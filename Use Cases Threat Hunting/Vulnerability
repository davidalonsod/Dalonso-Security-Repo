ðŸŽ¯ Risk-Based Prioritization


#### 1.1 Remediate Critical Security Baseline Failures 
**System**: server (Linux)  
**Impact**: High - Multiple critical security misconfigurations  
**Effort**: Medium  

**Query to Investigate**:
```kql
SecurityBaselineSummary
| where Computer == "server"
| where TimeGenerated > ago(7d)
| project TimeGenerated, Computer, BaselineType, CriticalFailedRules, 
          WarningFailedRules, TotalAssessedRules, PercentageOfPassedRules

#### 1.2 Investigate High Exposure Endpoints 
**Impact**: Critical - Increased attack surface  
**Effort**: High  

**Query to Identify High-Risk Devices**:
```kql
DeviceInfo
| where TimeGenerated > ago(1d)
| where ExposureLevel == "High"
| where DeviceCategory == "Endpoint"
| summarize arg_max(TimeGenerated, *) by DeviceId
| project DeviceName, OSPlatform, OSVersion, ExposureLevel, 
          IsInternetFacing, IsExcluded, OnboardingStatus, 
          SensorHealthState, PublicIP
| order by DeviceName asc
```

**Actions**:
1. Review each high-exposure device
2. Check for:
   - Outdated OS versions
   - Missing security patches
   - Weak configurations
   - Unnecessary internet exposure
3. Apply hardening measures
4. Consider network segmentation
5. Implement additional monitoring


### Priority 2 - URGENT (Within 3 days)

#### 2.1 Address Medium Exposure Endpoints
**Impact**: Medium - Potential vulnerabilities  
**Effort**: Medium  

**Query**:
```kql
DeviceInfo
| where TimeGenerated > ago(1d)
| where ExposureLevel == "Medium"
| where DeviceCategory == "Endpoint"
| summarize arg_max(TimeGenerated, *) by DeviceId
| project DeviceName, OSPlatform, ExposureLevel, MitigationStatus
```

---

#### 2.2 Investigate Excluded Devices 
**Impact**: Medium - Blind spots in security monitoring  
**Effort**: Low  

**Query**:
```kql
DeviceInfo
| where TimeGenerated > ago(1d)
| where IsExcluded == true
| project DeviceName, ExclusionReason, DeviceCategory, OnboardingStatus
```

**Actions**:
1. Determine why devices are excluded
2. If no longer valid, re-include in vulnerability management
3. If exclusion is required, document justification
4. Implement compensating controls

---

#### 2.3 Verify Antimalware Protection Status
**Impact**: High - No visibility into endpoint protection  
**Effort**: Low  

**Diagnostic Query**:
```kql
ProtectionStatus
| where TimeGenerated > ago(30d)
| summarize Count = count() by Computer
| order by Count desc
```

If no results:
```kql
// Check if agents are reporting
Heartbeat
| where TimeGenerated > ago(1d)
| summarize LastHeartbeat = max(TimeGenerated) by Computer
| where LastHeartbeat < ago(1h)
```

#### 3.2 Classify and Document Unknown Devices 
**Impact**: Low - Asset management gap  
**Effort**: Medium  

**Query**:
```kql
DeviceInfo
| where TimeGenerated > ago(1d)
| where DeviceCategory == "Unknown"
| project DeviceName, OSPlatform, DeviceType, Model, Vendor
```

---

## ðŸ“‹ Continuous Monitoring Queries

### Dashboard Query 1: Security Posture Overview
```kql
let BaselineData = SecurityBaselineSummary
    | where TimeGenerated > ago(7d)
    | summarize 
        AvgCompliance = avg(PercentageOfPassedRules),
        CriticalIssues = sum(CriticalFailedRules),
        WarningIssues = sum(WarningFailedRules);
let ExposureData = DeviceInfo
    | where TimeGenerated > ago(1d)
    | summarize arg_max(TimeGenerated, *) by DeviceId
    | summarize 
        HighExposure = countif(ExposureLevel == "High"),
        MediumExposure = countif(ExposureLevel == "Medium"),
        TotalDevices = count();
BaselineData
| extend ExposureData = ExposureData
| project AvgCompliance, CriticalIssues, WarningIssues, ExposureData
```


### Dashboard Query 2: Compliance Trend (Last 7 Days)
```kql
SecurityBaselineSummary
| where TimeGenerated > ago(7d)
| summarize 
    AvgCompliance = avg(PercentageOfPassedRules),
    Systems = dcount(Computer)
by bin(TimeGenerated, 1d)
| order by TimeGenerated asc
| render timechart 
```


### Dashboard Query 3: Top 10 Most Vulnerable Systems
```kql
let BaselineIssues = SecurityBaselineSummary
    | where TimeGenerated > ago(7d)
    | summarize arg_max(TimeGenerated, *) by Computer
    | extend BaselineScore = CriticalFailedRules * 3 + WarningFailedRules;
let ExposureScore = DeviceInfo
    | where TimeGenerated > ago(1d)
    | summarize arg_max(TimeGenerated, *) by DeviceId
    | extend ExposureScore = case(
        ExposureLevel == "High", 3,
        ExposureLevel == "Medium", 2,
        ExposureLevel == "Low", 1,
        0
    )
    | project DeviceName, ExposureScore;
BaselineIssues
| join kind=leftouter (ExposureScore) on $left.Computer == $right.DeviceName
| extend TotalRiskScore = BaselineScore + coalesce(ExposureScore, 0)
| project Computer, OSName, CriticalFailedRules, WarningFailedRules, 
          ExposureScore, TotalRiskScore, PercentageOfPassedRules
| order by TotalRiskScore desc
| take 10
```

### Dashboard Query 4: Antimalware Health Check
```kql
ProtectionStatus
| where TimeGenerated > ago(7d)
| summarize arg_max(TimeGenerated, *) by Computer
| summarize 
    Protected = countif(ProtectionStatus == "Protected"),
    OutdatedSignatures = countif(ProtectionStatus == "Signature out of date"),
    Unprotected = countif(ProtectionStatus !in ("Protected", "Signature out of date")),
    ActiveThreats = countif(ThreatStatus == "Active")
| extend ProtectionRate = round(100.0 * Protected / (Protected + OutdatedSignatures + Unprotected), 2)
```


### Dashboard Query 5: Device Exposure Heatmap
```kql
DeviceInfo
| where TimeGenerated > ago(1d)
| summarize arg_max(TimeGenerated, *) by DeviceId
| summarize Count = count() by DeviceCategory, ExposureLevel
| order by DeviceCategory, ExposureLevel
| render columnchart
```


**Investigation**:
```kql
DeviceInfo
| where DeviceId == "<device-id>"
| project DeviceName, OSVersion, OSBuild, ExposureLevel, 
          IsInternetFacing, PublicIP, OnboardingStatus,
          SensorHealthState, MitigationStatus
```

