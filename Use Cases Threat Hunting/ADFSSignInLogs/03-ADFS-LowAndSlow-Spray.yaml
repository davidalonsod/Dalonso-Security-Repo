id: c3d4e5f6-a7b8-4c9d-0e1f-2a3b4c5d6e7f
name: ADFS Low-and-Slow Password Spray - Rate-Evasion Pattern
version: 1.0.0
kind: Scheduled
description: |
  Detects IP addresses performing a low-volume, slow-cadence credential attack against ADFS:
  2â€“15 failures per hour spread across more than 5 unique accounts. This "low-and-slow" technique
  deliberately stays under per-account lockout thresholds and ADFS rate limits, making it nearly
  invisible to volume-based alerting. The query measures persistence across multiple hours to
  identify IPs with consistent spray behavior.
  MITRE ATT&CK: T1110 (Brute Force - Password Spraying)
severity: Medium
requiredDataConnectors:
  - connectorId: AzureActiveDirectory
    dataTypes:
      - ADFSSignInLogs
queryFrequency: 6h
queryPeriod: 1d
triggerOperator: gt
triggerThreshold: 0
tactics:
  - CredentialAccess
  - InitialAccess
relevantTechniques:
  - T1110
query: |
  let SprayErrors = dynamic(["50126", "50034", "50053", "396083"]);
  ADFSSignInLogs
  | where TimeGenerated > ago(1d)
  | extend ErrorCode = tostring(ResultType)
  | where ErrorCode in (SprayErrors)
  | summarize
      FailsPerHour = count(),
      UniqueUsers  = dcount(UserPrincipalName)
    by IPAddress, bin(TimeGenerated, 1h)
  | where FailsPerHour between (2 .. 15)
     and  UniqueUsers > 5
  | summarize
      SprayHours    = count(),
      TotalAttempts = sum(FailsPerHour),
      TotalUsers    = sum(UniqueUsers)
    by IPAddress
  | where SprayHours >= 3
  | order by SprayHours desc
entityMappings:
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: IPAddress
customDetails:
  SprayHours: SprayHours
  TotalAttempts: TotalAttempts
  TotalUsers: TotalUsers
alertDetailsOverride:
  alertDisplayNameFormat: "ADFS Low-and-Slow Spray from {{IPAddress}} - {{SprayHours}} hours of activity"
  alertDescriptionFormat: "IP {{IPAddress}} performed {{TotalAttempts}} credential failures across multiple ADFS accounts over {{SprayHours}} hours at a rate designed to evade lockout."
  alertSeverityColumnName: ""
  alertTacticsColumnName: ""
incidentConfiguration:
  createIncident: true
  groupingConfiguration:
    enabled: true
    reopenClosedIncident: false
    lookbackDuration: PT12H
    matchingMethod: AnyAlert
    groupByEntities:
      - IP
    groupByAlertDetails: []
    groupByCustomDetails: []
