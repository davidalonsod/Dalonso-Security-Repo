id: d5e1f3a4-b9c0-2d6e-7f8a-9b0c1d2e3f4a
name: Stale Token Used After Password Change or Auth Method Update
version: 1.0.0
kind: Scheduled
description: |
  Detects when a user's password or authentication methods were changed/reset in Azure AD
  Audit Logs, but non-interactive token refreshes continue to occur AFTER the change.
  This is a strong indicator that an attacker has a pre-existing refresh token that
  survived the password change â€” a key tactic to maintain persistent access even after
  the victim or IT team reset the compromised credentials.
  MITRE ATT&CK: T1528 (Steal Application Access Token), T1078 (Valid Accounts)
severity: High
requiredDataConnectors:
  - connectorId: AzureActiveDirectory
    dataTypes:
      - AADNonInteractiveUserSignInLogs
      - AuditLogs
queryFrequency: 1h
queryPeriod: 24h
triggerOperator: gt
triggerThreshold: 0
tactics:
  - Persistence
  - CredentialAccess
  - DefenseEvasion
relevantTechniques:
  - T1528
  - T1078
  - T1550
query: |
  let PasswordChanges =
      AuditLogs
      | where TimeGenerated > ago(24h)
      | where OperationName has_any (
          "Reset password",
          "Change password",
          "Update user",
          "User changed password",
          "Admin updated user authentication method",
          "Update Authentication Method",
          "Delete Authentication Method"
        )
      | extend UPN = tostring(TargetResources[0].userPrincipalName)
      | where isnotempty(UPN)
      | summarize ChangeTime = max(TimeGenerated) by UPN;
  AADNonInteractiveUserSignInLogs
  | where TimeGenerated > ago(24h)
  | where ResultType == 0
  | join kind=inner PasswordChanges on $left.UserPrincipalName == $right.UPN
  | where TimeGenerated > ChangeTime
  | summarize
      TokensAfterChange = count(),
      IPs               = make_set(IPAddress),
      Countries         = make_set(Location),
      Apps              = make_set(AppDisplayName),
      LastSeen          = max(TimeGenerated),
      FirstTokenAfter   = min(TimeGenerated)
    by UserPrincipalName, ChangeTime
  | extend IPAddress = tostring(IPs[0])
  | order by TokensAfterChange desc
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: UserPrincipalName
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: IPAddress
customDetails:
  TokensAfterChange: TokensAfterChange
  Countries: Countries
  Apps: Apps
  PasswordChangeTime: ChangeTime
alertDetailsOverride:
  alertDisplayNameFormat: "Stale Token Active After Credential Change - {{UserPrincipalName}}"
  alertDescriptionFormat: "User {{UserPrincipalName}} had credentials changed, but {{TokensAfterChange}} non-interactive token refreshes were observed afterward. Possible stale refresh token bypassing the credential reset."
incidentConfiguration:
  createIncident: true
  groupingConfiguration:
    enabled: true
    reopenClosedIncident: false
    lookbackDuration: PT5H
    matchingMethod: AnyAlert
    groupByEntities:
      - Account
    groupByAlertDetails: []
    groupByCustomDetails: []
