{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# üìß Defender for Office 365 - BEC & AiTM Threat Hunting Workbook v2.2\n\n**Purpose:** Comprehensive threat hunting, protection analytics, BEC detection, AiTM phishing investigation, and email security monitoring for Microsoft Defender for Office 365.\n\n| Category | Capabilities |\n|----------|-------------|\n| üéØ **Executive Summary** | Protection KPIs, Cost Savings, Risk Score, Threat Block Rate, Detonation Stats |\n| üîó **Link Protection** | URL Detonation, Time-of-Click Protection, Safe Links (Email/Teams/SharePoint/Office) |\n| üìé **File Protection** | Safe Attachments Detonation, Malware Blocking, SharePoint/OneDrive/Teams Protection |\n| üì¨ **Delivery Locations** | Inbox/Junk/Quarantine Analysis, Policy Configuration Insights |\n| ‚ö° **Automation (AIR)** | Automated Investigation & Response, Alert Correlation, Auto-Remediation |\n| üéØ **Campaigns & Analytics** | Attack Patterns, MITRE ATT&CK Mapping, Threat Intelligence |\n| üî¥ **Business Email Compromise** | Invoice Fraud, Executive Impersonation, Vendor Compromise, Payment Diversion |\n| üü† **AiTM Phishing** | Adversary-in-the-Middle Detection, Token Theft, Session Hijacking, MFA Bypass |\n| üü° **Phishing Detection** | Credential Harvesting, Brand Impersonation, QR Code Phishing (Quishing) |\n| ü¶† **Malware Analysis** | Attachment Threats, Weaponized Documents, Payload Delivery |\n| üåç **Geographic Threats** | Sender Location Analysis, Threat Origin Mapping, Geo-Anomaly Detection |\n| ‚≠ê **Priority Accounts** | Executive Protection, VIP Targeting, Safe Links/Attachments Scoping |\n| üé≠ **Spoofing Detection** | DMARC/DKIM/SPF Analysis, Impersonation Protection, Spoof Intelligence |\n| üè¢ **Internal Protection** | Intra-Org Threats, Lateral Phishing, Compromised Account Detection |\n| üõ°Ô∏è **ZAP & Remediation** | Zero-Hour Auto Purge, Post-Delivery Actions, AIR Automation |\n| ‚öôÔ∏è **Configuration Analysis** | Preset Policies, Anti-Phishing/Spam/Malware Status, Tenant Allow/Block |\n| üí¨ **Collaboration Security** | Teams/SharePoint/OneDrive Malware Detection, Safe Links, Activity Monitoring |\n\n---\n**Version:** 2.2 | **Last Updated:** 2026-02 | **Data Sources:** EmailEvents, EmailPostDeliveryEvents, UrlClickEvents, OfficeActivity, SecurityIncident, SecurityAlert, AlertInfo, AlertEvidence, SigninLogs, AADNonInteractiveUserSignInLogs, IdentityInfo"
      },
      "name": "text - header"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "a1b2c3d4-0001-0001-0001-000000000001",
            "version": "KqlParameterItem/1.0",
            "name": "Workspace",
            "type": 5,
            "isRequired": true,
            "query": "resources\n| where type == 'microsoft.operationalinsights/workspaces'\n| project id",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "resourceTypeFilter": {
                "microsoft.operationalinsights/workspaces": true
              },
              "additionalResourceOptions": [
                "value::1"
              ]
            },
            "queryType": 1,
            "label": "Workspace"
          },
          {
            "id": "a1b2c3d4-0001-0001-0001-000000000002",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 604800000
            },
            "typeSettings": {
              "selectableValues": [
                { "durationMs": 3600000, "displayName": "Last 1 hour" },
                { "durationMs": 14400000, "displayName": "Last 4 hours" },
                { "durationMs": 86400000, "displayName": "Last 24 hours" },
                { "durationMs": 259200000, "displayName": "Last 3 days" },
                { "durationMs": 604800000, "displayName": "Last 7 days" },
                { "durationMs": 1209600000, "displayName": "Last 14 days" },
                { "durationMs": 2592000000, "displayName": "Last 30 days" },
                { "durationMs": 5184000000, "displayName": "Last 60 days" },
                { "durationMs": 7776000000, "displayName": "Last 90 days" }
              ]
            },
            "label": "Time Range"
          },
          {
            "id": "a1b2c3d4-0001-0001-0001-000000000003",
            "version": "KqlParameterItem/1.0",
            "name": "InvestigateUser",
            "type": 1,
            "value": "",
            "label": "Investigate User (email)"
          },
          {
            "id": "a1b2c3d4-0001-0001-0001-000000000004",
            "version": "KqlParameterItem/1.0",
            "name": "InvestigateDomain",
            "type": 1,
            "value": "",
            "label": "Investigate Domain"
          }
        ],
        "style": "pills",
        "queryType": 0
      },
      "name": "parameters"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "tab-executive",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üéØ Executive Summary",
            "subTarget": "Executive",
            "style": "link"
          },
          {
            "id": "tab-bec",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üî¥ BEC Detection",
            "subTarget": "BEC",
            "style": "link"
          },
          {
            "id": "tab-aitm",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üü† AiTM Phishing",
            "subTarget": "AiTM",
            "style": "link"
          },
          {
            "id": "tab-phishing",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üé£ Phishing Analysis",
            "subTarget": "Phishing",
            "style": "link"
          },
          {
            "id": "tab-malware",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "ü¶† Malware & Attachments",
            "subTarget": "Malware",
            "style": "link"
          },
          {
            "id": "tab-geomap",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üåç Geo Threat Map",
            "subTarget": "GeoMap",
            "style": "link"
          },
          {
            "id": "tab-campaigns",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üìä Campaigns",
            "subTarget": "Campaigns",
            "style": "link"
          },
          {
            "id": "tab-urls",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üîó URL Analysis",
            "subTarget": "URLs",
            "style": "link"
          },
          {
            "id": "tab-zap",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üõ°Ô∏è ZAP & Remediation",
            "subTarget": "ZAP",
            "style": "link"
          },
          {
            "id": "tab-xdr",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üö® XDR & Attack Chains",
            "subTarget": "XDR",
            "style": "link"
          },
          {
            "id": "tab-config",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "‚öôÔ∏è Email Security Config",
            "subTarget": "Config",
            "style": "link"
          },
          {
            "id": "tab-investigation",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üîé Investigation",
            "subTarget": "Investigation",
            "style": "link"
          }
        ]
      },
      "name": "tabs"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üéØ Executive Dashboard - Email Security Value & KPIs\n\n**Demonstrate security value** to leadership with key performance indicators, threat prevention metrics, and ROI insights.\n\nThis workbook provides comprehensive monitoring across: **Email Protection** | **BEC/AiTM Detection** | **Teams/SharePoint/OneDrive** | **User Risk Monitoring** | **Compliance Status**\n\n| üî¥ Critical | üü† High | üü° Medium | üü¢ Low |\n|---|---|---|---|\n| Immediate action required | Action within 24h | Review within 7d | Monitor |"
            },
            "name": "text - executive header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// CISO KPI Dashboard - Protection Value\nlet BlockedThreats = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailDirection == \"Inbound\" | where DeliveryAction in (\"Blocked\", \"Quarantined\") | where isnotempty(ThreatTypes) | count);\nlet DeliveredThreats = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where DeliveryAction == \"Delivered\" | where isnotempty(ThreatTypes) | count);\nlet ZAPRemediated = toscalar(EmailPostDeliveryEvents | where TimeGenerated {TimeRange} | where ActionTrigger == \"ZAP\" | where ActionResult == \"Success\" | count);\nlet ClicksBlocked = toscalar(UrlClickEvents | where TimeGenerated {TimeRange} | where IsClickedThrough == false | count);\nlet ThreatBlockRate = round(toreal(BlockedThreats) / (BlockedThreats + DeliveredThreats + 1) * 100, 1);\nlet TotalPrevented = BlockedThreats + ZAPRemediated + ClicksBlocked;\nlet EstimatedCostSaved = (BlockedThreats + ZAPRemediated) * 250;\nprint Metric = dynamic([\"üõ°Ô∏è Threats Blocked\", \"‚ö° ZAP Remediated\", \"üëÜ Clicks Blocked\", \"üéØ Block Rate %\", \"‚úÖ Total Prevented\", \"üí∞ Est. Cost Saved\"]),\n      Value = pack_array(BlockedThreats, ZAPRemediated, ClicksBlocked, ThreatBlockRate, TotalPrevented, EstimatedCostSaved)\n| mv-expand Metric to typeof(string), Value to typeof(long)",
              "size": 4,
              "title": "üìä Protection Value - KPIs for Leadership",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "auto" } }
              }
            },
            "name": "query - ciso kpis"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üîó URL-Based Threats - Detonation & Protection"
            },
            "name": "text - url threats header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// URL-Based Threat Protection Summary\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| where DeliveryAction in (\"Blocked\", \"Quarantined\")\n| where DetectionMethods has_any (\"URL detonation\", \"URL reputation\", \"Safe Links\", \"URL\")\n| summarize Count = count()\n| project Metric = \"üîó At Delivery\", Value = Count",
              "size": 4,
              "title": "üîó URL Threats Stopped at Delivery",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "blue" } }
              }
            },
            "customWidth": "25",
            "name": "query - urls at delivery"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// URLs Stopped via Automation/AIR\nEmailPostDeliveryEvents\n| where TimeGenerated {TimeRange}\n| where ActionTrigger has_any (\"Automation\", \"Playbook\", \"AIR\", \"AutoRemediation\", \"ZAP\")\n| where ActionResult == \"Success\"\n| summarize Count = count()\n| project Metric = \"‚ö° Via Automation\", Value = Count",
              "size": 4,
              "title": "‚ö° URLs Stopped via Automation",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "green" } }
              }
            },
            "customWidth": "25",
            "name": "query - urls via automation"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// URLs Blocked at Time of Click\nUrlClickEvents\n| where TimeGenerated {TimeRange}\n| where IsClickedThrough == false\n| summarize Count = count()\n| project Metric = \"üëÜ At Click\", Value = Count",
              "size": 4,
              "title": "üëÜ URLs Blocked at Click",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "orange" } }
              }
            },
            "customWidth": "25",
            "name": "query - urls at click"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Total URL Protection\nlet URLsAtDelivery = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailDirection == \"Inbound\" | where DeliveryAction in (\"Blocked\", \"Quarantined\") | where DetectionMethods has_any (\"URL detonation\", \"URL reputation\", \"Safe Links\", \"URL\") | count);\nlet URLsViaAutomation = toscalar(EmailPostDeliveryEvents | where TimeGenerated {TimeRange} | where ActionTrigger has_any (\"Automation\", \"Playbook\", \"AIR\", \"ZAP\") | where ActionResult == \"Success\" | count);\nlet URLsAtClick = toscalar(UrlClickEvents | where TimeGenerated {TimeRange} | where IsClickedThrough == false | count);\nlet Total = URLsAtDelivery + URLsViaAutomation + URLsAtClick;\nprint Metric = \"üõ°Ô∏è Total Stopped\", Value = Total",
              "size": 4,
              "title": "üõ°Ô∏è Total URL Threats Stopped",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "greenDark" } }
              }
            },
            "customWidth": "25",
            "name": "query - urls total"
          },
          {
            "type": 1,
            "content": {
              "json": "**Observations:**\n- üîó **At Delivery:** URLs detonated & stopped using sandboxing technology before reaching mailboxes\n- ‚ö° **Via Automation:** URLs stopped with automatic playbooks triggered by signals in your environment ([Automation section](https://security.microsoft.com/action-center))\n- üëÜ **At Click:** URLs re-evaluated when users clicked - detecting payload changes behind malicious sites via Safe Links integration in Outlook, Office and Teams"
            },
            "name": "text - url observations"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üìé File-Based Threats - Detonation & Protection"
            },
            "name": "text - file threats header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Files Stopped at Delivery\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| where DeliveryAction in (\"Blocked\", \"Quarantined\")\n| where ThreatTypes has \"Malware\" or DetectionMethods has_any (\"File detonation\", \"Safe Attachments\", \"File reputation\", \"Antimalware\")\n| where AttachmentCount > 0\n| summarize Count = count()\n| project Metric = \"üìé At Delivery\", Value = Count",
              "size": 4,
              "title": "üìé Files Stopped at Delivery",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "blue" } }
              }
            },
            "customWidth": "25",
            "name": "query - files at delivery"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Files Protected in SharePoint/Teams/OneDrive\nOfficeActivity\n| where TimeGenerated {TimeRange}\n| where OfficeWorkload in (\"SharePoint\", \"OneDrive\", \"MicrosoftTeams\")\n| where Operation has_any (\"FileMalwareDetected\", \"FileBlocked\", \"AntivirusDetection\")\n| summarize Count = count()\n| project Metric = \"‚òÅÔ∏è Cloud Storage\", Value = Count",
              "size": 4,
              "title": "‚òÅÔ∏è Files in SharePoint/Teams/OneDrive",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "purple" } }
              }
            },
            "customWidth": "25",
            "name": "query - files sharepoint"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Total File Protection\nlet FilesAtDelivery = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailDirection == \"Inbound\" | where DeliveryAction in (\"Blocked\", \"Quarantined\") | where ThreatTypes has \"Malware\" or DetectionMethods has_any (\"File detonation\", \"Safe Attachments\") | where AttachmentCount > 0 | count);\nlet FilesInCloud = toscalar(OfficeActivity | where TimeGenerated {TimeRange} | where OfficeWorkload in (\"SharePoint\", \"OneDrive\", \"MicrosoftTeams\") | where Operation has_any (\"FileMalwareDetected\", \"FileBlocked\") | count);\nlet Total = FilesAtDelivery + FilesInCloud;\nprint Metric = \"üõ°Ô∏è Total Protected\", Value = Total",
              "size": 4,
              "title": "üõ°Ô∏è Total Files Protected",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "greenDark" } }
              }
            },
            "customWidth": "25",
            "name": "query - files total"
          },
          {
            "type": 1,
            "content": {
              "json": "**Observations:**\n- üìé **At Delivery:** Unique (by hash) file-based threats detonated & stopped using sandboxing technology\n- ‚òÅÔ∏è **Cloud Storage:** Files protected in SharePoint, Teams, or OneDrive - MDO protection extends beyond email to documents stored in collaboration platforms"
            },
            "name": "text - file observations"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üîó Link Protection\n\n**Microsoft Defender for Office 365** protects your links across a variety of platforms including **Email**, **Teams**, **SharePoint**, and **Office Apps**."
            },
            "name": "text - link protection header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Unique URLs with threats blocked\nUrlClickEvents\n| where TimeGenerated {TimeRange}\n| where IsClickedThrough == false or isnotempty(ThreatTypes)\n| summarize UniqueURLs = dcount(Url)\n| project Value = UniqueURLs, Description = \"unique URLs with threats blocked by Safe Links (detonation, reputation)\"",
              "size": 4,
              "title": "üîó Unique Threat URLs Blocked",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "blue" } },
                "subtitleContent": { "columnMatch": "Description", "formatter": 1 }
              }
            },
            "customWidth": "30",
            "name": "query - unique threat urls"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Clicks blocked at time-of-click\nUrlClickEvents\n| where TimeGenerated {TimeRange}\n| where IsClickedThrough == false\n| summarize ClicksBlocked = count()\n| project Value = ClicksBlocked, Description = \"clicks on unwanted sites blocked at time-of-click\"",
              "size": 4,
              "title": "üëÜ Clicks Blocked at Time-of-Click",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "green" } },
                "subtitleContent": { "columnMatch": "Description", "formatter": 1 }
              }
            },
            "customWidth": "30",
            "name": "query - clicks blocked"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Users Protected from clicking malicious links\nUrlClickEvents\n| where TimeGenerated {TimeRange}\n| where IsClickedThrough == false\n| summarize UsersProtected = dcount(AccountUpn)\n| project Value = UsersProtected, Description = \"users protected from clicking malicious links\"",
              "size": 4,
              "title": "üë• Users Protected",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "purple" } },
                "subtitleContent": { "columnMatch": "Description", "formatter": 1 }
              }
            },
            "customWidth": "40",
            "name": "query - users protected"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Link Protection by Platform\nUrlClickEvents\n| where TimeGenerated {TimeRange}\n| extend Platform = case(\n    Workload has \"Email\" or Workload has \"Exchange\" or isempty(Workload), \"üìß Mail / Outlook\",\n    Workload has \"Teams\", \"üí¨ Teams\",\n    Workload has \"SharePoint\" or Workload has \"OneDrive\", \"üìÅ SharePoint/OneDrive\",\n    Workload has \"Office\", \"üìÑ Office Apps\",\n    \"üîó Other\")\n| summarize \n    TotalClicks = count(),\n    BlockedClicks = countif(IsClickedThrough == false),\n    ThreatClicks = countif(isnotempty(ThreatTypes)),\n    UniqueURLs = dcount(Url),\n    UniqueUsers = dcount(AccountUpn)\n    by Platform\n| extend BlockRate = strcat(round(toreal(BlockedClicks) / TotalClicks * 100, 1), \"%\")\n| order by TotalClicks desc",
              "size": 0,
              "title": "üåê Link Protection by Platform",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "BlockedClicks", "formatter": 4, "formatOptions": { "palette": "green" } },
                  { "columnMatch": "ThreatClicks", "formatter": 4, "formatOptions": { "palette": "red" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - link protection by platform"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Link Click Outcomes\nUrlClickEvents\n| where TimeGenerated {TimeRange}\n| extend Outcome = case(\n    IsClickedThrough == false and isnotempty(ThreatTypes), \"üî¥ Threat Blocked\",\n    IsClickedThrough == false, \"üü° Blocked (Policy/Reputation)\",\n    IsClickedThrough == true and isnotempty(ThreatTypes), \"‚ö†Ô∏è Clicked Through Warning\",\n    \"‚úÖ Allowed\")\n| summarize Count = count() by Outcome\n| order by Count desc",
              "size": 2,
              "title": "üìä Link Click Outcomes",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - link outcomes"
          },
          {
            "type": 1,
            "content": {
              "json": "**Time-of-Click Protection:** Microsoft Defender for Office 365 scans links at delivery, but also when they are clicked - allowing decisions to be made after any reputation change. This re-detonation can detect changes in the payload behind a malicious site. Protection extends to client-side apps including **Outlook**, **Teams**, and **Office**."
            },
            "name": "text - link protection info"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üéØ Recent Notable Campaigns & Threat Analytics\n\n**Microsoft Security Research** tracks threat actors and campaigns targeting organizations. Below are notable patterns detected in your environment."
            },
            "name": "text - campaigns header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Recent Attack Campaigns Detected\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(ThreatTypes)\n| where EmailDirection == \"Inbound\"\n| extend CampaignPattern = case(\n    Subject has_any (\"password\", \"expire\", \"reset\", \"verify\", \"urgent\") and ThreatTypes has \"Phish\", \"üé£ Credential Harvesting\",\n    Subject has_any (\"invoice\", \"payment\", \"wire\", \"transfer\", \"urgent\") and ThreatTypes has \"Phish\", \"üí∞ BEC / Financial Fraud\",\n    Subject has_any (\"shared\", \"document\", \"onedrive\", \"sharepoint\", \"view\") and ThreatTypes has \"Phish\", \"üìÑ Fake File Share\",\n    Subject has_any (\"voicemail\", \"vm\", \"missed call\", \"fax\") and ThreatTypes has \"Phish\", \"üìû Voicemail/Fax Lure\",\n    Subject has_any (\"mfa\", \"authenticator\", \"security\", \"verify\", \"unusual\") and ThreatTypes has \"Phish\", \"üîê MFA/Security Alert Lure\",\n    Subject has_any (\"shipping\", \"delivery\", \"package\", \"fedex\", \"ups\", \"dhl\") and ThreatTypes has \"Phish\", \"üì¶ Shipping Notification\",\n    ThreatTypes has \"Malware\", \"ü¶† Malware Distribution\",\n    ThreatTypes has \"Spam\", \"üìß Spam Campaign\",\n    \"‚ö†Ô∏è Other Threat\")\n| summarize \n    EmailCount = count(),\n    UniqueRecipients = dcount(RecipientEmailAddress),\n    UniqueSenders = dcount(SenderFromAddress),\n    Domains = make_set(SenderFromDomain, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated),\n    Blocked = countif(DeliveryAction in (\"Blocked\", \"Quarantined\")),\n    Delivered = countif(DeliveryAction == \"Delivered\")\n    by CampaignPattern\n| extend BlockRate = strcat(round(toreal(Blocked) / EmailCount * 100, 1), \"%\")\n| extend Risk = case(\n    Delivered > 0 and CampaignPattern has_any (\"BEC\", \"Credential\", \"MFA\"), \"üî¥ HIGH\",\n    Delivered > 0, \"üü† MEDIUM\",\n    \"üü¢ BLOCKED\")\n| order by EmailCount desc\n| project Risk, CampaignPattern, EmailCount, UniqueRecipients, UniqueSenders, BlockRate, Delivered, FirstSeen, LastSeen, Domains",
              "size": 0,
              "title": "üéØ Attack Campaign Patterns Detected",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "EmailCount", "formatter": 4, "formatOptions": { "palette": "blue" } },
                  { "columnMatch": "Delivered", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "name": "query - campaign patterns"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Threat Actor Techniques (MITRE ATT&CK Mapping)\nlet Techniques = EmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(ThreatTypes)\n| extend Technique = case(\n    DetectionMethods has \"impersonation\" or Subject has_any (\"ceo\", \"cfo\", \"executive\"), \"T1534 - Internal Spearphishing\",\n    ThreatTypes has \"Phish\" and Subject has_any (\"password\", \"credential\", \"login\"), \"T1566.001 - Spearphishing Attachment\",\n    ThreatTypes has \"Phish\" and (DetectionMethods has \"URL\" or Subject has_any (\"click\", \"link\", \"view\")), \"T1566.002 - Spearphishing Link\",\n    ThreatTypes has \"Malware\" and AttachmentCount > 0, \"T1566.001 - Spearphishing Attachment\",\n    DetectionMethods has_any (\"spoof\", \"DMARC\", \"SPF\"), \"T1656 - Impersonation\",\n    Subject has_any (\"consent\", \"permission\", \"access\", \"oauth\"), \"T1528 - Steal Application Access Token\",\n    \"T1566 - Phishing\")\n| summarize Count = count() by Technique\n| order by Count desc\n| take 10;\nlet URLTechniques = UrlClickEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(ThreatTypes)\n| summarize Count = count()\n| extend Technique = \"T1204.001 - Malicious Link\";\nTechniques\n| union URLTechniques\n| summarize Count = sum(Count) by Technique\n| order by Count desc",
              "size": 0,
              "title": "üó∫Ô∏è MITRE ATT&CK Techniques Observed",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "barchart",
              "chartSettings": {
                "xAxis": "Technique",
                "yAxis": ["Count"],
                "seriesLabelSettings": [
                  { "seriesName": "Count", "color": "redBright" }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - mitre techniques"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Campaign Timeline\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(ThreatTypes)\n| where EmailDirection == \"Inbound\"\n| extend CampaignType = case(\n    Subject has_any (\"password\", \"credential\", \"login\", \"verify\") and ThreatTypes has \"Phish\", \"Credential Phishing\",\n    Subject has_any (\"invoice\", \"payment\", \"wire\", \"urgent\"), \"BEC/Fraud\",\n    ThreatTypes has \"Malware\", \"Malware\",\n    ThreatTypes has \"Phish\", \"Other Phishing\",\n    \"Other\")\n| summarize Count = count() by CampaignType, bin(TimeGenerated, 1d)\n| order by TimeGenerated asc",
              "size": 0,
              "title": "üìà Campaign Timeline",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  { "seriesName": "Credential Phishing", "color": "red" },
                  { "seriesName": "BEC/Fraud", "color": "orange" },
                  { "seriesName": "Malware", "color": "purple" },
                  { "seriesName": "Other Phishing", "color": "blue" }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - campaign timeline"
          },
          {
            "type": 1,
            "content": {
              "json": "**üí° Threat Analytics:** For detailed threat intelligence on active campaigns, visit [Microsoft 365 Defender Threat Analytics](https://security.microsoft.com/threatanalytics3). Notable recent campaigns include:\n- **QR Code Phishing (Quishing)** - Attackers embedding malicious QR codes to bypass email filters\n- **AiTM Phishing Kits** - Session hijacking attacks targeting MFA-protected accounts\n- **Business Email Compromise** - Impersonation of executives for financial fraud\n- **Callback Phishing** - Fake invoices requesting phone callbacks to social engineer victims\n- **Brand Impersonation** - Microsoft, DocuSign, Adobe login page spoofing"
            },
            "name": "text - threat analytics info"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üì¨ Delivery Locations\n\n**Microsoft Defender for Office 365** classifies messages with a verdict and confidence level. Based on your policies and tenant configuration, phish and spam threats will be delivered to **Inbox**, **Junk Mail Folder**, **Quarantine**, or a **custom location**. Any overrides you have made can also impact delivery location."
            },
            "name": "text - delivery locations header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Delivery Location Distribution for Threats\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| where ThreatTypes has_any (\"Phish\", \"Spam\", \"Malware\")\n| extend Location = case(\n    DeliveryLocation == \"Inbox/folder\", \"üì• Inbox\",\n    DeliveryLocation has \"Junk\", \"üìÅ Junk Folder\",\n    DeliveryLocation has \"Quarantine\" or DeliveryAction == \"Quarantined\", \"üîí Quarantine\",\n    DeliveryAction == \"Blocked\", \"üö´ Blocked\",\n    isnotempty(DeliveryLocation), strcat(\"‚öôÔ∏è Custom: \", DeliveryLocation),\n    \"‚ùì Unknown\")\n| summarize Count = count() by Location, ThreatType = case(ThreatTypes has \"Phish\", \"Phish\", ThreatTypes has \"Malware\", \"Malware\", \"Spam\")\n| order by Count desc",
              "size": 0,
              "title": "üì¨ Unwanted Message Delivery by Location",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "barchart",
              "chartSettings": {
                "xAxis": "Location",
                "yAxis": ["Count"],
                "group": "ThreatType",
                "seriesLabelSettings": [
                  { "seriesName": "Phish", "color": "red" },
                  { "seriesName": "Malware", "color": "purple" },
                  { "seriesName": "Spam", "color": "orange" }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - delivery locations chart"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Phish Delivery Location Analysis with Observations\nlet PhishToInbox = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where ThreatTypes has \"Phish\" | where DeliveryLocation == \"Inbox/folder\" or (DeliveryAction == \"Delivered\" and DeliveryLocation !has \"Junk\") | count);\nlet PhishToJunk = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where ThreatTypes has \"Phish\" | where DeliveryLocation has \"Junk\" | count);\nlet PhishToQuarantine = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where ThreatTypes has \"Phish\" | where DeliveryAction == \"Quarantined\" or DeliveryLocation has \"Quarantine\" | count);\nlet PhishCustom = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where ThreatTypes has \"Phish\" | where DeliveryAction !in (\"Delivered\", \"Blocked\", \"Quarantined\") | count);\nlet PhishBlocked = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where ThreatTypes has \"Phish\" | where DeliveryAction == \"Blocked\" | count);\nprint Location = dynamic([\"üì• Inbox\", \"üìÅ Junk Folder\", \"üîí Quarantine\", \"üö´ Blocked\", \"‚öôÔ∏è Custom Action\"]),\n      Count = pack_array(PhishToInbox, PhishToJunk, PhishToQuarantine, PhishBlocked, PhishCustom),\n      Risk = dynamic([\"üî¥ High Risk\", \"üü† Medium Risk\", \"‚úÖ Safe\", \"‚úÖ Safe\", \"üü° Review\"])\n| mv-expand Location to typeof(string), Count to typeof(long), Risk to typeof(string)\n| where Count > 0",
              "size": 0,
              "title": "üé£ Phish Delivery Location Summary",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - phish delivery summary"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Delivery Location Observations\nlet PhishToInbox = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where ThreatTypes has \"Phish\" | where DeliveryLocation == \"Inbox/folder\" or (DeliveryAction == \"Delivered\" and DeliveryLocation !has \"Junk\") | count);\nlet PhishToJunk = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where ThreatTypes has \"Phish\" | where DeliveryLocation has \"Junk\" | count);\nlet PhishCustom = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where ThreatTypes has \"Phish\" | where DeliveryAction !in (\"Delivered\", \"Blocked\", \"Quarantined\") | count);\nprint Observation = pack_array(\n    iff(PhishToInbox > 0, strcat(\"‚ö†Ô∏è **Phish to Inbox:** You have configuration allowing phish to be delivered to inbox. There are **\", PhishToInbox, \"** messages classified as phish sent to inbox\", iff(PhishCustom > 0, strcat(\", and **\", PhishCustom, \"** with custom action\"), \"\"), \". Considering these are potentially malicious, it's advisable to send to quarantine.\"), \"\"),\n    iff(PhishToJunk > 0, strcat(\"üü° **Phish to Junk:** There are **\", PhishToJunk, \"** messages classified as phish sent to junk folder, which users may mistake as safe. Be aware third-party vendors often purge items from this folder.\"), \"\"),\n    iff(PhishToInbox == 0 and PhishToJunk == 0, \"‚úÖ **All phish properly quarantined or blocked.** No action required.\", \"\"))\n| mv-expand Observation to typeof(string)\n| where isnotempty(Observation)",
              "size": 0,
              "title": "üìã Delivery Location Observations",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "labelSettings": [{ "columnId": "Observation", "label": "Observations & Recommendations" }]
              }
            },
            "name": "query - delivery observations"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### ‚ö° Automation (AIR - Automated Investigation & Response)\n\n**When false-negatives happen, having powerful automation is key.** Your organisation has Microsoft Defender for Office 365 P2 licenses with built-in automation designed to protect you even when there is a miss."
            },
            "name": "text - automation header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Automation Overview - AIR Statistics\nlet TotalAlerts = toscalar(SecurityAlert | where TimeGenerated {TimeRange} | where ProductName has_any (\"Office 365\", \"Microsoft Defender for Office 365\", \"MDO\") | count);\nlet AutomationRan = toscalar(SecurityAlert | where TimeGenerated {TimeRange} | where ProductName has_any (\"Office 365\", \"Microsoft Defender for Office 365\") | where Status has_any (\"InProgress\", \"Resolved\", \"Dismissed\") | count);\nlet UniqueIncidents = toscalar(SecurityIncident | where TimeGenerated {TimeRange} | where Labels has_any (\"Office365\", \"MDO\", \"Email\", \"Phishing\", \"Malware\", \"BEC\") or Title has_any (\"email\", \"phish\", \"malware\", \"spam\") | count);\nlet AutoClosed = toscalar(SecurityIncident | where TimeGenerated {TimeRange} | where Status == \"Closed\" | count);\nlet CorrelationRate = iff(TotalAlerts > 0 and UniqueIncidents > 0, toint(round(toreal(TotalAlerts - UniqueIncidents) / TotalAlerts * 100, 0)), 0);\nprint Metric = dynamic([\"üîî MDO Alerts Processed\", \"üìä Correlated to Incidents\", \"ü§ñ Auto-Closed Incidents\", \"üìà Correlation Rate %\"]),\n      Value = pack_array(TotalAlerts, UniqueIncidents, AutoClosed, CorrelationRate),\n      Description = dynamic([\"by automation playbooks\", \"reducing alert fatigue\", \"without manual intervention\", \"alerts grouped into incidents\"])\n| mv-expand Metric to typeof(string), Value to typeof(long), Description to typeof(string)",
              "size": 4,
              "title": "‚ö° Automation Overview (AIR)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "greenDark" } },
                "secondaryContent": { "columnMatch": "Description", "formatter": 1 }
              }
            },
            "name": "query - automation overview"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Incident Status Breakdown\nSecurityIncident\n| where TimeGenerated {TimeRange}\n| where Labels has_any (\"Office365\", \"MDO\", \"Email\", \"Phishing\", \"Malware\", \"BEC\", \"AiTM\") \n    or Title has_any (\"email\", \"phish\", \"malware\", \"spam\", \"suspicious\")\n| summarize Count = count() by Status\n| extend StatusIcon = case(\n    Status == \"Closed\", \"‚úÖ Closed\",\n    Status == \"Active\", \"üî¥ Active\",\n    Status == \"New\", \"üÜï New\",\n    Status)\n| project StatusIcon, Count\n| order by Count desc",
              "size": 2,
              "title": "üìä Incident Status Breakdown",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "piechart"
            },
            "customWidth": "25",
            "name": "query - incident status"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Automation Actions Analysis\nlet ZAPActions = toscalar(EmailPostDeliveryEvents | where TimeGenerated {TimeRange} | where ActionTrigger == \"ZAP\" | count);\nlet AIRActions = toscalar(EmailPostDeliveryEvents | where TimeGenerated {TimeRange} | where ActionTrigger has_any (\"AIR\", \"Automation\", \"Playbook\", \"AutoRemediation\") | count);\nlet AdminActions = toscalar(EmailPostDeliveryEvents | where TimeGenerated {TimeRange} | where ActionTrigger has_any (\"Admin\", \"Manual\") | count);\nlet PendingApproval = toscalar(EmailPostDeliveryEvents | where TimeGenerated {TimeRange} | where ActionResult has_any (\"Pending\", \"PendingApproval\") | count);\nlet TimedOut = toscalar(EmailPostDeliveryEvents | where TimeGenerated {TimeRange} | where ActionResult has_any (\"TimedOut\", \"Expired\", \"Failed\") | count);\nprint ActionType = dynamic([\"‚ö° ZAP Remediation\", \"ü§ñ AIR Automation\", \"üë®‚Äçüíº Admin Manual\", \"‚è≥ Pending Approval\", \"‚è±Ô∏è Timed Out\"]),\n      Count = pack_array(ZAPActions, AIRActions, AdminActions, PendingApproval, TimedOut),\n      Status = dynamic([\"Automatic\", \"Automatic\", \"Manual\", \"Requires Action\", \"Requires Review\"])\n| mv-expand ActionType to typeof(string), Count to typeof(long), Status to typeof(string)",
              "size": 0,
              "title": "‚öôÔ∏è Automation Actions Breakdown",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "customWidth": "35",
            "name": "query - automation actions"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Automation Observations\nlet TotalAlerts = toscalar(SecurityAlert | where TimeGenerated {TimeRange} | where ProductName has_any (\"Office 365\", \"Microsoft Defender for Office 365\") | count);\nlet UniqueIncidents = toscalar(SecurityIncident | where TimeGenerated {TimeRange} | where Labels has_any (\"Office365\", \"MDO\", \"Email\") or Title has_any (\"email\", \"phish\") | count);\nlet AutoClosed = toscalar(SecurityIncident | where TimeGenerated {TimeRange} | where Status == \"Closed\" | count);\nlet TotalIncidents = toscalar(SecurityIncident | where TimeGenerated {TimeRange} | count);\nlet PendingApproval = toscalar(EmailPostDeliveryEvents | where TimeGenerated {TimeRange} | where ActionResult has \"Pending\" | count);\nlet TimedOut = toscalar(EmailPostDeliveryEvents | where TimeGenerated {TimeRange} | where ActionResult has_any (\"TimedOut\", \"Expired\") | count);\nlet CorrelationPct = iff(TotalAlerts > 0 and UniqueIncidents > 0, toint(round(toreal(TotalAlerts - UniqueIncidents) / TotalAlerts * 100, 0)), toint(0));\nlet AutoCloseRate = iff(TotalIncidents > 0, toint(round(toreal(AutoClosed) / TotalIncidents * 100, 0)), toint(0));\nlet ManualRequired = TotalIncidents - AutoClosed;\nprint Observation = pack_array(\n    iff(TotalAlerts > 0, strcat(\"‚ö° **Automation playbooks ran on \", TotalAlerts, \" MDO alerts.** These playbooks run automatically when certain alerts fire, consisting of automated activities like re-detonating URLs/files, hunting, and remediation.\"), \"\"),\n    iff(UniqueIncidents > 0 and TotalAlerts > UniqueIncidents, strcat(\"üìä **Automation correlated \", TotalAlerts, \" alerts into \", UniqueIncidents, \" unique incidents** (correlation: \", CorrelationPct, \"%). Incidents are grouped by likeness, reducing total workload.\"), \"\"),\n    iff(AutoClosed > 0, strcat(\"‚úÖ **\", AutoClosed, \" incidents were automatically closed** (\", AutoCloseRate, \"% of incidents closed by automation without staff intervention). After automation, \", ManualRequired, \" required manual investigation.\"), \"\"),\n    iff(PendingApproval > 0, strcat(\"‚è≥ **Automation has actions pending approval in \", PendingApproval, \" items.** When automation runs, certain actions may require your approval. You can [turn on auto-approval](https://security.microsoft.com/action-center) for certain action types.\"), \"\"),\n    iff(TimedOut > 0, strcat(\"‚ö†Ô∏è **Automation found \", TimedOut, \" threats where remediation timed out awaiting approval.** If actions are not approved within 7 days, they will time out. Consider enabling auto-approval for certain action types.\"), \"\"))\n| mv-expand Observation to typeof(string)\n| where isnotempty(Observation)",
              "size": 0,
              "title": "üìã Automation Observations",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "labelSettings": [{ "columnId": "Observation", "label": "Observations & Recommendations" }]
              }
            },
            "customWidth": "40",
            "name": "query - automation observations"
          },
          {
            "type": 1,
            "content": {
              "json": "**üí° Automation Resources:**\n- [Action Center](https://security.microsoft.com/action-center) - View and approve pending actions\n- [Automated Investigation Details](https://security.microsoft.com/airinvestigations) - Review AIR investigations\n- [Configure Auto-Approval](https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/air-review-approve-pending-completed-actions) - Reduce manual intervention"
            },
            "name": "text - automation resources"
          },
          {
            "type": 1,
            "content": {
              "json": "---"
            },
            "name": "text - separator"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Actions Taken Summary\nlet ZAP = toscalar(EmailPostDeliveryEvents | where TimeGenerated {TimeRange} | where ActionTrigger == \"ZAP\" | count);\nlet Admin = toscalar(EmailPostDeliveryEvents | where TimeGenerated {TimeRange} | where ActionTrigger has_any (\"Admin\", \"Manual\", \"Submission\") | count);\nlet PolicyBlocked = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where DeliveryAction == \"Blocked\" | count);\nlet Quarantined = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where DeliveryAction == \"Quarantined\" | count);\nlet SafeLinks = toscalar(UrlClickEvents | where TimeGenerated {TimeRange} | where IsClickedThrough == false | count);\nprint Action = dynamic([\"ZAP Auto-Purge\", \"Admin Remediation\", \"Policy Blocked\", \"Quarantined\", \"Safe Links Blocked\"]),\n      Count = pack_array(ZAP, Admin, PolicyBlocked, Quarantined, SafeLinks),\n      Category = dynamic([\"Automated\", \"Manual\", \"Prevention\", \"Prevention\", \"Prevention\"])\n| mv-expand Action to typeof(string), Count to typeof(long), Category to typeof(string)",
              "size": 0,
              "title": "‚úÖ Actions Taken - Remediation Summary",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "barchart",
              "chartSettings": {
                "xAxis": "Action",
                "yAxis": ["Count"],
                "seriesLabelSettings": [
                  { "seriesName": "Count", "color": "green" }
                ]
              }
            },
            "customWidth": "40",
            "name": "query - actions taken"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Weekly Trend - Threats vs Actions\nlet Threats = EmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(ThreatTypes)\n| summarize ThreatsDetected = count() by bin(TimeGenerated, 1d);\nlet Actions = EmailPostDeliveryEvents\n| where TimeGenerated {TimeRange}\n| summarize ActionsTaken = count() by bin(TimeGenerated, 1d);\nThreats\n| join kind=leftouter Actions on TimeGenerated\n| project TimeGenerated, ThreatsDetected, ActionsTaken = coalesce(ActionsTaken, 0)",
              "size": 0,
              "title": "üìà Trend: Threats Detected vs Actions Taken",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  { "seriesName": "ThreatsDetected", "color": "redBright" },
                  { "seriesName": "ActionsTaken", "color": "green" }
                ]
              }
            },
            "customWidth": "60",
            "name": "query - trend threats actions"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Email Security Risk Score\nlet PhishCount = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where ThreatTypes has \"Phish\" | count);\nlet MalCount = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where ThreatTypes has \"Malware\" | count);\nlet SpamCnt = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where ThreatTypes has \"Spam\" | count);\nlet BECCount = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailActionPolicy has_any (\"Anti-phishing\", \"impersonation\", \"domain\") | count);\nlet RiskScore = min_of(100, (PhishCount / 10) + (MalCount * 5) + (BECCount * 10) + (SpamCnt / 100));\nlet RiskLevel = case(RiskScore >= 80, \"üî¥ CRITICAL\", RiskScore >= 60, \"üü† HIGH\", RiskScore >= 40, \"üü° MEDIUM\", \"üü¢ LOW\");\nprint Metric = dynamic([\"üéØ Risk Score\", \"üìä Risk Level\", \"üé£ Phishing\", \"ü¶† Malware\", \"üìß Spam\", \"üíº BEC Indicators\"]),\n      Value = pack_array(RiskScore, 0, PhishCount, MalCount, SpamCnt, BECCount),\n      DisplayValue = pack_array(tostring(toint(RiskScore)), RiskLevel, tostring(PhishCount), tostring(MalCount), tostring(SpamCnt), tostring(BECCount))\n| mv-expand Metric to typeof(string), Value to typeof(long), DisplayValue to typeof(string)",
              "size": 4,
              "title": "üéØ Email Security Risk Score",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "DisplayValue", "formatter": 1 }
              }
            },
            "name": "query - risk score"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Threat Distribution by Type\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(ThreatTypes)\n| extend ThreatType = case(\n    ThreatTypes has \"Phish\", \"üé£ Phishing\",\n    ThreatTypes has \"Malware\", \"ü¶† Malware\",\n    ThreatTypes has \"Spam\", \"üìß Spam\",\n    \"‚ö†Ô∏è Other\")\n| summarize Count = count() by ThreatType\n| order by Count desc",
              "size": 2,
              "title": "üìä Threat Distribution",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "query - threat distribution"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Delivery Actions Summary\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| summarize Count = count() by DeliveryAction\n| extend Status = case(\n    DeliveryAction == \"Blocked\", \"‚úÖ Blocked\",\n    DeliveryAction == \"Delivered\", \"‚ö†Ô∏è Delivered\",\n    DeliveryAction == \"Quarantined\", \"üü° Quarantined\",\n    \"üìß Other\")\n| project Status, Count\n| order by Count desc",
              "size": 2,
              "title": "üì¨ Delivery Actions",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "query - delivery actions"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Email Direction Summary\nEmailEvents\n| where TimeGenerated {TimeRange}\n| summarize Count = count() by EmailDirection\n| extend Direction = case(\n    EmailDirection == \"Inbound\", \"üì• Inbound\",\n    EmailDirection == \"Outbound\", \"üì§ Outbound\",\n    EmailDirection == \"Intra-org\", \"üîÑ Internal\",\n    \"‚ùì Unknown\")\n| project Direction, Count\n| order by Count desc",
              "size": 2,
              "title": "üìß Email Direction",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "piechart"
            },
            "customWidth": "34",
            "name": "query - email direction"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Threat Timeline\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(ThreatTypes)\n| extend ThreatType = case(\n    ThreatTypes has \"Phish\", \"Phishing\",\n    ThreatTypes has \"Malware\", \"Malware\",\n    ThreatTypes has \"Spam\", \"Spam\",\n    \"Other\")\n| summarize Count = count() by ThreatType, bin(TimeGenerated, 1h)\n| order by TimeGenerated asc",
              "size": 0,
              "title": "üìà Threat Timeline",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "timechart"
            },
            "name": "query - threat timeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Targeted Recipients\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(ThreatTypes)\n| summarize \n    ThreatCount = count(),\n    PhishCount = countif(ThreatTypes has \"Phish\"),\n    MalwareCount = countif(ThreatTypes has \"Malware\"),\n    Senders = dcount(SenderFromAddress)\n    by RecipientEmailAddress\n| order by ThreatCount desc\n| take 10\n| extend RiskLevel = case(\n    ThreatCount > 50, \"üî¥ High Target\",\n    ThreatCount > 20, \"üü† Medium Target\",\n    \"üü° Low Target\")\n| project RiskLevel, RecipientEmailAddress, ThreatCount, PhishCount, MalwareCount, Senders",
              "size": 0,
              "title": "üéØ Top Targeted Recipients",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "ThreatCount", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - top targets"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Threat Senders\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(ThreatTypes)\n| where EmailDirection == \"Inbound\"\n| summarize \n    ThreatCount = count(),\n    Recipients = dcount(RecipientEmailAddress),\n    ThreatList = make_set(ThreatTypes, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by SenderFromAddress, SenderFromDomain\n| order by ThreatCount desc\n| take 10\n| extend RiskLevel = case(\n    ThreatCount > 100, \"üî¥ Prolific Attacker\",\n    ThreatCount > 50, \"üü† High Volume\",\n    \"üü° Moderate\")\n| project RiskLevel, SenderFromAddress, SenderFromDomain, ThreatCount, Recipients, ThreatList, FirstSeen, LastSeen",
              "size": 0,
              "title": "üö® Top Threat Senders",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "ThreatCount", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - threat senders"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üìã Workbook Coverage Summary\n\nThis workbook provides comprehensive visibility into:\n\n| Tab | Coverage Area | Key Metrics |\n|-----|---------------|-------------|\n| **Executive Summary** | KPIs, Risk Score, Protection Value | URL/File Detonation, Delivery Locations, Automation (AIR), Campaigns, MITRE ATT&CK |\n| **BEC Detection** | Business Email Compromise | Domain/User Impersonation, Invoice Fraud, Payment Diversion |\n| **AiTM Phishing** | Adversary-in-the-Middle | Session Hijack, Token Theft, MFA Bypass, Cookie Theft |\n| **Phishing Analysis** | Credential Harvesting | Phish URLs, Brand Impersonation, QR Code Phishing |\n| **Malware & Attachments** | Malicious Files | Safe Attachments, File Detonation, Macro Analysis |\n| **Geo Threat Map** | Geographic Analysis | Origin Countries, Suspicious Regions, Geo-Anomalies |\n| **Campaigns** | Threat Intelligence | Attack Patterns, Campaign Tracking, MITRE Techniques |\n| **URL Analysis** | Link Protection | Safe Links (Email/Teams/Office), Time-of-Click, Detonation |\n| **ZAP & Remediation** | Post-Delivery Protection | Zero-Hour Purge, Admin Actions, Teams/SharePoint/OneDrive |\n| **XDR & Attack Chains** | Cross-Platform Correlation | Incidents by Tag, Alert Correlation, Attack Timeline |\n| **Email Security Config** | Configuration Analyzer | Preset Policies, Anti-Phishing/Spam/Malware, DMARC/DKIM/SPF, Quarantine, Allow/Block Lists |\n| **Investigation** | Threat Hunting | Priority Accounts, Spoofing Detection, Internal Protection, Custom Queries |"
            },
            "name": "text - workbook summary"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Post-Delivery Protection Summary\nlet ZAPRemoved = toscalar(EmailPostDeliveryEvents | where TimeGenerated {TimeRange} | where ActionTrigger == \"ZAP\" | where ActionResult == \"Success\" | count);\nlet AdminRemediated = toscalar(EmailPostDeliveryEvents | where TimeGenerated {TimeRange} | where ActionTrigger has_any (\"Admin\", \"Manual\", \"Submission\") | where ActionResult == \"Success\" | count);\nlet SafeLinksBlocked = toscalar(UrlClickEvents | where TimeGenerated {TimeRange} | where IsClickedThrough == false | count);\nlet SafeLinksAllowed = toscalar(UrlClickEvents | where TimeGenerated {TimeRange} | where IsClickedThrough == true | count);\nlet TeamsMalware = toscalar(OfficeActivity | where TimeGenerated {TimeRange} | where OfficeWorkload == \"MicrosoftTeams\" | where Operation has_any (\"FileMalwareDetected\", \"Malware\") | count);\nlet SharePointMalware = toscalar(OfficeActivity | where TimeGenerated {TimeRange} | where OfficeWorkload in (\"SharePoint\", \"OneDrive\") | where Operation has_any (\"FileMalwareDetected\", \"FileBlocked\", \"SharingRevoked\") | count);\nprint Category = dynamic([\"üìß Email - ZAP Purged\", \"üë§ Email - Admin Remediated\", \"üîó Safe Links - Blocked\", \"‚úÖ Safe Links - Allowed\", \"üí¨ Teams - Malware Blocked\", \"üìÅ SharePoint/OneDrive - Protected\"]),\n      Count = pack_array(ZAPRemoved, AdminRemediated, SafeLinksBlocked, SafeLinksAllowed, TeamsMalware, SharePointMalware)\n| mv-expand Category to typeof(string), Count to typeof(long)",
              "size": 0,
              "title": "üõ°Ô∏è Post-Delivery Protection Actions",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "barchart",
              "chartSettings": {
                "xAxis": "Category",
                "yAxis": ["Count"],
                "seriesLabelSettings": [
                  { "seriesName": "Count", "color": "blue" }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - post delivery protection"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// XDR Incident Trend by Tag Classification\nSecurityIncident\n| where TimeGenerated {TimeRange}\n| where Labels has_any (\"BEC\", \"AiTM\", \"Phishing\", \"phishing\", \"Credential\", \"credential\", \"Malware\", \"malware\")\n| extend IncidentType = case(\n    Labels has \"BEC\", \"üî¥ BEC\",\n    Labels has \"AiTM\", \"üü† AiTM\",\n    Labels has_any (\"Phishing\", \"phishing\", \"Credential\", \"credential\"), \"üé£ Phishing\",\n    Labels has_any (\"Malware\", \"malware\"), \"ü¶† Malware\",\n    \"‚ö†Ô∏è Other\")\n| summarize IncidentCount = count() by IncidentType, bin(TimeGenerated, 1d)\n| order by TimeGenerated asc",
              "size": 0,
              "title": "üìà Security Incident Trend by Tag",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "linechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  { "seriesName": "üî¥ BEC", "color": "redBright" },
                  { "seriesName": "üé£ Phishing", "color": "orange" },
                  { "seriesName": "üü† AiTM", "color": "yellow" },
                  { "seriesName": "ü¶† Malware", "color": "purple" }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - incident trend"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Executive"
      },
      "name": "group - executive"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üî¥ Business Email Compromise (BEC) Detection\n\n**MITRE ATT&CK:** T1566.001 - Spearphishing Attachment, T1566.002 - Spearphishing Link, T1534 - Internal Spearphishing\n\n| BEC Type | Description | Key Indicators |\n|----------|-------------|----------------|\n| **CEO/Executive Fraud** | Impersonating executives to request wire transfers | Urgency, financial requests, display name spoofing |\n| **Vendor/Invoice Fraud** | Compromised vendor accounts or impersonation | Invoice changes, new bank details, payment urgency |\n| **Account Compromise** | Legitimate account taken over | Unusual sending patterns, forwarding rules, new IPs |\n| **Attorney Impersonation** | Fake legal requests | Confidentiality claims, urgent wire transfers |\n| **Data Theft** | Requesting W-2s, PII, or sensitive data | HR/Finance targeting, bulk data requests |\n\n---\n\n### üîç BEC Hunting Queries"
            },
            "name": "text - bec header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Domain Impersonation Detection\n// Detect emails where anti-phishing policies flagged domain impersonation\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailActionPolicy has_any (\"Anti-phishing\", \"domain impersonation\", \"impersonation\")\n| summarize \n    Count = count(),\n    Recipients = make_set(RecipientEmailAddress, 10),\n    UniqueRecipients = dcount(RecipientEmailAddress),\n    Subjects = make_set(Subject, 5),\n    Actions = make_set(DeliveryAction, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by SenderFromAddress, SenderFromDomain, SenderDisplayName\n| extend ThreatLevel = case(\n    Count > 50, \"üî¥ Critical - Mass Impersonation\",\n    Count > 20, \"üî¥ High\",\n    Count > 5, \"üü† Medium\",\n    \"üü° Low\")\n| order by Count desc\n| project ThreatLevel, SenderDisplayName, SenderFromAddress, SenderFromDomain, Count, UniqueRecipients, Subjects, Actions, FirstSeen, LastSeen",
              "size": 0,
              "title": "üé≠ Domain Impersonation Attempts",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "name": "query - domain impersonation"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// BEC Subject Line Analysis - Financial Keywords\n// Hunt for emails with financial/urgent subject lines\nlet BECKeywords = dynamic([\"urgent\", \"wire\", \"transfer\", \"payment\", \"invoice\", \"bank\", \"account\", \"confidential\", \"immediate\", \"asap\", \"w-2\", \"w2\", \"tax\", \"payroll\", \"ach\", \"direct deposit\", \"vendor\", \"supplier\"]);\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| extend SubjectLower = tolower(Subject)\n| where SubjectLower has_any (BECKeywords)\n| extend MatchedKeywords = extract_all(@\"(urgent|wire|transfer|payment|invoice|bank|account|confidential|immediate|asap|w-2|w2|tax|payroll|ach|direct deposit|vendor|supplier)\", SubjectLower)\n| where array_length(MatchedKeywords) > 0\n| summarize \n    Count = count(),\n    Recipients = make_set(RecipientEmailAddress, 5),\n    Subjects = make_set(Subject, 5),\n    DeliveredCount = countif(DeliveryAction == \"Delivered\"),\n    BlockedCount = countif(DeliveryAction == \"Blocked\")\n    by SenderFromAddress, SenderFromDomain, SenderDisplayName\n| where Count > 1\n| extend RiskLevel = case(\n    DeliveredCount > 10, \"üî¥ Critical - Many Delivered\",\n    DeliveredCount > 5, \"üü† High\",\n    DeliveredCount > 0, \"üü° Medium\",\n    \"üü¢ Blocked\")\n| order by DeliveredCount desc, Count desc\n| project RiskLevel, SenderDisplayName, SenderFromAddress, SenderFromDomain, Count, DeliveredCount, BlockedCount, Subjects, Recipients",
              "size": 0,
              "title": "üí∞ BEC Keyword Detection (Financial/Urgent)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "DeliveredCount", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - bec keywords"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Authentication Failures - Spoofing Attempts\n// Emails failing SPF/DKIM/DMARC\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| where AuthenticationDetails has_any (\"fail\", \"none\", \"softfail\")\n| extend \n    SPFResult = extract(@\"spf=([a-z]+)\", 1, tolower(AuthenticationDetails)),\n    DKIMResult = extract(@\"dkim=([a-z]+)\", 1, tolower(AuthenticationDetails)),\n    DMARCResult = extract(@\"dmarc=([a-z]+)\", 1, tolower(AuthenticationDetails))\n| where SPFResult in (\"fail\", \"softfail\", \"none\") or DKIMResult in (\"fail\", \"none\") or DMARCResult in (\"fail\", \"none\")\n| summarize \n    FailCount = count(),\n    Recipients = dcount(RecipientEmailAddress),\n    Subjects = make_set(Subject, 3),\n    DeliveredCount = countif(DeliveryAction == \"Delivered\")\n    by SenderFromDomain, SPFResult, DKIMResult, DMARCResult\n| where FailCount > 5\n| extend AuthStatus = strcat(\"SPF:\", coalesce(SPFResult, \"-\"), \" DKIM:\", coalesce(DKIMResult, \"-\"), \" DMARC:\", coalesce(DMARCResult, \"-\"))\n| extend RiskLevel = case(\n    DMARCResult == \"fail\" and DeliveredCount > 0, \"üî¥ DMARC Fail - Delivered\",\n    SPFResult == \"fail\" and DKIMResult == \"fail\", \"üî¥ Both SPF/DKIM Fail\",\n    \"üü† Authentication Issues\")\n| order by DeliveredCount desc\n| project RiskLevel, SenderFromDomain, AuthStatus, FailCount, Recipients, DeliveredCount, Subjects",
              "size": 0,
              "title": "üîì Email Authentication Failures (SPF/DKIM/DMARC)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "DeliveredCount", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - auth failures"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Display Name Spoofing Detection\n// External senders using internal-looking display names\nlet InternalDomains = EmailEvents\n    | where TimeGenerated {TimeRange}\n    | where EmailDirection == \"Outbound\"\n    | distinct SenderFromDomain;\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| where isnotempty(SenderDisplayName)\n| extend DisplayNameLower = tolower(SenderDisplayName)\n// Look for display names containing common executive titles or internal patterns\n| where DisplayNameLower has_any (\"ceo\", \"cfo\", \"cto\", \"ciso\", \"president\", \"director\", \"vp\", \"chief\", \"executive\", \"manager\", \"hr\", \"human resources\", \"payroll\", \"accounting\", \"finance\")\n| join kind=leftanti InternalDomains on $left.SenderFromDomain == $right.SenderFromDomain\n| summarize \n    Count = count(),\n    Recipients = make_set(RecipientEmailAddress, 5),\n    Domains = make_set(SenderFromDomain, 5),\n    Subjects = make_set(Subject, 3),\n    DeliveredCount = countif(DeliveryAction == \"Delivered\")\n    by SenderDisplayName\n| where Count > 1\n| extend RiskLevel = case(\n    DeliveredCount > 5, \"üî¥ Critical - Executive Impersonation\",\n    DeliveredCount > 0, \"üü† High - Delivered\",\n    \"üü° Blocked\")\n| order by DeliveredCount desc\n| project RiskLevel, SenderDisplayName, Count, DeliveredCount, Domains, Subjects, Recipients",
              "size": 0,
              "title": "üëî Display Name Spoofing (Executive Impersonation)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "name": "query - display name spoofing"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Internal Account Compromise Detection\n// Look for unusual outbound email patterns that may indicate compromised accounts\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Outbound\"\n| summarize \n    TotalSent = count(),\n    UniqueRecipients = dcount(RecipientEmailAddress),\n    ExternalRecipients = dcountif(RecipientEmailAddress, not(RecipientEmailAddress has SenderFromDomain)),\n    UniqueSubjects = dcount(Subject),\n    UniqueHours = dcount(bin(TimeGenerated, 1h)),\n    FirstEmail = min(TimeGenerated),\n    LastEmail = max(TimeGenerated)\n    by SenderFromAddress\n| extend EmailsPerHour = round(toreal(TotalSent) / max_of(UniqueHours, 1), 2)\n| where EmailsPerHour > 20 or ExternalRecipients > 50\n| extend RiskLevel = case(\n    EmailsPerHour > 100, \"üî¥ Critical - Mass Mailing\",\n    ExternalRecipients > 100, \"üî¥ Critical - External Blast\",\n    EmailsPerHour > 50, \"üü† High Volume\",\n    \"üü° Unusual\")\n| order by EmailsPerHour desc\n| project RiskLevel, SenderFromAddress, TotalSent, UniqueRecipients, ExternalRecipients, EmailsPerHour, UniqueSubjects, FirstEmail, LastEmail",
              "size": 0,
              "title": "üì§ Potential Account Compromise (Unusual Outbound)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "EmailsPerHour", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "name": "query - account compromise"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üìã BEC Investigation Reference\n\n**Key BEC Indicators:**\n- Domain typosquatting (micros0ft.com vs microsoft.com)\n- Display name mimicking executives/vendors\n- Urgency language in subject/body\n- Requests for financial action or sensitive data\n- Authentication failures (SPF/DKIM/DMARC fail)\n- First-time sender to organization\n\n**Investigation Steps:**\n1. Review sender authentication details\n2. Check for similar emails to other recipients\n3. Analyze email content for social engineering\n4. Verify legitimacy with claimed sender out-of-band\n5. Check for inbox rules created post-compromise"
            },
            "name": "text - bec reference"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "BEC"
      },
      "name": "group - bec"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üü† Adversary-in-the-Middle (AiTM) Phishing Detection\n\n**MITRE ATT&CK:** T1557 - Adversary-in-the-Middle, T1539 - Steal Web Session Cookie\n\nAiTM attacks use reverse proxy infrastructure to intercept credentials AND session tokens, bypassing MFA. This section correlates email phishing attempts with sign-in anomalies to detect AiTM attacks.\n\n---\n\n### üîç AiTM Attack Indicators\n\n| Indicator | Description |\n|-----------|-------------|\n| **Phishing Email ‚Üí Quick Sign-in** | User receives phishing email, then signs in from unusual location |\n| **Session Token Theft** | Successful MFA followed by impossible travel |\n| **Evilginx/Modlishka Infrastructure** | Known AiTM proxy domains |\n| **OAuth Consent Phishing** | Malicious app consent requests |"
            },
            "name": "text - aitm header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AiTM Correlation: Phishing Email + Suspicious Sign-in\n// Correlate users who received phishing emails with subsequent sign-ins from new locations\nlet PhishingRecipients = EmailEvents\n    | where TimeGenerated {TimeRange}\n    | where ThreatTypes has \"Phish\"\n    | where DeliveryAction in (\"Delivered\", \"Junked\")\n    | summarize PhishEmails = count(), LastPhish = max(TimeGenerated) by RecipientEmailAddress\n    | project UserPrincipalName = RecipientEmailAddress, PhishEmails, LastPhish;\nSigninLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\" // Successful sign-ins\n| join kind=inner PhishingRecipients on UserPrincipalName\n| where TimeGenerated > LastPhish // Sign-in after phishing email\n| where datetime_diff('hour', TimeGenerated, LastPhish) <= 24 // Within 24 hours\n| extend Country = tostring(LocationDetails.countryOrRegion)\n| extend City = tostring(LocationDetails.city)\n| extend TimeSincePhish = datetime_diff('minute', TimeGenerated, LastPhish)\n| summarize \n    SignInCount = count(),\n    Countries = make_set(Country, 5),\n    IPs = make_set(IPAddress, 5),\n    Apps = make_set(AppDisplayName, 5),\n    AvgMinutesAfterPhish = avg(TimeSincePhish)\n    by UserPrincipalName, PhishEmails\n| extend RiskLevel = case(\n    AvgMinutesAfterPhish < 30, \"üî¥ Critical - Quick Compromise\",\n    AvgMinutesAfterPhish < 60, \"üî¥ High - Fast Response\",\n    AvgMinutesAfterPhish < 240, \"üü† Medium\",\n    \"üü° Investigate\")\n| order by AvgMinutesAfterPhish asc\n| project RiskLevel, UserPrincipalName, PhishEmails, SignInCount, AvgMinutesAfterPhish, Countries, IPs, Apps",
              "size": 0,
              "title": "üî¥ AiTM Alert: Phishing Email ‚Üí Suspicious Sign-in Correlation",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "AvgMinutesAfterPhish", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "name": "query - aitm correlation"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// URL Click ‚Üí Immediate Sign-in Correlation\n// Users who clicked on URLs and then had sign-in activity\nlet ClickedUsers = UrlClickEvents\n    | where TimeGenerated {TimeRange}\n    | where IsClickedThrough == true\n    | where ThreatTypes has_any (\"Phish\", \"Malware\")\n    | summarize ClickCount = count(), LastClick = max(TimeGenerated), URLs = make_set(Url, 3) by AccountUpn\n    | extend URLsString = tostring(URLs)\n    | project UserPrincipalName = AccountUpn, ClickCount, LastClick, URLsString;\nSigninLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\"\n| join kind=inner ClickedUsers on UserPrincipalName\n| where TimeGenerated > LastClick\n| where datetime_diff('minute', TimeGenerated, LastClick) <= 60\n| extend Country = tostring(LocationDetails.countryOrRegion)\n| extend TimeSinceClick = datetime_diff('minute', TimeGenerated, LastClick)\n| summarize \n    SignIns = count(),\n    Countries = make_set(Country, 5),\n    IPs = make_set(IPAddress, 5)\n    by UserPrincipalName, ClickCount, URLsString\n| extend RiskLevel = case(\n    SignIns > 5, \"üî¥ Critical - Multiple Sign-ins After Click\",\n    array_length(Countries) > 1, \"üî¥ Critical - Multi-Country\",\n    \"üü† High - Investigate\")\n| order by SignIns desc\n| project RiskLevel, UserPrincipalName, ClickCount, SignIns, Countries, IPs, URLs = URLsString",
              "size": 0,
              "title": "üîó URL Click ‚Üí Sign-in Correlation",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "query - click signin"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Known AiTM Infrastructure Detection\n// Detect URLs containing known AiTM/Phishing toolkit patterns\nlet AiTMPatterns = dynamic([\"evilginx\", \"modlishka\", \"muraena\", \"gophish\", \"credsniper\", \"-login\", \"login-\", \"signin-\", \"auth-\", \"verify-\", \"secure-\", \"account-\", \"update-\", \"confirm-\"]);\nEmailUrlInfo\n| where TimeGenerated {TimeRange}\n| extend UrlLower = tolower(Url)\n| extend DomainLower = tolower(UrlDomain)\n| where UrlLower has_any (AiTMPatterns) or DomainLower has_any (AiTMPatterns)\n| join kind=inner (\n    EmailEvents\n    | where TimeGenerated {TimeRange}\n    | project NetworkMessageId, RecipientEmailAddress, SenderFromAddress, Subject, DeliveryAction\n) on NetworkMessageId\n| summarize \n    Count = count(),\n    Recipients = make_set(RecipientEmailAddress, 10),\n    Senders = make_set(SenderFromAddress, 5),\n    DeliveredCount = countif(DeliveryAction == \"Delivered\")\n    by UrlDomain, Url\n| extend RiskLevel = case(\n    DeliveredCount > 5, \"üî¥ Critical - AiTM Infrastructure Delivered\",\n    DeliveredCount > 0, \"üü† High\",\n    \"üü° Blocked\")\n| order by DeliveredCount desc\n| project RiskLevel, UrlDomain, Url, Count, DeliveredCount, Recipients, Senders",
              "size": 0,
              "title": "üé£ Known AiTM/Phishing Toolkit URLs",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "query - aitm urls"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// XDR Alerts: AiTM and Credential Theft\nAlertInfo\n| where TimeGenerated {TimeRange}\n| where Title has_any (\"AiTM\", \"adversary-in-the-middle\", \"phishing\", \"credential\", \"token\", \"session\", \"oauth\")\n| join kind=leftouter (\n    AlertEvidence\n    | where TimeGenerated {TimeRange}\n    | summarize \n        Users = make_set(AccountUpn, 5),\n        Emails = make_set(EmailSubject, 3),\n        URLs = make_set(RemoteUrl, 5),\n        IPs = make_set(RemoteIP, 5)\n        by AlertId\n) on AlertId\n| project TimeGenerated, Severity, Title, Category, ServiceSource, Users, Emails, URLs, IPs, AttackTechniques\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üö® XDR Alerts: AiTM & Credential Theft",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "name": "query - aitm alerts"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üìã AiTM Investigation Playbook\n\n**Detection Correlation Points:**\n1. **Email ‚Üí Click ‚Üí Sign-in** - User receives phishing, clicks URL, signs in from new location\n2. **MFA Satisfied ‚Üí New IP** - MFA completed but session used from different IP\n3. **OAuth Consent** - User grants consent to malicious app\n4. **Inbox Rule Creation** - Post-compromise rule creation\n\n**Response Actions:**\n1. Revoke all refresh tokens for user\n2. Reset password and MFA methods\n3. Review audit logs for inbox rules and forwarding\n4. Block identified malicious URLs/domains\n5. Hunt for other affected users"
            },
            "name": "text - aitm reference"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "AiTM"
      },
      "name": "group - aitm"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üé£ Phishing Analysis\n\n**MITRE ATT&CK:** T1566 - Phishing\n\nComprehensive analysis of phishing attempts including credential harvesting, brand impersonation, and domain spoofing."
            },
            "name": "text - phishing header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Phishing Overview Metrics\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has \"Phish\"\n| summarize \n    TotalPhishing = count(),\n    Blocked = countif(DeliveryAction == \"Blocked\"),\n    Delivered = countif(DeliveryAction == \"Delivered\"),\n    Quarantined = countif(DeliveryAction == \"Quarantined\"),\n    UniqueRecipients = dcount(RecipientEmailAddress),\n    UniqueSenders = dcount(SenderFromAddress),\n    UniqueDomains = dcount(SenderFromDomain)\n| extend BlockRate = round(toreal(Blocked) / TotalPhishing * 100, 1)\n| project \n    Metric = pack_array(\"Total Phishing\", \"Blocked\", \"Delivered ‚ö†Ô∏è\", \"Quarantined\", \"Block Rate %\", \"Targeted Users\", \"Attack Sources\"),\n    Value = pack_array(TotalPhishing, Blocked, Delivered, Quarantined, BlockRate, UniqueRecipients, UniqueSenders)\n| mv-expand Metric to typeof(string), Value to typeof(real)",
              "size": 4,
              "title": "üìä Phishing Metrics",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "auto" } }
              }
            },
            "name": "query - phishing metrics"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Phishing by Detection Method\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has \"Phish\"\n| extend DetectionMethod = tostring(parse_json(DetectionMethods))\n| summarize Count = count() by DetectionMethod, DeliveryAction\n| order by Count desc",
              "size": 0,
              "title": "üîç Detection Methods",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "barchart"
            },
            "customWidth": "50",
            "name": "query - detection methods"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Phishing Timeline by Confidence\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has \"Phish\"\n| summarize \n    HighConfidence = countif(ConfidenceLevel == \"High\"),\n    LowConfidence = countif(ConfidenceLevel == \"Low\" or ConfidenceLevel == \"\"),\n    Delivered = countif(DeliveryAction == \"Delivered\")\n    by bin(TimeGenerated, 1h)\n| order by TimeGenerated asc",
              "size": 0,
              "title": "üìà Phishing Timeline",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "query - phishing timeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Phishing Domains - Top Attackers\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has \"Phish\"\n| summarize \n    Count = count(),\n    DeliveredCount = countif(DeliveryAction == \"Delivered\"),\n    Recipients = dcount(RecipientEmailAddress),\n    Subjects = make_set(Subject, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by SenderFromDomain\n| extend RiskLevel = case(\n    DeliveredCount > 10, \"üî¥ Critical\",\n    DeliveredCount > 5, \"üü† High\",\n    DeliveredCount > 0, \"üü° Medium\",\n    \"üü¢ Blocked\")\n| order by DeliveredCount desc, Count desc\n| take 20\n| project RiskLevel, SenderFromDomain, Count, DeliveredCount, Recipients, Subjects, FirstSeen, LastSeen",
              "size": 0,
              "title": "üåê Top Phishing Domains",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "DeliveredCount", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "name": "query - phishing domains"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Delivered Phishing - Requires Investigation\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has \"Phish\"\n| where DeliveryAction == \"Delivered\"\n| project TimeGenerated, RecipientEmailAddress, SenderFromAddress, SenderDisplayName, Subject, SenderFromDomain, ConfidenceLevel, DeliveryLocation, NetworkMessageId\n| order by TimeGenerated desc\n| take 100",
              "size": 0,
              "title": "‚ö†Ô∏è Delivered Phishing - Requires Investigation",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "name": "query - delivered phishing"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Phishing"
      },
      "name": "group - phishing"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## ü¶† Malware & Attachment Analysis\n\n**MITRE ATT&CK:** T1566.001 - Spearphishing Attachment, T1204.002 - Malicious File\n\nAnalyze malicious attachments, weaponized documents, and payload delivery mechanisms."
            },
            "name": "text - malware header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Malware Overview - All Malware Emails\nlet EmailMalware = EmailEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has \"Malware\"\n| summarize \n    TotalMalicious = count(),\n    Inbound = countif(EmailDirection == \"Inbound\"),\n    Outbound = countif(EmailDirection == \"Outbound\"),\n    IntraOrg = countif(EmailDirection == \"Intra-org\"),\n    WithAttachments = countif(AttachmentCount > 0),\n    Blocked = countif(DeliveryAction in (\"Blocked\", \"Quarantined\")),\n    Delivered = countif(DeliveryAction == \"Delivered\");\nEmailMalware\n| project \n    Metric = pack_array(\"ü¶† Total Malware\", \"üì• Inbound\", \"üì§ Outbound\", \"üè¢ Intra-Org\", \"üìé Attachments\", \"‚úÖ Blocked\", \"‚ö†Ô∏è Delivered\"),\n    Value = pack_array(TotalMalicious, Inbound, Outbound, IntraOrg, WithAttachments, Blocked, Delivered)\n| mv-expand Metric to typeof(string), Value to typeof(long)",
              "size": 4,
              "title": "üìä Malware Attachment Metrics",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "auto" } }
              }
            },
            "name": "query - malware metrics"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Malware Detection Methods\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has \"Malware\"\n| extend Method = case(\n    DetectionMethods has \"File detonation\", \"File Detonation\",\n    DetectionMethods has \"Safe Attachments\", \"Safe Attachments\",\n    DetectionMethods has \"File reputation\", \"File Reputation\",\n    DetectionMethods has \"Antimalware\", \"Anti-Malware Engine\",\n    DetectionMethods has \"URL detonation\", \"URL Detonation\",\n    DetectionMethods has \"Campaign\", \"Campaign Detection\",\n    isempty(DetectionMethods), \"Unknown\",\n    \"Other\")\n| summarize Count = count() by Method\n| order by Count desc",
              "size": 2,
              "title": "ÔøΩÔ∏è Detection Methods",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "query - malware filetypes"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Malware Delivery Actions\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has \"Malware\"\n| summarize Count = count() by DeliveryAction\n| extend ActionLabel = case(\n    DeliveryAction == \"Blocked\", \"‚úÖ Blocked\",\n    DeliveryAction == \"Quarantined\", \"üü° Quarantined\",\n    DeliveryAction == \"Delivered\", \"‚ö†Ô∏è Delivered\",\n    DeliveryAction == \"Replaced\", \"üîÑ Replaced\",\n    isempty(DeliveryAction), \"Unknown\",\n    \"Other\")\n| project ActionLabel, Count\n| order by Count desc",
              "size": 2,
              "title": "üìä Delivery Actions",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "query - threat families"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Malware Email Timeline\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has \"Malware\"\n| summarize \n    Blocked = countif(DeliveryAction in (\"Blocked\", \"Quarantined\")),\n    Delivered = countif(DeliveryAction == \"Delivered\"),\n    Total = count()\n    by bin(TimeGenerated, 1h)\n| order by TimeGenerated asc",
              "size": 0,
              "title": "üìà Malware Timeline",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "timechart"
            },
            "customWidth": "34",
            "name": "query - malware timeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Malware Senders & Domains\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has \"Malware\"\n| summarize \n    Count = count(),\n    Recipients = dcount(RecipientEmailAddress),\n    Inbound = countif(EmailDirection == \"Inbound\"),\n    Outbound = countif(EmailDirection == \"Outbound\"),\n    Blocked = countif(DeliveryAction in (\"Blocked\", \"Quarantined\")),\n    Delivered = countif(DeliveryAction == \"Delivered\"),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by SenderFromDomain, SenderFromAddress\n| extend RiskLevel = case(\n    Delivered > 0, \"üî¥ CRITICAL - Malware Delivered\",\n    Count > 20, \"üü† High Volume Attack\",\n    Count > 5, \"üü° Medium\",\n    \"üü¢ Low\")\n| order by Delivered desc, Count desc\n| take 20\n| project RiskLevel, SenderFromDomain, SenderFromAddress, Count, Inbound, Outbound, Blocked, Delivered, Recipients, FirstSeen, LastSeen",
              "size": 0,
              "title": "üîç Top Malware Attack Sources",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "name": "query - malware hashes"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Malware Targeted Recipients\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has \"Malware\"\n| summarize \n    MalwareReceived = count(),\n    UniqueSenders = dcount(SenderFromAddress),\n    Inbound = countif(EmailDirection == \"Inbound\"),\n    Blocked = countif(DeliveryAction in (\"Blocked\", \"Quarantined\")),\n    Delivered = countif(DeliveryAction == \"Delivered\"),\n    LatestDelivery = max(TimeGenerated),\n    Subjects = make_set(Subject, 3)\n    by RecipientEmailAddress\n| extend RiskLevel = case(\n    Delivered > 0, \"üî¥ MALWARE DELIVERED\",\n    MalwareReceived > 10, \"üü† Heavily Targeted\",\n    \"üü¢ Protected\")\n| order by Delivered desc, MalwareReceived desc\n| take 25\n| project RiskLevel, RecipientEmailAddress, MalwareReceived, Inbound, Blocked, Delivered, UniqueSenders, LatestDelivery, Subjects",
              "size": 0,
              "title": "üéØ Malware Targeted Recipients",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "name": "query - weaponized docs"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Malware"
      },
      "name": "group - malware"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üåç Geographic Threat Analysis & Trusted Location Validation\n\nVisualize the geographic origin of email threats and validate sign-in locations against your Entra ID Named Locations (trusted networks).\n\n| üåç Email Threats | üîê Sign-in Analysis |\n|-----------------|---------------------|\n| Phishing, Spam, Malware by sender domain/country | Sign-ins from trusted vs untrusted locations |"
            },
            "name": "text - geomap header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Email Threats Geographic Map (TLD to Country)\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(ThreatTypes)\n| extend TLD = tolower(tostring(split(SenderFromDomain, \".\")[-1]))\n| extend Country = case(\n    TLD == \"ru\", \"Russia\",\n    TLD == \"su\", \"Russia\",\n    TLD == \"cn\", \"China\",\n    TLD == \"br\", \"Brazil\",\n    TLD == \"in\", \"India\",\n    TLD == \"ng\", \"Nigeria\",\n    TLD == \"za\", \"South Africa\",\n    TLD == \"pk\", \"Pakistan\",\n    TLD == \"ua\", \"Ukraine\",\n    TLD == \"ir\", \"Iran\",\n    TLD == \"kp\", \"North Korea\",\n    TLD == \"de\", \"Germany\",\n    TLD == \"fr\", \"France\",\n    TLD == \"uk\", \"United Kingdom\",\n    TLD == \"gb\", \"United Kingdom\",\n    TLD == \"us\", \"United States\",\n    TLD == \"jp\", \"Japan\",\n    TLD == \"au\", \"Australia\",\n    TLD == \"ca\", \"Canada\",\n    TLD == \"nl\", \"Netherlands\",\n    TLD == \"pl\", \"Poland\",\n    TLD == \"it\", \"Italy\",\n    TLD == \"es\", \"Spain\",\n    TLD == \"mx\", \"Mexico\",\n    TLD == \"ar\", \"Argentina\",\n    TLD == \"co\", \"Colombia\",\n    TLD == \"kr\", \"South Korea\",\n    TLD == \"tr\", \"Turkey\",\n    TLD == \"id\", \"Indonesia\",\n    TLD == \"my\", \"Malaysia\",\n    TLD == \"sg\", \"Singapore\",\n    TLD == \"th\", \"Thailand\",\n    TLD == \"vn\", \"Vietnam\",\n    TLD == \"ph\", \"Philippines\",\n    TLD == \"eg\", \"Egypt\",\n    TLD == \"il\", \"Israel\",\n    TLD == \"ae\", \"United Arab Emirates\",\n    TLD == \"sa\", \"Saudi Arabia\",\n    TLD == \"se\", \"Sweden\",\n    TLD == \"no\", \"Norway\",\n    TLD == \"dk\", \"Denmark\",\n    TLD == \"fi\", \"Finland\",\n    TLD == \"be\", \"Belgium\",\n    TLD == \"ch\", \"Switzerland\",\n    TLD == \"at\", \"Austria\",\n    TLD == \"pt\", \"Portugal\",\n    TLD == \"gr\", \"Greece\",\n    TLD == \"cz\", \"Czech Republic\",\n    TLD == \"ro\", \"Romania\",\n    TLD == \"hu\", \"Hungary\",\n    TLD == \"bg\", \"Bulgaria\",\n    TLD == \"sk\", \"Slovakia\",\n    TLD == \"hr\", \"Croatia\",\n    TLD == \"rs\", \"Serbia\",\n    TLD == \"by\", \"Belarus\",\n    TLD == \"kz\", \"Kazakhstan\",\n    TLD == \"nz\", \"New Zealand\",\n    TLD == \"ie\", \"Ireland\",\n    TLD == \"cl\", \"Chile\",\n    TLD == \"pe\", \"Peru\",\n    TLD == \"ve\", \"Venezuela\",\n    TLD == \"bd\", \"Bangladesh\",\n    TLD == \"lk\", \"Sri Lanka\",\n    TLD == \"ke\", \"Kenya\",\n    TLD == \"gh\", \"Ghana\",\n    TLD == \"tz\", \"Tanzania\",\n    TLD == \"ug\", \"Uganda\",\n    TLD == \"ma\", \"Morocco\",\n    TLD == \"dz\", \"Algeria\",\n    TLD == \"tn\", \"Tunisia\",\n    \"\")\n| where isnotempty(Country)\n| summarize \n    ThreatCount = count(),\n    Phishing = countif(ThreatTypes has \"Phish\"),\n    Malware = countif(ThreatTypes has \"Malware\"),\n    Spam = countif(ThreatTypes has \"Spam\"),\n    Delivered = countif(DeliveryAction == \"Delivered\")\n    by Country\n| extend RiskScore = (Phishing * 5) + (Malware * 10) + (Delivered * 20) + (Spam)\n| order by ThreatCount desc",
              "size": 0,
              "title": "üó∫Ô∏è Email Threat Sources Map (Phishing, Malware, Spam)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "map",
              "mapSettings": {
                "locInfo": "CountryRegion",
                "locInfoColumn": "Country",
                "sizeSettings": "ThreatCount",
                "sizeAggregation": "Sum",
                "legendMetric": "ThreatCount",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "RiskScore",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "name": "query - email threat geo map"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Email Threats Overview by Top Level Domain\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(ThreatTypes)\n| extend TLD = tolower(tostring(split(SenderFromDomain, \".\")[-1]))\n| summarize \n    ThreatCount = count(),\n    Phishing = countif(ThreatTypes has \"Phish\"),\n    Malware = countif(ThreatTypes has \"Malware\"),\n    Spam = countif(ThreatTypes has \"Spam\"),\n    Delivered = countif(DeliveryAction == \"Delivered\"),\n    Blocked = countif(DeliveryAction in (\"Blocked\", \"Quarantined\"))\n    by TLD\n| extend RiskScore = Phishing * 5 + Malware * 10 + Delivered * 20\n| order by ThreatCount desc\n| take 25",
              "size": 0,
              "title": "üåê Email Threats by TLD (Top Level Domain)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "barchart",
              "chartSettings": {
                "xAxis": "TLD",
                "yAxis": ["Phishing", "Malware", "Spam"],
                "seriesLabelSettings": [
                  { "seriesName": "Phishing", "color": "orange" },
                  { "seriesName": "Malware", "color": "red" },
                  { "seriesName": "Spam", "color": "gray" }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - email threat map"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Threat Source Domains\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(ThreatTypes)\n| summarize \n    ThreatCount = count(),\n    Phishing = countif(ThreatTypes has \"Phish\"),\n    Malware = countif(ThreatTypes has \"Malware\"),\n    Spam = countif(ThreatTypes has \"Spam\"),\n    Blocked = countif(DeliveryAction in (\"Blocked\", \"Quarantined\")),\n    Delivered = countif(DeliveryAction == \"Delivered\")\n    by SenderFromDomain\n| extend RiskLevel = case(\n    Delivered > 0 and Malware > 0, \"üî¥ Critical - Malware Delivered\",\n    Delivered > 0 and Phishing > 0, \"üî¥ Critical - Phish Delivered\",\n    Malware > 0, \"üü† High - Malware Blocked\",\n    Phishing > 5, \"üü† High - Phishing\",\n    ThreatCount > 20, \"üü° Medium\",\n    \"üü¢ Low\")\n| order by Delivered desc, Malware desc, Phishing desc\n| take 30\n| project RiskLevel, SenderFromDomain, ThreatCount, Phishing, Malware, Spam, Blocked, Delivered",
              "size": 0,
              "title": "üåê Top Threat Source Domains",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Phishing", "formatter": 4, "formatOptions": { "palette": "orange" } },
                  { "columnMatch": "Malware", "formatter": 4, "formatOptions": { "palette": "red" } },
                  { "columnMatch": "Delivered", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - email threats by country table"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üîê Sign-in Location Analysis"
            },
            "name": "text - signin header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Sign-in Locations Map by Country\nSigninLogs\n| where TimeGenerated {TimeRange}\n| where isnotempty(Location)\n| extend Country = Location\n| extend TrustedLocation = iff(NetworkLocationDetails has \"trustedNamedLocation\", 1, 0)\n| extend RiskySignIn = iff(RiskLevelDuringSignIn in (\"medium\", \"high\"), 1, 0)\n| summarize \n    SignInCount = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    RiskySignIns = sum(RiskySignIn),\n    TrustedCount = sum(TrustedLocation),\n    FailedCount = countif(ResultType != \"0\")\n    by Country\n| extend RiskScore = RiskySignIns * 10 + FailedCount\n| order by SignInCount desc\n| take 50",
              "size": 0,
              "title": "üó∫Ô∏è Sign-in Locations Map by Country",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "map",
              "mapSettings": {
                "locInfo": "CountryRegion",
                "locInfoColumn": "Country",
                "sizeSettings": "SignInCount",
                "sizeAggregation": "Sum",
                "legendMetric": "SignInCount",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "RiskScore",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "name": "query - signin locations map"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Sign-in Locations by Country and City\nSigninLogs\n| where TimeGenerated {TimeRange}\n| where isnotempty(Location)\n| extend LocationDetails = parse_json(LocationDetails)\n| extend City = tostring(LocationDetails.city)\n| extend TrustedLocation = iff(NetworkLocationDetails has \"trustedNamedLocation\", 1, 0)\n| extend RiskySignIn = iff(RiskLevelDuringSignIn in (\"medium\", \"high\"), 1, 0)\n| summarize \n    SignInCount = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    RiskySignIns = sum(RiskySignIn),\n    TrustedCount = sum(TrustedLocation),\n    FailedCount = countif(ResultType != \"0\")\n    by Location, City\n| extend RiskScore = RiskySignIns * 10 + FailedCount\n| extend TrustStatus = case(\n    TrustedCount > 0 and RiskySignIns == 0, \"üü¢ Trusted\",\n    RiskySignIns > 0, \"üî¥ Risky\",\n    \"üü° Unknown\")\n| order by SignInCount desc\n| take 50\n| project TrustStatus, Location, City, SignInCount, UniqueUsers, RiskySignIns, TrustedCount, FailedCount",
              "size": 0,
              "title": "üèôÔ∏è Sign-in Locations by Country/City",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "SignInCount", "formatter": 4, "formatOptions": { "palette": "blue" } },
                  { "columnMatch": "RiskySignIns", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                  { "columnMatch": "FailedCount", "formatter": 4, "formatOptions": { "palette": "orange" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - signin city map"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Sign-in Location Details Table\nSigninLogs\n| where TimeGenerated {TimeRange}\n| where isnotempty(Location)\n| extend LocationDetails = parse_json(LocationDetails)\n| extend \n    City = tostring(LocationDetails.city),\n    Country = Location\n| extend TrustedLocation = iff(NetworkLocationDetails has \"trustedNamedLocation\", \"üü¢ Trusted\", \"üî¥ Untrusted\")\n| extend RiskLevel = case(\n    RiskLevelDuringSignIn == \"high\", \"üî¥ High\",\n    RiskLevelDuringSignIn == \"medium\", \"üü† Medium\",\n    \"üü¢ Low\")\n| summarize \n    SignInCount = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    RiskyCount = countif(RiskLevelDuringSignIn in (\"medium\", \"high\")),\n    TrustedCount = countif(NetworkLocationDetails has \"trustedNamedLocation\")\n    by Country, City\n| extend TrustStatus = case(\n    TrustedCount == SignInCount, \"üü¢ All Trusted\",\n    TrustedCount > 0, \"üü° Partial\",\n    \"üî¥ Untrusted\")\n| extend RiskStatus = case(\n    RiskyCount > 0, \"üî¥ Has Risky\",\n    FailedCount > SignInCount * 0.5, \"üü† High Failure\",\n    \"üü¢ Normal\")\n| order by RiskyCount desc, FailedCount desc\n| take 30\n| project TrustStatus, RiskStatus, Country, City, SignInCount, SuccessCount, FailedCount, RiskyCount, UniqueUsers",
              "size": 0,
              "title": "üìã Sign-in Locations with Trust Status",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "RiskyCount", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                  { "columnMatch": "SignInCount", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - location trust table"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Sign-ins from Untrusted Locations - Detailed Analysis\nSigninLogs\n| where TimeGenerated {TimeRange}\n| where not(NetworkLocationDetails has \"trustedNamedLocation\")\n| extend LocationDetails = parse_json(LocationDetails)\n| extend \n    City = tostring(LocationDetails.city),\n    Country = tostring(LocationDetails.countryOrRegion)\n| extend RiskLevel = case(\n    RiskLevelDuringSignIn == \"high\", \"üî¥ High\",\n    RiskLevelDuringSignIn == \"medium\", \"üü† Medium\",\n    ResultType != \"0\", \"üü° Failed\",\n    \"üü¢ Success\")\n| summarize \n    SignInCount = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    RiskyCount = countif(RiskLevelDuringSignIn in (\"medium\", \"high\")),\n    Users = make_set(UserPrincipalName, 5)\n    by Country, City, IPAddress\n| extend ThreatLevel = case(\n    RiskyCount > 0, \"üî¥ Critical - Risky Sign-ins\",\n    FailedCount > 10, \"üü† High - Many Failures\",\n    FailedCount > 0, \"üü° Medium\",\n    \"üü¢ Low\")\n| order by RiskyCount desc, FailedCount desc\n| take 50\n| project ThreatLevel, Country, City, IPAddress, SignInCount, SuccessCount, FailedCount, RiskyCount, UniqueUsers, Users",
              "size": 0,
              "title": "üö® Sign-ins from Untrusted Locations",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "RiskyCount", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                  { "columnMatch": "FailedCount", "formatter": 4, "formatOptions": { "palette": "orange" } }
                ]
              }
            },
            "name": "query - untrusted locations"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Trusted vs Untrusted Location Summary\nSigninLogs\n| where TimeGenerated {TimeRange}\n| extend IsTrusted = iff(NetworkLocationDetails has \"trustedNamedLocation\", \"üü¢ Trusted Location\", \"üî¥ Untrusted Location\")\n| summarize SignInCount = count(), UniqueUsers = dcount(UserPrincipalName), RiskySignIns = countif(RiskLevelDuringSignIn in (\"medium\", \"high\")) by IsTrusted\n| order by IsTrusted asc",
              "size": 2,
              "title": "üìä Trusted vs Untrusted Locations",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "query - trusted untrusted pie"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Countries by Risk\nSigninLogs\n| where TimeGenerated {TimeRange}\n| extend LocationDetails = parse_json(LocationDetails)\n| extend Country = tostring(LocationDetails.countryOrRegion)\n| where isnotempty(Country)\n| summarize \n    TotalSignIns = count(),\n    RiskySignIns = countif(RiskLevelDuringSignIn in (\"medium\", \"high\")),\n    FailedSignIns = countif(ResultType != \"0\"),\n    TrustedSignIns = countif(NetworkLocationDetails has \"trustedNamedLocation\")\n    by Country\n| extend RiskScore = (RiskySignIns * 10) + (FailedSignIns * 2) - (TrustedSignIns)\n| extend RiskLevel = case(\n    RiskScore > 100, \"üî¥ High Risk\",\n    RiskScore > 50, \"üü† Medium Risk\",\n    RiskScore > 0, \"üü° Low Risk\",\n    \"üü¢ Trusted\")\n| order by RiskScore desc\n| take 15\n| project RiskLevel, Country, TotalSignIns, RiskySignIns, FailedSignIns, TrustedSignIns, RiskScore",
              "size": 0,
              "title": "üåê Countries by Risk Score",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "RiskScore", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "customWidth": "67",
            "name": "query - country risk"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üìß Email Threat Geography\nEmail-based threat sources by sender IP address."
            },
            "name": "text - email threats header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Email Threat IPs Correlated with Sign-in Locations\nlet ThreatIPs = EmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(ThreatTypes)\n| where isnotempty(SenderIPv4)\n| distinct SenderIPv4;\nSigninLogs\n| where TimeGenerated {TimeRange}\n| where IPAddress in (ThreatIPs)\n| extend LocationDetails = parse_json(LocationDetails)\n| extend \n    Country = tostring(LocationDetails.countryOrRegion),\n    City = tostring(LocationDetails.city)\n| extend TrustedLocation = iff(NetworkLocationDetails has \"trustedNamedLocation\", \"üü¢ Trusted\", \"üî¥ Untrusted\")\n| summarize \n    SignInCount = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 5),\n    SuccessCount = countif(ResultType == \"0\")\n    by IPAddress, Country, City, TrustedLocation\n| extend RiskLevel = case(\n    TrustedLocation == \"üî¥ Untrusted\" and SuccessCount > 0, \"üî¥ Critical - Threat IP Successful Login\",\n    SuccessCount > 0, \"üü† Review - Successful from Threat IP\",\n    \"üü° Blocked\")\n| order by SuccessCount desc\n| project RiskLevel, IPAddress, Country, City, TrustedLocation, SignInCount, SuccessCount, UniqueUsers, Users",
              "size": 0,
              "title": "‚ö†Ô∏è Sign-ins from Email Threat Source IPs",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "SuccessCount", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "name": "query - threat ip signins"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Phishing by Sender IP\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has \"Phish\"\n| where isnotempty(SenderIPv4)\n| summarize \n    PhishingCount = count(),\n    UniqueRecipients = dcount(RecipientEmailAddress),\n    UniqueSenders = dcount(SenderFromAddress),\n    Domains = make_set(SenderFromDomain, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by SenderIPv4\n| extend RiskLevel = case(\n    PhishingCount > 100, \"üî¥ Critical\",\n    PhishingCount > 50, \"üü† High\",\n    PhishingCount > 10, \"üü° Medium\",\n    \"üü¢ Low\")\n| order by PhishingCount desc\n| take 50\n| project RiskLevel, SenderIPv4, PhishingCount, UniqueRecipients, UniqueSenders, Domains, FirstSeen, LastSeen",
              "size": 0,
              "title": "üé£ Phishing Sources by IP",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "PhishingCount", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - phishing sources"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Malware by Sender IP\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has \"Malware\"\n| where isnotempty(SenderIPv4)\n| summarize \n    MalwareCount = count(),\n    UniqueRecipients = dcount(RecipientEmailAddress),\n    UniqueSenders = dcount(SenderFromAddress),\n    Domains = make_set(SenderFromDomain, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by SenderIPv4\n| extend RiskLevel = case(\n    MalwareCount > 50, \"üî¥ Critical\",\n    MalwareCount > 20, \"üü† High\",\n    MalwareCount > 5, \"üü° Medium\",\n    \"üü¢ Low\")\n| order by MalwareCount desc\n| take 50\n| project RiskLevel, SenderIPv4, MalwareCount, UniqueRecipients, UniqueSenders, Domains, FirstSeen, LastSeen",
              "size": 0,
              "title": "ü¶† Malware Sources by IP",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "MalwareCount", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - malware geomap"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// All Threats by Sender Domain Origin\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(ThreatTypes)\n| where EmailDirection == \"Inbound\"\n| extend ThreatCategory = case(\n    ThreatTypes has \"Phish\", \"üé£ Phishing\",\n    ThreatTypes has \"Malware\", \"ü¶† Malware\",\n    ThreatTypes has \"Spam\", \"üìß Spam\",\n    \"‚ö†Ô∏è Other\")\n| extend ImpersonationIndicator = iff(EmailActionPolicy has_any (\"impersonation\", \"domain\"), \"üé≠ Domain Impersonation\", \"\")\n| extend ThreatLabel = iff(isnotempty(ImpersonationIndicator), ImpersonationIndicator, ThreatCategory)\n| summarize \n    ThreatCount = count(),\n    DeliveredCount = countif(DeliveryAction == \"Delivered\"),\n    Recipients = dcount(RecipientEmailAddress),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by SenderFromDomain, ThreatLabel\n| extend RiskLevel = case(\n    DeliveredCount > 20, \"üî¥ Critical\",\n    DeliveredCount > 10, \"üü† High\",\n    DeliveredCount > 0, \"üü° Medium\",\n    \"üü¢ Blocked\")\n| order by DeliveredCount desc, ThreatCount desc\n| take 50\n| project RiskLevel, SenderFromDomain, ThreatLabel, ThreatCount, DeliveredCount, Recipients, FirstSeen, LastSeen",
              "size": 0,
              "title": "üåê Threat Sources by Domain",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "DeliveredCount", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                  { "columnMatch": "ThreatCount", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "name": "query - threat domains table"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Domain Impersonation by IP\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailActionPolicy has_any (\"impersonation\", \"domain\")\n| where isnotempty(SenderIPv4)\n| summarize \n    ImpersonationCount = count(),\n    UniqueRecipients = dcount(RecipientEmailAddress),\n    Domains = make_set(SenderFromDomain, 10),\n    DeliveredCount = countif(DeliveryAction == \"Delivered\"),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by SenderIPv4\n| extend RiskLevel = case(\n    DeliveredCount > 10, \"üî¥ Critical\",\n    DeliveredCount > 5, \"üü† High\",\n    DeliveredCount > 0, \"üü° Medium\",\n    \"üü¢ Blocked\")\n| order by DeliveredCount desc, ImpersonationCount desc\n| take 50\n| project RiskLevel, SenderIPv4, ImpersonationCount, DeliveredCount, UniqueRecipients, Domains, FirstSeen, LastSeen",
              "size": 0,
              "title": "üé≠ Domain Impersonation by IP",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "DeliveredCount", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - impersonation geomap"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Spam Sources by IP\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has \"Spam\"\n| where isnotempty(SenderIPv4)\n| summarize \n    SpamCount = count(),\n    UniqueRecipients = dcount(RecipientEmailAddress),\n    Domains = make_set(SenderFromDomain, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by SenderIPv4\n| extend RiskLevel = case(\n    SpamCount > 500, \"üî¥ Critical\",\n    SpamCount > 100, \"üü† High\",\n    SpamCount > 20, \"üü° Medium\",\n    \"üü¢ Low\")\n| order by SpamCount desc\n| take 50\n| project RiskLevel, SenderIPv4, SpamCount, UniqueRecipients, Domains, FirstSeen, LastSeen",
              "size": 0,
              "title": "üìß Spam Sources by IP",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "SpamCount", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - spam geomap"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Threat Distribution Summary by Type and Category\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(ThreatTypes) or EmailActionPolicy has_any (\"impersonation\", \"domain\")\n| extend ThreatCategory = case(\n    EmailActionPolicy has_any (\"impersonation\", \"domain\"), \"üé≠ Domain Impersonation\",\n    ThreatTypes has \"Phish\", \"üé£ Phishing\",\n    ThreatTypes has \"Malware\", \"ü¶† Malware\",\n    ThreatTypes has \"Spam\", \"üìß Spam\",\n    \"‚ö†Ô∏è Other\")\n| summarize \n    TotalCount = count(),\n    DeliveredCount = countif(DeliveryAction == \"Delivered\"),\n    BlockedCount = countif(DeliveryAction == \"Blocked\"),\n    QuarantinedCount = countif(DeliveryAction == \"Quarantined\"),\n    UniqueIPs = dcount(SenderIPv4),\n    UniqueDomains = dcount(SenderFromDomain),\n    UniqueRecipients = dcount(RecipientEmailAddress)\n    by ThreatCategory\n| extend BlockRate = round(toreal(BlockedCount) / TotalCount * 100, 1)\n| order by TotalCount desc\n| project ThreatCategory, TotalCount, DeliveredCount, BlockedCount, QuarantinedCount, BlockRate, UniqueIPs, UniqueDomains, UniqueRecipients",
              "size": 0,
              "title": "üìä Threat Category Summary",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "DeliveredCount", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                  { "columnMatch": "BlockRate", "formatter": 4, "formatOptions": { "palette": "greenRed" } }
                ]
              }
            },
            "name": "query - threat summary"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "GeoMap"
      },
      "name": "group - geomap"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üìä Email Threat Campaigns\n\nDetect coordinated attack patterns by analyzing sender domains, threat types, and attack timing using EmailEvents data."
            },
            "name": "text - campaigns header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Detected Attack Patterns (Campaign-like behavior)\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has_any (\"Phish\", \"Malware\", \"Spam\") or DeliveryAction in (\"Blocked\", \"Quarantined\")\n| summarize \n    MessageCount = count(),\n    UniqueRecipients = dcount(RecipientEmailAddress),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated),\n    ThreatsSeen = make_set(ThreatTypes, 5),\n    SampleSubject = take_any(Subject)\n    by SenderFromDomain, ThreatTypes\n| where MessageCount >= 3 // At least 3 messages indicates coordinated attack\n| extend Duration = datetime_diff('hour', LastSeen, FirstSeen)\n| extend RiskLevel = case(\n    ThreatTypes has \"Phish\" and MessageCount > 50, \"üî¥ Critical\",\n    ThreatTypes has \"Malware\", \"üî¥ Critical\",\n    MessageCount > 100, \"üü† High\",\n    MessageCount > 20, \"üü° Medium\",\n    \"üü¢ Low\")\n| extend CampaignType = case(\n    ThreatTypes has \"Malware\", \"Malware Distribution\",\n    ThreatTypes has \"Phish\", \"Phishing Campaign\",\n    ThreatTypes has \"Spam\", \"Spam Wave\",\n    \"Blocked Content\")\n| order by MessageCount desc\n| project RiskLevel, SenderFromDomain, CampaignType, MessageCount, UniqueRecipients, Duration, SampleSubject, FirstSeen, LastSeen",
              "size": 0,
              "title": "üìä Detected Attack Campaigns (Pattern-Based)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "MessageCount", "formatter": 4, "formatOptions": { "palette": "blue" } },
                  { "columnMatch": "RiskLevel", "formatter": 0 }
                ]
              }
            },
            "name": "query - campaigns"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Threat Types Distribution\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(ThreatTypes)\n| extend ThreatCategory = case(\n    ThreatTypes has \"Malware\", \"Malware\",\n    ThreatTypes has \"Phish\", \"Phishing\",\n    ThreatTypes has \"Spam\", \"Spam\",\n    ThreatTypes has \"BEC\", \"BEC\",\n    \"Other\")\n| summarize Count = count() by ThreatCategory\n| order by Count desc",
              "size": 2,
              "title": "üìà Threat Types Distribution",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "query - campaign types"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Prolific Threat Senders\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has_any (\"Phish\", \"Malware\") or DeliveryAction in (\"Blocked\", \"Quarantined\")\n| summarize MessageCount = count(), TargetedUsers = dcount(RecipientEmailAddress) by SenderFromDomain\n| where MessageCount >= 5\n| top 10 by MessageCount desc\n| project SenderFromDomain, MessageCount, TargetedUsers",
              "size": 0,
              "title": "üéØ Top Threat Sender Domains",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "MessageCount", "formatter": 4, "formatOptions": { "palette": "redGreen" } }
                ]
              }
            },
            "customWidth": "33",
            "name": "query - top threat senders"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Common Attack Lures (Subject Lines)\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has_any (\"Phish\", \"Malware\")\n| summarize Count = count() by Subject\n| top 10 by Count desc\n| project Subject, Count",
              "size": 0,
              "title": "üìß Common Attack Lures (Subject Lines)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "customWidth": "34",
            "name": "query - attack lures"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Threat Activity Timeline\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has_any (\"Phish\", \"Malware\", \"Spam\") or DeliveryAction in (\"Blocked\", \"Quarantined\")\n| extend ThreatCategory = case(\n    ThreatTypes has \"Malware\", \"Malware\",\n    ThreatTypes has \"Phish\", \"Phishing\",\n    ThreatTypes has \"Spam\", \"Spam\",\n    \"Blocked\")\n| summarize Count = count() by ThreatCategory, bin(TimeGenerated, 1h)\n| order by TimeGenerated asc",
              "size": 0,
              "title": "üìà Threat Activity Timeline",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "timechart"
            },
            "name": "query - campaign timeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Email Cluster Analysis (Grouped by similarities)\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(EmailClusterId) and EmailClusterId > 0\n| summarize \n    MessageCount = count(),\n    UniqueRecipients = dcount(RecipientEmailAddress),\n    UniqueSenders = dcount(SenderFromAddress),\n    ThreatsSeen = make_set(ThreatTypes, 3),\n    SampleSubject = take_any(Subject)\n    by EmailClusterId\n| where MessageCount >= 5\n| order by MessageCount desc\n| top 20 by MessageCount\n| project EmailClusterId, MessageCount, UniqueRecipients, UniqueSenders, strcat_array(ThreatsSeen, \", \"), SampleSubject",
              "size": 0,
              "title": "üîó Email Clusters (Content-Based Grouping)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "MessageCount", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "name": "query - email clusters"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Campaigns"
      },
      "name": "group - campaigns"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üîó URL Analysis & Safe Links\n\nAnalyze URLs in emails and user click events to detect malicious links and phishing attempts."
            },
            "name": "text - urls header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// URL Click Overview\nUrlClickEvents\n| where TimeGenerated {TimeRange}\n| summarize \n    TotalClicks = count(),\n    AllowedClicks = countif(ActionType == \"ClickAllowed\"),\n    BlockedClicks = countif(ActionType has \"Blocked\"),\n    ClickedThrough = countif(IsClickedThrough == true),\n    UniqueUsers = dcount(AccountUpn),\n    ThreatClicks = countif(isnotempty(ThreatTypes))\n| project \n    Metric = pack_array(\"Total Clicks\", \"Allowed\", \"Blocked\", \"Clicked Through\", \"Unique Users\", \"Threat Clicks\"),\n    Value = pack_array(TotalClicks, AllowedClicks, BlockedClicks, ClickedThrough, UniqueUsers, ThreatClicks)\n| mv-expand Metric to typeof(string), Value to typeof(long)",
              "size": 4,
              "title": "üìä URL Click Metrics",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "auto" } }
              }
            },
            "name": "query - url metrics"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Malicious URL Clicks - Users at Risk\nUrlClickEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(ThreatTypes)\n| where IsClickedThrough == true\n| summarize \n    ClickCount = count(),\n    URLs = make_set(Url, 5),\n    Workloads = make_set(Workload, 3),\n    IPs = make_set(IPAddress, 5),\n    FirstClick = min(TimeGenerated),\n    LastClick = max(TimeGenerated)\n    by AccountUpn, ThreatTypes\n| extend RiskLevel = case(\n    ClickCount > 10, \"üî¥ Critical - Multiple Threat Clicks\",\n    ClickCount > 5, \"üü† High\",\n    \"üü° Medium\")\n| order by ClickCount desc\n| project RiskLevel, AccountUpn, ThreatTypes, ClickCount, URLs, Workloads, IPs, FirstClick, LastClick",
              "size": 0,
              "title": "‚ö†Ô∏è Users Who Clicked Malicious URLs",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "ClickCount", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "name": "query - malicious clicks"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Malicious Domains in Emails\nEmailUrlInfo\n| where TimeGenerated {TimeRange}\n| join kind=inner (\n    EmailEvents\n    | where TimeGenerated {TimeRange}\n    | where isnotempty(ThreatTypes)\n    | project NetworkMessageId, ThreatTypes, DeliveryAction\n) on NetworkMessageId\n| summarize \n    Count = count(),\n    DeliveredCount = countif(DeliveryAction == \"Delivered\"),\n    ThreatList = make_set(ThreatTypes, 5)\n    by UrlDomain\n| where Count > 5\n| extend RiskLevel = case(\n    DeliveredCount > 10, \"üî¥ Critical\",\n    DeliveredCount > 5, \"üü† High\",\n    DeliveredCount > 0, \"üü° Medium\",\n    \"üü¢ Blocked\")\n| order by DeliveredCount desc, Count desc\n| take 25\n| project RiskLevel, UrlDomain, Count, DeliveredCount, ThreatList",
              "size": 0,
              "title": "üåê Top Malicious URL Domains",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "query - malicious domains"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// URL Click Timeline by Threat Type\nUrlClickEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(ThreatTypes)\n| summarize Count = count() by ThreatTypes, bin(TimeGenerated, 1h)\n| order by TimeGenerated asc",
              "size": 0,
              "title": "üìà Threat Click Timeline",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "query - click timeline"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "URLs"
      },
      "name": "group - urls"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üõ°Ô∏è Zero-Hour Auto Purge (ZAP) & Post-Delivery Remediation\n\nTrack post-delivery actions including ZAP, admin actions, and automatic remediation."
            },
            "name": "text - zap header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// ZAP and Post-Delivery Actions Overview\nEmailPostDeliveryEvents\n| where TimeGenerated {TimeRange}\n| summarize \n    TotalActions = count(),\n    ZAPActions = countif(ActionTrigger == \"ZAP\"),\n    AdminActions = countif(ActionTrigger has_any (\"Admin\", \"Manual\")),\n    SuccessActions = countif(ActionResult == \"Success\"),\n    FailedActions = countif(ActionResult != \"Success\")\n| project \n    Metric = pack_array(\"Total Actions\", \"ZAP Actions\", \"Admin Actions\", \"Successful\", \"Failed\"),\n    Value = pack_array(TotalActions, ZAPActions, AdminActions, SuccessActions, FailedActions)\n| mv-expand Metric to typeof(string), Value to typeof(long)",
              "size": 4,
              "title": "üìä Post-Delivery Metrics",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "auto" } }
              }
            },
            "name": "query - zap metrics"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Post-Delivery Events Detail\nEmailPostDeliveryEvents\n| where TimeGenerated {TimeRange}\n| summarize \n    Count = count(),\n    SuccessCount = countif(ActionResult == \"Success\"),\n    Recipients = dcount(RecipientEmailAddress)\n    by Action, ActionTrigger, ActionType, ThreatTypes\n| extend SuccessRate = round(toreal(SuccessCount) / Count * 100, 1)\n| order by Count desc\n| project Action, ActionTrigger, ActionType, ThreatTypes, Count, SuccessCount, SuccessRate, Recipients",
              "size": 0,
              "title": "üìã Post-Delivery Actions by Type",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "SuccessRate", "formatter": 4, "formatOptions": { "palette": "greenRed" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - zap actions"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Post-Delivery Events Timeline (includes ZAP, Admin, User actions)\nEmailPostDeliveryEvents\n| where TimeGenerated {TimeRange}\n| summarize Count = count() by ActionTrigger, bin(TimeGenerated, 1h)\n| order by TimeGenerated asc",
              "size": 0,
              "title": "üìà Post-Delivery Actions Timeline",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "query - zap timeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Users Protected by Post-Delivery Actions\nEmailPostDeliveryEvents\n| where TimeGenerated {TimeRange}\n| summarize \n    ActionCount = count(),\n    ZAPCount = countif(ActionTrigger == \"ZAP\"),\n    AdminCount = countif(ActionTrigger has \"Admin\"),\n    PhishRemoved = countif(ThreatTypes has \"Phish\"),\n    MalwareRemoved = countif(ThreatTypes has \"Malware\"),\n    LastAction = max(TimeGenerated)\n    by RecipientEmailAddress\n| order by ActionCount desc\n| take 20\n| project RecipientEmailAddress, ActionCount, ZAPCount, AdminCount, PhishRemoved, MalwareRemoved, LastAction",
              "size": 0,
              "title": "üë§ Users Protected by Post-Delivery Actions",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "name": "query - zap users"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üí¨ Microsoft Teams, SharePoint & OneDrive Security\n\n**Microsoft Defender for Office 365** extends protection beyond email to collaboration platforms. This section monitors **Safe Links**, **Safe Attachments**, **malware detection**, and **suspicious activity** across Teams, SharePoint, and OneDrive.\n\n| Platform | Protection | Key Risks |\n|----------|------------|----------|\n| **Teams** | Safe Links, Safe Attachments, ZAP | Malicious URLs in chat, file sharing threats |\n| **SharePoint** | Safe Attachments, Malware scanning | External sharing, anonymous links, data exfiltration |\n| **OneDrive** | Safe Attachments, Ransomware detection | Mass downloads, sync anomalies, compromised accounts |"
            },
            "name": "text - teams security header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Collaboration Platform Protection Summary\nlet TeamsClicks = toscalar(UrlClickEvents | where TimeGenerated {TimeRange} | where Workload == \"Teams\" | count);\nlet TeamsBlocked = toscalar(UrlClickEvents | where TimeGenerated {TimeRange} | where Workload == \"Teams\" | where IsClickedThrough == false | count);\nlet SPMalware = toscalar(OfficeActivity | where TimeGenerated {TimeRange} | where OfficeWorkload == \"SharePoint\" | where Operation has_any (\"FileMalwareDetected\", \"Malware\") | count);\nlet ODMalware = toscalar(OfficeActivity | where TimeGenerated {TimeRange} | where OfficeWorkload == \"OneDrive\" | where Operation has_any (\"FileMalwareDetected\", \"Malware\") | count);\nlet TeamsMalware = toscalar(OfficeActivity | where TimeGenerated {TimeRange} | where OfficeWorkload == \"MicrosoftTeams\" | where Operation has_any (\"FileMalwareDetected\", \"Malware\") | count);\nlet TotalMalware = SPMalware + ODMalware + TeamsMalware;\nprint Metric = dynamic([\"üí¨ Teams URL Clicks\", \"üõ°Ô∏è Teams Blocked\", \"ü¶† SharePoint Malware\", \"ü¶† OneDrive Malware\", \"ü¶† Teams Malware\", \"üõ°Ô∏è Total Malware Blocked\"]),\n      Value = pack_array(TeamsClicks, TeamsBlocked, SPMalware, ODMalware, TeamsMalware, TotalMalware)\n| mv-expand Metric to typeof(string), Value to typeof(long)",
              "size": 4,
              "title": "üõ°Ô∏è Collaboration Platform Protection Overview",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "auto" } }
              }
            },
            "name": "query - collab overview"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Collaboration Activity by Platform\nOfficeActivity\n| where TimeGenerated {TimeRange}\n| where OfficeWorkload in (\"SharePoint\", \"OneDrive\", \"MicrosoftTeams\")\n| extend Platform = case(\n    OfficeWorkload == \"MicrosoftTeams\", \"üí¨ Teams\",\n    OfficeWorkload == \"SharePoint\", \"üìÇ SharePoint\",\n    OfficeWorkload == \"OneDrive\", \"‚òÅÔ∏è OneDrive\",\n    \"Other\")\n| summarize \n    TotalEvents = count(),\n    UniqueUsers = dcount(UserId),\n    FileUploads = countif(Operation has \"Upload\"),\n    FileDownloads = countif(Operation has \"Download\"),\n    FileShares = countif(Operation has_any (\"Shared\", \"Sharing\", \"Share\")),\n    MalwareEvents = countif(Operation has \"Malware\"),\n    DeleteEvents = countif(Operation has \"Delete\")\n    by Platform\n| extend RiskIndicator = case(\n    MalwareEvents > 0, \"üî¥ Malware Detected\",\n    FileShares > 1000, \"üü† High Sharing Volume\",\n    \"üü¢ Normal\")\n| order by TotalEvents desc\n| project Platform, RiskIndicator, TotalEvents, UniqueUsers, FileUploads, FileDownloads, FileShares, MalwareEvents, DeleteEvents",
              "size": 0,
              "title": "üìä Activity Summary by Platform",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "MalwareEvents", "formatter": 4, "formatOptions": { "palette": "red" } },
                  { "columnMatch": "TotalEvents", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - collab by platform"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// High-Risk Operations Detected\nOfficeActivity\n| where TimeGenerated {TimeRange}\n| where OfficeWorkload in (\"SharePoint\", \"OneDrive\", \"MicrosoftTeams\")\n| where Operation has_any (\n    \"FileMalwareDetected\", \"AnonymousLinkCreated\", \"AnonymousLinkUsed\",\n    \"SharingInvitationCreated\", \"AddedToSecureLink\", \"SecureLinkCreated\",\n    \"PermissionLevelModified\", \"SharingSet\", \"SiteSharingModified\",\n    \"FileDeleted\", \"FileDeletedFirstStageRecycleBin\", \"FolderDeleted\",\n    \"DLPRuleMatch\", \"SensitivityLabelApplied\", \"MalwareDetected\"\n)\n| extend RiskLevel = case(\n    Operation has \"Malware\", \"üî¥ Critical - Malware\",\n    Operation has \"DLPRuleMatch\", \"üî¥ Critical - DLP Violation\",\n    Operation has \"Anonymous\", \"üü† High - Anonymous Sharing\",\n    Operation has_any (\"Deleted\", \"Delete\"), \"üü° Medium - Deletion\",\n    Operation has_any (\"Sharing\", \"Secure\"), \"üü° Medium - External Sharing\",\n    \"üü¢ Low\")\n| extend Platform = case(\n    OfficeWorkload == \"MicrosoftTeams\", \"Teams\",\n    OfficeWorkload == \"SharePoint\", \"SharePoint\",\n    OfficeWorkload == \"OneDrive\", \"OneDrive\",\n    \"Other\")\n| summarize Count = count() by RiskLevel, Platform, Operation\n| order by RiskLevel asc, Count desc\n| take 30",
              "size": 0,
              "title": "‚ö†Ô∏è High-Risk Operations Detected",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - high risk ops"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n#### üí¨ Microsoft Teams Security"
            },
            "name": "text - teams subheader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Teams Safe Links - URL Clicks Overview\nUrlClickEvents\n| where TimeGenerated {TimeRange}\n| where Workload == \"Teams\"\n| summarize \n    TotalClicks = count(),\n    BlockedClicks = countif(ActionType has \"Blocked\"),\n    AllowedClicks = countif(ActionType == \"ClickAllowed\"),\n    ClickedThrough = countif(IsClickedThrough == true),\n    ThreatClicks = countif(isnotempty(ThreatTypes)),\n    UniqueUsers = dcount(AccountUpn)\n| project \n    Metric = pack_array(\"Total Teams Clicks\", \"Blocked\", \"Allowed\", \"Clicked Through\", \"Threat URLs\", \"Unique Users\"),\n    Value = pack_array(TotalClicks, BlockedClicks, AllowedClicks, ClickedThrough, ThreatClicks, UniqueUsers)\n| mv-expand Metric to typeof(string), Value to typeof(long)",
              "size": 4,
              "title": "üîó Teams Safe Links Overview",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "auto" } }
              }
            },
            "name": "query - teams safelinks overview"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Teams URL Click Events - Detailed\nUrlClickEvents\n| where TimeGenerated {TimeRange}\n| where Workload == \"Teams\"\n| extend ClickStatus = case(\n    ActionType has \"Blocked\", \"üî¥ Blocked\",\n    IsClickedThrough == true, \"‚ö†Ô∏è Clicked Through\",\n    ActionType == \"ClickAllowed\", \"üü¢ Allowed\",\n    \"üîµ Other\")\n| extend ThreatStatus = iff(isnotempty(ThreatTypes), strcat(\"‚ö†Ô∏è \", ThreatTypes), \"‚úÖ Clean\")\n| project TimeGenerated, AccountUpn, Url, ClickStatus, ThreatStatus, DetectionMethods, IPAddress\n| order by TimeGenerated desc\n| take 50",
              "size": 0,
              "title": "üîó Teams URL Click Events",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Url", "formatter": 7, "formatOptions": { "linkTarget": "Url" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - teams url clicks"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Teams Threat URL Clicks - Users at Risk\nUrlClickEvents\n| where TimeGenerated {TimeRange}\n| where Workload == \"Teams\"\n| where isnotempty(ThreatTypes) or ActionType has \"Blocked\"\n| summarize \n    ThreatClicks = count(),\n    BlockedClicks = countif(ActionType has \"Blocked\"),\n    ClickedThroughCount = countif(IsClickedThrough == true),\n    ThreatTypes = make_set(ThreatTypes, 5),\n    MaliciousUrls = make_set(Url, 5)\n    by AccountUpn\n| extend RiskLevel = case(\n    ClickedThroughCount > 0 and ThreatClicks > 3, \"üî¥ Critical\",\n    ClickedThroughCount > 0, \"üü† High\",\n    ThreatClicks > 5, \"üü° Medium\",\n    \"üü¢ Low\")\n| order by ClickedThroughCount desc, ThreatClicks desc\n| project RiskLevel, AccountUpn, ThreatClicks, BlockedClicks, ClickedThroughCount, ThreatTypes",
              "size": 0,
              "title": "üë§ Teams Users Exposed to Threat URLs",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "ThreatClicks", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                  { "columnMatch": "ClickedThroughCount", "formatter": 4, "formatOptions": { "palette": "orange" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - teams users at risk"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Teams & Collaboration Security Alerts\nAlertInfo\n| where TimeGenerated {TimeRange}\n| where ServiceSource has_any (\"Office 365\", \"MDO\", \"Microsoft 365 Defender\", \"MCAS\", \"Microsoft Defender for Cloud Apps\")\n| where Title has_any (\"Teams\", \"ZAP\", \"zero-hour\", \"auto purge\", \"malicious\", \"chat\", \"collaboration\", \"SharePoint\", \"OneDrive\", \"file\", \"sharing\")\n    or Category has_any (\"Malware\", \"Phishing\", \"InitialAccess\")\n| join kind=leftouter (\n    AlertEvidence\n    | where TimeGenerated {TimeRange}\n    | summarize \n        AffectedUsers = make_set(AccountUpn, 10),\n        URLs = make_set(RemoteUrl, 5)\n        by AlertId\n) on AlertId\n| extend SeverityIcon = case(\n    Severity == \"High\", \"üî¥\",\n    Severity == \"Medium\", \"üü†\",\n    Severity == \"Low\", \"üü°\",\n    \"‚ö™\")\n| project TimeGenerated, strcat(SeverityIcon, \" \", Severity), Title, Category, AffectedUsers, URLs, ServiceSource, AlertId\n| order by TimeGenerated desc\n| take 50",
              "size": 0,
              "title": "üõ°Ô∏è Collaboration Security Alerts (Teams, SharePoint, OneDrive)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "name": "query - teams zap alerts"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Teams Activity - File Operations\nOfficeActivity\n| where TimeGenerated {TimeRange}\n| where OfficeWorkload == \"MicrosoftTeams\"\n| summarize \n    FileUploads = countif(Operation has \"Upload\"),\n    FileDownloads = countif(Operation has \"Download\"),\n    MalwareDetected = countif(Operation has \"Malware\"),\n    FileShares = countif(Operation has \"Shared\" or Operation has \"Share\"),\n    MessagesSent = countif(Operation has \"Message\"),\n    TotalActions = count()\n    by UserId\n| where TotalActions > 5\n| extend RiskFlag = case(\n    MalwareDetected > 0, \"üî¥ Malware Detected\",\n    FileShares > 20, \"üü° High Sharing\",\n    \"üü¢ Normal\")\n| order by MalwareDetected desc, TotalActions desc\n| take 25\n| project RiskFlag, UserId, TotalActions, FileUploads, FileDownloads, FileShares, MessagesSent, MalwareDetected",
              "size": 0,
              "title": "üìÅ Teams User Activity Overview",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "MalwareDetected", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - teams file activity"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Teams URL Click Timeline\nUrlClickEvents\n| where TimeGenerated {TimeRange}\n| where Workload == \"Teams\"\n| extend ClickType = case(\n    ActionType has \"Blocked\", \"Blocked\",\n    isnotempty(ThreatTypes), \"Threat Detected\",\n    IsClickedThrough == true, \"Clicked Through\",\n    \"Allowed\")\n| summarize Count = count() by ClickType, bin(TimeGenerated, 1h)\n| order by TimeGenerated asc",
              "size": 0,
              "title": "üìà Teams URL Click Activity Timeline",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "areachart",
              "chartSettings": {
                "seriesLabelSettings": [
                  { "seriesName": "Blocked", "color": "redBright" },
                  { "seriesName": "Threat Detected", "color": "orange" },
                  { "seriesName": "Clicked Through", "color": "yellow" },
                  { "seriesName": "Allowed", "color": "green" }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - teams url timeline"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üìÇ SharePoint Security & Safe Links\n\nMonitor file activity, malware detection, and Safe Links protection for SharePoint Online."
            },
            "name": "text - sharepoint header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// SharePoint Activity Overview\nOfficeActivity\n| where TimeGenerated {TimeRange}\n| where OfficeWorkload == \"SharePoint\"\n| summarize \n    FileAccessed = countif(Operation has \"Accessed\"),\n    FileUploads = countif(Operation has \"Upload\"),\n    FileDownloads = countif(Operation has \"Download\"),\n    FileDeleted = countif(Operation has \"Delete\"),\n    FileShares = countif(Operation has \"Shared\" or Operation has \"Sharing\"),\n    MalwareDetected = countif(Operation has \"Malware\"),\n    AnonymousLinks = countif(Operation has \"AnonymousLink\"),\n    TotalActions = count()\n    by UserId\n| where TotalActions > 10\n| extend RiskFlag = case(\n    MalwareDetected > 0, \"üî¥ Malware\",\n    AnonymousLinks > 5, \"üü† Anonymous Sharing\",\n    FileShares > 50, \"üü° High Sharing\",\n    \"üü¢ Normal\")\n| order by MalwareDetected desc, AnonymousLinks desc, TotalActions desc\n| take 25\n| project RiskFlag, UserId, TotalActions, FileUploads, FileDownloads, FileShares, AnonymousLinks, MalwareDetected",
              "size": 0,
              "title": "üìÇ SharePoint User Activity",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "MalwareDetected", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                  { "columnMatch": "AnonymousLinks", "formatter": 4, "formatOptions": { "palette": "orange" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - sharepoint activity"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// SharePoint External Sharing\nOfficeActivity\n| where TimeGenerated {TimeRange}\n| where OfficeWorkload == \"SharePoint\"\n| where Operation has_any (\"SharingSet\", \"AnonymousLinkCreated\", \"SecureLinkCreated\", \"AddedToSecureLink\", \"SharingInvitationCreated\")\n| extend ShareType = case(\n    Operation has \"Anonymous\", \"üî¥ Anonymous Link\",\n    Operation has \"External\" or ExternalAccess == \"true\", \"üü† External Share\",\n    \"üü¢ Internal Share\")\n| summarize Count = count() by ShareType, bin(TimeGenerated, 1d)\n| order by TimeGenerated asc",
              "size": 0,
              "title": "üìä SharePoint Sharing Activity Timeline",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "areachart",
              "chartSettings": {
                "seriesLabelSettings": [
                  { "seriesName": "üî¥ Anonymous Link", "color": "redBright" },
                  { "seriesName": "üü† External Share", "color": "orange" },
                  { "seriesName": "üü¢ Internal Share", "color": "green" }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - sharepoint sharing timeline"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### ‚òÅÔ∏è OneDrive Security & Safe Links\n\nMonitor OneDrive for Business activity, sync operations, and potential data exfiltration."
            },
            "name": "text - onedrive header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// OneDrive Activity Overview\nOfficeActivity\n| where TimeGenerated {TimeRange}\n| where OfficeWorkload == \"OneDrive\"\n| summarize \n    FileUploads = countif(Operation has \"Upload\"),\n    FileDownloads = countif(Operation has \"Download\"),\n    FileSyncs = countif(Operation has \"Sync\"),\n    FileShares = countif(Operation has \"Shared\" or Operation has \"Sharing\"),\n    FileDeleted = countif(Operation has \"Delete\"),\n    MalwareDetected = countif(Operation has \"Malware\"),\n    TotalActions = count()\n    by UserId\n| where TotalActions > 10\n| extend RiskFlag = case(\n    MalwareDetected > 0, \"üî¥ Malware\",\n    FileDownloads > 100, \"üü† Mass Download\",\n    FileShares > 30, \"üü° High Sharing\",\n    \"üü¢ Normal\")\n| order by MalwareDetected desc, FileDownloads desc, TotalActions desc\n| take 25\n| project RiskFlag, UserId, TotalActions, FileUploads, FileDownloads, FileSyncs, FileShares, MalwareDetected",
              "size": 0,
              "title": "‚òÅÔ∏è OneDrive User Activity",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "MalwareDetected", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                  { "columnMatch": "FileDownloads", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - onedrive activity"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// OneDrive Sync and Download Anomalies\nOfficeActivity\n| where TimeGenerated {TimeRange}\n| where OfficeWorkload == \"OneDrive\"\n| where Operation has_any (\"FileDownloaded\", \"FileSyncDownloadedFull\", \"FileAccessed\")\n| summarize \n    DownloadCount = count(),\n    UniqueFiles = dcount(SourceFileName),\n    DataVolume = count() // Approximation\n    by UserId, bin(TimeGenerated, 1h)\n| where DownloadCount > 20\n| extend AnomalyFlag = case(\n    DownloadCount > 100, \"üî¥ Potential Exfiltration\",\n    DownloadCount > 50, \"üü† High Volume\",\n    \"üü° Elevated\")\n| order by DownloadCount desc\n| project TimeGenerated, AnomalyFlag, UserId, DownloadCount, UniqueFiles",
              "size": 0,
              "title": "‚ö†Ô∏è OneDrive Download Anomalies",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "DownloadCount", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - onedrive anomalies"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n#### üîó External & Guest User Activity\n\nMonitor external users, guest access, and anonymous sharing across collaboration platforms. External sharing is a common data exfiltration vector."
            },
            "name": "text - external sharing header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// External/Guest User Access Activity\nOfficeActivity\n| where TimeGenerated {TimeRange}\n| where OfficeWorkload in (\"SharePoint\", \"OneDrive\", \"MicrosoftTeams\")\n| where UserId contains \"#ext#\" or UserId contains \"urn:\" or ExternalAccess == true\n| extend Platform = case(\n    OfficeWorkload == \"MicrosoftTeams\", \"üí¨ Teams\",\n    OfficeWorkload == \"SharePoint\", \"üìÇ SharePoint\",\n    OfficeWorkload == \"OneDrive\", \"‚òÅÔ∏è OneDrive\",\n    \"Other\")\n| summarize \n    EventCount = count(),\n    UniqueOperations = dcount(Operation),\n    FileAccess = countif(Operation has_any (\"FileAccessed\", \"FileDownloaded\", \"FileViewed\", \"FilePreview\")),\n    FileModify = countif(Operation has_any (\"FileModified\", \"FileUploaded\", \"FileRenamed\")),\n    FileCopy = countif(Operation has \"FileCopied\"),\n    Platforms = make_set(Platform)\n    by UserId\n| extend RiskScore = FileAccess + (FileModify * 2) + (FileCopy * 5)\n| extend RiskLevel = case(\n    RiskScore > 50, \"üî¥ High Risk\",\n    RiskScore > 20, \"üü† Medium Risk\",\n    \"üü¢ Low Risk\")\n| order by RiskScore desc\n| project RiskLevel, UserId, EventCount, FileAccess, FileModify, FileCopy, RiskScore, Platforms\n| take 20",
              "size": 0,
              "title": "üë• External/Guest User Activity",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "RiskScore", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - external user activity"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Anonymous Link Activity\nOfficeActivity\n| where TimeGenerated {TimeRange}\n| where OfficeWorkload in (\"SharePoint\", \"OneDrive\")\n| where Operation has_any (\"AnonymousLinkCreated\", \"AnonymousLinkUpdated\", \"AnonymousLinkUsed\", \"AnonymousLinkRemoved\", \"SecureLinkCreated\", \"AddedToSecureLink\")\n| extend OperationType = case(\n    Operation has \"Created\", \"üîó Link Created\",\n    Operation has \"Used\", \"üì• Link Used\",\n    Operation has \"Updated\", \"‚úèÔ∏è Link Modified\",\n    Operation has \"Removed\", \"‚ùå Link Removed\",\n    \"Other\")\n| extend Platform = iff(OfficeWorkload == \"SharePoint\", \"üìÇ SharePoint\", \"‚òÅÔ∏è OneDrive\")\n| summarize Count = count() by OperationType, Platform, bin(TimeGenerated, 1d)\n| order by TimeGenerated asc",
              "size": 0,
              "title": "üîó Anonymous/Secure Link Activity Timeline",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "linechart",
              "chartSettings": {
                "xAxis": "TimeGenerated",
                "yAxis": ["Count"],
                "group": "OperationType"
              }
            },
            "customWidth": "50",
            "name": "query - anon link timeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Users Creating External Shares\nOfficeActivity\n| where TimeGenerated {TimeRange}\n| where OfficeWorkload in (\"SharePoint\", \"OneDrive\")\n| where Operation has_any (\"AnonymousLinkCreated\", \"SecureLinkCreated\", \"SharingInvitationCreated\", \"AddedToSecureLink\", \"SharingSet\")\n| summarize \n    TotalShares = count(),\n    AnonymousLinks = countif(Operation has \"Anonymous\"),\n    SecureLinks = countif(Operation has \"Secure\"),\n    SharingInvites = countif(Operation has \"Invitation\"),\n    UniqueFiles = dcount(SourceFileName),\n    FirstShare = min(TimeGenerated),\n    LastShare = max(TimeGenerated)\n    by UserId\n| extend ShareRate = round(toreal(TotalShares) / datetime_diff('hour', LastShare, FirstShare), 2)\n| extend RiskFlag = case(\n    AnonymousLinks > 10, \"üî¥ High Anonymous Sharing\",\n    TotalShares > 50, \"üü† Heavy Sharer\",\n    \"üü¢ Normal\")\n| order by AnonymousLinks desc, TotalShares desc\n| project RiskFlag, UserId, TotalShares, AnonymousLinks, SecureLinks, SharingInvites, UniqueFiles\n| take 20",
              "size": 0,
              "title": "üîù Top Users Creating External Shares",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "AnonymousLinks", "formatter": 4, "formatOptions": { "palette": "red" } },
                  { "columnMatch": "TotalShares", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - top external sharers"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n#### üìÅ Sensitive File Operations\n\nMonitor high-risk file operations including access to sensitive files, DLP violations, and potentially risky file extensions."
            },
            "name": "text - sensitive files header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// File Extensions Analysis - Potentially Risky Files\nlet RiskyExtensions = dynamic([\".exe\", \".bat\", \".cmd\", \".ps1\", \".vbs\", \".js\", \".hta\", \".scr\", \".msi\", \".dll\", \".pif\", \".lnk\", \".iso\", \".img\", \".vhd\", \".rar\", \".7z\", \".zip\"]);\nOfficeActivity\n| where TimeGenerated {TimeRange}\n| where OfficeWorkload in (\"SharePoint\", \"OneDrive\", \"MicrosoftTeams\")\n| where Operation has_any (\"FileUploaded\", \"FileCreated\", \"FileSyncUploadedFull\")\n| where isnotempty(SourceFileName)\n| extend FileExtension = tolower(extract(@\"\\.[a-zA-Z0-9]+$\", 0, SourceFileName))\n| where isnotempty(FileExtension)\n| extend IsRisky = FileExtension in (RiskyExtensions)\n| summarize \n    TotalFiles = count(),\n    RiskyFiles = countif(IsRisky),\n    UniqueUsers = dcount(UserId),\n    Examples = take_any(SourceFileName, 3)\n    by FileExtension\n| extend RiskIndicator = iff(FileExtension in (RiskyExtensions), \"üî¥ High Risk Extension\", \"üü¢ Standard\")\n| order by RiskyFiles desc, TotalFiles desc\n| project RiskIndicator, FileExtension, TotalFiles, RiskyFiles, UniqueUsers, Examples\n| take 25",
              "size": 0,
              "title": "üìä File Types Uploaded (Risk Assessment)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "RiskyFiles", "formatter": 4, "formatOptions": { "palette": "red" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - risky file types"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Mass File Operations (Potential Ransomware/Exfiltration)\nOfficeActivity\n| where TimeGenerated {TimeRange}\n| where OfficeWorkload in (\"SharePoint\", \"OneDrive\")\n| where Operation has_any (\"FileDeleted\", \"FileRenamed\", \"FileModified\", \"FileModifiedExtended\", \"FileDownloaded\")\n| summarize \n    OperationCount = count(),\n    DeleteCount = countif(Operation has \"Deleted\"),\n    RenameCount = countif(Operation has \"Renamed\"),\n    ModifyCount = countif(Operation has \"Modified\"),\n    DownloadCount = countif(Operation has \"Downloaded\"),\n    UniqueFiles = dcount(SourceFileName)\n    by UserId, bin(TimeGenerated, 1h)\n| where OperationCount > 50\n| extend ThreatIndicator = case(\n    DeleteCount > 30 and RenameCount > 30, \"üî¥ Ransomware Pattern\",\n    DownloadCount > 100, \"üî¥ Mass Exfiltration\",\n    DeleteCount > 50, \"üü† Mass Deletion\",\n    RenameCount > 50, \"üü† Mass Rename\",\n    \"üü° High Volume Activity\")\n| order by OperationCount desc\n| project TimeGenerated, ThreatIndicator, UserId, OperationCount, DeleteCount, RenameCount, ModifyCount, DownloadCount, UniqueFiles\n| take 20",
              "size": 0,
              "title": "ü¶† Mass File Operations (Ransomware/Exfiltration Indicators)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "OperationCount", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                  { "columnMatch": "DeleteCount", "formatter": 4, "formatOptions": { "palette": "red" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - mass file ops"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DLP and Sensitivity Label Activity\nOfficeActivity\n| where TimeGenerated {TimeRange}\n| where Operation has_any (\"DLPRuleMatch\", \"DLPRuleUndo\", \"SensitivityLabelApplied\", \"SensitivityLabelUpdated\", \"SensitivityLabelRemoved\", \"FileSensitivityLabelChanged\")\n| extend EventType = case(\n    Operation has \"DLPRuleMatch\", \"üö® DLP Rule Match\",\n    Operation has \"DLPRuleUndo\", \"‚Ü©Ô∏è DLP Undo\",\n    Operation has \"Applied\", \"üè∑Ô∏è Label Applied\",\n    Operation has \"Updated\" or Operation has \"Changed\", \"‚úèÔ∏è Label Changed\",\n    Operation has \"Removed\", \"‚ùå Label Removed\",\n    \"Other\")\n| extend Platform = case(\n    OfficeWorkload == \"SharePoint\", \"üìÇ SharePoint\",\n    OfficeWorkload == \"OneDrive\", \"‚òÅÔ∏è OneDrive\",\n    OfficeWorkload == \"Exchange\", \"üìß Exchange\",\n    \"Other\")\n| summarize Count = count() by EventType, Platform, UserId\n| order by Count desc\n| project EventType, Platform, UserId, Count\n| take 30",
              "size": 0,
              "title": "üè∑Ô∏è DLP & Sensitivity Label Activity",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - dlp sensitivity"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Admin Operations Across Platforms\nOfficeActivity\n| where TimeGenerated {TimeRange}\n| where OfficeWorkload in (\"SharePoint\", \"OneDrive\", \"MicrosoftTeams\")\n| where Operation has_any (\"SiteCollectionAdminAdded\", \"SiteAdminRemoved\", \"SitePermissionModified\", \"FolderPermissionModified\", \"AddedToGroup\", \"RemovedFromGroup\", \"TeamSettingChanged\", \"ChannelDeleted\", \"ChannelCreated\", \"SiteSharingModified\")\n| extend Platform = case(\n    OfficeWorkload == \"MicrosoftTeams\", \"üí¨ Teams\",\n    OfficeWorkload == \"SharePoint\", \"üìÇ SharePoint\",\n    OfficeWorkload == \"OneDrive\", \"‚òÅÔ∏è OneDrive\",\n    \"Other\")\n| extend RiskLevel = case(\n    Operation has_any (\"Admin\", \"Permission\"), \"üî¥ High Risk - Admin/Permission Change\",\n    Operation has \"Deleted\", \"üü† Medium Risk - Deletion\",\n    \"üü° Low Risk\")\n| summarize Count = count() by RiskLevel, Platform, Operation, UserId\n| order by RiskLevel asc, Count desc\n| project RiskLevel, Platform, Operation, UserId, Count\n| take 30",
              "size": 0,
              "title": "üëë Admin Operations Across Platforms",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - admin ops"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### ‚≠ê Priority Account Protection\n\n**Microsoft Defender for Office 365** protection is controlled by **Priority Account Safe Links and Safe Attachment policy scoping**. This section verifies your priority users are fully protected.\n\n| Policy Scoping | Recommendation |\n|----------------|----------------|\n| **Strict Preset Policy** | Apply to all priority accounts |\n| **Priority Account Safe Links** | Dedicated policy with strict settings |\n| **Priority Account Safe Attachments** | Dynamic Delivery or Block mode |\n| **Impersonation Protection** | Enable sender and domain impersonation |\n| **Priority Account Tags** | [Tag accounts in Microsoft 365 Defender](https://security.microsoft.com/userTags) |"
            },
            "name": "text - priority accounts header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Priority Accounts Protected - Summary\nlet PriorityPatterns = dynamic([\"CEO\", \"CFO\", \"CTO\", \"CISO\", \"COO\", \"President\", \"Director\", \"VP\", \"Vice President\", \"Executive\", \"Chief\", \"Partner\", \"Managing\", \"Principal\"]);\nlet PriorityRecipients = EmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| where isnotempty(ThreatTypes) or DeliveryAction in (\"Blocked\", \"Quarantined\")\n| where RecipientEmailAddress has_any (PriorityPatterns) or Subject has_any (PriorityPatterns)\n| distinct RecipientEmailAddress;\nlet ProtectedCount = toscalar(PriorityRecipients | count);\nlet TotalThreatsBlocked = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailDirection == \"Inbound\" | where RecipientEmailAddress in (PriorityRecipients) | where DeliveryAction in (\"Blocked\", \"Quarantined\") | count);\nlet PhishBlocked = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where RecipientEmailAddress in (PriorityRecipients) | where ThreatTypes has \"Phish\" and DeliveryAction in (\"Blocked\", \"Quarantined\") | count);\nlet MalwareBlocked = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where RecipientEmailAddress in (PriorityRecipients) | where ThreatTypes has \"Malware\" and DeliveryAction in (\"Blocked\", \"Quarantined\") | count);\nprint Metric = dynamic([\"‚≠ê Priority Accounts Protected\", \"üõ°Ô∏è Total Threats Blocked\", \"üé£ Phish Blocked\", \"ü¶† Malware Blocked\"]),\n      Value = pack_array(ProtectedCount, TotalThreatsBlocked, PhishBlocked, MalwareBlocked),\n      Description = dynamic([\"from threats\", \"for priority accounts\", \"for priority accounts\", \"for priority accounts\"])\n| mv-expand Metric to typeof(string), Value to typeof(long), Description to typeof(string)",
              "size": 4,
              "title": "‚≠ê Priority Account Protection Summary",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "blue" } },
                "secondaryContent": { "columnMatch": "Description", "formatter": 1 }
              }
            },
            "name": "query - priority protection summary"
          },
          {
            "type": 1,
            "content": {
              "json": "**‚úÖ We protected your priority accounts** from phish/malware emails using priority account protections applied to accounts you specified. The chart below shows the **top 5 targeted priority accounts** by threats received."
            },
            "name": "text - priority observation"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top 5 Targeted Priority Accounts by Phish/Malware Received\nlet PriorityPatterns = dynamic([\"CEO\", \"CFO\", \"CTO\", \"CISO\", \"COO\", \"President\", \"Director\", \"VP\", \"Vice President\", \"Executive\", \"Chief\", \"Partner\", \"Managing\"]);\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| where isnotempty(ThreatTypes)\n| where RecipientEmailAddress has_any (PriorityPatterns) or Subject has_any (PriorityPatterns)\n| summarize \n    TotalThreats = count(),\n    PhishReceived = countif(ThreatTypes has \"Phish\"),\n    MalwareReceived = countif(ThreatTypes has \"Malware\"),\n    Blocked = countif(DeliveryAction in (\"Blocked\", \"Quarantined\")),\n    Delivered = countif(DeliveryAction == \"Delivered\")\n    by RecipientEmailAddress\n| extend BlockRate = round(toreal(Blocked) / TotalThreats * 100, 1)\n| order by PhishReceived desc\n| take 5\n| project RecipientEmailAddress, PhishReceived, MalwareReceived, TotalThreats, Blocked, Delivered, strcat(BlockRate, \"% Blocked\")",
              "size": 0,
              "title": "üéØ Top 5 Targeted Priority Accounts (by Phish Received)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "barchart",
              "chartSettings": {
                "xAxis": "RecipientEmailAddress",
                "yAxis": ["PhishReceived", "MalwareReceived"],
                "seriesLabelSettings": [
                  { "seriesName": "PhishReceived", "color": "red" },
                  { "seriesName": "MalwareReceived", "color": "purple" }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - top 5 priority targets"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Targeted Users - Email Threats\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| where isnotempty(ThreatTypes) or DeliveryAction in (\"Blocked\", \"Quarantined\")\n| summarize \n    ThreatCount = count(),\n    PhishAttempts = countif(ThreatTypes has \"Phish\"),\n    MalwareAttempts = countif(ThreatTypes has \"Malware\"),\n    SpamCount = countif(ThreatTypes has \"Spam\"),\n    Blocked = countif(DeliveryAction in (\"Blocked\", \"Quarantined\")),\n    Delivered = countif(DeliveryAction == \"Delivered\" and isnotempty(ThreatTypes))\n    by RecipientEmailAddress\n| where ThreatCount > 0\n| extend RiskLevel = case(\n    Delivered > 0 and PhishAttempts > 0, \"üî¥ Critical - Phish Delivered\",\n    Delivered > 0, \"üü† Threats Delivered\",\n    ThreatCount > 10, \"üü° High Volume Target\",\n    \"üü¢ Protected\")\n| top 25 by ThreatCount desc\n| project RiskLevel, RecipientEmailAddress, ThreatCount, PhishAttempts, MalwareAttempts, SpamCount, Blocked, Delivered",
              "size": 0,
              "title": "‚≠ê Top Targeted Users - Email Threats",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Delivered", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                  { "columnMatch": "ThreatCount", "formatter": 4, "formatOptions": { "palette": "orange" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - priority account threats"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Users with Risky Sign-ins\nunion SigninLogs, AADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where RiskLevelDuringSignIn in (\"low\", \"medium\", \"high\") or ResultType != \"0\" or RiskState != \"none\"\n| summarize \n    TotalSignIns = count(),\n    RiskySignIns = countif(RiskLevelDuringSignIn in (\"medium\", \"high\")),\n    FailedSignIns = countif(ResultType != \"0\"),\n    UniqueIPs = dcount(IPAddress),\n    UniqueLocations = dcount(Location),\n    Apps = make_set(AppDisplayName, 3)\n    by UserPrincipalName, UserDisplayName\n| where RiskySignIns > 0 or FailedSignIns > 5\n| extend RiskLevel = case(\n    RiskySignIns > 5, \"üî¥ Critical\",\n    RiskySignIns > 2, \"üü† High\",\n    RiskySignIns > 0, \"üü° Medium\",\n    FailedSignIns > 10, \"üü° Failed Attempts\",\n    \"üü¢ Monitor\")\n| order by RiskySignIns desc, FailedSignIns desc\n| take 25\n| project RiskLevel, UserDisplayName, UserPrincipalName, TotalSignIns, RiskySignIns, FailedSignIns, UniqueIPs, UniqueLocations",
              "size": 0,
              "title": "üîê Users with Risky Sign-ins",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "RiskySignIns", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - priority account signin risk"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Impersonation Attempts Targeting Executives\nlet PriorityPatterns = dynamic([\"CEO\", \"CFO\", \"CTO\", \"CISO\", \"COO\", \"President\", \"Director\", \"VP\", \"Vice President\", \"Executive\", \"Chief\"]);\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| where SenderDisplayName has_any (PriorityPatterns)\n| where DeliveryAction in (\"Delivered\", \"Blocked\", \"Quarantined\")\n| extend IsImpersonation = (DetectionMethods has_any (\"Impersonation\", \"Domain impersonation\", \"User impersonation\", \"Spoof\") or EmailActionPolicy has_any (\"impersonation\", \"spoof\"))\n| summarize \n    TotalAttempts = count(),\n    ImpersonationDetected = countif(IsImpersonation),\n    DeliveredCount = countif(DeliveryAction == \"Delivered\"),\n    BlockedCount = countif(DeliveryAction in (\"Blocked\", \"Quarantined\")),\n    SenderDomains = make_set(SenderFromDomain, 5)\n    by SenderDisplayName, Subject\n| extend RiskLevel = case(\n    DeliveredCount > 0 and ImpersonationDetected > 0, \"üî¥ Impersonation Delivered\",\n    DeliveredCount > 0, \"üü† Delivered - Review\",\n    ImpersonationDetected > 0, \"üü° Impersonation Blocked\",\n    \"üü¢ Blocked\")\n| order by DeliveredCount desc, ImpersonationDetected desc\n| take 30\n| project RiskLevel, SenderDisplayName, Subject, TotalAttempts, ImpersonationDetected, DeliveredCount, BlockedCount, SenderDomains",
              "size": 0,
              "title": "üé≠ Executive Impersonation Attempts",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "DeliveredCount", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "name": "query - impersonation attempts"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### ÔøΩ Spoofing Detection & Analysis\n\n**PREVIEW:** This section provides insights into spoofing attempts detected in your environment, including **sender impersonation** and **domain spoofing**. Spoofing can trick users into believing an email is from a trusted source, but is also fundamental to correctly determining sender reputation and trustworthiness.\n\n> üí° For additional detail, utilize the [Spoofing and Impersonation Advanced Hunting Queries](https://security.microsoft.com/v2/advanced-hunting)"
            },
            "name": "text - spoofing header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Spoofing Detection Summary\nlet TotalInbound = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailDirection == \"Inbound\" | count);\nlet SpoofDetected = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailDirection == \"Inbound\" | where DetectionMethods has_any (\"Spoof\", \"DMARC\", \"SPF fail\", \"DKIM fail\") | count);\nlet SpoofBlocked = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailDirection == \"Inbound\" | where DetectionMethods has_any (\"Spoof\", \"DMARC\", \"SPF fail\") | where DeliveryAction in (\"Blocked\", \"Quarantined\") | count);\nlet SpoofDelivered = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailDirection == \"Inbound\" | where DetectionMethods has_any (\"Spoof\", \"DMARC\") | where DeliveryAction == \"Delivered\" | count);\nlet ImpersonationDetected = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where DetectionMethods has_any (\"Impersonation\", \"User impersonation\", \"Domain impersonation\") | count);\nprint Metric = dynamic([\"üé≠ Spoof Attempts Detected\", \"üõ°Ô∏è Spoofs Blocked\", \"‚ö†Ô∏è Spoofs Delivered\", \"üë§ Impersonation Detected\"]),\n      Value = pack_array(SpoofDetected, SpoofBlocked, SpoofDelivered, ImpersonationDetected)\n| mv-expand Metric to typeof(string), Value to typeof(long)",
              "size": 4,
              "title": "üé≠ Spoofing Detection Overview",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "auto" } }
              }
            },
            "name": "query - spoofing overview"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DMARC Enforcement Status - Domain Analysis\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| extend AuthDetails = parse_json(AuthenticationDetails)\n| extend \n    DMARC = tostring(AuthDetails.DMARC),\n    SPF = tostring(AuthDetails.SPF),\n    DKIM = tostring(AuthDetails.DKIM)\n| summarize \n    TotalEmails = count(),\n    DMARCPass = countif(DMARC == \"pass\"),\n    DMARCFail = countif(DMARC == \"fail\"),\n    DMARCNone = countif(DMARC == \"none\" or isempty(DMARC)),\n    SPFPass = countif(SPF == \"pass\"),\n    DKIMPass = countif(DKIM == \"pass\")\n    by SenderFromDomain\n| extend DMARCStatus = case(\n    DMARCFail > 0 and DMARCPass == 0, \"üî¥ DMARC Failing\",\n    DMARCNone == TotalEmails, \"‚ö†Ô∏è No DMARC\",\n    DMARCPass > DMARCFail, \"‚úÖ DMARC Enforced\",\n    \"üü° Mixed\")\n| where DMARCStatus != \"‚úÖ DMARC Enforced\" or TotalEmails > 100\n| order by TotalEmails desc\n| take 20\n| project DMARCStatus, SenderFromDomain, TotalEmails, DMARCPass, DMARCFail, DMARCNone, SPFPass, DKIMPass",
              "size": 0,
              "title": "üìß DMARC Enforcement by Sender Domain",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "DMARCFail", "formatter": 4, "formatOptions": { "palette": "red" } },
                  { "columnMatch": "DMARCPass", "formatter": 4, "formatOptions": { "palette": "green" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - dmarc by domain"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Spoof Intelligence - Top Spoofed Domains\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| where DetectionMethods has_any (\"Spoof\", \"DMARC\", \"Impersonation\")\n| extend SpoofType = case(\n    DetectionMethods has \"User impersonation\", \"üë§ User Impersonation\",\n    DetectionMethods has \"Domain impersonation\", \"üåê Domain Impersonation\",\n    DetectionMethods has \"Spoof\", \"üé≠ Spoofing\",\n    DetectionMethods has \"DMARC\", \"üìß DMARC Failure\",\n    \"Other\")\n| summarize \n    AttemptCount = count(),\n    Blocked = countif(DeliveryAction in (\"Blocked\", \"Quarantined\")),\n    Delivered = countif(DeliveryAction == \"Delivered\"),\n    UniqueImpersonated = dcount(SenderDisplayName)\n    by SenderFromDomain, SpoofType\n| extend BlockRate = strcat(round(toreal(Blocked) / AttemptCount * 100, 1), \"%\")\n| order by AttemptCount desc\n| take 25\n| project SpoofType, SenderFromDomain, AttemptCount, Blocked, Delivered, BlockRate, UniqueImpersonated",
              "size": 0,
              "title": "üé≠ Top Spoofed/Impersonated Domains",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Delivered", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                  { "columnMatch": "AttemptCount", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - spoofed domains"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DMARC Policy Compliance Assessment\nlet Domains = EmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| extend AuthDetails = parse_json(AuthenticationDetails)\n| extend DMARC = tostring(AuthDetails.DMARC)\n| summarize \n    Total = count(),\n    Pass = countif(DMARC == \"pass\"),\n    Fail = countif(DMARC == \"fail\"),\n    None = countif(DMARC == \"none\" or isempty(DMARC))\n| extend \n    PassRate = round(toreal(Pass) / Total * 100, 1),\n    FailRate = round(toreal(Fail) / Total * 100, 1),\n    NoneRate = round(toreal(None) / Total * 100, 1);\nDomains\n| extend Assessment = case(\n    PassRate >= 90, \"‚úÖ All domains appear to have DMARC enforcement\",\n    FailRate > 10, \"‚ö†Ô∏è High DMARC failure rate - investigate sender domains\",\n    NoneRate > 50, \"üü° Many senders lack DMARC - encourage adoption\",\n    \"üü¢ DMARC compliance acceptable\")\n| extend Recommendation = case(\n    PassRate >= 90, \"No action recommended. DMARC enforcement is encouraged on all domains to protect users and your brand.\",\n    FailRate > 10, \"Review failing domains in Spoof Intelligence. Consider blocking or allowing based on legitimacy.\",\n    NoneRate > 50, \"Many external senders lack DMARC. Consider implementing stricter anti-spoofing policies.\",\n    \"Continue monitoring. DMARC protects users and validates sender trustworthiness.\")\n| project Assessment, strcat(\"Pass: \", PassRate, \"%\"), strcat(\"Fail: \", FailRate, \"%\"), strcat(\"None: \", NoneRate, \"%\"), Recommendation",
              "size": 0,
              "title": "üìä DMARC Policy Compliance Assessment",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "query - dmarc assessment"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Anti-Phishing Policy DMARC Respecting Check\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| extend AuthDetails = parse_json(AuthenticationDetails)\n| extend DMARC = tostring(AuthDetails.DMARC)\n| where DMARC == \"fail\"\n| summarize \n    DMARCFailTotal = count(),\n    Blocked = countif(DeliveryAction in (\"Blocked\", \"Quarantined\")),\n    Delivered = countif(DeliveryAction == \"Delivered\"),\n    Junk = countif(DeliveryLocation == \"Junk folder\")\n| extend EnforcementRate = round(toreal(Blocked + Junk) / DMARCFailTotal * 100, 1)\n| extend PolicyStatus = case(\n    Delivered == 0, \"‚úÖ Anti-phishing policy is respecting senders' DMARC wishes\",\n    EnforcementRate >= 90, \"üü¢ Most DMARC failures being blocked/junked\",\n    EnforcementRate >= 70, \"üü° Some DMARC failures delivered - review policy\",\n    \"üî¥ DMARC failures being delivered - action required\")\n| extend Suggestion = case(\n    Delivered == 0, \"No action suggested. Enforcing senders' DMARC policies contributes to a safer environment for your users.\",\n    \"Review Anti-phishing policy settings to honor sender DMARC policies. See: Set up DMARC to validate From address domain.\")\n| project PolicyStatus, DMARCFailTotal, Blocked, Delivered, Junk, strcat(EnforcementRate, \"% Enforced\"), Suggestion",
              "size": 0,
              "title": "üõ°Ô∏è Anti-Phishing DMARC Policy Enforcement",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "query - dmarc enforcement"
          },
          {
            "type": 1,
            "content": {
              "json": "**üí° DMARC Insights:**\n- **Enforcing senders' DMARC policies** contributes to a safer environment for your users and makes configuration mistakes the responsibility of the sender\n- For more information see [Set up DMARC to validate the From address domain for cloud senders](https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/email-authentication-dmarc-configure)\n- Review [Spoof Intelligence](https://security.microsoft.com/spoofintelligence) to manage allowed/blocked spoofed senders"
            },
            "name": "text - dmarc insights"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### ÔøΩüè¢ Internal Network & Intranet Protection\n\nMonitor internal email flow, assess email authentication for internal domains, and verify intranet protection compliance.\n\n| Protection | Best Practice |\n|------------|---------------|\n| **Internal Mail Flow** | Monitor intra-org email for lateral phishing |\n| **Connectors** | Secure on-premises connectors with TLS |\n| **Internal Spoofing** | Detect internal domain impersonation |\n| **Safe Links Internal** | Enable for intra-org messages |"
            },
            "name": "text - intranet header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Internal Email Threat Detection\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Intra-org\"\n| summarize \n    TotalIntraOrg = count(),\n    ThreatsDetected = countif(isnotempty(ThreatTypes)),\n    PhishingInternal = countif(ThreatTypes has \"Phish\"),\n    MalwareInternal = countif(ThreatTypes has \"Malware\"),\n    Blocked = countif(DeliveryAction in (\"Blocked\", \"Quarantined\")),\n    Delivered = countif(DeliveryAction == \"Delivered\")\n| extend InternalThreatRate = round(toreal(ThreatsDetected) / TotalIntraOrg * 100, 2)\n| project \n    Metric = pack_array(\"üìß Total Intra-Org Emails\", \"‚ö†Ô∏è Threats Detected\", \"üé£ Internal Phishing\", \"ü¶† Internal Malware\", \"‚úÖ Blocked\", \"‚ùå Delivered\", \"üìä Internal Threat Rate %\"),\n    Value = pack_array(TotalIntraOrg, ThreatsDetected, PhishingInternal, MalwareInternal, Blocked, Delivered, InternalThreatRate)\n| mv-expand Metric to typeof(string), Value to typeof(long)",
              "size": 4,
              "title": "üè¢ Internal Email Security Overview",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "auto" } }
              }
            },
            "name": "query - internal email overview"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Internal Lateral Phishing Detection\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Intra-org\"\n| where ThreatTypes has_any (\"Phish\", \"Malware\") \n    or Subject has_any (\"password\", \"urgent\", \"action required\", \"verify\", \"suspended\", \"expire\")\n| summarize \n    SuspiciousCount = count(),\n    UniqueRecipients = dcount(RecipientEmailAddress),\n    ThreatDetected = countif(isnotempty(ThreatTypes)),\n    Subjects = make_set(Subject, 3)\n    by SenderFromAddress\n| where SuspiciousCount >= 3\n| extend RiskLevel = case(\n    ThreatDetected > 0, \"üî¥ Compromised Account\",\n    SuspiciousCount > 10, \"üü† Potential Compromise\",\n    \"üü° Monitor\")\n| order by ThreatDetected desc, SuspiciousCount desc\n| project RiskLevel, SenderFromAddress, SuspiciousCount, UniqueRecipients, ThreatDetected, Subjects",
              "size": 0,
              "title": "üîÑ Internal Lateral Phishing Detection",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "ThreatDetected", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                  { "columnMatch": "SuspiciousCount", "formatter": 4, "formatOptions": { "palette": "orange" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - lateral phishing"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Internal Domain Spoofing Check\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| extend AuthDetails = parse_json(AuthenticationDetails)\n| extend \n    SPFResult = tostring(AuthDetails.SPF),\n    DKIMResult = tostring(AuthDetails.DKIM),\n    DMARCResult = tostring(AuthDetails.DMARC)\n| where SPFResult in (\"fail\", \"softfail\") or DMARCResult == \"fail\"\n| where SenderFromDomain has_any (\"internal\", \"corp\", \"local\") // Adjust patterns for your org\n    or SenderDisplayName has_any (\"IT\", \"Help Desk\", \"Admin\", \"System\", \"Support\")\n| summarize \n    SpoofAttempts = count(),\n    DeliveredCount = countif(DeliveryAction == \"Delivered\"),\n    BlockedCount = countif(DeliveryAction in (\"Blocked\", \"Quarantined\")),\n    SampleSubjects = make_set(Subject, 3)\n    by SenderFromDomain, SenderDisplayName\n| extend RiskLevel = case(\n    DeliveredCount > 0, \"üî¥ Spoofed & Delivered\",\n    SpoofAttempts > 10, \"üü† Persistent Spoofing\",\n    \"üü° Blocked\")\n| order by DeliveredCount desc, SpoofAttempts desc\n| project RiskLevel, SenderFromDomain, SenderDisplayName, SpoofAttempts, DeliveredCount, BlockedCount, SampleSubjects",
              "size": 0,
              "title": "üé≠ Internal Domain Spoofing Attempts",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "DeliveredCount", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - internal spoofing"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### ‚úÖ Intranet Protection Compliance Check\n\nValidate that recommended security configurations are in place for internal protection."
            },
            "name": "text - compliance check header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Intranet Protection Compliance Assessment\nlet IntraOrgEmails = EmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Intra-org\"\n| summarize TotalIntraOrg = count(), ThreatsBlocked = countif(DeliveryAction in (\"Blocked\", \"Quarantined\") and isnotempty(ThreatTypes));\nlet SafeLinksIntraOrg = UrlClickEvents\n| where TimeGenerated {TimeRange}\n| where Workload in (\"Email\", \"Office\")\n| summarize SafeLinksActive = count(), BlockedLinks = countif(ActionType has \"Blocked\");\nlet InternalAuth = EmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Intra-org\"\n| extend AuthDetails = parse_json(AuthenticationDetails)\n| summarize \n    InternalSPFPass = countif(tostring(AuthDetails.SPF) == \"pass\"),\n    InternalDKIMPass = countif(tostring(AuthDetails.DKIM) == \"pass\"),\n    TotalInternal = count();\nlet ConnectorSecurity = EmailEvents\n| where TimeGenerated {TimeRange}\n| where Connectors != \"\"\n| summarize ConnectorEmails = count(), SecureConnectors = countif(Connectors has \"TLS\");\nprint \n    Check = dynamic([\n        \"‚úÖ Intra-Org Threat Detection\",\n        \"‚úÖ Safe Links for Internal\", \n        \"‚úÖ Internal SPF Validation\",\n        \"‚úÖ Internal DKIM Signing\",\n        \"‚úÖ Connector Security\"\n    ]),\n    Status = pack_array(\n        iff(toscalar(IntraOrgEmails | project ThreatsBlocked) > 0, \"Active - Threats Blocked\", \"Monitoring Only\"),\n        iff(toscalar(SafeLinksIntraOrg | project SafeLinksActive) > 0, \"Active\", \"Not Detected\"),\n        iff(toscalar(InternalAuth | project InternalSPFPass) > toscalar(InternalAuth | project TotalInternal) * 0.9, \"Compliant (>90%)\", \"Review Needed\"),\n        iff(toscalar(InternalAuth | project InternalDKIMPass) > toscalar(InternalAuth | project TotalInternal) * 0.8, \"Compliant (>80%)\", \"Review Needed\"),\n        iff(toscalar(ConnectorSecurity | project SecureConnectors) > 0, \"TLS Enabled\", \"Review Connectors\")\n    ),\n    Recommendation = dynamic([\n        \"Enable Safe Attachments for internal mail\",\n        \"Enable Safe Links for intra-org messages in policy\",\n        \"Ensure all internal domains have SPF records\",\n        \"Enable DKIM signing for all sending domains\",\n        \"Enforce TLS 1.2+ on all connectors\"\n    ])\n| mv-expand Check to typeof(string), Status to typeof(string), Recommendation to typeof(string)\n| extend Compliance = case(\n    Status has \"Active\" or Status has \"Compliant\" or Status has \"TLS\", \"‚úÖ\",\n    Status has \"Monitoring\", \"üü°\",\n    \"‚ùå\")",
              "size": 0,
              "title": "‚úÖ Intranet Protection Compliance Status",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Compliance", "formatter": 0 },
                  { "columnMatch": "Status", "formatter": 0 }
                ]
              }
            },
            "name": "query - intranet compliance"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Internal vs External Threat Comparison\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(ThreatTypes)\n| extend Direction = case(\n    EmailDirection == \"Inbound\", \"External Inbound\",\n    EmailDirection == \"Intra-org\", \"Internal\",\n    EmailDirection == \"Outbound\", \"Outbound\",\n    \"Other\")\n| summarize ThreatCount = count() by Direction, ThreatTypes\n| order by ThreatCount desc",
              "size": 2,
              "title": "üìä Threat Distribution: Internal vs External",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - internal vs external threats"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Mail Flow Connector Analysis\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where Connectors != \"\"\n| summarize \n    EmailCount = count(),\n    InboundCount = countif(EmailDirection == \"Inbound\"),\n    OutboundCount = countif(EmailDirection == \"Outbound\"),\n    ThreatsViaConnector = countif(isnotempty(ThreatTypes))\n    by Connectors\n| extend SecurityStatus = case(\n    ThreatsViaConnector > 0, \"‚ö†Ô∏è Threats Detected\",\n    Connectors has \"TLS\", \"‚úÖ Secure\",\n    \"üîç Review\")\n| order by ThreatsViaConnector desc, EmailCount desc\n| project SecurityStatus, Connectors, EmailCount, InboundCount, OutboundCount, ThreatsViaConnector",
              "size": 0,
              "title": "üîå Mail Flow Connector Security",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "ThreatsViaConnector", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - connector analysis"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "ZAP"
      },
      "name": "group - zap"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üö® XDR Alerts & Attack Chains\n\nUnified view of email security alerts from Microsoft Defender for Office 365, correlated with identity threats to detect multi-stage attack chains (phishing ‚Üí credential theft ‚Üí account takeover)."
            },
            "name": "text - xdr header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Alert Overview Metrics\nlet HighSev = toscalar(AlertInfo | where TimeGenerated {TimeRange} | where ServiceSource has_any (\"Office 365\", \"Microsoft Defender for Office 365\", \"MDO\", \"Microsoft 365 Defender\") | where Severity == \"High\" | count);\nlet MedSev = toscalar(AlertInfo | where TimeGenerated {TimeRange} | where ServiceSource has_any (\"Office 365\", \"Microsoft Defender for Office 365\", \"MDO\", \"Microsoft 365 Defender\") | where Severity == \"Medium\" | count);\nlet MDOTotal = toscalar(AlertInfo | where TimeGenerated {TimeRange} | where ServiceSource has_any (\"Office 365\", \"Microsoft Defender for Office 365\", \"MDO\", \"Microsoft 365 Defender\") | count);\nlet IdentityTotal = toscalar(AlertInfo | where TimeGenerated {TimeRange} | where ServiceSource has_any (\"Azure AD\", \"Microsoft Entra\", \"MCAS\", \"Identity Protection\") | count);\nlet AiTMCount = toscalar(AlertInfo | where TimeGenerated {TimeRange} | where Title has_any (\"AiTM\", \"adversary-in-the-middle\", \"token theft\", \"session hijack\") | count);\nprint Metric = dynamic([\"üî¥ High Severity\", \"üü° Medium Severity\", \"üìß Email Alerts\", \"üîê Identity Alerts\", \"‚ö° AiTM Alerts\"]),\n      Value = pack_array(HighSev, MedSev, MDOTotal, IdentityTotal, AiTMCount)\n| mv-expand Metric to typeof(string), Value to typeof(long)",
              "size": 4,
              "title": "üìä Alert Overview",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "auto" } }
              }
            },
            "name": "query - alert overview"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Alert Categories Distribution\nAlertInfo\n| where TimeGenerated {TimeRange}\n| where ServiceSource has_any (\"Office 365\", \"Microsoft Defender for Office 365\", \"MDO\", \"Azure AD\", \"Microsoft Entra\", \"MCAS\", \"Microsoft 365 Defender\")\n| summarize Count = count() by Category\n| order by Count desc",
              "size": 2,
              "title": "üìà Alert Categories",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "query - alert categories"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Alert Timeline by Severity\nAlertInfo\n| where TimeGenerated {TimeRange}\n| where ServiceSource has_any (\"Office 365\", \"MDO\", \"Azure AD\", \"Microsoft Entra\", \"Microsoft 365 Defender\")\n| summarize Count = count() by Severity, bin(TimeGenerated, 4h)\n| order by TimeGenerated asc",
              "size": 0,
              "title": "üìà Alert Timeline",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "timechart"
            },
            "customWidth": "67",
            "name": "query - alert timeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Multi-Stage Incidents with Email + Identity Alerts\nlet EmailAlerts = AlertInfo\n| where TimeGenerated {TimeRange}\n| where ServiceSource has_any (\"Office 365\", \"Microsoft Defender for Office 365\", \"MDO\", \"Microsoft 365 Defender\")\n| where Category has_any (\"Phishing\", \"InitialAccess\", \"Execution\") or Title has_any (\"phish\", \"credential\", \"malicious\", \"BEC\")\n| project AlertId, EmailAlertTime = TimeGenerated, EmailTitle = Title, EmailSeverity = Severity, EmailCategory = Category;\nlet IdentityAlerts = AlertInfo\n| where TimeGenerated {TimeRange}\n| where ServiceSource has_any (\"Azure Active Directory\", \"Microsoft Entra\", \"Azure AD Identity Protection\", \"MCAS\", \"Cloud App Security\", \"Microsoft 365 Defender\")\n| where Category has_any (\"CredentialAccess\", \"Persistence\", \"InitialAccess\", \"LateralMovement\") \n    or Title has_any (\"impossible travel\", \"anomalous\", \"token\", \"MFA\", \"session\", \"credential\", \"suspicious sign-in\", \"password spray\", \"brute force\")\n| project AlertId, IdentityAlertTime = TimeGenerated, IdentityTitle = Title, IdentitySeverity = Severity, IdentityCategory = Category;\nAlertEvidence\n| where TimeGenerated {TimeRange}\n| where isnotempty(AccountUpn)\n| project AlertId, AccountUpn, NetworkMessageId, TimeGenerated\n| join kind=inner EmailAlerts on AlertId\n| join kind=inner (\n    AlertEvidence\n    | where TimeGenerated {TimeRange}\n    | where isnotempty(AccountUpn)\n    | project IdentityAlertId = AlertId, AccountUpn\n    | join kind=inner IdentityAlerts on $left.IdentityAlertId == $right.AlertId\n) on AccountUpn\n| where IdentityAlertTime > EmailAlertTime and IdentityAlertTime < EmailAlertTime + 72h\n| summarize \n    EmailAlerts = make_set(EmailTitle, 5),\n    IdentityAlerts = make_set(IdentityTitle, 5),\n    FirstEmailAlert = min(EmailAlertTime),\n    FirstIdentityAlert = min(IdentityAlertTime),\n    TotalCorrelations = count()\n    by AccountUpn, EmailSeverity, IdentitySeverity\n| extend AttackChainRisk = case(\n    EmailSeverity == \"High\" and IdentitySeverity == \"High\", \"üî¥ Critical\",\n    EmailSeverity == \"High\" or IdentitySeverity == \"High\", \"üü† High\",\n    \"üü° Medium\")\n| extend TimeToCompromise = datetime_diff('minute', FirstIdentityAlert, FirstEmailAlert)\n| order by TotalCorrelations desc\n| project AttackChainRisk, AccountUpn, EmailAlerts, IdentityAlerts, TimeToCompromise, FirstEmailAlert, FirstIdentityAlert, TotalCorrelations",
              "size": 0,
              "title": "üîó Multi-Stage Attack Chains: Email ‚Üí Credential Theft",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "TotalCorrelations", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                  { "columnMatch": "TimeToCompromise", "formatter": 4, "formatOptions": { "palette": "orange" } }
                ]
              }
            },
            "name": "query - multistage attack chains"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AiTM Specific Attack Patterns\nAlertInfo\n| where TimeGenerated {TimeRange}\n| where Title has_any (\n    \"adversary-in-the-middle\", \"AiTM\", \"attacker in the middle\",\n    \"session hijack\", \"token theft\", \"cookie theft\",\n    \"OAuth\", \"consent\", \"illicit consent\",\n    \"suspicious inbox rule\", \"inbox forwarding\",\n    \"BEC\", \"business email compromise\",\n    \"impossible travel\", \"anomalous token\",\n    \"stolen session\", \"session cookie\",\n    \"MFA bypass\", \"MFA fraud\")\n| join kind=leftouter (\n    AlertEvidence\n    | where TimeGenerated {TimeRange}\n    | summarize \n        Users = make_set(AccountUpn, 10),\n        IPs = make_set(RemoteIP, 10),\n        Emails = make_set(EmailSubject, 5)\n        by AlertId\n) on AlertId\n| extend RiskLevel = case(\n    Severity == \"High\" and Title has_any (\"AiTM\", \"adversary-in-the-middle\", \"token theft\"), \"üî¥ Critical\",\n    Severity == \"High\", \"üü† High\",\n    Severity == \"Medium\", \"üü° Medium\",\n    \"üü¢ Low\")\n| project TimeGenerated, RiskLevel, Title, Category, ServiceSource, Users, IPs, Emails, AttackTechniques, AlertId\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üéØ AiTM & Session Hijacking Alerts",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "name": "query - aitm alerts"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// MDO-Related Incidents with Multiple Alert Types\nAlertInfo\n| where TimeGenerated {TimeRange}\n| where ServiceSource has_any (\"Office 365\", \"Microsoft Defender for Office 365\", \"MDO\", \"Microsoft 365 Defender\")\n| where isnotempty(AttackTechniques)\n| extend Techniques = parse_json(AttackTechniques)\n| mv-expand Technique = Techniques\n| extend TechniqueStr = tostring(Technique)\n| where TechniqueStr has_any (\n    \"T1566\", \"T1598\", \"T1534\",  // Phishing techniques\n    \"T1110\", \"T1111\", \"T1556\",  // Credential Access\n    \"T1539\", \"T1550\", \"T1528\",  // Token/Session techniques\n    \"T1114\", \"T1087\", \"T1201\")  // Email Collection, Account Discovery\n| summarize \n    AlertCount = count(),\n    Alerts = make_set(Title, 10),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by TechniqueStr, Category\n| order by AlertCount desc\n| project TechniqueStr, Category, AlertCount, Alerts, FirstSeen, LastSeen",
              "size": 0,
              "title": "‚öîÔ∏è MITRE ATT&CK Techniques (Email ‚Üí Credential)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "AlertCount", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - mitre techniques"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Attack Timeline - Email to Identity Compromise\nlet TimelineBin = 4h;\nAlertInfo\n| where TimeGenerated {TimeRange}\n| where ServiceSource has_any (\"Office 365\", \"MDO\", \"Azure AD\", \"Microsoft Entra\", \"MCAS\", \"Microsoft 365 Defender\")\n| where Category has_any (\"InitialAccess\", \"CredentialAccess\", \"Persistence\", \"Phishing\", \"Collection\")\n| summarize Count = count() by Category, bin(TimeGenerated, TimelineBin)\n| order by TimeGenerated asc",
              "size": 0,
              "title": "üìà Attack Phase Timeline",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "areachart",
              "chartSettings": {
                "seriesLabelSettings": [
                  { "seriesName": "InitialAccess", "color": "orange" },
                  { "seriesName": "CredentialAccess", "color": "redBright" },
                  { "seriesName": "Persistence", "color": "purple" },
                  { "seriesName": "Phishing", "color": "yellow" },
                  { "seriesName": "Collection", "color": "blue" }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - attack timeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Credential Theft Indicators from Email Activity\nlet SuspiciousEmails = EmailEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has_any (\"Phish\", \"Credential\") \n    or Subject has_any (\"password\", \"verify\", \"confirm\", \"update your\", \"expire\", \"urgent\", \"action required\")\n| where DeliveryAction == \"Delivered\"\n| project RecipientEmailAddress, NetworkMessageId, EmailTime = TimeGenerated, Subject, SenderFromAddress;\nlet CompromiseSignals = union \n    (SigninLogs \n    | where TimeGenerated {TimeRange}\n    | where RiskLevelDuringSignIn in (\"medium\", \"high\") or RiskState != \"none\"\n    | project UserPrincipalName, SignInTime = TimeGenerated, SignInRisk = RiskLevelDuringSignIn, IPAddress, Location),\n    (AADNonInteractiveUserSignInLogs\n    | where TimeGenerated {TimeRange}\n    | where RiskLevelDuringSignIn in (\"medium\", \"high\")\n    | project UserPrincipalName, SignInTime = TimeGenerated, SignInRisk = RiskLevelDuringSignIn, IPAddress, Location);\nSuspiciousEmails\n| join kind=inner (\n    CompromiseSignals\n) on $left.RecipientEmailAddress == $right.UserPrincipalName\n| where SignInTime > EmailTime and SignInTime < EmailTime + 24h\n| extend MinutesToCompromise = datetime_diff('minute', SignInTime, EmailTime)\n| summarize \n    SuspiciousEmailCount = dcount(NetworkMessageId),\n    RiskySignInCount = count(),\n    AvgTimeToCompromise = avg(MinutesToCompromise),\n    Senders = make_set(SenderFromAddress, 5),\n    SignInIPs = make_set(IPAddress, 5)\n    by RecipientEmailAddress\n| extend RiskLevel = case(\n    RiskySignInCount > 5, \"üî¥ Critical\",\n    RiskySignInCount > 2, \"üü† High\",\n    \"üü° Medium\")\n| order by RiskySignInCount desc\n| project RiskLevel, RecipientEmailAddress, SuspiciousEmailCount, RiskySignInCount, AvgTimeToCompromise, Senders, SignInIPs",
              "size": 0,
              "title": "üîê Phishing Email ‚Üí Risky Sign-In Correlation",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "RiskySignInCount", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                  { "columnMatch": "AvgTimeToCompromise", "formatter": 4, "formatOptions": { "palette": "orange" } }
                ]
              }
            },
            "name": "query - phishing to signin correlation"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Post-Compromise Activity: Inbox Rules & Forwarding\nAlertInfo\n| where TimeGenerated {TimeRange}\n| where Title has_any (\n    \"inbox rule\", \"forwarding rule\", \"mail forwarding\",\n    \"suspicious mail\", \"email exfiltration\",\n    \"redirect\", \"auto-forward\")\n| join kind=leftouter (\n    AlertEvidence\n    | where TimeGenerated {TimeRange}\n    | summarize \n        Users = make_set(AccountUpn, 10),\n        ForwardingTargets = make_set(RemoteUrl, 10)\n        by AlertId\n) on AlertId\n| extend RiskLevel = case(\n    Severity == \"High\", \"üî¥ High\",\n    Severity == \"Medium\", \"üü† Medium\",\n    \"üü° Low\")\n| project TimeGenerated, RiskLevel, Title, Users, ForwardingTargets, ServiceSource, AlertId\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üì§ Post-Compromise: Suspicious Inbox Rules & Forwarding",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "query - inbox rules alerts"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// OAuth/Consent Grant Attacks\nAlertInfo\n| where TimeGenerated {TimeRange}\n| where Title has_any (\n    \"OAuth\", \"consent\", \"illicit consent\",\n    \"app consent\", \"application consent\",\n    \"suspicious application\", \"malicious app\",\n    \"risky OAuth\")\n| join kind=leftouter (\n    AlertEvidence\n    | where TimeGenerated {TimeRange}\n    | summarize \n        Users = make_set(AccountUpn, 10),\n        Apps = make_set(Application, 10)\n        by AlertId\n) on AlertId\n| extend RiskLevel = case(\n    Severity == \"High\", \"üî¥ High\",\n    Severity == \"Medium\", \"üü† Medium\",\n    \"üü° Low\")\n| project TimeGenerated, RiskLevel, Title, Users, Apps, ServiceSource, AlertId\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üîì OAuth & Consent Grant Attacks",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "query - oauth consent attacks"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// High-Risk Users with Email + Identity Alerts\nlet EmailAffectedUsers = AlertEvidence\n| where TimeGenerated {TimeRange}\n| join kind=inner (\n    AlertInfo\n    | where TimeGenerated {TimeRange}\n    | where ServiceSource has_any (\"Office 365\", \"MDO\", \"Microsoft 365 Defender\")\n) on AlertId\n| where isnotempty(AccountUpn)\n| summarize EmailAlertCount = dcount(AlertId), EmailAlertTitles = make_set(Title, 5) by AccountUpn;\nlet IdentityAffectedUsers = AlertEvidence\n| where TimeGenerated {TimeRange}\n| join kind=inner (\n    AlertInfo\n    | where TimeGenerated {TimeRange}\n    | where ServiceSource has_any (\"Azure AD\", \"Microsoft Entra\", \"MCAS\", \"Identity Protection\")\n) on AlertId\n| where isnotempty(AccountUpn)\n| summarize IdentityAlertCount = dcount(AlertId), IdentityAlertTitles = make_set(Title, 5) by AccountUpn;\nEmailAffectedUsers\n| join kind=inner IdentityAffectedUsers on AccountUpn\n| extend TotalAlerts = EmailAlertCount + IdentityAlertCount\n| extend RiskLevel = case(\n    TotalAlerts > 10, \"üî¥ Critical\",\n    TotalAlerts > 5, \"üü† High\",\n    TotalAlerts > 2, \"üü° Medium\",\n    \"üü¢ Low\")\n| order by TotalAlerts desc\n| project RiskLevel, AccountUpn, EmailAlertCount, EmailAlertTitles, IdentityAlertCount, IdentityAlertTitles, TotalAlerts",
              "size": 0,
              "title": "üë§ High-Risk Users: Combined Email + Identity Alerts",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "TotalAlerts", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "name": "query - high risk users combined"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üè∑Ô∏è Tagged Incidents: BEC, Credential Phishing & AiTM\n\nMonitor incidents that have been tagged with specific threat categories for prioritized investigation. **Click on a tile below to see detailed events.**"
            },
            "name": "text - tagged incidents header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// All Available Tags in Incidents\nSecurityIncident\n| where TimeGenerated {TimeRange}\n| where isnotempty(Labels)\n| mv-expand Label = Labels\n| summarize IncidentCount = count() by Tag = tostring(Label)\n| order by IncidentCount desc\n| take 25",
              "size": 3,
              "title": "üîç Available Tags in Your Incidents (Click to see what tags exist)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "IncidentCount", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - available tags"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Tag Distribution Chart\nSecurityIncident\n| where TimeGenerated {TimeRange}\n| where isnotempty(Labels)\n| mv-expand Label = Labels\n| summarize Count = count() by Tag = tostring(Label)\n| order by Count desc\n| take 10",
              "size": 3,
              "title": "üìä Top 10 Tags Distribution",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "query - tag distribution chart"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "threat-type-selector",
                  "version": "KqlParameterItem/1.0",
                  "name": "SelectedThreatType",
                  "type": 2,
                  "isRequired": true,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "jsonData": "[{\"value\":\"All\",\"label\":\"üìä All Incidents\"},{\"value\":\"BEC\",\"label\":\"üí∞ BEC & Fraud\"},{\"value\":\"Phishing\",\"label\":\"üîê Credential Phishing\"},{\"value\":\"AiTM\",\"label\":\"‚ö° AiTM Attacks\"}]",
                  "value": "All"
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - threat type selector"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Incidents Tagged with BEC, Credential Phish, or AiTM (Defender XDR)\nSecurityIncident\n| where TimeGenerated {TimeRange}\n| extend XDRTags = tostring(parse_json(tostring(AdditionalData)).alertProductNames)\n| extend ProviderTags = tostring(parse_json(tostring(AdditionalData)).tactics)\n| where Labels has_any (\"BEC\", \"bec\", \"Business Email Compromise\", \"Credential\", \"credential\", \"Phish\", \"phish\", \"AiTM\", \"aitm\", \"Adversary-in-the-Middle\", \"MFA bypass\", \"token theft\", \"fraud\", \"invoice\", \"payment\")\n    or Title has_any (\"BEC\", \"Business Email Compromise\", \"credential phish\", \"AiTM\", \"adversary in the middle\", \"MFA bypass\", \"token theft\", \"invoice fraud\", \"payment fraud\", \"wire transfer\", \"impersonation\", \"phishing\", \"credential\")\n    or Description has_any (\"BEC\", \"credential\", \"phish\", \"AiTM\", \"token theft\", \"impersonation\")\n| extend TagList = Labels\n| extend IncidentSeverity = case(\n    Severity == \"High\", \"üî¥ High\",\n    Severity == \"Medium\", \"üü† Medium\",\n    Severity == \"Low\", \"üü° Low\",\n    \"‚ö™ Informational\")\n| extend IncidentStatus = case(\n    Status == \"Active\" or Status == \"New\", \"üî• Active\",\n    Status == \"Closed\", \"‚úÖ Closed\",\n    \"üîÑ In Progress\")\n| extend OwnerName = tostring(Owner.assignedTo)\n| extend AlertCount = array_length(AlertIds)\n| project TimeGenerated, IncidentNumber, IncidentSeverity, IncidentStatus, Title, TagList, OwnerName, Classification, AlertCount, IncidentUrl\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üè∑Ô∏è Tagged Incidents: BEC, Credential Phishing & AiTM (Defender XDR)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "IncidentUrl", "formatter": 7, "formatOptions": { "linkTarget": "Url", "linkLabel": "Open Incident" } },
                  { "columnMatch": "AlertsCount", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedThreatType",
              "comparison": "isEqualTo",
              "value": "All"
            },
            "name": "query - tagged incidents"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// BEC Fraud Incidents Summary\nSecurityIncident\n| where TimeGenerated {TimeRange}\n| where Labels has_any (\"BEC\", \"bec\", \"Business Email Compromise\", \"fraud\", \"invoice\", \"payment\", \"wire transfer\")\n    or Title has_any (\"BEC\", \"Business Email Compromise\", \"invoice fraud\", \"payment fraud\", \"wire transfer\", \"vendor fraud\")\n| extend AlertCount = array_length(AlertIds)\n| summarize \n    TotalIncidents = count(),\n    ActiveIncidents = countif(Status in (\"Active\", \"New\")),\n    ClosedIncidents = countif(Status == \"Closed\"),\n    HighSeverity = countif(Severity == \"High\"),\n    TotalAlerts = sum(AlertCount)\n| extend StatusLabel = \"üéØ BEC/Fraud Incidents\", ThreatType = \"BEC\"\n| project StatusLabel, ThreatType, TotalIncidents, ActiveIncidents, ClosedIncidents, HighSeverity, TotalAlerts",
              "size": 4,
              "title": "üí∞ BEC & Fraud Incidents",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "StatusLabel", "formatter": 1 },
                "leftContent": { "columnMatch": "TotalIncidents", "formatter": 12, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                "secondaryContent": { "columnMatch": "ActiveIncidents", "formatter": 1 }
              },
              "exportedParameters": [
                {
                  "fieldName": "ThreatType",
                  "parameterName": "SelectedThreatType",
                  "parameterType": 1
                }
              ]
            },
            "customWidth": "33",
            "name": "query - bec incidents summary"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Credential Phishing Incidents Summary\nSecurityIncident\n| where TimeGenerated {TimeRange}\n| where Labels has_any (\"Credential\", \"credential\", \"Phish\", \"phish\", \"password\", \"credential theft\", \"credential access\")\n    or Title has_any (\"credential phish\", \"credential theft\", \"password\", \"phishing\", \"credential access\", \"stolen credential\")\n| extend AlertCount = array_length(AlertIds)\n| summarize \n    TotalIncidents = count(),\n    ActiveIncidents = countif(Status in (\"Active\", \"New\")),\n    ClosedIncidents = countif(Status == \"Closed\"),\n    HighSeverity = countif(Severity == \"High\"),\n    TotalAlerts = sum(AlertCount)\n| extend StatusLabel = \"üîê Credential Phishing\", ThreatType = \"Phishing\"\n| project StatusLabel, ThreatType, TotalIncidents, ActiveIncidents, ClosedIncidents, HighSeverity, TotalAlerts",
              "size": 4,
              "title": "üîê Credential Phishing Incidents",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "StatusLabel", "formatter": 1 },
                "leftContent": { "columnMatch": "TotalIncidents", "formatter": 12, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                "secondaryContent": { "columnMatch": "ActiveIncidents", "formatter": 1 }
              },
              "exportedParameters": [
                {
                  "fieldName": "ThreatType",
                  "parameterName": "SelectedThreatType",
                  "parameterType": 1
                }
              ]
            },
            "customWidth": "33",
            "name": "query - credential phish incidents summary"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AiTM Incidents Summary (Based on Defender XDR Tag)\nSecurityIncident\n| where TimeGenerated {TimeRange}\n| where Labels has \"AiTM\"\n| extend AlertCount = array_length(AlertIds)\n| summarize \n    TotalIncidents = count(),\n    ActiveIncidents = countif(Status in (\"Active\", \"New\")),\n    ClosedIncidents = countif(Status == \"Closed\"),\n    HighSeverity = countif(Severity == \"High\"),\n    TotalAlerts = sum(AlertCount)\n| extend StatusLabel = \"‚ö° AiTM Attacks\", ThreatType = \"AiTM\"\n| project StatusLabel, ThreatType, TotalIncidents, ActiveIncidents, ClosedIncidents, HighSeverity, TotalAlerts",
              "size": 4,
              "title": "‚ö° AiTM Attack Incidents (Tagged: AiTM)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "StatusLabel", "formatter": 1 },
                "leftContent": { "columnMatch": "TotalIncidents", "formatter": 12, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                "secondaryContent": { "columnMatch": "ActiveIncidents", "formatter": 1 }
              },
              "exportedParameters": [
                {
                  "fieldName": "ThreatType",
                  "parameterName": "SelectedThreatType",
                  "parameterType": 1
                }
              ]
            },
            "customWidth": "34",
            "name": "query - aitm incidents summary"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// BEC & Fraud Incidents List\nSecurityIncident\n| where TimeGenerated {TimeRange}\n| where Labels has_any (\"BEC\", \"bec\", \"Business Email Compromise\", \"fraud\", \"invoice\", \"payment\", \"wire transfer\")\n    or Title has_any (\"BEC\", \"Business Email Compromise\", \"invoice fraud\", \"payment fraud\", \"wire transfer\", \"vendor fraud\", \"impersonation\")\n| extend TagList = Labels\n| extend IncidentSeverity = case(\n    Severity == \"High\", \"üî¥ High\",\n    Severity == \"Medium\", \"üü† Medium\",\n    Severity == \"Low\", \"üü° Low\",\n    \"‚ö™ Informational\")\n| extend IncidentStatus = case(\n    Status == \"Active\" or Status == \"New\", \"üî• Active\",\n    Status == \"Closed\", \"‚úÖ Closed\",\n    \"üîÑ In Progress\")\n| extend OwnerName = tostring(Owner.assignedTo)\n| extend AlertCount = array_length(AlertIds)\n| project TimeGenerated, IncidentNumber, IncidentSeverity, IncidentStatus, Title, TagList, OwnerName, Classification, AlertCount, IncidentUrl\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üí∞ BEC & Fraud Incidents",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "IncidentUrl", "formatter": 7, "formatOptions": { "linkTarget": "Url", "linkLabel": "Open Incident" } },
                  { "columnMatch": "AlertCount", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedThreatType",
              "comparison": "isEqualTo",
              "value": "BEC"
            },
            "name": "query - bec incidents list"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Credential Phishing Incidents List\nSecurityIncident\n| where TimeGenerated {TimeRange}\n| where Labels has_any (\"Credential\", \"credential\", \"Phish\", \"phish\", \"password\", \"credential theft\", \"credential access\")\n    or Title has_any (\"credential phish\", \"credential theft\", \"password\", \"phishing\", \"credential access\", \"stolen credential\")\n| extend TagList = Labels\n| extend IncidentSeverity = case(\n    Severity == \"High\", \"üî¥ High\",\n    Severity == \"Medium\", \"üü† Medium\",\n    Severity == \"Low\", \"üü° Low\",\n    \"‚ö™ Informational\")\n| extend IncidentStatus = case(\n    Status == \"Active\" or Status == \"New\", \"üî• Active\",\n    Status == \"Closed\", \"‚úÖ Closed\",\n    \"üîÑ In Progress\")\n| extend OwnerName = tostring(Owner.assignedTo)\n| extend AlertCount = array_length(AlertIds)\n| project TimeGenerated, IncidentNumber, IncidentSeverity, IncidentStatus, Title, TagList, OwnerName, Classification, AlertCount, IncidentUrl\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üîê Credential Phishing Incidents",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "IncidentUrl", "formatter": 7, "formatOptions": { "linkTarget": "Url", "linkLabel": "Open Incident" } },
                  { "columnMatch": "AlertCount", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedThreatType",
              "comparison": "isEqualTo",
              "value": "Phishing"
            },
            "name": "query - phishing incidents list"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AiTM Attack Incidents List (Based on Defender XDR Tag)\nSecurityIncident\n| where TimeGenerated {TimeRange}\n| where Labels has \"AiTM\"\n| extend TagList = Labels\n| extend IncidentSeverity = case(\n    Severity == \"High\", \"üî¥ High\",\n    Severity == \"Medium\", \"üü† Medium\",\n    Severity == \"Low\", \"üü° Low\",\n    \"‚ö™ Informational\")\n| extend IncidentStatus = case(\n    Status == \"Active\" or Status == \"New\", \"üî• Active\",\n    Status == \"Closed\", \"‚úÖ Closed\",\n    \"üîÑ In Progress\")\n| extend OwnerName = tostring(Owner.assignedTo)\n| extend AlertCount = array_length(AlertIds)\n| project TimeGenerated, IncidentNumber, IncidentSeverity, IncidentStatus, Title, TagList, OwnerName, Classification, AlertCount, IncidentUrl\n| order by TimeGenerated desc",
              "size": 0,
              "title": "‚ö° AiTM Attack Incidents (Tagged: AiTM)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "IncidentUrl", "formatter": 7, "formatOptions": { "linkTarget": "Url", "linkLabel": "Open Incident" } },
                  { "columnMatch": "AlertCount", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedThreatType",
              "comparison": "isEqualTo",
              "value": "AiTM"
            },
            "name": "query - aitm incidents list"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// BEC & Fraud - Email Events Analysis\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| where EmailActionPolicy has_any (\"impersonation\", \"spoof\", \"Anti-phishing\", \"BEC\")\n    or DetectionMethods has_any (\"impersonation\", \"spoof\", \"BEC\", \"domain impersonation\", \"user impersonation\")\n    or Subject has_any (\"invoice\", \"payment\", \"wire transfer\", \"bank\", \"urgent\", \"ACH\", \"vendor change\", \"account update\", \"payroll\")\n| extend ThreatIndicator = case(\n    DetectionMethods has \"BEC\", \"üî¥ BEC Detected\",\n    EmailActionPolicy has \"impersonation\", \"üî¥ Impersonation Policy\",\n    DetectionMethods has \"impersonation\", \"üü† Impersonation Detected\",\n    DetectionMethods has \"spoof\", \"üü† Spoofing Detected\",\n    Subject has_any (\"invoice\", \"payment\", \"wire\"), \"üü° Financial Keywords\",\n    \"‚ö™ Other\")\n| extend DeliveryStatus = case(\n    DeliveryAction == \"Delivered\", \"‚ö†Ô∏è DELIVERED\",\n    DeliveryAction == \"Blocked\", \"‚úÖ Blocked\",\n    DeliveryAction == \"Quarantined\", \"üü° Quarantined\",\n    \"‚ùì Unknown\")\n| project TimeGenerated, ThreatIndicator, DeliveryStatus, SenderDisplayName, SenderFromAddress, SenderFromDomain, RecipientEmailAddress, Subject, DetectionMethods, EmailActionPolicy, NetworkMessageId\n| order by TimeGenerated desc\n| take 100",
              "size": 0,
              "title": "üí∞ BEC & Fraud - Email Events (Click for Details)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "AlertId", "formatter": 5 }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedThreatType",
              "comparison": "isEqualTo",
              "value": "BEC"
            },
            "name": "query - bec detailed events"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// BEC & Fraud - Detailed Alert Events\nlet BECIncidents = SecurityIncident\n| where TimeGenerated {TimeRange}\n| where Labels has_any (\"BEC\", \"bec\", \"Business Email Compromise\", \"fraud\", \"invoice\", \"payment\", \"wire transfer\")\n    or Title has_any (\"BEC\", \"Business Email Compromise\", \"invoice fraud\", \"payment fraud\", \"wire transfer\", \"vendor fraud\", \"impersonation\")\n| extend AlertIdList = AlertIds;\nlet BECAlertIds = BECIncidents | mv-expand AlertId = AlertIdList | summarize make_set(tostring(AlertId));\nlet BECAlerts = AlertInfo\n| where TimeGenerated {TimeRange}\n| where AlertId in (BECAlertIds)\n    or Title has_any (\"BEC\", \"Business Email Compromise\", \"invoice\", \"payment\", \"impersonation\", \"fraud\", \"wire transfer\", \"executive\", \"vendor\");\nBECAlerts\n| join kind=leftouter (\n    AlertEvidence\n    | where TimeGenerated {TimeRange}\n    | summarize \n        Users = make_set(AccountUpn, 5),\n        IPs = make_set(RemoteIP, 5),\n        Emails = make_set(EmailSubject, 5),\n        Devices = make_set(DeviceName, 5)\n        by AlertId\n) on AlertId\n| extend SeverityIcon = case(\n    Severity == \"High\", \"üî¥\",\n    Severity == \"Medium\", \"üü†\",\n    Severity == \"Low\", \"üü°\",\n    \"‚ö™\")\n| project TimeGenerated, strcat(SeverityIcon, \" \", Severity), Title, Category, Users, IPs, Emails, Devices, ServiceSource, AlertId\n| order by TimeGenerated desc\n| take 100",
              "size": 0,
              "title": "üí∞ BEC & Fraud - Detailed Alert Events",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "AlertId", "formatter": 5 }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedThreatType",
              "comparison": "isEqualTo",
              "value": "BEC"
            },
            "name": "query - bec alert events"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// ‚ö†Ô∏è Malicious URL Clicks - NOT BLOCKED (Requires Investigation)\nUrlClickEvents\n| where TimeGenerated {TimeRange}\n| where IsClickedThrough == true\n| where ThreatTypes has_any (\"Phish\", \"Malware\") or UrlChain has_any (\"login\", \"signin\", \"verify\", \"update\", \"secure\", \"account\")\n| extend ClickRisk = case(\n    ThreatTypes has \"Malware\", \"üî¥ CRITICAL - Malware URL Clicked\",\n    ThreatTypes has \"Phish\", \"üî¥ CRITICAL - Phish URL Clicked\",\n    \"üü† HIGH - Suspicious URL Clicked\")\n| extend InvestigationNotes = case(\n    ThreatTypes has \"Malware\", \"Check endpoint for compromise, run AV scan\",\n    ThreatTypes has \"Phish\", \"Check if credentials were entered, reset password if needed\",\n    \"Review URL destination and user activity\")\n| project TimeGenerated, ClickRisk, AccountUpn, Url, ThreatTypes, ActionType, InvestigationNotes, UrlChain, NetworkMessageId\n| order by TimeGenerated desc\n| take 100",
              "size": 0,
              "title": "üö® CRITICAL: Malicious URLs Clicked Through (NOT BLOCKED)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Delivered", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedThreatType",
              "comparison": "isEqualTo",
              "value": "BEC"
            },
            "name": "query - bec email events"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Credential Phishing - Email Events Analysis\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| where ThreatTypes has \"Phish\"\n    or DetectionMethods has_any (\"URL detonation\", \"phish\", \"credential\")\n    or Subject has_any (\"password\", \"verify\", \"confirm\", \"suspended\", \"expire\", \"update account\", \"security alert\")\n| extend ThreatIndicator = case(\n    ThreatTypes has \"Phish\", \"üî¥ Phishing Detected\",\n    DetectionMethods has \"URL detonation\", \"üî¥ Malicious URL\",\n    DetectionMethods has \"credential\", \"üü† Credential Theft\",\n    Subject has_any (\"password\", \"verify\", \"suspended\"), \"üü° Suspicious Keywords\",\n    \"‚ö™ Other\")\n| extend DeliveryStatus = case(\n    DeliveryAction == \"Delivered\", \"‚ö†Ô∏è DELIVERED\",\n    DeliveryAction == \"Blocked\", \"‚úÖ Blocked\",\n    DeliveryAction == \"Quarantined\", \"üü° Quarantined\",\n    \"‚ùì Unknown\")\n| project TimeGenerated, ThreatIndicator, DeliveryStatus, SenderDisplayName, SenderFromAddress, SenderFromDomain, RecipientEmailAddress, Subject, ThreatTypes, DetectionMethods, NetworkMessageId\n| order by TimeGenerated desc\n| take 100",
              "size": 0,
              "title": "üîê Credential Phishing - Email Events (Click for Details)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "AlertId", "formatter": 5 }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedThreatType",
              "comparison": "isEqualTo",
              "value": "Phishing"
            },
            "name": "query - phishing detailed events"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Credential Phishing - Detailed Alert Events\nlet PhishIncidents = SecurityIncident\n| where TimeGenerated {TimeRange}\n| where Labels has_any (\"Credential\", \"credential\", \"Phish\", \"phish\", \"password\", \"credential theft\", \"credential access\")\n    or Title has_any (\"credential phish\", \"credential theft\", \"password\", \"phishing\", \"credential access\", \"stolen credential\")\n| extend AlertIdList = AlertIds;\nlet PhishAlertIds = PhishIncidents | mv-expand AlertId = AlertIdList | summarize make_set(tostring(AlertId));\nlet PhishAlerts = AlertInfo\n| where TimeGenerated {TimeRange}\n| where AlertId in (PhishAlertIds)\n    or Title has_any (\"phish\", \"credential\", \"password\", \"login\", \"sign-in\", \"authentication\", \"harvest\", \"stolen\");\nPhishAlerts\n| join kind=leftouter (\n    AlertEvidence\n    | where TimeGenerated {TimeRange}\n    | summarize \n        Users = make_set(AccountUpn, 5),\n        IPs = make_set(RemoteIP, 5),\n        URLs = make_set(RemoteUrl, 5),\n        Emails = make_set(EmailSubject, 5)\n        by AlertId\n) on AlertId\n| extend SeverityIcon = case(\n    Severity == \"High\", \"üî¥\",\n    Severity == \"Medium\", \"üü†\",\n    Severity == \"Low\", \"üü°\",\n    \"‚ö™\")\n| project TimeGenerated, strcat(SeverityIcon, \" \", Severity), Title, Category, Users, IPs, URLs, Emails, ServiceSource, AlertId\n| order by TimeGenerated desc\n| take 100",
              "size": 0,
              "title": "üîê Credential Phishing - Detailed Alert Events",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "AlertId", "formatter": 5 }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedThreatType",
              "comparison": "isEqualTo",
              "value": "Phishing"
            },
            "name": "query - phishing alert events"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// ‚ö†Ô∏è Phishing URL Clicks - Tracking User Clicks\nUrlClickEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has \"Phish\" or ActionType has_any (\"ClickBlocked\", \"ClickAllowed\")\n| extend ClickRisk = case(\n    IsClickedThrough == true and ThreatTypes has \"Phish\", \"üî¥ CRITICAL - Phish URL Clicked\",\n    IsClickedThrough == true, \"üü† HIGH - Suspicious URL Clicked\",\n    ActionType == \"ClickBlocked\", \"‚úÖ Blocked by Safe Links\",\n    \"üü° Review\")\n| extend InvestigationRequired = case(\n    IsClickedThrough == true and ThreatTypes has \"Phish\", \"YES - Check if credentials entered, reset password\",\n    IsClickedThrough == true, \"YES - Review user activity\",\n    \"No - Click was blocked\")\n| project TimeGenerated, ClickRisk, AccountUpn, Url, ThreatTypes, ActionType, IsClickedThrough, InvestigationRequired, NetworkMessageId\n| order by case(IsClickedThrough == true, 0, 1) asc, TimeGenerated desc\n| take 100",
              "size": 0,
              "title": "üîó Phishing URL Clicks (‚ö†Ô∏è Unblocked Clicks Need Investigation)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "ClickedThrough", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedThreatType",
              "comparison": "isEqualTo",
              "value": "Phishing"
            },
            "name": "query - phishing email url events"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AiTM Attack Detailed Events\nlet AiTMIncidents = SecurityIncident\n| where TimeGenerated {TimeRange}\n| where Labels has_any (\"AiTM\", \"aitm\", \"Adversary-in-the-Middle\", \"MFA bypass\", \"token theft\", \"session hijack\")\n    or Title has_any (\"AiTM\", \"adversary in the middle\", \"MFA bypass\", \"token theft\", \"session hijack\")\n| extend AlertIdList = AlertIds;\nlet AiTMAlertIds = AiTMIncidents | mv-expand AlertId = AlertIdList | summarize make_set(tostring(AlertId));\nAlertInfo\n| where TimeGenerated {TimeRange}\n| where AlertId in (AiTMAlertIds)\n| join kind=leftouter (\n    AlertEvidence\n    | where TimeGenerated {TimeRange}\n    | summarize \n        Users = make_set(AccountUpn, 5),\n        IPs = make_set(RemoteIP, 5),\n        URLs = make_set(RemoteUrl, 5),\n        Devices = make_set(DeviceName, 3)\n        by AlertId\n) on AlertId\n| extend SeverityIcon = case(\n    Severity == \"High\", \"üî¥\",\n    Severity == \"Medium\", \"üü†\",\n    Severity == \"Low\", \"üü°\",\n    \"‚ö™\")\n| project TimeGenerated, strcat(SeverityIcon, \" \", Severity), Title, Category, Users, IPs, URLs, Devices, ServiceSource, AlertId\n| order by TimeGenerated desc\n| take 100",
              "size": 0,
              "title": "‚ö° AiTM Attack - Detailed Alert Events",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "AlertId", "formatter": 5 }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedThreatType",
              "comparison": "isEqualTo",
              "value": "AiTM"
            },
            "name": "query - aitm detailed events"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AiTM Sign-in Correlation\nlet AiTMKeywords = dynamic([\"AiTM\", \"adversary\", \"middle\", \"proxy\", \"evilginx\", \"modlishka\", \"muraena\"]);\nlet SuspiciousSignIns = union SigninLogs, AADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where RiskLevelDuringSignIn in (\"medium\", \"high\")\n    or RiskEventTypes has_any (\"unfamiliarFeatures\", \"anonymizedIPAddress\", \"maliciousIPAddress\", \"suspiciousInboxForwarding\")\n    or UserAgent has_any (\"python\", \"curl\", \"wget\", \"httpx\")\n| extend AiTMIndicator = case(\n    RiskEventTypes has \"anomalousToken\", \"üî¥ Token Anomaly\",\n    UserAgent has_any (\"python\", \"curl\"), \"üü† Automation Tool\",\n    RiskLevelDuringSignIn == \"high\", \"üü° High Risk Sign-in\",\n    \"‚ö™ Medium Risk\")\n| project TimeGenerated, UserPrincipalName, AiTMIndicator, RiskLevelDuringSignIn, IPAddress, Location, UserAgent, AppDisplayName, ResultType;\nlet PhishEmailRecipients = EmailEvents\n| where TimeGenerated {TimeRange}\n| where ThreatTypes has \"Phish\"\n| where DeliveryAction == \"Delivered\"\n| distinct RecipientEmailAddress;\nSuspiciousSignIns\n| where UserPrincipalName in (PhishEmailRecipients)\n| summarize \n    RiskySignIns = count(),\n    UniqueIPs = dcount(IPAddress),\n    Locations = make_set(Location, 5),\n    Apps = make_set(AppDisplayName, 5),\n    Indicators = make_set(AiTMIndicator, 3)\n    by UserPrincipalName\n| extend CompromiseRisk = case(\n    RiskySignIns > 5, \"üî¥ Likely Compromised\",\n    RiskySignIns > 2, \"üü† High Risk\",\n    \"üü° Monitor\")\n| order by RiskySignIns desc\n| project CompromiseRisk, UserPrincipalName, RiskySignIns, UniqueIPs, Locations, Apps, Indicators",
              "size": 0,
              "title": "üîê AiTM - Phishing to Sign-in Correlation",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "RiskySignIns", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedThreatType",
              "comparison": "isEqualTo",
              "value": "AiTM"
            },
            "name": "query - aitm signin correlation"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Tagged Incidents Timeline\nSecurityIncident\n| where TimeGenerated {TimeRange}\n| where Labels has_any (\"BEC\", \"bec\", \"Business Email Compromise\", \"Credential\", \"credential\", \"Phish\", \"phish\", \"AiTM\", \"aitm\", \"Adversary-in-the-Middle\", \"MFA bypass\", \"token theft\", \"fraud\")\n    or Title has_any (\"BEC\", \"credential phish\", \"AiTM\", \"adversary in the middle\", \"MFA bypass\", \"payment fraud\")\n| extend IncidentType = case(\n    Labels has_any (\"AiTM\", \"aitm\", \"MFA bypass\", \"token theft\") or Title has_any (\"AiTM\", \"MFA bypass\"), \"AiTM\",\n    Labels has_any (\"BEC\", \"bec\", \"fraud\", \"invoice\") or Title has_any (\"BEC\", \"fraud\"), \"BEC/Fraud\",\n    Labels has_any (\"Credential\", \"credential\", \"Phish\", \"phish\") or Title has_any (\"credential\", \"phish\"), \"Credential Phishing\",\n    \"Other\")\n| summarize Count = count() by IncidentType, bin(TimeGenerated, 1d)\n| order by TimeGenerated asc",
              "size": 0,
              "title": "üìà Tagged Incidents Timeline",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "areachart",
              "chartSettings": {
                "seriesLabelSettings": [
                  { "seriesName": "BEC/Fraud", "color": "redBright" },
                  { "seriesName": "Credential Phishing", "color": "orange" },
                  { "seriesName": "AiTM", "color": "purple" }
                ]
              }
            },
            "name": "query - tagged incidents timeline"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "XDR"
      },
      "name": "group - xdr"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## ‚öôÔ∏è Email Security Configuration Analysis\n\nReview your email authentication configuration (DMARC, DKIM, SPF) and identify potential improvements. Proper configuration is critical for preventing spoofing and ensuring email deliverability.\n\n| Protocol | Purpose | Recommendation |\n|----------|---------|----------------|\n| **SPF** | Authorizes sending servers | Publish strict `-all` policy |\n| **DKIM** | Cryptographic signature | Enable for all domains |\n| **DMARC** | Policy enforcement | `p=reject` for full protection |"
            },
            "name": "text - config header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DMARC/DKIM/SPF Authentication Results Overview\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| extend AuthDetails = parse_json(AuthenticationDetails)\n| extend \n    SPFResult = tostring(AuthDetails.SPF),\n    DKIMResult = tostring(AuthDetails.DKIM),\n    DMARCResult = tostring(AuthDetails.DMARC),\n    CompAuth = tostring(AuthDetails.CompAuth)\n| summarize \n    TotalEmails = count(),\n    SPF_Pass = countif(SPFResult == \"pass\"),\n    SPF_Fail = countif(SPFResult in (\"fail\", \"hardfail\", \"softfail\")),\n    DKIM_Pass = countif(DKIMResult == \"pass\"),\n    DKIM_Fail = countif(DKIMResult == \"fail\"),\n    DMARC_Pass = countif(DMARCResult == \"pass\"),\n    DMARC_Fail = countif(DMARCResult == \"fail\")\n| extend \n    SPF_Rate = round(toreal(SPF_Pass) / TotalEmails * 100, 1),\n    DKIM_Rate = round(toreal(DKIM_Pass) / TotalEmails * 100, 1),\n    DMARC_Rate = round(toreal(DMARC_Pass) / TotalEmails * 100, 1)\n| project \n    Metric = pack_array(\"üìß Total Inbound\", \"‚úÖ SPF Pass Rate\", \"‚úÖ DKIM Pass Rate\", \"‚úÖ DMARC Pass Rate\", \"‚ùå SPF Failures\", \"‚ùå DKIM Failures\", \"‚ùå DMARC Failures\"),\n    Value = pack_array(TotalEmails, SPF_Rate, DKIM_Rate, DMARC_Rate, SPF_Fail, DKIM_Fail, DMARC_Fail)\n| mv-expand Metric to typeof(string), Value to typeof(long)",
              "size": 4,
              "title": "üìä Email Authentication Overview",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "auto" } }
              }
            },
            "name": "query - auth overview"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Authentication Failures by Domain - Potential Spoofing\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| extend AuthDetails = parse_json(AuthenticationDetails)\n| extend \n    SPFResult = tostring(AuthDetails.SPF),\n    DKIMResult = tostring(AuthDetails.DKIM),\n    DMARCResult = tostring(AuthDetails.DMARC)\n| where SPFResult in (\"fail\", \"hardfail\", \"softfail\") or DKIMResult == \"fail\" or DMARCResult == \"fail\"\n| summarize \n    FailedEmails = count(),\n    SPFFails = countif(SPFResult in (\"fail\", \"hardfail\", \"softfail\")),\n    DKIMFails = countif(DKIMResult == \"fail\"),\n    DMARCFails = countif(DMARCResult == \"fail\"),\n    DeliveredCount = countif(DeliveryAction == \"Delivered\"),\n    UniqueSenders = dcount(SenderFromAddress)\n    by SenderFromDomain\n| extend RiskLevel = case(\n    DMARCFails > 50 and DeliveredCount > 10, \"üî¥ Critical - Spoofing Risk\",\n    DMARCFails > 20, \"üü† High - Missing DMARC\",\n    SPFFails > 50, \"üü° Medium - SPF Issues\",\n    \"üü¢ Low\")\n| order by FailedEmails desc\n| take 20\n| project RiskLevel, SenderFromDomain, FailedEmails, SPFFails, DKIMFails, DMARCFails, DeliveredCount, UniqueSenders",
              "size": 0,
              "title": "‚ö†Ô∏è Domains with Authentication Failures (Potential Spoofing)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "FailedEmails", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                  { "columnMatch": "DeliveredCount", "formatter": 4, "formatOptions": { "palette": "orange" } }
                ]
              }
            },
            "name": "query - auth failures by domain"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Your Organization's Outbound Authentication\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Outbound\"\n| extend AuthDetails = parse_json(AuthenticationDetails)\n| extend \n    SPFResult = tostring(AuthDetails.SPF),\n    DKIMResult = tostring(AuthDetails.DKIM)\n| summarize \n    TotalOutbound = count(),\n    SPFPass = countif(SPFResult == \"pass\"),\n    DKIMPass = countif(DKIMResult == \"pass\"),\n    DKIMSigned = countif(isnotempty(DKIMResult) and DKIMResult != \"none\")\n    by SenderFromDomain\n| extend \n    SPFRate = round(toreal(SPFPass) / TotalOutbound * 100, 1),\n    DKIMRate = round(toreal(DKIMPass) / TotalOutbound * 100, 1)\n| extend ConfigStatus = case(\n    SPFRate == 100 and DKIMRate == 100, \"‚úÖ Fully Configured\",\n    SPFRate == 100 and DKIMRate < 100, \"‚ö†Ô∏è DKIM Not Enabled\",\n    SPFRate < 100, \"‚ùå SPF Issues\",\n    \"üîç Review Needed\")\n| order by TotalOutbound desc\n| project ConfigStatus, SenderFromDomain, TotalOutbound, SPFRate, DKIMRate",
              "size": 0,
              "title": "üì§ Your Outbound Domain Authentication Status",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "SPFRate", "formatter": 4, "formatOptions": { "palette": "greenRed" } },
                  { "columnMatch": "DKIMRate", "formatter": 4, "formatOptions": { "palette": "greenRed" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - outbound auth"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DMARC Policy Distribution - Inbound\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| extend AuthDetails = parse_json(AuthenticationDetails)\n| extend DMARCResult = tostring(AuthDetails.DMARC)\n| summarize Count = count() by DMARCResult\n| extend Result = case(\n    DMARCResult == \"pass\", \"‚úÖ Pass\",\n    DMARCResult == \"fail\", \"‚ùå Fail\",\n    DMARCResult == \"none\", \"‚ö†Ô∏è No DMARC\",\n    isempty(DMARCResult), \"‚ùì Unknown\",\n    DMARCResult)\n| project Result, Count\n| order by Count desc",
              "size": 2,
              "title": "üìä DMARC Results Distribution",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "piechart"
            },
            "customWidth": "25",
            "name": "query - dmarc distribution"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// SPF Results Distribution\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| extend AuthDetails = parse_json(AuthenticationDetails)\n| extend SPFResult = tostring(AuthDetails.SPF)\n| summarize Count = count() by SPFResult\n| extend Result = case(\n    SPFResult == \"pass\", \"‚úÖ Pass\",\n    SPFResult in (\"fail\", \"hardfail\"), \"‚ùå Hard Fail\",\n    SPFResult == \"softfail\", \"‚ö†Ô∏è Soft Fail\",\n    SPFResult == \"none\", \"‚ùì No SPF\",\n    isempty(SPFResult), \"‚ùì Unknown\",\n    SPFResult)\n| project Result, Count\n| order by Count desc",
              "size": 2,
              "title": "üìä SPF Results Distribution",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "piechart"
            },
            "customWidth": "25",
            "name": "query - spf distribution"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n## ÔøΩ Configuration Analyzer - Policy Assessment\n\n**Purpose:** Analyze your Microsoft Defender for Office 365 configuration based on observed email flow data. This section helps identify gaps in your security policies and provides actionable recommendations.\n\n| Policy Area | What We Check | Data Source |\n|-------------|---------------|-------------|\n| **Preset Security Policies** | Standard vs Strict coverage | EmailEvents actions |\n| **Anti-Phishing** | Impersonation protection activity | Detection methods |\n| **Anti-Spam** | Spam filtering effectiveness | Threat types, actions |\n| **Anti-Malware** | Malware detection and blocking | Safe Attachments |\n| **Safe Attachments** | Attachment scanning activity | Detonation events |\n| **Safe Links** | URL protection clicks | UrlClickEvents |\n| **Email Authentication** | SPF/DKIM/DMARC enforcement | Authentication details |\n| **Quarantine** | Quarantine policy usage | Post-delivery events |\n| **Tenant Allow/Block** | Override effectiveness | Delivery overrides |"
            },
            "name": "text - config analyzer header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Preset Security Policies - Coverage Analysis\nlet TotalInbound = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailDirection == \"Inbound\" | count);\nlet StandardProtected = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailDirection == \"Inbound\" | where isnotempty(EmailActionPolicy) | where EmailActionPolicy has_any (\"Default\", \"Standard\") | count);\nlet StrictProtected = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailDirection == \"Inbound\" | where isnotempty(EmailActionPolicy) | where EmailActionPolicy has \"Strict\" | count);\nlet CustomPolicy = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailDirection == \"Inbound\" | where isnotempty(EmailActionPolicy) | where not(EmailActionPolicy has_any (\"Default\", \"Standard\", \"Strict\")) | count);\nlet NoPolicy = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailDirection == \"Inbound\" | where isempty(EmailActionPolicy) or EmailActionPolicy == \"\" | count);\nprint PolicyType = dynamic([\"üõ°Ô∏è Strict Preset\", \"üîµ Standard Preset\", \"‚öôÔ∏è Custom Policies\", \"‚ö†Ô∏è No Policy Detected\"]),\n      Count = pack_array(StrictProtected, StandardProtected, CustomPolicy, NoPolicy),\n      Recommendation = dynamic([\"‚úÖ Best Protection\", \"‚úÖ Good Protection\", \"üîç Review custom settings\", \"‚ùå Apply Preset Policies\"])\n| mv-expand PolicyType to typeof(string), Count to typeof(long), Recommendation to typeof(string)",
              "size": 4,
              "title": "üõ°Ô∏è Preset Security Policies - Coverage Overview",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "PolicyType", "formatter": 1 },
                "leftContent": { "columnMatch": "Count", "formatter": 12, "formatOptions": { "palette": "auto" } },
                "secondaryContent": { "columnMatch": "Recommendation", "formatter": 1 }
              }
            },
            "name": "query - preset policies overview"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üìã MDO Policy Configuration Checklist"
            },
            "name": "text - policy checklist header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Anti-Phishing Policy - Activity Check\nlet AntiPhishDetections = EmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| where DetectionMethods has_any (\"Impersonation\", \"Domain impersonation\", \"User impersonation\", \"Spoof\", \"DMARC\") \n    or EmailActionPolicy has_any (\"impersonation\", \"Anti-phish\", \"phish\")\n| summarize \n    TotalDetections = count(),\n    UserImpersonation = countif(DetectionMethods has \"User impersonation\"),\n    DomainImpersonation = countif(DetectionMethods has \"Domain impersonation\"),\n    SpoofDetections = countif(DetectionMethods has \"Spoof\"),\n    Blocked = countif(DeliveryAction in (\"Blocked\", \"Quarantined\")),\n    Delivered = countif(DeliveryAction == \"Delivered\");\nAntiPhishDetections\n| extend PolicyStatus = case(\n    TotalDetections > 0 and Blocked > Delivered, \"‚úÖ Anti-Phishing Active & Blocking\",\n    TotalDetections > 0, \"üü° Detections but some delivered - Review actions\",\n    \"‚ö†Ô∏è No detections - Verify policy is enabled\")\n| project PolicyStatus, TotalDetections, UserImpersonation, DomainImpersonation, SpoofDetections, Blocked, Delivered",
              "size": 0,
              "title": "üé£ Anti-Phishing Policy Status",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "query - antiphishing status"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Anti-Spam Policy - Activity Check\nlet AntiSpamActivity = EmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| summarize \n    TotalInbound = count(),\n    SpamDetected = countif(ThreatTypes has \"Spam\"),\n    HighConfSpam = countif(ThreatTypes has \"Spam\" and DeliveryAction in (\"Blocked\", \"Quarantined\")),\n    PhishDetected = countif(ThreatTypes has \"Phish\"),\n    HighConfPhish = countif(ThreatTypes has \"Phish\" and DeliveryAction in (\"Blocked\", \"Quarantined\")),\n    BulkMail = countif(BulkComplaintLevel >= 7),\n    JunkFolder = countif(DeliveryLocation == \"Junk folder\"),\n    Quarantined = countif(DeliveryAction == \"Quarantined\");\nAntiSpamActivity\n| extend PolicyStatus = case(\n    HighConfPhish > 0 or Quarantined > 0, \"‚úÖ Anti-Spam Active\",\n    SpamDetected > 0, \"üü° Detecting but check actions\",\n    \"‚ö†Ô∏è Low activity - Review configuration\")\n| project PolicyStatus, TotalInbound, SpamDetected, HighConfSpam, PhishDetected, HighConfPhish, BulkMail, JunkFolder, Quarantined",
              "size": 0,
              "title": "üìß Anti-Spam Policy Status",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "query - antispam status"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Anti-Malware & Safe Attachments - Activity Check\nlet MalwareActivity = EmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| summarize \n    TotalInbound = count(),\n    MalwareDetected = countif(ThreatTypes has \"Malware\"),\n    MalwareBlocked = countif(ThreatTypes has \"Malware\" and DeliveryAction in (\"Blocked\", \"Quarantined\")),\n    MalwareDelivered = countif(ThreatTypes has \"Malware\" and DeliveryAction == \"Delivered\"),\n    SafeAttachDetections = countif(DetectionMethods has_any (\"File detonation\", \"Safe Attachments\", \"File reputation\")),\n    WithAttachments = countif(AttachmentCount > 0),\n    ZAPMalware = countif(LatestDeliveryAction has \"ZAP\" and ThreatTypes has \"Malware\");\nMalwareActivity\n| extend PolicyStatus = case(\n    MalwareBlocked > 0 and MalwareDelivered == 0, \"‚úÖ Anti-Malware Blocking All\",\n    MalwareDetected > 0 and MalwareBlocked > MalwareDelivered, \"üü° Most blocked, some delivered\",\n    MalwareDelivered > 0, \"‚ùå Malware delivered - Review policy\",\n    SafeAttachDetections > 0, \"‚úÖ Safe Attachments Active\",\n    \"‚ö†Ô∏è No detections - Verify configuration\")\n| project PolicyStatus, MalwareDetected, MalwareBlocked, MalwareDelivered, SafeAttachDetections, WithAttachments, ZAPMalware",
              "size": 0,
              "title": "ü¶† Anti-Malware & Safe Attachments Status",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "query - antimalware status"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Safe Links - Activity Check\nlet SafeLinksActivity = UrlClickEvents\n| where TimeGenerated {TimeRange}\n| summarize \n    TotalClicks = count(),\n    ClicksBlocked = countif(ActionType has \"Blocked\" or IsClickedThrough == false),\n    ClicksAllowed = countif(ActionType has \"Allowed\" or IsClickedThrough == true),\n    ThreatClicks = countif(isnotempty(ThreatTypes)),\n    PhishClicks = countif(ThreatTypes has \"Phish\"),\n    MalwareClicks = countif(ThreatTypes has \"Malware\"),\n    ClickedThrough = countif(IsClickedThrough == true and isnotempty(ThreatTypes)),\n    UniqueUsers = dcount(AccountUpn);\nSafeLinksActivity\n| extend PolicyStatus = case(\n    TotalClicks > 0 and ClicksBlocked > 0, \"‚úÖ Safe Links Active & Blocking\",\n    TotalClicks > 0, \"üü° Safe Links Active - Review blocks\",\n    \"‚ö†Ô∏è No Safe Links data - Verify configuration\")\n| extend RiskIndicator = case(\n    ClickedThrough > 0, \"üî¥ Users clicked through blocked URLs\",\n    ThreatClicks > 0 and ClicksBlocked == ThreatClicks, \"‚úÖ All threats blocked\",\n    \"üü¢ Normal\")\n| project PolicyStatus, RiskIndicator, TotalClicks, ClicksBlocked, ThreatClicks, PhishClicks, MalwareClicks, ClickedThrough, UniqueUsers",
              "size": 0,
              "title": "üîó Safe Links Policy Status",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "query - safelinks status"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üìß Email Authentication Settings"
            },
            "name": "text - email auth header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Email Authentication Enforcement Summary\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| extend AuthDetails = parse_json(AuthenticationDetails)\n| extend \n    SPF = tostring(AuthDetails.SPF),\n    DKIM = tostring(AuthDetails.DKIM),\n    DMARC = tostring(AuthDetails.DMARC),\n    CompAuth = tostring(AuthDetails.CompAuth)\n| summarize \n    Total = count(),\n    SPF_Pass = countif(SPF == \"pass\"),\n    SPF_Fail = countif(SPF in (\"fail\", \"hardfail\", \"softfail\")),\n    DKIM_Pass = countif(DKIM == \"pass\"),\n    DKIM_Fail = countif(DKIM == \"fail\"),\n    DMARC_Pass = countif(DMARC == \"pass\"),\n    DMARC_Fail = countif(DMARC == \"fail\"),\n    DMARC_None = countif(DMARC == \"none\" or isempty(DMARC)),\n    CompAuth_Pass = countif(CompAuth == \"pass\")\n| extend \n    SPF_Rate = round(toreal(SPF_Pass) / Total * 100, 1),\n    DKIM_Rate = round(toreal(DKIM_Pass) / Total * 100, 1),\n    DMARC_Rate = round(toreal(DMARC_Pass) / Total * 100, 1),\n    DMARC_Coverage = round(toreal(Total - DMARC_None) / Total * 100, 1)\n| extend \n    SPF_Status = case(SPF_Rate >= 90, \"‚úÖ Excellent\", SPF_Rate >= 70, \"üü° Good\", \"‚ùå Review\"),\n    DKIM_Status = case(DKIM_Rate >= 80, \"‚úÖ Excellent\", DKIM_Rate >= 60, \"üü° Good\", \"‚ùå Review\"),\n    DMARC_Status = case(DMARC_Rate >= 80, \"‚úÖ Excellent\", DMARC_Rate >= 50, \"üü° Partial\", \"‚ùå Low\")\n| project Total, SPF_Status, strcat(SPF_Rate, \"%\"), DKIM_Status, strcat(DKIM_Rate, \"%\"), DMARC_Status, strcat(DMARC_Rate, \"%\"), strcat(\"Coverage: \", DMARC_Coverage, \"%\")",
              "size": 0,
              "title": "üîê Email Authentication Summary (SPF/DKIM/DMARC)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "name": "query - auth summary"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üöÄ Advanced Delivery & Enhanced Filtering"
            },
            "name": "text - advanced delivery header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Advanced Delivery - SecOps Mailbox & Phish Simulation Check\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| extend IsSecOpsDelivery = (EmailActionPolicy has \"SecOps\")\n| extend IsPhishSim = (EmailActionPolicy has_any (\"Simulation\", \"PhishSimOverride\", \"Attack simulation\"))\n| extend IsThirdPartyFilter = (EmailActionPolicy has_any (\"Enhanced\", \"ThirdParty\", \"Connector\"))\n| extend IsEnhancedFiltering = (EmailActionPolicy has \"Enhanced\" or DetectionMethods has \"Enhanced\")\n| summarize \n    TotalEmails = count(),\n    SecOpsMailbox = countif(IsSecOpsDelivery),\n    PhishSimulations = countif(IsPhishSim),\n    ThirdPartyFiltered = countif(IsThirdPartyFilter),\n    EnhancedFiltering = countif(IsEnhancedFiltering),\n    WithPolicy = countif(isnotempty(EmailActionPolicy))\n| extend AdvancedDeliveryStatus = case(\n    SecOpsMailbox > 0 or PhishSimulations > 0, \"‚úÖ Advanced Delivery Configured\",\n    \"‚ÑπÔ∏è No Advanced Delivery detected\")\n| extend EnhancedFilterStatus = case(\n    EnhancedFiltering > 0, \"‚úÖ Enhanced Filtering Active\",\n    ThirdPartyFiltered > 0, \"üü° Third-party integration detected\",\n    \"‚ÑπÔ∏è No Enhanced Filtering detected\")\n| project AdvancedDeliveryStatus, EnhancedFilterStatus, SecOpsMailbox, PhishSimulations, EnhancedFiltering, ThirdPartyFiltered, WithPolicy",
              "size": 0,
              "title": "üöÄ Advanced Delivery & Enhanced Filtering Status",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "query - advanced delivery"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Quarantine Policy Analysis\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where DeliveryAction == \"Quarantined\"\n| summarize \n    TotalQuarantined = count(),\n    PhishQuarantined = countif(ThreatTypes has \"Phish\"),\n    SpamQuarantined = countif(ThreatTypes has \"Spam\"),\n    MalwareQuarantined = countif(ThreatTypes has \"Malware\"),\n    BulkQuarantined = countif(BulkComplaintLevel >= 7),\n    PolicyQuarantined = countif(isnotempty(EmailActionPolicy)),\n    UniqueRecipients = dcount(RecipientEmailAddress)\n| join kind=leftouter (\n    EmailPostDeliveryEvents\n    | where TimeGenerated {TimeRange}\n    | where ActionType has_any (\"Release\", \"Released\", \"Delete\", \"Deleted\")\n    | summarize \n        Released = countif(ActionType has \"Release\"),\n        Deleted = countif(ActionType has \"Delete\")\n) on $left.TotalQuarantined == $right.Released\n| extend QuarantineStatus = case(\n    TotalQuarantined > 0, \"‚úÖ Quarantine Active\",\n    \"‚ö†Ô∏è No quarantine activity\")\n| project QuarantineStatus, TotalQuarantined, PhishQuarantined, SpamQuarantined, MalwareQuarantined, BulkQuarantined, UniqueRecipients",
              "size": 0,
              "title": "üì¶ Quarantine Policy Status",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "query - quarantine status"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üìã Tenant Allow/Block List Analysis"
            },
            "name": "text - tabl header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Tenant Allow/Block List - Policy Action Analysis\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| where isnotempty(EmailActionPolicy) or (isnotempty(ThreatTypes) and DeliveryAction == \"Delivered\")\n| extend ActionCategory = case(\n    EmailActionPolicy has_any (\"Block\", \"Reject\") and DeliveryAction == \"Delivered\", \"‚ö†Ô∏è Policy Bypass - Delivered despite block policy\",\n    ThreatTypes has \"Phish\" and DeliveryAction == \"Delivered\", \"üî¥ Phish Delivered - Check allows\",\n    ThreatTypes has \"Malware\" and DeliveryAction == \"Delivered\", \"üî¥ Malware Delivered - Check allows\",\n    ThreatTypes has \"Spam\" and DeliveryAction == \"Delivered\", \"üü† Spam Delivered\",\n    DeliveryAction in (\"Blocked\", \"Quarantined\"), \"‚úÖ Properly Blocked/Quarantined\",\n    DeliveryLocation == \"Junk folder\", \"üü° Sent to Junk\",\n    \"üìß Normal Delivery\")\n| where ActionCategory != \"üìß Normal Delivery\"\n| summarize \n    Count = count(),\n    Delivered = countif(DeliveryAction == \"Delivered\"),\n    Blocked = countif(DeliveryAction in (\"Blocked\", \"Quarantined\")),\n    ThreatEmails = countif(isnotempty(ThreatTypes)),\n    Domains = make_set(SenderFromDomain, 10)\n    by ActionCategory\n| extend RiskLevel = case(\n    ActionCategory has \"Malware\" or ActionCategory has \"Phish\", \"üî¥ High - Investigate immediately\",\n    ActionCategory has \"Bypass\", \"üü† Medium - Review policy\",\n    ActionCategory has \"Blocked\", \"‚úÖ Working as expected\",\n    \"üü° Review\")\n| order by Count desc\n| project RiskLevel, ActionCategory, Count, Delivered, Blocked, ThreatEmails, Domains",
              "size": 0,
              "title": "üìã Policy Action & Delivery Analysis",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "blue" } },
                  { "columnMatch": "ThreatEmails", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - tabl analysis"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Threats Delivered Analysis - Requires Investigation\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| where DeliveryAction == \"Delivered\"\n| where isnotempty(ThreatTypes)\n| extend ThreatCategory = case(\n    ThreatTypes has \"Malware\", \"ü¶† Malware\",\n    ThreatTypes has \"Phish\", \"üé£ Phishing\",\n    ThreatTypes has \"Spam\", \"üìß Spam\",\n    \"Other\")\n| summarize \n    ThreatsDelivered = count(),\n    UniqueRecipients = dcount(RecipientEmailAddress),\n    UniqueSenders = dcount(SenderFromAddress),\n    Domains = make_set(SenderFromDomain, 10),\n    Subjects = make_set(Subject, 5)\n    by ThreatCategory\n| extend Risk = case(\n    ThreatCategory has \"Malware\", \"üî¥ CRITICAL - Malware reached mailboxes\",\n    ThreatCategory has \"Phish\", \"üî¥ HIGH - Phishing reached mailboxes\",\n    ThreatsDelivered > 50, \"üü† MEDIUM - High volume spam\",\n    \"üü° LOW\")\n| extend Action = \"Review Tenant Allow/Block List and transport rules\"\n| order by ThreatsDelivered desc\n| project Risk, ThreatCategory, ThreatsDelivered, UniqueRecipients, UniqueSenders, Domains, Action",
              "size": 0,
              "title": "‚ö†Ô∏è Threats Delivered - Requires Investigation",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "ThreatsDelivered", "formatter": 4, "formatOptions": { "palette": "red" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - allow list risk"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üìä Configuration Recommendations Summary"
            },
            "name": "text - recommendations summary header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Configuration Recommendations Generator\nlet TotalInbound = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailDirection == \"Inbound\" | count);\nlet DMARCNone = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailDirection == \"Inbound\" | extend Auth = parse_json(AuthenticationDetails) | where tostring(Auth.DMARC) in (\"none\", \"\") or isempty(tostring(Auth.DMARC)) | count);\nlet ThreatsDelivered = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where DeliveryAction == \"Delivered\" | where isnotempty(ThreatTypes) | count);\nlet ImpersonationCount = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where DetectionMethods has_any (\"impersonation\", \"Impersonation\") | count);\nlet ZAPCount = toscalar(EmailPostDeliveryEvents | where TimeGenerated {TimeRange} | where ActionTrigger == \"ZAP\" | count);\nlet SafeLinksCount = toscalar(UrlClickEvents | where TimeGenerated {TimeRange} | count);\nlet AllowOverrides = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where DeliveryAction == \"Delivered\" and isnotempty(ThreatTypes) | count);\nlet SpoofDelivered = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where DetectionMethods has \"Spoof\" and DeliveryAction == \"Delivered\" | count);\nprint Recommendation = dynamic([\n    \"Enable Strict Preset for executives\",\n    \"Review DMARC policy - many senders have none\",\n    \"Threats delivered - Review blocking policies\",\n    \"Enable/tune Impersonation Protection\",\n    \"Verify ZAP is enabled for all policies\",\n    \"Verify Safe Links is enabled for all users\",\n    \"Review and reduce Allow list entries\",\n    \"Enable Spoof Intelligence\"]),\n    Priority = dynamic([\"üî¥ High\", \"üî¥ High\", \"üî¥ High\", \"üü† Medium\", \"üü† Medium\", \"üü† Medium\", \"üü° Medium\", \"üü° Medium\"]),\n    Finding = pack_array(\n        iff(TotalInbound > 0, \"Preset policies provide consistent protection\", \"N/A\"),\n        iff(DMARCNone > TotalInbound * 0.3, strcat(DMARCNone, \" emails from senders without DMARC\"), \"‚úÖ DMARC coverage acceptable\"),\n        iff(ThreatsDelivered > 0, strcat(ThreatsDelivered, \" threats reached mailboxes\"), \"‚úÖ No threats delivered\"),\n        iff(ImpersonationCount > 0, strcat(ImpersonationCount, \" impersonation attempts detected\"), \"‚ö†Ô∏è Enable to detect BEC\"),\n        iff(ZAPCount > 0, strcat(\"‚úÖ ZAP active - \", ZAPCount, \" actions\"), \"‚ö†Ô∏è No ZAP activity detected\"),\n        iff(SafeLinksCount > 0, strcat(\"‚úÖ Safe Links active - \", SafeLinksCount, \" clicks tracked\"), \"‚ö†Ô∏è No Safe Links data\"),\n        iff(AllowOverrides > 0, strcat(\"‚ùå \", AllowOverrides, \" threats bypassed via allows\"), \"‚úÖ No threat bypasses\"),\n        iff(SpoofDelivered > 0, strcat(\"‚ùå \", SpoofDelivered, \" spoofed emails delivered\"), \"‚úÖ Spoofs blocked\")),\n    ActionLink = dynamic([\n        \"[Configure Preset Policies](https://security.microsoft.com/presetSecurityPolicies)\",\n        \"[Review DMARC Settings](https://security.microsoft.com/dkim)\",\n        \"[Threat Policies](https://security.microsoft.com/threatpolicy)\",\n        \"[Anti-Phishing Policy](https://security.microsoft.com/antiphishing)\",\n        \"[Anti-Malware Policy](https://security.microsoft.com/antimalwarev2)\",\n        \"[Safe Links Policy](https://security.microsoft.com/safelinksv2)\",\n        \"[Tenant Allow/Block List](https://security.microsoft.com/tenantAllowBlockList)\",\n        \"[Spoof Intelligence](https://security.microsoft.com/spoofintelligence)\"])\n| mv-expand Recommendation to typeof(string), Priority to typeof(string), Finding to typeof(string), ActionLink to typeof(string)\n| where Finding !startswith \"‚úÖ\" or Recommendation has \"Preset\"",
              "size": 0,
              "title": "üìä Configuration Recommendations",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "ActionLink", "formatter": 7, "formatOptions": { "linkTarget": "Url", "linkLabel": "Open Config" } }
                ]
              }
            },
            "name": "query - recommendations summary"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n## ÔøΩüìã Best Practices & Configuration Recommendations\n\n### üîê Email Authentication (DMARC/DKIM/SPF)\n\n| Priority | Recommendation | Benefit | Implementation |\n|----------|----------------|---------|----------------|\n| üî¥ **Critical** | Enable DMARC with `p=reject` | Prevents domain spoofing | Add DNS TXT: `_dmarc.domain.com` with `v=DMARC1; p=reject; rua=mailto:dmarc@domain.com` |\n| üî¥ **Critical** | Configure DKIM signing | Ensures email integrity | Enable in Exchange Admin Center > Mail Flow > DKIM |\n| üî¥ **Critical** | Publish SPF with `-all` | Rejects unauthorized senders | DNS TXT: `v=spf1 include:spf.protection.outlook.com -all` |\n| üü† **High** | Enable DMARC reporting | Visibility into failures | Add `rua=mailto:dmarc-reports@domain.com` to DMARC record |\n| üü† **High** | Monitor DMARC aggregate reports | Identify spoofing attempts | Use DMARC analyzer tools (Valimail, dmarcian, etc.) |\n\n### üõ°Ô∏è Microsoft Defender for Office 365 Policies\n\n| Priority | Policy | Recommendation | Risk if Not Configured |\n|----------|--------|----------------|------------------------|\n| üî¥ **Critical** | Safe Attachments | Enable **Block** mode for all users | Malware delivered via attachments |\n| üî¥ **Critical** | Safe Links | Enable URL rewriting + time-of-click verification | Users click malicious links |\n| üî¥ **Critical** | Anti-phishing | Enable impersonation protection for executives | BEC/CEO fraud attacks succeed |\n| üü† **High** | Anti-spam | Set **High confidence phishing** to Quarantine | Phishing emails reach inbox |\n| üü† **High** | Anti-malware | Enable **Zero-hour Auto Purge (ZAP)** | Delayed threats not removed |\n| üü† **High** | Preset Security Policies | Apply **Strict** preset for high-risk users | Inconsistent protection levels |\n| üü° **Medium** | Quarantine policies | Configure end-user spam notifications | Users unaware of quarantined mail |\n| üü° **Medium** | Tenant Allow/Block List | Review and minimize allow entries | Bypass of security controls |\n\n### üéØ Anti-Phishing and Impersonation Protection\n\n| Setting | Recommended Value | Purpose |\n|---------|-------------------|--------|\n| **User impersonation protection** | Enabled for executives, finance, HR | Protects high-value targets from BEC |\n| **Domain impersonation protection** | Enabled for your domains + partners | Prevents domain lookalike attacks |\n| **Mailbox intelligence** | Enabled | Learns user communication patterns |\n| **Spoof intelligence** | Enabled + Review regularly | Identifies spoofed senders |\n| **First contact safety tip** | Enabled | Warns on first-time external senders |\n| **User impersonation safety tip** | Enabled | Alerts on potential impersonation |\n| **Show (?) for unauthenticated senders** | Enabled | Visual indicator for suspicious mail |\n\n### üîí Advanced Configuration\n\n| Priority | Configuration | Details |\n|----------|---------------|--------|\n| üî¥ **Critical** | Enhanced Filtering for Connectors | Enable if using third-party email gateway |\n| üî¥ **Critical** | Disable auto-forwarding to external | Prevent data exfiltration via mail rules |\n| üü† **High** | Priority Account Protection | Mark executives as priority accounts |\n| üü† **High** | Attack Simulation Training | Regular phishing simulations for users |\n| üü† **High** | Report Message add-in | Enable user reporting of suspicious emails |\n| üü° **Medium** | Audit logging | Ensure mailbox audit logging enabled |\n| üü° **Medium** | Unified Audit Log | Retain logs for 90+ days |\n\n### ‚ö†Ô∏è Common Misconfigurations to Avoid\n\n| Misconfiguration | Fix | Risk |\n|--------------------|--------|--------|\n| SPF with `~all` (softfail) | Change to `-all` (hardfail) | Spoofed emails may be delivered |\n| DMARC with `p=none` | Progress to `p=quarantine` then `p=reject` | No enforcement of authentication |\n| Safe Attachments in Monitor mode | Change to Block mode | Malware delivered while monitoring |\n| Allow lists too broad | Review and restrict allow entries | Security bypass for attackers |\n| No impersonation protection | Enable for all executives | BEC attacks succeed |\n| External forwarding allowed | Block or alert on auto-forward rules | Data exfiltration risk |\n| ZAP disabled | Enable ZAP for phishing and malware | Threats persist in mailboxes |\n\n---"
            },
            "name": "text - config recommendations"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n## ‚úÖ Configuration Compliance Check\n\nThe following queries analyze your environment data to validate if security best practices are applied."
            },
            "name": "text - compliance check header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Configuration Compliance Summary\nlet TotalInbound = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailDirection == \"Inbound\" | count);\nlet DMARCPass = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailDirection == \"Inbound\" | extend Auth = parse_json(AuthenticationDetails) | where tostring(Auth.DMARC) == \"pass\" | count);\nlet DKIMPass = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailDirection == \"Inbound\" | extend Auth = parse_json(AuthenticationDetails) | where tostring(Auth.DKIM) == \"pass\" | count);\nlet SPFPass = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailDirection == \"Inbound\" | extend Auth = parse_json(AuthenticationDetails) | where tostring(Auth.SPF) == \"pass\" | count);\nlet ZAPActive = toscalar(EmailPostDeliveryEvents | where TimeGenerated {TimeRange} | where ActionTrigger == \"ZAP\" | count);\nlet SafeLinksActive = toscalar(UrlClickEvents | where TimeGenerated {TimeRange} | count);\nlet ImpersonationBlocks = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where EmailActionPolicy has_any (\"impersonation\", \"Anti-phishing\") | count);\nlet ThreatsBlocked = toscalar(EmailEvents | where TimeGenerated {TimeRange} | where DeliveryAction in (\"Blocked\", \"Quarantined\") | where isnotempty(ThreatTypes) | count);\nprint Check = dynamic([\"DMARC Validation\", \"DKIM Validation\", \"SPF Validation\", \"ZAP Active\", \"Safe Links Active\", \"Impersonation Protection\", \"Threat Blocking\"]),\n      Status = pack_array(\n        iff(DMARCPass > TotalInbound * 0.7, \"‚úÖ Good\", iff(DMARCPass > TotalInbound * 0.5, \"üü° Partial\", \"‚ùå Review\")),\n        iff(DKIMPass > TotalInbound * 0.7, \"‚úÖ Good\", iff(DKIMPass > TotalInbound * 0.5, \"üü° Partial\", \"‚ùå Review\")),\n        iff(SPFPass > TotalInbound * 0.8, \"‚úÖ Good\", iff(SPFPass > TotalInbound * 0.6, \"üü° Partial\", \"‚ùå Review\")),\n        iff(ZAPActive > 0, \"‚úÖ Active\", \"‚ùå No ZAP Activity\"),\n        iff(SafeLinksActive > 0, \"‚úÖ Active\", \"‚ö†Ô∏è No Data\"),\n        iff(ImpersonationBlocks > 0, \"‚úÖ Active\", \"‚ö†Ô∏è Review Policy\"),\n        iff(ThreatsBlocked > 0, \"‚úÖ Active\", \"‚ö†Ô∏è No Blocks\")),\n      Count = pack_array(DMARCPass, DKIMPass, SPFPass, ZAPActive, SafeLinksActive, ImpersonationBlocks, ThreatsBlocked),\n      Percentage = pack_array(\n        strcat(tostring(round(toreal(DMARCPass)/TotalInbound*100, 1)), \"%\"),\n        strcat(tostring(round(toreal(DKIMPass)/TotalInbound*100, 1)), \"%\"),\n        strcat(tostring(round(toreal(SPFPass)/TotalInbound*100, 1)), \"%\"),\n        \"N/A\", \"N/A\", \"N/A\", \"N/A\")\n| mv-expand Check to typeof(string), Status to typeof(string), Count to typeof(long), Percentage to typeof(string)",
              "size": 0,
              "title": "üìä Configuration Compliance Summary",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "name": "query - compliance summary"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Your Domains - DMARC/DKIM/SPF Status for Outbound\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Outbound\"\n| extend AuthDetails = parse_json(AuthenticationDetails)\n| extend \n    SPF = tostring(AuthDetails.SPF),\n    DKIM = tostring(AuthDetails.DKIM),\n    DMARC = tostring(AuthDetails.DMARC)\n| summarize \n    TotalSent = count(),\n    SPFPass = countif(SPF == \"pass\"),\n    DKIMPass = countif(DKIM == \"pass\"),\n    DKIMSigned = countif(isnotempty(DKIM) and DKIM != \"none\")\n    by SenderFromDomain\n| extend \n    SPFStatus = case(SPFPass == TotalSent, \"‚úÖ 100%\", SPFPass > TotalSent * 0.9, \"üü° >90%\", \"‚ùå Review\"),\n    DKIMStatus = case(DKIMPass == TotalSent, \"‚úÖ 100%\", DKIMPass > TotalSent * 0.9, \"üü° >90%\", DKIMSigned > 0, \"‚ö†Ô∏è Partial\", \"‚ùå Not Signing\")\n| order by TotalSent desc\n| project SenderFromDomain, TotalSent, SPFStatus, SPFPass, DKIMStatus, DKIMPass, DKIMSigned",
              "size": 0,
              "title": "üîê Your Domains - Authentication Status",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "query - your domains auth"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// ZAP Effectiveness Check\nEmailPostDeliveryEvents\n| where TimeGenerated {TimeRange}\n| summarize \n    TotalZAPActions = countif(ActionTrigger == \"ZAP\"),\n    ZAPSuccess = countif(ActionTrigger == \"ZAP\" and ActionResult == \"Success\"),\n    ZAPPhishing = countif(ActionTrigger == \"ZAP\" and ThreatTypes has \"Phish\"),\n    ZAPMalware = countif(ActionTrigger == \"ZAP\" and ThreatTypes has \"Malware\"),\n    ZAPSpam = countif(ActionTrigger == \"ZAP\" and ThreatTypes has \"Spam\"),\n    AdminActions = countif(ActionTrigger has_any (\"Admin\", \"Manual\"))\n| extend ZAPStatus = case(\n    TotalZAPActions > 0 and ZAPSuccess == TotalZAPActions, \"‚úÖ ZAP Fully Active\",\n    TotalZAPActions > 0, \"üü° ZAP Active (some failures)\",\n    \"‚ùå No ZAP Activity - Check Configuration\")\n| project ZAPStatus, TotalZAPActions, ZAPSuccess, ZAPPhishing, ZAPMalware, ZAPSpam, AdminActions",
              "size": 0,
              "title": "‚ö° ZAP (Zero-Hour Auto Purge) Status",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "query - zap status"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Safe Links Activity Check\nUrlClickEvents\n| where TimeGenerated {TimeRange}\n| summarize \n    TotalClicks = count(),\n    BlockedClicks = countif(IsClickedThrough == false),\n    AllowedClicks = countif(IsClickedThrough == true),\n    PhishingBlocked = countif(ThreatTypes has \"Phish\" and IsClickedThrough == false),\n    UniqueUsers = dcount(AccountUpn),\n    UniqueUrls = dcount(Url)\n| extend SafeLinksStatus = case(\n    TotalClicks > 0 and BlockedClicks > 0, \"‚úÖ Safe Links Active & Blocking\",\n    TotalClicks > 0, \"üü° Safe Links Active (no blocks)\",\n    \"‚ö†Ô∏è No Safe Links Data\")\n| extend BlockRate = round(toreal(BlockedClicks) / TotalClicks * 100, 1)\n| project SafeLinksStatus, TotalClicks, BlockedClicks, AllowedClicks, BlockRate, PhishingBlocked, UniqueUsers",
              "size": 0,
              "title": "üîó Safe Links Status",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "query - safe links status"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Safe Attachments Activity Check\nEmailAttachmentInfo\n| where TimeGenerated {TimeRange}\n| where isnotempty(ThreatTypes)\n| summarize \n    TotalMaliciousAttachments = count(),\n    UniqueHashes = dcount(SHA256),\n    UniqueRecipients = dcount(RecipientEmailAddress),\n    ThreatNames = make_set(ThreatNames, 10)\n| extend SafeAttachmentsStatus = case(\n    TotalMaliciousAttachments > 0, \"‚úÖ Safe Attachments Active & Detecting\",\n    \"‚ö†Ô∏è No Malicious Attachments Detected\")\n| project SafeAttachmentsStatus, TotalMaliciousAttachments, UniqueHashes, UniqueRecipients, ThreatNames",
              "size": 0,
              "title": "üìé Safe Attachments Status",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "query - safe attachments status"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Impersonation Protection Check\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailActionPolicy has_any (\"impersonation\", \"Anti-phishing\", \"domain impersonation\", \"user impersonation\")\n| summarize \n    TotalImpersonationActions = count(),\n    Blocked = countif(DeliveryAction == \"Blocked\"),\n    Quarantined = countif(DeliveryAction == \"Quarantined\"),\n    Delivered = countif(DeliveryAction == \"Delivered\"),\n    UniqueTargets = dcount(RecipientEmailAddress),\n    UniqueSenders = dcount(SenderFromAddress)\n| extend ImpersonationStatus = case(\n    TotalImpersonationActions > 0 and Delivered == 0, \"‚úÖ Impersonation Protection Active (All Blocked)\",\n    TotalImpersonationActions > 0, \"üü° Active but some delivered - Review Policy\",\n    \"‚ö†Ô∏è No Impersonation Detections - Verify Policy\")\n| project ImpersonationStatus, TotalImpersonationActions, Blocked, Quarantined, Delivered, UniqueTargets",
              "size": 0,
              "title": "üé≠ Impersonation Protection Status",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "query - impersonation status"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Spoof Intelligence Check\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| extend AuthDetails = parse_json(AuthenticationDetails)\n| extend CompAuth = tostring(AuthDetails.CompAuth)\n| where CompAuth has_any (\"fail\", \"softfail\", \"spoof\")\n| summarize \n    SpoofAttempts = count(),\n    Blocked = countif(DeliveryAction == \"Blocked\"),\n    Quarantined = countif(DeliveryAction == \"Quarantined\"),\n    Delivered = countif(DeliveryAction == \"Delivered\"),\n    UniqueSenders = dcount(SenderFromAddress)\n| extend SpoofStatus = case(\n    SpoofAttempts > 0 and Delivered == 0, \"‚úÖ Spoof Intelligence Active (All Blocked)\",\n    SpoofAttempts > 0 and Delivered < SpoofAttempts * 0.1, \"üü° Mostly Blocking\",\n    SpoofAttempts > 0, \"‚ùå Review - Spoofed emails delivered\",\n    \"‚ÑπÔ∏è No Spoof Attempts Detected\")\n| project SpoofStatus, SpoofAttempts, Blocked, Quarantined, Delivered",
              "size": 0,
              "title": "üïµÔ∏è Spoof Intelligence Status",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "query - spoof status"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// External Forwarding Detection\nlet ForwardingRules = OfficeActivity\n| where TimeGenerated {TimeRange}\n| where Operation in (\"New-InboxRule\", \"Set-InboxRule\", \"Set-Mailbox\")\n| where Parameters has_any (\"ForwardTo\", \"ForwardAsAttachmentTo\", \"RedirectTo\", \"ForwardingSmtpAddress\")\n| extend ForwardingTarget = extract(@\"(ForwardTo|ForwardAsAttachmentTo|RedirectTo|ForwardingSmtpAddress)[^@]*@([\\w.-]+)\", 2, tostring(Parameters))\n| where isnotempty(ForwardingTarget)\n| summarize \n    RulesCreated = count(),\n    UniqueUsers = dcount(UserId),\n    Targets = make_set(ForwardingTarget, 10)\n    by UserId, Operation;\nForwardingRules\n| summarize \n    TotalForwardingRules = count(),\n    UniqueUsersWithForwarding = dcount(UserId),\n    ExternalTargets = make_set(Targets, 20)\n| extend ForwardingStatus = case(\n    TotalForwardingRules == 0, \"‚úÖ No External Forwarding Detected\",\n    TotalForwardingRules > 10, \"üî¥ High Volume - Investigate\",\n    \"üü° Forwarding Rules Exist - Review\")\n| project ForwardingStatus, TotalForwardingRules, UniqueUsersWithForwarding, ExternalTargets",
              "size": 0,
              "title": "üì§ External Forwarding Rules Check",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "name": "query - forwarding check"
          },
          {
            "type": 1,
            "content": {
              "json": "---"
            },
            "name": "text - divider"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Emails Bypassing Authentication\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| where DeliveryAction == \"Delivered\"\n| extend AuthDetails = parse_json(AuthenticationDetails)\n| extend \n    SPFResult = tostring(AuthDetails.SPF),\n    DKIMResult = tostring(AuthDetails.DKIM),\n    DMARCResult = tostring(AuthDetails.DMARC)\n| where SPFResult in (\"fail\", \"hardfail\", \"softfail\") or DMARCResult == \"fail\"\n| summarize \n    DeliveredDespiteFailure = count(),\n    PhishingThreats = countif(ThreatTypes has \"Phish\"),\n    UniqueRecipients = dcount(RecipientEmailAddress)\n    by SenderFromDomain, SenderFromAddress\n| extend RiskLevel = case(\n    PhishingThreats > 0, \"üî¥ Phishing Delivered\",\n    DeliveredDespiteFailure > 10, \"üü† High Volume Bypass\",\n    \"üü° Review\")\n| order by DeliveredDespiteFailure desc\n| take 25\n| project RiskLevel, SenderFromDomain, SenderFromAddress, DeliveredDespiteFailure, PhishingThreats, UniqueRecipients",
              "size": 0,
              "title": "üö® Delivered Despite Authentication Failure (Configuration Gap)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "DeliveredDespiteFailure", "formatter": 4, "formatOptions": { "palette": "orange" } },
                  { "columnMatch": "PhishingThreats", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "name": "query - delivered despite failure"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Partner Domains Without DMARC\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| extend AuthDetails = parse_json(AuthenticationDetails)\n| extend DMARCResult = tostring(AuthDetails.DMARC)\n| where DMARCResult in (\"none\", \"\") or isempty(DMARCResult)\n| where isnotempty(ThreatTypes) == false // Legitimate email only\n| summarize \n    EmailCount = count(),\n    UniqueRecipients = dcount(RecipientEmailAddress),\n    UniqueSenders = dcount(SenderFromAddress)\n    by SenderFromDomain\n| where EmailCount > 10\n| order by EmailCount desc\n| take 20\n| project SenderFromDomain, EmailCount, UniqueRecipients, UniqueSenders",
              "size": 0,
              "title": "üìß High-Volume Partner Domains Without DMARC",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "EmailCount", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - partners without dmarc"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Policy Actions Effectiveness\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where EmailDirection == \"Inbound\"\n| where isnotempty(EmailActionPolicy)\n| summarize \n    TotalActions = count(),\n    Blocked = countif(DeliveryAction == \"Blocked\"),\n    Quarantined = countif(DeliveryAction == \"Quarantined\"),\n    Delivered = countif(DeliveryAction == \"Delivered\")\n    by EmailActionPolicy\n| extend BlockRate = round(toreal(Blocked + Quarantined) / TotalActions * 100, 1)\n| order by TotalActions desc\n| project EmailActionPolicy, TotalActions, Blocked, Quarantined, Delivered, BlockRate",
              "size": 0,
              "title": "üìä Policy Effectiveness Analysis",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "BlockRate", "formatter": 4, "formatOptions": { "palette": "greenRed" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - policy effectiveness"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Config"
      },
      "name": "group - config"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üîé User & Domain Investigation\n\nUse the parameters above to investigate specific users or domains."
            },
            "name": "text - investigation header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// User Investigation - Email Activity\nlet UserFilter = \"{InvestigateUser}\";\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(UserFilter) and (RecipientEmailAddress has UserFilter or SenderFromAddress has UserFilter)\n| summarize \n    TotalEmails = count(),\n    Inbound = countif(EmailDirection == \"Inbound\"),\n    Outbound = countif(EmailDirection == \"Outbound\"),\n    Threats = countif(isnotempty(ThreatTypes)),\n    Phishing = countif(ThreatTypes has \"Phish\"),\n    Malware = countif(ThreatTypes has \"Malware\")\n| project \n    Metric = pack_array(\"Total Emails\", \"Inbound\", \"Outbound\", \"Threats\", \"Phishing\", \"Malware\"),\n    Value = pack_array(TotalEmails, Inbound, Outbound, Threats, Phishing, Malware)\n| mv-expand Metric to typeof(string), Value to typeof(long)",
              "size": 4,
              "title": "üë§ User Email Metrics",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "auto" } }
              }
            },
            "name": "query - user metrics"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// User - Received Threats\nlet UserFilter = \"{InvestigateUser}\";\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(UserFilter) and RecipientEmailAddress has UserFilter\n| where isnotempty(ThreatTypes)\n| project TimeGenerated, SenderFromAddress, SenderDisplayName, Subject, ThreatTypes, DeliveryAction, DeliveryLocation\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üì• Threats Received by User",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "name": "query - user threats"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Domain Investigation\nlet DomainFilter = \"{InvestigateDomain}\";\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(DomainFilter) and SenderFromDomain has DomainFilter\n| summarize \n    TotalEmails = count(),\n    Threats = countif(isnotempty(ThreatTypes)),\n    Delivered = countif(DeliveryAction == \"Delivered\"),\n    Blocked = countif(DeliveryAction == \"Blocked\"),\n    UniqueRecipients = dcount(RecipientEmailAddress),\n    UniqueSenders = dcount(SenderFromAddress)\n| project \n    Metric = pack_array(\"Total Emails\", \"Threats\", \"Delivered\", \"Blocked\", \"Recipients\", \"Senders\"),\n    Value = pack_array(TotalEmails, Threats, Delivered, Blocked, UniqueRecipients, UniqueSenders)\n| mv-expand Metric to typeof(string), Value to typeof(long)",
              "size": 4,
              "title": "üåê Domain Investigation Metrics",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "auto" } }
              }
            },
            "name": "query - domain metrics"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Domain - Email Activity\nlet DomainFilter = \"{InvestigateDomain}\";\nEmailEvents\n| where TimeGenerated {TimeRange}\n| where isnotempty(DomainFilter) and SenderFromDomain has DomainFilter\n| project TimeGenerated, SenderFromAddress, SenderDisplayName, RecipientEmailAddress, Subject, ThreatTypes, DeliveryAction, AuthenticationDetails\n| order by TimeGenerated desc\n| take 100",
              "size": 0,
              "title": "üìß Emails from Domain",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": ["{Workspace}"],
              "visualization": "table"
            },
            "name": "query - domain emails"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Investigation"
      },
      "name": "group - investigation"
    }
  ],
  "fallbackResourceIds": [],
  "fromTemplateId": "DefenderForOffice365-BEC-AiTM",
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
