{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "## üè∞ Active Directory & Domain Controller Security Workbook\n---\n\nComprehensive monitoring and analysis of Windows Security Events from Domain Controllers and Active Directory infrastructure. This workbook provides real-time visibility into authentication activity, privileged access, directory changes, and security threats.\n\n**Use Cases:**\n- üîê Monitor Domain Controller authentication activity\n- üëë Track privileged account usage and anomalies\n- üìù Audit Active Directory changes (users, groups, GPOs)\n- üö® Detect credential attacks and lateral movement\n- üîê Monitor Kerberos vs NTLM authentication patterns\n- üìä Baseline deviation analysis for anomaly detection\n\n**Data Source:** SecurityEvent\n\n---\n\n### üì° XPath Queries for Data Collection Rules (DCR)\n\nConfigure these XPath queries in your Azure Monitor Agent Data Collection Rules.\n\n‚ö†Ô∏è **IMPORTANT:** Copy each query COMPLETELY including `Security!*[System[(` at the start and `]]]` at the end.\n\n**Add these XPath queries to your DCR (one per line in the Custom section):**\n\n```\nSecurity!*[System[(EventID=4624 or EventID=4625 or EventID=4648 or EventID=4672 or EventID=4634)]]\nSecurity!*[System[(EventID=4768 or EventID=4769 or EventID=4770 or EventID=4771 or EventID=4776)]]\nSecurity!*[System[(EventID=4720 or EventID=4722 or EventID=4723 or EventID=4724 or EventID=4725 or EventID=4726 or EventID=4738 or EventID=4740)]]\nSecurity!*[System[(EventID=4728 or EventID=4729 or EventID=4732 or EventID=4733 or EventID=4756 or EventID=4757)]]\nSecurity!*[System[(EventID=5136 or EventID=5137 or EventID=5141 or EventID=1102)]]\n```\n\n**System Log - Kerberos RC4 Deprecation Events (Windows Server 2025+):**\n```\nSystem!*[System[(EventID=201 or EventID=206 or EventID=207 or EventID=208 or EventID=209 or EventID=210)]]\nMicrosoft-Windows-Kerberos-Key-Distribution-Center/Operational!*[System[(EventID=16 or EventID=17 or EventID=18 or EventID=19)]]\n```\n\n**DCR Configuration Steps:**\n1. Navigate to **Azure Portal** ‚Üí **Monitor** ‚Üí **Data Collection Rules**\n2. Create or edit a DCR for Domain Controllers\n3. Add **Windows Event Logs** as a data source\n4. Select **Custom** and paste each XPath query (one per line)\n5. Set destination to your Log Analytics workspace\n6. Associate DCR with Domain Controller VMs\n\n---\n\n### üìã Prerequisites & Requirements\n\n**Required Data Connectors:**\n- Windows Security Events via AMA (recommended) or Legacy Agent\n- Microsoft Defender for Identity (optional, for enhanced detection)\n\n**Required Audit Policies (GPO):**\n| Category | Subcategory | Setting |\n|----------|-------------|---------|\n| Account Logon | Credential Validation | Success, Failure |\n| Account Logon | Kerberos Authentication Service | Success, Failure |\n| Account Logon | Kerberos Service Ticket Operations | Success, Failure |\n| Account Management | User Account Management | Success, Failure |\n| Account Management | Security Group Management | Success, Failure |\n| Account Management | Computer Account Management | Success, Failure |\n| Logon/Logoff | Logon | Success, Failure |\n| Logon/Logoff | Special Logon | Success |\n| DS Access | Directory Service Changes | Success, Failure |\n| Policy Change | Audit Policy Change | Success, Failure |\n\n**Key Event IDs Required:**\n- 4624, 4625 (Logon Success/Failure)\n- 4648 (Explicit Credentials)\n- 4672 (Special Privileges)\n- 4720-4726, 4738 (Account Management)\n- 4728, 4732, 4756 (Group Membership)\n- 4740 (Account Lockout)\n- 4768, 4769, 4770, 4771 (Kerberos)\n- 4776 (NTLM)\n- 5136, 5137, 5141 (Directory Service)\n\n**RC4 Deprecation Events (Windows Server 2025+):**\n- 201 (RC4 TGT Issued by KDC)\n- 206 (RC4 Service Ticket Issued)\n- 207 (RC4 used - missing AES keys)\n- 208/209/210 (RC4 fallback reasons)\n- 16-19 (KDC Operational RC4 audit)\n\n‚ö†Ô∏è **Security Note:** Domain Controllers are high-value targets. Monitor for unusual authentication patterns, privileged access from unexpected locations, and directory modifications."
      },
      "name": "WorkbookHeader"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "label": "Time Range",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 604800000
            },
            "typeSettings": {
              "selectableValues": [
                { "durationMs": 3600000 },
                { "durationMs": 14400000 },
                { "durationMs": 43200000 },
                { "durationMs": 86400000 },
                { "durationMs": 604800000 },
                { "durationMs": 2592000000 }
              ],
              "allowCustom": true
            }
          },
          {
            "id": "b2c3d4e5-f678-90ab-cdef-123456789012",
            "version": "KqlParameterItem/1.0",
            "name": "DomainController",
            "label": "Domain Controller",
            "type": 2,
            "isRequired": false,
            "query": "SecurityEvent\n| where TimeGenerated > ago(7d)\n| where EventID in (4624, 4625, 4768, 4769)\n| distinct Computer\n| order by Computer asc",
            "typeSettings": {
              "additionalResourceOptions": ["value::all"],
              "showDefault": false
            },
            "defaultValue": "value::all",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "Parameters"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "tab-executive",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üìà Executive Summary",
            "subTarget": "executive",
            "style": "link"
          },
          {
            "id": "tab-overview",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üìä Overview",
            "subTarget": "overview",
            "style": "link"
          },
          {
            "id": "tab-staleprotocols",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üîí Stale Protocols & Weak Auth",
            "subTarget": "staleprotocols",
            "style": "link"
          },
          {
            "id": "tab-auth",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üîê Authentication",
            "subTarget": "auth",
            "style": "link"
          },
          {
            "id": "tab-privileged",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üëë Privileged Access",
            "subTarget": "privileged",
            "style": "link"
          },
          {
            "id": "tab-adchanges",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üìù AD Changes",
            "subTarget": "adchanges",
            "style": "link"
          },
          {
            "id": "tab-geo",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üó∫Ô∏è Geolocation",
            "subTarget": "geo",
            "style": "link"
          },
          {
            "id": "tab-security",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üö® Security Threats",
            "subTarget": "security",
            "style": "link"
          },
          {
            "id": "tab-dchealth",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üñ•Ô∏è DC Health",
            "subTarget": "dchealth",
            "style": "link"
          },
          {
            "id": "tab-mdi",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üõ°Ô∏è MDI Coverage",
            "subTarget": "mdi",
            "style": "link"
          },
          {
            "id": "tab-misconfig",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "‚ö†Ô∏è Misconfigurations",
            "subTarget": "misconfig",
            "style": "link"
          },
          {
            "id": "tab-ueba",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üß† UEBA & Anomalies",
            "subTarget": "ueba",
            "style": "link"
          },
          {
            "id": "tab-credtheft",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üî¥ Credential Theft",
            "subTarget": "credtheft",
            "style": "link"
          },
          {
            "id": "tab-persistence",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üü£ Persistence",
            "subTarget": "persistence",
            "style": "link"
          },
          {
            "id": "tab-forensics",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üî¨ Forensics",
            "subTarget": "forensics",
            "style": "link"
          },
          {
            "id": "tab-xdr",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üõ°Ô∏è XDR Correlation",
            "subTarget": "xdr",
            "style": "link"
          },
          {
            "id": "tab-staleaccounts",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üëª Stale Accounts & Devices",
            "subTarget": "staleaccounts",
            "style": "link"
          }
        ]
      },
      "name": "TabNavigation"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## ÔøΩ Executive Summary for Leadership\n\n**Purpose:** High-level security posture overview for CIO, CISO, and executive stakeholders.\n\n---"
            },
            "name": "ExecHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Overall Identity Security Risk Score\nlet FailedLogons = SecurityEvent | where TimeGenerated {TimeRange} | where EventID == 4625 | count;\nlet DCSync = SecurityEvent | where TimeGenerated {TimeRange} | where EventID == 4662 | where Properties has_any (\"1131f6aa-9c07-11d1-f79f-00c04fc2dcd2\", \"1131f6ad-9c07-11d1-f79f-00c04fc2dcd2\") | where SubjectUserName !endswith \"$\" | count;\nlet CredTools = SecurityEvent | where TimeGenerated {TimeRange} | where EventID == 4688 | where CommandLine has_any (\"mimikatz\", \"sekurlsa\", \"procdump\", \"ntdsutil\", \"secretsdump\") | count;\nlet PrivEsc = SecurityEvent | where TimeGenerated {TimeRange} | where EventID in (4728, 4732, 4756) | where TargetUserName has_any (\"Domain Admins\", \"Enterprise Admins\", \"Administrators\") | count;\nlet Lockouts = SecurityEvent | where TimeGenerated {TimeRange} | where EventID == 4740 | count;\nlet CriticalScore = toscalar(DCSync) * 50 + toscalar(CredTools) * 40 + toscalar(PrivEsc) * 30;\nlet HighScore = toscalar(Lockouts) * 5;\nlet MediumScore = toscalar(FailedLogons) / 100;\nlet TotalScore = CriticalScore + HighScore + MediumScore;\nlet RiskLevel = case(TotalScore >= 100, \"üî¥ CRITICAL\", TotalScore >= 50, \"üü† HIGH\", TotalScore >= 20, \"üü° MEDIUM\", \"üü¢ LOW\");\nprint RiskLevel = RiskLevel, RiskScore = TotalScore, CriticalEvents = toscalar(DCSync) + toscalar(CredTools), PrivilegeEscalations = toscalar(PrivEsc), AccountLockouts = toscalar(Lockouts), FailedLogons = toscalar(FailedLogons)",
              "size": 3,
              "title": "üéØ Identity Security Risk Score",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "RiskLevel", "formatter": 1 },
                "subtitleContent": { "columnMatch": "RiskScore", "formatter": 12 },
                "showBorder": true
              }
            },
            "name": "ExecRiskScore"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Executive KPI Metrics\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| summarize \n    TotalEvents = count(),\n    FailedLogons = countif(EventID == 4625),\n    SuccessLogons = countif(EventID == 4624),\n    PrivilegedLogons = countif(EventID == 4672),\n    AccountLockouts = countif(EventID == 4740),\n    GroupChanges = countif(EventID in (4728, 4732, 4756)),\n    UserChanges = countif(EventID in (4720, 4722, 4725, 4726)),\n    KerberosFailures = countif(EventID == 4771)\n| extend FailRate = round(todouble(FailedLogons) / (FailedLogons + SuccessLogons) * 100, 2)\n| extend FailRateStatus = case(FailRate > 10, 'üî¥', FailRate > 5, 'üü°', 'üü¢')\n| project \n    TotalEvents, SuccessLogons, FailedLogons, FailRate, FailRateStatus,\n    PrivilegedLogons, AccountLockouts, GroupChanges, UserChanges, KerberosFailures",
              "size": 0,
              "title": "üìä Key Performance Indicators (7-Day Summary)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "FailRate", "formatter": 4, "formatOptions": { "palette": "redGreen", "min": 0, "max": 20 } },
                  { "columnMatch": "FailedLogons", "formatter": 4, "formatOptions": { "palette": "red" } },
                  { "columnMatch": "AccountLockouts", "formatter": 4, "formatOptions": { "palette": "orange" } }
                ]
              }
            },
            "name": "ExecKPIs"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Critical Alerts for Leadership\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| extend AttributeLDAPDisplayName = extract('<Data Name=\"AttributeLDAPDisplayName\">([^<]+)</Data>', 1, EventData)\n| extend CriticalAlert = case(\n    EventID == 4662 and Properties has_any (\"1131f6aa-9c07-11d1-f79f-00c04fc2dcd2\", \"1131f6ad-9c07-11d1-f79f-00c04fc2dcd2\") and SubjectUserName !endswith \"$\", \"üî¥ DCSync Attack Detected\",\n    EventID == 4688 and CommandLine has_any (\"mimikatz\", \"sekurlsa\", \"lsadump\"), \"üî¥ Credential Theft Tool\",\n    EventID == 4688 and CommandLine has_any (\"ntdsutil\", \"vssadmin\") and CommandLine has_any (\"create\", \"ifm\"), \"üî¥ NTDS.dit Extraction\",\n    EventID in (4728, 4732, 4756) and TargetUserName has_any (\"Enterprise Admins\", \"Schema Admins\"), \"üî¥ Tier-0 Group Modified\",\n    EventID in (4728, 4732, 4756) and TargetUserName has \"Domain Admins\", \"üü† Domain Admins Modified\",\n    EventID == 4765, \"üü† SID History Injection\",\n    EventID == 5136 and AttributeLDAPDisplayName == \"msDS-KeyCredentialLink\", \"üî¥ Shadow Credentials Added\",\n    EventID == 4740, \"üü° Account Lockout\",\n    \"\")\n| where CriticalAlert != \"\"\n| summarize Count = count(), LastSeen = max(TimeGenerated), Computers = make_set(Computer, 3) by CriticalAlert\n| extend Severity = case(CriticalAlert startswith \"üî¥\", 1, CriticalAlert startswith \"üü†\", 2, 3)\n| order by Severity asc, Count desc\n| project ['Alert Type'] = CriticalAlert, ['Count'] = Count, ['Last Seen'] = LastSeen, ['Affected Systems'] = Computers",
              "size": 0,
              "title": "üö® Critical Security Alerts Requiring Attention",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "redGreen" } }
                ]
              }
            },
            "name": "ExecCriticalAlerts"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Security Trend - 7 Day View\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4625, 4740, 4728, 4732, 4756, 4672)\n| extend Category = case(\n    EventID == 4625, \"Failed Logons\",\n    EventID == 4740, \"Lockouts\",\n    EventID in (4728, 4732, 4756), \"Group Changes\",\n    EventID == 4672, \"Privileged Access\",\n    \"Other\")\n| summarize Count = count() by Category, bin(TimeGenerated, 1d)\n| render timechart",
              "size": 0,
              "title": "üìà Security Event Trends",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "ExecTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Risk Users\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4625, 4672, 4648, 4768, 4771)\n| where TargetUserName !endswith \"$\" and TargetUserName != \"-\"\n| summarize \n    FailedLogons = countif(EventID == 4625),\n    PrivilegedSessions = countif(EventID == 4672),\n    ExplicitCreds = countif(EventID == 4648),\n    KerberosFails = countif(EventID == 4771)\n    by TargetUserName\n| extend RiskScore = FailedLogons * 2 + ExplicitCreds * 5 + KerberosFails * 3\n| where RiskScore > 10\n| top 10 by RiskScore desc\n| extend RiskLevel = case(RiskScore >= 100, \"üî¥ Critical\", RiskScore >= 50, \"üü† High\", \"üü° Medium\")\n| project RiskLevel, User = TargetUserName, RiskScore, FailedLogons, PrivilegedSessions, ExplicitCreds",
              "size": 0,
              "title": "üë§ Top 10 High-Risk Users",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ExecRiskUsers"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// MITRE ATT&CK Coverage Summary\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| extend TicketEncryptionType = extract('<Data Name=\"TicketEncryptionType\">([^<]+)</Data>', 1, EventData)\n| extend PreAuthType = extract('<Data Name=\"PreAuthType\">([^<]+)</Data>', 1, EventData)\n| extend TechniqueDetected = case(\n    EventID == 4625, \"T1110 - Brute Force\",\n    EventID == 4648, \"T1078 - Valid Accounts\",\n    EventID == 4662 and Properties has \"1131f6a\", \"T1003.006 - DCSync\",\n    EventID == 4688 and CommandLine has_any (\"mimikatz\", \"sekurlsa\"), \"T1003.001 - LSASS Memory\",\n    EventID == 4688 and CommandLine has_any (\"ntdsutil\", \"vssadmin\"), \"T1003.003 - NTDS\",\n    EventID in (4728, 4732, 4756), \"T1098 - Account Manipulation\",\n    EventID == 4769 and TicketEncryptionType in (\"0x17\", \"0x18\"), \"T1558.003 - Kerberoasting\",\n    EventID == 4768 and PreAuthType == \"0\", \"T1558.004 - AS-REP Roasting\",\n    EventID == 4624 and LogonType == 3 and AuthenticationPackageName == \"NTLM\", \"T1550.002 - Pass the Hash\",\n    \"\")\n| where TechniqueDetected != \"\"\n| summarize DetectionCount = count(), LastSeen = max(TimeGenerated), SampleComputers = make_set(Computer, 3) by TechniqueDetected\n| extend Tactic = case(\n    TechniqueDetected has \"T1110\", \"Credential Access\",\n    TechniqueDetected has \"T1078\", \"Initial Access\",\n    TechniqueDetected has \"T1003\", \"Credential Access\",\n    TechniqueDetected has \"T1098\", \"Persistence\",\n    TechniqueDetected has \"T1558\", \"Credential Access\",\n    TechniqueDetected has \"T1550\", \"Lateral Movement\",\n    \"Other\")\n| extend Severity = case(\n    TechniqueDetected has_any (\"DCSync\", \"LSASS\", \"NTDS\", \"Kerberoasting\", \"AS-REP\"), \"üî¥ Critical\",\n    TechniqueDetected has_any (\"Pass the Hash\", \"Account Manipulation\"), \"üü† High\",\n    \"üü° Medium\")\n| project Severity, Tactic, TechniqueDetected, DetectionCount, LastSeen, SampleComputers\n| order by DetectionCount desc",
              "size": 0,
              "title": "üéØ MITRE ATT&CK Detections - Click row for details",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Severity", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "contains", "thresholdValue": "Critical", "representation": "red", "text": "{0}"}, {"operator": "contains", "thresholdValue": "High", "representation": "orange", "text": "{0}"}, {"operator": "Default", "representation": "yellow", "text": "{0}"}] } },
                  { "columnMatch": "DetectionCount", "formatter": 4, "formatOptions": { "palette": "redGreen" } }
                ],
                "filter": true
              },
              "exportFieldName": "TechniqueDetected",
              "exportParameterName": "SelectedMITRETechnique",
              "exportDefaultValue": ""
            },
            "customWidth": "50",
            "name": "ExecMITRE"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// MITRE Technique Details\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| extend TicketEncryptionType = extract('<Data Name=\"TicketEncryptionType\">([^<]+)</Data>', 1, EventData)\n| extend PreAuthType = extract('<Data Name=\"PreAuthType\">([^<]+)</Data>', 1, EventData)\n| extend TechniqueDetected = case(\n    EventID == 4625, \"T1110 - Brute Force\",\n    EventID == 4648, \"T1078 - Valid Accounts\",\n    EventID == 4662 and Properties has \"1131f6a\", \"T1003.006 - DCSync\",\n    EventID == 4688 and CommandLine has_any (\"mimikatz\", \"sekurlsa\"), \"T1003.001 - LSASS Memory\",\n    EventID == 4688 and CommandLine has_any (\"ntdsutil\", \"vssadmin\"), \"T1003.003 - NTDS\",\n    EventID in (4728, 4732, 4756), \"T1098 - Account Manipulation\",\n    EventID == 4769 and TicketEncryptionType in (\"0x17\", \"0x18\"), \"T1558.003 - Kerberoasting\",\n    EventID == 4768 and PreAuthType == \"0\", \"T1558.004 - AS-REP Roasting\",\n    EventID == 4624 and LogonType == 3 and AuthenticationPackageName == \"NTLM\", \"T1550.002 - Pass the Hash\",\n    \"\")\n| where TechniqueDetected == \"{SelectedMITRETechnique}\"\n| summarize EventCount = count(), FirstSeen = min(TimeGenerated), LastSeen = max(TimeGenerated) by Computer, TargetUserName, Activity\n| top 20 by EventCount desc\n| project Computer, TargetUserName, Activity, EventCount, FirstSeen, LastSeen",
              "size": 0,
              "title": "üîç MITRE Technique Details: {SelectedMITRETechnique}",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "EventCount", "formatter": 4, "formatOptions": { "palette": "redGreen" } }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedMITRETechnique",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "ExecMITREDetails"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### üéØ Top 10 High Risk Entities"
            },
            "name": "TopRiskHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top 10 High Risk Accounts\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| extend RiskWeight = case(\n    EventID == 4662 and Properties has \"1131f6a\", 50,\n    EventID == 4688 and CommandLine has_any (\"mimikatz\", \"sekurlsa\"), 40,\n    EventID in (4728, 4732, 4756), 30,\n    EventID == 4625, 5,\n    EventID == 4740, 10,\n    1)\n| where SubjectUserName != \"-\" and SubjectUserName !endswith \"$\"\n| summarize \n    RiskScore = sum(RiskWeight),\n    TotalEvents = count(),\n    FailedLogons = countif(EventID == 4625),\n    PrivilegedOps = countif(EventID in (4672, 4728, 4732, 4756)),\n    ComputersAccessed = dcount(Computer)\n    by SubjectUserName\n| top 10 by RiskScore desc\n| extend RiskLevel = case(RiskScore > 500, \"üî¥ Critical\", RiskScore > 100, \"üü† High\", \"üü° Medium\")\n| project RiskLevel, Account = SubjectUserName, RiskScore, TotalEvents, FailedLogons, PrivilegedOps, ComputersAccessed",
              "size": 0,
              "title": "üë§ Top 10 High Risk Accounts",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "RiskScore", "formatter": 4, "formatOptions": { "palette": "redGreen", "min": 0, "max": 500 } },
                  { "columnMatch": "RiskLevel", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "contains", "thresholdValue": "Critical", "representation": "red", "text": "{0}"}, {"operator": "contains", "thresholdValue": "High", "representation": "orange", "text": "{0}"}, {"operator": "Default", "representation": "yellow", "text": "{0}"}] } }
                ]
              }
            },
            "customWidth": "50",
            "name": "TopRiskAccounts"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top 10 High Risk Computers\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| extend RiskWeight = case(\n    EventID == 4662 and Properties has \"1131f6a\", 50,\n    EventID == 4688 and CommandLine has_any (\"mimikatz\", \"sekurlsa\"), 40,\n    EventID in (4728, 4732, 4756), 30,\n    EventID == 4625, 5,\n    EventID == 4771, 8,\n    1)\n| summarize \n    RiskScore = sum(RiskWeight),\n    TotalEvents = count(),\n    FailedLogons = countif(EventID == 4625),\n    SuspiciousProcesses = countif(EventID == 4688 and CommandLine has_any (\"mimikatz\", \"sekurlsa\", \"ntdsutil\")),\n    UniqueUsers = dcount(SubjectUserName)\n    by Computer\n| top 10 by RiskScore desc\n| extend RiskLevel = case(RiskScore > 500, \"üî¥ Critical\", RiskScore > 100, \"üü† High\", \"üü° Medium\")\n| project RiskLevel, Computer, RiskScore, TotalEvents, FailedLogons, SuspiciousProcesses, UniqueUsers",
              "size": 0,
              "title": "üñ•Ô∏è Top 10 High Risk Computers",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "RiskScore", "formatter": 4, "formatOptions": { "palette": "redGreen", "min": 0, "max": 500 } },
                  { "columnMatch": "RiskLevel", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "contains", "thresholdValue": "Critical", "representation": "red", "text": "{0}"}, {"operator": "contains", "thresholdValue": "High", "representation": "orange", "text": "{0}"}, {"operator": "Default", "representation": "yellow", "text": "{0}"}] } }
                ]
              }
            },
            "customWidth": "50",
            "name": "TopRiskComputers"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top 10 High Risk IP Addresses\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where isnotempty(IpAddress) and IpAddress != \"-\"\n| extend RiskWeight = case(\n    EventID == 4662 and Properties has \"1131f6a\", 50,\n    EventID == 4688 and CommandLine has_any (\"mimikatz\", \"sekurlsa\"), 40,\n    EventID in (4728, 4732, 4756), 30,\n    EventID == 4625, 5,\n    EventID == 4771, 8,\n    EventID == 4648, 10,\n    1)\n| summarize \n    RiskScore = sum(RiskWeight),\n    TotalEvents = count(),\n    FailedLogons = countif(EventID == 4625),\n    SuccessLogons = countif(EventID == 4624),\n    UniqueUsers = dcount(TargetUserName),\n    UniqueComputers = dcount(Computer),\n    SampleUsers = make_set(TargetUserName, 5)\n    by IpAddress\n| top 10 by RiskScore desc\n| extend RiskLevel = case(RiskScore > 500, \"üî¥ Critical\", RiskScore > 100, \"üü† High\", \"üü° Medium\")\n| extend FailRate = round(todouble(FailedLogons) / (FailedLogons + SuccessLogons) * 100, 1)\n| project RiskLevel, IpAddress, RiskScore, TotalEvents, FailedLogons, ['Fail %'] = FailRate, UniqueUsers, UniqueComputers, SampleUsers",
              "size": 0,
              "title": "üåê Top 10 High Risk IP Addresses",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "RiskScore", "formatter": 4, "formatOptions": { "palette": "redGreen", "min": 0, "max": 500 } },
                  { "columnMatch": "RiskLevel", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "contains", "thresholdValue": "Critical", "representation": "red", "text": "{0}"}, {"operator": "contains", "thresholdValue": "High", "representation": "orange", "text": "{0}"}, {"operator": "Default", "representation": "yellow", "text": "{0}"}] } },
                  { "columnMatch": "Fail %", "formatter": 4, "formatOptions": { "palette": "redGreen", "min": 0, "max": 50 } }
                ]
              }
            },
            "customWidth": "50",
            "name": "TopRiskIPs"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Domain Controller Health Summary\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4625, 4768, 4769)\n| summarize \n    TotalEvents = count(),\n    FailedLogons = countif(EventID == 4625),\n    KerberosRequests = countif(EventID in (4768, 4769)),\n    LastEvent = max(TimeGenerated)\n    by Computer\n| extend HealthStatus = case(\n    datetime_diff('hour', now(), LastEvent) > 1, \"üî¥ No Recent Data\",\n    FailedLogons > 1000, \"üü† High Failed Logons\",\n    \"üü¢ Healthy\")\n| project HealthStatus, ['Domain Controller'] = Computer, TotalEvents, FailedLogons, KerberosRequests, ['Last Event'] = LastEvent\n| order by HealthStatus asc",
              "size": 0,
              "title": "üñ•Ô∏è Domain Controller Health Status",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ExecDCHealth"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### üìã Executive Action Items\n\n| Priority | Category | Recommendation |\n|----------|----------|----------------|\n| üî¥ **Critical** | Credential Theft | Investigate any DCSync or NTDS.dit extraction alerts immediately |\n| üî¥ **Critical** | Privileged Access | Review all Enterprise/Schema Admin group changes |\n| üü† **High** | Account Security | Investigate accounts with high failed logon rates |\n| üü† **High** | Lateral Movement | Review users accessing multiple systems rapidly |\n| üü° **Medium** | Compliance | Ensure all DCs are reporting security events |\n| üü° **Medium** | Hygiene | Review and remove stale privileged accounts |\n\n### üìä Key Metrics Explained\n\n- **Risk Score**: Weighted calculation based on critical events (DCSync=50pts, Credential Tools=40pts, Privilege Changes=30pts)\n- **Failure Rate**: Percentage of failed vs successful logons - high rates indicate brute force or misconfigurations\n- **Privileged Sessions**: Count of special privilege assignments - monitor for unusual spikes\n- **MITRE Coverage**: Attack techniques detected based on MITRE ATT&CK framework mappings\n\n---\n\n*For detailed investigation, use the other tabs: Credential Theft, Persistence, Forensics, XDR Correlation*"
            },
            "name": "ExecActionItems"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "executive"
      },
      "name": "ExecutiveGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## ÔøΩüìä Active Directory Security Overview\n---\nKey metrics and trends for Domain Controller and Active Directory security events."
            },
            "name": "OverviewHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4625)\n| summarize TotalLogons = count()\n| extend Label = 'Total Logon Events'",
              "size": 4,
              "title": "Total Logon Events",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "Label" },
                "leftContent": { "columnMatch": "TotalLogons", "formatter": 12, "numberFormat": { "unit": 17, "options": { "style": "decimal", "maximumFractionDigits": 0 } } },
                "showBorder": true
              }
            },
            "customWidth": "20",
            "name": "TileTotalLogons"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| summarize SuccessCount = count()\n| extend Label = 'Successful'",
              "size": 4,
              "title": "Successful Logons",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "Label" },
                "leftContent": { "columnMatch": "SuccessCount", "formatter": 12, "formatOptions": { "palette": "green" }, "numberFormat": { "unit": 17, "options": { "style": "decimal", "maximumFractionDigits": 0 } } },
                "showBorder": true
              }
            },
            "customWidth": "20",
            "name": "TileSuccess"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4625\n| summarize FailedCount = count()\n| extend Label = 'Failed'",
              "size": 4,
              "title": "Failed Logons",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "Label" },
                "leftContent": { "columnMatch": "FailedCount", "formatter": 12, "formatOptions": { "palette": "red" }, "numberFormat": { "unit": 17, "options": { "style": "decimal", "maximumFractionDigits": 0 } } },
                "showBorder": true
              }
            },
            "customWidth": "20",
            "name": "TileFailed"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4740\n| summarize LockedAccounts = dcount(TargetUserName)\n| extend Label = 'Locked Accounts'",
              "size": 4,
              "title": "Account Lockouts",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "Label" },
                "leftContent": { "columnMatch": "LockedAccounts", "formatter": 12, "formatOptions": { "palette": "orange" }, "numberFormat": { "unit": 17, "options": { "style": "decimal", "maximumFractionDigits": 0 } } },
                "showBorder": true
              }
            },
            "customWidth": "20",
            "name": "TileLockouts"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4720, 4722, 4723, 4724, 4725, 4726, 4727, 4728, 4729, 4730, 4731, 4732, 4733, 4734, 4735, 4737, 4738, 4741, 4742, 4743)\n| summarize ADChanges = count()\n| extend Label = 'AD Changes'",
              "size": 4,
              "title": "AD Changes",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "Label" },
                "leftContent": { "columnMatch": "ADChanges", "formatter": 12, "formatOptions": { "palette": "purple" }, "numberFormat": { "unit": 17, "options": { "style": "decimal", "maximumFractionDigits": 0 } } },
                "showBorder": true
              }
            },
            "customWidth": "20",
            "name": "TileADChanges"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìà 7-Day Baseline Comparison\n\nCompare current security event activity against the previous 7-day baseline to identify anomalies and deviations."
            },
            "name": "BaselineHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// 7-Day Baseline Deviation Analysis\nlet CurrentCount = toscalar(SecurityEvent\n    | where TimeGenerated >= ago(7d)\n    | where EventID in (4624, 4625)\n    | summarize count());\nlet PreviousCount = toscalar(SecurityEvent\n    | where TimeGenerated between (ago(14d) .. ago(7d))\n    | where EventID in (4624, 4625)\n    | summarize count());\nlet CurrentFailed = toscalar(SecurityEvent\n    | where TimeGenerated >= ago(7d)\n    | where EventID == 4625\n    | summarize count());\nlet PreviousFailed = toscalar(SecurityEvent\n    | where TimeGenerated between (ago(14d) .. ago(7d))\n    | where EventID == 4625\n    | summarize count());\nlet TotalDeviation = round((todouble(CurrentCount - PreviousCount) / PreviousCount) * 100, 2);\nlet FailedDeviation = round((todouble(CurrentFailed - PreviousFailed) / PreviousFailed) * 100, 2);\nprint \n    CurrentWeekTotal = CurrentCount,\n    BaselineWeekTotal = PreviousCount,\n    TotalDeviationPct = TotalDeviation,\n    CurrentWeekFailed = CurrentFailed,\n    BaselineWeekFailed = PreviousFailed,\n    FailedDeviationPct = FailedDeviation\n| extend TotalStatus = case(\n    TotalDeviation > 50, 'Critical Spike',\n    TotalDeviation > 20, 'Significant Increase',\n    TotalDeviation < -20, 'Significant Decrease',\n    'Within Normal Range'\n)\n| extend FailedStatus = case(\n    FailedDeviation > 100, 'Attack Detected',\n    FailedDeviation > 50, 'Elevated Failures',\n    FailedDeviation < -20, 'Improved Security',\n    'Normal')",
              "size": 4,
              "title": "üìä 7-Day Baseline Deviation",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "TotalStatus", "formatter": 1 },
                "leftContent": { "columnMatch": "TotalDeviationPct", "formatter": 12, "formatOptions": { "palette": "greenRed" }, "numberFormat": { "unit": 1, "options": { "style": "decimal", "maximumFractionDigits": 2 } } },
                "secondaryContent": { "columnMatch": "FailedStatus", "formatter": 1 },
                "showBorder": true
              }
            },
            "customWidth": "50",
            "name": "BaselineDeviationTile"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// 7-Day Baseline Trend Comparison\nSecurityEvent\n| where TimeGenerated >= ago(14d)\n| where EventID in (4624, 4625)\n| extend Period = iff(TimeGenerated >= ago(7d), 'Current Week', 'Baseline Week')\n| extend DayOffset = iff(TimeGenerated >= ago(7d), datetime_diff('day', now(), TimeGenerated), datetime_diff('day', ago(7d), TimeGenerated))\n| summarize EventCount = count() by Period, DayOffset\n| extend Day = 7 - DayOffset\n| project Day, EventCount, Period\n| order by Period, Day asc",
              "size": 0,
              "title": "üìà Current vs Baseline Activity (7-Day Comparison)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "linechart",
              "chartSettings": {
                "xAxis": "Day",
                "yAxis": ["EventCount"],
                "group": "Period",
                "createOtherGroup": false
              }
            },
            "customWidth": "50",
            "name": "BaselineTrendChart"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Authentication Timeline\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4625)\n| extend Status = case(EventID == 4624, 'Success', 'Failed')\n| summarize Count = count() by bin(TimeGenerated, 1h), Status\n| render timechart",
              "size": 0,
              "title": "üìà Authentication Timeline (Success vs Failed)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "name": "AuthTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Logon Type Distribution\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| extend LogonTypeDesc = case(\n    LogonType == 2, 'Interactive',\n    LogonType == 3, 'Network',\n    LogonType == 4, 'Batch',\n    LogonType == 5, 'Service',\n    LogonType == 7, 'Unlock',\n    LogonType == 8, 'NetworkCleartext',\n    LogonType == 9, 'NewCredentials',\n    LogonType == 10, 'RemoteInteractive',\n    LogonType == 11, 'CachedInteractive',\n    'Other'\n)\n| summarize Count = count() by LogonTypeDesc\n| order by Count desc",
              "size": 2,
              "title": "Logon Type Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "LogonTypeDistribution"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Authentication Protocol Distribution\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| extend Protocol = case(\n    AuthenticationPackageName has 'Kerberos', 'Kerberos',\n    AuthenticationPackageName has 'NTLM', 'NTLM',\n    AuthenticationPackageName has 'Negotiate', 'Negotiate',\n    'Other'\n)\n| summarize Count = count() by Protocol\n| order by Count desc",
              "size": 2,
              "title": "Authentication Protocol",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "AuthProtocolDistribution"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Domain Controllers by Event Volume\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4625, 4768, 4769, 4770, 4771)\n| summarize EventCount = count() by Computer\n| order by EventCount desc\n| take 10",
              "size": 2,
              "title": "Top Domain Controllers",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "34",
            "name": "TopDCs"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Critical Security Events Summary\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (\n    4624, 4625, 4648, 4672, 4720, 4722, 4723, 4724, 4725, 4726,\n    4728, 4732, 4740, 4756, 4768, 4769, 4771, 4776, 5136, 5137\n)\n| extend EventDescription = case(\n    EventID == 4624, 'Successful Logon',\n    EventID == 4625, 'Failed Logon',\n    EventID == 4648, 'Explicit Credential Logon',\n    EventID == 4672, 'Special Privileges Assigned',\n    EventID == 4720, 'User Account Created',\n    EventID == 4722, 'User Account Enabled',\n    EventID == 4723, 'Password Change Attempt',\n    EventID == 4724, 'Password Reset Attempt',\n    EventID == 4725, 'User Account Disabled',\n    EventID == 4726, 'User Account Deleted',\n    EventID == 4728, 'Member Added to Security Group',\n    EventID == 4732, 'Member Added to Local Group',\n    EventID == 4740, 'Account Locked Out',\n    EventID == 4756, 'Member Added to Universal Group',\n    EventID == 4768, 'Kerberos TGT Request',\n    EventID == 4769, 'Kerberos Service Ticket Request',\n    EventID == 4771, 'Kerberos Pre-Auth Failed',\n    EventID == 4776, 'NTLM Authentication',\n    EventID == 5136, 'Directory Object Modified',\n    EventID == 5137, 'Directory Object Created',\n    'Other'\n)\n| summarize Count = count() by EventID, EventDescription\n| order by Count desc\n| take 15",
              "size": 0,
              "title": "üìã Security Event Summary",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SecurityEventSummary"
          },
          {
            "type": 1,
            "content": {
              "json": "### üñ•Ô∏è Remote Desktop (RDP) Analysis\n\nMonitor RDP connections with internal vs external source classification."
            },
            "name": "RDPAnalysisHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// RDP Connections - Internal vs External\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where LogonType == 10\n| extend SourceType = case(\n    ipv4_is_private(IpAddress), 'Internal',\n    isempty(IpAddress) or IpAddress == '-' or IpAddress == '127.0.0.1' or IpAddress == '::1', 'Local',\n    'External'\n)\n| summarize Count = count() by SourceType",
              "size": 2,
              "title": "üñ•Ô∏è RDP Connections by Source Type",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  { "seriesName": "Internal", "color": "green" },
                  { "seriesName": "External", "color": "red" },
                  { "seriesName": "Local", "color": "blue" }
                ]
              }
            },
            "customWidth": "33",
            "name": "RDPSourceTypePie"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Logon Success by Source Type (Internal vs External)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where isnotempty(IpAddress) and IpAddress != '-'\n| extend SourceType = case(\n    ipv4_is_private(IpAddress), 'Internal',\n    IpAddress == '127.0.0.1' or IpAddress == '::1', 'Local',\n    'External'\n)\n| summarize Count = count() by SourceType",
              "size": 2,
              "title": "‚úÖ Successful Logons by Source",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  { "seriesName": "Internal", "color": "green" },
                  { "seriesName": "External", "color": "orange" },
                  { "seriesName": "Local", "color": "blue" }
                ]
              }
            },
            "customWidth": "33",
            "name": "SuccessLogonSourcePie"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Failed Logons by Source Type (Internal vs External)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4625\n| where isnotempty(IpAddress) and IpAddress != '-'\n| extend SourceType = case(\n    ipv4_is_private(IpAddress), 'Internal',\n    IpAddress == '127.0.0.1' or IpAddress == '::1', 'Local',\n    'External'\n)\n| summarize Count = count() by SourceType",
              "size": 2,
              "title": "‚ùå Failed Logons by Source",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  { "seriesName": "Internal", "color": "yellow" },
                  { "seriesName": "External", "color": "red" },
                  { "seriesName": "Local", "color": "blue" }
                ]
              }
            },
            "customWidth": "34",
            "name": "FailedLogonSourcePie"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// RDP Connections Detail\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where LogonType == 10\n| extend SourceType = case(\n    ipv4_is_private(IpAddress), 'Internal',\n    isempty(IpAddress) or IpAddress == '-' or IpAddress == '127.0.0.1', 'Local',\n    'External'\n)\n| extend GeoInfo = geo_info_from_ip_address(IpAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| summarize \n    RDPConnections = count(),\n    UniqueIPs = dcount(IpAddress),\n    IPs = make_set(IpAddress, 5),\n    Countries = make_set(Country, 3),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by Account, Computer, SourceType\n| extend RiskLevel = case(\n    SourceType == 'External' and RDPConnections > 10, 'üî¥ High - External RDP',\n    SourceType == 'External', 'üü° Medium - External',\n    RDPConnections > 100, 'üü° Review - High Volume',\n    'üü¢ Normal'\n)\n| order by RDPConnections desc\n| take 30",
              "size": 0,
              "title": "üñ•Ô∏è RDP Connection Details (Internal vs External)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "RDPConnectionDetails"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Internal vs External Logon Trend\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4625)\n| where isnotempty(IpAddress) and IpAddress != '-'\n| extend SourceType = case(\n    ipv4_is_private(IpAddress), 'Internal',\n    IpAddress == '127.0.0.1' or IpAddress == '::1', 'Local',\n    'External'\n)\n| extend Status = iff(EventID == 4624, 'Success', 'Failed')\n| extend Category = strcat(SourceType, ' - ', Status)\n| summarize Count = count() by bin(TimeGenerated, 1h), Category\n| render timechart",
              "size": 0,
              "title": "üìà Internal vs External Logon Trend",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "InternalExternalTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// External RDP Timeline\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where LogonType == 10\n| where not(ipv4_is_private(IpAddress))\n| where IpAddress != '-' and IpAddress != '127.0.0.1' and IpAddress != '::1'\n| summarize Count = count() by bin(TimeGenerated, 1h)\n| render timechart",
              "size": 0,
              "title": "‚ö†Ô∏è External RDP Connections Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "ExternalRDPTimeline"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìã Audit Configuration Inventory\n\nCurrent audit event coverage based on detected events in the selected time range."
            },
            "name": "AuditInventoryHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Audit Event Inventory by Category\nlet AuditCategories = datatable(EventID:int, Category:string, Subcategory:string, Description:string) [\n    4624, 'Logon/Logoff', 'Logon', 'Successful Logon',\n    4625, 'Logon/Logoff', 'Logon', 'Failed Logon',\n    4634, 'Logon/Logoff', 'Logoff', 'Account Logoff',\n    4647, 'Logon/Logoff', 'Logoff', 'User Initiated Logoff',\n    4648, 'Logon/Logoff', 'Logon', 'Explicit Credentials Logon',\n    4672, 'Logon/Logoff', 'Special Logon', 'Special Privileges Assigned',\n    4720, 'Account Management', 'User Account', 'User Account Created',\n    4722, 'Account Management', 'User Account', 'User Account Enabled',\n    4723, 'Account Management', 'User Account', 'Password Change Attempt',\n    4724, 'Account Management', 'User Account', 'Password Reset',\n    4725, 'Account Management', 'User Account', 'User Account Disabled',\n    4726, 'Account Management', 'User Account', 'User Account Deleted',\n    4738, 'Account Management', 'User Account', 'User Account Changed',\n    4728, 'Account Management', 'Security Group', 'Member Added to Global Group',\n    4729, 'Account Management', 'Security Group', 'Member Removed from Global Group',\n    4732, 'Account Management', 'Security Group', 'Member Added to Local Group',\n    4733, 'Account Management', 'Security Group', 'Member Removed from Local Group',\n    4756, 'Account Management', 'Security Group', 'Member Added to Universal Group',\n    4757, 'Account Management', 'Security Group', 'Member Removed from Universal Group',\n    4740, 'Account Management', 'User Account', 'Account Locked Out',\n    4741, 'Account Management', 'Computer Account', 'Computer Account Created',\n    4742, 'Account Management', 'Computer Account', 'Computer Account Changed',\n    4743, 'Account Management', 'Computer Account', 'Computer Account Deleted',\n    4768, 'Account Logon', 'Kerberos Auth', 'TGT Requested',\n    4769, 'Account Logon', 'Kerberos Service', 'Service Ticket Requested',\n    4770, 'Account Logon', 'Kerberos Service', 'Service Ticket Renewed',\n    4771, 'Account Logon', 'Kerberos Auth', 'Pre-Authentication Failed',\n    4776, 'Account Logon', 'Credential Validation', 'NTLM Authentication',\n    5136, 'DS Access', 'Directory Service', 'Object Modified',\n    5137, 'DS Access', 'Directory Service', 'Object Created',\n    5141, 'DS Access', 'Directory Service', 'Object Deleted',\n    1102, 'System', 'Security Log', 'Audit Log Cleared'\n];\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| summarize EventCount = count(), LastSeen = max(TimeGenerated) by EventID\n| join kind=leftouter (AuditCategories) on EventID\n| extend Category = coalesce(Category, 'Other')\n| extend Subcategory = coalesce(Subcategory, 'Unknown')\n| extend Description = coalesce(Description, strcat('Event ', EventID))\n| extend Status = 'üü¢ Active'\n| project EventID, Category, Subcategory, Description, EventCount, LastSeen, Status\n| order by Category asc, EventCount desc",
              "size": 0,
              "title": "üìã Active Audit Events Inventory",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "AuditInventory"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Audit Coverage by Category\nlet AuditCategories = datatable(EventID:int, Category:string) [\n    4624, 'Logon/Logoff',\n    4625, 'Logon/Logoff',\n    4634, 'Logon/Logoff',\n    4648, 'Logon/Logoff',\n    4672, 'Logon/Logoff',\n    4720, 'Account Management',\n    4722, 'Account Management',\n    4723, 'Account Management',\n    4724, 'Account Management',\n    4725, 'Account Management',\n    4726, 'Account Management',\n    4728, 'Account Management',\n    4732, 'Account Management',\n    4740, 'Account Management',\n    4741, 'Account Management',\n    4768, 'Account Logon',\n    4769, 'Account Logon',\n    4771, 'Account Logon',\n    4776, 'Account Logon',\n    5136, 'DS Access',\n    5137, 'DS Access',\n    5141, 'DS Access'\n];\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| summarize EventCount = count() by EventID\n| join kind=inner (AuditCategories) on EventID\n| summarize TotalEvents = sum(EventCount), UniqueEventTypes = dcount(EventID) by Category\n| order by TotalEvents desc",
              "size": 2,
              "title": "üìä Audit Event Distribution by Category",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "AuditCategoryPie"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Required vs Detected Audit Events\nlet RequiredEvents = datatable(EventID:int, Category:string, Priority:string) [\n    4624, 'Logon', 'Critical',\n    4625, 'Logon', 'Critical',\n    4648, 'Logon', 'High',\n    4672, 'Special Logon', 'High',\n    4720, 'User Management', 'Critical',\n    4726, 'User Management', 'Critical',\n    4728, 'Group Management', 'Critical',\n    4732, 'Group Management', 'Critical',\n    4740, 'Account Lockout', 'High',\n    4768, 'Kerberos', 'High',\n    4769, 'Kerberos', 'Medium',\n    4771, 'Kerberos', 'High',\n    4776, 'NTLM', 'High',\n    5136, 'Directory Service', 'High'\n];\nlet DetectedEvents = SecurityEvent\n    | where TimeGenerated {TimeRange}\n    | distinct EventID;\nRequiredEvents\n| join kind=leftouter (DetectedEvents) on EventID\n| extend Detected = iff(isnotempty(EventID1), 'üü¢ Yes', 'üî¥ No')\n| project EventID, Category, Priority, Detected\n| order by Priority asc, Category asc",
              "size": 0,
              "title": "‚úÖ Required Audit Events Coverage",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "RequiredAuditCoverage"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "overview"
      },
      "name": "OverviewGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üîê Authentication Analysis\n---\nDetailed analysis of authentication events including successful and failed logons, account lockouts, and authentication patterns."
            },
            "name": "AuthHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Accounts by Logon Activity\nlet TrustedCountries = dynamic(['United States', 'Canada', 'United Kingdom', 'Germany', 'France', 'Netherlands', 'Australia']);\nlet TrustedIPRanges = dynamic(['10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16']);\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4625)\n| extend GeoInfo = geo_info_from_ip_address(IpAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend IsTrustedIP = ipv4_is_private(IpAddress)\n| extend IsTrustedCountry = Country in (TrustedCountries)\n| extend TrustedLocation = case(\n    IsTrustedIP, 'Trusted IP',\n    IsTrustedCountry, 'Trusted Country',\n    isempty(IpAddress) or IpAddress == '-', 'Local',\n    'Untrusted'\n)\n| summarize \n    TotalLogons = count(),\n    SuccessCount = countif(EventID == 4624),\n    FailedCount = countif(EventID == 4625),\n    UniqueIPs = dcount(IpAddress),\n    UniqueComputers = dcount(Computer),\n    TrustedLogons = countif(TrustedLocation != 'Untrusted'),\n    UntrustedLogons = countif(TrustedLocation == 'Untrusted'),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by Account\n| extend FailureRate = round(todouble(FailedCount) / TotalLogons * 100, 2)\n| extend TrustedPct = round(todouble(TrustedLogons) / TotalLogons * 100, 2)\n| extend RiskLevel = case(\n    FailureRate > 80, 'üî¥ High - Mostly Failed',\n    UntrustedLogons > 100, 'üî¥ High - Many Untrusted',\n    FailureRate > 50, 'üü° Medium - High Failure',\n    TrustedPct < 50, 'üü° Medium - Mixed Locations',\n    'üü¢ Normal'\n)\n| order by TotalLogons desc\n| take 50",
              "size": 0,
              "title": "üë§ Top Accounts by Logon Activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "TopAccountsLogon"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Failed Logons by Reason\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4625\n| extend FailureReason = case(\n    Status == '0xC000006D', 'Bad username or password',\n    Status == '0xC000006A', 'Incorrect password',\n    Status == '0xC0000064', 'User does not exist',\n    Status == '0xC000006F', 'Outside authorized hours',\n    Status == '0xC0000070', 'Unauthorized workstation',\n    Status == '0xC0000071', 'Expired password',\n    Status == '0xC0000072', 'Account disabled',\n    Status == '0xC0000234', 'Account locked out',\n    Status == '0xC0000193', 'Account expired',\n    Status == '0xC000015B', 'Logon type not granted',\n    Status == '0xC0000224', 'Password must change',\n    Status == '0xC0000225', 'Windows bug',\n    strcat('Status: ', Status)\n)\n| summarize \n    Count = count(),\n    UniqueAccounts = dcount(Account),\n    UniqueIPs = dcount(IpAddress),\n    SampleAccounts = make_set(Account, 5)\n    by FailureReason, Status\n| order by Count desc",
              "size": 0,
              "title": "‚ùå Failed Logons by Reason",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "FailedLogonReasons"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top IPs with Failed Logons\nlet TrustedCountries = dynamic(['United States', 'Canada', 'United Kingdom', 'Germany', 'France', 'Netherlands', 'Australia']);\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4625\n| where isnotempty(IpAddress) and IpAddress != '-'\n| extend GeoInfo = geo_info_from_ip_address(IpAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| extend IsPrivateIP = ipv4_is_private(IpAddress)\n| extend IsExternal = not(IsPrivateIP)\n| extend IsTrustedCountry = Country in (TrustedCountries)\n| extend TrustedLocation = case(\n    IsPrivateIP, 'üü¢ Trusted - Internal',\n    IsTrustedCountry, 'üü° Trusted - Country',\n    'üî¥ Untrusted'\n)\n| summarize \n    FailedAttempts = count(),\n    UniqueAccounts = dcount(Account),\n    TargetAccounts = make_set(Account, 10),\n    UniqueComputers = dcount(Computer),\n    TargetComputers = make_set(Computer, 5),\n    FirstAttempt = min(TimeGenerated),\n    LastAttempt = max(TimeGenerated)\n    by IpAddress, Country, City, IsPrivateIP, IsExternal, TrustedLocation\n| extend RiskLevel = case(\n    TrustedLocation == 'üî¥ Untrusted' and FailedAttempts > 50, 'üî¥ Critical - Untrusted Attack',\n    IsExternal and FailedAttempts > 100, 'üî¥ Critical - External Attack',\n    FailedAttempts > 500 and UniqueAccounts > 20, 'üî¥ Critical - Password Spray',\n    FailedAttempts > 100 and UniqueAccounts > 10, 'üî¥ High - Brute Force',\n    IsExternal and FailedAttempts > 10, 'üü° Medium - External Suspicious',\n    FailedAttempts > 50, 'üü° Medium - Suspicious',\n    FailedAttempts > 10, 'üü° Low - Monitor',\n    'üü¢ Normal'\n)\n| extend IPType = iff(IsExternal, 'üåê External', 'üè† Internal')\n| project IpAddress, IPType, TrustedLocation, Country, City, RiskLevel, FailedAttempts, UniqueAccounts, UniqueComputers, TargetAccounts, FirstAttempt, LastAttempt\n| order by TrustedLocation desc, FailedAttempts desc\n| take 50",
              "size": 0,
              "title": "üåê Top IPs with Failed Logons",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "TopIPsFailedLogon"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Devices with Failed Logons\nlet TrustedCountries = dynamic(['United States', 'Canada', 'United Kingdom', 'Germany', 'France', 'Netherlands', 'Australia']);\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4625\n| extend GeoInfo = geo_info_from_ip_address(IpAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend IsPrivateIP = ipv4_is_private(IpAddress)\n| extend IsExternal = not(IsPrivateIP) and isnotempty(IpAddress) and IpAddress != '-'\n| extend IsTrustedCountry = Country in (TrustedCountries)\n| extend IPTrustLevel = case(\n    IsPrivateIP or isempty(IpAddress) or IpAddress == '-', 'Internal',\n    IsTrustedCountry, 'TrustedCountry',\n    'Untrusted'\n)\n| summarize \n    FailedAttempts = count(),\n    UniqueAccounts = dcount(Account),\n    TargetAccounts = make_set(Account, 10),\n    UniqueSourceIPs = dcount(IpAddress),\n    SourceIPs = make_set(IpAddress, 5),\n    InternalIPs = dcountif(IpAddress, IsPrivateIP),\n    ExternalIPs = dcountif(IpAddress, IsExternal),\n    UntrustedIPs = dcountif(IpAddress, IPTrustLevel == 'Untrusted'),\n    UntrustedAttempts = countif(IPTrustLevel == 'Untrusted'),\n    FirstAttempt = min(TimeGenerated),\n    LastAttempt = max(TimeGenerated),\n    FailureReasons = make_set(Status, 5)\n    by Computer\n| extend TrustedLocation = case(\n    UntrustedIPs > 0, strcat('üî¥ ', UntrustedIPs, ' Untrusted IPs'),\n    ExternalIPs > 0, strcat('üü° ', ExternalIPs, ' External IPs'),\n    'üü¢ Internal Only'\n)\n| extend RiskLevel = case(\n    UntrustedAttempts > 100, 'üî¥ Critical - Untrusted Attack',\n    FailedAttempts > 1000, 'üî¥ Critical - Under Attack',\n    FailedAttempts > 500, 'üî¥ High - Heavy Failures',\n    UntrustedIPs > 0, 'üü° Medium - Untrusted Sources',\n    FailedAttempts > 100, 'üü° Medium - Elevated',\n    FailedAttempts > 20, 'üü° Low - Monitor',\n    'üü¢ Normal'\n)\n| extend FailureRate = round(todouble(FailedAttempts) / UniqueAccounts, 1)\n| project Computer, RiskLevel, TrustedLocation, FailedAttempts, UntrustedAttempts, UniqueAccounts, FailureRate, UniqueSourceIPs, ExternalIPs, UntrustedIPs, SourceIPs, FailureReasons, FirstAttempt, LastAttempt\n| order by UntrustedIPs desc, FailedAttempts desc\n| take 50",
              "size": 0,
              "title": "üñ•Ô∏è Top Devices with Failed Logons",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "TopDevicesFailedLogon"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Failed Logon Heatmap by Hour and Day\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4625\n| extend Hour = datetime_part('hour', TimeGenerated)\n| extend DayOfWeek = dayofweek(TimeGenerated) / 1d\n| extend DayName = case(\n    DayOfWeek == 0, 'Sunday',\n    DayOfWeek == 1, 'Monday',\n    DayOfWeek == 2, 'Tuesday',\n    DayOfWeek == 3, 'Wednesday',\n    DayOfWeek == 4, 'Thursday',\n    DayOfWeek == 5, 'Friday',\n    'Saturday'\n)\n| summarize FailedCount = count() by DayName, Hour\n| order by Hour asc",
              "size": 0,
              "title": "üìä Failed Logon Heatmap (Day/Hour)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "FailedLogonHeatmap"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Failed Logon Trend by IP Type\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4625\n| where isnotempty(IpAddress) and IpAddress != '-'\n| extend IPType = iff(ipv4_is_private(IpAddress), 'Internal', 'External')\n| summarize FailedCount = count() by bin(TimeGenerated, 1h), IPType\n| render timechart",
              "size": 0,
              "title": "üìà Failed Logon Trend (Internal vs External)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "FailedLogonTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Account Lockouts\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4740\n| summarize \n    LockoutCount = count(),\n    SourceComputers = make_set(Computer, 5),\n    FirstLockout = min(TimeGenerated),\n    LastLockout = max(TimeGenerated)\n    by TargetUserName, TargetDomainName\n| extend RiskLevel = case(\n    LockoutCount > 10, 'üî¥ High - Repeated Lockouts',\n    LockoutCount > 5, 'üü° Medium - Multiple Lockouts',\n    'üü° Low - Single Lockout'\n)\n| order by LockoutCount desc",
              "size": 0,
              "title": "üîë Account Lockouts",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "AccountLockouts"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Explicit Credential Logons (RunAs, Scheduled Tasks)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4648\n| summarize \n    Count = count(),\n    TargetServers = make_set(TargetServerName, 10),\n    UniqueTargets = dcount(TargetServerName),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by Account, Computer\n| extend RiskLevel = case(\n    UniqueTargets > 10, 'üî¥ High - Many Targets',\n    UniqueTargets > 5, 'üü° Medium - Multiple Targets',\n    'üü¢ Normal'\n)\n| order by Count desc\n| take 30",
              "size": 0,
              "title": "üîë Explicit Credential Logons (4648)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "ExplicitCredentialLogons"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Remote Desktop Logons\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where LogonType == 10\n| extend GeoInfo = geo_info_from_ip_address(IpAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| summarize \n    RDPLogons = count(),\n    UniqueIPs = dcount(IpAddress),\n    IPs = make_set(IpAddress, 5),\n    Countries = make_set(Country, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by Account, Computer\n| order by RDPLogons desc\n| take 30",
              "size": 0,
              "title": "üñ•Ô∏è Remote Desktop (RDP) Logons",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "RDPLogons"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Account Logons\nlet ServiceAccountKeywords = dynamic(['svc', 'service', '_sa', '-sa', 'app', 'sql', 'admin', 'backup']);\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where Account has_any (ServiceAccountKeywords)\n| summarize \n    LogonCount = count(),\n    UniqueComputers = dcount(Computer),\n    Computers = make_set(Computer, 10),\n    LogonTypes = make_set(LogonType),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by Account\n| extend ServiceRisk = case(\n    LogonCount > 1000, 'üü° High Volume - Review',\n    LogonCount > 100, 'üü¢ Normal',\n    'üü¢ Low Usage'\n)\n| order by LogonCount desc",
              "size": 0,
              "title": "‚öôÔ∏è Service Account Logons",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ServiceAccountLogons"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// After-Hours Authentication\nlet BusinessHoursStart = 7;\nlet BusinessHoursEnd = 19;\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| extend Hour = datetime_part('Hour', TimeGenerated)\n| extend DayOfWeek = dayofweek(TimeGenerated) / 1d\n| extend IsAfterHours = case(\n    DayOfWeek >= 5, 'Weekend',\n    Hour < BusinessHoursStart or Hour > BusinessHoursEnd, 'After Hours',\n    'Business Hours'\n)\n| where IsAfterHours != 'Business Hours'\n| summarize \n    LogonCount = count(),\n    UniqueComputers = dcount(Computer),\n    UniqueIPs = dcount(IpAddress),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by Account, IsAfterHours\n| extend RiskLevel = case(\n    LogonCount > 100, 'üü¢ High - Investigate',\n    LogonCount > 20, 'üü° Medium - Review',\n    'üü¢ Low'\n)\n| order by LogonCount desc\n| take 30",
              "size": 0,
              "title": "üìÑ After-Hours Authentication",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "AfterHoursAuth"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "auth"
      },
      "name": "AuthGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üëë Privileged Access Monitoring\n---\nMonitor privileged account usage, special privilege assignments, and administrative actions."
            },
            "name": "PrivilegedHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Special Privileges Assigned (4672)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4672\n| summarize \n    PrivilegedLogons = count(),\n    UniqueComputers = dcount(Computer),\n    Computers = make_set(Computer, 10),\n    UniqueIPs = dcount(IpAddress),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by Account\n| order by PrivilegedLogons desc\n| take 30",
              "size": 0,
              "title": "üëë Accounts with Special Privileges Assigned (4672)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SpecialPrivileges"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Privileged Account Activity (Domain Admins, Enterprise Admins, etc.)\nlet PrivilegedGroups = dynamic(['Domain Admins', 'Enterprise Admins', 'Schema Admins', 'Administrators', 'Backup Operators', 'Account Operators']);\nlet PrivilegedKeywords = dynamic(['admin', 'administrator', 'domain admin', 'enterprise admin']);\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where Account has_any (PrivilegedKeywords) or Account contains 'admin'\n| extend GeoInfo = geo_info_from_ip_address(IpAddress)\n| extend Country = tostring(GeoInfo.country)\n| summarize \n    LogonCount = count(),\n    UniqueIPs = dcount(IpAddress),\n    IPs = make_set(IpAddress, 5),\n    UniqueComputers = dcount(Computer),\n    Computers = make_set(Computer, 10),\n    Countries = make_set(Country, 5),\n    LogonTypes = make_set(LogonType),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by Account\n| extend RiskLevel = case(\n    UniqueIPs > 10, 'üî¥ High - Many Source IPs',\n    UniqueComputers > 20, 'üü° Medium - Many Targets',\n    'üü¢ Normal'\n)\n| order by LogonCount desc",
              "size": 0,
              "title": "‚ö†Ô∏è Privileged Account Logons",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "PrivilegedAccountLogons"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Sensitive Group Membership Changes\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4728, 4729, 4732, 4733, 4756, 4757)\n| extend ChangeType = case(\n    EventID == 4728, 'Member Added to Security-Enabled Global Group',\n    EventID == 4729, 'Member Removed from Security-Enabled Global Group',\n    EventID == 4732, 'Member Added to Security-Enabled Local Group',\n    EventID == 4733, 'Member Removed from Security-Enabled Local Group',\n    EventID == 4756, 'Member Added to Security-Enabled Universal Group',\n    EventID == 4757, 'Member Removed from Security-Enabled Universal Group',\n    'Other'\n)\n| extend IsAddition = EventID in (4728, 4732, 4756)\n| project TimeGenerated, Computer, Account, TargetUserName, ChangeType, IsAddition, TargetAccount, SubjectUserName\n| order by TimeGenerated desc\n| take 50",
              "size": 0,
              "title": "üë• Security Group Membership Changes",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "GroupMembershipChanges"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Privileged Account Timeline\nlet PrivilegedKeywords = dynamic(['admin', 'administrator']);\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where Account has_any (PrivilegedKeywords) or Account contains 'admin'\n| summarize Count = count() by bin(TimeGenerated, 1h), Account\n| where Account in (\n    SecurityEvent\n    | where TimeGenerated {TimeRange}\n    | where EventID == 4624\n    | where Account has_any (PrivilegedKeywords) or Account contains 'admin'\n    | summarize TotalCount = count() by Account\n    | top 5 by TotalCount\n    | project Account\n)\n| render timechart",
              "size": 0,
              "title": "üìà Top 5 Privileged Account Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "PrivilegedAccountTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Privileged Logons from New Locations\nlet PrivilegedKeywords = dynamic(['admin', 'administrator']);\nlet TrustedCountries = dynamic(['United States', 'Canada', 'United Kingdom', 'Germany', 'France']);\nlet BaselineLocations = SecurityEvent\n| where TimeGenerated between (ago(60d) .. ago(7d))\n| where EventID == 4624\n| where Account has_any (PrivilegedKeywords) or Account contains 'admin'\n| extend GeoInfo = geo_info_from_ip_address(IpAddress)\n| extend Country = tostring(GeoInfo.country)\n| where isnotempty(Country)\n| distinct Account, Country;\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where Account has_any (PrivilegedKeywords) or Account contains 'admin'\n| extend GeoInfo = geo_info_from_ip_address(IpAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| where isnotempty(Country)\n| join kind=leftanti (BaselineLocations) on Account, Country\n| summarize \n    LogonCount = count(),\n    IPs = make_set(IpAddress, 5),\n    Cities = make_set(City, 5),\n    FirstSeen = min(TimeGenerated)\n    by Account, Country\n| extend IsTrusted = iff(Country in (TrustedCountries), 'üü° Trusted Country', 'üî¥ Untrusted Country')\n| extend RiskLevel = '‚ö†Ô∏è New Location for Privileged Account'\n| order by LogonCount desc",
              "size": 0,
              "title": "üÜï Privileged Logons from New Locations",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "PrivilegedNewLocations"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Password Changes for Privileged Accounts\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4723, 4724)\n| where TargetUserName contains 'admin' or TargetUserName has_any (dynamic(['svc', 'service']))\n| extend ChangeType = case(\n    EventID == 4723, 'Password Change Attempt',\n    EventID == 4724, 'Password Reset',\n    'Other'\n)\n| project TimeGenerated, Computer, SubjectUserName, TargetUserName, ChangeType, IpAddress\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üîë Password Changes for Sensitive Accounts",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "PrivilegedPasswordChanges"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "privileged"
      },
      "name": "PrivilegedGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üìù Active Directory Changes\n---\nMonitor Active Directory object modifications including user accounts, groups, computer accounts, and directory objects."
            },
            "name": "ADChangesHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// User Account Changes Overview\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4720, 4722, 4723, 4724, 4725, 4726, 4738)\n| extend ChangeType = case(\n    EventID == 4720, 'üÜï Account Created',\n    EventID == 4722, '‚úÖ Account Enabled',\n    EventID == 4723, 'üîë Password Change Attempt',\n    EventID == 4724, 'üîÑ Password Reset',\n    EventID == 4725, '‚õî Account Disabled',\n    EventID == 4726, '‚ùå Account Deleted',\n    EventID == 4738, 'üìù Account Modified',\n    'Other'\n)\n| summarize Count = count() by ChangeType, EventID\n| order by Count desc",
              "size": 0,
              "title": "üë§ User Account Changes Summary",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "UserAccountChangesSummary"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Group Changes Overview\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4727, 4728, 4729, 4730, 4731, 4732, 4733, 4734, 4735, 4737, 4754, 4755, 4756, 4757, 4758)\n| extend ChangeType = case(\n    EventID == 4727, 'Global Group Created',\n    EventID == 4728, 'Member Added to Global Group',\n    EventID == 4729, 'Member Removed from Global Group',\n    EventID == 4730, 'Global Group Deleted',\n    EventID == 4731, 'Local Group Created',\n    EventID == 4732, 'Member Added to Local Group',\n    EventID == 4733, 'Member Removed from Local Group',\n    EventID == 4734, 'Local Group Deleted',\n    EventID == 4735, 'Local Group Changed',\n    EventID == 4737, 'Global Group Changed',\n    EventID == 4754, 'Universal Group Created',\n    EventID == 4755, 'Universal Group Changed',\n    EventID == 4756, 'Member Added to Universal Group',\n    EventID == 4757, 'Member Removed from Universal Group',\n    EventID == 4758, 'Universal Group Deleted',\n    'Other'\n)\n| summarize Count = count() by ChangeType, EventID\n| order by Count desc",
              "size": 0,
              "title": "üë• Group Changes Summary",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "GroupChangesSummary"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// New User Accounts Created\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4720\n| project \n    TimeGenerated,\n    Computer,\n    CreatedBy = SubjectUserName,\n    NewAccount = TargetUserName,\n    NewAccountDomain = TargetDomainName,\n    CreatorDomain = SubjectDomainName\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üÜï New User Accounts Created (4720)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "NewUsersCreated"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Computer Account Changes\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4741, 4742, 4743)\n| extend ChangeType = case(\n    EventID == 4741, 'üñ•Ô∏è Computer Account Created',\n    EventID == 4742, 'üìù Computer Account Changed',\n    EventID == 4743, '‚ùå Computer Account Deleted',\n    'Other'\n)\n| project TimeGenerated, Computer, ChangeType, TargetUserName, SubjectUserName, SubjectDomainName\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üñ•Ô∏è Computer Account Changes",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ComputerAccountChanges"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Directory Service Changes (5136, 5137, 5138, 5139, 5141)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (5136, 5137, 5138, 5139, 5141)\n| extend ChangeType = case(\n    EventID == 5136, 'Object Modified',\n    EventID == 5137, 'Object Created',\n    EventID == 5138, 'Object Undeleted',\n    EventID == 5139, 'Object Moved',\n    EventID == 5141, 'Object Deleted',\n    'Other'\n)\n| summarize Count = count() by ChangeType, EventID\n| order by Count desc",
              "size": 0,
              "title": "üìù Directory Service Changes",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "DirectoryServiceChanges"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AD Changes by Administrator\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4720, 4722, 4723, 4724, 4725, 4726, 4727, 4728, 4729, 4730, 4731, 4732, 4733, 4734, 4738, 4741, 4742, 4743, 5136, 5137)\n| summarize \n    TotalChanges = count(),\n    UsersCreated = countif(EventID == 4720),\n    UsersDeleted = countif(EventID == 4726),\n    GroupMembershipChanges = countif(EventID in (4728, 4729, 4732, 4733, 4756, 4757)),\n    PasswordResets = countif(EventID == 4724),\n    ObjectModifications = countif(EventID == 5136)\n    by SubjectUserName, SubjectDomainName\n| extend FullAccount = strcat(SubjectDomainName, '\\\\', SubjectUserName)\n| order by TotalChanges desc\n| take 20",
              "size": 0,
              "title": "üë§ AD Changes by Administrator",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "ADChangesByAdmin"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AD Changes Timeline\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4720, 4722, 4725, 4726, 4728, 4729, 4732, 4733, 4738)\n| extend ChangeCategory = case(\n    EventID in (4720, 4722, 4725, 4726), 'User Account',\n    EventID in (4728, 4729, 4732, 4733), 'Group Membership',\n    EventID == 4738, 'Account Modification',\n    'Other'\n)\n| summarize Count = count() by bin(TimeGenerated, 1h), ChangeCategory\n| render timechart",
              "size": 0,
              "title": "üìà AD Changes Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "name": "ADChangesTimeline"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "adchanges"
      },
      "name": "ADChangesGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üé´ Kerberos & NTLM Protocol Analysis\n---\nMonitor Kerberos ticket operations, NTLM authentication, encryption types, and protocol-specific security events. This section is part of the Stale Protocols analysis."
            },
            "name": "KerberosHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Kerberos vs NTLM Distribution\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| extend Protocol = case(\n    AuthenticationPackageName has 'Kerberos', 'Kerberos',\n    AuthenticationPackageName has 'NTLM', 'NTLM',\n    AuthenticationPackageName has 'Negotiate', 'Negotiate',\n    'Other'\n)\n| summarize Count = count() by Protocol",
              "size": 2,
              "title": "üîê Kerberos vs NTLM Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "KerberosNTLMPie"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Kerberos Ticket Operations Summary\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4768, 4769, 4770, 4771, 4772, 4773)\n| extend TicketOperation = case(\n    EventID == 4768, 'TGT Request (AS)',\n    EventID == 4769, 'Service Ticket Request (TGS)',\n    EventID == 4770, 'TGT Renewed',\n    EventID == 4771, 'Pre-Auth Failed',\n    EventID == 4772, 'TGT Request Failed',\n    EventID == 4773, 'Service Ticket Request Failed',\n    'Other'\n)\n| summarize Count = count() by TicketOperation, EventID\n| order by Count desc",
              "size": 0,
              "title": "üé´ Kerberos Ticket Operations",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "33",
            "name": "KerberosTicketOps"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Kerberos vs NTLM Trend\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| extend Protocol = case(\n    AuthenticationPackageName has 'Kerberos', 'Kerberos',\n    AuthenticationPackageName has 'NTLM', 'NTLM',\n    'Other'\n)\n| where Protocol in ('Kerberos', 'NTLM')\n| summarize Count = count() by bin(TimeGenerated, 1h), Protocol\n| render timechart",
              "size": 0,
              "title": "üìà Kerberos vs NTLM Trend",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "34",
            "name": "KerberosNTLMTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Kerberos Pre-Authentication Failures (4771)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4771\n| extend FailureCode = case(\n    Status == '0x6', 'Bad password',\n    Status == '0x12', 'Account disabled/expired/locked',\n    Status == '0x17', 'Password expired',\n    Status == '0x18', 'Pre-authentication failed',\n    Status == '0x25', 'Workstation clock skew',\n    strcat('Code: ', Status)\n)\n| summarize \n    FailureCount = count(),\n    UniqueIPs = dcount(IpAddress),\n    IPs = make_set(IpAddress, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by TargetUserName, FailureCode\n| extend RiskLevel = case(\n    FailureCount > 100, 'üî¥ Critical - Brute Force',\n    FailureCount > 20, 'üü¢ High - Attack Pattern',\n    FailureCount > 5, 'üü° Medium - Multiple Failures',\n    'üü¢ Low'\n)\n| order by FailureCount desc\n| take 30",
              "size": 0,
              "title": "‚ùå Kerberos Pre-Authentication Failures (4771)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "KerberosPreAuthFailures"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// NTLM Authentication (4776)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4776\n| extend AuthResult = case(\n    Status == '0x0', 'Success',\n    Status == '0xC0000064', 'User Not Found',\n    Status == '0xC000006A', 'Wrong Password',\n    Status == '0xC0000234', 'Account Locked',\n    Status == '0xC0000072', 'Account Disabled',\n    Status == '0xC000006D', 'Logon Failure',\n    strcat('Error: ', Status)\n)\n| summarize \n    Count = count(),\n    UniqueWorkstations = dcount(Workstation),\n    Workstations = make_set(Workstation, 5)\n    by TargetUserName, AuthResult, Computer\n| extend RiskLevel = case(\n    AuthResult != 'Success' and Count > 50, 'üî¥ High',\n    AuthResult != 'Success' and Count > 10, 'üü° Medium',\n    AuthResult != 'Success', 'üü° Low',\n    'üü¢ Normal'\n)\n| order by Count desc\n| take 50",
              "size": 0,
              "title": "üîë NTLM Authentication (4776)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "NTLMAuthentication"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Kerberos Service Ticket Requests (4769)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4769\n| summarize \n    TicketRequests = count(),\n    UniqueServices = dcount(ServiceName),\n    Services = make_set(ServiceName, 10),\n    UniqueIPs = dcount(IpAddress)\n    by TargetUserName\n| order by TicketRequests desc\n| take 30",
              "size": 0,
              "title": "üé´ Top Kerberos Service Ticket Requesters (4769)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "KerberosServiceTickets"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Potential Kerberoasting (Unusual Service Ticket Requests)\n// Detection based on high volume of service ticket requests to non-machine accounts\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4769\n| where ServiceName !endswith '$'\n| where ServiceName !in ('krbtgt', 'kadmin/changepw')\n| extend EncryptionType = extract('Ticket Encryption Type:\\\\s+(0x[0-9a-fA-F]+)', 1, EventData)\n| extend IsRC4 = EncryptionType in ('0x17', '0x18', '0x17', '0x18') or EventData has '0x17' or EventData has '0x18'\n| summarize \n    TicketCount = count(),\n    UniqueServices = dcount(ServiceName),\n    Services = make_set(ServiceName, 20),\n    UniqueIPs = dcount(IpAddress),\n    IPs = make_set(IpAddress, 5),\n    RC4Requests = countif(IsRC4)\n    by TargetUserName\n| where UniqueServices > 3\n| extend RiskLevel = case(\n    RC4Requests > 0 and UniqueServices > 10, 'üî¥ Critical - Likely Kerberoasting (RC4)',\n    UniqueServices > 10, 'üî¥ Critical - Likely Kerberoasting',\n    UniqueServices > 5, 'üü¢ High - Suspicious Pattern',\n    'üü° Medium - Review'\n)\n| order by UniqueServices desc",
              "size": 0,
              "title": "‚ö†Ô∏è Potential Kerberoasting Detection",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "Kerberoasting"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// NTLM Deprecation Progress\nlet CurrentCount = toscalar(SecurityEvent\n    | where TimeGenerated >= ago(7d)\n    | where EventID == 4624\n    | where AuthenticationPackageName has 'NTLM'\n    | summarize count());\nlet PreviousCount = toscalar(SecurityEvent\n    | where TimeGenerated between (ago(14d) .. ago(7d))\n    | where EventID == 4624\n    | where AuthenticationPackageName has 'NTLM'\n    | summarize count());\nlet PercentChange = round((todouble(CurrentCount - PreviousCount) / PreviousCount) * 100, 2);\nprint Metric = 'NTLM Usage (7-Day Comparison)', CurrentCount = CurrentCount, PreviousCount = PreviousCount, PercentChange = PercentChange\n| extend Trend = case(\n    PercentChange < -20, 'Significant Reduction',\n    PercentChange < 0, 'Decreasing',\n    PercentChange == 0, 'No Change',\n    PercentChange > 20, 'Significant Increase',\n    'Increasing')",
              "size": 4,
              "title": "üìà NTLM Deprecation Progress",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "PercentChange", "formatter": 12, "formatOptions": { "palette": "greenRed" }, "numberFormat": { "unit": 1, "options": { "style": "decimal", "maximumFractionDigits": 2 } } },
                "secondaryContent": { "columnMatch": "Trend", "formatter": 1 },
                "showBorder": true
              }
            },
            "name": "NTLMDeprecation"
          },
          {
            "type": 1,
            "content": {
              "json": "### üîê Kerberos Encryption Type Analysis\n\nMonitor Kerberos ticket encryption types. **DES and RC4 are weak and should be disabled.** AES-256 is the recommended standard."
            },
            "name": "KerberosCipherHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Kerberos Encryption Types from TGT Requests (4768)\n// Encryption Type values:\n// 0x1 = DES-CBC-CRC, 0x3 = DES-CBC-MD5 (Weak - Deprecated)\n// 0x17 = RC4-HMAC (Weak - Should disable)\n// 0x18 = RC4-HMAC-EXP (Weak - Should disable)\n// 0x11 = AES128-CTS-HMAC-SHA1 (Strong)\n// 0x12 = AES256-CTS-HMAC-SHA1 (Strong - Recommended)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4768\n| extend EncryptionTypeRaw = extract('Ticket Encryption Type:\\\\s*(0x[0-9a-fA-F]+)', 1, EventData)\n| extend EncryptionType = case(\n    EncryptionTypeRaw == '0x1', 'DES-CBC-CRC',\n    EncryptionTypeRaw == '0x3', 'DES-CBC-MD5',\n    EncryptionTypeRaw == '0x17', 'RC4-HMAC',\n    EncryptionTypeRaw == '0x18', 'RC4-HMAC-EXP',\n    EncryptionTypeRaw == '0x11', 'AES128-CTS',\n    EncryptionTypeRaw == '0x12', 'AES256-CTS',\n    EncryptionTypeRaw == '0xffffffff', 'Not Specified',\n    isnotempty(EncryptionTypeRaw), strcat('Unknown (', EncryptionTypeRaw, ')'),\n    'Not Available'\n)\n| extend CipherStrength = case(\n    EncryptionType has 'DES', 'üî¥ Weak (DES)',\n    EncryptionType has 'RC4', 'üü† Weak (RC4)',\n    EncryptionType has 'AES128', 'üü° Good (AES128)',\n    EncryptionType has 'AES256', 'üü¢ Strong (AES256)',\n    '‚ö™ Unknown'\n)\n| summarize Count = count() by EncryptionType, CipherStrength\n| order by CipherStrength asc, Count desc",
              "size": 0,
              "title": "üîê Kerberos TGT Encryption Types (4768)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "KerberosTGTEncryption"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Kerberos Service Ticket Encryption Types (4769)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4769\n| extend EncryptionTypeRaw = extract('Ticket Encryption Type:\\\\s*(0x[0-9a-fA-F]+)', 1, EventData)\n| extend EncryptionType = case(\n    EncryptionTypeRaw == '0x1', 'DES-CBC-CRC',\n    EncryptionTypeRaw == '0x3', 'DES-CBC-MD5',\n    EncryptionTypeRaw == '0x17', 'RC4-HMAC',\n    EncryptionTypeRaw == '0x18', 'RC4-HMAC-EXP',\n    EncryptionTypeRaw == '0x11', 'AES128-CTS',\n    EncryptionTypeRaw == '0x12', 'AES256-CTS',\n    EncryptionTypeRaw == '0xffffffff', 'Not Specified',\n    isnotempty(EncryptionTypeRaw), strcat('Unknown (', EncryptionTypeRaw, ')'),\n    'Not Available'\n)\n| extend CipherStrength = case(\n    EncryptionType has 'DES', 'üî¥ Weak (DES)',\n    EncryptionType has 'RC4', 'üü† Weak (RC4)',\n    EncryptionType has 'AES128', 'üü° Good (AES128)',\n    EncryptionType has 'AES256', 'üü¢ Strong (AES256)',\n    '‚ö™ Unknown'\n)\n| summarize Count = count() by EncryptionType, CipherStrength\n| order by CipherStrength asc, Count desc",
              "size": 0,
              "title": "üé´ Kerberos Service Ticket Encryption Types (4769)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "KerberosTGSEncryption"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Weak Cipher Usage Distribution\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4768, 4769)\n| extend EncryptionTypeRaw = extract('Ticket Encryption Type:\\\\s*(0x[0-9a-fA-F]+)', 1, EventData)\n| extend CipherCategory = case(\n    EncryptionTypeRaw in ('0x1', '0x3'), 'DES (Critical)',\n    EncryptionTypeRaw in ('0x17', '0x18'), 'RC4 (Weak)',\n    EncryptionTypeRaw == '0x11', 'AES128 (Good)',\n    EncryptionTypeRaw == '0x12', 'AES256 (Strong)',\n    'Other/Unknown'\n)\n| summarize Count = count() by CipherCategory",
              "size": 2,
              "title": "üìä Kerberos Cipher Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  { "seriesName": "DES (Critical)", "color": "red" },
                  { "seriesName": "RC4 (Weak)", "color": "orange" },
                  { "seriesName": "AES128 (Good)", "color": "yellow" },
                  { "seriesName": "AES256 (Strong)", "color": "green" },
                  { "seriesName": "Other/Unknown", "color": "gray" }
                ]
              }
            },
            "customWidth": "33",
            "name": "CipherDistributionPie"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Weak Cipher Usage Trend\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4768, 4769)\n| extend EncryptionTypeRaw = extract('Ticket Encryption Type:\\\\s*(0x[0-9a-fA-F]+)', 1, EventData)\n| extend CipherCategory = case(\n    EncryptionTypeRaw in ('0x1', '0x3'), 'DES',\n    EncryptionTypeRaw in ('0x17', '0x18'), 'RC4',\n    EncryptionTypeRaw in ('0x11', '0x12'), 'AES',\n    'Other'\n)\n| where CipherCategory in ('DES', 'RC4', 'AES')\n| summarize Count = count() by bin(TimeGenerated, 1h), CipherCategory\n| render timechart",
              "size": 0,
              "title": "üìà Cipher Usage Trend (DES vs RC4 vs AES)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "67",
            "name": "CipherTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Accounts Using Weak Ciphers (DES/RC4)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4768, 4769)\n| extend EncryptionTypeRaw = extract('Ticket Encryption Type:\\\\s*(0x[0-9a-fA-F]+)', 1, EventData)\n| where EncryptionTypeRaw in ('0x1', '0x3', '0x17', '0x18')\n| extend CipherType = case(\n    EncryptionTypeRaw in ('0x1', '0x3'), 'DES',\n    EncryptionTypeRaw in ('0x17', '0x18'), 'RC4',\n    'Unknown'\n)\n| summarize \n    WeakTickets = count(),\n    DESCount = countif(CipherType == 'DES'),\n    RC4Count = countif(CipherType == 'RC4'),\n    EventTypes = make_set(EventID),\n    Services = make_set(ServiceName, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by TargetUserName\n| extend RiskLevel = case(\n    DESCount > 0, 'üî¥ Critical - Using DES',\n    RC4Count > 100, 'üü¢ High - Heavy RC4 Usage',\n    RC4Count > 0, 'üü° Medium - RC4 Usage',\n    'üü¢ OK'\n)\n| extend Remediation = case(\n    DESCount > 0, 'Disable DES in account properties and GPO',\n    RC4Count > 0, 'Enable AES on account, disable RC4 via GPO',\n    'N/A'\n)\n| order by DESCount desc, RC4Count desc\n| take 30",
              "size": 0,
              "title": "‚ö†Ô∏è Accounts Using Weak Ciphers (DES/RC4)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "AccountsWeakCiphers"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Services Targeted with Weak Ciphers (Kerberoasting Indicator)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4769\n| extend EncryptionTypeRaw = extract('Ticket Encryption Type:\\\\s*(0x[0-9a-fA-F]+)', 1, EventData)\n| where EncryptionTypeRaw in ('0x17', '0x18') // RC4\n| where ServiceName !endswith '$'\n| where ServiceName !in ('krbtgt', 'kadmin/changepw')\n| summarize \n    RC4Requests = count(),\n    UniqueRequesters = dcount(TargetUserName),\n    Requesters = make_set(TargetUserName, 10),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by ServiceName\n| extend RiskLevel = case(\n    UniqueRequesters > 5, 'üî¥ Critical - Multiple requesters (Kerberoasting)',\n    RC4Requests > 100, 'üü¢ High - Heavy RC4 Usage',\n    'üü° Medium - RC4 in use'\n)\n| extend Finding = 'Service using RC4 encryption'\n| extend Remediation = 'Enable AES on service account, set msDS-SupportedEncryptionTypes'\n| order by UniqueRequesters desc, RC4Requests desc\n| take 20",
              "size": 0,
              "title": "üéØ Services with RC4 Ticket Requests (Kerberoasting Risk)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ServicesRC4"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Cipher Deprecation Progress (7-Day Comparison)\nlet CurrentWeak = toscalar(SecurityEvent\n    | where TimeGenerated >= ago(7d)\n    | where EventID in (4768, 4769)\n    | extend EncType = extract('Ticket Encryption Type:\\\\s*(0x[0-9a-fA-F]+)', 1, EventData)\n    | where EncType in ('0x1', '0x3', '0x17', '0x18')\n    | summarize count());\nlet PreviousWeak = toscalar(SecurityEvent\n    | where TimeGenerated between (ago(14d) .. ago(7d))\n    | where EventID in (4768, 4769)\n    | extend EncType = extract('Ticket Encryption Type:\\\\s*(0x[0-9a-fA-F]+)', 1, EventData)\n    | where EncType in ('0x1', '0x3', '0x17', '0x18')\n    | summarize count());\nlet CurrentTotal = toscalar(SecurityEvent\n    | where TimeGenerated >= ago(7d)\n    | where EventID in (4768, 4769)\n    | summarize count());\nlet WeakRatio = round(todouble(CurrentWeak) / CurrentTotal * 100, 2);\nlet Change = round((todouble(CurrentWeak - PreviousWeak) / PreviousWeak) * 100, 2);\nprint \n    CurrentWeakCiphers = CurrentWeak,\n    PreviousWeakCiphers = PreviousWeak,\n    WeakCipherRatio = WeakRatio,\n    ChangePercent = Change\n| extend Status = case(\n    WeakRatio < 5, 'üü¢ Good - Low weak cipher usage',\n    WeakRatio < 20, 'üü° Medium - Some weak ciphers',\n    'üî¥ High - Significant weak cipher usage'\n)\n| extend Trend = case(\n    Change < -20, '‚úÖ Improving',\n    Change < 0, 'üìà Decreasing',\n    Change > 20, '‚ö†Ô∏è Increasing',\n    '‚û°Ô∏è Stable'\n)",
              "size": 4,
              "title": "üìà Weak Cipher Deprecation Progress",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "Status", "formatter": 1 },
                "leftContent": { "columnMatch": "WeakCipherRatio", "formatter": 12, "formatOptions": { "palette": "greenRed" }, "numberFormat": { "unit": 1, "options": { "style": "decimal", "maximumFractionDigits": 2 } } },
                "secondaryContent": { "columnMatch": "Trend", "formatter": 1 },
                "showBorder": true
              }
            },
            "customWidth": "50",
            "name": "CipherDeprecation"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìã Kerberos Cipher Reference\n\n| Hex Code | Cipher | Strength | Recommendation |\n|----------|--------|----------|----------------|\n| 0x1 | DES-CBC-CRC | üî¥ Critical | **Disable immediately** - Deprecated, easily cracked |\n| 0x3 | DES-CBC-MD5 | üî¥ Critical | **Disable immediately** - Deprecated, easily cracked |\n| 0x17 | RC4-HMAC | üü† Weak | **Disable** - Vulnerable to offline cracking, used in Kerberoasting |\n| 0x18 | RC4-HMAC-EXP | üü† Weak | **Disable** - Export-grade, very weak |\n| 0x11 | AES128-CTS-HMAC-SHA1 | üü° Good | Acceptable but prefer AES256 |\n| 0x12 | AES256-CTS-HMAC-SHA1 | üü¢ Strong | **Recommended** - Use this as default |\n\n**Remediation Steps:**\n1. Set `msDS-SupportedEncryptionTypes` attribute on accounts to enable AES (value: 24 for AES128+AES256)\n2. Configure GPO: Computer Configuration ‚Üí Policies ‚Üí Windows Settings ‚Üí Security Settings ‚Üí Local Policies ‚Üí Security Options ‚Üí 'Network security: Configure encryption types allowed for Kerberos'\n3. Uncheck DES and RC4, ensure AES128 and AES256 are enabled\n4. Test thoroughly before enforcing in production"
            },
            "name": "CipherReference"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n## üîí Stale & Legacy Protocol Analysis\n\nDetect usage of deprecated, insecure, or legacy authentication protocols and weak encryption that increase security risk.\n\n**Why This Matters:**\n- Legacy protocols like NTLMv1, LM, and WDigest store credentials insecurely\n- Weak Kerberos encryption (RC4, DES) can be easily cracked\n- Legacy TLS versions have known vulnerabilities\n- These represent attack vectors for credential theft and downgrade attacks\n\n---"
            },
            "name": "StaleProtocolsHeaderInline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Stale Protocol Risk Summary\nlet NTLMv1Count = SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where LmPackageName has \"NTLMv1\" or AuthenticationPackageName == \"NTLM\" and LmPackageName !has \"NTLMv2\"\n| count;\nlet WeakKerberos = SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4768, 4769)\n| extend TicketEncryptionType = extract('<Data Name=\"TicketEncryptionType\">([^<]+)</Data>', 1, EventData)\n| where TicketEncryptionType in (\"0x1\", \"0x3\", \"0x17\", \"0x18\")\n| count;\nlet NTLMTotal = SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where AuthenticationPackageName == \"NTLM\"\n| count;\nlet LegacyLogon = SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4776\n| count;\nprint \n  ['NTLMv1 Logons'] = toscalar(NTLMv1Count),\n  ['Total NTLM Logons'] = toscalar(NTLMTotal),\n  ['Weak Kerberos (RC4/DES)'] = toscalar(WeakKerberos),\n  ['NTLM Credential Validations (4776)'] = toscalar(LegacyLogon)",
              "size": 3,
              "title": "üö® Stale Protocol Risk Summary",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true
              }
            },
            "name": "StaleProtocolSummaryInline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// NTLMv1 Authentication Detection\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where LmPackageName has \"NTLMv1\" or (AuthenticationPackageName == \"NTLM\" and LmPackageName !has \"NTLMv2\")\n| extend NTLMVersion = case(\n    LmPackageName has \"NTLMv1\", \"üî¥ NTLMv1 (Critical)\",\n    LmPackageName has \"LM\", \"üî¥ LM Hash (Critical)\",\n    \"üü† NTLM Unknown Version\")\n| summarize Count = count(), LastSeen = max(TimeGenerated), Computers = make_set(Computer, 5), SourceIPs = make_set(IpAddress, 5) by TargetUserName, TargetDomainName, NTLMVersion\n| order by Count desc\n| project NTLMVersion, User = strcat(TargetDomainName, \"\\\\\", TargetUserName), Count, LastSeen, Computers, SourceIPs",
              "size": 0,
              "title": "üî¥ NTLMv1 / LM Hash Authentication (CRITICAL)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "red" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "NTLMv1DetectionInline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// WDigest Credential Exposure Risk\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where AuthenticationPackageName == \"NTLM\"\n| where LogonType in (2, 10, 11)\n| extend LogonTypeDesc = case(LogonType == 2, \"Interactive\", LogonType == 10, \"RDP\", LogonType == 11, \"Cached\", tostring(LogonType))\n| summarize Count = count(), LastSeen = max(TimeGenerated), LogonTypes = make_set(LogonTypeDesc) by TargetUserName, TargetDomainName\n| extend RiskLevel = case(Count > 100, \"üî¥ High WDigest Exposure\", Count > 20, \"üü† Moderate Exposure\", \"üü° Low\")\n| order by Count desc\n| project RiskLevel, User = strcat(TargetDomainName, \"\\\\\", TargetUserName), Count, LogonTypes, LastSeen\n| take 25",
              "size": 0,
              "title": "üî¥ WDigest Credential Exposure Risk",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "red" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "WDigestDetectionInline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Legacy TLS/SSL Detection\nEvent\n| where TimeGenerated {TimeRange}\n| where Source == \"Schannel\" or EventLog == \"System\"\n| where EventID in (36880, 36888, 36887)\n| extend TLSVersion = extract(\"(SSL [0-9.]+|TLS [0-9.]+)\", 1, RenderedDescription)\n| where isnotempty(TLSVersion)\n| extend RiskLevel = case(\n    TLSVersion has \"SSL 2\", \"üî¥ SSL 2.0 (Critical)\",\n    TLSVersion has \"SSL 3\", \"üî¥ SSL 3.0 (Critical)\",\n    TLSVersion has \"TLS 1.0\", \"üî¥ TLS 1.0 (Deprecated)\",\n    TLSVersion has \"TLS 1.1\", \"üü† TLS 1.1 (Deprecated)\",\n    TLSVersion has \"TLS 1.2\", \"üü¢ TLS 1.2\",\n    TLSVersion has \"TLS 1.3\", \"üü¢ TLS 1.3\",\n    \"Unknown\")\n| summarize Count = count(), LastSeen = max(TimeGenerated) by TLSVersion, RiskLevel, Computer\n| order by RiskLevel asc, Count desc\n| project RiskLevel, TLSVersion, Computer, Count, LastSeen",
              "size": 0,
              "title": "üîê TLS/SSL Version Usage",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "LegacyTLSDetectionInline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// LDAP Signing Issues\nEvent\n| where TimeGenerated {TimeRange}\n| where EventLog == \"Directory Service\"\n| where EventID in (2889, 2888, 2886, 2887, 3039, 3040)\n| extend ClientIP = extract(\"Client IP address: ([0-9.]+)\", 1, RenderedDescription)\n| extend BindType = case(\n    EventID == 2889, \"üî¥ Unsigned LDAP Bind\",\n    EventID == 2888, \"üü° LDAP Signing Warning\",\n    EventID == 2886, \"üî¥ LDAP Simple Bind (Cleartext)\",\n    EventID == 2887, \"üî¥ LDAP Simple Bind Count\",\n    EventID == 3039, \"üü† Channel Binding Not Enforced\",\n    EventID == 3040, \"üî¥ Unsigned LDAP over SSL\",\n    \"Other\")\n| summarize Count = count(), LastSeen = max(TimeGenerated), Clients = make_set(ClientIP, 10) by BindType, Computer\n| order by Count desc\n| project BindType, DC = Computer, Count, LastSeen, Clients",
              "size": 0,
              "title": "üì° LDAP Signing & Channel Binding Issues",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "orange" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "LDAPSigningInline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// SMBv1 Usage Detection\nEvent\n| where TimeGenerated {TimeRange}\n| where EventLog == \"Microsoft-Windows-SMBServer/Audit\" or Source == \"srv\"\n| where EventID in (3000, 1001)\n| extend ClientIP = extract(\"Client Address: ([0-9.]+)\", 1, RenderedDescription)\n| summarize Count = count(), LastSeen = max(TimeGenerated), Clients = make_set(ClientIP, 20) by Computer\n| extend Guidance = \"üî¥ SMBv1 is deprecated - disable and migrate\"\n| project Guidance, Server = Computer, SMBv1Connections = Count, LastSeen, ClientIPs = Clients",
              "size": 0,
              "title": "üîå SMBv1 Usage Detection (Deprecated)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "SMBv1DetectionInline"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n## üîë Kerberos RC4 Deprecation Monitoring\n\nRC4 encryption is deprecated. Use Events 201, 206, 207-210 on Windows Server 2025+ for enhanced monitoring.\n\n| Event ID | Description | Availability |\n|----------|-------------|--------------|\n| **201** | RC4 TGT issued | Windows Server 2025+ |\n| **206** | RC4 Service Ticket issued | Windows Server 2025+ |\n| **207-210** | RC4 fallback reasons | Windows Server 2025+ |\n| **16-19** | KDC RC4 audit | Windows Server 2019+ |"
            },
            "name": "RC4HeaderInline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Event 201 - RC4 TGT Issued (Windows Server 2025+)\nEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 201\n| extend AccountName = extract(@\"Account Name:\\s*([^\\r\\n]+)\", 1, RenderedDescription)\n| extend AccountDomain = extract(@\"Account Domain:\\s*([^\\r\\n]+)\", 1, RenderedDescription)\n| extend ClientAddress = extract(@\"Client Address:\\s*([^\\r\\n]+)\", 1, RenderedDescription)\n| summarize RC4TGTCount = count(), LastSeen = max(TimeGenerated), ClientIPs = make_set(ClientAddress, 5) by AccountName, AccountDomain, Computer\n| extend Status = \"üî¥ RC4 TGT - Migrate to AES\"\n| order by RC4TGTCount desc\n| project Status, Account = strcat(AccountDomain, \"\\\\\", AccountName), DC = Computer, RC4TGTCount, LastSeen, ClientIPs",
              "size": 0,
              "title": "üÜï Event 201: RC4 TGT Issued (Server 2025+)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "RC4TGTCount", "formatter": 4, "formatOptions": { "palette": "red" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "Event201Inline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Event 206 - RC4 Service Ticket Issued (Windows Server 2025+)\nEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 206\n| extend AccountName = extract(@\"Account Name:\\s*([^\\r\\n]+)\", 1, RenderedDescription)\n| extend ServiceName = extract(@\"Service Name:\\s*([^\\r\\n]+)\", 1, RenderedDescription)\n| summarize RC4Tickets = count(), LastSeen = max(TimeGenerated), UniqueUsers = dcount(AccountName), Users = make_set(AccountName, 5) by ServiceName, Computer\n| extend Priority = case(RC4Tickets > 1000, \"üî¥ Critical\", RC4Tickets > 100, \"üü† High\", RC4Tickets > 10, \"üü° Medium\", \"üü¢ Low\")\n| order by RC4Tickets desc\n| project Priority, ServiceName, DC = Computer, RC4Tickets, UniqueUsers, Users, LastSeen",
              "size": 0,
              "title": "üÜï Event 206: RC4 Service Tickets (Server 2025+)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "RC4Tickets", "formatter": 4, "formatOptions": { "palette": "red" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "Event206Inline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// RC4 Deprecation Summary - All Sources\nlet RC4FromSecurity = SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4768, 4769)\n| extend TicketEncryptionType = extract('<Data Name=\"TicketEncryptionType\">([^<]+)</Data>', 1, EventData)\n| where TicketEncryptionType in (\"0x17\", \"0x18\")\n| summarize RC4SecurityEvents = count();\nlet RC4FromSystem = Event\n| where TimeGenerated {TimeRange}\n| where EventID in (201, 206, 207, 208, 209, 210)\n| summarize RC4SystemEvents = count();\nlet RC4FromKDC = Event\n| where TimeGenerated {TimeRange}\n| where EventLog has \"Kerberos-Key-Distribution-Center\"\n| where EventID in (16, 17, 18, 19)\n| summarize RC4KDCEvents = count();\nprint \n  ['üî¥ RC4 Tickets (4768/4769)'] = toscalar(RC4FromSecurity),\n  ['üÜï RC4 Events (201/206)'] = toscalar(RC4FromSystem),\n  ['üìã KDC RC4 Audit (16-19)'] = toscalar(RC4FromKDC)",
              "size": 3,
              "title": "üîë RC4 Deprecation Summary",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true
              }
            },
            "name": "RC4DeprecationSummary"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Events 207-210 - RC4 Fallback Reasons (Windows Server 2025+)\nEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (207, 208, 209, 210)\n| extend EventDescription = case(\n    EventID == 207, \"üî¥ RC4 used - Missing AES keys\",\n    EventID == 208, \"üü† RC4 used - Cross-realm trust\",\n    EventID == 209, \"üü° RC4 used - Client requested\",\n    EventID == 210, \"üü° RC4 used - Legacy app\",\n    \"Other\")\n| extend AccountName = extract(@\"Account Name:\\s*([^\\r\\n]+)\", 1, RenderedDescription)\n| extend ServiceName = extract(@\"Service Name:\\s*([^\\r\\n]+)\", 1, RenderedDescription)\n| summarize Count = count(), LastSeen = max(TimeGenerated), AffectedAccounts = make_set(AccountName, 5), AffectedServices = make_set(ServiceName, 5) by EventID, EventDescription, Computer\n| order by EventID asc\n| project EventDescription, EventID, DC = Computer, Count, LastSeen, AffectedAccounts, AffectedServices",
              "size": 0,
              "title": "üìã RC4 Fallback Reasons (Events 207-210)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "orange" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "RC4FallbackReasons"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// KDC RC4 Audit Events (16-19) - Windows Server 2019+\nEvent\n| where TimeGenerated {TimeRange}\n| where EventLog has \"Kerberos-Key-Distribution-Center\" or EventLog has \"KDC\"\n| where EventID in (16, 17, 18, 19)\n| extend EventDescription = case(\n    EventID == 16, \"üî¥ RC4 TGT created\",\n    EventID == 17, \"üî¥ RC4 Service Ticket created\",\n    EventID == 18, \"üü† Missing AES keys\",\n    EventID == 19, \"üü° Trust uses RC4\",\n    \"Other\")\n| extend AccountName = extract(@\"Account:\\s*([^\\r\\n@]+)\", 1, RenderedDescription)\n| extend ServiceName = extract(@\"Service:\\s*([^\\r\\n]+)\", 1, RenderedDescription)\n| summarize Count = count(), LastSeen = max(TimeGenerated), Accounts = make_set(AccountName, 5), Services = make_set(ServiceName, 5) by EventID, EventDescription, Computer\n| order by EventID asc\n| project EventDescription, EventID, DC = Computer, Count, LastSeen, Accounts, Services",
              "size": 0,
              "title": "üîç KDC RC4 Audit Events (16-19)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "red" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "KDCAuditEvents"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// RC4 Account Remediation Priority List\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4768, 4769)\n| extend TicketEncryptionType = extract('<Data Name=\"TicketEncryptionType\">([^<]+)</Data>', 1, EventData)\n| where TicketEncryptionType in (\"0x17\", \"0x18\")\n| extend TicketType = iff(EventID == 4768, \"TGT\", \"TGS\")\n| extend ServiceName = extract('<Data Name=\"ServiceName\">([^<]+)</Data>', 1, EventData)\n| summarize RC4TicketCount = count(), TGTCount = countif(EventID == 4768), TGSCount = countif(EventID == 4769), LastSeen = max(TimeGenerated), ServicesAccessed = make_set(ServiceName, 5) by TargetUserName, TargetDomainName\n| extend Priority = case(\n    TargetUserName endswith \"$\", \"üîµ Computer Account\",\n    TargetUserName has_any (\"admin\", \"svc\", \"service\"), \"üî¥ Privileged/Service\",\n    RC4TicketCount > 1000, \"üü† High Volume\",\n    \"üü° Standard User\")\n| extend Remediation = case(\n    TargetUserName endswith \"$\", \"Update msDS-SupportedEncryptionTypes on computer\",\n    TargetUserName has \"svc\", \"Convert to gMSA or enable AES\",\n    \"Reset password after enabling AES\")\n| order by RC4TicketCount desc\n| project Priority, Account = strcat(TargetDomainName, \"\\\\\", TargetUserName), RC4TicketCount, TGTCount, TGSCount, LastSeen, Remediation, ServicesAccessed\n| take 30",
              "size": 0,
              "title": "üìã RC4 Account Remediation Priority List",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "RC4TicketCount", "formatter": 4, "formatOptions": { "palette": "red" } }
                ]
              }
            },
            "name": "RC4RemediationList"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// RC4 Usage Trend Over Time\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4768, 4769)\n| extend TicketEncryptionType = extract('<Data Name=\"TicketEncryptionType\">([^<]+)</Data>', 1, EventData)\n| extend EncryptionCategory = case(\n    TicketEncryptionType in (\"0x17\", \"0x18\"), \"RC4 (Deprecated)\",\n    TicketEncryptionType in (\"0x11\", \"0x12\"), \"AES (Recommended)\",\n    TicketEncryptionType in (\"0x1\", \"0x3\"), \"DES (Critical)\",\n    \"Other\")\n| where EncryptionCategory != \"Other\"\n| summarize Count = count() by EncryptionCategory, bin(TimeGenerated, 1h)\n| render timechart",
              "size": 0,
              "title": "üìà RC4 vs AES vs DES Encryption Trend",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "RC4UsageTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principals Using RC4 (Kerberoasting Risk)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4769\n| extend TicketEncryptionType = extract('<Data Name=\"TicketEncryptionType\">([^<]+)</Data>', 1, EventData)\n| extend ServiceName = extract('<Data Name=\"ServiceName\">([^<]+)</Data>', 1, EventData)\n| where TicketEncryptionType in (\"0x17\", \"0x18\")\n| where ServiceName !endswith \"$\" and ServiceName != \"krbtgt\"\n| summarize RC4Tickets = count(), UniqueRequesters = dcount(TargetUserName), Requesters = make_set(TargetUserName, 5), LastRequest = max(TimeGenerated) by ServiceName, Computer\n| extend KerberoastRisk = case(\n    RC4Tickets > 100 and UniqueRequesters > 5, \"üî¥ HIGH\",\n    RC4Tickets > 50, \"üü† MEDIUM\",\n    \"üü° LOW\")\n| order by RC4Tickets desc\n| project KerberoastRisk, ServiceName, DC = Computer, RC4Tickets, UniqueRequesters, Requesters, LastRequest\n| take 25",
              "size": 0,
              "title": "üéØ Service Principals with RC4 (Kerberoasting Risk)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "RC4Tickets", "formatter": 4, "formatOptions": { "palette": "red" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "SPNsUsingRC4"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// RC4 Deprecation Compliance Check\nlet RC4Accounts = SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4768, 4769)\n| extend TicketEncryptionType = extract('<Data Name=\"TicketEncryptionType\">([^<]+)</Data>', 1, EventData)\n| where TicketEncryptionType in (\"0x17\", \"0x18\")\n| distinct TargetUserName;\nlet AESAccounts = SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4768, 4769)\n| extend TicketEncryptionType = extract('<Data Name=\"TicketEncryptionType\">([^<]+)</Data>', 1, EventData)\n| where TicketEncryptionType in (\"0x11\", \"0x12\")\n| distinct TargetUserName;\nlet TotalAccounts = SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4768, 4769)\n| distinct TargetUserName;\nprint \n  ['Total Accounts'] = toscalar(TotalAccounts | count),\n  ['‚úÖ AES-Only'] = toscalar(AESAccounts | join kind=leftanti RC4Accounts on TargetUserName | count),\n  ['üî¥ RC4-Using'] = toscalar(RC4Accounts | count),\n  ['üü¢ Compliance %'] = round(100.0 * toscalar(AESAccounts | join kind=leftanti RC4Accounts on TargetUserName | count) / toscalar(TotalAccounts | count), 1)",
              "size": 3,
              "title": "‚úÖ RC4 Deprecation Compliance Status",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true
              }
            },
            "name": "RC4ComplianceStatus"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### üîß RC4 Deprecation Remediation Guide\n\n**Phase 1: Discovery**\n1. Enable KDC auditing for RC4 events\n2. Use this workbook to identify all RC4 usage\n3. Document applications and accounts requiring RC4\n\n**Phase 2: Preparation**\n1. Update `msDS-SupportedEncryptionTypes` on accounts to include AES (value: 24)\n2. Reset passwords on service accounts after enabling AES\n3. Update computer accounts to support AES\n\n**Phase 3: Migration**\n1. Configure GPO: `Network security: Configure encryption types allowed for Kerberos`\n2. Enable only AES128 and AES256\n3. Test critical applications for compatibility\n\n**Phase 4: Enforcement**\n1. Remove RC4 from allowed encryption types\n2. Set `msDS-SupportedEncryptionTypes = 24` on all accounts\n3. Monitor for authentication failures\n\n**PowerShell:**\n```powershell\n# Enable AES on service account\nSet-ADUser -Identity \"svc_account\" -KerberosEncryptionType AES128,AES256\n\n# Check encryption types on SPNs\nGet-ADUser -Filter {ServicePrincipalName -ne \"$null\"} -Properties msDS-SupportedEncryptionTypes | Select Name, msDS-SupportedEncryptionTypes\n```"
            },
            "name": "RC4RemediationGuide"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### üìã Stale Protocol Remediation Guide\n\n| Protocol | Risk Level | Remediation |\n|----------|------------|-------------|\n| **NTLMv1 / LM Hash** | üî¥ Critical | GPO: `LAN Manager authentication level` = Send NTLMv2 only |\n| **WDigest** | üî¥ Critical | Registry: `UseLogonCredential` = 0 |\n| **DES/RC4 Kerberos** | üü† High | Set `msDS-SupportedEncryptionTypes` = 24 (AES only) |\n| **TLS 1.0/1.1** | üü† High | Disable via registry; use TLS 1.2+ |\n| **SMBv1** | üî¥ Critical | `Disable-WindowsOptionalFeature -Online -FeatureName SMB1Protocol` |\n| **Unsigned LDAP** | üü† High | GPO: `LDAP server signing requirements` = Require signing |"
            },
            "name": "RemediationGuideInline"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "staleprotocols"
      },
      "name": "KerberosGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üó∫Ô∏è Geolocation Analysis\n---\nGeographic distribution of authentication events with trusted location analysis."
            },
            "name": "GeoHeader"
          },
          {
            "type": 1,
            "content": {
              "json": "### üõ°Ô∏è Trusted Location Analysis"
            },
            "name": "TrustedLocationHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Trusted vs Untrusted Location Distribution\nlet TrustedCountries = dynamic(['United States', 'Canada', 'United Kingdom', 'Germany', 'France', 'Netherlands', 'Australia']);\nlet TrustedIPRanges = dynamic(['10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16']);\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where isnotempty(IpAddress) and IpAddress != '-'\n| extend GeoInfo = geo_info_from_ip_address(IpAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend IsTrustedIP = ipv4_is_private(IpAddress)\n| extend IsTrustedCountry = Country in (TrustedCountries)\n| extend TrustedLocation = case(\n    IsTrustedIP, 'Trusted IP Range',\n    IsTrustedCountry, 'Trusted Country',\n    isempty(Country), 'Local/Unknown',\n    'Untrusted Location'\n)\n| summarize Count = count() by TrustedLocation",
              "size": 2,
              "title": "üõ°Ô∏è Trusted vs Untrusted Location Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "TrustedLocationPie"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Trusted Location Trend\nlet TrustedCountries = dynamic(['United States', 'Canada', 'United Kingdom', 'Germany', 'France', 'Netherlands', 'Australia']);\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where isnotempty(IpAddress) and IpAddress != '-'\n| extend GeoInfo = geo_info_from_ip_address(IpAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend IsTrustedIP = ipv4_is_private(IpAddress)\n| extend IsTrustedCountry = Country in (TrustedCountries)\n| extend TrustedLocation = case(\n    IsTrustedIP or IsTrustedCountry, 'Trusted',\n    'Untrusted'\n)\n| summarize Count = count() by bin(TimeGenerated, 1h), TrustedLocation\n| render timechart",
              "size": 0,
              "title": "üìà Trusted vs Untrusted Location Trend",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "67",
            "name": "TrustedLocationTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Authentication by Country\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4625)\n| where isnotempty(IpAddress) and IpAddress != '-' and IpAddress != '127.0.0.1' and IpAddress != '::1'\n| where not(ipv4_is_private(IpAddress))\n| extend GeoInfo = geo_info_from_ip_address(IpAddress)\n| extend Country = tostring(GeoInfo.country)\n| where isnotempty(Country)\n| summarize \n    TotalEvents = count(),\n    SuccessCount = countif(EventID == 4624),\n    FailedCount = countif(EventID == 4625),\n    UniqueAccounts = dcount(Account),\n    UniqueIPs = dcount(IpAddress)\n    by Country\n| extend FailureRate = round(todouble(FailedCount) / TotalEvents * 100, 2)\n| extend RiskLevel = case(\n    FailureRate > 90, 'üî¥ Critical',\n    FailureRate > 50, 'üü¢ High',\n    FailedCount > 100, 'üü° Medium',\n    'üü¢ Low'\n)\n| order by TotalEvents desc\n| take 20",
              "size": 0,
              "title": "üîí Authentication by Country",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "AuthByCountry"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Untrusted Location Sign-Ins\nlet TrustedCountries = dynamic(['United States', 'Canada', 'United Kingdom', 'Germany', 'France', 'Netherlands', 'Australia']);\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where isnotempty(IpAddress) and IpAddress != '-' and IpAddress != '127.0.0.1'\n| where not(ipv4_is_private(IpAddress))\n| extend GeoInfo = geo_info_from_ip_address(IpAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| where isnotempty(Country)\n| where not(Country in (TrustedCountries))\n| summarize \n    SignIns = count(),\n    UniqueAccounts = dcount(Account),\n    Accounts = make_set(Account, 10),\n    UniqueIPs = dcount(IpAddress)\n    by Country, City\n| extend RiskLevel = case(\n    SignIns > 100, 'üî¥ Critical',\n    SignIns > 10, 'üü¢ High',\n    'üü° Medium'\n)\n| order by SignIns desc\n| take 20",
              "size": 0,
              "title": "‚ö†Ô∏è Sign-Ins from Untrusted Locations",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "UntrustedLocations"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Failed Logons Geolocation Map\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4625\n| where isnotempty(IpAddress) and IpAddress != '-' and IpAddress != '127.0.0.1' and IpAddress != '::1'\n| where not(ipv4_is_private(IpAddress))\n| extend GeoInfo = geo_info_from_ip_address(IpAddress)\n| extend Latitude = toreal(GeoInfo.latitude)\n| extend Longitude = toreal(GeoInfo.longitude)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| where isnotempty(Latitude) and isnotempty(Longitude)\n| summarize \n    FailedAttempts = count(),\n    UniqueAccounts = dcount(Account),\n    UniqueIPs = dcount(IpAddress)\n    by Longitude, Latitude, Country, City\n| extend LocationLabel = strcat(City, ', ', Country, ' - ', FailedAttempts, ' failures')",
              "size": 0,
              "title": "üó∫Ô∏è Failed Logon Sources Map",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "map",
              "mapSettings": {
                "locInfo": "LatLong",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "FailedAttempts",
                "sizeAggregation": "Sum",
                "labelSettings": "LocationLabel",
                "legendMetric": "FailedAttempts",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "FailedAttempts",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "name": "FailedLogonsMap"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "geo"
      },
      "name": "GeoGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üö® Security Threats & Attack Detection\n---\nDetect credential attacks, lateral movement, and other security threats targeting Active Directory."
            },
            "name": "SecurityHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Brute Force Attack Detection\nlet TrustedCountries = dynamic(['United States', 'Canada', 'United Kingdom', 'Germany', 'France']);\nlet TrustedIPRanges = dynamic(['10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16']);\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4625\n| summarize \n    FailedAttempts = count(),\n    UniqueAccounts = dcount(Account),\n    Accounts = make_set(Account, 10),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by IpAddress\n| where FailedAttempts > 10\n| extend GeoInfo = geo_info_from_ip_address(IpAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| extend IsPrivateIP = ipv4_is_private(IpAddress)\n| extend IsTrustedCountry = Country in (TrustedCountries)\n| extend TrustedLocation = case(\n    IsPrivateIP, 'üü¢ Trusted - Internal IP',\n    IsTrustedCountry, 'üü° Trusted - Country',\n    'üî¥ Untrusted'\n)\n| extend IsExternal = not(IsPrivateIP)\n| extend AttackType = case(\n    UniqueAccounts > 20 and FailedAttempts > 100, 'üî¥ Password Spray',\n    FailedAttempts > 500, 'üî¥ Brute Force',\n    UniqueAccounts > 10, 'üü° Credential Stuffing',\n    'üü° Suspicious Activity'\n)\n| project IpAddress, TrustedLocation, IsExternal, Country, City, AttackType, FailedAttempts, UniqueAccounts, Accounts, FirstSeen, LastSeen\n| order by IsExternal desc, FailedAttempts desc\n| take 50",
              "size": 0,
              "title": "üéØ Brute Force & Password Spray Detection",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "BruteForceDetection"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Lateral Movement Detection\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where LogonType == 3\n| summarize \n    TargetCount = dcount(Computer),\n    Targets = make_set(Computer, 20),\n    LogonCount = count(),\n    UniqueIPs = dcount(IpAddress),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated),\n    TimeSpan = datetime_diff('minute', max(TimeGenerated), min(TimeGenerated))\n    by Account\n| where TargetCount >= 3\n| extend RiskLevel = case(\n    TargetCount >= 10 and TimeSpan <= 60, 'üî¥ Critical - Rapid Lateral Movement',\n    TargetCount >= 5, 'üü¢ High - Multiple Targets',\n    TimeSpan <= 30, 'üü° Medium - Fast Spread',\n    'üü¢ Review'\n)\n| order by TargetCount desc",
              "size": 0,
              "title": "üîÄ Lateral Movement Detection",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "LateralMovement"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Successful Logon After Failed Attempts (Breach Indicator)\nlet FailedLogons = SecurityEvent\n    | where TimeGenerated {TimeRange}\n    | where EventID == 4625\n    | summarize FailureCount = count() by IpAddress, Account, Computer;\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| join kind=inner (FailedLogons) on IpAddress, Account\n| where FailureCount > 5\n| project TimeGenerated, Account, Computer, IpAddress, FailureCount, LogonType\n| extend ThreatLevel = 'üî¥ Critical - Potential Breach'\n| order by FailureCount desc\n| take 20",
              "size": 0,
              "title": "üö® Successful Logon After Failed Attempts (Potential Breach)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "BreachIndicator"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Golden Ticket / Pass-the-Ticket Detection\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4769\n| where ServiceName == 'krbtgt'\n| summarize \n    Count = count(),\n    UniqueIPs = dcount(IpAddress),\n    IPs = make_set(IpAddress, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by TargetUserName, Computer\n| where Count > 10\n| extend RiskLevel = case(\n    Count > 100, 'üî¥ Critical - Possible Golden Ticket',\n    Count > 50, 'üü¢ High - Suspicious Activity',\n    'üü° Medium - Review'\n)\n| order by Count desc",
              "size": 0,
              "title": "‚ö†Ô∏è Potential Golden Ticket Activity (KRBTGT)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "GoldenTicket"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DCSync Detection (Directory Replication)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4662\n| where ObjectType contains 'domainDNS'\n| where Properties has_any ('Replicating Directory Changes', '1131f6aa-9c07-11d1-f79f-00c04fc2dcd2', '1131f6ad-9c07-11d1-f79f-00c04fc2dcd2')\n| project TimeGenerated, Account, Computer, ObjectType, Properties\n| extend ThreatLevel = 'üî¥ Critical - Potential DCSync Attack'\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üö® DCSync Attack Detection (Directory Replication)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "DCSyncDetection"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// NTDS.dit Exfiltration Detection\n// Monitors for attempts to access or copy the AD database (ntds.dit)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4663, 4656, 4658, 4660, 4985)\n| where ObjectName has_any ('ntds.dit', 'NTDS', 'ntds')\n   or CommandLine has_any ('ntds.dit', 'ntdsutil', 'vssadmin', 'diskshadow', 'esentutl')\n   or Process has_any ('ntdsutil', 'vssadmin', 'diskshadow', 'esentutl')\n| extend AttackTechnique = case(\n    Process has 'ntdsutil', 'NTDSUTIL Snapshot',\n    Process has 'vssadmin', 'VSS Shadow Copy',\n    Process has 'diskshadow', 'DiskShadow Attack',\n    Process has 'esentutl', 'ESENTUTL Database Copy',\n    'Direct NTDS.dit Access'\n)\n| project TimeGenerated, Computer, Account, Process, CommandLine, ObjectName, AttackTechnique, EventID\n| extend ThreatLevel = 'üî¥ Critical - NTDS.dit Exfiltration Attempt'\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üóÑÔ∏è NTDS.dit Exfiltration Detection (AD Database Theft)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "NTDSExfiltration"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// NTDS Dumping Detection (Process-Based)\n// Detects tools and techniques used to dump NTDS.dit\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4688\n| where (\n    // NTDSUTIL IFM (Install From Media) - creates copy of NTDS.dit\n    (NewProcessName has 'ntdsutil' and CommandLine has_any ('ifm', 'create full', 'activate instance ntds', 'snapshot'))\n    // VSS Shadow Copy abuse\n    or (NewProcessName has 'vssadmin' and CommandLine has_any ('create shadow', 'list shadows'))\n    // DiskShadow script-based attack\n    or (NewProcessName has 'diskshadow' and CommandLine has_any ('/s', 'script', 'expose'))\n    // ESENTUTL database copy\n    or (NewProcessName has 'esentutl' and CommandLine has_any ('/y', '/vss', 'ntds'))\n    // Secretsdump / Impacket patterns\n    or (CommandLine has_any ('secretsdump', 'impacket', 'crackmapexec') and CommandLine has 'ntds')\n    // Copy/Robocopy of NTDS.dit\n    or (CommandLine has 'ntds.dit' and NewProcessName has_any ('cmd', 'powershell', 'robocopy', 'xcopy', 'copy'))\n    // WMI-based NTDS access\n    or (NewProcessName has 'wmic' and CommandLine has 'shadowcopy')\n    // PowerShell NTDS access\n    or (NewProcessName has 'powershell' and CommandLine has_any ('ntds.dit', 'Get-ADDBAccount', 'DSInternals', 'ntdsutil'))\n)\n| extend DumpTechnique = case(\n    NewProcessName has 'ntdsutil' and CommandLine has 'ifm', 'üî¥ NTDSUTIL IFM',\n    NewProcessName has 'ntdsutil' and CommandLine has 'snapshot', 'üî¥ NTDSUTIL Snapshot',\n    NewProcessName has 'vssadmin', 'üî¥ VSS Shadow Copy',\n    NewProcessName has 'diskshadow', 'üî¥ DiskShadow Script',\n    NewProcessName has 'esentutl', 'üî¥ ESENTUTL Copy',\n    CommandLine has 'secretsdump', 'üî¥ Secretsdump (Impacket)',\n    NewProcessName has 'wmic', 'üî¥ WMI Shadow Copy',\n    NewProcessName has 'powershell' and CommandLine has 'DSInternals', 'üî¥ DSInternals Module',\n    CommandLine has 'ntds.dit', 'üî¥ Direct NTDS.dit Copy',\n    'üü° Suspicious Activity'\n)\n| extend MITRE = 'T1003.003 - NTDS'\n| project TimeGenerated, Computer, Account, NewProcessName, CommandLine, DumpTechnique, MITRE, ParentProcessName\n| extend ThreatLevel = 'üî¥ Critical - NTDS Credential Dumping'\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üíÄ NTDS.dit Dumping Detection (Credential Theft)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "NTDSDumping"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// WBAdmin Backup Manipulation Detection\n// Detects attempts to delete or manipulate Windows backups\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4688, 4663, 4656)\n| where NewProcessName has 'wbadmin' \n   or Process has 'wbadmin'\n   or CommandLine has 'wbadmin'\n   or CommandLine has_any ('delete catalog', 'delete systemstatebackup', 'delete backup', 'disable backup')\n   or CommandLine has_any ('bcdedit', 'recoveryenabled', 'bootstatuspolicy')\n   or CommandLine has 'vssadmin delete shadows'\n| extend AttackType = case(\n    CommandLine has 'delete catalog', 'üî¥ Backup Catalog Deletion',\n    CommandLine has 'delete systemstatebackup', 'üî¥ System State Backup Deletion',\n    CommandLine has 'delete backup', 'üî¥ Backup Deletion',\n    CommandLine has 'disable backup', 'üî¥ Backup Disabled',\n    CommandLine has 'vssadmin delete shadows', 'üî¥ VSS Shadow Copy Deletion',\n    CommandLine has 'bcdedit' and CommandLine has 'recoveryenabled', 'üî¥ Recovery Disabled',\n    CommandLine has 'bootstatuspolicy', 'üî¥ Boot Policy Modified',\n    'üü° Suspicious WBAdmin Activity'\n)\n| project TimeGenerated, Computer, Account, Process, CommandLine, AttackType, EventID\n| extend ThreatLevel = 'üî¥ Critical - Backup Manipulation (Ransomware Precursor)'\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üíæ Backup Manipulation Detection (WBAdmin/VSS/BCDEdit)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "BackupManipulation"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Plaintext Credentials in SYSVOL/NETLOGON/GPO Detection\n// Detects access to files that commonly contain plaintext passwords\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4663, 4656, 5145)\n| where ObjectName has_any ('SYSVOL', 'NETLOGON', 'Policies', 'scripts')\n| where ObjectName has_any (\n    // Group Policy Preferences (cpassword)\n    'Groups.xml', 'Services.xml', 'Scheduledtasks.xml', 'DataSources.xml',\n    'Printers.xml', 'Drives.xml', 'Registry.pol',\n    // Script files that may contain credentials\n    '.ps1', '.bat', '.cmd', '.vbs', '.wsf', '.js',\n    // Configuration files\n    '.xml', '.ini', '.config', 'unattend.xml', 'sysprep.xml',\n    // Other sensitive files\n    'web.config', 'applicationHost.config'\n)\n| extend FileType = case(\n    ObjectName has 'Groups.xml', 'üî¥ GPP Groups.xml (cpassword)',\n    ObjectName has 'Services.xml', 'üî¥ GPP Services.xml',\n    ObjectName has 'Scheduledtasks.xml', 'üî¥ GPP ScheduledTasks.xml',\n    ObjectName has 'DataSources.xml', 'üî¥ GPP DataSources.xml',\n    ObjectName has 'Drives.xml', 'üî¥ GPP Drives.xml',\n    ObjectName has 'unattend.xml', 'üî¥ Unattend.xml (autologon)',\n    ObjectName has 'sysprep.xml', 'üî¥ Sysprep.xml',\n    ObjectName has '.ps1', 'üü° PowerShell Script',\n    ObjectName has_any ('.bat', '.cmd'), 'üü° Batch Script',\n    ObjectName has '.vbs', 'üü° VBScript',\n    'üü° Config/Script File'\n)\n| extend Location = case(\n    ObjectName has 'NETLOGON', 'üìÅ NETLOGON Share',\n    ObjectName has 'SYSVOL', 'üìÅ SYSVOL',\n    ObjectName has 'Policies', 'üìÅ Group Policy',\n    'üìÅ Other'\n)\n| project TimeGenerated, Computer, Account, ObjectName, FileType, Location, AccessMask, EventID\n| extend ThreatLevel = iff(FileType startswith 'üî¥', 'üî¥ Critical - Potential Credential Harvesting', 'üü° Review - Script Access')\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üîë Plaintext Credentials Detection (SYSVOL/NETLOGON/GPO)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "PlaintextCredentials"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// GPP Password Hunting (Groups.xml, etc.)\n// Specific detection for Group Policy Preferences password files\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4663, 4656, 5145)\n| where ObjectName has_any ('Groups.xml', 'Services.xml', 'Scheduledtasks.xml', 'DataSources.xml', 'Printers.xml', 'Drives.xml')\n| summarize \n    AccessCount = count(),\n    UniqueUsers = dcount(Account),\n    Users = make_set(Account, 10),\n    FirstAccess = min(TimeGenerated),\n    LastAccess = max(TimeGenerated)\n    by ObjectName, Computer\n| extend GPPFile = case(\n    ObjectName has 'Groups.xml', 'Groups.xml - Local Admin Passwords',\n    ObjectName has 'Services.xml', 'Services.xml - Service Account Creds',\n    ObjectName has 'Scheduledtasks.xml', 'ScheduledTasks.xml - Task Creds',\n    ObjectName has 'DataSources.xml', 'DataSources.xml - DB Credentials',\n    ObjectName has 'Drives.xml', 'Drives.xml - Mapped Drive Creds',\n    ObjectName has 'Printers.xml', 'Printers.xml - Printer Creds',\n    'Other GPP File'\n)\n| extend RiskLevel = 'üî¥ Critical - GPP cpassword Vulnerability (MS14-025)'\n| project GPPFile, ObjectName, Computer, AccessCount, UniqueUsers, Users, FirstAccess, LastAccess, RiskLevel\n| order by AccessCount desc",
              "size": 0,
              "title": "‚ö†Ô∏è GPP Password Files Access (MS14-025 - cpassword)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "GPPPasswordFiles"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// NETLOGON Script Access Monitoring\n// Monitor access to scripts in NETLOGON share\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4663, 4656, 5145)\n| where ObjectName has 'NETLOGON'\n| where ObjectName has_any ('.ps1', '.bat', '.cmd', '.vbs', '.wsf', '.js', '.exe')\n| summarize \n    AccessCount = count(),\n    UniqueUsers = dcount(Account),\n    AccessTypes = make_set(AccessMask, 5)\n    by ObjectName, Computer\n| extend ScriptType = case(\n    ObjectName has '.ps1', 'PowerShell',\n    ObjectName has '.bat', 'Batch',\n    ObjectName has '.cmd', 'Command',\n    ObjectName has '.vbs', 'VBScript',\n    ObjectName has '.exe', 'Executable',\n    'Other'\n)\n| extend RiskLevel = case(\n    AccessCount > 100, 'üü° High Volume Access',\n    UniqueUsers > 10, 'üü° Many Users Accessing',\n    'üü¢ Normal'\n)\n| project ScriptType, ObjectName, Computer, AccessCount, UniqueUsers, RiskLevel\n| order by AccessCount desc",
              "size": 0,
              "title": "üìú NETLOGON Script Access",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "NetlogonScripts"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Security Event Baseline Comparison\nlet CurrentWeek = SecurityEvent\n| where TimeGenerated >= ago(7d)\n| where EventID in (4625, 4740, 4771)\n| summarize CurrentCount = count() by EventID;\nlet PreviousWeek = SecurityEvent\n| where TimeGenerated between (ago(14d) .. ago(7d))\n| where EventID in (4625, 4740, 4771)\n| summarize BaselineCount = count() by EventID;\nCurrentWeek\n| join kind=fullouter (PreviousWeek) on EventID\n| extend EventID = coalesce(EventID, EventID1)\n| extend CurrentCount = coalesce(CurrentCount, 0)\n| extend BaselineCount = coalesce(BaselineCount, 0)\n| extend Change = CurrentCount - BaselineCount\n| extend ChangePct = round(iff(BaselineCount > 0, todouble(Change) / BaselineCount * 100, 100.0), 2)\n| extend EventName = case(\n    EventID == 4625, 'Failed Logons',\n    EventID == 4740, 'Account Lockouts',\n    EventID == 4771, 'Kerberos Pre-Auth Failures',\n    strcat('Event ', EventID)\n)\n| extend Trend = case(\n    ChangePct > 100, 'üî¥ Significant Increase',\n    ChangePct > 50, 'üü¢ Moderate Increase',\n    ChangePct > 0, 'üü° Slight Increase',\n    ChangePct < -50, '‚úÖ Significant Decrease',\n    'üü¢ Normal'\n)\n| project EventID, EventName, CurrentCount, BaselineCount, Change, ChangePct, Trend\n| order by ChangePct desc",
              "size": 0,
              "title": "üìä Security Event Baseline Comparison (7-Day)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SecurityEventBaseline"
          },
          {
            "type": 1,
            "content": {
              "json": "---\\n\\n## üè¢ Enterprise Critical Detections"
            },
            "name": "EnterpriseCriticalHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Security Log Cleared Detection (Event 1102)\\n// Critical: Attackers clear logs to cover tracks\\nSecurityEvent\\n| where TimeGenerated {TimeRange}\\n| where EventID == 1102\\n| extend ClearedBy = SubjectUserName\\n| extend ClearTime = TimeGenerated\\n| project ClearTime, Computer, ClearedBy, SubjectDomainName, SubjectLogonId\\n| extend Alert = \\\"üî¥ CRITICAL - Security Audit Log Cleared\\\"\\n| order by ClearTime desc",
              "size": 0,
              "title": "üö® Security Log Cleared (1102) - Evidence Tampering",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Alert", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "Default", "representation": "red", "text": "{0}"}] } }
                ]
              }
            },
            "customWidth": "50",
            "name": "SecurityLogCleared"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Scheduled Task Creation (Event 4698) - Persistence\\n// Attackers use scheduled tasks for persistence\\nSecurityEvent\\n| where TimeGenerated {TimeRange}\\n| where EventID == 4698\\n| extend TaskName = extract('<Data Name=\\\"TaskName\\\">([^<]+)</Data>', 1, EventData)\\n| extend TaskContent = extract('<Data Name=\\\"TaskContent\\\">([^<]+)</Data>', 1, EventData)\\n| extend RiskLevel = case(\\n    TaskContent has_any (\\\"powershell\\\", \\\"cmd\\\", \\\"wscript\\\", \\\"cscript\\\", \\\"mshta\\\", \\\"rundll32\\\"), \\\"üî¥ HIGH - Script-based Task\\\",\\n    TaskContent has_any (\\\"http\\\", \\\"ftp\\\", \\\"\\\\\\\\\\\\\\\\\\\"\\), \\\"üü† MEDIUM - Network/Remote Task\\\",\\n    \\\"üü° Review\\\")\\n| summarize \\n    Count = count(),\\n    LastCreated = max(TimeGenerated),\\n    Computers = make_set(Computer, 5)\\n    by TaskName, SubjectUserName, RiskLevel\\n| order by RiskLevel asc, Count desc",
              "size": 0,
              "title": "üìÖ Scheduled Task Created (4698) - Persistence",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ScheduledTaskCreated"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Account Interactive Logon Detection\\n// Service accounts should NOT log on interactively (Type 2, 10, 11)\\nSecurityEvent\\n| where TimeGenerated {TimeRange}\\n| where EventID == 4624\\n| where LogonType in (2, 10, 11) // Interactive, RDP, Cached\\n| where TargetUserName matches regex @\\\"(?i)(svc|service|srv|sql|app|batch|task|iis|backup|scan|monitor|admin)\\\"\\n| where TargetUserName !endswith \\\"$\\\"\\n| extend LogonTypeDesc = case(\\n    LogonType == 2, \\\"Interactive (Console)\\\",\\n    LogonType == 10, \\\"Remote Desktop (RDP)\\\",\\n    LogonType == 11, \\\"Cached Interactive\\\",\\n    tostring(LogonType))\\n| summarize \\n    Count = count(),\\n    LastLogon = max(TimeGenerated),\\n    LogonTypes = make_set(LogonTypeDesc),\\n    SourceIPs = make_set(IpAddress, 5),\\n    Computers = make_set(Computer, 5)\\n    by TargetUserName, TargetDomainName\\n| extend Alert = \\\"üî¥ CRITICAL - Service Account Interactive Logon\\\"\\n| order by Count desc\\n| project Alert, ServiceAccount = strcat(TargetDomainName, \\\"\\\\\\\\\\\", TargetUserName), Count, LogonTypes, LastLogon, SourceIPs, Computers",
              "size": 0,
              "title": "‚ö†Ô∏è Service Account Interactive Logons (Should be Zero)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "red" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "ServiceAccountInteractive"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Sensitive Group Membership Changes (Beyond Domain Admins)\\n// Monitor all Tier-0 and high-privilege groups\\nSecurityEvent\\n| where TimeGenerated {TimeRange}\\n| where EventID in (4728, 4729, 4732, 4733, 4756, 4757)\\n| where TargetUserName has_any (\\n    \\\"Domain Admins\\\", \\\"Enterprise Admins\\\", \\\"Schema Admins\\\",\\n    \\\"Administrators\\\", \\\"Account Operators\\\", \\\"Backup Operators\\\",\\n    \\\"Print Operators\\\", \\\"Server Operators\\\", \\\"DnsAdmins\\\",\\n    \\\"Domain Controllers\\\", \\\"Group Policy Creator Owners\\\",\\n    \\\"Cert Publishers\\\", \\\"Cryptographic Operators\\\",\\n    \\\"Distributed COM Users\\\", \\\"Event Log Readers\\\",\\n    \\\"Remote Desktop Users\\\", \\\"Remote Management Users\\\",\\n    \\\"Hyper-V Administrators\\\", \\\"Protected Users\\\",\\n    \\\"Key Admins\\\", \\\"Enterprise Key Admins\\\")\\n| extend Action = case(\\n    EventID in (4728, 4732, 4756), \\\"‚ûï Member Added\\\",\\n    EventID in (4729, 4733, 4757), \\\"‚ûñ Member Removed\\\",\\n    \\\"Unknown\\\")\\n| extend GroupRisk = case(\\n    TargetUserName has_any (\\\"Enterprise Admins\\\", \\\"Schema Admins\\\", \\\"Domain Admins\\\"), \\\"üî¥ Tier-0\\\",\\n    TargetUserName has_any (\\\"Account Operators\\\", \\\"Backup Operators\\\", \\\"DnsAdmins\\\"), \\\"üü† High-Privilege\\\",\\n    \\\"üü° Elevated\\\")\\n| project TimeGenerated, GroupRisk, Action, ['Target Group'] = TargetUserName, ['Member Changed'] = MemberName, ['Changed By'] = SubjectUserName, Computer\\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üë• All Sensitive Group Changes (Tier-0/High-Privilege)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "GroupRisk", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "contains", "thresholdValue": "Tier-0", "representation": "red", "text": "{0}"}, {"operator": "contains", "thresholdValue": "High", "representation": "orange", "text": "{0}"}, {"operator": "Default", "representation": "yellow", "text": "{0}"}] } }
                ]
              }
            },
            "customWidth": "50",
            "name": "SensitiveGroupChanges"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// After-Hours Privileged Activity\\n// Detect admin activity outside business hours (suspicious)\\nSecurityEvent\\n| where TimeGenerated {TimeRange}\\n| where EventID in (4624, 4672, 4648)\\n| where TargetUserName has_any (\\\"admin\\\", \\\"svc\\\", \\\"service\\\")\\n   or EventID == 4672\\n| extend HourOfDay = hourofday(TimeGenerated)\\n| extend DayOfWeek = dayofweek(TimeGenerated)\\n| extend IsAfterHours = (HourOfDay < 6 or HourOfDay > 20) or (DayOfWeek == 0d or DayOfWeek == 6d)\\n| where IsAfterHours == true\\n| extend TimeCategory = case(\\n    DayOfWeek in (0d, 6d), \\\"üî¥ Weekend\\\",\\n    HourOfDay < 6 or HourOfDay > 20, \\\"üü† After Hours\\\",\\n    \\\"Normal\\\")\\n| summarize \\n    Count = count(),\\n    FirstSeen = min(TimeGenerated),\\n    LastSeen = max(TimeGenerated),\\n    Computers = make_set(Computer, 5),\\n    SourceIPs = make_set(IpAddress, 5)\\n    by TargetUserName, TimeCategory\\n| order by TimeCategory asc, Count desc\\n| project TimeCategory, User = TargetUserName, Count, FirstSeen, LastSeen, Computers, SourceIPs",
              "size": 0,
              "title": "üåô After-Hours Privileged Activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "orange" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "AfterHoursActivity"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Password Spray Detection\\n// Multiple failed logons with same password pattern (many users, few passwords)\\nSecurityEvent\\n| where TimeGenerated {TimeRange}\\n| where EventID == 4625\\n| where TargetUserName !endswith \\\"$\\\"\\n| summarize \\n    FailedAttempts = count(),\\n    UniqueUsers = dcount(TargetUserName),\\n    SampleUsers = make_set(TargetUserName, 10),\\n    TargetDCs = make_set(Computer, 5)\\n    by IpAddress, bin(TimeGenerated, 1h)\\n| where UniqueUsers >= 5 and FailedAttempts >= 10\\n| extend AttackType = case(\\n    UniqueUsers >= 50, \\\"üî¥ CRITICAL - Large-Scale Password Spray\\\",\\n    UniqueUsers >= 20, \\\"üü† HIGH - Password Spray Attack\\\",\\n    \\\"üü° MEDIUM - Potential Password Spray\\\")\\n| project TimeGenerated, AttackType, SourceIP = IpAddress, FailedAttempts, UniqueUsers, SampleUsers, TargetDCs\\n| order by UniqueUsers desc",
              "size": 0,
              "title": "üåßÔ∏è Password Spray Detection",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "UniqueUsers", "formatter": 4, "formatOptions": { "palette": "red" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "PasswordSprayDetection"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Rapid Privilege Escalation Detection\\n// User created and immediately added to privileged group\\nlet UserCreations = SecurityEvent\\n| where TimeGenerated {TimeRange}\\n| where EventID == 4720\\n| project UserCreatedTime = TimeGenerated, NewUser = TargetUserName, CreatedBy = SubjectUserName, CreateComputer = Computer;\\nlet GroupAdditions = SecurityEvent\\n| where TimeGenerated {TimeRange}\\n| where EventID in (4728, 4732, 4756)\\n| where TargetUserName has_any (\\\"Admin\\\", \\\"Domain Admins\\\", \\\"Enterprise Admins\\\")\\n| project GroupAddTime = TimeGenerated, MemberAdded = MemberName, TargetGroup = TargetUserName, AddedBy = SubjectUserName, GroupComputer = Computer;\\nUserCreations\\n| join kind=inner (GroupAdditions) on $left.NewUser == $right.MemberAdded\\n| extend TimeDiff = datetime_diff('minute', GroupAddTime, UserCreatedTime)\\n| where TimeDiff >= 0 and TimeDiff <= 60 // Within 1 hour\\n| extend Alert = \\\"üî¥ CRITICAL - Rapid Privilege Escalation\\\"\\n| project Alert, NewUser, TargetGroup, CreatedBy, AddedBy, UserCreatedTime, GroupAddTime, ['Minutes Between'] = TimeDiff\\n| order by TimeDiff asc",
              "size": 0,
              "title": "‚ö° Rapid Privilege Escalation (User Created ‚Üí Admin in <1hr)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "RapidPrivEsc"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Honeypot/Canary Account Access Detection\\n// Alert when decoy accounts are accessed (define your canary accounts)\\n// Replace 'honeypot', 'decoy', 'canary' with your actual account names\\nSecurityEvent\\n| where TimeGenerated {TimeRange}\\n| where EventID in (4624, 4625, 4648, 4768, 4769, 4776)\\n| where TargetUserName has_any (\\n    \\\"honeypot\\\", \\\"decoy\\\", \\\"canary\\\", \\\"tripwire\\\", \\\"fake\\\",\\n    \\\"testadmin\\\", \\\"tempadmin\\\", \\\"oldadmin\\\", \\\"legacyadmin\\\")\\n| extend EventType = case(\\n    EventID == 4624, \\\"Logon Success\\\",\\n    EventID == 4625, \\\"Logon Failed\\\",\\n    EventID == 4648, \\\"Explicit Creds\\\",\\n    EventID == 4768, \\\"TGT Request\\\",\\n    EventID == 4769, \\\"Service Ticket\\\",\\n    EventID == 4776, \\\"NTLM Auth\\\",\\n    tostring(EventID))\\n| extend Alert = \\\"üî¥ CRITICAL - Honeypot Account Accessed\\\"\\n| project TimeGenerated, Alert, HoneypotAccount = TargetUserName, EventType, SourceIP = IpAddress, Computer, SubjectUserName\\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üçØ Honeypot/Canary Account Access (Configure Account Names)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "HoneypotDetection"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// RDP Brute Force Detection\\n// Multiple failed RDP logons from same source\\nSecurityEvent\\n| where TimeGenerated {TimeRange}\\n| where EventID == 4625\\n| where LogonType == 10 // RDP\\n| summarize \\n    FailedAttempts = count(),\\n    UniqueUsers = dcount(TargetUserName),\\n    TargetUsers = make_set(TargetUserName, 10),\\n    TargetComputers = make_set(Computer, 5),\\n    FirstAttempt = min(TimeGenerated),\\n    LastAttempt = max(TimeGenerated)\\n    by IpAddress\\n| where FailedAttempts >= 5\\n| extend AttackSeverity = case(\\n    FailedAttempts >= 100, \\\"üî¥ CRITICAL - Heavy RDP Brute Force\\\",\\n    FailedAttempts >= 20, \\\"üü† HIGH - RDP Brute Force\\\",\\n    \\\"üü° MEDIUM - RDP Failed Logons\\\")\\n| project AttackSeverity, SourceIP = IpAddress, FailedAttempts, UniqueUsers, TargetUsers, TargetComputers, FirstAttempt, LastAttempt\\n| order by FailedAttempts desc",
              "size": 0,
              "title": "üñ•Ô∏è RDP Brute Force Detection (LogonType 10)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "FailedAttempts", "formatter": 4, "formatOptions": { "palette": "red" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "RDPBruteForce"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Account Lockout Storm Detection\\n// Multiple accounts locked from same source (password spray indicator)\\nSecurityEvent\\n| where TimeGenerated {TimeRange}\\n| where EventID == 4740\\n| summarize \\n    LockoutCount = count(),\\n    UniqueAccounts = dcount(TargetUserName),\\n    LockedAccounts = make_set(TargetUserName, 20),\\n    TargetDCs = make_set(Computer, 5),\\n    FirstLockout = min(TimeGenerated),\\n    LastLockout = max(TimeGenerated)\\n    by TargetDomainName, bin(TimeGenerated, 15m)\\n| where UniqueAccounts >= 3\\n| extend AttackIndicator = case(\\n    UniqueAccounts >= 20, \\\"üî¥ CRITICAL - Mass Lockout (Password Spray)\\\",\\n    UniqueAccounts >= 10, \\\"üü† HIGH - Multiple Lockouts\\\",\\n    \\\"üü° MEDIUM - Elevated Lockouts\\\")\\n| project TimeGenerated, AttackIndicator, Domain = TargetDomainName, LockoutCount, UniqueAccounts, LockedAccounts, TargetDCs\\n| order by UniqueAccounts desc",
              "size": 0,
              "title": "üîí Account Lockout Storm (Password Spray Indicator)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "LockoutStorm"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// SID History Injection Detection\\n// Attackers add SID History for privilege escalation\\nSecurityEvent\\n| where TimeGenerated {TimeRange}\\n| where EventID == 4765 or (EventID == 4738 and EventData has \\\"SidHistory\\\")\\n| extend Alert = \\\"üî¥ CRITICAL - SID History Modified\\\"\\n| project TimeGenerated, Alert, TargetUser = TargetUserName, ModifiedBy = SubjectUserName, Computer, EventID\\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üÜî SID History Injection (4765)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "SIDHistoryInjection"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AdminSDHolder Modification Detection\\n// Changes to AdminSDHolder propagate to all protected accounts\\nSecurityEvent\\n| where TimeGenerated {TimeRange}\\n| where EventID == 5136\\n| where ObjectDN has \\\"AdminSDHolder\\\" or ObjectDN has \\\"CN=AdminSDHolder\\\"\\n| extend Alert = \\\"üî¥ CRITICAL - AdminSDHolder Modified (ACL Persistence)\\\"\\n| project TimeGenerated, Alert, ObjectDN, AttributeModified = AttributeLDAPDisplayName, ModifiedBy = SubjectUserName, Computer\\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üõ°Ô∏è AdminSDHolder Modification (Persistence)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "AdminSDHolderMod"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Computer Account Anomalies - Unconstrained Delegation Risk\\n// New computer accounts or delegation changes\\nSecurityEvent\\n| where TimeGenerated {TimeRange}\\n| where EventID in (4741, 4742, 4743) // Computer account events\\n   or (EventID == 5136 and AttributeLDAPDisplayName has_any (\\\"userAccountControl\\\", \\\"msDS-AllowedToDelegateTo\\\"))\\n| extend Action = case(\\n    EventID == 4741, \\\"üÜï Computer Created\\\",\\n    EventID == 4742, \\\"üìù Computer Modified\\\",\\n    EventID == 4743, \\\"‚ùå Computer Deleted\\\",\\n    EventID == 5136 and AttributeLDAPDisplayName has \\\"Delegate\\\", \\\"‚ö†Ô∏è Delegation Changed\\\",\\n    EventID == 5136, \\\"üìù Attribute Changed\\\",\\n    \\\"Other\\\")\\n| where TargetUserName endswith \\\"$\\\" or EventID == 5136\\n| summarize Count = count(), LastSeen = max(TimeGenerated) by Action, TargetUserName, SubjectUserName, Computer\\n| order by Action asc, Count desc",
              "size": 0,
              "title": "üíª Computer Account Changes (Delegation Risk)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ComputerAccountAnomalies"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Domain Trust Modifications\\n// Changes to AD trust relationships\\nSecurityEvent\\n| where TimeGenerated {TimeRange}\\n| where EventID in (4706, 4707, 4716, 4717, 4718, 4864, 4865, 4866, 4867)\\n| extend TrustAction = case(\\n    EventID == 4706, \\\"üÜï Trust Created\\\",\\n    EventID == 4707, \\\"‚ùå Trust Deleted\\\",\\n    EventID == 4716, \\\"üìù Trust Info Modified\\\",\\n    EventID == 4717, \\\"üîì System Access Granted\\\",\\n    EventID == 4718, \\\"üîí System Access Removed\\\",\\n    EventID == 4864, \\\"üìù Namespace Collision Detected\\\",\\n    EventID == 4865, \\\"üìù Forest Trust Info Added\\\",\\n    EventID == 4866, \\\"üìù Forest Trust Info Removed\\\",\\n    EventID == 4867, \\\"üìù Forest Trust Info Modified\\\",\\n    \\\"Other\\\")\\n| extend Alert = \\\"üî¥ CRITICAL - Domain Trust Modified\\\"\\n| project TimeGenerated, Alert, TrustAction, EventID, SubjectUserName, Computer\\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üîó Domain Trust Modifications",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "TrustModifications"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DPAPI Backup Key Access Detection\\n// Access to DPAPI backup key can decrypt all DPAPI secrets\\nSecurityEvent\\n| where TimeGenerated {TimeRange}\\n| where EventID == 4662\\n| where Properties has \\\"BCKUPKEY\\\" or ObjectName has \\\"BCKUPKEY\\\" or Properties has \\\"DPAPI\\\"\\n| extend Alert = \\\"üî¥ CRITICAL - DPAPI Backup Key Accessed\\\"\\n| project TimeGenerated, Alert, SubjectUserName, ObjectType, ObjectName, Computer\\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üîê DPAPI Backup Key Access",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "DPAPIBackupKey"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Suspicious Process Execution on Domain Controllers\\n// Processes that shouldn't normally run on DCs\\nSecurityEvent\\n| where TimeGenerated {TimeRange}\\n| where EventID == 4688\\n| where Computer has_any (\\\"DC\\\", \\\"PDC\\\") // Adjust to match your DC naming\\n| where NewProcessName has_any (\\n    // Credential theft\\n    \\\"mimikatz\\\", \\\"procdump\\\", \\\"secretsdump\\\", \\\"lazagne\\\",\\n    // Recon tools\\n    \\\"bloodhound\\\", \\\"sharphound\\\", \\\"adexplorer\\\", \\\"ldapsearch\\\",\\n    // Post-exploitation\\n    \\\"psexec\\\", \\\"paexec\\\", \\\"csexec\\\",\\n    // Suspicious executables\\n    \\\"nc.exe\\\", \\\"ncat\\\", \\\"netcat\\\", \\\"plink\\\",\\n    // LOLBins abuse\\n    \\\"certutil\\\", \\\"bitsadmin\\\"\\n)\\n   or CommandLine has_any (\\n    \\\"sekurlsa\\\", \\\"lsadump\\\", \\\"dcsync\\\", \\\"invoke-mimikatz\\\",\\n    \\\"invoke-command\\\", \\\"downloadstring\\\", \\\"downloadfile\\\",\\n    \\\"encodedcommand\\\", \\\"-enc \\\", \\\"-e \\\",\\n    \\\"frombase64\\\", \\\"iex(\\\", \\\"invoke-expression\\\"\\n)\\n| extend ThreatLevel = \\\"üî¥ CRITICAL - Suspicious Process on DC\\\"\\n| project TimeGenerated, ThreatLevel, Computer, Account, NewProcessName, CommandLine, ParentProcessName\\n| order by TimeGenerated desc\\n| take 100",
              "size": 0,
              "title": "üíÄ Suspicious Processes on Domain Controllers (4688)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "SuspiciousProcessDC"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Mass Password Reset Detection\\n// Multiple password resets in short time (potential takeover)\\nSecurityEvent\\n| where TimeGenerated {TimeRange}\\n| where EventID == 4724\\n| summarize \\n    ResetCount = count(),\\n    UniqueTargets = dcount(TargetUserName),\\n    TargetUsers = make_set(TargetUserName, 20),\\n    Computers = make_set(Computer, 5)\\n    by SubjectUserName, bin(TimeGenerated, 1h)\\n| where ResetCount >= 5\\n| extend RiskLevel = case(\\n    ResetCount >= 20, \\\"üî¥ CRITICAL - Mass Password Reset\\\",\\n    ResetCount >= 10, \\\"üü† HIGH - Multiple Resets\\\",\\n    \\\"üü° MEDIUM - Elevated Resets\\\")\\n| project TimeGenerated, RiskLevel, ResetBy = SubjectUserName, ResetCount, UniqueTargets, TargetUsers, Computers\\n| order by ResetCount desc",
              "size": 0,
              "title": "üîÑ Mass Password Reset Detection (Potential Takeover)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "MassPasswordReset"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Audit Policy Changes Detection\\n// Changes to audit settings could hide attacker activity\\nSecurityEvent\\n| where TimeGenerated {TimeRange}\\n| where EventID in (4719, 4902, 4906, 4907, 4908, 4912)\\n| extend PolicyChange = case(\\n    EventID == 4719, \\\"üìù System Audit Policy Changed\\\",\\n    EventID == 4902, \\\"üìù Per-user Audit Policy Table Created\\\",\\n    EventID == 4906, \\\"üìù CrashOnAuditFail Changed\\\",\\n    EventID == 4907, \\\"üìù Auditing Settings Changed\\\",\\n    EventID == 4908, \\\"üìù Special Groups Logon Table Modified\\\",\\n    EventID == 4912, \\\"üìù Per-user Audit Policy Changed\\\",\\n    \\\"Other\\\")\\n| extend Alert = \\\"üü† HIGH - Audit Policy Modified\\\"\\n| project TimeGenerated, Alert, PolicyChange, SubjectUserName, Computer, EventID\\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üìã Audit Policy Changes (Covering Tracks)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "AuditPolicyChanges"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// GPO Modification Detection\\n// Changes to Group Policy Objects\\nSecurityEvent\\n| where TimeGenerated {TimeRange}\\n| where EventID in (5136, 5137, 5141)\\n| where ObjectDN has \\\"Policies\\\" and ObjectDN has \\\"CN={\\\"\\n| extend GPOAction = case(\\n    EventID == 5136, \\\"üìù GPO Modified\\\",\\n    EventID == 5137, \\\"üÜï GPO Created\\\",\\n    EventID == 5141, \\\"‚ùå GPO Deleted\\\",\\n    \\\"Other\\\")\\n| extend GPOName = extract(\\\"CN=\\\\{([^}]+)\\\\}\\\", 1, ObjectDN)\\n| summarize \\n    ChangeCount = count(),\\n    LastChange = max(TimeGenerated),\\n    ChangedBy = make_set(SubjectUserName, 5)\\n    by GPOAction, GPOName, ObjectDN\\n| extend RiskLevel = case(\\n    ObjectDN has \\\"Default Domain Policy\\\", \\\"üî¥ CRITICAL - Default Domain Policy\\\",\\n    ObjectDN has \\\"Default Domain Controllers\\\", \\\"üî¥ CRITICAL - DC Policy\\\",\\n    ChangeCount > 10, \\\"üü† HIGH - Many Changes\\\",\\n    \\\"üü° Review\\\")\\n| project RiskLevel, GPOAction, GPOName, ChangeCount, LastChange, ChangedBy\\n| order by RiskLevel asc, ChangeCount desc",
              "size": 0,
              "title": "üìú GPO Modifications (Potential Persistence)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "GPOModifications"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Security Event Data Gaps Detection\\n// Identify gaps in security event collection\\nSecurityEvent\\n| where TimeGenerated {TimeRange}\\n| summarize EventCount = count(), MinTime = min(TimeGenerated), MaxTime = max(TimeGenerated) by Computer, bin(TimeGenerated, 1h)\\n| summarize \\n    TotalHours = dcount(TimeGenerated),\\n    AvgEventsPerHour = avg(EventCount),\\n    MinEventsHour = min(EventCount),\\n    MaxEventsHour = max(EventCount),\\n    FirstEvent = min(MinTime),\\n    LastEvent = max(MaxTime)\\n    by Computer\\n| extend ExpectedHours = datetime_diff('hour', LastEvent, FirstEvent)\\n| extend MissingHours = ExpectedHours - TotalHours\\n| where MissingHours > 0 or MinEventsHour < 10\\n| extend DataQuality = case(\\n    MissingHours > 24, \\\"üî¥ CRITICAL - Large Data Gap\\\",\\n    MissingHours > 6, \\\"üü† HIGH - Data Gap Detected\\\",\\n    MinEventsHour < 10, \\\"üü° LOW - Low Event Volume\\\",\\n    \\\"üü¢ OK\\\")\\n| project DataQuality, Computer, TotalHours, ExpectedHours, MissingHours, AvgEventsPerHour, FirstEvent, LastEvent\\n| order by MissingHours desc",
              "size": 0,
              "title": "üìä Security Event Data Quality/Gaps",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "DataGapsDetection"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n## ‚ò† Threat Actors & Attack Tools Targeting Active Directory\n\n### üî¥ Known Threat Actor Groups Targeting AD\n\n| Threat Actor | Origin | TTPs | AD Attack Focus |\n|--------------|--------|------|------------------|\n| **APT29 (Cozy Bear)** | Russia | Stealth, persistence | Golden Ticket, DCSync |\n| **APT28 (Fancy Bear)** | Russia | Spearphishing | Pass-the-Hash, Kerberoasting |\n| **Lazarus Group** | North Korea | Ransomware | Domain Admin compromise |\n| **FIN7/Carbanak** | E. Europe | Financial fraud | Service account abuse |\n| **Wizard Spider** | Russia | Ransomware | Domain-wide encryption |\n| **BlackCat/ALPHV** | Russia | RaaS | AD recon, mass encryption |\n| **LockBit** | Russia | RaaS | GPO ransomware deployment |\n| **Scattered Spider** | USA/UK | Social engineering | Help desk attacks, MFA bypass |\n| **Volt Typhoon** | China | Living-off-the-land | Long-term AD persistence |\n| **Midnight Blizzard** | Russia | Supply chain | OAuth abuse, federation |"
            },
            "name": "ThreatActorsTable"
          },
          {
            "type": 1,
            "content": {
              "json": "### üõ°Ô∏è Common Attack Tools Against AD\n\n| Tool | Category | Attack Capability | Detection |\n|------|----------|-------------------|------------|\n| **Mimikatz** | Credential Theft | Pass-the-Hash, Golden Ticket, DCSync | 4624, 4672, 4769 |\n| **Rubeus** | Kerberos | Kerberoasting, AS-REP Roasting | 4768, 4769, 4771 |\n| **Impacket** | Remote Exec | secretsdump, psexec, wmiexec | 4624, 4648 |\n| **BloodHound** | AD Recon | Attack path discovery | LDAP queries |\n| **CrackMapExec** | Post-Exploit | Credential spraying, lateral movement | 4625, 4624 |\n| **Cobalt Strike** | C2 Framework | Beacon, Golden Ticket | 4624, 4648, 4769 |\n| **Certify/Certipy** | ADCS | Certificate abuse, ESC1-ESC8 | ADCS logs |\n| **PowerView** | Enumeration | Domain reconnaissance | PowerShell |\n| **Kekeo** | Kerberos | Golden/Silver tickets | 4768, 4769 |\n| **DSInternals** | AD Database | Offline credential extraction | 4662 |"
            },
            "name": "AttackToolsTable"
          },
          {
            "type": 1,
            "content": {
              "json": "### üí• Top 10 Critical AD Vulnerabilities\n\n| # | Vulnerability | Risk | MITRE | Mitigation |\n|---|---------------|------|-------|-------------|\n| 1 | **Kerberoasting** | üî¥ Critical | T1558.003 | gMSA, strong passwords, detect RC4 |\n| 2 | **DCSync Attack** | üî¥ Critical | T1003.006 | Limit replication rights, monitor 4662 |\n| 3 | **Golden Ticket** | üî¥ Critical | T1558.001 | Rotate KRBTGT 2x |\n| 4 | **AS-REP Roasting** | üî¥ High | T1558.004 | Require Kerberos preauth |\n| 5 | **ADCS ESC1-ESC8** | üî¥ Critical | T1649 | Audit cert templates |\n| 6 | **Unconstrained Delegation** | üî¥ High | T1558 | Use constrained/RBCD |\n| 7 | **GPO Abuse** | üî¥ High | T1484.001 | Monitor 5136/5137 |\n| 8 | **Password Spraying** | üü¢ High | T1110.003 | Smart lockout, MFA |\n| 9 | **NTLM Relay** | üî¥ High | T1557.001 | LDAP/SMB signing, EPA |\n| 10 | **AdminSDHolder** | üî¥ High | T1098 | Monitor ACL changes |"
            },
            "name": "TopVulnerabilitiesTable"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìã MITRE ATT&CK Techniques for AD\n\n| Technique | Name | Description |\n|-----------|------|-------------|\n| T1003.001 | LSASS Memory | Credential dumping from memory |\n| T1003.003 | NTDS | AD database theft |\n| T1003.006 | DCSync | Replication-based credential theft |\n| T1078.002 | Domain Accounts | Compromised domain credentials |\n| T1110.003 | Password Spraying | Low-and-slow brute force |\n| T1484.001 | GPO Modification | GPO-based attacks |\n| T1558.001 | Golden Ticket | Forged TGT with KRBTGT hash |\n| T1558.002 | Silver Ticket | Forged service tickets |\n| T1558.003 | Kerberoasting | Offline service account cracking |\n| T1558.004 | AS-REP Roasting | Pre-auth disabled account abuse |"
            },
            "name": "MITRETable"
          },
          {
            "type": 1,
            "content": {
              "json": "### üõ°Ô∏è Critical CVEs Affecting AD\n\n| CVE | Name | Severity | Impact |\n|-----|------|----------|--------|\n| CVE-2020-1472 | **Zerologon** | 10.0 Critical | DC takeover via Netlogon |\n| CVE-2021-42278 | **noPac** | 9.8 Critical | Privilege escalation to DA |\n| CVE-2022-26923 | **Certifried** | 8.8 High | ADCS privilege escalation |\n| CVE-2021-34527 | **PrintNightmare** | 8.8 High | RCE via Print Spooler |\n| CVE-2022-33679 | **Kerberos RC4** | 8.1 High | Kerberos downgrade |\n| CVE-2019-1040 | **Drop The MIC** | 7.5 High | NTLM relay bypass |\n| CVE-2022-37966 | **Kerberos PAC** | 8.8 High | Privilege elevation |\n| CVE-2023-23397 | **Outlook NTLM** | 9.8 Critical | NTLM credential theft |\n| CVE-2024-49113 | **LDAP Nightmare** | 7.5 High | LDAP DoS/RCE |\n\n**üîó Resources:** [MITRE ATT&CK](https://attack.mitre.org) | [Microsoft AD Security](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/) | [BloodHound](https://bloodhound.readthedocs.io/)"
            },
            "name": "CVETable"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "security"
      },
      "name": "SecurityGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üñ•Ô∏è Domain Controller Health & Monitoring\n---\nMonitor Domain Controller health, event volume, and operational status."
            },
            "name": "DCHealthHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Domain Controller Event Volume\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4625, 4768, 4769, 4770, 4771, 4776)\n| summarize \n    TotalEvents = count(),\n    SuccessfulLogons = countif(EventID == 4624),\n    FailedLogons = countif(EventID == 4625),\n    KerberosTGT = countif(EventID == 4768),\n    KerberosService = countif(EventID == 4769),\n    KerberosFailed = countif(EventID == 4771),\n    NTLMAuth = countif(EventID == 4776),\n    LastEvent = max(TimeGenerated)\n    by Computer\n| extend FailureRate = round(todouble(FailedLogons) / (SuccessfulLogons + FailedLogons) * 100, 2)\n| extend HealthStatus = case(\n    FailureRate > 50, 'üî¥ Critical - High Failure Rate',\n    FailureRate > 20, 'üü° Warning - Elevated Failures',\n    datetime_diff('minute', now(), LastEvent) > 60, 'üü° Warning - No Recent Events',\n    'üü¢ Healthy'\n)\n| order by TotalEvents desc",
              "size": 0,
              "title": "üñ•Ô∏è Domain Controller Event Volume & Health",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "DCEventVolume"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DC Event Timeline by Computer\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4625, 4768, 4769)\n| where Computer in (\n    SecurityEvent\n    | where TimeGenerated {TimeRange}\n    | where EventID in (4624, 4625, 4768, 4769)\n    | summarize Count = count() by Computer\n    | top 5 by Count\n    | project Computer\n)\n| summarize Count = count() by bin(TimeGenerated, 1h), Computer\n| render timechart",
              "size": 0,
              "title": "üìà Top 5 Domain Controllers Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "DCTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DC Replication Events\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4932, 4933, 4934, 4935, 4936, 4937)\n| extend ReplicationEvent = case(\n    EventID == 4932, 'Replication of naming context began',\n    EventID == 4933, 'Replication of naming context ended',\n    EventID == 4934, 'AD attributes replicated',\n    EventID == 4935, 'Replication failure began',\n    EventID == 4936, 'Replication failure ended',\n    EventID == 4937, 'Lingering object removed',\n    'Other'\n)\n| summarize Count = count() by ReplicationEvent, EventID, Computer\n| order by Count desc",
              "size": 0,
              "title": "üîÑ AD Replication Events",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "DCReplication"
          },
          {
            "type": 1,
            "content": {
              "json": "### üîÑ AD Replication Health Monitoring\n\nMonitor Active Directory replication status across Domain Controllers. Replication failures can cause authentication issues, inconsistent data, and security gaps.\n\n---\n\n#### üì° Required Data Collection for Replication Monitoring\n\n**XPath queries for DCR (Directory Service log):**\n```\nDirectory Service!*[System[(EventID=1083 or EventID=1084 or EventID=1085 or EventID=1088 or EventID=1089 or EventID=1566 or EventID=1567 or EventID=1864 or EventID=1865 or EventID=2042 or EventID=2087 or EventID=2088 or EventID=2089 or EventID=2095 or EventID=1925 or EventID=1926 or EventID=1988)]]\n```\n\n**Key Replication Event IDs:**\n| Event ID | Log | Severity | Description |\n|----------|-----|----------|-------------|\n| 1083 | Directory Service | Info | Replication initialized |\n| 1084 | Directory Service | Warning | Replication latency detected |\n| 1085 | Directory Service | Warning | Replication backlog |\n| 1088 | Directory Service | Error | Replication error |\n| 1566 | Directory Service | Warning | Replication over SMTP failed |\n| 1864 | Directory Service | Warning | Lingering objects |\n| 1988 | Directory Service | Info | Lingering objects removed |\n| 2042 | Directory Service | Error | Replication failure - too long |\n| 2087 | Directory Service | Warning | Could not resolve DNS |\n| 2088 | Directory Service | Warning | Could not locate DC |\n| 2089 | Directory Service | Warning | Backup latency violation |\n| 2095 | Directory Service | Warning | NTDS backup old |\n| 1925 | Directory Service | Warning | Attempt to establish replication failed |\n| 1926 | Directory Service | Warning | Replication to RODC failed |"
            },
            "name": "ReplicationHealthHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Replication Health from Directory Service Log\n// Requires Directory Service log collection\nEvent\n| where TimeGenerated {TimeRange}\n| where Source == 'NTDS Replication' or Source == 'Microsoft-Windows-ActiveDirectory_DomainService' or EventLog == 'Directory Service'\n| where EventID in (1083, 1084, 1085, 1088, 1089, 1566, 1567, 1864, 1865, 1925, 1926, 1988, 2042, 2087, 2088, 2089, 2095)\n| extend ReplicationStatus = case(\n    EventID in (1088, 2042, 1566), 'üî¥ Replication Error',\n    EventID in (1084, 1085, 2087, 2088, 1925, 1926), 'üü° Replication Warning',\n    EventID in (1864, 2089, 2095), 'üü° Backup/Lingering Issue',\n    EventID in (1083, 1988), 'üü¢ Replication OK',\n    'üìã Info'\n)\n| extend EventDescription = case(\n    EventID == 1083, 'Replication initialized',\n    EventID == 1084, 'Replication latency',\n    EventID == 1085, 'Replication backlog',\n    EventID == 1088, 'Replication error',\n    EventID == 1566, 'SMTP replication failed',\n    EventID == 1864, 'Lingering objects detected',\n    EventID == 1925, 'Replication attempt failed',\n    EventID == 1926, 'RODC replication failed',\n    EventID == 1988, 'Lingering objects removed',\n    EventID == 2042, 'Replication failure - too long',\n    EventID == 2087, 'DNS resolution failed',\n    EventID == 2088, 'Could not locate DC',\n    EventID == 2089, 'Backup latency violation',\n    EventID == 2095, 'NTDS backup old',\n    strcat('Event ', EventID)\n)\n| summarize \n    Count = count(),\n    LastOccurrence = max(TimeGenerated)\n    by Computer, EventID, EventDescription, ReplicationStatus\n| order by ReplicationStatus asc, Count desc",
              "size": 0,
              "title": "üîÑ AD Replication Health (Directory Service Log)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "ReplicationHealthEvents"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Replication Status Summary\nlet ReplicationEvents = SecurityEvent\n    | where TimeGenerated {TimeRange}\n    | where EventID in (4932, 4933, 4934, 4935, 4936, 4937);\nlet SuccessEvents = ReplicationEvents | where EventID in (4932, 4933, 4934, 4937) | summarize SuccessCount = count() by Computer;\nlet FailureEvents = ReplicationEvents | where EventID in (4935, 4936) | summarize FailureCount = count() by Computer;\nlet AllDCs = SecurityEvent\n    | where TimeGenerated {TimeRange}\n    | where EventID in (4624, 4768, 4769)\n    | distinct Computer;\nAllDCs\n| join kind=leftouter (SuccessEvents) on Computer\n| join kind=leftouter (FailureEvents) on Computer\n| extend SuccessCount = coalesce(SuccessCount, 0)\n| extend FailureCount = coalesce(FailureCount, 0)\n| extend TotalReplication = SuccessCount + FailureCount\n| extend HealthStatus = case(\n    FailureCount > 0, 'üî¥ Failures Detected',\n    TotalReplication == 0, 'üü° No Replication Data',\n    'üü¢ Healthy'\n)\n| extend FailureRate = iff(TotalReplication > 0, round(todouble(FailureCount) / TotalReplication * 100, 1), 0.0)\n| project Computer, HealthStatus, SuccessCount, FailureCount, FailureRate, TotalReplication\n| order by FailureCount desc, SuccessCount desc",
              "size": 0,
              "title": "üìä Replication Status by DC (SecurityEvent)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ReplicationStatusByDC"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Replication Failures Timeline\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4935, 4936)\n| summarize FailureCount = count() by bin(TimeGenerated, 1h), Computer\n| render timechart",
              "size": 0,
              "title": "üìâ Replication Failures Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "ReplicationFailureTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Replication Health Overview\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4932, 4933, 4934, 4935, 4936, 4937)\n| extend ReplicationType = case(\n    EventID == 4932, 'üîÑ Replication Started',\n    EventID == 4933, '‚úÖ Replication Completed',\n    EventID == 4934, 'Attributes Replicated',\n    EventID == 4935, '‚ùå Replication Failure Started',\n    EventID == 4936, '‚ö†Ô∏è Replication Failure Ended',\n    EventID == 4937, 'üóëÔ∏è Lingering Object Removed',\n    'Other'\n)\n| summarize Count = count() by ReplicationType\n| extend SortOrder = case(\n    ReplicationType has 'Failure Started', 1,\n    ReplicationType has 'Failure Ended', 2,\n    ReplicationType has 'Started', 3,\n    ReplicationType has 'Completed', 4,\n    5\n)\n| order by SortOrder asc",
              "size": 2,
              "title": "üîÑ Replication Event Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  { "seriesName": "‚úÖ Replication Completed", "color": "green" },
                  { "seriesName": "üîÑ Replication Started", "color": "blue" },
                  { "seriesName": "‚ùå Replication Failure Started", "color": "red" },
                  { "seriesName": "‚ö†Ô∏è Replication Failure Ended", "color": "orange" },
                  { "seriesName": "üóëÔ∏è Lingering Object Removed", "color": "purple" }
                ]
              }
            },
            "customWidth": "50",
            "name": "ReplicationDistribution"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Recent Replication Activity Detail\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4932, 4933, 4934, 4935, 4936, 4937)\n| extend ReplicationEvent = case(\n    EventID == 4932, 'üîÑ Started',\n    EventID == 4933, '‚úÖ Completed',\n    EventID == 4934, 'üìù Attributes',\n    EventID == 4935, '‚ùå Failure Started',\n    EventID == 4936, '‚ö†Ô∏è Failure Ended',\n    EventID == 4937, 'üóëÔ∏è Lingering Removed',\n    'Other'\n)\n| extend IsError = iff(EventID in (4935, 4936), true, false)\n| project TimeGenerated, Computer, ReplicationEvent, EventID, Account, IsError\n| order by TimeGenerated desc\n| take 100",
              "size": 0,
              "title": "üìã Recent Replication Activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "IsError",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        { "operator": "==", "thresholdValue": "true", "representation": "error", "text": "" },
                        { "operator": "Default", "representation": "success", "text": "" }
                      ]
                    }
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "RecentReplicationActivity"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Group Policy Events\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4739, 5136, 5137)\n| where EventData has 'groupPolicy' or EventData has 'Group Policy' or Activity has 'Policy'\n| summarize \n    Count = count(),\n    Operations = make_set(Activity, 5)\n    by Computer, SubjectUserName\n| extend RiskLevel = case(\n    Count > 10, 'üü¢ High - Multiple GPO Changes',\n    'üü¢ Normal'\n)\n| order by Count desc",
              "size": 0,
              "title": "üìã Group Policy Changes",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "GPOChanges"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Security Log Cleared\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 1102\n| project TimeGenerated, Computer, Account, Activity\n| extend RiskLevel = 'üî¥ Critical - Security Log Cleared'\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üö® Security Log Cleared (Anti-Forensics)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "LogCleared"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Daily Event Volume by DC\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4625, 4768, 4769)\n| summarize DailyEvents = count() by Computer, bin(TimeGenerated, 1d)\n| summarize \n    AvgDaily = round(avg(DailyEvents), 0),\n    MaxDaily = max(DailyEvents),\n    MinDaily = min(DailyEvents),\n    TotalEvents = sum(DailyEvents)\n    by Computer\n| extend Variance = MaxDaily - MinDaily\n| extend Stability = case(\n    Variance > AvgDaily * 2, 'üü¢ High Variance',\n    Variance > AvgDaily, 'üü° Moderate Variance',\n    'üü¢ Stable'\n)\n| order by TotalEvents desc",
              "size": 0,
              "title": "üìä Daily Event Volume Statistics by DC",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "DCDailyVolume"
          },
          {
            "type": 1,
            "content": {
              "json": "### üü¢ Domain Controller Availability Monitoring\n\nMonitor DC availability based on event flow, detect silent periods, and track operational status."
            },
            "name": "DCAvailabilityHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DC Availability Status\nlet AvailabilityThreshold = 15m;\nlet AllDCs = SecurityEvent\n    | where TimeGenerated >= ago(30d)\n    | where EventID in (4624, 4625, 4768, 4769, 4776)\n    | distinct Computer;\nlet CurrentStatus = SecurityEvent\n    | where TimeGenerated >= ago(1h)\n    | where EventID in (4624, 4625, 4768, 4769, 4776)\n    | summarize \n        LastEvent = max(TimeGenerated),\n        EventsLast1h = count(),\n        EventsLast15m = countif(TimeGenerated >= ago(15m)),\n        EventsLast5m = countif(TimeGenerated >= ago(5m))\n        by Computer;\nAllDCs\n| join kind=leftouter (CurrentStatus) on Computer\n| extend LastEvent = coalesce(LastEvent, datetime(1970-01-01))\n| extend MinutesSinceLastEvent = datetime_diff('minute', now(), LastEvent)\n| extend AvailabilityStatus = case(\n    MinutesSinceLastEvent <= 5, 'üü¢ Online',\n    MinutesSinceLastEvent <= 15, 'üü° Delayed',\n    MinutesSinceLastEvent <= 60, 'üü¢ Stale',\n    'üî¥ Offline/No Data'\n)\n| extend EventsLast1h = coalesce(EventsLast1h, 0)\n| extend EventsLast15m = coalesce(EventsLast15m, 0)\n| extend EventsLast5m = coalesce(EventsLast5m, 0)\n| project Computer, AvailabilityStatus, LastEvent, MinutesSinceLastEvent, EventsLast5m, EventsLast15m, EventsLast1h\n| order by AvailabilityStatus asc, MinutesSinceLastEvent desc",
              "size": 0,
              "title": "üü¢ Domain Controller Availability Status (Real-Time)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "AvailabilityStatus",
                    "formatter": 1
                  }
                ]
              }
            },
            "name": "DCAvailabilityStatus"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DC Availability Overview Tiles\nlet AllDCs = SecurityEvent\n    | where TimeGenerated >= ago(30d)\n    | where EventID in (4624, 4625, 4768, 4769, 4776)\n    | distinct Computer\n    | summarize TotalDCs = count();\nlet OnlineDCs = SecurityEvent\n    | where TimeGenerated >= ago(5m)\n    | where EventID in (4624, 4625, 4768, 4769, 4776)\n    | distinct Computer\n    | summarize OnlineCount = count();\nlet DelayedDCs = SecurityEvent\n    | where TimeGenerated between (ago(15m) .. ago(5m))\n    | where EventID in (4624, 4625, 4768, 4769, 4776)\n    | distinct Computer\n    | summarize DelayedCount = count();\nlet StaleDCs = SecurityEvent\n    | where TimeGenerated between (ago(1h) .. ago(15m))\n    | where EventID in (4624, 4625, 4768, 4769, 4776)\n    | distinct Computer\n    | summarize StaleCount = count();\nAllDCs\n| extend OnlineCount = toscalar(OnlineDCs)\n| extend DelayedCount = toscalar(DelayedDCs)\n| extend StaleCount = toscalar(StaleDCs)\n| extend OfflineCount = TotalDCs - OnlineCount - DelayedCount - StaleCount\n| extend AvailabilityPct = round(todouble(OnlineCount) / TotalDCs * 100, 1)\n| project TotalDCs, OnlineCount, DelayedCount, StaleCount, OfflineCount, AvailabilityPct",
              "size": 4,
              "title": "üìä DC Availability Summary",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "TotalDCs", "formatter": 1 },
                "leftContent": { "columnMatch": "AvailabilityPct", "formatter": 12, "formatOptions": { "palette": "greenRed" }, "numberFormat": { "unit": 1, "options": { "style": "decimal", "maximumFractionDigits": 1 } } },
                "secondaryContent": { "columnMatch": "OnlineCount", "formatter": 1 },
                "showBorder": true
              }
            },
            "customWidth": "50",
            "name": "DCAvailabilitySummary"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DC Availability Pie Chart\nlet AllDCs = SecurityEvent\n    | where TimeGenerated >= ago(30d)\n    | where EventID in (4624, 4625, 4768, 4769, 4776)\n    | distinct Computer;\nlet DCStatus = SecurityEvent\n    | where TimeGenerated >= ago(1h)\n    | where EventID in (4624, 4625, 4768, 4769, 4776)\n    | summarize LastEvent = max(TimeGenerated) by Computer;\nAllDCs\n| join kind=leftouter (DCStatus) on Computer\n| extend MinutesSinceLastEvent = datetime_diff('minute', now(), coalesce(LastEvent, datetime(1970-01-01)))\n| extend Status = case(\n    MinutesSinceLastEvent <= 5, 'Online',\n    MinutesSinceLastEvent <= 15, 'Delayed',\n    MinutesSinceLastEvent <= 60, 'Stale',\n    'Offline'\n)\n| summarize Count = count() by Status",
              "size": 2,
              "title": "üü¢ DC Status Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  { "seriesName": "Online", "color": "green" },
                  { "seriesName": "Delayed", "color": "yellow" },
                  { "seriesName": "Stale", "color": "orange" },
                  { "seriesName": "Offline", "color": "red" }
                ]
              }
            },
            "customWidth": "50",
            "name": "DCStatusPie"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DC Heartbeat Timeline (Events per 30-min interval)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4625, 4768, 4769, 4776)\n| summarize EventCount = count() by Computer, bin(TimeGenerated, 30m)\n| where Computer in (\n    SecurityEvent\n    | where TimeGenerated {TimeRange}\n    | where EventID in (4624, 4625, 4768, 4769, 4776)\n    | summarize TotalCount = count() by Computer\n    | top 5 by TotalCount\n    | project Computer\n)\n| render timechart",
              "size": 0,
              "title": "üíì DC Heartbeat Timeline (30-min intervals)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "name": "DCHeartbeat"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DC Silent Periods Detection\nlet TimeSlots = SecurityEvent\n    | where TimeGenerated {TimeRange}\n    | where EventID in (4624, 4625, 4768, 4769, 4776)\n    | summarize EventCount = count() by Computer, TimeSlot = bin(TimeGenerated, 15m);\nlet AllTimeSlots = range TimeSlot from ago(7d) to now() step 15m\n    | extend placeholder = 1;\nlet AllDCs = SecurityEvent\n    | where TimeGenerated >= ago(7d)\n    | where EventID in (4624, 4625, 4768, 4769, 4776)\n    | distinct Computer\n    | extend placeholder = 1;\nAllDCs\n| join kind=inner (AllTimeSlots) on placeholder\n| project Computer, TimeSlot\n| join kind=leftanti (TimeSlots) on Computer, TimeSlot\n| summarize SilentPeriods = count(), SilentSlots = make_set(TimeSlot, 10) by Computer\n| where SilentPeriods > 0\n| extend SilentHours = round(todouble(SilentPeriods) * 15 / 60, 1)\n| extend RiskLevel = case(\n    SilentHours > 24, 'üî¥ Critical - Extended Outage',\n    SilentHours > 4, 'üü° Warning - Multiple Gaps',\n    SilentHours > 1, 'üü° Notice - Brief Gaps',\n    'üü¢ Normal'\n)\n| project Computer, SilentPeriods, SilentHours, RiskLevel\n| order by SilentHours desc",
              "size": 0,
              "title": "‚ö†Ô∏è DC Silent Periods (Gaps in Event Flow)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "DCSilentPeriods"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DC Uptime Calculation (Based on Event Flow)\nSecurityEvent\n| where TimeGenerated >= ago(7d)\n| where EventID in (4624, 4625, 4768, 4769, 4776)\n| summarize \n    FirstEvent = min(TimeGenerated),\n    LastEvent = max(TimeGenerated),\n    TotalEvents = count(),\n    ActiveHours = dcount(bin(TimeGenerated, 1h))\n    by Computer\n| extend TotalHoursInRange = 168 // 7 days * 24 hours\n| extend UptimePct = round(todouble(ActiveHours) / TotalHoursInRange * 100, 1)\n| extend AvgEventsPerHour = round(todouble(TotalEvents) / ActiveHours, 0)\n| extend UptimeStatus = case(\n    UptimePct >= 99, 'üü¢ Excellent',\n    UptimePct >= 95, 'üü¢ Good',\n    UptimePct >= 90, 'üü° Acceptable',\n    UptimePct >= 80, 'üü¢ Degraded',\n    'üî¥ Poor'\n)\n| project Computer, UptimePct, UptimeStatus, ActiveHours, TotalHoursInRange, TotalEvents, AvgEventsPerHour, FirstEvent, LastEvent\n| order by UptimePct desc",
              "size": 0,
              "title": "üìà DC Uptime (7-Day Event-Based)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "DCUptime"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DC Availability Trend (Hourly)\nlet HourlyEvents = SecurityEvent\n    | where TimeGenerated {TimeRange}\n    | where EventID in (4624, 4625, 4768, 4769, 4776)\n    | summarize EventCount = count() by Hour = bin(TimeGenerated, 1h);\nlet TotalDCs = toscalar(SecurityEvent\n    | where TimeGenerated >= ago(30d)\n    | where EventID in (4624, 4625, 4768, 4769, 4776)\n    | distinct Computer\n    | summarize count());\nlet HourlyDCCount = SecurityEvent\n    | where TimeGenerated {TimeRange}\n    | where EventID in (4624, 4625, 4768, 4769, 4776)\n    | summarize ActiveDCs = dcount(Computer) by Hour = bin(TimeGenerated, 1h);\nHourlyDCCount\n| extend TotalDCs = TotalDCs\n| extend AvailabilityPct = round(todouble(ActiveDCs) / TotalDCs * 100, 1)\n| project Hour, ActiveDCs, TotalDCs, AvailabilityPct\n| render timechart",
              "size": 0,
              "title": "üìä DC Availability Trend (Hourly)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "name": "DCAvailabilityTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DC Recovery Events (Coming back online after silent period)\nlet SilentThreshold = 30m;\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4625, 4768, 4769, 4776)\n| summarize Events = count() by Computer, TimeSlot = bin(TimeGenerated, 5m)\n| order by Computer, TimeSlot asc\n| extend PrevTimeSlot = prev(TimeSlot, 1)\n| extend PrevComputer = prev(Computer, 1)\n| extend GapMinutes = iff(Computer == PrevComputer, datetime_diff('minute', TimeSlot, PrevTimeSlot), 0)\n| where GapMinutes > 30\n| project RecoveryTime = TimeSlot, Computer, GapMinutes, EventsAfterRecovery = Events\n| extend GapDuration = strcat(GapMinutes, ' minutes')\n| extend RecoveryType = case(\n    GapMinutes > 240, 'üî¥ Major Outage Recovery',\n    GapMinutes > 60, 'üü¢ Extended Gap Recovery',\n    'üü° Brief Gap Recovery'\n)\n| order by RecoveryTime desc\n| take 20",
              "size": 0,
              "title": "üîÑ DC Recovery Events (Came Back Online After Gap)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "DCRecoveryEvents"
          },
          {
            "type": 1,
            "content": {
              "json": "### üíæ Domain Controller Backup Health\n\nMonitor backup operations on Domain Controllers. Regular backups are critical for AD disaster recovery. Attackers often target backup infrastructure before ransomware deployment.\n\n---\n\n#### üì° Required Data Collection for Backup Monitoring\n\n**Option 1: Windows Event Logs via AMA (Recommended)**\n\nAdd these XPath queries to your DCR:\n```\nApplication!*[System[Provider[@Name='Microsoft-Windows-Backup'] and (EventID=4 or EventID=5 or EventID=8 or EventID=9 or EventID=14 or EventID=17 or EventID=49 or EventID=50 or EventID=517 or EventID=518 or EventID=521 or EventID=527 or EventID=528 or EventID=544 or EventID=545 or EventID=546 or EventID=561)]]\nApplication!*[System[Provider[@Name='VSS']]]\nSystem!*[System[Provider[@Name='Microsoft-Windows-Backup']]]\n```\n\n**Key Backup Event IDs (Application Log - Microsoft-Windows-Backup):**\n| Event ID | Description |\n|----------|-------------|\n| 4 | Backup started |\n| 5 | Backup completed successfully |\n| 8 | Backup failed |\n| 9 | Backup completed with warnings |\n| 14 | System state backup started |\n| 17 | System state backup succeeded |\n| 49 | Backup job created |\n| 50 | Backup job status |\n| 517 | Catalog corruption detected |\n| 518 | Catalog rebuild started |\n| 521 | Full backup of volumes started |\n| 527 | Backup of system state started |\n| 528 | Backup operation finished |\n| 544 | Windows Server Backup configuration changed |\n| 545 | Scheduled backup enabled |\n| 546 | Scheduled backup disabled |\n| 561 | Backup target full |\n\n**VSS Shadow Copy Event IDs:**\n| Event ID | Source | Description |\n|----------|--------|-------------|\n| 8224 | VSS | Shadow copy created |\n| 8225 | VSS | Shadow copy deleted |\n| 12289 | VSS | VSS service started |\n| 12293 | VSS | Shadow copy aborted |\n\n**Option 2: Use SecurityEvent (Process Execution)**\n\nIf Event table is not available, use SecurityEvent 4688 to monitor backup tool execution (shown below)."
            },
            "name": "DCBackupHealthHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Windows Backup Events from Event Table\n// Requires: Windows Event Logs connector with Application/System logs\nlet BackupEventIDs = dynamic([4, 5, 8, 9, 14, 17, 49, 50, 517, 518, 521, 527, 528, 544, 545, 546, 561]);\nEvent\n| where TimeGenerated {TimeRange}\n| where Source has_any ('Microsoft-Windows-Backup', 'Backup', 'VSS', 'NTDS')\n    or (EventLog == 'Application' and EventID in (BackupEventIDs))\n| extend BackupResult = case(\n    EventID in (5, 17, 528), '‚úÖ Success',\n    EventID in (8, 517, 561), '‚ùå Failed',\n    EventID in (9), '‚ö†Ô∏è Warning',\n    EventID in (4, 14, 521, 527), 'üîÑ Started',\n    EventID in (545), 'üìÖ Scheduled Enabled',\n    EventID in (546), 'üî¥ Scheduled Disabled',\n    'üìã Info'\n)\n| summarize \n    TotalEvents = count(),\n    Successful = countif(BackupResult == '‚úÖ Success'),\n    Failed = countif(BackupResult == '‚ùå Failed'),\n    LastEvent = max(TimeGenerated),\n    EventTypes = make_set(BackupResult, 5)\n    by Computer, Source\n| extend DaysSinceEvent = datetime_diff('day', now(), LastEvent)\n| extend BackupStatus = case(\n    Failed > 0 and DaysSinceEvent <= 1, 'üî¥ Recent Failure',\n    DaysSinceEvent > 7, 'üî¥ No Recent Events',\n    DaysSinceEvent > 3, 'üü° Overdue',\n    Successful > 0, 'üü¢ Healthy',\n    'üü° Review'\n)\n| project Computer, Source, BackupStatus, DaysSinceEvent, LastEvent, Successful, Failed, TotalEvents\n| order by DaysSinceEvent desc",
              "size": 0,
              "title": "üíæ DC Backup Status (Event Table)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "DCBackupStatus"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Backup Tool Execution (SecurityEvent 4688)\n// Works when Event table is not available\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4688\n| where NewProcessName has_any ('wbadmin', 'ntdsutil', 'vssadmin', 'diskshadow', 'backup')\n    or CommandLine has_any ('wbadmin', 'ntdsutil', 'start backup', 'start systemstatebackup', 'create shadow')\n| extend ToolUsed = case(\n    NewProcessName has 'wbadmin', 'WBAdmin',\n    NewProcessName has 'ntdsutil', 'NTDSUTIL',\n    NewProcessName has 'vssadmin', 'VSSAdmin',\n    NewProcessName has 'diskshadow', 'DiskShadow',\n    'Other'\n)\n| extend OperationType = case(\n    CommandLine has_any ('start backup', 'start systemstatebackup'), 'üü¢ Backup Started',\n    CommandLine has 'start recovery', 'üîÑ Recovery',\n    CommandLine has 'create shadow', 'üì∏ Shadow Copy',\n    CommandLine has 'delete', 'üî¥ Deletion',\n    CommandLine has 'ifm', '‚ö†Ô∏è IFM Create',\n    CommandLine has 'get versions', 'üìã List Versions',\n    CommandLine has 'get status', 'üìä Status Check',\n    'üìã Other'\n)\n| summarize \n    OperationCount = count(),\n    LastOperation = max(TimeGenerated),\n    Operations = make_set(OperationType, 5),\n    Users = make_set(Account, 5)\n    by Computer, ToolUsed\n| extend DaysSinceBackup = datetime_diff('day', now(), LastOperation)\n| project Computer, ToolUsed, OperationCount, DaysSinceBackup, LastOperation, Operations, Users\n| order by LastOperation desc",
              "size": 0,
              "title": "üîß Backup Tool Activity (SecurityEvent 4688)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "BackupToolActivity"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// WBAdmin Backup Operations\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4688\n| where NewProcessName has 'wbadmin' or CommandLine has 'wbadmin'\n| extend BackupOperation = case(\n    CommandLine has 'start backup', 'üü¢ Backup Started',\n    CommandLine has 'start systemstatebackup', 'üü¢ System State Backup',\n    CommandLine has 'start recovery', 'üîÑ Recovery Started',\n    CommandLine has 'get status', 'üìä Status Check',\n    CommandLine has 'get versions', 'üìã Version List',\n    CommandLine has 'delete', 'üî¥ Deletion Attempt',\n    CommandLine has 'disable', 'üî¥ Backup Disabled',\n    'üü° Other Operation'\n)\n| project TimeGenerated, Computer, Account, BackupOperation, CommandLine, ParentProcessName\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üîß WBAdmin Backup Operations",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "WBAdminOperations"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// VSS Shadow Copy Operations\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4688\n| where NewProcessName has 'vssadmin' or CommandLine has 'vssadmin'\n| extend VSSOperation = case(\n    CommandLine has 'create shadow', 'üü¢ Shadow Copy Created',\n    CommandLine has 'list shadows', 'üìã Shadow List',\n    CommandLine has 'delete shadows', 'üî¥ Shadow Deletion',\n    CommandLine has 'resize shadowstorage', '‚ö†Ô∏è Storage Resize',\n    'üü° Other VSS Operation'\n)\n| project TimeGenerated, Computer, Account, VSSOperation, CommandLine, ParentProcessName\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üì∏ VSS Shadow Copy Operations",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "VSSOperations"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DC Backup Coverage Summary\n// Uses SecurityEvent to identify DCs and check for backup tool usage\nlet BackupActivity = SecurityEvent\n    | where TimeGenerated >= ago(30d)\n    | where EventID == 4688\n    | where NewProcessName has_any ('wbadmin', 'ntdsutil', 'vssadmin')\n        or CommandLine has_any ('start backup', 'start systemstatebackup', 'create shadow')\n    | summarize LastBackupTool = max(TimeGenerated) by Computer;\nlet AllDCs = SecurityEvent\n    | where TimeGenerated >= ago(30d)\n    | where EventID in (4624, 4768, 4769)\n    | distinct Computer;\nAllDCs\n| join kind=leftouter (BackupActivity) on Computer\n| extend DaysSinceBackup = iff(isnotnull(LastBackupTool), datetime_diff('day', now(), LastBackupTool), 999)\n| extend BackupHealth = case(\n    DaysSinceBackup == 999, 'üî¥ No Backup Activity',\n    DaysSinceBackup <= 1, 'üü¢ Backed Up Today',\n    DaysSinceBackup <= 3, 'üü¢ Recent Backup',\n    DaysSinceBackup <= 7, 'üü° Backup This Week',\n    DaysSinceBackup <= 14, 'üü° Backup > 1 Week',\n    'üî¥ Backup > 2 Weeks'\n)\n| summarize Count = count() by BackupHealth\n| order by Count desc",
              "size": 2,
              "title": "üìä DC Backup Coverage (Based on Tool Execution)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  { "seriesName": "üü¢ Backed Up Today", "color": "green" },
                  { "seriesName": "üü¢ Recent Backup", "color": "greenDark" },
                  { "seriesName": "üü° Backup This Week", "color": "yellow" },
                  { "seriesName": "üü° Backup > 1 Week", "color": "orange" },
                  { "seriesName": "üî¥ Backup > 2 Weeks", "color": "redBright" },
                  { "seriesName": "üî¥ No Backup Activity", "color": "red" }
                ]
              }
            },
            "customWidth": "50",
            "name": "DCBackupHealthPie"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Backup Tool Usage Timeline (30 Days)\nSecurityEvent\n| where TimeGenerated >= ago(30d)\n| where EventID == 4688\n| where NewProcessName has_any ('wbadmin', 'ntdsutil', 'vssadmin')\n    or CommandLine has_any ('start backup', 'start systemstatebackup', 'create shadow')\n| extend ToolType = case(\n    NewProcessName has 'wbadmin' or CommandLine has 'wbadmin', 'WBAdmin',\n    NewProcessName has 'ntdsutil' or CommandLine has 'ntdsutil', 'NTDSUTIL',\n    NewProcessName has 'vssadmin' or CommandLine has 'vssadmin', 'VSSAdmin',\n    'Other'\n)\n| summarize Count = count() by bin(TimeGenerated, 1d), ToolType\n| render timechart",
              "size": 0,
              "title": "üìà Backup Tool Usage Timeline (30 Days)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "BackupTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DC Backup Status Detail\nlet BackupActivity = SecurityEvent\n    | where TimeGenerated >= ago(30d)\n    | where EventID == 4688\n    | where NewProcessName has_any ('wbadmin', 'ntdsutil', 'vssadmin')\n        or CommandLine has_any ('start backup', 'start systemstatebackup', 'create shadow')\n    | summarize \n        LastBackupTool = max(TimeGenerated),\n        BackupCount = count(),\n        ToolsUsed = make_set(case(\n            NewProcessName has 'wbadmin', 'WBAdmin',\n            NewProcessName has 'ntdsutil', 'NTDSUTIL',\n            NewProcessName has 'vssadmin', 'VSSAdmin',\n            'Other'\n        ), 5)\n        by Computer;\nlet AllDCs = SecurityEvent\n    | where TimeGenerated >= ago(30d)\n    | where EventID in (4624, 4768, 4769)\n    | distinct Computer;\nAllDCs\n| join kind=leftouter (BackupActivity) on Computer\n| extend DaysSinceBackup = iff(isnotnull(LastBackupTool), datetime_diff('day', now(), LastBackupTool), -1)\n| extend BackupStatus = case(\n    DaysSinceBackup == -1, 'üî¥ No Backup Data',\n    DaysSinceBackup <= 1, 'üü¢ Healthy',\n    DaysSinceBackup <= 7, 'üü° Review',\n    'üî¥ Overdue'\n)\n| extend BackupCount = coalesce(BackupCount, 0)\n| project Computer, BackupStatus, DaysSinceBackup, LastBackupTool, BackupCount, ToolsUsed\n| order by DaysSinceBackup desc",
              "size": 0,
              "title": "üñ•Ô∏è DC Backup Status by Computer",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "DCBackupDetail"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìã Backup Best Practices for Domain Controllers\n\n| Requirement | Recommendation | Frequency |\n|-------------|----------------|-----------|\n| **System State Backup** | Required for AD recovery | Daily |\n| **Full DC Backup** | Complete server image | Weekly |\n| **SYSVOL Backup** | GPO and scripts | With System State |\n| **Backup Retention** | Minimum 60 days | Tombstone lifetime |\n| **Offsite/Offline Copy** | Air-gapped backup | Weekly |\n| **Backup Testing** | Test restore regularly | Monthly |\n\n‚ö†Ô∏è **Security Considerations:**\n- Protect backup files (contain all AD secrets)\n- Monitor for backup deletion attempts\n- Encrypt backup storage\n- Limit backup operator permissions\n- Alert on backup failures"
            },
            "name": "BackupBestPractices"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "dchealth"
      },
      "name": "DCHealthGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üõ°Ô∏è Microsoft Defender for Identity Coverage\n---\n\nMonitor Defender for Identity (MDI) sensor coverage and health across Domain Controllers. MDI provides advanced threat detection for Active Directory environments.\n\n**Benefits of MDI Integration:**\n- üîê Real-time detection of lateral movement attacks\n- üéØ Identification of compromised credentials\n- üö® Alert on suspicious authentication patterns\n- üìä User and Entity Behavior Analytics (UEBA)\n- üîó Integration with Microsoft 365 Defender"
            },
            "name": "MDIHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// MDI Sensor Coverage - Using all MDI tables\nlet MDISensors = union IdentityDirectoryEvents, IdentityLogonEvents, IdentityQueryEvents\n    | where TimeGenerated >= ago(24h)\n    | extend DCName = coalesce(DestinationDeviceName, DeviceName, TargetDeviceName)\n    | where isnotempty(DCName)\n    | summarize LastSeen = max(TimeGenerated), EventCount = count() by DCName\n    | extend DCNameShort = tolower(tostring(split(DCName, '.')[0]))\n    | extend SensorStatus = 'üü¢ MDI Active';\nlet AllDCs = SecurityEvent\n    | where TimeGenerated >= ago(7d)\n    | where EventID in (4624, 4768, 4769)\n    | extend DCNameShort = tolower(tostring(split(Computer, '.')[0]))\n    | distinct Computer, DCNameShort;\nAllDCs\n| join kind=leftouter (MDISensors) on DCNameShort\n| extend CoverageStatus = iff(isnotempty(SensorStatus), 'Covered', 'Not Covered')\n| summarize \n    TotalDCs = dcount(Computer),\n    CoveredDCs = dcountif(Computer, CoverageStatus == 'Covered'),\n    UncoveredDCs = dcountif(Computer, CoverageStatus == 'Not Covered')\n| extend CoveragePct = round(todouble(CoveredDCs) / TotalDCs * 100, 1)\n| extend Status = case(\n    CoveragePct == 100, 'üü¢ Full Coverage',\n    CoveragePct >= 80, 'üü° Partial Coverage',\n    CoveragePct > 0, 'üü† Low Coverage',\n    'üî¥ No Coverage'\n)\n| project Status, TotalDCs, CoveredDCs, UncoveredDCs, CoveragePct",
              "size": 4,
              "title": "üõ°Ô∏è MDI Sensor Coverage Overview",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "Status", "formatter": 1 },
                "leftContent": { "columnMatch": "CoveragePct", "formatter": 12, "formatOptions": { "palette": "greenRed" }, "numberFormat": { "unit": 1, "options": { "style": "decimal" } } },
                "secondaryContent": { "columnMatch": "CoveredDCs", "formatter": 1 },
                "showBorder": true
              }
            },
            "customWidth": "50",
            "name": "MDICoverageTile"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Check if IdentityDirectoryEvents table exists and has data\nunion withsource=TableName IdentityDirectoryEvents, IdentityLogonEvents, IdentityQueryEvents\n| where TimeGenerated >= ago(7d)\n| summarize EventCount = count(), LastEvent = max(TimeGenerated) by TableName\n| extend Status = case(\n    EventCount > 0 and datetime_diff('hour', now(), LastEvent) <= 24, 'üü¢ Active',\n    EventCount > 0, 'üü° Stale',\n    'üî¥ No Data'\n)\n| project TableName, EventCount, LastEvent, Status",
              "size": 0,
              "title": "üìä MDI Data Tables Status",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "MDITablesStatus"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Domain Controller MDI Coverage Detail\nlet MDIEvents = union IdentityDirectoryEvents, IdentityLogonEvents, IdentityQueryEvents\n    | where TimeGenerated >= ago(7d)\n    | extend DCName = coalesce(DestinationDeviceName, DeviceName, TargetDeviceName)\n    | where isnotempty(DCName)\n    | extend DCNameShort = tolower(tostring(split(DCName, '.')[0]))\n    | summarize \n        MDIEvents = count(), \n        LastMDIEvent = max(TimeGenerated),\n        MDIActionTypes = make_set(ActionType, 10),\n        MDITables = make_set(Type, 5)\n        by DCNameShort;\nlet SecurityEvents = SecurityEvent\n    | where TimeGenerated >= ago(7d)\n    | where EventID in (4624, 4625, 4768, 4769, 4776)\n    | extend DCNameShort = tolower(tostring(split(Computer, '.')[0]))\n    | summarize \n        SecEvents = count(),\n        LastSecEvent = max(TimeGenerated),\n        Computer = take_any(Computer)\n        by DCNameShort;\nSecurityEvents\n| join kind=leftouter (MDIEvents) on DCNameShort\n| extend MDIStatus = case(\n    isnotempty(LastMDIEvent) and datetime_diff('hour', now(), LastMDIEvent) <= 24, 'üü¢ Active',\n    isnotempty(LastMDIEvent) and datetime_diff('hour', now(), LastMDIEvent) <= 72, 'üü° Delayed',\n    isnotempty(LastMDIEvent), 'üü† Stale',\n    'üî¥ Not Covered'\n)\n| extend MDIEvents = coalesce(MDIEvents, 0)\n| extend HoursSinceLastMDI = iff(isnotempty(LastMDIEvent), datetime_diff('hour', now(), LastMDIEvent), -1)\n| project Computer, MDIStatus, MDIEvents, HoursSinceLastMDI, LastMDIEvent, SecEvents, LastSecEvent, MDIActionTypes, MDITables\n| order by MDIStatus asc, SecEvents desc",
              "size": 0,
              "title": "üñ•Ô∏è Domain Controller MDI Coverage Detail",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "DCMDICoverage"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// MDI Alert Summary\nSecurityAlert\n| where TimeGenerated {TimeRange}\n| where ProviderName has 'Identity' or ProductName has 'Azure ATP' or ProductName has 'Defender for Identity'\n| summarize \n    AlertCount = count(),\n    HighSeverity = countif(AlertSeverity == 'High'),\n    MediumSeverity = countif(AlertSeverity == 'Medium'),\n    LowSeverity = countif(AlertSeverity == 'Low')\n    by AlertName, AlertSeverity\n| order by HighSeverity desc, MediumSeverity desc, AlertCount desc\n| take 20",
              "size": 0,
              "title": "üö® MDI Security Alerts",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "MDIAlerts"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// MDI Detection Types\nIdentityDirectoryEvents\n| where TimeGenerated {TimeRange}\n| summarize Count = count() by ActionType\n| order by Count desc\n| take 15",
              "size": 2,
              "title": "üîê MDI Detection Types",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "MDIDetectionTypes"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìã MDI Coverage Requirements\n\n**For Full MDI Coverage, ensure:**\n1. ‚úÖ MDI Sensor installed on all Domain Controllers\n2. ‚úÖ Sensor service running and healthy\n3. ‚úÖ Network connectivity to MDI cloud service\n4. ‚úÖ Required ports open (443 outbound)\n5. ‚úÖ Directory Services account configured\n6. ‚úÖ SAM-R permissions for lateral movement detection\n\n**MDI Tables Used:**\n| Table | Description |\n|-------|-------------|\n| IdentityDirectoryEvents | AD directory operations |\n| IdentityLogonEvents | Authentication events |\n| IdentityQueryEvents | LDAP/DNS queries |\n| SecurityAlert | MDI alerts |\n\n**Note:** If MDI tables show no data, verify:\n- Defender for Identity license is active\n- Sensors are properly deployed\n- Data connector is configured in Sentinel"
            },
            "name": "MDIRequirements"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "mdi"
      },
      "name": "MDIGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## ‚ö†Ô∏è Security Misconfigurations & Posture Assessment\n---\n\nIdentify security misconfigurations, policy violations, and deviations from Active Directory security best practices.\n\n**Assessment Categories:**\n- üîê Authentication & Password Policies\n- üëë Privileged Access Management\n- üìù Audit Policy Coverage\n- üõ°Ô∏è Protocol Security (NTLM/Kerberos)\n- üñ•Ô∏è Domain Controller Hardening"
            },
            "name": "MisconfigHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Accounts with Password Never Expires (from logon events)\n// Detecting accounts that may have 'Password Never Expires' based on long-lived sessions\nSecurityEvent\n| where TimeGenerated >= ago(90d)\n| where EventID == 4624\n| where Account !endswith '$'\n| where Account !has 'SYSTEM' and Account !has 'LOCAL SERVICE' and Account !has 'NETWORK SERVICE'\n| summarize \n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated),\n    LogonCount = count(),\n    UniqueComputers = dcount(Computer)\n    by Account\n| extend AccountAgeDays = datetime_diff('day', now(), FirstSeen)\n| where AccountAgeDays > 365\n| extend RiskLevel = case(\n    AccountAgeDays > 730, 'üî¥ High - Active 2+ Years',\n    AccountAgeDays > 365, 'üü° Medium - Active 1+ Year',\n    'üü¢ Normal'\n)\n| extend Finding = 'Long-lived account - Review password policy'\n| project Account, AccountAgeDays, LogonCount, UniqueComputers, FirstSeen, LastSeen, RiskLevel, Finding\n| order by AccountAgeDays desc\n| take 30",
              "size": 0,
              "title": "üîê Long-Lived Accounts (Potential Password Never Expires)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "PasswordNeverExpires"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Accounts Using Interactive Logon\nlet ServiceAccountPatterns = dynamic(['svc', 'service', '_sa', '-sa', 'app', 'sql', 'backup', 'scan', 'task']);\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where LogonType in (2, 10, 11) // Interactive, RemoteInteractive, CachedInteractive\n| where Account has_any (ServiceAccountPatterns)\n| summarize \n    InteractiveLogons = count(),\n    LogonTypes = make_set(LogonType),\n    Computers = make_set(Computer, 10),\n    UniqueComputers = dcount(Computer),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by Account\n| extend RiskLevel = 'üî¥ High - Service Account Interactive Logon'\n| extend Finding = 'Service accounts should not use interactive logon'\n| extend Remediation = 'Configure for service logon (Type 5) only'\n| order by InteractiveLogons desc",
              "size": 0,
              "title": "‚ö†Ô∏è Service Accounts with Interactive Logon",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ServiceAccountInteractive"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Privileged Accounts with Network Logon (Pass-the-Hash Risk)\nlet PrivilegedKeywords = dynamic(['admin', 'administrator', 'domain admin', 'enterprise']);\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where LogonType == 3 // Network logon\n| where Account has_any (PrivilegedKeywords)\n| where Account !endswith '$'\n| summarize \n    NetworkLogons = count(),\n    UniqueTargets = dcount(Computer),\n    Targets = make_set(Computer, 10),\n    UniqueIPs = dcount(IpAddress),\n    SourceIPs = make_set(IpAddress, 5)\n    by Account\n| where UniqueTargets > 3\n| extend RiskLevel = case(\n    UniqueTargets > 10, 'üî¥ High - Many Targets',\n    UniqueTargets > 5, 'üü° Medium',\n    'üü° Low'\n)\n| extend Finding = 'Admin account used for network logons'\n| extend Remediation = 'Use Protected Users group or tiered admin model'\n| order by UniqueTargets desc",
              "size": 0,
              "title": "üëë Admin Accounts with Network Logon (PtH Risk)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "AdminNetworkLogon"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// NTLM Usage Detection (Should be minimized)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where AuthenticationPackageName has 'NTLM'\n| summarize \n    NTLMLogons = count(),\n    UniqueAccounts = dcount(Account),\n    Accounts = make_set(Account, 10),\n    UniqueComputers = dcount(Computer)\n    by Computer\n| extend RiskLevel = case(\n    NTLMLogons > 10000, 'üî¥ High - Heavy NTLM Usage',\n    NTLMLogons > 1000, 'üü° Medium - Significant NTLM',\n    'üü° Low'\n)\n| extend Finding = 'NTLM authentication in use'\n| extend Remediation = 'Migrate to Kerberos, enable NTLM auditing'\n| order by NTLMLogons desc",
              "size": 0,
              "title": "üîë NTLM Usage by Computer (Should Minimize)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "NTLMUsage"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Clear Text Password in NTLM (Type 8)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where LogonType == 8 // NetworkCleartext\n| summarize \n    ClearTextLogons = count(),\n    UniqueAccounts = dcount(Account),\n    Accounts = make_set(Account, 10),\n    UniqueComputers = dcount(Computer),\n    Computers = make_set(Computer, 5)\n    by IpAddress\n| extend RiskLevel = 'üî¥ Critical - Cleartext Credentials'\n| extend Finding = 'Passwords transmitted in cleartext'\n| extend Remediation = 'Disable Basic Auth, require Kerberos/NTLMv2'\n| order by ClearTextLogons desc",
              "size": 0,
              "title": "üö® Clear Text Password Logons (Type 8)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ClearTextLogon"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Accounts with Excessive Failed Logons (Weak Passwords)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4625\n| where Account !endswith '$'\n| summarize \n    FailedLogons = count(),\n    UniqueIPs = dcount(IpAddress),\n    FailureReasons = make_set(Status, 5),\n    LastFailure = max(TimeGenerated)\n    by Account\n| where FailedLogons > 50\n| extend RiskLevel = case(\n    FailedLogons > 500, 'üî¥ High - Possible Brute Force Target',\n    FailedLogons > 100, 'üü° Medium',\n    'üü° Low'\n)\n| extend Finding = 'Account with excessive failures'\n| extend Remediation = 'Review password strength, enable MFA'\n| order by FailedLogons desc\n| take 30",
              "size": 0,
              "title": "üîë Accounts with Excessive Failed Logons",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ExcessiveFailures"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Accounts Never Locked Despite Failures (Lockout Policy Issue)\nlet FailedAccounts = SecurityEvent\n    | where TimeGenerated {TimeRange}\n    | where EventID == 4625\n    | where Account !endswith '$'\n    | summarize FailedCount = count() by Account\n    | where FailedCount > 20;\nlet LockedAccounts = SecurityEvent\n    | where TimeGenerated {TimeRange}\n    | where EventID == 4740\n    | distinct TargetUserName;\nFailedAccounts\n| join kind=leftanti (LockedAccounts) on $left.Account == $right.TargetUserName\n| extend RiskLevel = case(\n    FailedCount > 100, 'üî¥ High - No Lockout Policy',\n    FailedCount > 50, 'üü° Medium',\n    'üü° Low'\n)\n| extend Finding = 'Account not locked despite failures'\n| extend Remediation = 'Review account lockout policy threshold'\n| order by FailedCount desc\n| take 20",
              "size": 0,
              "title": "üö´ Accounts Not Locked Despite Failures",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "NoLockout"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìä Security Posture Summary"
            },
            "name": "PostureSummaryHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Security Posture Checks\nlet NTLMRatio = toscalar(\n    SecurityEvent\n    | where TimeGenerated >= ago(7d)\n    | where EventID == 4624\n    | summarize \n        Total = count(),\n        NTLM = countif(AuthenticationPackageName has 'NTLM')\n    | extend Ratio = round(todouble(NTLM) / Total * 100, 1)\n    | project Ratio\n);\nlet ClearTextCount = toscalar(\n    SecurityEvent\n    | where TimeGenerated >= ago(7d)\n    | where EventID == 4624\n    | where LogonType == 8\n    | summarize count()\n);\nlet AdminNetworkLogons = toscalar(\n    SecurityEvent\n    | where TimeGenerated >= ago(7d)\n    | where EventID == 4624\n    | where LogonType == 3\n    | where Account has 'admin'\n    | summarize count()\n);\nlet ExternalRDP = toscalar(\n    SecurityEvent\n    | where TimeGenerated >= ago(7d)\n    | where EventID == 4624\n    | where LogonType == 10\n    | where not(ipv4_is_private(IpAddress))\n    | where IpAddress != '-' and IpAddress != '127.0.0.1'\n    | summarize count()\n);\nprint Check1 = 'NTLM Usage Ratio', Value1 = NTLMRatio, Check2 = 'Cleartext Logons', Value2 = ClearTextCount, Check3 = 'Admin Network Logons', Value3 = AdminNetworkLogons, Check4 = 'External RDP', Value4 = ExternalRDP\n| extend NTLMStatus = case(Value1 > 30, 'üî¥ High', Value1 > 10, 'üü° Medium', 'üü¢ Good')\n| extend ClearStatus = case(Value2 > 0, 'üî¥ Critical', 'üü¢ Good')\n| extend AdminStatus = case(Value3 > 1000, 'üî¥ High', Value3 > 100, 'üü° Medium', 'üü¢ Good')\n| extend RDPStatus = case(Value4 > 0, 'üî¥ Critical', 'üü¢ Good')\n| project Check1, Value1, NTLMStatus, Check2, Value2, ClearStatus, Check3, Value3, AdminStatus, Check4, Value4, RDPStatus",
              "size": 0,
              "title": "üìã Security Posture Checks (7-Day)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "PostureChecks"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Audit Policy Coverage Check\nlet RequiredEvents = datatable(EventID:int, Category:string, Importance:string) [\n    4624, 'Logon Success', 'Critical',\n    4625, 'Logon Failure', 'Critical',\n    4648, 'Explicit Credentials', 'High',\n    4672, 'Special Privileges', 'High',\n    4720, 'User Created', 'Critical',\n    4726, 'User Deleted', 'Critical',\n    4728, 'Group Member Added', 'Critical',\n    4732, 'Local Group Changed', 'High',\n    4740, 'Account Lockout', 'High',\n    4768, 'Kerberos TGT', 'Medium',\n    4769, 'Kerberos TGS', 'Medium',\n    4771, 'Kerberos Pre-Auth Fail', 'High',\n    4776, 'NTLM Validation', 'High',\n    5136, 'Directory Object Modified', 'High',\n    5137, 'Directory Object Created', 'Medium'\n];\nlet DetectedEvents = SecurityEvent\n    | where TimeGenerated >= ago(7d)\n    | distinct EventID;\nRequiredEvents\n| join kind=leftouter (DetectedEvents) on EventID\n| extend Status = iff(isnotempty(EventID1), 'üü¢ Detected', 'üî¥ Missing')\n| summarize \n    TotalRequired = count(),\n    Detected = countif(Status == 'üü¢ Detected'),\n    Missing = countif(Status == 'üî¥ Missing')\n| extend CoveragePct = round(todouble(Detected) / TotalRequired * 100, 1)\n| extend OverallStatus = case(\n    CoveragePct >= 90, 'üü¢ Good',\n    CoveragePct >= 70, 'üü¢ Needs Improvement',\n    'üî¥ Critical Gaps'\n)",
              "size": 4,
              "title": "üìä Audit Policy Coverage",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "OverallStatus", "formatter": 1 },
                "leftContent": { "columnMatch": "CoveragePct", "formatter": 12, "formatOptions": { "palette": "greenRed" }, "numberFormat": { "unit": 1, "options": { "style": "decimal", "maximumFractionDigits": 1 } } },
                "secondaryContent": { "columnMatch": "Missing", "formatter": 1 },
                "showBorder": true
              }
            },
            "customWidth": "50",
            "name": "AuditCoverage"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìã Security Best Practices Checklist\n\n**üîê Authentication Security:**\n| Check | Best Practice | Detection |\n|-------|---------------|-----------|\n| NTLM Minimization | Reduce NTLM to <10% | Monitor 4624 AuthPackage |\n| Clear Text Passwords | Zero tolerance | Detect LogonType 8 |\n| Kerberos RC4 | Disable RC4 encryption | Monitor 4769 encryption |\n| Password Policies | 14+ chars, complexity | Review 4723/4724 patterns |\n\n**üëë Privileged Access:**\n| Check | Best Practice | Detection |\n|-------|---------------|-----------|\n| Tiered Admin Model | Separate admin accounts | Monitor admin logon targets |\n| Protected Users | Add admins to group | Check network logon exposure |\n| PAW Usage | Admins use secure workstations | Monitor admin source IPs |\n| Just-In-Time Access | Time-limited privileges | Track 4728 patterns |\n\n**üñ•Ô∏è Domain Controller Hardening:**\n| Check | Best Practice | Detection |\n|-------|---------------|-----------|\n| RDP Access | Internal only, or disabled | Monitor external RDP |\n| Service Accounts | gMSA preferred | Detect interactive svc logon |\n| Audit Policies | Full security auditing | Check event coverage |\n| LDAP Signing | Required | Monitor for unsigned |\n\n**üõ°Ô∏è Detection Coverage:**\n| Check | Best Practice | Detection |\n|-------|---------------|-----------|\n| MDI Sensors | All DCs covered | Check MDI data flow |\n| Event Forwarding | Central collection | Verify DC event volume |\n| Alert Rules | Key attacks detected | Test detection coverage |"
            },
            "name": "BestPracticesChecklist"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "misconfig"
      },
      "name": "MisconfigGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üß† UEBA & Anomaly Detection\n---\n\nUser and Entity Behavior Analytics (UEBA) leverages machine learning to detect anomalous behavior patterns in Active Directory authentication and access events.\n\n**UEBA Tables Queried:**\n- ‚úÖ `BehaviorAnalytics` - ML-detected anomalies with SecurityEvent correlation\n- ‚úÖ `IdentityInfo` - User and entity enrichment with risk levels\n- ‚úÖ `UserPeerAnalytics` - Peer group deviations and blast radius\n- ‚úÖ `Anomalies` - Sentinel UEBA anomaly detections\n- ‚úÖ `SecurityEvent` - Z-Score statistical anomaly detection\n\n**Integration with SecurityEvent:**\nAll UEBA tables are correlated with Event IDs 4624, 4625, 4648, 4672, 4720, 4728, 4732 for comprehensive anomaly context."
            },
            "name": "UEBAHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// UEBA Anomalies Summary\nBehaviorAnalytics\n| where TimeGenerated {TimeRange}\n| summarize \n    TotalAnomalies = count(),\n    HighSeverity = countif(ActivityInsights has 'High' or InvestigationPriority > 7),\n    MediumSeverity = countif(InvestigationPriority between (4 .. 7)),\n    LowSeverity = countif(InvestigationPriority < 4)\n| extend Label = 'UEBA Anomalies'",
              "size": 4,
              "title": "üß† UEBA Anomalies Overview",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "Label", "formatter": 1 },
                "leftContent": { "columnMatch": "TotalAnomalies", "formatter": 12, "numberFormat": { "unit": 17, "options": { "style": "decimal" } } },
                "secondaryContent": { "columnMatch": "HighSeverity", "formatter": 1 },
                "showBorder": true
              }
            },
            "customWidth": "50",
            "name": "UEBASummaryTile"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Check UEBA Tables Availability\nunion withsource=TableName BehaviorAnalytics, IdentityInfo\n| where TimeGenerated >= ago(7d)\n| summarize RecordCount = count(), LastRecord = max(TimeGenerated) by TableName\n| extend Status = case(\n    RecordCount > 0 and datetime_diff('hour', now(), LastRecord) <= 24, 'üü¢ Active',\n    RecordCount > 0, 'üü° Stale',\n    'üî¥ No Data'\n)",
              "size": 0,
              "title": "üìä UEBA Tables Status",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "UEBATablesStatus"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top UEBA Anomalies by User\nBehaviorAnalytics\n| where TimeGenerated {TimeRange}\n| summarize \n    AnomalyCount = count(),\n    HighPriorityCount = countif(InvestigationPriority > 7),\n    AnomalyTypes = make_set(ActivityType, 10),\n    AvgPriority = avg(InvestigationPriority),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by UserPrincipalName, UserName\n| extend Account = coalesce(UserPrincipalName, UserName)\n| where isnotempty(Account)\n| extend RiskLevel = case(\n    HighPriorityCount > 5, 'üî¥ Critical',\n    HighPriorityCount > 0, 'üü¢ High',\n    AnomalyCount > 10, 'üü° Medium',\n    'üü¢ Low'\n)\n| project Account, AnomalyCount, HighPriorityCount, RiskLevel, AnomalyTypes, AvgPriority, FirstSeen, LastSeen\n| order by HighPriorityCount desc, AnomalyCount desc\n| take 20",
              "size": 0,
              "title": "üë§ Top Users by UEBA Anomalies",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "TopUserAnomalies"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// UEBA Anomaly Types Distribution\nBehaviorAnalytics\n| where TimeGenerated {TimeRange}\n| summarize Count = count() by ActivityType\n| order by Count desc",
              "size": 2,
              "title": "üìä Anomaly Types Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "AnomalyTypesPie"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// UEBA Investigation Priority Distribution\nBehaviorAnalytics\n| where TimeGenerated {TimeRange}\n| extend PriorityBand = case(\n    InvestigationPriority >= 8, 'Critical (8-10)',\n    InvestigationPriority >= 5, 'High (5-7)',\n    InvestigationPriority >= 3, 'Medium (3-4)',\n    'Low (0-2)'\n)\n| summarize Count = count() by PriorityBand",
              "size": 2,
              "title": "‚ö†Ô∏è Investigation Priority Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  { "seriesName": "Critical (8-10)", "color": "red" },
                  { "seriesName": "High (5-7)", "color": "orange" },
                  { "seriesName": "Medium (3-4)", "color": "yellow" },
                  { "seriesName": "Low (0-2)", "color": "green" }
                ]
              }
            },
            "customWidth": "33",
            "name": "PriorityDistribution"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// UEBA Anomaly Trend\nBehaviorAnalytics\n| where TimeGenerated {TimeRange}\n| extend PriorityBand = case(\n    InvestigationPriority >= 8, 'Critical',\n    InvestigationPriority >= 5, 'High',\n    'Medium/Low'\n)\n| summarize Count = count() by bin(TimeGenerated, 1h), PriorityBand\n| render timechart",
              "size": 0,
              "title": "üìà UEBA Anomaly Trend",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "34",
            "name": "AnomalyTrend"
          },
          {
            "type": 1,
            "content": {
              "json": "### üîê SecurityEvent Anomalies\n\nDetect anomalous patterns in Windows Security Events using statistical analysis."
            },
            "name": "SecurityEventAnomaliesHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Unusual Logon Time Anomalies\nlet HourlyBaseline = SecurityEvent\n    | where TimeGenerated between (ago(30d) .. ago(7d))\n    | where EventID == 4624\n    | extend Hour = datetime_part('Hour', TimeGenerated)\n    | summarize BaselineCount = count() by Account, Hour\n    | summarize AvgCount = avg(BaselineCount), StdDev = stdev(BaselineCount) by Account;\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| extend Hour = datetime_part('Hour', TimeGenerated)\n| summarize CurrentCount = count(), Computers = make_set(Computer, 5) by Account, Hour\n| join kind=inner (HourlyBaseline) on Account\n| extend ZScore = (CurrentCount - AvgCount) / StdDev\n| where ZScore > 3 or ZScore < -3\n| extend AnomalyType = iff(ZScore > 0, 'üî∫ Unusual Spike', 'üîª Unusual Drop')\n| project Account, Hour, CurrentCount, AvgCount, ZScore, AnomalyType, Computers\n| order by abs(ZScore) desc\n| take 20",
              "size": 0,
              "title": "‚è∞ Unusual Logon Time Patterns (Z-Score > 3)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "UnusualLogonTime"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// First-Time Access Anomalies\nlet HistoricalAccess = SecurityEvent\n    | where TimeGenerated between (ago(90d) .. ago(7d))\n    | where EventID == 4624\n    | distinct Account, Computer;\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| distinct Account, Computer, TimeGenerated, IpAddress, LogonType\n| join kind=leftanti (HistoricalAccess) on Account, Computer\n| summarize \n    FirstAccess = min(TimeGenerated),\n    AccessCount = count(),\n    IPs = make_set(IpAddress, 5),\n    LogonTypes = make_set(LogonType)\n    by Account, Computer\n| extend RiskLevel = case(\n    LogonTypes has '10', 'üî¥ High - First RDP',\n    LogonTypes has '3', 'üü° Medium - First Network',\n    'üü° Low - First Access'\n)\n| order by FirstAccess desc\n| take 30",
              "size": 0,
              "title": "üÜï First-Time Computer Access (90-Day Baseline)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "FirstTimeAccess"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Anomalous Failed Logon Patterns\nlet FailureBaseline = SecurityEvent\n    | where TimeGenerated between (ago(30d) .. ago(7d))\n    | where EventID == 4625\n    | summarize DailyFailures = count() by Account, bin(TimeGenerated, 1d)\n    | summarize AvgDaily = avg(DailyFailures), StdDaily = stdev(DailyFailures) by Account;\nSecurityEvent\n| where TimeGenerated >= ago(1d)\n| where EventID == 4625\n| summarize TodayFailures = count(), UniqueIPs = dcount(IpAddress), IPs = make_set(IpAddress, 5) by Account\n| join kind=inner (FailureBaseline) on Account\n| extend ZScore = (TodayFailures - AvgDaily) / StdDaily\n| where ZScore > 2\n| extend AnomalyLevel = case(\n    ZScore > 5, 'üî¥ Critical Anomaly',\n    ZScore > 3, 'üü¢ High Anomaly',\n    'üü° Moderate Anomaly'\n)\n| project Account, TodayFailures, AvgDaily, ZScore, AnomalyLevel, UniqueIPs, IPs\n| order by ZScore desc\n| take 20",
              "size": 0,
              "title": "‚ùå Anomalous Failed Logon Patterns (Today vs Baseline)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "AnomalousFailures"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Unusual Privilege Escalation\nlet PrivilegeBaseline = SecurityEvent\n    | where TimeGenerated between (ago(30d) .. ago(7d))\n    | where EventID == 4672\n    | summarize BaselinePrivEvents = count() by Account\n    | summarize AvgPriv = avg(BaselinePrivEvents), StdPriv = stdev(BaselinePrivEvents);\nlet AvgPriv = toscalar(PrivilegeBaseline | project AvgPriv);\nlet StdPriv = toscalar(PrivilegeBaseline | project StdPriv);\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4672\n| summarize \n    PrivilegeEvents = count(),\n    UniqueComputers = dcount(Computer),\n    Computers = make_set(Computer, 10),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by Account\n| extend ZScore = (PrivilegeEvents - AvgPriv) / StdPriv\n| where ZScore > 2\n| extend RiskLevel = case(\n    ZScore > 5, 'üî¥ Critical - Excessive Privileges',\n    ZScore > 3, 'üü¢ High - Elevated Privileges',\n    'üü° Medium - Above Normal'\n)\n| project Account, PrivilegeEvents, ZScore, RiskLevel, UniqueComputers, Computers\n| order by ZScore desc\n| take 20",
              "size": 0,
              "title": "üëë Unusual Special Privilege Assignment (4672)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "UnusualPrivileges"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// UEBA + SecurityEvent Correlation\nlet UEBAAnomalies = BehaviorAnalytics\n    | where TimeGenerated {TimeRange}\n    | where InvestigationPriority > 5\n    | project UEBATime = TimeGenerated, Account = coalesce(UserPrincipalName, UserName), ActivityType, InvestigationPriority;\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4625, 4648, 4672)\n| project SecurityTime = TimeGenerated, Account, EventID, Computer, IpAddress, LogonType\n| join kind=inner (UEBAAnomalies) on Account\n| where abs(datetime_diff('minute', SecurityTime, UEBATime)) <= 60\n| extend CorrelationType = case(\n    EventID == 4624, 'Anomaly + Successful Logon',\n    EventID == 4625, 'Anomaly + Failed Logon',\n    EventID == 4648, 'Anomaly + Explicit Credentials',\n    EventID == 4672, 'Anomaly + Privilege Assignment',\n    'Anomaly + Security Event'\n)\n| project SecurityTime, Account, CorrelationType, ActivityType, InvestigationPriority, Computer, IpAddress\n| order by InvestigationPriority desc, SecurityTime desc\n| take 30",
              "size": 0,
              "title": "üîó UEBA + SecurityEvent Correlation",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "UEBASecurityCorrelation"
          },
          {
            "type": 1,
            "content": {
              "json": "### √Ø¬ø¬Ω User Peer Analytics & Identity Correlation\n\nAnalyze user behavior deviations from peer groups and identity enrichment correlated with SecurityEvent data."
            },
            "name": "PeerAnalyticsHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// UserPeerAnalytics - Users with Peer Relationships\nUserPeerAnalytics\n| where TimeGenerated {TimeRange}\n| summarize \n    PeerCount = dcount(PeerUserId),\n    AvgPeerRank = avg(Rank),\n    TopPeers = make_set(PeerUserName, 5),\n    LatestUpdate = max(TimeGenerated)\n    by UserPrincipalName, UserName\n| extend UserAccount = coalesce(UserPrincipalName, UserName)\n| extend PeerStatus = case(\n    PeerCount == 0, 'üî¥ No Peers Identified',\n    PeerCount < 3, 'üü† Few Peers',\n    AvgPeerRank > 50, 'üü° Low Ranked Peers',\n    'üü¢ Normal Peer Network'\n)\n| where PeerStatus != 'üü¢ Normal Peer Network'\n| project UserAccount, PeerStatus, PeerCount, AvgPeerRank, TopPeers, LatestUpdate\n| order by PeerCount asc\n| take 30",
              "size": 0,
              "title": "üë• UserPeerAnalytics - Peer Group Analysis",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "UserPeerDeviations"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// UserPeerAnalytics + SecurityEvent Correlation\nlet UserPeers = UserPeerAnalytics\n    | where TimeGenerated {TimeRange}\n    | summarize PeerCount = dcount(PeerUserId), AvgRank = avg(Rank) by UserPrincipalName\n    | where PeerCount < 5 or AvgRank > 30\n    | project UserPrincipalName, PeerCount, AvgRank;\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4625, 4648, 4672)\n| extend UserUPN = tolower(TargetUserName)\n| join kind=inner (UserPeers | extend UserUPN = tolower(UserPrincipalName)) on UserUPN\n| summarize \n    Logons = countif(EventID == 4624),\n    Failures = countif(EventID == 4625),\n    ExplicitCreds = countif(EventID == 4648),\n    PrivilegeEvents = countif(EventID == 4672),\n    Computers = make_set(Computer, 5)\n    by TargetUserName, PeerCount, AvgRank\n| extend RiskIndicator = case(\n    PeerCount == 0 and Failures > 10, 'üî¥ No Peers + High Failures',\n    PeerCount < 3 and PrivilegeEvents > 0, 'üü† Few Peers + Privilege Use',\n    AvgRank > 50, 'üü° Low Ranked Peer Network',\n    'üü¢ Normal Activity'\n)\n| where RiskIndicator != 'üü¢ Normal Activity'\n| project TargetUserName, RiskIndicator, Logons, Failures, ExplicitCreds, PrivilegeEvents, PeerCount, AvgRank, Computers\n| order by Failures desc\n| take 25",
              "size": 0,
              "title": "üîó UserPeerAnalytics + SecurityEvent Correlation",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "PeerSecurityCorrelation"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Anomalies Table - Direct Sentinel UEBA Anomalies\nAnomalies\n| where TimeGenerated {TimeRange}\n| extend UserAccount = coalesce(UserPrincipalName, UserName)\n| project \n    TimeGenerated,\n    UserAccount,\n    AnomalyTemplateName,\n    RuleName,\n    AnomalyReasons,\n    Score,\n    ExtendedProperties\n| summarize \n    AnomalyCount = count(),\n    AvgScore = avg(Score),\n    AnomalyTypes = make_set(AnomalyTemplateName, 10),\n    LastSeen = max(TimeGenerated)\n    by UserAccount, RuleName\n| extend SeverityLevel = case(\n    AvgScore >= 0.8, 'üî¥ Critical',\n    AvgScore >= 0.6, 'üü¢ High',\n    AvgScore >= 0.4, 'üü° Medium',\n    'üü¢ Low'\n)\n| order by AvgScore desc\n| take 30",
              "size": 0,
              "title": "üéØ Anomalies Table - Sentinel UEBA Detected Anomalies",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "AnomaliesTable"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Anomalies + SecurityEvent Correlation\nlet DetectedAnomalies = Anomalies\n    | where TimeGenerated {TimeRange}\n    | where Score >= 0.5\n    | extend UserAccount = coalesce(UserPrincipalName, UserName)\n    | project AnomalyTime = TimeGenerated, UserAccount, AnomalyTemplateName, Score;\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4625, 4648, 4672, 4720, 4728, 4732)\n| join kind=inner (DetectedAnomalies) on $left.Account == $right.UserAccount\n| where abs(datetime_diff('hour', TimeGenerated, AnomalyTime)) <= 24\n| summarize \n    CorrelatedEvents = count(),\n    EventTypes = make_set(EventID),\n    Computers = make_set(Computer, 5),\n    IPs = make_set(IpAddress, 5)\n    by Account, AnomalyTemplateName, Score\n| extend EventDescription = strcat_array(EventTypes, ', ')\n| extend ThreatLevel = case(\n    Score >= 0.8 and EventTypes has '4672', 'üî¥ Critical - High Score + Privilege',\n    Score >= 0.8, 'üü¢ High - Elevated Anomaly Score',\n    EventTypes has '4728' or EventTypes has '4732', 'üü¢ High - Group Change During Anomaly',\n    'üü° Medium - Anomaly + Activity'\n)\n| project Account, AnomalyTemplateName, Score, ThreatLevel, EventDescription, CorrelatedEvents, Computers, IPs\n| order by Score desc\n| take 25",
              "size": 0,
              "title": "üîó Anomalies + SecurityEvent Correlation (24hr Window)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "AnomaliesSecurityCorrelation"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// IdentityInfo Enrichment + SecurityEvent\nlet EnrichedIdentities = IdentityInfo\n    | where TimeGenerated > ago(30d)\n    | summarize arg_max(TimeGenerated, *) by AccountUPN\n    | project \n        AccountUPN,\n        Department,\n        JobTitle,\n        Manager,\n        IsAccountEnabled,\n        RiskLevel,\n        RiskState,\n        GroupMembership,\n        AssignedRoles;\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4625, 4648, 4672)\n| summarize \n    TotalEvents = count(),\n    Failures4625 = countif(EventID == 4625),\n    ExplicitCreds4648 = countif(EventID == 4648),\n    Privilege4672 = countif(EventID == 4672),\n    Computers = make_set(Computer, 5)\n    by Account\n| join kind=leftouter (EnrichedIdentities) on $left.Account == $right.AccountUPN\n| extend RiskIndicator = case(\n    RiskLevel == 'high' or RiskState has 'atRisk', 'üî¥ Risky User',\n    Failures4625 > 10, 'üü¢ High Failure Count',\n    Privilege4672 > 50, 'üü¢ High Privilege Use',\n    'üü¢ Normal'\n)\n| where RiskIndicator != 'üü¢ Normal'\n| project Account, Department, JobTitle, RiskIndicator, RiskLevel, Failures4625, ExplicitCreds4648, Privilege4672, Computers, AssignedRoles\n| order by Failures4625 desc\n| take 30",
              "size": 0,
              "title": "üë§ IdentityInfo Enrichment + SecurityEvent Activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "IdentityInfoEnrichment"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// High Risk Identities from IdentityInfo with SecurityEvent Correlation\nlet HighRiskIdentities = IdentityInfo\n    | where TimeGenerated > ago(7d)\n    | where RiskLevel in ('high', 'medium') or RiskState has 'atRisk'\n    | summarize arg_max(TimeGenerated, *) by AccountUPN\n    | project AccountUPN, RiskLevel, RiskState, Department, JobTitle, AssignedRoles;\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| join kind=inner (HighRiskIdentities) on $left.Account == $right.AccountUPN\n| summarize \n    LogonCount = count(),\n    UniqueComputers = dcount(Computer),\n    Computers = make_set(Computer, 5),\n    LogonTypes = make_set(LogonType),\n    IPs = make_set(IpAddress, 5)\n    by Account, RiskLevel, RiskState, Department, JobTitle\n| extend ActivityRisk = case(\n    RiskLevel == 'high' and UniqueComputers > 5, 'üî¥ Critical - High Risk + Wide Access',\n    RiskLevel == 'high', 'üü¢ High - Risky Identity Active',\n    RiskState has 'atRisk' and LogonCount > 20, 'üü¢ High - At Risk + Frequent Logons',\n    'üü° Medium - Elevated Risk Activity'\n)\n| project Account, ActivityRisk, RiskLevel, RiskState, LogonCount, UniqueComputers, Department, Computers\n| order by UniqueComputers desc\n| take 25",
              "size": 0,
              "title": "üîê High Risk Identities - Active Logons",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "HighRiskIdentityLogons"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// UEBA Tables Data Availability Check\nlet BA = BehaviorAnalytics | where TimeGenerated {TimeRange} | count | extend Table = 'BehaviorAnalytics';\nlet UP = UserPeerAnalytics | where TimeGenerated {TimeRange} | count | extend Table = 'UserPeerAnalytics';\nlet AN = Anomalies | where TimeGenerated {TimeRange} | count | extend Table = 'Anomalies';\nlet II = IdentityInfo | where TimeGenerated > ago(30d) | count | extend Table = 'IdentityInfo';\nlet SE = SecurityEvent | where TimeGenerated {TimeRange} | where EventID in (4624, 4625, 4672) | count | extend Table = 'SecurityEvent';\nunion BA, UP, AN, II, SE\n| project Table, RecordCount = Count\n| extend Status = case(\n    RecordCount == 0, '‚ùå No Data',\n    RecordCount < 100, '‚ö†Ô∏è Limited Data',\n    '‚úÖ Data Available'\n)\n| order by Table asc",
              "size": 1,
              "title": "üìä UEBA Tables Data Availability",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "UEBADataAvailability"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìö UEBA Reference\n\n| Detection Type | Description | SecurityEvent Correlation |\n|----------------|-------------|------------------------------|\n| **Anomalous Logon** | Unusual time, location, or pattern | 4624, 4625 |\n| **Impossible Travel** | Logons from distant locations | 4624 + GeoIP |\n| **First Access** | Never-before-seen access patterns | 4624 |\n| **Lateral Movement** | Unusual cross-system authentication | 4624, 4648 |\n| **Privilege Anomaly** | Unusual privilege usage | 4672 |\n| **Password Spray** | Distributed failed logons | 4625 patterns |\n| **Kerberos Anomaly** | Unusual ticket requests | 4768, 4769, 4771 |\n\n**UEBA Requirements:**\n- Enable Microsoft Sentinel UEBA\n- Configure identity providers (Entra ID, on-prem AD)\n- Allow 14+ days for baseline building\n- Review Investigation Priority scores regularly"
            },
            "name": "UEBAReference"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "ueba"
      },
      "name": "UEBAGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üî¥ Credential Theft Detection\n\n**MITRE ATT&CK:** T1003 - OS Credential Dumping\n\nDetect NTDS.dit extraction, LSASS memory access, DCSync attacks, and credential theft techniques that go **beyond Defender for Identity** coverage.\n\n---"
            },
            "name": "CredTheftHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DCSync Attack Detection - Replication requests from non-DC\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4662\n| where Properties has_any (\"1131f6aa-9c07-11d1-f79f-00c04fc2dcd2\", \"1131f6ad-9c07-11d1-f79f-00c04fc2dcd2\", \"89e95b76-444d-4c62-991a-0facbeda640c\")\n| where not(SubjectUserName endswith \"$\")\n| summarize \n    ReplicationRequests = count(),\n    UniqueObjects = dcount(ObjectName),\n    Objects = make_set(ObjectName, 10),\n    FirstRequest = min(TimeGenerated),\n    LastRequest = max(TimeGenerated)\n    by SubjectUserName, SubjectDomainName, Computer, IpAddress\n| extend ThreatLevel = case(\n    not(Computer has_any (\"DC\", \"PDC\")), \"üî¥ CRITICAL - DCSync from Non-DC\",\n    ReplicationRequests > 100, \"üü† HIGH - Excessive Replication\",\n    \"üü° MEDIUM - Monitor\")\n| project ThreatLevel, SubjectUserName, Computer, IpAddress, ReplicationRequests, UniqueObjects, Objects, FirstRequest, LastRequest\n| order by ReplicationRequests desc",
              "size": 0,
              "title": "üî¥ DCSync Attack Detection (T1003.006)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "DCSync"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// NTDS.dit Access Detection - Volume Shadow Copy\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4688\n| where CommandLine has_any (\n    \"vssadmin create shadow\",\n    \"vssadmin list shadows\",\n    \"wmic shadowcopy call create\",\n    \"diskshadow\",\n    \"ntdsutil ifm\",\n    \"ntdsutil snapshot\",\n    \"esentutl /y\",\n    \"copy ntds.dit\",\n    \"secretsdump\"\n)\n| extend AttackStage = case(\n    CommandLine has \"create shadow\", \"üî¥ Shadow Copy Creation - NTDS.dit Theft\",\n    CommandLine has \"list shadows\", \"üü° Shadow Copy Enumeration\",\n    CommandLine has \"ifm\", \"üî¥ IFM Media Creation - DC Export\",\n    CommandLine has \"esentutl\", \"üî¥ Database Copy via Esentutl\",\n    CommandLine has \"secretsdump\", \"üî¥ Impacket SecretsDump\",\n    \"üü† Volume Shadow Activity\")\n| extend MITRETechnique = \"T1003.003 - NTDS\"\n| project TimeGenerated, Computer, SubjectUserName, NewProcessName, CommandLine, AttackStage, MITRETechnique\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üóÑÔ∏è NTDS.dit Extraction Detection (T1003.003)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "NTDSdit"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Credential Dumping Tools Detection\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4688\n| where CommandLine has_any (\n    \"mimikatz\", \"sekurlsa\", \"lsadump\", \"kerberos::\",\n    \"procdump\", \"comsvcs.dll\", \"MiniDump\",\n    \"Out-Minidump\", \"Invoke-Mimikatz\",\n    \"SafetyKatz\", \"SharpKatz\", \"BetterSafetyKatz\",\n    \"pypykatz\", \"LaZagne\", \"rubeus\"\n)\n| extend ToolDetected = case(\n    CommandLine has \"mimikatz\" or CommandLine has \"sekurlsa\", \"Mimikatz\",\n    CommandLine has \"procdump\" and CommandLine has \"lsass\", \"ProcDump LSASS\",\n    CommandLine has \"comsvcs.dll\", \"Comsvcs.dll MiniDump\",\n    CommandLine has \"rubeus\", \"Rubeus\",\n    CommandLine has \"pypykatz\", \"Pypykatz\",\n    CommandLine has \"LaZagne\", \"LaZagne\",\n    \"Other Credential Tool\")\n| extend ThreatLevel = \"üî¥ CRITICAL - Credential Theft Tool Detected\"\n| extend MITRETechnique = \"T1003.001 - LSASS Memory\"\n| project TimeGenerated, ThreatLevel, Computer, SubjectUserName, ToolDetected, CommandLine, MITRETechnique\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üõ†Ô∏è Credential Dumping Tools (T1003.001)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "CredTools"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// SAM/SECURITY Registry Hive Access\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4688\n| where CommandLine has_any (\n    \"reg save HKLM\\\\SAM\",\n    \"reg save HKLM\\\\SECURITY\",\n    \"reg save HKLM\\\\SYSTEM\",\n    \"save sam sam.hive\",\n    \"save security security.hive\"\n)\n| extend ThreatLevel = \"üî¥ CRITICAL - Registry Hive Export\"\n| extend MITRETechnique = \"T1003.002 - Security Account Manager\"\n| project TimeGenerated, ThreatLevel, Computer, SubjectUserName, CommandLine, MITRETechnique\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üîë SAM/SECURITY Hive Access (T1003.002)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "RegistryHive"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Kerberoasting Detection - RC4 Service Tickets\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4769\n| where not(ServiceName endswith \"$\")\n| where ServiceName !in (\"krbtgt\", \"kadmin\")\n| extend EncryptionType = extract(@\"Ticket Encryption Type:\\s*(0x[0-9a-fA-F]+)\", 1, Properties)\n| where EncryptionType in (\"0x17\", \"0x18\") or Properties has_any (\"0x17\", \"0x18\", \"RC4\")\n| summarize \n    RequestCount = count(),\n    UniqueServices = dcount(ServiceName),\n    ServiceList = make_set(ServiceName, 20),\n    FirstRequest = min(TimeGenerated),\n    LastRequest = max(TimeGenerated)\n    by TargetUserName, TargetDomainName, IpAddress\n| where UniqueServices >= 3 or RequestCount >= 10\n| extend ThreatLevel = case(\n    UniqueServices >= 20, \"üî¥ CRITICAL - Mass Kerberoasting\",\n    UniqueServices >= 10, \"üî¥ HIGH - Active Kerberoasting\",\n    RequestCount >= 50, \"üü† MEDIUM - SPN Enumeration\",\n    \"üü° LOW - Suspicious Activity\")\n| extend MITRETechnique = \"T1558.003 - Kerberoasting\"\n| project ThreatLevel, TargetUserName, IpAddress, RequestCount, UniqueServices, ServiceList, FirstRequest, LastRequest, MITRETechnique\n| order by UniqueServices desc",
              "size": 0,
              "title": "üé´ Kerberoasting Detection (T1558.003)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "Kerberoasting"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AS-REP Roasting Detection\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4768\n| extend EncryptionType = extract(@\"Ticket Encryption Type:\\s*(0x[0-9a-fA-F]+)\", 1, Properties)\n| extend PreAuth = extract(@\"Pre-Authentication Type:\\s*(\\d+)\", 1, Properties)\n| where EncryptionType in (\"0x17\", \"0x18\") or Properties has_any (\"0x17\", \"0x18\", \"RC4\")\n| where PreAuth == \"0\" or Properties has \"Pre-Authentication Type:\\t0\"\n| summarize \n    RequestCount = count(),\n    UniqueAccounts = dcount(TargetUserName),\n    AccountList = make_set(TargetUserName, 20),\n    FirstRequest = min(TimeGenerated),\n    LastRequest = max(TimeGenerated)\n    by IpAddress, TargetDomainName\n| where UniqueAccounts >= 2 or RequestCount >= 10\n| extend ThreatLevel = case(\n    UniqueAccounts >= 10, \"üî¥ CRITICAL - AS-REP Roasting Campaign\",\n    UniqueAccounts >= 5, \"üî¥ HIGH - Active AS-REP Roasting\",\n    \"üü† MEDIUM - Suspicious Kerberos Activity\")\n| extend MITRETechnique = \"T1558.004 - AS-REP Roasting\"\n| project ThreatLevel, IpAddress, TargetDomainName, RequestCount, UniqueAccounts, AccountList, FirstRequest, LastRequest, MITRETechnique\n| order by UniqueAccounts desc",
              "size": 0,
              "title": "üîì AS-REP Roasting Detection (T1558.004)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ASREPRoast"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Pass-the-Hash Detection - NTLM Network Logons with Admin\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where LogonType == 3\n| where AuthenticationPackageName == \"NTLM\"\n| where TargetUserName !endswith \"$\"\n| join kind=leftouter (\n    SecurityEvent\n    | where EventID == 4672\n    | summarize HasPrivileges = count() by TargetUserName, TargetLogonId\n) on TargetUserName, TargetLogonId\n| where HasPrivileges > 0\n| summarize \n    LogonCount = count(),\n    UniqueComputers = dcount(Computer),\n    ComputerList = make_set(Computer, 10),\n    UniqueSourceIPs = dcount(IpAddress),\n    SourceIPs = make_set(IpAddress, 5)\n    by TargetUserName, TargetDomainName\n| where UniqueComputers >= 3\n| extend ThreatLevel = case(\n    UniqueComputers >= 10, \"üî¥ CRITICAL - Widespread Lateral Movement\",\n    UniqueComputers >= 5, \"üî¥ HIGH - Active Lateral Movement\",\n    \"üü† MEDIUM - Suspicious NTLM Activity\")\n| extend MITRETechnique = \"T1550.002 - Pass the Hash\"\n| project ThreatLevel, TargetUserName, LogonCount, UniqueComputers, ComputerList, UniqueSourceIPs, SourceIPs, MITRETechnique\n| order by UniqueComputers desc",
              "size": 0,
              "title": "üîê Pass-the-Hash Detection (T1550.002)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "PassTheHash"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "credtheft"
      },
      "name": "CredTheftGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üü£ Persistence Detection\n\n**MITRE ATT&CK:** T1098 - Account Manipulation, T1556 - Modify Authentication Process\n\nDetect AdminSDHolder abuse, SID History injection, Shadow Credentials, and GPO persistence - attacks **NOT covered by MDI**.\n\n---"
            },
            "name": "PersistenceHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Privileged Group Membership Changes\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4728, 4732, 4756, 4751, 4761)\n| where TargetUserName has_any (\n    \"Domain Admins\", \"Enterprise Admins\", \"Schema Admins\",\n    \"Administrators\", \"Account Operators\", \"Backup Operators\",\n    \"Server Operators\", \"DnsAdmins\", \"Group Policy Creator Owners\")\n| extend Actor = SubjectUserName\n| extend AddedMember = MemberName\n| extend GroupModified = TargetUserName\n| extend ThreatLevel = case(\n    GroupModified has_any (\"Enterprise Admins\", \"Schema Admins\"), \"üî¥ CRITICAL\",\n    GroupModified has \"Domain Admins\", \"üî¥ HIGH\",\n    \"üü† MEDIUM\")\n| extend MITRETechnique = \"T1098.002 - Add to AD Group\"\n| project TimeGenerated, ThreatLevel, GroupModified, AddedMember, Actor, Computer, MITRETechnique\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üëë Privileged Group Changes (T1098.002)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "PrivGroupChanges"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AdminSDHolder Modifications\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 5136\n| where ObjectName has \"CN=AdminSDHolder,CN=System\"\n| extend ModifiedBy = SubjectUserName\n| extend ModifiedAttribute = extract(@\"LDAP Display Name:\\s*([^\\r\\n]+)\", 1, Properties)\n| extend ThreatLevel = \"üî¥ CRITICAL - AdminSDHolder Modified\"\n| extend Description = \"SDProp will propagate these permissions to all protected groups\"\n| project TimeGenerated, ThreatLevel, ModifiedBy, ModifiedAttribute, ObjectName, Computer, Description\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üõ°Ô∏è AdminSDHolder Modifications (SDProp Persistence)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "AdminSDHolder"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// SID History Injection\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4765\n   or (EventID == 5136 and Properties has \"sIDHistory\")\n| extend TargetAccount = coalesce(TargetUserName, ObjectName)\n| extend InjectedSID = coalesce(SidHistory, extract(@\"Value:\\s*([S-][0-9-]+)\", 1, Properties))\n| extend ModifiedBy = SubjectUserName\n| extend ThreatLevel = case(\n    InjectedSID has \"-500\", \"üî¥ CRITICAL - Domain Admin SID Injected\",\n    InjectedSID has \"-519\", \"üî¥ CRITICAL - Enterprise Admin SID Injected\",\n    InjectedSID has \"-512\", \"üî¥ CRITICAL - Domain Admins SID Injected\",\n    \"üü† HIGH - SID History Modification\")\n| extend MITRETechnique = \"T1134.005 - SID-History Injection\"\n| project TimeGenerated, ThreatLevel, TargetAccount, InjectedSID, ModifiedBy, Computer, MITRETechnique\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üÜî SID History Injection (T1134.005)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "SIDHistory"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Shadow Credentials - msDS-KeyCredentialLink\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 5136\n| where Properties has \"msDS-KeyCredentialLink\"\n| extend TargetAccount = ObjectName\n| extend ModifiedBy = SubjectUserName\n| extend ThreatLevel = \"üî¥ CRITICAL - Shadow Credentials Added\"\n| extend MITRETechnique = \"T1556 - Modify Authentication Process\"\n| extend Description = \"Attacker can now authenticate as this account using their key\"\n| project TimeGenerated, ThreatLevel, ModifiedBy, TargetAccount, Computer, Description, MITRETechnique\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üîë Shadow Credentials Detection (NOT in MDI)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ShadowCreds"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// GPO Modifications (Persistence)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 5136\n| where ObjectType has \"groupPolicyContainer\" or ObjectName has \"CN=Policies,CN=System\"\n| where Properties has_any (\n    \"ScheduledTasks\", \"Scripts\", \"Services\",\n    \"Registry.pol\", \"GptTmpl.inf\", \"security.inf\", \"gPCFileSysPath\", \"gPCMachineExtensionNames\")\n| extend GPOName = extract(@\"CN=\\{([^}]+)\\}\", 1, ObjectName)\n| extend ModifiedBy = SubjectUserName\n| extend ModifiedAttribute = extract(@\"LDAP Display Name:\\s*([^\\r\\n]+)\", 1, Properties)\n| extend ThreatLevel = \"üü† HIGH - GPO Modified with Persistence\"\n| extend MITRETechnique = \"T1484.001 - GPO Modification\"\n| project TimeGenerated, ThreatLevel, GPOName, ModifiedBy, ModifiedAttribute, Computer, MITRETechnique\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üìã GPO Persistence Detection (T1484.001)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "GPOPersistence"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// DCShadow Attack Detection - Rogue DC SPN Registration\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4742\n| where TargetUserName endswith \"$\"\n| where Properties has_any (\n    \"GC/\", \"E3514235-4B06-11D1-AB04-00C04FC2DCD2\",\n    \"ldap/\", \"DNS/\", \"servicePrincipalName\")\n| extend ServicePrincipalNames = extract(@\"Service Principal Names:\\s*([^\\r\\n]+)\", 1, Properties)\n| extend ThreatLevel = \"üî¥ CRITICAL - Possible DCShadow Attack\"\n| extend MITRETechnique = \"T1207 - DCShadow\"\n| extend Description = \"Non-DC computer registered with DC SPN\"\n| project TimeGenerated, ThreatLevel, TargetUserName, ServicePrincipalNames, SubjectUserName, Computer, MITRETechnique\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üë§ DCShadow Detection (T1207) - NOT in MDI",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "DCShadow"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "persistence"
      },
      "name": "PersistenceGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üî¨ Forensic Investigation\n\nDeep-dive investigation queries for incident response and forensic analysis. Use these to reconstruct attack timelines and investigate compromised accounts.\n\n---"
            },
            "name": "ForensicsHeader"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "inv-user",
                  "version": "KqlParameterItem/1.0",
                  "name": "InvestigateUser",
                  "label": "Investigate User",
                  "type": 1,
                  "value": ""
                },
                {
                  "id": "inv-ip",
                  "version": "KqlParameterItem/1.0",
                  "name": "InvestigateIP",
                  "label": "Investigate IP",
                  "type": 1,
                  "value": ""
                },
                {
                  "id": "inv-server",
                  "version": "KqlParameterItem/1.0",
                  "name": "InvestigateServer",
                  "label": "Investigate Server",
                  "type": 1,
                  "value": ""
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "ForensicsParams"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Attack Chain Detection - Full Kill Chain Summary\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4625, 4624, 4672, 4648, 4728, 4732, 4756, 4662, 4768, 4769, 4688)\n| extend AttackPhase = case(\n    EventID == 4625, \"1Ô∏è‚É£ Recon/Brute Force\",\n    EventID == 4624 and LogonType in (3, 10), \"2Ô∏è‚É£ Initial Access\",\n    EventID == 4648, \"3Ô∏è‚É£ Credential Access\",\n    EventID == 4672, \"4Ô∏è‚É£ Privilege Escalation\",\n    EventID in (4728, 4732, 4756), \"5Ô∏è‚É£ Persistence\",\n    EventID == 4662 and Properties has \"1131f6a\", \"6Ô∏è‚É£ DCSync/Exfil\",\n    EventID in (4768, 4769), \"7Ô∏è‚É£ Kerberos Activity\",\n    EventID == 4688 and CommandLine has_any (\"mimikatz\", \"sekurlsa\", \"procdump\"), \"3Ô∏è‚É£ Credential Theft\",\n    \"Other\")\n| where AttackPhase != \"Other\"\n| summarize \n    EventCount = count(),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated),\n    UniqueUsers = dcount(TargetUserName),\n    UniqueComputers = dcount(Computer),\n    SampleUsers = make_set(TargetUserName, 5),\n    SampleComputers = make_set(Computer, 5)\n    by AttackPhase\n| extend Severity = case(\n    AttackPhase has \"DCSync\" or AttackPhase has \"Credential Theft\", \"üî¥ Critical\",\n    AttackPhase has \"Privilege\" or AttackPhase has \"Persistence\", \"üü† High\",\n    AttackPhase has \"Brute Force\" or AttackPhase has \"Initial\", \"üü° Medium\",\n    \"üü¢ Low\")\n| project Severity, AttackPhase, EventCount, FirstSeen, LastSeen, UniqueUsers, UniqueComputers, SampleUsers, SampleComputers\n| order by AttackPhase asc",
              "size": 0,
              "title": "üîó Attack Chain Timeline - Click a phase to see details",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Severity", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "contains", "thresholdValue": "Critical", "representation": "red", "text": "{0}"}, {"operator": "contains", "thresholdValue": "High", "representation": "orange", "text": "{0}"}, {"operator": "contains", "thresholdValue": "Medium", "representation": "yellow", "text": "{0}"}, {"operator": "Default", "representation": "green", "text": "{0}"}] } },
                  { "columnMatch": "EventCount", "formatter": 4, "formatOptions": { "palette": "redGreen" } }
                ],
                "filter": true
              },
              "exportFieldName": "AttackPhase",
              "exportParameterName": "SelectedAttackPhase",
              "exportDefaultValue": ""
            },
            "customWidth": "60",
            "name": "AttackChain"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Attack Chain Timeline Visualization\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4625, 4624, 4672, 4648, 4728, 4732, 4756, 4662, 4768, 4769, 4688)\n| extend AttackPhase = case(\n    EventID == 4625, \"1Ô∏è‚É£ Recon/Brute Force\",\n    EventID == 4624 and LogonType in (3, 10), \"2Ô∏è‚É£ Initial Access\",\n    EventID == 4648, \"3Ô∏è‚É£ Credential Access\",\n    EventID == 4672, \"4Ô∏è‚É£ Privilege Escalation\",\n    EventID in (4728, 4732, 4756), \"5Ô∏è‚É£ Persistence\",\n    EventID == 4662 and Properties has \"1131f6a\", \"6Ô∏è‚É£ DCSync/Exfil\",\n    EventID in (4768, 4769), \"7Ô∏è‚É£ Kerberos Activity\",\n    EventID == 4688 and CommandLine has_any (\"mimikatz\", \"sekurlsa\", \"procdump\"), \"3Ô∏è‚É£ Credential Theft\",\n    \"Other\")\n| where AttackPhase != \"Other\"\n| summarize Events = count() by AttackPhase, bin(TimeGenerated, 1h)\n| render columnchart",
              "size": 0,
              "title": "üìä Attack Phase Activity Over Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "columnchart"
            },
            "customWidth": "40",
            "name": "AttackChainChart"
          },
          {
            "type": 1,
            "content": {
              "json": "### üîç Attack Phase Details: {SelectedAttackPhase}\n\n*Click a phase above to see detailed events for that attack stage.*"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedAttackPhase",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "AttackPhaseDetailsHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Attack Phase Detailed Events\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4625, 4624, 4672, 4648, 4728, 4732, 4756, 4662, 4768, 4769, 4688)\n| extend AttackPhase = case(\n    EventID == 4625, \"1Ô∏è‚É£ Recon/Brute Force\",\n    EventID == 4624 and LogonType in (3, 10), \"2Ô∏è‚É£ Initial Access\",\n    EventID == 4648, \"3Ô∏è‚É£ Credential Access\",\n    EventID == 4672, \"4Ô∏è‚É£ Privilege Escalation\",\n    EventID in (4728, 4732, 4756), \"5Ô∏è‚É£ Persistence\",\n    EventID == 4662 and Properties has \"1131f6a\", \"6Ô∏è‚É£ DCSync/Exfil\",\n    EventID in (4768, 4769), \"7Ô∏è‚É£ Kerberos Activity\",\n    EventID == 4688 and CommandLine has_any (\"mimikatz\", \"sekurlsa\", \"procdump\"), \"3Ô∏è‚É£ Credential Theft\",\n    \"Other\")\n| where AttackPhase == \"{SelectedAttackPhase}\"\n| extend RiskIndicator = case(\n    EventID == 4662 and Properties has \"1131f6a\", \"üî¥ CRITICAL - DCSync\",\n    EventID == 4688 and CommandLine has_any (\"mimikatz\", \"sekurlsa\"), \"üî¥ CRITICAL - Credential Tool\",\n    EventID == 4672, \"üü† HIGH - Privilege Assignment\",\n    EventID in (4728, 4732, 4756), \"üü† HIGH - Group Modification\",\n    EventID == 4625, \"üü° MEDIUM - Failed Logon\",\n    \"üü¢ INFO\")\n| project TimeGenerated, RiskIndicator, EventID, Computer, TargetUserName, SubjectUserName, IpAddress, Activity, CommandLine\n| order by TimeGenerated desc\n| take 100",
              "size": 0,
              "title": "üìã Detailed Events for: {SelectedAttackPhase}",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "RiskIndicator", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "contains", "thresholdValue": "CRITICAL", "representation": "red", "text": "{0}"}, {"operator": "contains", "thresholdValue": "HIGH", "representation": "orange", "text": "{0}"}, {"operator": "contains", "thresholdValue": "MEDIUM", "representation": "yellow", "text": "{0}"}, {"operator": "Default", "representation": "green", "text": "{0}"}] } },
                  { "columnMatch": "TimeGenerated", "formatter": 6 }
                ],
                "filter": true
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedAttackPhase",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "AttackPhaseDetails"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Attack Phase - Top Accounts Involved\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4625, 4624, 4672, 4648, 4728, 4732, 4756, 4662, 4768, 4769, 4688)\n| extend AttackPhase = case(\n    EventID == 4625, \"1Ô∏è‚É£ Recon/Brute Force\",\n    EventID == 4624 and LogonType in (3, 10), \"2Ô∏è‚É£ Initial Access\",\n    EventID == 4648, \"3Ô∏è‚É£ Credential Access\",\n    EventID == 4672, \"4Ô∏è‚É£ Privilege Escalation\",\n    EventID in (4728, 4732, 4756), \"5Ô∏è‚É£ Persistence\",\n    EventID == 4662 and Properties has \"1131f6a\", \"6Ô∏è‚É£ DCSync/Exfil\",\n    EventID in (4768, 4769), \"7Ô∏è‚É£ Kerberos Activity\",\n    EventID == 4688 and CommandLine has_any (\"mimikatz\", \"sekurlsa\", \"procdump\"), \"3Ô∏è‚É£ Credential Theft\",\n    \"Other\")\n| where AttackPhase == \"{SelectedAttackPhase}\"\n| where TargetUserName != \"-\" and TargetUserName != \"\"\n| summarize EventCount = count(), Computers = make_set(Computer, 5), SourceIPs = make_set(IpAddress, 5) by TargetUserName\n| top 10 by EventCount desc\n| project Account = TargetUserName, EventCount, Computers, SourceIPs",
              "size": 0,
              "title": "üë§ Top Accounts in this Attack Phase",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "EventCount", "formatter": 4, "formatOptions": { "palette": "redGreen" } }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedAttackPhase",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "AttackPhaseAccounts"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Attack Phase - Top Computers Involved\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4625, 4624, 4672, 4648, 4728, 4732, 4756, 4662, 4768, 4769, 4688)\n| extend AttackPhase = case(\n    EventID == 4625, \"1Ô∏è‚É£ Recon/Brute Force\",\n    EventID == 4624 and LogonType in (3, 10), \"2Ô∏è‚É£ Initial Access\",\n    EventID == 4648, \"3Ô∏è‚É£ Credential Access\",\n    EventID == 4672, \"4Ô∏è‚É£ Privilege Escalation\",\n    EventID in (4728, 4732, 4756), \"5Ô∏è‚É£ Persistence\",\n    EventID == 4662 and Properties has \"1131f6a\", \"6Ô∏è‚É£ DCSync/Exfil\",\n    EventID in (4768, 4769), \"7Ô∏è‚É£ Kerberos Activity\",\n    EventID == 4688 and CommandLine has_any (\"mimikatz\", \"sekurlsa\", \"procdump\"), \"3Ô∏è‚É£ Credential Theft\",\n    \"Other\")\n| where AttackPhase == \"{SelectedAttackPhase}\"\n| summarize EventCount = count(), UniqueUsers = dcount(TargetUserName), SourceIPs = make_set(IpAddress, 5) by Computer\n| top 10 by EventCount desc\n| project Computer, EventCount, UniqueUsers, SourceIPs",
              "size": 0,
              "title": "üñ•Ô∏è Top Computers in this Attack Phase",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "EventCount", "formatter": 4, "formatOptions": { "palette": "redGreen" } }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedAttackPhase",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "AttackPhaseComputers"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// User Investigation Timeline\nlet InvestigatedUser = \"{InvestigateUser}\";\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where InvestigatedUser != \"\"\n| where TargetUserName has InvestigatedUser or SubjectUserName has InvestigatedUser\n| extend EventType = case(\n    EventID == 4624, \"‚úÖ Logon Success\",\n    EventID == 4625, \"‚ùå Logon Failed\",\n    EventID == 4648, \"üîì Explicit Credentials\",\n    EventID == 4672, \"üëë Special Privileges\",\n    EventID == 4768, \"üé´ Kerberos TGT\",\n    EventID == 4769, \"üé´ Kerberos TGS\",\n    EventID == 4771, \"‚ùå Kerberos Pre-Auth Failed\",\n    EventID in (4728, 4732, 4756), \"üë• Group Membership\",\n    EventID == 4688, \"‚öôÔ∏è Process Created\",\n    strcat(\"Event \", tostring(EventID)))\n| project TimeGenerated, EventType, EventID, Computer, IpAddress, Activity, CommandLine\n| order by TimeGenerated desc\n| take 100",
              "size": 0,
              "title": "üë§ User Investigation Timeline (Enter user above)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "UserTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// IP Investigation\nlet InvestigatedIP = \"{InvestigateIP}\";\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where InvestigatedIP != \"\"\n| where IpAddress == InvestigatedIP or ClientAddress == InvestigatedIP\n| summarize \n    TotalEvents = count(),\n    FailedLogons = countif(EventID == 4625),\n    SuccessLogons = countif(EventID == 4624),\n    UniqueUsers = dcount(TargetUserName),\n    Users = make_set(TargetUserName, 20),\n    UniqueComputers = dcount(Computer),\n    Computers = make_set(Computer, 10),\n    EventTypes = make_set(EventID, 10)\n| extend ThreatLevel = case(\n    FailedLogons > 50, \"üî¥ HIGH - Likely Attack Source\",\n    FailedLogons > 10, \"üü† MEDIUM - Suspicious\",\n    \"üü° LOW - Normal\")\n| project ThreatLevel, TotalEvents, FailedLogons, SuccessLogons, UniqueUsers, Users, UniqueComputers, Computers, EventTypes",
              "size": 0,
              "title": "üåê IP Investigation Summary (Enter IP above)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "IPInvestigation"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Server Investigation - Comprehensive Analysis\nlet InvestigatedServer = \"{InvestigateServer}\";\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where InvestigatedServer != \"\"\n| where Computer has InvestigatedServer\n| summarize \n    TotalEvents = count(),\n    FailedLogons = countif(EventID == 4625),\n    SuccessLogons = countif(EventID == 4624),\n    PrivilegedLogons = countif(EventID == 4672),\n    ProcessCreations = countif(EventID == 4688),\n    UniqueUsers = dcount(TargetUserName),\n    Users = make_set(TargetUserName, 20),\n    UniqueSourceIPs = dcount(IpAddress),\n    SourceIPs = make_set(IpAddress, 15),\n    EventTypes = make_set(EventID, 20),\n    FirstEvent = min(TimeGenerated),\n    LastEvent = max(TimeGenerated)\n| extend ThreatIndicators = case(\n    FailedLogons > 100, \"üî¥ HIGH - Brute Force Target\",\n    PrivilegedLogons > 50, \"üü† MEDIUM - Heavy Privileged Activity\",\n    \"üü¢ NORMAL\")\n| project ThreatIndicators, TotalEvents, FailedLogons, SuccessLogons, PrivilegedLogons, ProcessCreations, UniqueUsers, Users, UniqueSourceIPs, SourceIPs",
              "size": 0,
              "title": "üñ•Ô∏è Server Investigation Summary (Enter server above)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ServerInvestigation"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Server Activity Timeline\nlet InvestigatedServer = \"{InvestigateServer}\";\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where InvestigatedServer != \"\"\n| where Computer has InvestigatedServer\n| extend EventType = case(\n    EventID == 4624, \"‚úÖ Logon Success\",\n    EventID == 4625, \"‚ùå Logon Failed\",\n    EventID == 4648, \"üîì Explicit Credentials\",\n    EventID == 4672, \"üëë Special Privileges\",\n    EventID == 4688, \"‚öôÔ∏è Process Created\",\n    EventID == 4689, \"‚õî Process Terminated\",\n    EventID == 4768, \"üé´ Kerberos TGT\",\n    EventID == 4769, \"üé´ Kerberos TGS\",\n    EventID in (4728, 4732, 4756), \"üë• Group Change\",\n    EventID == 5136, \"üìù Directory Modified\",\n    EventID == 4662, \"üìÇ DS Access\",\n    EventID == 1102, \"üî¥ Audit Log Cleared\",\n    strcat(\"Event \", tostring(EventID)))\n| extend RiskLevel = case(\n    EventID == 1102, \"üî¥ CRITICAL\",\n    EventID == 4662 and Properties has \"1131f6a\", \"üî¥ CRITICAL - DCSync\",\n    EventID == 4672, \"üü† HIGH\",\n    EventID == 4625, \"üü° MEDIUM\",\n    \"üü¢ LOW\")\n| project TimeGenerated, RiskLevel, EventType, EventID, TargetUserName, SubjectUserName, IpAddress, Activity, CommandLine\n| order by TimeGenerated desc\n| take 100",
              "size": 0,
              "title": "üìä Server Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "ServerTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Server Logon Analysis\nlet InvestigatedServer = \"{InvestigateServer}\";\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where InvestigatedServer != \"\"\n| where Computer has InvestigatedServer\n| where EventID == 4624\n| extend LogonTypeDesc = case(\n    LogonType == 2, \"Interactive\",\n    LogonType == 3, \"Network\",\n    LogonType == 4, \"Batch\",\n    LogonType == 5, \"Service\",\n    LogonType == 7, \"Unlock\",\n    LogonType == 8, \"NetworkCleartext\",\n    LogonType == 9, \"NewCredentials\",\n    LogonType == 10, \"RemoteInteractive (RDP)\",\n    LogonType == 11, \"CachedInteractive\",\n    strcat(\"Type \", tostring(LogonType)))\n| summarize \n    LogonCount = count(),\n    UniqueUsers = dcount(TargetUserName),\n    Users = make_set(TargetUserName, 10)\n    by LogonTypeDesc, AuthenticationPackageName\n| order by LogonCount desc",
              "size": 0,
              "title": "üîê Server Logon Types Breakdown",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ServerLogonTypes"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Suspicious Processes on Server\nlet InvestigatedServer = \"{InvestigateServer}\";\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where InvestigatedServer != \"\"\n| where Computer has InvestigatedServer\n| where EventID == 4688\n| where CommandLine has_any (\n    \"mimikatz\", \"sekurlsa\", \"procdump\", \"lsass\",\n    \"ntdsutil\", \"vssadmin\", \"diskshadow\",\n    \"powershell -enc\", \"powershell -e \", \"-encodedcommand\",\n    \"whoami\", \"net user\", \"net group\", \"net localgroup\",\n    \"nltest\", \"dsquery\", \"cmdkey\", \"reg save\",\n    \"wmic\", \"psexec\", \"wmiexec\", \"smbexec\")\n| extend SuspicionLevel = case(\n    CommandLine has_any (\"mimikatz\", \"sekurlsa\", \"lsass\", \"ntdsutil\"), \"üî¥ CRITICAL - Credential Theft\",\n    CommandLine has_any (\"powershell -enc\", \"-encodedcommand\"), \"üî¥ HIGH - Encoded PowerShell\",\n    CommandLine has_any (\"psexec\", \"wmiexec\", \"smbexec\"), \"üü† HIGH - Lateral Movement Tool\",\n    CommandLine has_any (\"net user\", \"net group\", \"nltest\"), \"üü° MEDIUM - Recon Activity\",\n    \"üü° LOW - Review\")\n| project TimeGenerated, SuspicionLevel, SubjectUserName, NewProcessName, CommandLine, ParentProcessName\n| order by TimeGenerated desc\n| take 50",
              "size": 0,
              "title": "‚ö†Ô∏è Suspicious Processes on Server",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ServerSuspiciousProcesses"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Lateral Movement Chain Reconstruction\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where LogonType in (3, 10)\n| where TargetUserName !endswith \"$\"\n| summarize \n    LogonCount = count(),\n    UniqueTargets = dcount(Computer),\n    Targets = make_set(Computer, 20),\n    SourceIPs = make_set(IpAddress, 10),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by TargetUserName, TargetDomainName\n| where UniqueTargets >= 3\n| extend MovementSpeed = datetime_diff('minute', LastSeen, FirstSeen)\n| extend ThreatLevel = case(\n    UniqueTargets >= 10, \"üî¥ CRITICAL - Widespread Movement\",\n    UniqueTargets >= 5, \"üü† HIGH - Active Movement\",\n    \"üü° MEDIUM - Monitor\")\n| project ThreatLevel, TargetUserName, UniqueTargets, Targets, SourceIPs, MovementSpeed, FirstSeen, LastSeen\n| order by UniqueTargets desc",
              "size": 0,
              "title": "üîÄ Lateral Movement Chain",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "LateralChain"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Success After Failures - Compromised Accounts\nlet failThreshold = 5;\nlet successWindow = 30m;\nlet FailedLogins = SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4625\n| summarize \n    FailureCount = count(),\n    LastFailure = max(TimeGenerated)\n    by TargetUserName, IpAddress\n| where FailureCount >= failThreshold;\nlet SuccessfulLogins = SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| project TargetUserName, IpAddress, SuccessTime = TimeGenerated, Computer, LogonType;\nFailedLogins\n| join kind=inner SuccessfulLogins on TargetUserName, IpAddress\n| where SuccessTime > LastFailure\n| where SuccessTime - LastFailure <= successWindow\n| extend TimeSinceLastFailure = datetime_diff('minute', SuccessTime, LastFailure)\n| extend ThreatLevel = case(\n    TimeSinceLastFailure <= 2, \"üî¥ CRITICAL - Immediate Success (Compromised)\",\n    TimeSinceLastFailure <= 5, \"üî¥ HIGH - Rapid Success\",\n    \"üü† MEDIUM - Delayed Success\")\n| project ThreatLevel, TargetUserName, IpAddress, FailureCount, TimeSinceLastFailure, SuccessTime, Computer\n| order by TimeSinceLastFailure asc",
              "size": 0,
              "title": "‚ö†Ô∏è Successful Login After Failed Attempts (Compromised?)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SuccessAfterFail"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// High-Risk Events Summary\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (\n    4625, 4672, 4662, 4768, 4769, 4771,\n    4728, 4732, 4756, 4720, 4724, 4740, 4688)\n| extend RiskCategory = case(\n    EventID == 4662 and Properties has \"1131f6a\", \"üî¥ DCSync\",\n    EventID in (4728, 4732, 4756), \"üî¥ Group Change\",\n    EventID == 4688 and CommandLine has_any (\"mimikatz\", \"sekurlsa\"), \"üî¥ Credential Tool\",\n    EventID == 4672, \"üü† Privilege Use\",\n    EventID == 4625, \"üü° Failed Logon\",\n    EventID == 4740, \"üü° Lockout\",\n    EventID in (4768, 4769), \"üü¢ Kerberos\",\n    \"üü¢ Other\")\n| summarize Count = count() by EventID, Activity, RiskCategory\n| project RiskCategory, EventID, Activity, Count\n| order by Count desc",
              "size": 0,
              "title": "üìä High-Risk Events Summary",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "RiskSummary"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "forensics"
      },
      "name": "ForensicsGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üõ°Ô∏è XDR Correlation (Defender for Endpoint)\n\nCorrelate SecurityEvent data with Microsoft Defender XDR tables for comprehensive visibility. These queries detect threats **beyond what MDI covers**.\n\n> **Note:** These queries require Defender for Endpoint tables (DeviceProcessEvents, DeviceNetworkEvents, etc.) to be available in your workspace via the Microsoft 365 Defender connector.\n\n---"
            },
            "name": "XDRHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// LSASS Memory Access Detection (XDR)\nDeviceEvents\n| where Timestamp {TimeRange}\n| where ActionType == \"OpenProcessApiCall\"\n| where FileName =~ \"lsass.exe\"\n| where InitiatingProcessFileName !in~ (\n    \"taskmgr.exe\", \"procexp.exe\", \"wmiprvse.exe\",\n    \"csrss.exe\", \"wininit.exe\", \"MsMpEng.exe\", \"svchost.exe\")\n| extend SuspicionLevel = case(\n    InitiatingProcessFileName in~ (\"powershell.exe\", \"pwsh.exe\"), \"üî¥ CRITICAL - PowerShell accessing LSASS\",\n    InitiatingProcessFileName in~ (\"rundll32.exe\", \"regsvr32.exe\"), \"üî¥ CRITICAL - LOLBin accessing LSASS\",\n    InitiatingProcessFileName has_any (\"mimikatz\", \"procdump\"), \"üî¥ CRITICAL - Known Tool\",\n    \"üü† HIGH - Unusual LSASS Access\")\n| project Timestamp, DeviceName, InitiatingProcessFileName, InitiatingProcessCommandLine, InitiatingProcessAccountName, SuspicionLevel\n| order by Timestamp desc\n| take 50",
              "size": 0,
              "title": "üîç LSASS Memory Access (XDR - Beyond MDI)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "XDR_LSASS"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Suspicious Processes on DCs (XDR)\nDeviceProcessEvents\n| where Timestamp {TimeRange}\n| where DeviceName has_any (\"DC\", \"PDC\")\n| where ProcessCommandLine has_any (\n    \"mimikatz\", \"sekurlsa\", \"lsadump\",\n    \"ntdsutil\", \"vssadmin\", \"diskshadow\",\n    \"procdump\", \"comsvcs.dll\", \"MiniDump\",\n    \"Invoke-Mimikatz\", \"Out-Minidump\",\n    \"secretsdump\", \"pypykatz\", \"rubeus\",\n    \"SharpHound\", \"BloodHound\", \"PowerView\")\n| extend ThreatLevel = case(\n    ProcessCommandLine has_any (\"mimikatz\", \"sekurlsa\", \"lsadump\"), \"üî¥ CRITICAL - Mimikatz\",\n    ProcessCommandLine has \"ntdsutil\", \"üî¥ CRITICAL - NTDS.dit\",\n    ProcessCommandLine has \"vssadmin\", \"üî¥ HIGH - Shadow Copy\",\n    ProcessCommandLine has_any (\"SharpHound\", \"BloodHound\"), \"üü† HIGH - AD Recon\",\n    \"üü† MEDIUM - Suspicious\")\n| project Timestamp, ThreatLevel, DeviceName, AccountName, FileName, ProcessCommandLine\n| order by Timestamp desc",
              "size": 0,
              "title": "üíÄ Suspicious Processes on DCs (XDR)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "XDR_Suspicious"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Outbound Network from DCs (XDR)\nDeviceNetworkEvents\n| where Timestamp {TimeRange}\n| where DeviceName has_any (\"DC\", \"PDC\")\n| where RemoteIPType == \"Public\"\n| summarize \n    Connections = count(),\n    Ports = make_set(RemotePort, 10),\n    Processes = make_set(InitiatingProcessFileName, 5)\n    by RemoteIP, RemoteUrl\n| where Connections > 10 or Ports has_any (\"4444\", \"1337\", \"8080\", \"9001\")\n| extend ThreatLevel = case(\n    Ports has_any (\"4444\", \"1337\", \"9001\"), \"üî¥ CRITICAL - C2 Port\",\n    Connections > 100, \"üü† HIGH - High Volume\",\n    \"üü° MEDIUM - Review\")\n| project ThreatLevel, RemoteIP, RemoteUrl, Connections, Ports, Processes\n| order by Connections desc",
              "size": 0,
              "title": "üåê Outbound Network from DCs (XDR)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "XDR_Network"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Registry Persistence on DCs (XDR)\nDeviceRegistryEvents\n| where Timestamp {TimeRange}\n| where DeviceName has_any (\"DC\", \"PDC\")\n| where RegistryKey has_any (\n    \"CurrentVersion\\\\Run\", \"CurrentVersion\\\\RunOnce\",\n    \"Winlogon\", \"Image File Execution\", \"AppInit_DLLs\",\n    \"CurrentControlSet\\\\Control\\\\Lsa\", \"Security Packages\")\n| where ActionType == \"RegistryValueSet\"\n| extend ThreatLevel = case(\n    RegistryKey has \"Lsa\", \"üî¥ CRITICAL - LSA Persistence\",\n    RegistryKey has \"Security Packages\", \"üî¥ CRITICAL - SSP Backdoor\",\n    RegistryKey has \"Run\", \"üü† HIGH - Autorun Persistence\",\n    \"üü° MEDIUM - Registry Change\")\n| project Timestamp, ThreatLevel, DeviceName, RegistryKey, RegistryValueName, RegistryValueData, InitiatingProcessFileName, InitiatingProcessAccountName\n| order by Timestamp desc",
              "size": 0,
              "title": "üìù Registry Persistence on DCs (XDR)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "XDR_Registry"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Suspicious DLL Loads in LSASS (Skeleton Key Detection)\nDeviceImageLoadEvents\n| where Timestamp {TimeRange}\n| where InitiatingProcessFileName =~ \"lsass.exe\"\n| where FileName !in~ (\n    \"msv1_0.dll\", \"kerberos.dll\", \"wdigest.dll\", \"tspkg.dll\",\n    \"pku2u.dll\", \"livessp.dll\", \"cloudap.dll\", \"negoexts.dll\",\n    \"msoidsvc.dll\", \"msoidres.dll\", \"ngccredprov.dll\")\n| where FolderPath !startswith \"C:\\\\Windows\\\\System32\"\n| extend ThreatLevel = \"üî¥ CRITICAL - Suspicious DLL in LSASS\"\n| extend Description = \"Possible Skeleton Key or LSASS Backdoor\"\n| project Timestamp, ThreatLevel, DeviceName, FileName, FolderPath, SHA1, Description\n| order by Timestamp desc",
              "size": 0,
              "title": "ü¶¥ Skeleton Key Detection - Suspicious LSASS DLLs (XDR)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "XDR_SkeletonKey"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Identity Logon Correlation (MDI Data)\nIdentityLogonEvents\n| where Timestamp {TimeRange}\n| where DestinationDeviceName has_any (\"DC\", \"PDC\")\n| summarize \n    LogonCount = count(),\n    FailedCount = countif(ActionType has \"Failed\"),\n    Protocols = make_set(Protocol, 5),\n    SourceIPs = make_set(IPAddress, 10)\n    by AccountName, AccountDomain, DestinationDeviceName\n| where FailedCount >= 5 or LogonCount >= 50\n| extend ThreatLevel = case(\n    FailedCount >= 20, \"üî¥ HIGH - Brute Force to DC\",\n    LogonCount >= 100, \"üü† MEDIUM - High Volume\",\n    \"üü° LOW - Monitor\")\n| project ThreatLevel, AccountName, DestinationDeviceName, LogonCount, FailedCount, Protocols, SourceIPs\n| order by FailedCount desc",
              "size": 0,
              "title": "üîê Identity Logon Correlation (MDI)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "XDR_Identity"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìã XDR Tables Coverage\n\n| Table | Purpose | MDI Equivalent |\n|-------|---------|----------------|\n| **DeviceProcessEvents** | Process execution on endpoints | Partial |\n| **DeviceNetworkEvents** | Network connections | Not covered |\n| **DeviceFileEvents** | File operations | Not covered |\n| **DeviceRegistryEvents** | Registry changes | Not covered |\n| **DeviceImageLoadEvents** | DLL loads (Skeleton Key!) | Not covered |\n| **DeviceLogonEvents** | Endpoint logons | Partial |\n| **IdentityLogonEvents** | AD logons (MDI) | Full |\n| **IdentityDirectoryEvents** | AD changes (MDI) | Full |\n\n**‚ö†Ô∏è Key Gaps MDI Doesn't Cover:**\n- LSASS memory access patterns\n- Registry persistence mechanisms\n- Suspicious DLL loads (Skeleton Key)\n- Network C2 indicators\n- File system credential theft"
            },
            "name": "XDRReference"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "xdr"
      },
      "name": "XDRGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## ÔøΩ Stale Accounts & Devices\n\nDetect usage of deprecated, insecure, or legacy authentication protocols and weak encryption that increase security risk.\n\n**Why This Matters:**\n- Legacy protocols like NTLMv1, LM, and WDigest store credentials insecurely\n- Weak Kerberos encryption (RC4, DES) can be easily cracked\n- Legacy TLS versions have known vulnerabilities\n- These represent attack vectors for credential theft and downgrade attacks\n\n---"
            },
            "name": "StaleProtocolsHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Stale Protocol Risk Summary\nlet NTLMv1Count = SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where LmPackageName has \"NTLMv1\" or AuthenticationPackageName == \"NTLM\" and LmPackageName !has \"NTLMv2\"\n| count;\nlet WeakKerberos = SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4768, 4769)\n| extend TicketEncryptionType = extract('<Data Name=\"TicketEncryptionType\">([^<]+)</Data>', 1, EventData)\n| where TicketEncryptionType in (\"0x1\", \"0x3\", \"0x17\", \"0x18\")\n| count;\nlet NTLMTotal = SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where AuthenticationPackageName == \"NTLM\"\n| count;\nlet LegacyLogon = SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4776\n| count;\nprint \n  ['NTLMv1 Logons'] = toscalar(NTLMv1Count),\n  ['Total NTLM Logons'] = toscalar(NTLMTotal),\n  ['Weak Kerberos (RC4/DES)'] = toscalar(WeakKerberos),\n  ['NTLM Credential Validations (4776)'] = toscalar(LegacyLogon)",
              "size": 3,
              "title": "üö® Stale Protocol Risk Summary",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true
              }
            },
            "name": "StaleProtocolSummary"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// NTLMv1 Authentication Detection\n// NTLMv1 is highly vulnerable to credential theft and should be disabled\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where LmPackageName has \"NTLMv1\" or (AuthenticationPackageName == \"NTLM\" and LmPackageName !has \"NTLMv2\")\n| extend NTLMVersion = case(\n    LmPackageName has \"NTLMv1\", \"üî¥ NTLMv1 (Critical)\",\n    LmPackageName has \"LM\", \"üî¥ LM Hash (Critical)\",\n    \"üü† NTLM Unknown Version\")\n| summarize \n    Count = count(),\n    LastSeen = max(TimeGenerated),\n    Computers = make_set(Computer, 5),\n    SourceIPs = make_set(IpAddress, 5)\n    by TargetUserName, TargetDomainName, NTLMVersion\n| order by Count desc\n| project NTLMVersion, User = strcat(TargetDomainName, \"\\\\\", TargetUserName), Count, LastSeen, Computers, SourceIPs",
              "size": 0,
              "title": "üî¥ NTLMv1 / LM Hash Authentication (CRITICAL - Should be Zero)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "red" } },
                  { "columnMatch": "NTLMVersion", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "contains", "thresholdValue": "Critical", "representation": "red", "text": "{0}"}, {"operator": "Default", "representation": "orange", "text": "{0}"}] } }
                ]
              }
            },
            "customWidth": "50",
            "name": "NTLMv1Detection"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Weak Kerberos Encryption Detection (RC4, DES)\n// RC4 (0x17, 0x18) and DES (0x1, 0x3) are weak and susceptible to attacks\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4768, 4769)\n| extend TicketEncryptionType = extract('<Data Name=\"TicketEncryptionType\">([^<]+)</Data>', 1, EventData)\n| extend EncryptionDescription = case(\n    TicketEncryptionType == \"0x1\", \"üî¥ DES-CBC-CRC\",\n    TicketEncryptionType == \"0x3\", \"üî¥ DES-CBC-MD5\",\n    TicketEncryptionType == \"0x17\", \"üü† RC4-HMAC\",\n    TicketEncryptionType == \"0x18\", \"üü† RC4-HMAC-EXP\",\n    TicketEncryptionType == \"0x11\", \"üü¢ AES128-CTS\",\n    TicketEncryptionType == \"0x12\", \"üü¢ AES256-CTS\",\n    strcat(\"Unknown: \", TicketEncryptionType))\n| where TicketEncryptionType in (\"0x1\", \"0x3\", \"0x17\", \"0x18\")\n| extend RiskLevel = case(\n    TicketEncryptionType in (\"0x1\", \"0x3\"), \"üî¥ Critical - DES\",\n    \"üü† High - RC4\")\n| summarize \n    Count = count(),\n    LastSeen = max(TimeGenerated),\n    EventTypes = make_set(EventID)\n    by TargetUserName, EncryptionDescription, RiskLevel, Computer\n| order by RiskLevel asc, Count desc\n| project RiskLevel, EncryptionDescription, User = TargetUserName, Computer, Count, LastSeen, EventTypes",
              "size": 0,
              "title": "üîê Weak Kerberos Encryption (RC4/DES) - Kerberoasting Risk",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "orange" } },
                  { "columnMatch": "RiskLevel", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "contains", "thresholdValue": "Critical", "representation": "red", "text": "{0}"}, {"operator": "Default", "representation": "orange", "text": "{0}"}] } }
                ]
              }
            },
            "customWidth": "50",
            "name": "WeakKerberosDetection"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// NTLM vs Kerberos Authentication Trend\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4768, 4769, 4776)\n| extend Protocol = case(\n    EventID == 4624 and AuthenticationPackageName == \"NTLM\", \"NTLM Logon\",\n    EventID == 4624 and AuthenticationPackageName == \"Kerberos\", \"Kerberos Logon\",\n    EventID == 4776, \"NTLM Credential Validation\",\n    EventID in (4768, 4769), \"Kerberos Ticket\",\n    \"Other\")\n| where Protocol != \"Other\"\n| summarize Count = count() by Protocol, bin(TimeGenerated, 1h)\n| render timechart",
              "size": 0,
              "title": "üìà Authentication Protocol Trend (NTLM vs Kerberos)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "NTLMKerberosTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Kerberos Encryption Type Distribution\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4768, 4769)\n| extend TicketEncryptionType = extract('<Data Name=\"TicketEncryptionType\">([^<]+)</Data>', 1, EventData)\n| extend EncryptionName = case(\n    TicketEncryptionType == \"0x1\", \"DES-CBC-CRC\",\n    TicketEncryptionType == \"0x3\", \"DES-CBC-MD5\",\n    TicketEncryptionType == \"0x17\", \"RC4-HMAC\",\n    TicketEncryptionType == \"0x18\", \"RC4-HMAC-EXP\",\n    TicketEncryptionType == \"0x11\", \"AES128-CTS\",\n    TicketEncryptionType == \"0x12\", \"AES256-CTS\",\n    strcat(\"Other (\", TicketEncryptionType, \")\"))\n| where isnotempty(TicketEncryptionType)\n| summarize Count = count() by EncryptionName\n| render piechart",
              "size": 0,
              "title": "ü•ß Kerberos Encryption Type Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "KerberosEncryptionPie"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// WDigest Authentication Detection - Enhanced\n// WDigest stores passwords in CLEARTEXT in LSASS memory - CRITICAL security risk\n// When UseLogonCredential=1, credentials are cached in plaintext (default on Win7/2008R2)\n// Mimikatz and similar tools can extract these credentials directly\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where AuthenticationPackageName == \"NTLM\"\n| where LogonType in (2, 10, 11) // Interactive, RemoteInteractive, CachedInteractive\n| extend LogonTypeDesc = case(\n    LogonType == 2, \"Interactive (Local)\",\n    LogonType == 10, \"RemoteInteractive (RDP)\",\n    LogonType == 11, \"CachedInteractive\",\n    tostring(LogonType))\n| summarize \n    Count = count(),\n    LastSeen = max(TimeGenerated),\n    FirstSeen = min(TimeGenerated),\n    LogonTypes = make_set(LogonTypeDesc),\n    SourceIPs = make_set(IpAddress, 10),\n    Computers = make_set(Computer, 10)\n    by TargetUserName, TargetDomainName\n| extend RiskLevel = case(\n    Count > 100, \"üî¥ CRITICAL - High WDigest Exposure\",\n    Count > 20, \"üü† HIGH - Moderate WDigest Exposure\",\n    \"üü° MEDIUM - WDigest Risk Present\")\n| order by Count desc\n| project RiskLevel, User = strcat(TargetDomainName, \"\\\\\", TargetUserName), Count, LogonTypes, FirstSeen, LastSeen, SourceIPs, Computers",
              "size": 0,
              "title": "üî¥ WDigest Credential Exposure Risk (Cleartext in Memory)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "red" } },
                  { "columnMatch": "RiskLevel", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "contains", "thresholdValue": "CRITICAL", "representation": "red", "text": "{0}"}, {"operator": "contains", "thresholdValue": "HIGH", "representation": "orange", "text": "{0}"}, {"operator": "Default", "representation": "yellow", "text": "{0}"}] } }
                ]
              }
            },
            "customWidth": "50",
            "name": "WDigestDetection"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// WDigest Registry Configuration Changes Detection\n// Monitors for changes to UseLogonCredential registry key\n// HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest\n// Value 1 = Enabled (BAD), Value 0 = Disabled (GOOD)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4657, 4663) // Registry value modified\n| where ObjectName has \"WDigest\" or ObjectName has \"UseLogonCredential\" or ObjectName has \"SecurityProviders\"\n| extend RegistryAction = case(\n    AccessMask == \"0x2\", \"Value Set\",\n    AccessMask == \"0x1\", \"Query\",\n    \"Other\")\n| summarize \n    Count = count(),\n    LastChange = max(TimeGenerated),\n    Actors = make_set(SubjectUserName, 5)\n    by Computer, ObjectName, ProcessName\n| extend Alert = \"üî¥ WDigest Registry Modified - Verify UseLogonCredential=0\"\n| project Alert, Computer, ObjectName, ProcessName, Count, LastChange, Actors",
              "size": 0,
              "title": "‚ö†Ô∏è WDigest Registry Changes (UseLogonCredential)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "WDigestRegistryChanges"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// WDigest Enabled Systems Detection via DeviceRegistryEvents (Defender XDR)\n// Identifies systems where WDigest is enabled (UseLogonCredential=1)\nDeviceRegistryEvents\n| where Timestamp {TimeRange}\n| where RegistryKey has \"SecurityProviders\\\\WDigest\"\n| where RegistryValueName == \"UseLogonCredential\"\n| extend WDigestStatus = case(\n    RegistryValueData == \"1\", \"üî¥ CRITICAL - WDigest ENABLED (Cleartext Creds)\",\n    RegistryValueData == \"0\", \"üü¢ WDigest Disabled (Safe)\",\n    \"Unknown\")\n| summarize \n    LastSeen = max(Timestamp),\n    ActionTypes = make_set(ActionType)\n    by DeviceName, RegistryValueData, WDigestStatus\n| order by WDigestStatus asc\n| project WDigestStatus, DeviceName, RegistryValue = RegistryValueData, LastSeen, ActionTypes",
              "size": 0,
              "title": "üîì WDigest Enabled Systems (XDR Registry Data)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "WDigestStatus", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "contains", "thresholdValue": "CRITICAL", "representation": "red", "text": "{0}"}, {"operator": "Default", "representation": "green", "text": "{0}"}] } }
                ]
              }
            },
            "customWidth": "50",
            "name": "WDigestXDRDetection"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// WDigest DLL Load Detection in LSASS\n// Monitors for wdigest.dll being loaded into lsass.exe\nDeviceImageLoadEvents\n| where Timestamp {TimeRange}\n| where InitiatingProcessFileName =~ \"lsass.exe\"\n| where FileName =~ \"wdigest.dll\"\n| summarize \n    LoadCount = count(),\n    LastLoaded = max(Timestamp),\n    FirstLoaded = min(Timestamp)\n    by DeviceName, FolderPath, SHA256\n| extend Note = \"‚ö†Ô∏è WDigest DLL loaded in LSASS - verify if disabled\"\n| project Note, DeviceName, FolderPath, LoadCount, FirstLoaded, LastLoaded, SHA256",
              "size": 0,
              "title": "üì¶ WDigest DLL Loads in LSASS (XDR)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "WDigestDLLLoad"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// NTLM Credential Validation (Event 4776)\n// Shows NTLM authentication against the DC - potential for Pass-the-Hash\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4776\n| extend Status = iff(Status == \"0x0\", \"Success\", \"Failed\")\n| summarize \n    TotalAttempts = count(),\n    SuccessCount = countif(Status == \"Success\"),\n    FailedCount = countif(Status == \"Failed\"),\n    Workstations = make_set(WorkstationName, 10)\n    by TargetUserName, Computer\n| extend FailRate = round(todouble(FailedCount) / TotalAttempts * 100, 1)\n| extend RiskLevel = case(\n    FailedCount > 100, \"üî¥ High Failed Count\",\n    FailRate > 50, \"üü† High Fail Rate\",\n    TotalAttempts > 1000, \"üü° High Volume\",\n    \"üü¢ Normal\")\n| order by TotalAttempts desc\n| project RiskLevel, User = TargetUserName, DC = Computer, TotalAttempts, SuccessCount, FailedCount, ['Fail %'] = FailRate, Workstations\n| take 50",
              "size": 0,
              "title": "üîë NTLM Credential Validation (Event 4776) - Top Users",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "TotalAttempts", "formatter": 4, "formatOptions": { "palette": "blue" } },
                  { "columnMatch": "FailedCount", "formatter": 4, "formatOptions": { "palette": "red" } },
                  { "columnMatch": "RiskLevel", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "contains", "thresholdValue": "High Failed", "representation": "red", "text": "{0}"}, {"operator": "contains", "thresholdValue": "High Fail Rate", "representation": "orange", "text": "{0}"}, {"operator": "contains", "thresholdValue": "High Volume", "representation": "yellow", "text": "{0}"}, {"operator": "Default", "representation": "green", "text": "{0}"}] } }
                ]
              }
            },
            "customWidth": "50",
            "name": "NTLMCredentialValidation"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Legacy TLS/SSL Detection - Schannel Events\n// Event 36880 = TLS handshake succeeded\n// Event 36888 = Fatal TLS alert generated\n// Event 36887 = Fatal TLS alert received\nEvent\n| where TimeGenerated {TimeRange}\n| where Source == \"Schannel\" or EventLog == \"System\"\n| where EventID in (36880, 36888, 36887)\n| extend TLSVersion = extract(\"(SSL [0-9.]+|TLS [0-9.]+)\", 1, RenderedDescription)\n| where isnotempty(TLSVersion)\n| extend RiskLevel = case(\n    TLSVersion has \"SSL 2\", \"üî¥ CRITICAL - SSL 2.0 (Severely Broken)\",\n    TLSVersion has \"SSL 3\", \"üî¥ CRITICAL - SSL 3.0 (POODLE Vuln)\",\n    TLSVersion has \"TLS 1.0\", \"üî¥ HIGH - TLS 1.0 (Deprecated Jan 2020)\",\n    TLSVersion has \"TLS 1.1\", \"üü† MEDIUM - TLS 1.1 (Deprecated Jan 2020)\",\n    TLSVersion has \"TLS 1.2\", \"üü¢ GOOD - TLS 1.2\",\n    TLSVersion has \"TLS 1.3\", \"üü¢ BEST - TLS 1.3\",\n    \"Unknown\")\n| extend EventType = case(\n    EventID == 36880, \"Handshake Success\",\n    EventID == 36888, \"Alert Sent\",\n    EventID == 36887, \"Alert Received\",\n    \"Other\")\n| summarize \n    Count = count(),\n    LastSeen = max(TimeGenerated),\n    FirstSeen = min(TimeGenerated),\n    EventTypes = make_set(EventType)\n    by TLSVersion, RiskLevel, Computer\n| order by RiskLevel asc, Count desc\n| project RiskLevel, TLSVersion, Computer, Count, FirstSeen, LastSeen, EventTypes",
              "size": 0,
              "title": "üîê TLS/SSL Version Usage (Schannel Events)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "blue" } },
                  { "columnMatch": "RiskLevel", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "contains", "thresholdValue": "CRITICAL", "representation": "red", "text": "{0}"}, {"operator": "contains", "thresholdValue": "HIGH", "representation": "redBright", "text": "{0}"}, {"operator": "contains", "thresholdValue": "MEDIUM", "representation": "orange", "text": "{0}"}, {"operator": "Default", "representation": "green", "text": "{0}"}] } }
                ]
              }
            },
            "customWidth": "50",
            "name": "LegacyTLSDetection"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// TLS Version Distribution Pie Chart\nEvent\n| where TimeGenerated {TimeRange}\n| where Source == \"Schannel\"\n| where EventID == 36880\n| extend TLSVersion = extract(\"(SSL [0-9.]+|TLS [0-9.]+)\", 1, RenderedDescription)\n| where isnotempty(TLSVersion)\n| summarize Count = count() by TLSVersion\n| render piechart",
              "size": 0,
              "title": "ü•ß TLS Version Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "25",
            "name": "TLSVersionPie"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Legacy TLS Summary Counts\nlet TLSEvents = Event\n| where TimeGenerated {TimeRange}\n| where Source == \"Schannel\"\n| where EventID == 36880\n| extend TLSVersion = extract(\"(SSL [0-9.]+|TLS [0-9.]+)\", 1, RenderedDescription)\n| where isnotempty(TLSVersion);\nlet SSL2 = TLSEvents | where TLSVersion has \"SSL 2\" | count;\nlet SSL3 = TLSEvents | where TLSVersion has \"SSL 3\" | count;\nlet TLS10 = TLSEvents | where TLSVersion has \"TLS 1.0\" | count;\nlet TLS11 = TLSEvents | where TLSVersion has \"TLS 1.1\" | count;\nlet TLS12 = TLSEvents | where TLSVersion has \"TLS 1.2\" | count;\nlet TLS13 = TLSEvents | where TLSVersion has \"TLS 1.3\" | count;\nprint \n    ['üî¥ SSL 2.0'] = toscalar(SSL2),\n    ['üî¥ SSL 3.0'] = toscalar(SSL3),\n    ['üî¥ TLS 1.0'] = toscalar(TLS10),\n    ['üü† TLS 1.1'] = toscalar(TLS11),\n    ['üü¢ TLS 1.2'] = toscalar(TLS12),\n    ['üü¢ TLS 1.3'] = toscalar(TLS13)",
              "size": 3,
              "title": "üìä TLS Version Summary",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true
              }
            },
            "customWidth": "25",
            "name": "TLSVersionSummary"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Servers Using Deprecated TLS Versions - Top Offenders\nEvent\n| where TimeGenerated {TimeRange}\n| where Source == \"Schannel\"\n| where EventID == 36880\n| extend TLSVersion = extract(\"(SSL [0-9.]+|TLS [0-9.]+)\", 1, RenderedDescription)\n| where TLSVersion has_any (\"SSL 2\", \"SSL 3\", \"TLS 1.0\", \"TLS 1.1\")\n| summarize \n    LegacyTLSCount = count(),\n    TLSVersionsUsed = make_set(TLSVersion),\n    LastSeen = max(TimeGenerated)\n    by Computer\n| order by LegacyTLSCount desc\n| extend Priority = case(\n    LegacyTLSCount > 1000, \"üî¥ Urgent Remediation\",\n    LegacyTLSCount > 100, \"üü† High Priority\",\n    \"üü° Review\")\n| project Priority, Computer, LegacyTLSCount, TLSVersionsUsed, LastSeen\n| take 25",
              "size": 0,
              "title": "üñ•Ô∏è Servers with Legacy TLS - Remediation Priority",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "LegacyTLSCount", "formatter": 4, "formatOptions": { "palette": "red" } },
                  { "columnMatch": "Priority", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "contains", "thresholdValue": "Urgent", "representation": "red", "text": "{0}"}, {"operator": "contains", "thresholdValue": "High", "representation": "orange", "text": "{0}"}, {"operator": "Default", "representation": "yellow", "text": "{0}"}] } }
                ]
              }
            },
            "customWidth": "50",
            "name": "LegacyTLSServers"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// TLS Version Trend Over Time\nEvent\n| where TimeGenerated {TimeRange}\n| where Source == \"Schannel\"\n| where EventID == 36880\n| extend TLSVersion = extract(\"(SSL [0-9.]+|TLS [0-9.]+)\", 1, RenderedDescription)\n| where isnotempty(TLSVersion)\n| extend TLSCategory = case(\n    TLSVersion has_any (\"SSL\", \"TLS 1.0\", \"TLS 1.1\"), \"Legacy (Deprecated)\",\n    \"Modern (TLS 1.2+)\")\n| summarize Count = count() by TLSCategory, bin(TimeGenerated, 1h)\n| render timechart",
              "size": 0,
              "title": "üìà Legacy vs Modern TLS Usage Trend",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "TLSVersionTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Anonymous and Guest Logon Detection\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where TargetUserName in (\"ANONYMOUS LOGON\", \"Guest\", \"\") or TargetUserSid in (\"S-1-5-7\", \"S-1-5-21-*-501\")\n| summarize \n    Count = count(),\n    LastSeen = max(TimeGenerated),\n    SourceIPs = make_set(IpAddress, 10),\n    LogonTypes = make_set(LogonType)\n    by TargetUserName, Computer\n| extend RiskLevel = case(\n    TargetUserName == \"ANONYMOUS LOGON\", \"üî¥ Anonymous Access\",\n    TargetUserName == \"Guest\", \"üü† Guest Account Active\",\n    \"üü° Review\")\n| order by Count desc\n| project RiskLevel, Account = TargetUserName, Computer, Count, LastSeen, LogonTypes, SourceIPs",
              "size": 0,
              "title": "üë§ Anonymous & Guest Logon Detection",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "orange" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "AnonymousGuestLogon"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top NTLM-Only Clients by Volume\n// Clients using only NTLM may indicate legacy systems or misconfigurations\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where AuthenticationPackageName == \"NTLM\"\n| extend WorkstationClean = iff(isempty(WorkstationName), IpAddress, WorkstationName)\n| summarize \n    NTLMCount = count(),\n    UniqueUsers = dcount(TargetUserName),\n    LastSeen = max(TimeGenerated),\n    SampleUsers = make_set(TargetUserName, 5)\n    by WorkstationClean, Computer\n| order by NTLMCount desc\n| extend Assessment = case(\n    NTLMCount > 1000, \"üî¥ Very High NTLM Usage\",\n    NTLMCount > 100, \"üü† High NTLM Usage\",\n    NTLMCount > 10, \"üü° Moderate NTLM Usage\",\n    \"üü¢ Low\")\n| project Assessment, Client = WorkstationClean, ['Target DC'] = Computer, NTLMCount, UniqueUsers, LastSeen, SampleUsers\n| take 50",
              "size": 0,
              "title": "üíª Top NTLM-Only Clients (Potential Legacy Systems)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "NTLMCount", "formatter": 4, "formatOptions": { "palette": "orange" } },
                  { "columnMatch": "Assessment", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "contains", "thresholdValue": "Very High", "representation": "red", "text": "{0}"}, {"operator": "contains", "thresholdValue": "High", "representation": "orange", "text": "{0}"}, {"operator": "contains", "thresholdValue": "Moderate", "representation": "yellow", "text": "{0}"}, {"operator": "Default", "representation": "green", "text": "{0}"}] } }
                ]
              }
            },
            "customWidth": "50",
            "name": "TopNTLMClients"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Accounts Using NTLM\n// Service accounts should prefer Kerberos - NTLM may indicate misconfiguration\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where AuthenticationPackageName == \"NTLM\"\n| where TargetUserName matches regex @\"(?i)(svc|service|srv|sql|app|batch|task)\"\n| where TargetUserName !endswith \"$\"\n| summarize \n    Count = count(),\n    LastSeen = max(TimeGenerated),\n    TargetComputers = make_set(Computer, 10),\n    SourceIPs = make_set(IpAddress, 5)\n    by TargetUserName, TargetDomainName\n| order by Count desc\n| extend Warning = \"üü† Service Account using NTLM - Configure for Kerberos\"\n| project Warning, ServiceAccount = strcat(TargetDomainName, \"\\\\\", TargetUserName), Count, LastSeen, TargetComputers, SourceIPs",
              "size": 0,
              "title": "‚öôÔ∏è Service Accounts Using NTLM (Should Use Kerberos)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "orange" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "ServiceAccountNTLM"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Cleartext/Reversible Password Storage Indicators\n// Event 4738 with password policy changes or 4670 with permission changes\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4738, 4670, 5136)\n| extend AttributeChanged = extract('<Data Name=\"AttributeLDAPDisplayName\">([^<]+)</Data>', 1, EventData)\n| extend AttributeValue = extract('<Data Name=\"AttributeValue\">([^<]+)</Data>', 1, EventData)\n| where AttributeChanged has_any (\"userAccountControl\", \"msDS-SupportedEncryptionTypes\", \"unicodePwd\", \"supplementalCredentials\")\n| summarize Count = count(), LastSeen = max(TimeGenerated) by SubjectUserName, TargetUserName, AttributeChanged, Computer\n| extend RiskNote = case(\n    AttributeChanged == \"userAccountControl\", \"üü† UAC Changed - Check for reversible encryption\",\n    AttributeChanged == \"msDS-SupportedEncryptionTypes\", \"üî¥ Encryption Types Modified\",\n    \"üü° Credential-related attribute changed\")\n| order by LastSeen desc\n| project RiskNote, ModifiedBy = SubjectUserName, TargetUser = TargetUserName, AttributeChanged, Computer, Count, LastSeen",
              "size": 0,
              "title": "üîì Credential Storage & Encryption Attribute Changes",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ReversiblePasswordDetection"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Kerberos Pre-Authentication Type Analysis\n// Pre-auth type 0 = No pre-auth (AS-REP Roasting vulnerability)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4768\n| extend PreAuthType = extract('<Data Name=\"PreAuthType\">([^<]+)</Data>', 1, EventData)\n| extend PreAuthDescription = case(\n    PreAuthType == \"0\", \"üî¥ No Pre-Auth (AS-REP Roastable)\",\n    PreAuthType == \"2\", \"üü¢ Encrypted Timestamp\",\n    PreAuthType == \"11\", \"üü¢ PKINIT\",\n    PreAuthType == \"15\", \"üü¢ PA-ETYPE-INFO2\",\n    PreAuthType == \"16\", \"üü¢ PA-PK-AS-REQ\",\n    strcat(\"Unknown: \", PreAuthType))\n| where PreAuthType == \"0\"\n| summarize \n    Count = count(),\n    LastSeen = max(TimeGenerated),\n    SourceIPs = make_set(IpAddress, 5)\n    by TargetUserName, Computer, PreAuthDescription\n| order by Count desc\n| project PreAuthDescription, User = TargetUserName, DC = Computer, Count, LastSeen, SourceIPs",
              "size": 0,
              "title": "üéØ AS-REP Roasting Vulnerable Accounts (No Pre-Auth)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "red" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "ASREPRoasting"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// LDAP Signing and Channel Binding Status\n// Event 2889 indicates unsigned LDAP binds (should be enforced)\nEvent\n| where TimeGenerated {TimeRange}\n| where EventLog == \"Directory Service\"\n| where EventID in (2889, 2888, 3039, 3040)\n| extend ClientIP = extract(\"Client IP address: ([0-9.]+)\", 1, RenderedDescription)\n| extend BindType = case(\n    EventID == 2889, \"üî¥ Unsigned LDAP Bind\",\n    EventID == 2888, \"üü° LDAP Signing Not Required Warning\",\n    EventID == 3039, \"üü† LDAP Channel Binding Not Enforced\",\n    EventID == 3040, \"üî¥ Unsigned LDAP over SSL\",\n    \"Other\")\n| summarize Count = count(), LastSeen = max(TimeGenerated), Clients = make_set(ClientIP, 10) by BindType, Computer\n| order by Count desc\n| project BindType, DC = Computer, Count, LastSeen, Clients",
              "size": 0,
              "title": "üì° LDAP Signing & Channel Binding Issues",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "LDAPSigningDetection"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// LDAP Cleartext (Simple Bind) Detection\n// Event 2886 indicates LDAP simple binds over unencrypted connection\n// This exposes credentials in cleartext on the network\nEvent\n| where TimeGenerated {TimeRange}\n| where EventLog == \"Directory Service\"\n| where EventID in (2886, 2887)\n| extend ClientIP = extract(\"Client IP address: ([0-9.]+)\", 1, RenderedDescription)\n| extend ClientDN = extract(\"Client DN: ([^\\\\n]+)\", 1, RenderedDescription)\n| extend BindIssue = case(\n    EventID == 2886, \"üî¥ CRITICAL - LDAP Simple Bind (Cleartext Password)\",\n    EventID == 2887, \"üî¥ CRITICAL - LDAP Simple Bind Count Warning\",\n    \"Other\")\n| summarize \n    Count = count(),\n    LastSeen = max(TimeGenerated),\n    FirstSeen = min(TimeGenerated),\n    Clients = make_set(ClientIP, 20),\n    SampleDNs = make_set(ClientDN, 5)\n    by BindIssue, Computer\n| order by Count desc\n| project BindIssue, DC = Computer, Count, FirstSeen, LastSeen, Clients, SampleDNs",
              "size": 0,
              "title": "üî¥ LDAP Cleartext / Simple Bind Detection (Password Exposed)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "red" } },
                  { "columnMatch": "BindIssue", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "contains", "thresholdValue": "CRITICAL", "representation": "red", "text": "{0}"}, {"operator": "Default", "representation": "orange", "text": "{0}"}] } }
                ]
              }
            },
            "customWidth": "50",
            "name": "LDAPCleartextDetection"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// LDAP Simple Bind Clients - Detailed View\n// Identifies which clients are performing insecure LDAP binds\nEvent\n| where TimeGenerated {TimeRange}\n| where EventLog == \"Directory Service\"\n| where EventID in (2886, 2889)\n| extend ClientIP = extract(\"Client IP address: ([0-9.]+)\", 1, RenderedDescription)\n| extend BindingUser = extract(\"Binding user: ([^\\\\n]+)\", 1, RenderedDescription)\n| where isnotempty(ClientIP)\n| summarize \n    SimpleBinds = countif(EventID == 2886),\n    UnsignedBinds = countif(EventID == 2889),\n    TotalInsecure = count(),\n    LastSeen = max(TimeGenerated),\n    BindingUsers = make_set(BindingUser, 5)\n    by ClientIP, Computer\n| extend RiskLevel = case(\n    SimpleBinds > 0, \"üî¥ CRITICAL - Cleartext Credentials\",\n    UnsignedBinds > 100, \"üü† HIGH - Heavy Unsigned Traffic\",\n    \"üü° MEDIUM - Unsigned LDAP\")\n| order by SimpleBinds desc, UnsignedBinds desc\n| project RiskLevel, ClientIP, DC = Computer, SimpleBinds, UnsignedBinds, TotalInsecure, LastSeen, BindingUsers\n| take 50",
              "size": 0,
              "title": "üñ•Ô∏è LDAP Insecure Clients by IP",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "SimpleBinds", "formatter": 4, "formatOptions": { "palette": "red" } },
                  { "columnMatch": "UnsignedBinds", "formatter": 4, "formatOptions": { "palette": "orange" } },
                  { "columnMatch": "RiskLevel", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "contains", "thresholdValue": "CRITICAL", "representation": "red", "text": "{0}"}, {"operator": "contains", "thresholdValue": "HIGH", "representation": "orange", "text": "{0}"}, {"operator": "Default", "representation": "yellow", "text": "{0}"}] } }
                ]
              }
            },
            "customWidth": "50",
            "name": "LDAPInsecureClients"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// SMBv1 Usage Detection\n// SMBv1 is deprecated and has known vulnerabilities (EternalBlue)\nEvent\n| where TimeGenerated {TimeRange}\n| where EventLog == \"Microsoft-Windows-SMBServer/Audit\" or Source == \"srv\"\n| where EventID in (3000, 1001)\n| extend ClientIP = extract(\"Client Address: ([0-9.]+)\", 1, RenderedDescription)\n| summarize Count = count(), LastSeen = max(TimeGenerated), Clients = make_set(ClientIP, 20) by Computer\n| extend Guidance = \"üî¥ SMBv1 is deprecated - disable and migrate\"\n| project Guidance, Server = Computer, SMBv1Connections = Count, LastSeen, ClientIPs = Clients",
              "size": 0,
              "title": "üîå SMBv1 Usage Detection (Deprecated)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "SMBv1Detection"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Pass-the-Hash (PtH) Indicators via NTLM\n// Network logons (Type 3) with NTLM from non-standard workstations\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where LogonType == 3\n| where AuthenticationPackageName == \"NTLM\"\n| where LmPackageName has \"NTLM\"\n| where TargetUserName !endswith \"$\"\n| where isnotempty(IpAddress) and IpAddress != \"-\"\n| extend PtHIndicator = case(\n    WorkstationName == \"\" or WorkstationName == \"-\", \"üî¥ Missing Workstation Name\",\n    IpAddress != WorkstationName, \"üü† IP/Workstation Mismatch\",\n    \"üü¢ Normal\")\n| where PtHIndicator in (\"üî¥ Missing Workstation Name\", \"üü† IP/Workstation Mismatch\")\n| summarize \n    Count = count(),\n    LastSeen = max(TimeGenerated),\n    TargetComputers = make_set(Computer, 5)\n    by PtHIndicator, TargetUserName, IpAddress, WorkstationName\n| order by Count desc\n| project PtHIndicator, User = TargetUserName, SourceIP = IpAddress, Workstation = WorkstationName, Count, LastSeen, TargetComputers",
              "size": 0,
              "title": "üîê Pass-the-Hash Indicators (NTLM Network Logon Anomalies)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "red" } }
                ]
              }
            },
            "name": "PtHDetection"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n## üîë Kerberos RC4 Deprecation Monitoring\n\nRC4 (ARCFOUR) encryption is deprecated in modern Windows environments due to known cryptographic weaknesses. Microsoft recommends migrating to AES encryption (AES128/AES256).\n\n**Why Remove RC4:**\n- RC4 is vulnerable to statistical attacks and key recovery\n- Enables Kerberoasting attacks with faster offline cracking\n- Microsoft deprecated RC4 in Windows Server 2025\n- Compliance frameworks (PCI DSS, NIST) require strong encryption\n\n**Key Events for RC4 Monitoring:**\n| Event ID | Source | Description | Availability |\n|----------|--------|-------------|--------------|\n| **201** | System | RC4 TGT issued by KDC | Windows Server 2025+ |\n| **206** | System | RC4 Service Ticket issued | Windows Server 2025+ |\n| **207** | System | RC4 used (missing AES keys) | Windows Server 2025+ |\n| **208** | System | RC4 used for cross-realm | Windows Server 2025+ |\n| **16** | KDC/Operational | RC4 TGT created for user | Windows Server 2019+ |\n| **17** | KDC/Operational | RC4 Service Ticket created | Windows Server 2019+ |\n| **4768** | Security | TGT Request (check encryption) | All versions |\n| **4769** | Security | TGS Request (check encryption) | All versions |\n\n---"
            },
            "name": "RC4DeprecationHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// RC4 Deprecation Summary - All Sources\nlet RC4FromSecurity = SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4768, 4769)\n| extend TicketEncryptionType = extract('<Data Name=\"TicketEncryptionType\">([^<]+)</Data>', 1, EventData)\n| where TicketEncryptionType in (\"0x17\", \"0x18\")\n| summarize RC4SecurityEvents = count();\nlet RC4FromSystem = Event\n| where TimeGenerated {TimeRange}\n| where EventID in (201, 206, 207, 208, 209, 210)\n| summarize RC4SystemEvents = count();\nlet RC4FromKDC = Event\n| where TimeGenerated {TimeRange}\n| where EventLog has \"Kerberos-Key-Distribution-Center\"\n| where EventID in (16, 17, 18, 19)\n| summarize RC4KDCEvents = count();\nprint \n  ['üî¥ RC4 Tickets (4768/4769)'] = toscalar(RC4FromSecurity),\n  ['üÜï RC4 Events (201/206/207)'] = toscalar(RC4FromSystem),\n  ['üìã KDC RC4 Audit (16-19)'] = toscalar(RC4FromKDC)",
              "size": 3,
              "title": "üîë RC4 Deprecation Summary",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true
              }
            },
            "name": "RC4DeprecationSummary"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Event 201 - RC4 TGT Issued (Windows Server 2025+)\n// Indicates KDC issued a TGT using RC4 encryption\nEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 201\n| extend AccountName = extract(@\"Account Name:\\s*([^\\r\\n]+)\", 1, RenderedDescription)\n| extend AccountDomain = extract(@\"Account Domain:\\s*([^\\r\\n]+)\", 1, RenderedDescription)\n| extend ClientAddress = extract(@\"Client Address:\\s*([^\\r\\n]+)\", 1, RenderedDescription)\n| extend EncryptionType = extract(@\"Encryption Type:\\s*([^\\r\\n]+)\", 1, RenderedDescription)\n| summarize \n    RC4TGTCount = count(),\n    LastSeen = max(TimeGenerated),\n    FirstSeen = min(TimeGenerated),\n    ClientIPs = make_set(ClientAddress, 5)\n    by AccountName, AccountDomain, Computer\n| extend DeprecationStatus = \"üî¥ RC4 TGT - Migrate to AES\"\n| order by RC4TGTCount desc\n| project DeprecationStatus, Account = strcat(AccountDomain, \"\\\\\", AccountName), DC = Computer, RC4TGTCount, FirstSeen, LastSeen, ClientIPs",
              "size": 0,
              "title": "üÜï Event 201: RC4 TGT Issued (Windows Server 2025+)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "RC4TGTCount", "formatter": 4, "formatOptions": { "palette": "red" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "Event201RC4TGT"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Event 206 - RC4 Service Ticket Issued (Windows Server 2025+)\n// Indicates KDC issued a service ticket using RC4 encryption\nEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 206\n| extend AccountName = extract(@\"Account Name:\\s*([^\\r\\n]+)\", 1, RenderedDescription)\n| extend ServiceName = extract(@\"Service Name:\\s*([^\\r\\n]+)\", 1, RenderedDescription)\n| extend ClientAddress = extract(@\"Client Address:\\s*([^\\r\\n]+)\", 1, RenderedDescription)\n| extend TicketOptions = extract(@\"Ticket Options:\\s*([^\\r\\n]+)\", 1, RenderedDescription)\n| summarize \n    RC4ServiceTickets = count(),\n    LastSeen = max(TimeGenerated),\n    UniqueUsers = dcount(AccountName),\n    Users = make_set(AccountName, 5),\n    ClientIPs = make_set(ClientAddress, 5)\n    by ServiceName, Computer\n| extend ServiceType = case(\n    ServiceName has \"http\", \"üåê Web Service\",\n    ServiceName has \"mssql\", \"üóÑÔ∏è SQL Server\",\n    ServiceName has \"cifs\", \"üìÅ File Share\",\n    ServiceName has \"ldap\", \"üìÇ LDAP\",\n    ServiceName has \"host\", \"üñ•Ô∏è Host Service\",\n    \"üìã Other Service\"\n)\n| extend Priority = case(\n    RC4ServiceTickets > 1000, \"üî¥ Critical - High Volume\",\n    RC4ServiceTickets > 100, \"üü† High - Significant Usage\",\n    RC4ServiceTickets > 10, \"üü° Medium - Moderate Usage\",\n    \"üü¢ Low\"\n)\n| order by RC4ServiceTickets desc\n| project Priority, ServiceType, ServiceName, DC = Computer, RC4ServiceTickets, UniqueUsers, Users, LastSeen, ClientIPs",
              "size": 0,
              "title": "üÜï Event 206: RC4 Service Tickets by SPN (Windows Server 2025+)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "RC4ServiceTickets", "formatter": 4, "formatOptions": { "palette": "red" } },
                  { "columnMatch": "Priority", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "contains", "thresholdValue": "Critical", "representation": "red", "text": "{0}"}, {"operator": "contains", "thresholdValue": "High", "representation": "orange", "text": "{0}"}, {"operator": "contains", "thresholdValue": "Medium", "representation": "yellow", "text": "{0}"}, {"operator": "Default", "representation": "green", "text": "{0}"}] } }
                ]
              }
            },
            "customWidth": "50",
            "name": "Event206RC4ServiceTicket"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Event 207/208/209/210 - RC4 Fallback Reasons\n// These events indicate why RC4 was used instead of AES\nEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (207, 208, 209, 210)\n| extend EventDescription = case(\n    EventID == 207, \"üî¥ RC4 used - Missing AES keys on account\",\n    EventID == 208, \"üü† RC4 used - Cross-realm trust limitation\",\n    EventID == 209, \"üü° RC4 used - Client requested RC4 only\",\n    EventID == 210, \"üü° RC4 used - Legacy application\",\n    \"Other RC4 event\"\n)\n| extend AccountName = extract(@\"Account Name:\\s*([^\\r\\n]+)\", 1, RenderedDescription)\n| extend ServiceName = extract(@\"Service Name:\\s*([^\\r\\n]+)\", 1, RenderedDescription)\n| extend Reason = extract(@\"Reason:\\s*([^\\r\\n]+)\", 1, RenderedDescription)\n| summarize \n    Count = count(),\n    LastSeen = max(TimeGenerated),\n    AffectedAccounts = make_set(AccountName, 10),\n    AffectedServices = make_set(ServiceName, 10)\n    by EventID, EventDescription, Computer\n| order by EventID asc\n| project EventDescription, EventID, DC = Computer, Count, LastSeen, AffectedAccounts, AffectedServices",
              "size": 0,
              "title": "üìã RC4 Fallback Reasons (Events 207-210)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "orange" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "RC4FallbackReasons"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// KDC Operational Events 16-19 - RC4 Audit\n// These events are available on Windows Server 2019+ when KDC auditing is enabled\nEvent\n| where TimeGenerated {TimeRange}\n| where EventLog has \"Kerberos-Key-Distribution-Center\" or EventLog has \"KDC\"\n| where EventID in (16, 17, 18, 19)\n| extend EventDescription = case(\n    EventID == 16, \"üî¥ RC4 TGT created for user\",\n    EventID == 17, \"üî¥ RC4 Service Ticket created\",\n    EventID == 18, \"üü† Account missing AES keys\",\n    EventID == 19, \"üü° Trust uses RC4 encryption\",\n    \"Other\"\n)\n| extend AccountName = extract(@\"Account:\\s*([^\\r\\n@]+)\", 1, RenderedDescription)\n| extend ServiceName = extract(@\"Service:\\s*([^\\r\\n]+)\", 1, RenderedDescription)\n| summarize \n    Count = count(),\n    LastSeen = max(TimeGenerated),\n    Accounts = make_set(AccountName, 10),\n    Services = make_set(ServiceName, 10)\n    by EventID, EventDescription, Computer\n| order by EventID asc\n| project EventDescription, EventID, DC = Computer, Count, LastSeen, Accounts, Services",
              "size": 0,
              "title": "üîç KDC RC4 Audit Events (16-19)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Count", "formatter": 4, "formatOptions": { "palette": "red" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "KDCAuditEvents"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Accounts Using RC4 - Remediation Priority List\n// Combines data from Security Events 4768/4769 to identify accounts needing AES migration\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4768, 4769)\n| extend TicketEncryptionType = extract('<Data Name=\"TicketEncryptionType\">([^<]+)</Data>', 1, EventData)\n| where TicketEncryptionType in (\"0x17\", \"0x18\")  // RC4-HMAC variants\n| extend TicketType = iff(EventID == 4768, \"TGT\", \"TGS\")\n| extend ServiceName = extract('<Data Name=\"ServiceName\">([^<]+)</Data>', 1, EventData)\n| summarize \n    RC4TicketCount = count(),\n    TGTCount = countif(EventID == 4768),\n    TGSCount = countif(EventID == 4769),\n    LastSeen = max(TimeGenerated),\n    FirstSeen = min(TimeGenerated),\n    ServicesAccessed = make_set(ServiceName, 10),\n    DCs = make_set(Computer, 5)\n    by TargetUserName, TargetDomainName\n| extend RemediationPriority = case(\n    TargetUserName endswith \"$\", \"üîµ Computer Account\",\n    TargetUserName has_any (\"admin\", \"svc\", \"service\"), \"üî¥ Privileged/Service Account\",\n    RC4TicketCount > 1000, \"üü† High Volume User\",\n    \"üü° Standard User\"\n)\n| extend RemediationAction = case(\n    TargetUserName endswith \"$\", \"Update msDS-SupportedEncryptionTypes on computer object\",\n    TargetUserName has \"svc\", \"Convert to gMSA or update encryption types\",\n    \"Reset password after enabling AES on account\"\n)\n| order by RC4TicketCount desc\n| project RemediationPriority, Account = strcat(TargetDomainName, \"\\\\\", TargetUserName), RC4TicketCount, TGTCount, TGSCount, FirstSeen, LastSeen, RemediationAction, ServicesAccessed\n| take 50",
              "size": 0,
              "title": "üìã RC4 Account Remediation Priority List",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "RC4TicketCount", "formatter": 4, "formatOptions": { "palette": "red" } },
                  { "columnMatch": "RemediationPriority", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "contains", "thresholdValue": "Privileged", "representation": "red", "text": "{0}"}, {"operator": "contains", "thresholdValue": "High", "representation": "orange", "text": "{0}"}, {"operator": "contains", "thresholdValue": "Computer", "representation": "blue", "text": "{0}"}, {"operator": "Default", "representation": "yellow", "text": "{0}"}] } }
                ]
              }
            },
            "name": "RC4RemediationList"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// RC4 Usage Trend Over Time\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4768, 4769)\n| extend TicketEncryptionType = extract('<Data Name=\"TicketEncryptionType\">([^<]+)</Data>', 1, EventData)\n| extend EncryptionCategory = case(\n    TicketEncryptionType in (\"0x17\", \"0x18\"), \"RC4 (Deprecated)\",\n    TicketEncryptionType in (\"0x11\", \"0x12\"), \"AES (Recommended)\",\n    TicketEncryptionType in (\"0x1\", \"0x3\"), \"DES (Critical)\",\n    \"Other\"\n)\n| where EncryptionCategory != \"Other\"\n| summarize Count = count() by EncryptionCategory, bin(TimeGenerated, 1h)\n| render timechart",
              "size": 0,
              "title": "üìà Kerberos Encryption Type Trend (RC4 vs AES vs DES)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "RC4UsageTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principals Using RC4 - Kerberoasting Risk\n// SPNs using RC4 are prime targets for Kerberoasting attacks\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4769\n| extend TicketEncryptionType = extract('<Data Name=\"TicketEncryptionType\">([^<]+)</Data>', 1, EventData)\n| extend ServiceName = extract('<Data Name=\"ServiceName\">([^<]+)</Data>', 1, EventData)\n| where TicketEncryptionType in (\"0x17\", \"0x18\")\n| where ServiceName !endswith \"$\" and ServiceName != \"krbtgt\"\n| summarize \n    RC4Tickets = count(),\n    UniqueRequesters = dcount(TargetUserName),\n    Requesters = make_set(TargetUserName, 5),\n    LastRequest = max(TimeGenerated)\n    by ServiceName, Computer\n| extend KerberoastRisk = case(\n    RC4Tickets > 100 and UniqueRequesters > 5, \"üî¥ HIGH - Frequent RC4 requests from multiple users\",\n    RC4Tickets > 50, \"üü† MEDIUM - Significant RC4 usage\",\n    \"üü° LOW - Monitor for increase\"\n)\n| extend Remediation = \"Set msDS-SupportedEncryptionTypes=24 (AES only) and rotate password\"\n| order by RC4Tickets desc\n| project KerberoastRisk, ServiceName, DC = Computer, RC4Tickets, UniqueRequesters, Requesters, LastRequest, Remediation\n| take 30",
              "size": 0,
              "title": "üéØ Service Principals with RC4 (Kerberoasting Risk)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "RC4Tickets", "formatter": 4, "formatOptions": { "palette": "red" } },
                  { "columnMatch": "KerberoastRisk", "formatter": 18, "formatOptions": { "thresholdsOptions": "colors", "thresholdsGrid": [{"operator": "contains", "thresholdValue": "HIGH", "representation": "red", "text": "{0}"}, {"operator": "contains", "thresholdValue": "MEDIUM", "representation": "orange", "text": "{0}"}, {"operator": "Default", "representation": "yellow", "text": "{0}"}] } }
                ]
              }
            },
            "customWidth": "50",
            "name": "SPNsUsingRC4"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### üîß RC4 Deprecation Remediation Guide\n\n**Phase 1: Discovery & Auditing**\n1. Enable KDC auditing for RC4 events (GPO or registry)\n2. Deploy Windows Server 2025 DCs for enhanced logging (Events 201, 206)\n3. Use this workbook to identify all RC4 usage\n4. Document applications and accounts requiring RC4\n\n**Phase 2: Preparation**\n1. Verify all DCs support AES (Windows 2008+ required)\n2. Update `msDS-SupportedEncryptionTypes` on service accounts to include AES:\n   - Value `24` = AES128 + AES256 (recommended)\n   - Value `28` = AES128 + AES256 + RC4 (transition period)\n3. Reset passwords on service accounts after enabling AES\n4. Update computer accounts in AD to support AES\n\n**Phase 3: Migration**\n1. Configure GPO to prefer AES:\n   - `Network security: Configure encryption types allowed for Kerberos`\n   - Enable only AES128_HMAC_SHA1 and AES256_HMAC_SHA1\n2. Test critical applications for compatibility\n3. Update domain/forest functional level to 2012 R2+\n4. Rotate all service account passwords\n\n**Phase 4: Enforcement**\n1. Remove RC4 from allowed encryption types in GPO\n2. Set `msDS-SupportedEncryptionTypes = 24` on all accounts\n3. Monitor for authentication failures\n4. Address remaining compatibility issues\n\n**PowerShell Commands:**\n```powershell\n# Find accounts with RC4-only encryption\nGet-ADUser -Filter * -Properties msDS-SupportedEncryptionTypes | \n  Where-Object { $_.'msDS-SupportedEncryptionTypes' -eq $null -or $_.'msDS-SupportedEncryptionTypes' -band 4 }\n\n# Enable AES on a service account\nSet-ADUser -Identity \"svc_account\" -KerberosEncryptionType AES128,AES256\n\n# Check encryption types on all service accounts\nGet-ADUser -Filter {ServicePrincipalName -ne \"$null\"} -Properties msDS-SupportedEncryptionTypes, ServicePrincipalName |\n  Select Name, ServicePrincipalName, msDS-SupportedEncryptionTypes\n```\n\n---"
            },
            "name": "RC4RemediationGuide"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// RC4 Deprecation Compliance Check\nlet RC4Accounts = SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4768, 4769)\n| extend TicketEncryptionType = extract('<Data Name=\"TicketEncryptionType\">([^<]+)</Data>', 1, EventData)\n| where TicketEncryptionType in (\"0x17\", \"0x18\")\n| distinct TargetUserName;\nlet AESAccounts = SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4768, 4769)\n| extend TicketEncryptionType = extract('<Data Name=\"TicketEncryptionType\">([^<]+)</Data>', 1, EventData)\n| where TicketEncryptionType in (\"0x11\", \"0x12\")\n| distinct TargetUserName;\nlet TotalAccounts = SecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4768, 4769)\n| distinct TargetUserName;\nprint \n  ['Total Accounts Authenticating'] = toscalar(TotalAccounts | count),\n  ['‚úÖ AES-Only Accounts'] = toscalar(AESAccounts | join kind=leftanti RC4Accounts on TargetUserName | count),\n  ['üî¥ RC4-Using Accounts'] = toscalar(RC4Accounts | count),\n  ['üü¢ Compliance Rate %'] = round(100.0 * toscalar(AESAccounts | join kind=leftanti RC4Accounts on TargetUserName | count) / toscalar(TotalAccounts | count), 1)",
              "size": 3,
              "title": "‚úÖ RC4 Deprecation Compliance Status",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true
              }
            },
            "name": "RC4ComplianceCheck"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### üìã Stale Protocol Remediation Guide\n\n| Protocol | Risk Level | Remediation |\n|----------|------------|-------------|\n| **NTLMv1 / LM Hash** | üî¥ Critical | Disable via GPO: `Network security: LAN Manager authentication level` = Send NTLMv2 only. Refuse LM & NTLM |\n| **WDigest** | üî¥ Critical | Set registry: `HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest\\UseLogonCredential` = 0 |\n| **DES Kerberos** | üî¥ Critical | Disable DES encryption types via GPO and update `msDS-SupportedEncryptionTypes` on accounts |\n| **RC4 Kerberos** | üü† High | Transition to AES; set `msDS-SupportedEncryptionTypes` = 24 (AES128+AES256) on service accounts |\n| **TLS 1.0/1.1** | üü† High | Disable via registry or GPO; ensure applications support TLS 1.2+ |\n| **SMBv1** | üî¥ Critical | Disable via: `Disable-WindowsOptionalFeature -Online -FeatureName SMB1Protocol` |\n| **Unsigned LDAP** | üü† High | Set GPO: `Domain controller: LDAP server signing requirements` = Require signing |\n| **Anonymous Logon** | üü† High | Restrict anonymous enumeration via GPO security options |\n\n### üîç Key Event IDs for Stale Protocol Detection\n\n| Event ID | Description | Use Case |\n|----------|-------------|----------|\n| 4624 | Successful Logon | Detect NTLM version via LmPackageName |\n| 4776 | NTLM Credential Validation | All NTLM auth against DC |\n| 4768 | Kerberos TGT Request | Detect encryption type and pre-auth |\n| 4769 | Kerberos Service Ticket | Detect weak encryption (RC4/DES) |\n| 2889 | Unsigned LDAP Bind | LDAP signing not enforced |\n| 36880 | Schannel TLS | TLS version negotiation |\n\n### üéØ Recommended GPO Settings\n\n```\nComputer Configuration > Policies > Windows Settings > Security Settings > Local Policies > Security Options:\n\n‚Ä¢ Network security: LAN Manager authentication level = \"Send NTLMv2 response only. Refuse LM & NTLM\"\n‚Ä¢ Network security: Minimum session security for NTLM SSP = \"Require NTLMv2, Require 128-bit\"\n‚Ä¢ Network security: Configure encryption types allowed for Kerberos = \"AES128, AES256, Future types\"\n‚Ä¢ Network security: Restrict NTLM: Audit NTLM in this domain = \"Enable all\"\n```"
            },
            "name": "StaleProtocolGuidance"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "disabled_staleprotocols_duplicate"
      },
      "name": "StaleProtocolsDuplicateGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üëª Stale Accounts & Devices\n\n**Purpose:** Identify dormant accounts and devices that pose security risks. Stale objects are prime targets for attackers as they often have weak or unchanged passwords and may be overlooked in security reviews.\n\n| Risk Category | Description | Remediation |\n|---------------|-------------|-------------|\n| **Inactive Users** | Users who haven't logged in for extended periods | Disable after 90 days, delete after 180 days |\n| **Password Age** | Accounts with passwords older than policy allows | Force password reset or disable |\n| **Non-Expiring Passwords** | Accounts exempt from password expiration | Review necessity, enable expiration where possible |\n| **Stale Computers** | Computer accounts that haven't authenticated | Remove from AD after verification |\n| **Legacy OS** | Systems running unsupported operating systems | Upgrade or isolate |\n\n---\n\n### üìä Data Sources\n\n**SecurityEvent Table:** Uses Windows Security Event logs (4624, 4768, 4769) to detect user and computer activity patterns.\n\n**Note:** This analysis is based on authentication activity observed in your selected time range. For complete stale account detection, ensure adequate log retention."
            },
            "name": "StaleAccountsHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Stale Accounts Overview Summary (Based on Authentication Activity)\nlet TimeWindow = 90d;\nlet AllUsers = SecurityEvent\n| where TimeGenerated > ago(TimeWindow)\n| where EventID in (4624, 4768)\n| where AccountType == \"User\" or TargetUserName !endswith \"$\"\n| where TargetUserName !in (\"SYSTEM\", \"LOCAL SERVICE\", \"NETWORK SERVICE\", \"ANONYMOUS LOGON\", \"-\")\n| summarize LastLogon = max(TimeGenerated) by TargetUserName\n| where isnotempty(TargetUserName);\nlet ActiveUsers = AllUsers | where LastLogon > ago(30d) | count;\nlet IdleUsers = AllUsers | where LastLogon between (ago(90d) .. ago(30d)) | count;\nlet UsersWithLogons = AllUsers | count;\nlet AllComputers = SecurityEvent\n| where TimeGenerated > ago(TimeWindow)\n| where EventID in (4624, 4768, 4769)\n| where TargetUserName endswith \"$\"\n| summarize LastSeen = max(TimeGenerated) by Computer\n| where isnotempty(Computer);\nlet ActiveComputers = AllComputers | where LastSeen > ago(30d) | count;\nlet StaleComputers = AllComputers | where LastSeen < ago(60d) | count;\nprint Metric = dynamic([\"üë§ Active Users (30 days)\", \"‚è≥ Idle Users (30-90 days)\", \"üíª Active Computers\", \"üñ•Ô∏è Stale Computers (60+ days)\"]),\n      Count = pack_array(toscalar(ActiveUsers), toscalar(IdleUsers), toscalar(ActiveComputers), toscalar(StaleComputers)),\n      Status = dynamic([\"üü¢ Good\", \"üü† Monitor\", \"üü¢ Good\", \"üî¥ Review\"])\n| mv-expand Metric to typeof(string), Count to typeof(long), Status to typeof(string)",
              "size": 4,
              "title": "üìä Account & Device Activity Overview",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Count", "formatter": 12, "formatOptions": { "palette": "auto" } },
                "secondaryContent": { "columnMatch": "Status", "formatter": 1 }
              }
            },
            "name": "StaleOverviewTiles"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üë§ User Activity Analysis"
            },
            "name": "StaleUsersHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Users by Last Authentication Time\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4768)\n| where AccountType == \"User\" or TargetUserName !endswith \"$\"\n| where TargetUserName !in (\"SYSTEM\", \"LOCAL SERVICE\", \"NETWORK SERVICE\", \"ANONYMOUS LOGON\", \"-\", \"\")\n| where isnotempty(TargetUserName)\n| summarize \n    LastLogon = max(TimeGenerated),\n    LogonCount = count(),\n    UniqueComputers = dcount(Computer),\n    Computers = make_set(Computer, 5)\n    by TargetUserName, TargetDomainName\n| extend DaysSinceLastLogon = datetime_diff('day', now(), LastLogon)\n| extend ActivityStatus = case(\n    DaysSinceLastLogon <= 7, \"üü¢ Active (7 days)\",\n    DaysSinceLastLogon <= 30, \"üü¢ Recent (30 days)\",\n    DaysSinceLastLogon <= 60, \"üü° Idle (60 days)\",\n    DaysSinceLastLogon <= 90, \"üü† Stale (90 days)\",\n    \"üî¥ Inactive (90+ days)\")\n| extend IsPrivileged = case(\n    TargetUserName has_any (\"admin\", \"svc\", \"service\", \"adm\"), \"‚ö†Ô∏è Possible\",\n    \"No\")\n| project ActivityStatus, TargetUserName, TargetDomainName, DaysSinceLastLogon, LastLogon, LogonCount, UniqueComputers, IsPrivileged, Computers\n| order by DaysSinceLastLogon desc\n| take 100",
              "size": 0,
              "title": "üë§ Users by Last Authentication (Identify Idle/Stale Accounts)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "DaysSinceLastLogon", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                  { "columnMatch": "LogonCount", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "InactiveUsers"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Privileged Account Activity\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4672  // Special privileges assigned\n| where SubjectUserName !in (\"SYSTEM\", \"LOCAL SERVICE\", \"NETWORK SERVICE\", \"-\")\n| where SubjectUserName !endswith \"$\"\n| summarize \n    LastPrivilegedLogon = max(TimeGenerated),\n    PrivilegedLogonCount = count(),\n    UniqueComputers = dcount(Computer),\n    Computers = make_set(Computer, 5)\n    by SubjectUserName, SubjectDomainName\n| extend DaysSinceLastPrivLogon = datetime_diff('day', now(), LastPrivilegedLogon)\n| extend PrivAccountStatus = case(\n    DaysSinceLastPrivLogon <= 7, \"üü¢ Active Admin\",\n    DaysSinceLastPrivLogon <= 30, \"üü¢ Recent Admin\",\n    DaysSinceLastPrivLogon <= 60, \"üü° Idle Admin\",\n    \"üî¥ Stale Admin - Review\")\n| project PrivAccountStatus, SubjectUserName, SubjectDomainName, DaysSinceLastPrivLogon, LastPrivilegedLogon, PrivilegedLogonCount, UniqueComputers, Computers\n| order by DaysSinceLastPrivLogon desc\n| take 50",
              "size": 0,
              "title": "üëë Privileged Account Activity (Event 4672)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "DaysSinceLastPrivLogon", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                  { "columnMatch": "PrivilegedLogonCount", "formatter": 4, "formatOptions": { "palette": "purple" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "OldPasswords"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Accounts Activity\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4768)\n| where TargetUserName !endswith \"$\"\n| where TargetUserName has_any (\"svc\", \"service\", \"_sa\", \"app_\", \"sql\", \"iis\", \"backup\")\n| where TargetUserName !in (\"SYSTEM\", \"LOCAL SERVICE\", \"NETWORK SERVICE\", \"-\")\n| summarize \n    LastLogon = max(TimeGenerated),\n    LogonCount = count(),\n    UniqueComputers = dcount(Computer),\n    LogonTypes = make_set(LogonType, 5),\n    Computers = make_set(Computer, 5)\n    by TargetUserName, TargetDomainName\n| extend DaysSinceLastLogon = datetime_diff('day', now(), LastLogon)\n| extend SvcAccountStatus = case(\n    DaysSinceLastLogon <= 1, \"üü¢ Active\",\n    DaysSinceLastLogon <= 7, \"üü¢ Recent\",\n    DaysSinceLastLogon <= 30, \"üü° Check\",\n    \"üî¥ Stale - Review\")\n| project SvcAccountStatus, TargetUserName, TargetDomainName, DaysSinceLastLogon, LastLogon, LogonCount, LogonTypes, UniqueComputers, Computers\n| order by DaysSinceLastLogon desc\n| take 50",
              "size": 0,
              "title": "üîß Service Account Activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "DaysSinceLastLogon", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } }
                ]
              }
            },
            "customWidth": "50",
            "name": "NonExpiringPasswords"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// User Activity Distribution\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4768)\n| where AccountType == \"User\" or TargetUserName !endswith \"$\"\n| where TargetUserName !in (\"SYSTEM\", \"LOCAL SERVICE\", \"NETWORK SERVICE\", \"ANONYMOUS LOGON\", \"-\", \"\")\n| summarize LastLogon = max(TimeGenerated) by TargetUserName\n| extend ActivityBucket = case(\n    LastLogon > ago(7d), \"Active (< 7 days)\",\n    LastLogon > ago(30d), \"Recent (7-30 days)\",\n    LastLogon > ago(60d), \"Idle (30-60 days)\",\n    LastLogon > ago(90d), \"Stale (60-90 days)\",\n    \"Inactive (90+ days)\")\n| summarize Count = count() by ActivityBucket\n| order by case(\n    ActivityBucket == \"Active (< 7 days)\", 1,\n    ActivityBucket == \"Recent (7-30 days)\", 2,\n    ActivityBucket == \"Idle (30-60 days)\", 3,\n    ActivityBucket == \"Stale (60-90 days)\", 4,\n    5) asc",
              "size": 0,
              "title": "üìä User Activity Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "UserInactivityDistribution"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üíª Computer Account Activity"
            },
            "name": "StaleDevicesHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Computer Account Activity (Machine Accounts)\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4768, 4769)\n| where TargetUserName endswith \"$\"  // Machine accounts end with $\n| where TargetUserName != \"ANONYMOUS LOGON\"\n| summarize \n    LastSeen = max(TimeGenerated),\n    AuthCount = count(),\n    AuthTypes = make_set(case(EventID == 4624, \"Logon\", EventID == 4768, \"TGT\", EventID == 4769, \"TGS\", \"Other\"), 3)\n    by ComputerAccount = TargetUserName, Domain = TargetDomainName\n| extend ComputerName = replace_string(ComputerAccount, \"$\", \"\")\n| extend DaysSinceLastSeen = datetime_diff('day', now(), LastSeen)\n| extend ComputerStatus = case(\n    DaysSinceLastSeen <= 7, \"üü¢ Active\",\n    DaysSinceLastSeen <= 30, \"üü¢ Recent\",\n    DaysSinceLastSeen <= 60, \"üü° Idle\",\n    DaysSinceLastSeen <= 90, \"üü† Stale\",\n    \"üî¥ Inactive\")\n| project ComputerStatus, ComputerName, Domain, DaysSinceLastSeen, LastSeen, AuthCount, AuthTypes\n| order by DaysSinceLastSeen desc\n| take 100",
              "size": 0,
              "title": "üíª Computer Account Activity (Machine Authentication)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "DaysSinceLastSeen", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                  { "columnMatch": "AuthCount", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "InactiveComputers"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Workstations by Authentication Activity\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624\n| where LogonType in (2, 3, 7, 10, 11)  // Interactive, Network, Unlock, RemoteInteractive, CachedInteractive\n| where Computer !has \"DC\"  // Exclude domain controllers\n| summarize \n    LastActivity = max(TimeGenerated),\n    TotalLogons = count(),\n    UniqueUsers = dcount(TargetUserName),\n    Users = make_set(TargetUserName, 5)\n    by Computer\n| extend DaysSinceActivity = datetime_diff('day', now(), LastActivity)\n| extend WorkstationStatus = case(\n    DaysSinceActivity <= 7, \"üü¢ Active\",\n    DaysSinceActivity <= 30, \"üü¢ Recent\",\n    DaysSinceActivity <= 60, \"üü° Idle\",\n    \"üî¥ Stale/Offline\")\n| project WorkstationStatus, Computer, DaysSinceActivity, LastActivity, TotalLogons, UniqueUsers, Users\n| order by DaysSinceActivity desc\n| take 100",
              "size": 0,
              "title": "üñ•Ô∏è Workstation Activity (By Computer Name)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "DaysSinceActivity", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                  { "columnMatch": "TotalLogons", "formatter": 4, "formatOptions": { "palette": "blue" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "DevicesByOS"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Servers by Kerberos Service Ticket Activity\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4769  // Kerberos Service Ticket\n| where ServiceName !endswith \"$\" and ServiceName != \"krbtgt\"\n| summarize \n    LastServiceRequest = max(TimeGenerated),\n    TicketCount = count(),\n    UniqueRequesters = dcount(TargetUserName),\n    Requesters = make_set(TargetUserName, 5)\n    by ServiceName\n| extend DaysSinceLastRequest = datetime_diff('day', now(), LastServiceRequest)\n| extend ServiceStatus = case(\n    DaysSinceLastRequest <= 1, \"üü¢ Active\",\n    DaysSinceLastRequest <= 7, \"üü¢ Recent\",\n    DaysSinceLastRequest <= 30, \"üü° Low Activity\",\n    \"üî¥ Inactive/Stale\")\n| project ServiceStatus, ServiceName, DaysSinceLastRequest, LastServiceRequest, TicketCount, UniqueRequesters, Requesters\n| order by DaysSinceLastRequest desc\n| take 50",
              "size": 0,
              "title": "üîê Service Principal Activity (Kerberos TGS)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "DaysSinceLastRequest", "formatter": 4, "formatOptions": { "palette": "redGreen", "reverseColors": true } },
                  { "columnMatch": "TicketCount", "formatter": 4, "formatOptions": { "palette": "purple" } }
                ]
              }
            },
            "customWidth": "50",
            "name": "ComputerPasswordAge"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Computer Activity Distribution\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID in (4624, 4768, 4769)\n| summarize LastSeen = max(TimeGenerated) by Computer\n| extend ActivityBucket = case(\n    LastSeen > ago(1d), \"Active (Today)\",\n    LastSeen > ago(7d), \"Recent (7 days)\",\n    LastSeen > ago(30d), \"Moderate (30 days)\",\n    LastSeen > ago(60d), \"Idle (60 days)\",\n    \"Stale (60+ days)\")\n| summarize Count = count() by ActivityBucket\n| order by case(\n    ActivityBucket == \"Active (Today)\", 1,\n    ActivityBucket == \"Recent (7 days)\", 2,\n    ActivityBucket == \"Moderate (30 days)\", 3,\n    ActivityBucket == \"Idle (60 days)\", 4,\n    5) asc",
              "size": 0,
              "title": "üìä Computer Activity Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "DeviceInactivityDistribution"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n\n### üìã Stale Account Remediation Guide\n\n| Object Type | Condition | Risk Level | Recommended Action |\n|-------------|-----------|------------|-------------------|\n| **User Account** | No logon > 90 days | üü† Medium | Disable account, notify manager |\n| **User Account** | No logon > 180 days | üî¥ High | Disable and move to OU for deletion |\n| **User Account** | No logon > 365 days | üî¥ Critical | Delete after backup of mailbox/data |\n| **User Password** | Age > 180 days | üü† Medium | Force password reset at next logon |\n| **User Password** | Age > 365 days | üî¥ High | Reset password and review account |\n| **Non-Expiring Password** | Privileged account | üî¥ Critical | Enable expiration, use PAM solution |\n| **Non-Expiring Password** | Service account | üü† Medium | Document exception, use gMSA if possible |\n| **Computer Account** | No logon > 90 days | üü† Medium | Verify if system is powered off or retired |\n| **Computer Account** | No logon > 180 days | üî¥ High | Disable and move to Stale OU |\n| **Computer Account** | Password age > 60 days | üî¥ High | May indicate offline/disconnected system |\n| **Legacy OS** | Windows 7/2008 or older | üî¥ Critical | Upgrade, isolate, or decommission |\n\n### üîß PowerShell Commands for Remediation\n\n```powershell\n# Find inactive users (90+ days)\nSearch-ADAccount -AccountInactive -TimeSpan 90.00:00:00 -UsersOnly | Select Name, LastLogonDate, Enabled\n\n# Find users with passwords older than 180 days\nGet-ADUser -Filter * -Properties PasswordLastSet | Where-Object { $_.PasswordLastSet -lt (Get-Date).AddDays(-180) }\n\n# Find users with non-expiring passwords\nGet-ADUser -Filter {PasswordNeverExpires -eq $true} -Properties PasswordNeverExpires | Select Name, Enabled\n\n# Find inactive computers (90+ days)\nSearch-ADAccount -AccountInactive -TimeSpan 90.00:00:00 -ComputersOnly | Select Name, LastLogonDate\n\n# Disable stale user account\nDisable-ADAccount -Identity \"username\"\n\n# Move stale object to Stale OU\nMove-ADObject -Identity \"CN=username,OU=Users,DC=domain,DC=com\" -TargetPath \"OU=Stale,DC=domain,DC=com\"\n```\n\n### üìä Recommended Policies\n\n| Policy | Setting | Frequency |\n|--------|---------|-----------|\n| **User Inactivity Review** | Disable after 90 days | Monthly |\n| **Password Maximum Age** | 90-180 days (per NIST guidance) | Continuous |\n| **Non-Expiring Password Exceptions** | Document and review | Quarterly |\n| **Computer Account Cleanup** | Remove after 180 days inactive | Monthly |\n| **Legacy OS Inventory** | Track and plan migration | Quarterly |"
            },
            "name": "StaleAccountGuidance"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "staleaccounts"
      },
      "name": "StaleAccountsGroup"
    },
    {
      "type": 1,
      "content": {
        "json": "---\n\n### üìã Active Directory Security Best Practices\n\n**üî¥ Critical Monitoring:**\n1. Monitor privileged account usage (Domain Admins, Enterprise Admins)\n2. Alert on security group membership changes\n3. Detect brute force and password spray attacks\n4. Watch for Kerberoasting and Golden Ticket attacks\n5. Track after-hours administrative activity\n\n**üü° Key Event IDs to Monitor:**\n| Event ID | Description | Priority |\n|----------|-------------|----------|\n| 4624 | Successful Logon | Medium |\n| 4625 | Failed Logon | High |\n| 4648 | Explicit Credentials | High |\n| 4672 | Special Privileges Assigned | High |\n| 4720 | User Account Created | Medium |\n| 4728/4732 | Group Membership Changed | High |\n| 4740 | Account Locked Out | Medium |\n| 4768/4769 | Kerberos TGT/TGS | Medium |\n| 4771 | Kerberos Pre-Auth Failed | High |\n| 5136 | Directory Object Modified | Medium |\n\n**üìä Data Source:** SecurityEvent\n\n**References:**\n- [Windows Security Auditing](https://docs.microsoft.com/windows/security/threat-protection/auditing/)\n- [Detecting Credential Attacks](https://docs.microsoft.com/defender-for-identity/)"
      },
      "name": "BestPractices"
    }
  ],
  "fallbackResourceIds": [
    "Azure Monitor"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
