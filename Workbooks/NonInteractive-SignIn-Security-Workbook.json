{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "## üîÑ Entra ID Non-Interactive Sign-In Security Workbook\n---\n\nComprehensive monitoring and analysis of Azure AD Non-Interactive User Sign-In activity. Non-interactive sign-ins occur when apps refresh tokens or perform background authentication on behalf of users without direct user interaction.\n\n**Use Cases:**\n- üîç Monitor background token refresh patterns\n- üì± Analyze app-to-resource access patterns\n- üåç Detect geographic anomalies in automated authentications\n- üö® Identify suspicious IPs and potential token theft\n- üìä Track application usage and health\n\n**Data Source:** AADNonInteractiveUserSignInLogs\n\n‚ö†Ô∏è **Security Note:** Non-interactive sign-ins can indicate token replay attacks, compromised refresh tokens, or malicious apps operating on behalf of users."
      },
      "name": "WorkbookHeader"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "label": "Time Range",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 604800000
            },
            "typeSettings": {
              "selectableValues": [
                { "durationMs": 3600000 },
                { "durationMs": 14400000 },
                { "durationMs": 43200000 },
                { "durationMs": 86400000 },
                { "durationMs": 604800000 },
                { "durationMs": 2592000000 }
              ],
              "allowCustom": true
            }
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "Parameters"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "tab-executive",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üìà Executive Summary",
            "subTarget": "executive",
            "style": "link"
          },
          {
            "id": "tab-overview",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üìä Overview",
            "subTarget": "overview",
            "style": "link"
          },
          {
            "id": "tab-apps",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üì± Application Analysis",
            "subTarget": "apps",
            "style": "link"
          },
          {
            "id": "tab-users",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üë§ User Analysis",
            "subTarget": "users",
            "style": "link"
          },
          {
            "id": "tab-geo",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üó∫Ô∏è Geolocation",
            "subTarget": "geo",
            "style": "link"
          },
          {
            "id": "tab-security",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üö® Security & Threats",
            "subTarget": "security",
            "style": "link"
          },
          {
            "id": "tab-failures",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "‚ùå Failure Analysis",
            "subTarget": "failures",
            "style": "link"
          },
          {
            "id": "tab-botnet",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üï∏Ô∏è Botnet Detection",
            "subTarget": "botnet",
            "style": "link"
          },
          {
            "id": "tab-remediation",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üõ†Ô∏è Remediation",
            "subTarget": "remediation",
            "style": "link"
          },
          {
            "id": "tab-forensics",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üîç Forensic Investigation",
            "subTarget": "forensics",
            "style": "link"
          },
          {
            "id": "tab-aiagents",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "ü§ñ AI Agents",
            "subTarget": "aiagents",
            "style": "link"
          }
        ]
      },
      "name": "TabNavigation"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## ÔøΩ Executive Summary - Non-Interactive Sign-In Security\n---\n### For CISOs, CIOs, and Security Leadership\n\nReal-time visibility into **non-interactive authentication security posture**. Non-interactive sign-ins represent token refresh operations and background app authentications that occur without user interaction - making them critical indicators of token-based attacks.\n\n| üî¥ Critical | üü† High | üü° Medium | üü¢ Low |\n|---|---|---|---|\n| Token theft suspected | Anomalous patterns | Review within 7d | Monitor |\n\n---"
            },
            "name": "ExecutiveHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Overall Security Score (0-100)\nlet SignInHealth = AADNonInteractiveUserSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | summarize Total = count(), Failed = countif(ResultType != '0'), UniqueUsers = dcount(UserPrincipalName)\n    | extend FailRate = iff(Total == 0, 0.0, round(todouble(Failed) / todouble(Total) * 100.0, 1))\n    | extend SignInScore = max_of(0.0, 100.0 - FailRate - iff(Failed > 1000, 20.0, 0.0));\nlet GeoAnomalies = AADNonInteractiveUserSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | extend LocationData = parse_json(LocationDetails)\n    | extend Country = tostring(LocationData.countryOrRegion)\n    | where Country != ''\n    | summarize Countries = dcount(Country) by UserPrincipalName\n    | where Countries >= 3\n    | summarize AnomalyCount = count()\n    | extend GeoScore = max_of(0.0, 100.0 - iff(AnomalyCount > 10, 30.0, iff(AnomalyCount > 5, 15.0, 0.0)));\nlet TokenHealth = AADNonInteractiveUserSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | summarize TokensPerUser = count() by UserPrincipalName\n    | where TokensPerUser > 1000\n    | summarize HighVolumeUsers = count()\n    | extend TokenScore = max_of(0.0, 100.0 - iff(HighVolumeUsers > 20, 25.0, iff(HighVolumeUsers > 5, 10.0, 0.0)));\nSignInHealth | extend placeholder = 1\n| join kind=leftouter (GeoAnomalies | extend placeholder = 1) on placeholder\n| join kind=leftouter (TokenHealth | extend placeholder = 1) on placeholder\n| extend OverallScore = round((coalesce(SignInScore, 100.0) + coalesce(GeoScore, 100.0) + coalesce(TokenScore, 100.0)) / 3.0, 0)\n| extend ScoreStatus = case(\n    OverallScore >= 90.0, 'üü¢ Excellent',\n    OverallScore >= 75.0, 'üü° Good',\n    OverallScore >= 60.0, 'üü† Needs Attention',\n    'üî¥ Critical'\n)\n| project Metric = 'Security Score', Value = OverallScore, Status = ScoreStatus",
              "size": 4,
              "title": "üèÜ Non-Interactive Security Score",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "greenRed", "min": 0, "max": 100 }, "numberFormat": { "unit": 0, "options": { "style": "decimal" } } },
                "secondaryContent": { "columnMatch": "Status", "formatter": 1 }
              }
            },
            "customWidth": "25",
            "name": "SecurityScore"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Active Threats (24h)\nlet TokenTheft = AADNonInteractiveUserSignInLogs\n    | where TimeGenerated >= ago(24h)\n    | extend LocationData = parse_json(LocationDetails)\n    | extend Country = tostring(LocationData.countryOrRegion)\n    | where Country != ''\n    | summarize Countries = dcount(Country), IPs = dcount(IPAddress) by UserPrincipalName\n    | where Countries >= 3 or IPs >= 10\n    | summarize Count = count();\nlet HighFailureApps = AADNonInteractiveUserSignInLogs\n    | where TimeGenerated >= ago(24h)\n    | summarize Total = count(), Failed = countif(ResultType != '0') by AppDisplayName\n    | where Total > 0 and todouble(Failed) / todouble(Total) > 0.5 and Failed > 50\n    | summarize Count = count();\nlet SuspiciousIPs = AADNonInteractiveUserSignInLogs\n    | where TimeGenerated >= ago(24h)\n    | where ResultType != '0'\n    | summarize FailedAttempts = count(), UniqueUsers = dcount(UserPrincipalName) by IPAddress\n    | where FailedAttempts > 100 or UniqueUsers > 10\n    | summarize Count = count();\nunion\n    (TokenTheft | extend ThreatType = 'Token Theft'),\n    (HighFailureApps | extend ThreatType = 'App Failures'),\n    (SuspiciousIPs | extend ThreatType = 'Suspicious IPs')\n| summarize TotalThreats = sum(Count)\n| extend Severity = case(TotalThreats >= 10, 'üî¥ Critical', TotalThreats >= 3, 'üü† High', TotalThreats > 0, 'üü° Medium', 'üü¢ None')\n| project Metric = 'Active Threats', Value = TotalThreats, Status = Severity",
              "size": 4,
              "title": "üö® Active Threats (24h)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "redGreen", "min": 0 }, "numberFormat": { "unit": 0, "options": { "style": "decimal" } } },
                "secondaryContent": { "columnMatch": "Status", "formatter": 1 }
              }
            },
            "customWidth": "25",
            "name": "ActiveThreats"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Monitored Users and Apps\nlet Users = AADNonInteractiveUserSignInLogs | where TimeGenerated >= ago(7d) | summarize by UserPrincipalName | count | project Count;\nlet Apps = AADNonInteractiveUserSignInLogs | where TimeGenerated >= ago(7d) | summarize by AppDisplayName | count | project Count;\nunion Users, Apps\n| summarize TotalMonitored = sum(Count)\n| project Metric = 'Users + Apps', Value = TotalMonitored, Status = 'üìä'",
              "size": 4,
              "title": "ü§ñ Monitored Entities",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "blue" }, "numberFormat": { "unit": 0, "options": { "style": "decimal" } } },
                "secondaryContent": { "columnMatch": "Status", "formatter": 1 }
              }
            },
            "customWidth": "25",
            "name": "MonitoredEntities"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Week-over-Week Failure Change\nlet ThisWeek = AADNonInteractiveUserSignInLogs | where TimeGenerated >= ago(7d) | summarize TW = countif(ResultType != '0');\nlet LastWeek = AADNonInteractiveUserSignInLogs | where TimeGenerated between (ago(14d) .. ago(7d)) | summarize LW = countif(ResultType != '0');\nThisWeek | extend p = 1 | join kind=leftouter (LastWeek | extend p = 1) on p\n| extend LW = coalesce(LW, 1)\n| extend Change = round((todouble(TW) - todouble(LW)) / todouble(LW) * 100.0, 0)\n| extend Status = case(Change > 50.0, strcat('üî¥ +', tostring(toint(Change)), '%'), Change > 10.0, strcat('üü† +', tostring(toint(Change)), '%'), Change < -10.0, strcat('üü¢ ', tostring(toint(Change)), '%'), '‚û°Ô∏è Stable')\n| project Metric = 'WoW Failures', Value = TW, Status",
              "size": 4,
              "title": "üìÖ Week Trend",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": { "columnMatch": "Metric", "formatter": 1 },
                "leftContent": { "columnMatch": "Value", "formatter": 12, "formatOptions": { "palette": "blue" }, "numberFormat": { "unit": 0, "options": { "style": "decimal" } } },
                "secondaryContent": { "columnMatch": "Status", "formatter": 1 }
              }
            },
            "customWidth": "25",
            "name": "WeekTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Detailed KPIs\nlet SignInMetrics = AADNonInteractiveUserSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | summarize \n        TotalSignIns = count(), \n        FailedSignIns = countif(ResultType != '0'), \n        UniqueUsers = dcount(UserPrincipalName),\n        UniqueApps = dcount(AppDisplayName),\n        ExternalIPs = dcountif(IPAddress, not(ipv4_is_private(IPAddress)) and IPAddress != '');\nSignInMetrics\n| extend FailureRate = iff(TotalSignIns == 0, 0.0, round(todouble(FailedSignIns) / todouble(TotalSignIns) * 100.0, 1))\n| project \n    TotalVolume = TotalSignIns,\n    FailedCount = FailedSignIns,\n    FailureRate = FailureRate,\n    FailStatus = case(FailureRate > 10.0, 'üî¥', FailureRate > 5.0, 'üü°', 'üü¢'),\n    UniqueUsers = UniqueUsers,\n    UniqueApps = UniqueApps,\n    ExternalIPs = ExternalIPs,\n    IPStatus = case(ExternalIPs > 1000, 'üü°', 'üü¢')",
              "size": 0,
              "title": "üìä Key Performance Indicators (7-Day Summary)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "FailureRate", "formatter": 4, "formatOptions": { "palette": "redGreen", "min": 0, "max": 20 } }
                ]
              }
            },
            "name": "DetailedKPIs"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Critical Findings\nlet Finding1_TokenTheft = AADNonInteractiveUserSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | extend LocationData = parse_json(LocationDetails)\n    | extend Country = tostring(LocationData.countryOrRegion)\n    | where Country != ''\n    | summarize Countries = make_set(Country, 5), CountryCount = dcount(Country), IPs = dcount(IPAddress) by UserPrincipalName\n    | where CountryCount >= 3\n    | top 3 by CountryCount\n    | extend Priority = 1, Category = 'üî¥ Potential Token Theft', Finding = strcat(UserPrincipalName, ' - tokens from ', CountryCount, ' countries: ', tostring(Countries)), Impact = 'Stolen refresh token', Action = 'Revoke sessions';\nlet Finding2_HighFailApps = AADNonInteractiveUserSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | summarize Total = count(), Failed = countif(ResultType != '0') by AppDisplayName\n    | where Total > 100 and todouble(Failed) / todouble(Total) > 0.3\n    | top 2 by Failed\n    | extend Priority = 2, Category = 'üü† App Misconfiguration', UserPrincipalName = AppDisplayName, Finding = strcat(AppDisplayName, ' - ', Failed, ' failures (', round(todouble(Failed)/todouble(Total)*100.0,0), '% rate)'), Impact = 'Token refresh failures', Action = 'Review app config';\nlet Finding3_SuspiciousIPs = AADNonInteractiveUserSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | summarize Users = dcount(UserPrincipalName), FailedEvents = countif(ResultType != '0') by IPAddress\n    | where Users > 5 and FailedEvents > 50\n    | top 2 by Users\n    | extend Priority = 3, Category = 'üü† Suspicious IP', UserPrincipalName = IPAddress, Finding = strcat('IP ', IPAddress, ' - ', Users, ' users, ', FailedEvents, ' failures'), Impact = 'Credential stuffing', Action = 'Block IP';\nunion Finding1_TokenTheft, Finding2_HighFailApps, Finding3_SuspiciousIPs\n| project Priority, Category, Finding, Impact, Action\n| order by Priority asc\n| take 10",
              "size": 0,
              "title": "üö® Top Critical Findings Requiring Executive Attention",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "Priority", "formatter": 18, "formatOptions": { "thresholdsOptions": "icons", "thresholdsGrid": [{ "operator": "==", "thresholdValue": "1", "representation": "Sev0", "text": "" }, { "operator": "==", "thresholdValue": "2", "representation": "Sev1", "text": "" }, { "operator": "==", "thresholdValue": "3", "representation": "Sev2", "text": "" }, { "operator": "Default", "representation": "Sev3", "text": "" }] } }
                ]
              }
            },
            "name": "CriticalFindings"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// 30-Day Failure Rate Trend\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated >= ago(30d)\n| summarize Total = count(), Failed = countif(ResultType != '0') by bin(TimeGenerated, 1d)\n| extend FailureRate = iff(Total == 0, 0.0, round(todouble(Failed) / todouble(Total) * 100.0, 1))\n| project TimeGenerated, FailureRate\n| render timechart",
              "size": 0,
              "title": "üìà Failure Rate Trend (30 Days) - Lower is Better",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart",
              "chartSettings": {
                "ySettings": { "min": 0, "max": 20 }
              }
            },
            "customWidth": "60",
            "name": "FailureTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// User Risk Distribution\nlet HighRisk = AADNonInteractiveUserSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | extend LocationData = parse_json(LocationDetails)\n    | extend Country = tostring(LocationData.countryOrRegion)\n    | summarize Countries = dcount(Country), IPs = dcount(IPAddress), Failed = countif(ResultType != '0') by UserPrincipalName\n    | where Countries >= 3 or IPs >= 10 or Failed > 100\n    | count | project Category = 'üî¥ High Risk', Count;\nlet MediumRisk = AADNonInteractiveUserSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | summarize Failed = countif(ResultType != '0'), Total = count() by UserPrincipalName\n    | where Total > 0 and todouble(Failed) / todouble(Total) between (0.1 .. 0.5) and Failed > 10\n    | count | project Category = 'üü† Medium Risk', Count;\nlet LowRisk = AADNonInteractiveUserSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | summarize Failed = countif(ResultType != '0'), Total = count() by UserPrincipalName\n    | where Total > 0 and (todouble(Failed) / todouble(Total) < 0.1 or Failed <= 10)\n    | count | project Category = 'üü¢ Low Risk', Count;\nunion HighRisk, MediumRisk, LowRisk",
              "size": 2,
              "title": "‚ö†Ô∏è User Risk Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  { "seriesName": "üî¥ High Risk", "color": "redBright" },
                  { "seriesName": "üü† Medium Risk", "color": "orange" },
                  { "seriesName": "üü¢ Low Risk", "color": "green" }
                ]
              }
            },
            "customWidth": "40",
            "name": "RiskDistribution"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top 10 High Risk IPs by Threat Score\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated >= ago(7d)\n| extend Country = tostring(parse_json(LocationDetails).countryOrRegion)\n| summarize \n    TotalAttempts = count(),\n    FailedAttempts = countif(ResultType != '0'),\n    SuccessfulAttempts = countif(ResultType == '0'),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueApps = dcount(AppDisplayName),\n    Countries = make_set(Country, 3),\n    LastSeen = max(TimeGenerated)\n    by IPAddress\n| where IPAddress != ''\n| extend FailureRate = round(todouble(FailedAttempts) / TotalAttempts * 100, 1)\n| extend ThreatScore = (FailedAttempts / 10) + (UniqueUsers * 5) + iif(SuccessfulAttempts > 0 and FailedAttempts > 10, 50, 0)\n| extend ThreatLevel = case(\n    SuccessfulAttempts > 0 and FailedAttempts > 10, 'üî¥ CRITICAL',\n    UniqueUsers > 10, 'üî¥ HIGH',\n    FailedAttempts > 100, 'üü† MEDIUM',\n    'üü° LOW'\n)\n| project ThreatLevel, IPAddress, ThreatScore, FailedAttempts, SuccessfulAttempts, UniqueUsers, UniqueApps, FailureRate, Countries, LastSeen\n| order by ThreatScore desc\n| take 10",
              "size": 0,
              "title": "üî¥ Top 10 High Risk IPs",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "ThreatLevel",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {"operator": "contains", "thresholdValue": "CRITICAL", "representation": "red", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "HIGH", "representation": "redBright", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "MEDIUM", "representation": "orange", "text": "{0}"},
                        {"operator": "Default", "representation": "yellow", "text": "{0}"}
                      ]
                    }
                  },
                  {
                    "columnMatch": "ThreatScore",
                    "formatter": 4,
                    "formatOptions": {"palette": "redGreen", "min": 0, "max": 200}
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "Top10HighRiskIPs"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top 10 Apps at Risk by Failure Rate\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated >= ago(7d)\n| summarize \n    TotalEvents = count(),\n    FailedEvents = countif(ResultType != '0'),\n    SuccessfulEvents = countif(ResultType == '0'),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueIPs = dcount(IPAddress),\n    ErrorCodes = make_set(ResultType, 5),\n    LastSeen = max(TimeGenerated)\n    by AppDisplayName, AppId\n| where TotalEvents > 50\n| extend FailureRate = round(todouble(FailedEvents) / TotalEvents * 100, 1)\n| extend RiskScore = (FailedEvents / 10) + iif(FailureRate > 50, 50, 0) + iif(UniqueUsers > 100 and FailureRate > 20, 30, 0)\n| extend RiskLevel = case(\n    FailureRate > 50 and FailedEvents > 100, 'üî¥ CRITICAL',\n    FailureRate > 30, 'üî¥ HIGH',\n    FailureRate > 15, 'üü† MEDIUM',\n    'üü° LOW'\n)\n| project RiskLevel, AppDisplayName, RiskScore, FailureRate, FailedEvents, TotalEvents, UniqueUsers, UniqueIPs, ErrorCodes, LastSeen\n| order by RiskScore desc\n| take 10",
              "size": 0,
              "title": "üì± Top 10 Apps at Risk",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "RiskLevel",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {"operator": "contains", "thresholdValue": "CRITICAL", "representation": "red", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "HIGH", "representation": "redBright", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "MEDIUM", "representation": "orange", "text": "{0}"},
                        {"operator": "Default", "representation": "yellow", "text": "{0}"}
                      ]
                    }
                  },
                  {
                    "columnMatch": "FailureRate",
                    "formatter": 4,
                    "formatOptions": {"palette": "redGreen", "min": 0, "max": 100}
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "Top10AppsAtRisk"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üìã Executive Action Items\n\n| Priority | Area | Issue | Recommended Action | Owner | SLA |\n|:--------:|------|-------|-------------------|-------|-----|\n| üî¥ **P1** | **Token Theft** | Users with tokens from multiple countries | Revoke all sessions, investigate | Security Ops | **4 hours** |\n| üî¥ **P1** | **Suspicious IPs** | IPs targeting multiple users | Block IP, correlate with SIEM | SOC | **4 hours** |\n| üü† **P2** | **App Failures** | High-failure apps indicate misconfiguration | Review app settings, rotate secrets | App Team | **24 hours** |\n| üü† **P2** | **Unusual Volume** | Abnormal token refresh patterns | Investigate for automation abuse | Identity Team | **24 hours** |\n| üü° **P3** | **Token Hygiene** | Long-lived refresh tokens | Implement token lifetime policies | IAM Team | **7 days** |\n\n---\n\n### üéØ Strategic Recommendations\n\n| Initiative | Business Impact | Effort | Timeline |\n|------------|----------------|--------|----------|\n| **Continuous Access Evaluation** | Real-time token revocation | Low | 1 month |\n| **Token Lifetime Policies** | Reduce token theft window | Low | 2 weeks |\n| **Conditional Access for Apps** | App-specific access controls | Medium | 2-3 months |\n| **Sign-in Risk Policies** | Block risky non-interactive sign-ins | Medium | 1-2 months |"
            },
            "name": "ExecutiveRecommendations"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "executive"
      },
      "name": "ExecutiveGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## ÔøΩüìä Non-Interactive Sign-In Overview\n---\nKey metrics and trends for non-interactive authentication activity."
            },
            "name": "OverviewHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| summarize TotalSignIns = count()\n| extend Label = \"Total Sign-Ins\"",
              "size": 4,
              "title": "Total Non-Interactive Sign-Ins",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "Label" },
                "leftContent": { "columnMatch": "TotalSignIns", "formatter": 12, "numberFormat": { "unit": 17, "options": { "style": "decimal", "maximumFractionDigits": 0 } } },
                "showBorder": true
              }
            },
            "customWidth": "20",
            "name": "TileTotalSignIns"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\"\n| summarize SuccessCount = count()\n| extend Label = \"Successful\"",
              "size": 4,
              "title": "Successful Sign-Ins",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "Label" },
                "leftContent": { "columnMatch": "SuccessCount", "formatter": 12, "numberFormat": { "unit": 17, "options": { "style": "decimal", "maximumFractionDigits": 0 } } },
                "showBorder": true
              }
            },
            "customWidth": "20",
            "name": "TileSuccess"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType != \"0\"\n| summarize FailedCount = count()\n| extend Label = \"Failed\"",
              "size": 4,
              "title": "Failed Sign-Ins",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "Label" },
                "leftContent": { "columnMatch": "FailedCount", "formatter": 12, "numberFormat": { "unit": 17, "options": { "style": "decimal", "maximumFractionDigits": 0 } } },
                "showBorder": true
              }
            },
            "customWidth": "20",
            "name": "TileFailed"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| summarize UniqueUsers = dcount(UserPrincipalName)\n| extend Label = \"Unique Users\"",
              "size": 4,
              "title": "Unique Users",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "Label" },
                "leftContent": { "columnMatch": "UniqueUsers", "formatter": 12, "numberFormat": { "unit": 17, "options": { "style": "decimal", "maximumFractionDigits": 0 } } },
                "showBorder": true
              }
            },
            "customWidth": "20",
            "name": "TileUniqueUsers"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| summarize UniqueApps = dcount(AppDisplayName)\n| extend Label = \"Unique Apps\"",
              "size": 4,
              "title": "Unique Applications",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "Label" },
                "leftContent": { "columnMatch": "UniqueApps", "formatter": 12, "numberFormat": { "unit": 17, "options": { "style": "decimal", "maximumFractionDigits": 0 } } },
                "showBorder": true
              }
            },
            "customWidth": "20",
            "name": "TileUniqueApps"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìà 7-Day Baseline Comparison\n\nCompare current non-interactive sign-in activity against the previous 7-day baseline to identify anomalies and deviations."
            },
            "name": "BaselineHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// 7-Day Baseline Deviation Analysis\nlet CurrentCount = toscalar(AADNonInteractiveUserSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | summarize count());\nlet PreviousCount = toscalar(AADNonInteractiveUserSignInLogs\n    | where TimeGenerated between (ago(14d) .. ago(7d))\n    | summarize count());\nlet CurrentSuccess = toscalar(AADNonInteractiveUserSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | where ResultType == '0'\n    | summarize count());\nlet PreviousSuccess = toscalar(AADNonInteractiveUserSignInLogs\n    | where TimeGenerated between (ago(14d) .. ago(7d))\n    | where ResultType == '0'\n    | summarize count());\nlet CurrentFailed = toscalar(AADNonInteractiveUserSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | where ResultType != '0'\n    | summarize count());\nlet PreviousFailed = toscalar(AADNonInteractiveUserSignInLogs\n    | where TimeGenerated between (ago(14d) .. ago(7d))\n    | where ResultType != '0'\n    | summarize count());\nlet TotalDeviation = round((todouble(CurrentCount - PreviousCount) / PreviousCount) * 100, 2);\nlet FailedDeviation = round((todouble(CurrentFailed - PreviousFailed) / PreviousFailed) * 100, 2);\nprint \n    CurrentWeekTotal = CurrentCount,\n    BaselineWeekTotal = PreviousCount,\n    TotalDeviationPct = TotalDeviation,\n    CurrentWeekFailed = CurrentFailed,\n    BaselineWeekFailed = PreviousFailed,\n    FailedDeviationPct = FailedDeviation\n| extend TotalStatus = case(\n    TotalDeviation > 50, 'Critical Spike',\n    TotalDeviation > 20, 'Significant Increase',\n    TotalDeviation < -20, 'Significant Decrease',\n    'Within Normal Range'\n)\n| extend FailedStatus = case(\n    FailedDeviation > 100, 'Attack Detected',\n    FailedDeviation > 50, 'Elevated Failures',\n    FailedDeviation < -20, 'Improved Security',\n    'Normal')",
              "size": 4,
              "title": "üìä 7-Day Baseline Deviation",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "TotalStatus", "formatter": 1 },
                "leftContent": { "columnMatch": "TotalDeviationPct", "formatter": 12, "formatOptions": { "palette": "greenRed" }, "numberFormat": { "unit": 1, "options": { "style": "decimal", "maximumFractionDigits": 2 } } },
                "secondaryContent": { "columnMatch": "FailedStatus", "formatter": 1 },
                "showBorder": true
              }
            },
            "customWidth": "50",
            "name": "BaselineDeviationTile"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// 7-Day Baseline Trend Comparison\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated >= ago(14d)\n| extend Period = iff(TimeGenerated >= ago(7d), 'Current Week', 'Baseline Week')\n| extend DayOffset = iff(TimeGenerated >= ago(7d), datetime_diff('day', now(), TimeGenerated), datetime_diff('day', ago(7d), TimeGenerated))\n| summarize EventCount = count() by Period, DayOffset\n| extend Day = 7 - DayOffset\n| project Day, EventCount, Period\n| order by Period, Day asc",
              "size": 0,
              "title": "üìà Current vs Baseline Activity (7-Day Comparison)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "linechart",
              "chartSettings": {
                "xAxis": "Day",
                "yAxis": ["EventCount"],
                "group": "Period",
                "createOtherGroup": false
              }
            },
            "customWidth": "50",
            "name": "BaselineTrendChart"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Non-Interactive Sign-In Timeline\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| extend Status = case(ResultType == \"0\", \"Success\", \"Failed\")\n| summarize Count = count() by bin(TimeGenerated, 1h), Status\n| render timechart",
              "size": 0,
              "title": "üìà Non-Interactive Sign-In Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "name": "SignInTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Success vs Failure Distribution\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| extend Status = case(ResultType == \"0\", \"Success\", \"Failed\")\n| summarize Count = count() by Status",
              "size": 2,
              "title": "Success vs Failure",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "SuccessFailurePie"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Resources Accessed\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\"\n| summarize Count = count() by ResourceDisplayName\n| top 10 by Count",
              "size": 2,
              "title": "Top 10 Resources Accessed",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "TopResources"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Client App Types\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| extend ClientApp = coalesce(ClientAppUsed, \"Unknown\")\n| summarize Count = count() by ClientApp\n| top 10 by Count",
              "size": 2,
              "title": "Client App Types",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "34",
            "name": "ClientAppTypes"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Hourly Activity Heatmap\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| extend Hour = datetime_part(\"Hour\", TimeGenerated)\n| extend DayOfWeek = dayofweek(TimeGenerated) / 1d\n| extend DayName = case(\n    DayOfWeek == 0, \"Sunday\",\n    DayOfWeek == 1, \"Monday\",\n    DayOfWeek == 2, \"Tuesday\",\n    DayOfWeek == 3, \"Wednesday\",\n    DayOfWeek == 4, \"Thursday\",\n    DayOfWeek == 5, \"Friday\",\n    \"Saturday\"\n)\n| summarize SignIns = count() by DayName, Hour\n| order by Hour asc",
              "size": 0,
              "title": "üìÖ Activity Heatmap by Day/Hour",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "ActivityHeatmap"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "overview"
      },
      "name": "OverviewGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üì± Application Analysis\n---\nAnalyze which applications are generating non-interactive sign-ins and their patterns."
            },
            "name": "AppsHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Applications by Sign-In Volume\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| summarize \n    TotalSignIns = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueIPs = dcount(IPAddress),\n    Resources = make_set(ResourceDisplayName, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by AppDisplayName, AppId\n| extend FailureRate = round(todouble(FailedCount) / TotalSignIns * 100, 2)\n| extend HealthStatus = case(\n    FailureRate > 50, \"üî¥ Unhealthy\",\n    FailureRate > 20, \"üü† Degraded\",\n    \"üü¢ Healthy\"\n)\n| order by TotalSignIns desc",
              "size": 0,
              "title": "üì± Top Applications by Sign-In Volume",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "TopApps"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// App Sign-In Distribution\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| summarize Count = count() by AppDisplayName\n| top 15 by Count",
              "size": 2,
              "title": "Application Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "AppDistribution"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// App Resource Access Patterns\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\"\n| summarize Count = count() by AppDisplayName, ResourceDisplayName\n| top 20 by Count\n| project App = AppDisplayName, Resource = ResourceDisplayName, AccessCount = Count",
              "size": 0,
              "title": "App to Resource Access Matrix",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "AppResourceMatrix"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// App Activity Timeline\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName in (\n    AADNonInteractiveUserSignInLogs\n    | where TimeGenerated {TimeRange}\n    | summarize Count = count() by AppDisplayName\n    | top 5 by Count\n    | project AppDisplayName\n)\n| summarize Count = count() by bin(TimeGenerated, 1h), AppDisplayName\n| render timechart",
              "size": 0,
              "title": "üìà Top 5 Apps Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "name": "AppTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Apps with High Failure Rates\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| summarize \n    TotalSignIns = count(),\n    FailedCount = countif(ResultType != \"0\"),\n    UniqueUsers = dcount(UserPrincipalName),\n    ErrorCodes = make_set(ResultType, 10)\n    by AppDisplayName, AppId\n| where TotalSignIns > 10\n| extend FailureRate = round(todouble(FailedCount) / TotalSignIns * 100, 2)\n| where FailureRate > 10\n| extend HealthStatus = case(\n    FailureRate > 75, \"üî¥ Critical\",\n    FailureRate > 50, \"üü† Poor\",\n    FailureRate > 25, \"üü° Fair\",\n    \"üü¢ Good\"\n)\n| order by FailureRate desc",
              "size": 0,
              "title": "‚ö†Ô∏è Apps with High Failure Rates",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "AppsHighFailure"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// First-Party vs Third-Party Apps\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| extend AppType = case(\n    AppId in (\n        \"00000002-0000-0000-c000-000000000000\", // Azure AD Graph\n        \"00000003-0000-0000-c000-000000000000\", // Microsoft Graph\n        \"00000001-0000-0000-c000-000000000000\", // Azure AD\n        \"00000002-0000-0ff1-ce00-000000000000\", // Office 365 Exchange\n        \"00000003-0000-0ff1-ce00-000000000000\", // Office 365 SharePoint\n        \"00000006-0000-0ff1-ce00-000000000000\", // Office 365 Portal\n        \"d3590ed6-52b3-4102-aeff-aad2292ab01c\", // Microsoft Office\n        \"1fec8e78-bce4-4aaf-ab1b-5451cc387264\", // Microsoft Teams\n        \"4765445b-32c6-49b0-83e6-1d93765276ca\"  // Microsoft Authenticator\n    ), \"Microsoft First-Party\",\n    \"Third-Party/Custom\"\n)\n| summarize \n    SignIns = count(),\n    UniqueApps = dcount(AppDisplayName),\n    Apps = make_set(AppDisplayName, 10)\n    by AppType",
              "size": 2,
              "title": "First-Party vs Third-Party Apps",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "FirstPartyVsThirdParty"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// New Apps (First Seen in Period)\nlet HistoricalApps = AADNonInteractiveUserSignInLogs\n| where TimeGenerated between (ago(90d) .. ago(7d))\n| distinct AppId;\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| join kind=leftanti (HistoricalApps) on AppId\n| summarize \n    SignIns = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    FirstSeen = min(TimeGenerated),\n    Resources = make_set(ResourceDisplayName, 5)\n    by AppDisplayName, AppId\n| extend Status = \"üÜï New App\"\n| order by SignIns desc",
              "size": 0,
              "title": "üÜï Newly Detected Apps",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "NewApps"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "apps"
      },
      "name": "AppsGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üë§ User Analysis\n---\nAnalyze user patterns in non-interactive sign-ins."
            },
            "name": "UsersHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Users by Non-Interactive Sign-Ins\nlet TrustedCountries = dynamic(['United States', 'Canada', 'United Kingdom', 'Germany', 'France', 'Netherlands', 'Australia']);\nlet TrustedIPRanges = dynamic(['10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16', '20.0.0.0/8', '40.0.0.0/8', '52.0.0.0/8', '104.0.0.0/8', '13.0.0.0/8']);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend IsTrustedIP = ipv4_is_private(IPAddress) or ipv4_is_in_any_range(IPAddress, TrustedIPRanges)\n| extend IsTrustedCountry = Country in (TrustedCountries)\n| extend TrustedLocation = case(\n    IsTrustedIP, 'Trusted IP',\n    IsTrustedCountry, 'Trusted Country',\n    'Untrusted'\n)\n| summarize \n    TotalSignIns = count(),\n    SuccessCount = countif(ResultType == '0'),\n    FailedCount = countif(ResultType != '0'),\n    UniqueApps = dcount(AppDisplayName),\n    Apps = make_set(AppDisplayName, 5),\n    UniqueIPs = dcount(IPAddress),\n    UniqueLocations = dcount(Location),\n    Locations = make_set(Location, 5),\n    TrustedSignIns = countif(TrustedLocation != 'Untrusted'),\n    UntrustedSignIns = countif(TrustedLocation == 'Untrusted'),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by UserPrincipalName, UserId\n| extend FailureRate = round(todouble(FailedCount) / TotalSignIns * 100, 2)\n| extend TrustedPct = round(todouble(TrustedSignIns) / TotalSignIns * 100, 2)\n| extend LocationRisk = case(\n    TrustedPct < 50, 'üî¥ High Risk - Mostly Untrusted',\n    TrustedPct < 80, 'üü† Medium Risk - Mixed Locations',\n    'üü¢ Low Risk - Mostly Trusted'\n)\n| order by TotalSignIns desc\n| take 50",
              "size": 0,
              "title": "üë§ Top Users by Sign-In Volume",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "TopUsers"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// User Sign-In Distribution\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| summarize Count = count() by UserPrincipalName\n| top 15 by Count",
              "size": 2,
              "title": "Top 15 Users Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "UserDistribution"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Users with Multiple Geographic Locations\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\"\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| where isnotempty(Country)\n| summarize \n    Countries = make_set(Country, 20),\n    CountryCount = dcount(Country),\n    SignIns = count(),\n    UniqueIPs = dcount(IPAddress)\n    by UserPrincipalName\n| where CountryCount > 1\n| extend RiskLevel = case(\n    CountryCount > 5, \"üî¥ High Risk\",\n    CountryCount > 3, \"üü† Medium Risk\",\n    \"üü° Review\"\n)\n| order by CountryCount desc",
              "size": 0,
              "title": "‚ö†Ô∏è Users with Multiple Countries",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "UsersMultipleCountries"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// User App Usage Patterns\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\"\n| summarize \n    AppCount = dcount(AppDisplayName),\n    Apps = make_set(AppDisplayName, 10),\n    SignIns = count()\n    by UserPrincipalName\n| where AppCount > 3\n| order by AppCount desc\n| take 30",
              "size": 0,
              "title": "Users Using Multiple Apps",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "UserMultipleApps"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Users with High Failure Rates\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| summarize \n    TotalSignIns = count(),\n    FailedCount = countif(ResultType != \"0\"),\n    ErrorCodes = make_set(ResultType, 5),\n    Apps = make_set(AppDisplayName, 5)\n    by UserPrincipalName\n| where TotalSignIns > 10\n| extend FailureRate = round(todouble(FailedCount) / TotalSignIns * 100, 2)\n| where FailureRate > 30\n| order by FailureRate desc",
              "size": 0,
              "title": "‚ö†Ô∏è Users with High Failure Rates",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "UsersHighFailure"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// User Activity Timeline (Top 5 Users)\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where UserPrincipalName in (\n    AADNonInteractiveUserSignInLogs\n    | where TimeGenerated {TimeRange}\n    | summarize Count = count() by UserPrincipalName\n    | top 5 by Count\n    | project UserPrincipalName\n)\n| summarize Count = count() by bin(TimeGenerated, 1h), UserPrincipalName\n| render timechart",
              "size": 0,
              "title": "üìà Top 5 Users Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "name": "UserTimeline"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "users"
      },
      "name": "UsersGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üó∫Ô∏è Geolocation Analysis\n---\nGeographic distribution and anomaly detection for non-interactive sign-ins."
            },
            "name": "GeoHeader"
          },
          {
            "type": 1,
            "content": {
              "json": "### üõ°Ô∏è Trusted Location Analysis\n\nAnalyze sign-ins from trusted vs untrusted locations. Trusted locations include private IP ranges, Azure datacenter IPs, and predefined trusted countries."
            },
            "name": "TrustedLocationHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Trusted vs Untrusted Location Distribution\nlet TrustedCountries = dynamic(['United States', 'Canada', 'United Kingdom', 'Germany', 'France', 'Netherlands', 'Australia']);\nlet TrustedIPRanges = dynamic(['10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16', '20.0.0.0/8', '40.0.0.0/8', '52.0.0.0/8', '104.0.0.0/8', '13.0.0.0/8']);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend IsTrustedIP = ipv4_is_private(IPAddress) or ipv4_is_in_any_range(IPAddress, TrustedIPRanges)\n| extend IsTrustedCountry = Country in (TrustedCountries)\n| extend TrustedLocation = case(\n    IsTrustedIP, 'Trusted IP Range',\n    IsTrustedCountry, 'Trusted Country',\n    'Untrusted Location'\n)\n| summarize Count = count() by TrustedLocation",
              "size": 2,
              "title": "üõ°Ô∏è Trusted vs Untrusted Location Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "TrustedLocationPie"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Trusted Location Trend Over Time\nlet TrustedCountries = dynamic(['United States', 'Canada', 'United Kingdom', 'Germany', 'France', 'Netherlands', 'Australia']);\nlet TrustedIPRanges = dynamic(['10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16', '20.0.0.0/8', '40.0.0.0/8', '52.0.0.0/8', '104.0.0.0/8', '13.0.0.0/8']);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend IsTrustedIP = ipv4_is_private(IPAddress) or ipv4_is_in_any_range(IPAddress, TrustedIPRanges)\n| extend IsTrustedCountry = Country in (TrustedCountries)\n| extend TrustedLocation = case(\n    IsTrustedIP or IsTrustedCountry, 'Trusted',\n    'Untrusted'\n)\n| summarize Count = count() by bin(TimeGenerated, 1h), TrustedLocation\n| render timechart",
              "size": 0,
              "title": "üìà Trusted vs Untrusted Location Trend",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "67",
            "name": "TrustedLocationTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Sign-Ins from Untrusted Locations - Detailed\nlet TrustedCountries = dynamic(['United States', 'Canada', 'United Kingdom', 'Germany', 'France', 'Netherlands', 'Australia']);\nlet TrustedIPRanges = dynamic(['10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16', '20.0.0.0/8', '40.0.0.0/8', '52.0.0.0/8', '104.0.0.0/8', '13.0.0.0/8']);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| extend IsTrustedIP = ipv4_is_private(IPAddress) or ipv4_is_in_any_range(IPAddress, TrustedIPRanges)\n| extend IsTrustedCountry = Country in (TrustedCountries)\n| where not(IsTrustedIP) and not(IsTrustedCountry)\n| summarize \n    SignIns = count(),\n    SuccessCount = countif(ResultType == '0'),\n    FailedCount = countif(ResultType != '0'),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 10),\n    UniqueIPs = dcount(IPAddress),\n    Apps = make_set(AppDisplayName, 5)\n    by Country, City\n| extend RiskLevel = case(\n    SuccessCount > 100, 'üî¥ Critical - High Success from Untrusted',\n    SuccessCount > 10, 'üü† High - Successful Access',\n    SuccessCount > 0, 'üü° Medium - Some Success',\n    'üü¢ Low - All Failed'\n)\n| order by SignIns desc\n| take 20",
              "size": 0,
              "title": "‚ö†Ô∏è Sign-Ins from Untrusted Locations",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "UntrustedLocationsTable"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Successful Sign-Ins Geolocation Map\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\"\n| where isnotempty(IPAddress) and IPAddress != \"127.0.0.1\" and IPAddress != \"::1\"\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Latitude = toreal(GeoInfo.latitude)\n| extend Longitude = toreal(GeoInfo.longitude)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| where isnotempty(Latitude) and isnotempty(Longitude)\n| summarize \n    SignIns = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueApps = dcount(AppDisplayName),\n    UniqueIPs = dcount(IPAddress)\n    by Longitude, Latitude, Country, City\n| extend LocationLabel = strcat(City, \", \", Country, \" - \", SignIns, \" sign-ins\")",
              "size": 0,
              "title": "üó∫Ô∏è Non-Interactive Sign-In Locations (Success)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "map",
              "mapSettings": {
                "locInfo": "LatLong",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "SignIns",
                "sizeAggregation": "Sum",
                "labelSettings": "LocationLabel",
                "legendMetric": "SignIns",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "SignIns",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "name": "GeoMapSuccess"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Failed Sign-Ins Geolocation Map\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType != \"0\"\n| where isnotempty(IPAddress) and IPAddress != \"127.0.0.1\" and IPAddress != \"::1\"\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Latitude = toreal(GeoInfo.latitude)\n| extend Longitude = toreal(GeoInfo.longitude)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| where isnotempty(Latitude) and isnotempty(Longitude)\n| summarize \n    FailedSignIns = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueIPs = dcount(IPAddress),\n    ErrorCodes = make_set(ResultType, 5)\n    by Longitude, Latitude, Country, City\n| extend LocationLabel = strcat(City, \", \", Country, \" - \", FailedSignIns, \" failures\")",
              "size": 0,
              "title": "üó∫Ô∏è Non-Interactive Sign-In Failures by Location",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "map",
              "mapSettings": {
                "locInfo": "LatLong",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "FailedSignIns",
                "sizeAggregation": "Sum",
                "labelSettings": "LocationLabel",
                "legendMetric": "FailedSignIns",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "FailedSignIns",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "yellowOrangeRed"
                }
              }
            },
            "name": "GeoMapFailed"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Sign-Ins by Country\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| where isnotempty(Country)\n| summarize \n    TotalSignIns = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueApps = dcount(AppDisplayName),\n    UniqueIPs = dcount(IPAddress)\n    by Country\n| extend FailureRate = round(todouble(FailedCount) / TotalSignIns * 100, 2)\n| order by TotalSignIns desc",
              "size": 0,
              "title": "Sign-Ins by Country",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "SignInsByCountry"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Country Distribution\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| where isnotempty(Country)\n| summarize Count = count() by Country\n| top 15 by Count",
              "size": 2,
              "title": "Top 15 Countries",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "CountryDistribution"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Sign-Ins from Unusual Countries (Not in Baseline)\nlet BaselineCountries = AADNonInteractiveUserSignInLogs\n| where TimeGenerated between (ago(60d) .. ago(7d))\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| where isnotempty(Country)\n| distinct Country;\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| where isnotempty(Country)\n| join kind=leftanti (BaselineCountries) on Country\n| summarize \n    SignIns = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 10),\n    UniqueIPs = dcount(IPAddress),\n    IPs = make_set(IPAddress, 10),\n    Cities = make_set(City, 5)\n    by Country\n| extend RiskLevel = \"üî¥ New Country\"\n| order by SignIns desc",
              "size": 0,
              "title": "‚ö†Ô∏è Sign-Ins from New Countries (Not in 60-Day Baseline)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "NewCountries"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Potential Impossible Travel\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\"\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| extend Lat = toreal(GeoInfo.latitude)\n| extend Lon = toreal(GeoInfo.longitude)\n| where isnotempty(Lat) and isnotempty(Lon)\n| order by UserPrincipalName, TimeGenerated asc\n| extend PrevTime = prev(TimeGenerated, 1)\n| extend PrevLat = prev(Lat, 1)\n| extend PrevLon = prev(Lon, 1)\n| extend PrevUser = prev(UserPrincipalName, 1)\n| extend PrevCountry = prev(Country, 1)\n| where UserPrincipalName == PrevUser\n| where Country != PrevCountry\n| extend TimeDiffMinutes = datetime_diff('minute', TimeGenerated, PrevTime)\n| extend DistanceKm = round(geo_distance_2points(Lon, Lat, PrevLon, PrevLat) / 1000, 0)\n| extend SpeedKmH = round(DistanceKm / (TimeDiffMinutes / 60.0), 0)\n| where SpeedKmH > 800 // Faster than commercial flight\n| where TimeDiffMinutes < 240 // Within 4 hours\n| project TimeGenerated, UserPrincipalName, FromCountry = PrevCountry, ToCountry = Country, TimeDiffMinutes, DistanceKm, SpeedKmH, AppDisplayName\n| order by SpeedKmH desc",
              "size": 0,
              "title": "üö® Potential Impossible Travel (Non-Interactive)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "ImpossibleTravel"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "geo"
      },
      "name": "GeoGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üö® Security & Threat Analysis\n---\nIdentify suspicious IPs, potential attacks, and security anomalies in non-interactive sign-ins."
            },
            "name": "SecurityHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Suspicious IPs (High Volume Failures)\nlet TrustedCountries = dynamic(['United States', 'Canada', 'United Kingdom', 'Germany', 'France', 'Netherlands', 'Australia']);\nlet TrustedIPRanges = dynamic(['10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16', '20.0.0.0/8', '40.0.0.0/8', '52.0.0.0/8', '104.0.0.0/8', '13.0.0.0/8']);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| summarize \n    TotalAttempts = count(),\n    FailedCount = countif(ResultType != '0'),\n    SuccessCount = countif(ResultType == '0'),\n    UniqueUsers = dcount(UserPrincipalName),\n    TargetedUsers = make_set(UserPrincipalName, 10),\n    UniqueApps = dcount(AppDisplayName),\n    ErrorCodes = make_set(ResultType, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by IPAddress\n| extend FailureRate = round(todouble(FailedCount) / TotalAttempts * 100, 2)\n| where FailedCount > 10 or (UniqueUsers > 5 and FailureRate > 50)\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| extend IsTrustedIP = ipv4_is_private(IPAddress) or ipv4_is_in_any_range(IPAddress, TrustedIPRanges)\n| extend IsTrustedCountry = Country in (TrustedCountries)\n| extend TrustedLocation = case(\n    IsTrustedIP, 'üü¢ Trusted IP',\n    IsTrustedCountry, 'üü° Trusted Country',\n    'üî¥ Untrusted'\n)\n| extend ThreatLevel = case(\n    FailedCount > 100 and UniqueUsers > 10, 'üî¥ Critical - Credential Attack',\n    FailedCount > 50 or UniqueUsers > 5, 'üü† High - Suspicious',\n    FailureRate > 80, 'üü° Medium - High Failure Rate',\n    'üü¢ Low'\n)\n| order by FailedCount desc\n| take 50",
              "size": 0,
              "title": "üî¥ Suspicious IPs (High Failure Volume)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SuspiciousIPs"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// IPs Targeting Multiple Users (Password Spray Pattern)\nlet TrustedCountries = dynamic(['United States', 'Canada', 'United Kingdom', 'Germany', 'France', 'Netherlands', 'Australia']);\nlet TrustedIPRanges = dynamic(['10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16', '20.0.0.0/8', '40.0.0.0/8', '52.0.0.0/8', '104.0.0.0/8', '13.0.0.0/8']);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType != '0'\n| summarize \n    TargetedUsers = dcount(UserPrincipalName),\n    UserList = make_set(UserPrincipalName, 20),\n    FailedAttempts = count(),\n    Apps = make_set(AppDisplayName, 5),\n    ErrorCodes = make_set(ResultType, 5)\n    by IPAddress\n| where TargetedUsers > 3\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend IsTrustedIP = ipv4_is_private(IPAddress) or ipv4_is_in_any_range(IPAddress, TrustedIPRanges)\n| extend IsTrustedCountry = Country in (TrustedCountries)\n| extend TrustedLocation = case(\n    IsTrustedIP, 'üü¢ Trusted IP',\n    IsTrustedCountry, 'üü° Trusted Country',\n    'üî¥ Untrusted'\n)\n| extend AttackPattern = case(\n    TargetedUsers > 20, 'üî¥ Mass Password Spray',\n    TargetedUsers > 10, 'üü† Password Spray',\n    'üü° Multi-User Attack'\n)\n| order by TargetedUsers desc",
              "size": 0,
              "title": "üéØ Password Spray Detection (IPs Targeting Multiple Users)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "PasswordSpray"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Potential Malicious IPs - Correlation with TI\nlet MaliciousIndicators = ThreatIntelligenceIndicator\n| where TimeGenerated > ago(30d)\n| where isnotempty(NetworkIP) or isnotempty(NetworkSourceIP)\n| extend TIIPAddress = coalesce(NetworkIP, NetworkSourceIP)\n| where isnotempty(TIIPAddress)\n| summarize ThreatTypes = make_set(ThreatType, 5), Confidence = max(ConfidenceScore) by TIIPAddress;\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| join kind=inner (MaliciousIndicators) on $left.IPAddress == $right.TIIPAddress\n| summarize \n    SignIns = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 10),\n    Apps = make_set(AppDisplayName, 5),\n    ThreatTypes = take_any(ThreatTypes),\n    Confidence = max(Confidence)\n    by IPAddress\n| extend RiskLevel = case(\n    SuccessCount > 0, \"üî¥ Critical - Successful Malicious Access\",\n    \"üü† High - Blocked Malicious Attempt\"\n)\n| order by SuccessCount desc, SignIns desc",
              "size": 0,
              "title": "‚ò†Ô∏è Known Malicious IPs (Threat Intelligence Match)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "MaliciousIPsTI"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Anonymous/VPN/Proxy Detection\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| mv-expand todynamic(NetworkLocationDetails)\n| extend NetworkType = tostring(NetworkLocationDetails.networkType)\n| where NetworkType in (\"anonymizer\", \"vpn\", \"proxy\", \"tor\")\n| summarize \n    SignIns = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 10),\n    UniqueIPs = dcount(IPAddress),\n    Apps = make_set(AppDisplayName, 5)\n    by NetworkType\n| extend RiskLevel = case(\n    SuccessCount > 0, \"üî¥ High - Successful Access\",\n    \"üü° Medium - Blocked\"\n)\n| order by SignIns desc",
              "size": 0,
              "title": "üïµÔ∏è Anonymous/VPN/Proxy Sign-Ins",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "AnonymousAccess"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Risky Sign-Ins by Risk Level\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where RiskLevelDuringSignIn != \"none\" and isnotempty(RiskLevelDuringSignIn)\n| summarize \n    Count = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 10),\n    Apps = make_set(AppDisplayName, 5)\n    by RiskLevelDuringSignIn\n| extend RiskEmoji = case(\n    RiskLevelDuringSignIn == \"high\", \"üî¥\",\n    RiskLevelDuringSignIn == \"medium\", \"üü†\",\n    RiskLevelDuringSignIn == \"low\", \"üü°\",\n    \"‚ö™\"\n)\n| extend DisplayRisk = strcat(RiskEmoji, \" \", RiskLevelDuringSignIn)\n| project DisplayRisk, Count, UniqueUsers, Users, Apps\n| order by Count desc",
              "size": 0,
              "title": "‚ö†Ô∏è Risky Sign-Ins by Risk Level",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "RiskySignIns"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// New IP Addresses Accessing Organization\nlet TrustedCountries = dynamic(['United States', 'Canada', 'United Kingdom', 'Germany', 'France', 'Netherlands', 'Australia']);\nlet TrustedIPRanges = dynamic(['10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16', '20.0.0.0/8', '40.0.0.0/8', '52.0.0.0/8', '104.0.0.0/8', '13.0.0.0/8']);\nlet BaselineIPs = AADNonInteractiveUserSignInLogs\n| where TimeGenerated between (ago(60d) .. ago(7d))\n| where ResultType == '0'\n| distinct IPAddress;\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == '0'\n| join kind=leftanti (BaselineIPs) on IPAddress\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| extend IsTrustedIP = ipv4_is_private(IPAddress) or ipv4_is_in_any_range(IPAddress, TrustedIPRanges)\n| extend IsTrustedCountry = Country in (TrustedCountries)\n| extend TrustedLocation = case(\n    IsTrustedIP, 'üü¢ Trusted IP',\n    IsTrustedCountry, 'üü° Trusted Country',\n    'üî¥ Untrusted'\n)\n| summarize \n    SignIns = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 10),\n    Apps = make_set(AppDisplayName, 5),\n    FirstSeen = min(TimeGenerated)\n    by IPAddress, Country, City, TrustedLocation\n| extend RiskLevel = case(\n    TrustedLocation == 'üî¥ Untrusted' and UniqueUsers > 5, 'üî¥ High - Multiple Users from Untrusted',\n    TrustedLocation == 'üî¥ Untrusted', 'üü† Medium - New Untrusted IP',\n    UniqueUsers > 5, 'üü° Low - Multiple Users',\n    'üü¢ Low - Single User'\n)\n| order by SignIns desc\n| take 50",
              "size": 0,
              "title": "üÜï New IPs (First Seen in Period)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "NewIPs"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Token Refresh Anomalies (Unusual Patterns)\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\"\n| summarize \n    SignInCount = count(),\n    UniqueIPs = dcount(IPAddress),\n    UniqueApps = dcount(AppDisplayName),\n    IPList = make_set(IPAddress, 10),\n    AppList = make_set(AppDisplayName, 10),\n    AvgSignInsPerHour = round(count() / (datetime_diff('hour', max(TimeGenerated), min(TimeGenerated)) + 1.0), 2)\n    by UserPrincipalName, bin(TimeGenerated, 1h)\n| where SignInCount > 50 or UniqueIPs > 5\n| extend AnomalyType = case(\n    UniqueIPs > 10, \"üî¥ Critical - Distributed Token Use\",\n    UniqueIPs > 5, \"üü† High - Multiple IPs\",\n    SignInCount > 100, \"üü° Medium - High Volume\",\n    \"Review\"\n)\n| order by SignInCount desc",
              "size": 0,
              "title": "üîç Token Refresh Anomalies",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "TokenAnomalies"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "security"
      },
      "name": "SecurityGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## ‚ùå Failure Analysis\n---\nDeep-dive into authentication failures, error codes, and patterns."
            },
            "name": "FailuresHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Failure Error Codes\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType != \"0\"\n| extend ErrorDescription = case(\n    ResultType == \"50126\", \"Invalid username or password\",\n    ResultType == \"50053\", \"Account locked out\",\n    ResultType == \"50057\", \"Account disabled\",\n    ResultType == \"50055\", \"Password expired\",\n    ResultType == \"50056\", \"Invalid or null password\",\n    ResultType == \"50076\", \"MFA required\",\n    ResultType == \"50074\", \"Strong auth required\",\n    ResultType == \"50079\", \"User must enroll MFA\",\n    ResultType == \"50140\", \"Keep me signed in interrupt\",\n    ResultType == \"53003\", \"Blocked by Conditional Access\",\n    ResultType == \"530032\", \"Blocked by security defaults\",\n    ResultType == \"65001\", \"User hasn't consented\",\n    ResultType == \"70011\", \"Invalid scope requested\",\n    ResultType == \"7000218\", \"Request body must contain client_assertion\",\n    ResultType == \"90094\", \"Admin consent required\",\n    ResultType == \"500011\", \"Resource not found\",\n    ResultType == \"500121\", \"Authentication failed during MFA\",\n    ResultType == \"700016\", \"Application not found in tenant\",\n    ResultType == \"700027\", \"Client assertion invalid signature\",\n    strcat(\"Error \", ResultType)\n)\n| summarize \n    Count = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueApps = dcount(AppDisplayName),\n    SampleUsers = make_set(UserPrincipalName, 5),\n    SampleApps = make_set(AppDisplayName, 5)\n    by ResultType, ErrorDescription\n| order by Count desc",
              "size": 0,
              "title": "‚ùå Top Failure Error Codes",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "TopErrorCodes"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Error Code Distribution\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType != \"0\"\n| summarize Count = count() by ResultType\n| top 10 by Count",
              "size": 2,
              "title": "Error Code Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "ErrorCodePie"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìà Error Code Baseline Comparison\n\nCompare current error code distribution against the previous 7-day baseline to identify new or increasing error patterns."
            },
            "name": "ErrorBaselineHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Error Code 7-Day Baseline Comparison\nlet CurrentWeek = AADNonInteractiveUserSignInLogs\n| where TimeGenerated >= ago(7d)\n| where ResultType != '0'\n| summarize CurrentCount = count() by ResultType;\nlet PreviousWeek = AADNonInteractiveUserSignInLogs\n| where TimeGenerated between (ago(14d) .. ago(7d))\n| where ResultType != '0'\n| summarize BaselineCount = count() by ResultType;\nCurrentWeek\n| join kind=fullouter (PreviousWeek) on ResultType\n| extend ResultType = coalesce(ResultType, ResultType1)\n| extend CurrentCount = coalesce(CurrentCount, 0)\n| extend BaselineCount = coalesce(BaselineCount, 0)\n| extend Change = CurrentCount - BaselineCount\n| extend ChangePct = round(iff(BaselineCount > 0, todouble(Change) / BaselineCount * 100, 100.0), 2)\n| extend ErrorDescription = case(\n    ResultType == '50126', 'Invalid username or password',\n    ResultType == '50053', 'Account locked out',\n    ResultType == '50057', 'Account disabled',\n    ResultType == '50055', 'Password expired',\n    ResultType == '50076', 'MFA required',\n    ResultType == '53003', 'Blocked by Conditional Access',\n    ResultType == '65001', 'User has not consented',\n    ResultType == '700016', 'App not found in tenant',\n    strcat('Error ', ResultType)\n)\n| extend Trend = case(\n    ChangePct > 100, 'üî¥ Significant Increase',\n    ChangePct > 50, 'üü† Moderate Increase',\n    ChangePct > 0, 'üü° Slight Increase',\n    ChangePct == 0, '‚ûñ No Change',\n    ChangePct > -50, 'üü¢ Slight Decrease',\n    '‚úÖ Significant Decrease'\n)\n| extend IsNew = iff(BaselineCount == 0 and CurrentCount > 0, 'üÜï New Error', '')\n| project ResultType, ErrorDescription, CurrentCount, BaselineCount, Change, ChangePct, Trend, IsNew\n| order by CurrentCount desc\n| take 15",
              "size": 0,
              "title": "üìä Error Code Baseline Comparison (7-Day)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  { "columnMatch": "CurrentCount", "formatter": 8, "formatOptions": { "palette": "red" } },
                  { "columnMatch": "ChangePct", "formatter": 8, "formatOptions": { "palette": "greenRed" } }
                ]
              }
            },
            "name": "ErrorCodeBaseline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Error Code Trend Over Time\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated >= ago(14d)\n| where ResultType != '0'\n| where ResultType in (\n    AADNonInteractiveUserSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | where ResultType != '0'\n    | summarize Count = count() by ResultType\n    | top 5 by Count\n    | project ResultType\n)\n| extend Period = iff(TimeGenerated >= ago(7d), 'Current Week', 'Baseline Week')\n| summarize Count = count() by bin(TimeGenerated, 1d), ResultType\n| render timechart",
              "size": 0,
              "title": "üìà Top Error Codes Trend (14 Days)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "name": "ErrorCodeTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Failure Timeline\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType != \"0\"\n| summarize Failures = count() by bin(TimeGenerated, 1h)\n| render timechart",
              "size": 0,
              "title": "Failure Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "FailureTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Users with Failures\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType != \"0\"\n| summarize \n    FailedCount = count(),\n    ErrorCodes = make_set(ResultType, 10),\n    Apps = make_set(AppDisplayName, 5),\n    IPs = make_set(IPAddress, 5),\n    FirstFailure = min(TimeGenerated),\n    LastFailure = max(TimeGenerated)\n    by UserPrincipalName\n| order by FailedCount desc\n| take 30",
              "size": 0,
              "title": "üë§ Top Users with Failures",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "TopFailedUsers"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Apps with Failures\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType != \"0\"\n| summarize \n    FailedCount = count(),\n    ErrorCodes = make_set(ResultType, 10),\n    UniqueUsers = dcount(UserPrincipalName),\n    FirstFailure = min(TimeGenerated),\n    LastFailure = max(TimeGenerated)\n    by AppDisplayName, AppId\n| order by FailedCount desc\n| take 30",
              "size": 0,
              "title": "üì± Top Apps with Failures",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "TopFailedApps"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Conditional Access Blocks\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType in (\"53003\", \"530032\")\n| mv-expand todynamic(ConditionalAccessPolicies)\n| where ConditionalAccessPolicies.result == \"failure\"\n| extend PolicyName = tostring(ConditionalAccessPolicies.displayName)\n| extend PolicyId = tostring(ConditionalAccessPolicies.id)\n| summarize \n    BlockCount = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 10),\n    Apps = make_set(AppDisplayName, 5)\n    by PolicyName, PolicyId\n| order by BlockCount desc",
              "size": 0,
              "title": "üõ°Ô∏è Conditional Access Policy Blocks",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "CABlocks"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// MFA-Related Failures\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType in (\"50076\", \"50074\", \"50079\", \"500121\")\n| extend MFAError = case(\n    ResultType == \"50076\", \"MFA Required\",\n    ResultType == \"50074\", \"Strong Auth Required\",\n    ResultType == \"50079\", \"User Must Enroll MFA\",\n    ResultType == \"500121\", \"MFA Authentication Failed\",\n    \"Other MFA Error\"\n)\n| summarize \n    Count = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 10),\n    Apps = make_set(AppDisplayName, 5)\n    by MFAError\n| order by Count desc",
              "size": 0,
              "title": "üîê MFA-Related Failures",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "MFAFailures"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Account Status Failures\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType in (\"50053\", \"50057\", \"50055\")\n| extend AccountIssue = case(\n    ResultType == \"50053\", \"üîí Account Locked\",\n    ResultType == \"50057\", \"‚õî Account Disabled\",\n    ResultType == \"50055\", \"üîë Password Expired\",\n    \"Other\"\n)\n| summarize \n    Count = count(),\n    Apps = make_set(AppDisplayName, 5),\n    IPs = make_set(IPAddress, 5)\n    by UserPrincipalName, AccountIssue\n| order by Count desc",
              "size": 0,
              "title": "üë§ Account Status Issues",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "AccountStatusFailures"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "failures"
      },
      "name": "FailuresGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## ü§ñ AI Agents Monitoring\n---\nMonitor AI Agent authentication activity including Copilot Studio Agents, Azure AI Foundry Agents, and Entra ID Agent identities.\n\n**Covered Agents:**\n- üéØ **Copilot Studio Agents** - Power Virtual Agents, Microsoft Copilot Studio bots\n- üè≠ **Azure AI Foundry Agents** - AI services, Azure OpenAI, Cognitive Services\n- üÜî **Entra ID Agent Identities** - Workload identities configured for AI/automation"
            },
            "name": "AIAgentsHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AI Agent Sign-In Overview - Tiles\nlet CopilotStudioApps = dynamic([\n    \"Power Virtual Agents\",\n    \"PVA\",\n    \"Copilot Studio\",\n    \"Microsoft Copilot\",\n    \"Copilot\",\n    \"Bot Framework\"\n]);\nlet FoundryApps = dynamic([\n    \"Azure OpenAI\",\n    \"Azure AI\",\n    \"Cognitive Services\",\n    \"Azure Machine Learning\",\n    \"AI Foundry\",\n    \"Azure AI Services\",\n    \"Azure AI Foundry\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| extend AgentType = case(\n    AppDisplayName has_any (CopilotStudioApps) or AppDisplayName contains \"copilot\" or AppDisplayName contains \"bot\", \"Copilot Studio\",\n    AppDisplayName has_any (FoundryApps) or AppDisplayName contains \"openai\" or AppDisplayName contains \"cognitive\", \"AI Foundry\",\n    AppDisplayName contains \"agent\" or AppDisplayName contains \"automation\", \"Agent Identity\",\n    \"\"\n)\n| where isnotempty(AgentType)\n| summarize TotalAgentSignIns = count()\n| extend Label = \"Total AI Agent Sign-Ins\"",
              "size": 4,
              "title": "Total AI Agent Sign-Ins",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "Label" },
                "leftContent": { "columnMatch": "TotalAgentSignIns", "formatter": 12, "numberFormat": { "unit": 17, "options": { "style": "decimal", "maximumFractionDigits": 0 } } },
                "showBorder": true
              }
            },
            "customWidth": "25",
            "name": "TileAIAgentTotal"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Copilot Studio Agents Count\nlet CopilotStudioApps = dynamic([\n    \"Power Virtual Agents\",\n    \"PVA\",\n    \"Copilot Studio\",\n    \"Microsoft Copilot\",\n    \"Copilot\",\n    \"Bot Framework\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (CopilotStudioApps) or AppDisplayName contains \"copilot\" or AppDisplayName contains \"bot\"\n| summarize Count = count()\n| extend Label = \"Copilot Studio\"",
              "size": 4,
              "title": "üéØ Copilot Studio",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "Label" },
                "leftContent": { "columnMatch": "Count", "formatter": 12, "numberFormat": { "unit": 17, "options": { "style": "decimal", "maximumFractionDigits": 0 } } },
                "showBorder": true
              }
            },
            "customWidth": "25",
            "name": "TileCopilotStudio"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AI Foundry Agents Count\nlet FoundryApps = dynamic([\n    \"Azure OpenAI\",\n    \"Azure AI\",\n    \"Cognitive Services\",\n    \"Azure Machine Learning\",\n    \"AI Foundry\",\n    \"Azure AI Services\",\n    \"Azure AI Foundry\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (FoundryApps) or AppDisplayName contains \"openai\" or AppDisplayName contains \"cognitive\"\n| summarize Count = count()\n| extend Label = \"AI Foundry\"",
              "size": 4,
              "title": "üè≠ AI Foundry",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "Label" },
                "leftContent": { "columnMatch": "Count", "formatter": 12, "numberFormat": { "unit": 17, "options": { "style": "decimal", "maximumFractionDigits": 0 } } },
                "showBorder": true
              }
            },
            "customWidth": "25",
            "name": "TileAIFoundry"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Unique AI Agent Apps\nlet CopilotStudioApps = dynamic([\n    \"Power Virtual Agents\",\n    \"PVA\",\n    \"Copilot Studio\",\n    \"Microsoft Copilot\",\n    \"Copilot\",\n    \"Bot Framework\"\n]);\nlet FoundryApps = dynamic([\n    \"Azure OpenAI\",\n    \"Azure AI\",\n    \"Cognitive Services\",\n    \"Azure Machine Learning\",\n    \"AI Foundry\",\n    \"Azure AI Services\",\n    \"Azure AI Foundry\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (CopilotStudioApps) \n    or AppDisplayName has_any (FoundryApps)\n    or AppDisplayName contains \"copilot\" \n    or AppDisplayName contains \"bot\"\n    or AppDisplayName contains \"openai\"\n    or AppDisplayName contains \"agent\"\n| summarize UniqueApps = dcount(AppDisplayName)\n| extend Label = \"Unique Agent Apps\"",
              "size": 4,
              "title": "üÜî Unique Agent Apps",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "Label" },
                "leftContent": { "columnMatch": "UniqueApps", "formatter": 12, "numberFormat": { "unit": 17, "options": { "style": "decimal", "maximumFractionDigits": 0 } } },
                "showBorder": true
              }
            },
            "customWidth": "25",
            "name": "TileUniqueAgentApps"
          },
          {
            "type": 1,
            "content": {
              "json": "### üéØ Copilot Studio Agents"
            },
            "name": "CopilotStudioHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Copilot Studio Agent Activity\nlet CopilotStudioApps = dynamic([\n    \"Power Virtual Agents\",\n    \"PVA\",\n    \"Copilot Studio\",\n    \"Microsoft Copilot\",\n    \"Copilot\",\n    \"Bot Framework\",\n    \"Microsoft Bot\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (CopilotStudioApps) or AppDisplayName contains \"copilot\" or AppDisplayName contains \"bot\"\n| summarize \n    TotalSignIns = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 10),\n    UniqueIPs = dcount(IPAddress),\n    Resources = make_set(ResourceDisplayName, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by AppDisplayName, AppId\n| extend FailureRate = round(todouble(FailedCount) / TotalSignIns * 100, 2)\n| extend HealthStatus = case(\n    FailureRate > 50, \"üî¥ Unhealthy\",\n    FailureRate > 20, \"üü† Degraded\",\n    \"üü¢ Healthy\"\n)\n| order by TotalSignIns desc",
              "size": 0,
              "title": "üéØ Copilot Studio Agent Activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "CopilotStudioAgents"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Copilot Studio Timeline\nlet CopilotStudioApps = dynamic([\n    \"Power Virtual Agents\",\n    \"PVA\",\n    \"Copilot Studio\",\n    \"Microsoft Copilot\",\n    \"Copilot\",\n    \"Bot Framework\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (CopilotStudioApps) or AppDisplayName contains \"copilot\" or AppDisplayName contains \"bot\"\n| extend Status = case(ResultType == \"0\", \"Success\", \"Failed\")\n| summarize Count = count() by bin(TimeGenerated, 1h), Status\n| render timechart",
              "size": 0,
              "title": "üìà Copilot Studio Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "CopilotStudioTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Copilot Studio Geolocation\nlet CopilotStudioApps = dynamic([\n    \"Power Virtual Agents\",\n    \"PVA\",\n    \"Copilot Studio\",\n    \"Microsoft Copilot\",\n    \"Copilot\",\n    \"Bot Framework\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (CopilotStudioApps) or AppDisplayName contains \"copilot\" or AppDisplayName contains \"bot\"\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| where isnotempty(Country)\n| summarize \n    SignIns = count(),\n    UniqueApps = dcount(AppDisplayName),\n    UniqueUsers = dcount(UserPrincipalName)\n    by Country\n| order by SignIns desc\n| take 10",
              "size": 2,
              "title": "üåç Copilot Studio by Country",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "CopilotStudioGeo"
          },
          {
            "type": 1,
            "content": {
              "json": "### üè≠ Azure AI Foundry Agents"
            },
            "name": "AIFoundryHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AI Foundry Agent Activity\nlet FoundryApps = dynamic([\n    \"Azure OpenAI\",\n    \"Azure AI\",\n    \"Cognitive Services\",\n    \"Azure Machine Learning\",\n    \"AI Foundry\",\n    \"Azure AI Services\",\n    \"Azure AI Foundry\",\n    \"Azure Cognitive\",\n    \"OpenAI\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (FoundryApps) or AppDisplayName contains \"openai\" or AppDisplayName contains \"cognitive\"\n| summarize \n    TotalSignIns = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 10),\n    UniqueIPs = dcount(IPAddress),\n    Resources = make_set(ResourceDisplayName, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by AppDisplayName, AppId\n| extend FailureRate = round(todouble(FailedCount) / TotalSignIns * 100, 2)\n| extend HealthStatus = case(\n    FailureRate > 50, \"üî¥ Unhealthy\",\n    FailureRate > 20, \"üü† Degraded\",\n    \"üü¢ Healthy\"\n)\n| order by TotalSignIns desc",
              "size": 0,
              "title": "üè≠ Azure AI Foundry Agent Activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "AIFoundryAgents"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AI Foundry Timeline\nlet FoundryApps = dynamic([\n    \"Azure OpenAI\",\n    \"Azure AI\",\n    \"Cognitive Services\",\n    \"Azure Machine Learning\",\n    \"AI Foundry\",\n    \"Azure AI Services\",\n    \"Azure AI Foundry\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (FoundryApps) or AppDisplayName contains \"openai\" or AppDisplayName contains \"cognitive\"\n| extend Status = case(ResultType == \"0\", \"Success\", \"Failed\")\n| summarize Count = count() by bin(TimeGenerated, 1h), Status\n| render timechart",
              "size": 0,
              "title": "üìà AI Foundry Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "AIFoundryTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AI Foundry Resources Accessed\nlet FoundryApps = dynamic([\n    \"Azure OpenAI\",\n    \"Azure AI\",\n    \"Cognitive Services\",\n    \"Azure Machine Learning\",\n    \"AI Foundry\",\n    \"Azure AI Services\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (FoundryApps) or AppDisplayName contains \"openai\" or AppDisplayName contains \"cognitive\"\n| where ResultType == \"0\"\n| summarize AccessCount = count(), UniqueApps = dcount(AppDisplayName) by ResourceDisplayName\n| order by AccessCount desc\n| take 10",
              "size": 2,
              "title": "üéØ Resources Accessed by AI Foundry",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "AIFoundryResources"
          },
          {
            "type": 1,
            "content": {
              "json": "### üÜî Entra ID Agent Identities\n\nAgent identities registered in Entra ID for automation and AI workloads."
            },
            "name": "EntraAgentHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// All Agent-Like Applications (Pattern Detection)\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName contains \"agent\" \n    or AppDisplayName contains \"automation\"\n    or AppDisplayName contains \"workflow\"\n    or AppDisplayName contains \"scheduler\"\n    or AppDisplayName contains \"orchestrator\"\n    or AppDisplayName contains \"pipeline\"\n| summarize \n    TotalSignIns = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueIPs = dcount(IPAddress),\n    Resources = make_set(ResourceDisplayName, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by AppDisplayName, AppId\n| extend FailureRate = round(todouble(FailedCount) / TotalSignIns * 100, 2)\n| extend AgentCategory = case(\n    AppDisplayName contains \"agent\", \"ü§ñ Agent\",\n    AppDisplayName contains \"automation\", \"‚öôÔ∏è Automation\",\n    AppDisplayName contains \"workflow\", \"üîÑ Workflow\",\n    AppDisplayName contains \"pipeline\", \"üîÄ Pipeline\",\n    \"üìã Other\"\n)\n| order by TotalSignIns desc",
              "size": 0,
              "title": "üÜî Detected Agent Identities",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "EntraAgentIdentities"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principal Agent Sign-Ins\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| where ServicePrincipalName contains \"agent\" \n    or ServicePrincipalName contains \"automation\"\n    or ServicePrincipalName contains \"copilot\"\n    or ServicePrincipalName contains \"bot\"\n    or ServicePrincipalName contains \"ai\"\n| summarize \n    TotalSignIns = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    UniqueIPs = dcount(IPAddress),\n    Resources = make_set(ResourceDisplayName, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by ServicePrincipalName, ServicePrincipalId\n| extend FailureRate = round(todouble(FailedCount) / TotalSignIns * 100, 2)\n| extend HealthStatus = case(\n    FailureRate > 50, \"üî¥ Unhealthy\",\n    FailureRate > 20, \"üü† Degraded\",\n    \"üü¢ Healthy\"\n)\n| order by TotalSignIns desc",
              "size": 0,
              "title": "üîß Service Principal Agent Sign-Ins",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SPAgentSignIns"
          },
          {
            "type": 1,
            "content": {
              "json": "### üó∫Ô∏è AI Agent Geolocation"
            },
            "name": "AIAgentGeoHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AI Agent Sign-Ins Geolocation Map\nlet CopilotStudioApps = dynamic([\"Power Virtual Agents\", \"PVA\", \"Copilot Studio\", \"Microsoft Copilot\", \"Copilot\", \"Bot Framework\"]);\nlet FoundryApps = dynamic([\"Azure OpenAI\", \"Azure AI\", \"Cognitive Services\", \"Azure Machine Learning\", \"AI Foundry\", \"Azure AI Services\"]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (CopilotStudioApps) \n    or AppDisplayName has_any (FoundryApps)\n    or AppDisplayName contains \"copilot\" \n    or AppDisplayName contains \"bot\"\n    or AppDisplayName contains \"openai\"\n    or AppDisplayName contains \"agent\"\n| where isnotempty(IPAddress) and IPAddress != \"127.0.0.1\"\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Latitude = toreal(GeoInfo.latitude)\n| extend Longitude = toreal(GeoInfo.longitude)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| where isnotempty(Latitude) and isnotempty(Longitude)\n| summarize \n    SignIns = count(),\n    UniqueApps = dcount(AppDisplayName),\n    Apps = make_set(AppDisplayName, 5),\n    UniqueUsers = dcount(UserPrincipalName)\n    by Longitude, Latitude, Country, City\n| extend LocationLabel = strcat(City, \", \", Country, \" - \", SignIns, \" sign-ins\")",
              "size": 0,
              "title": "üó∫Ô∏è AI Agent Sign-In Locations",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "map",
              "mapSettings": {
                "locInfo": "LatLong",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "SignIns",
                "sizeAggregation": "Sum",
                "labelSettings": "LocationLabel",
                "legendMetric": "SignIns",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "SignIns",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "name": "AIAgentGeoMap"
          },
          {
            "type": 1,
            "content": {
              "json": "### ‚ö†Ô∏è AI Agent Security Concerns"
            },
            "name": "AIAgentSecurityHeader"
          },
          {
            "type": 1,
            "content": {
              "json": "### üëª AI Shadow IT Detection\n\nIdentify unauthorized or unapproved AI applications being used within your organization. Shadow AI poses data governance and compliance risks.\n\n**Risk Indicators:**\n- üî¥ **Unapproved AI Services** - Third-party AI tools not sanctioned by IT\n- üü† **New AI Applications** - Recently detected AI apps requiring review\n- üü° **High Usage Patterns** - Excessive use suggesting potential data leakage\n- ‚ö†Ô∏è **Unknown AI Integrations** - Unidentified apps with AI-like behavior"
            },
            "name": "ShadowITHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AI Shadow IT - Unauthorized AI Applications\nlet ApprovedAIApps = dynamic([\n    'Microsoft Copilot',\n    'Copilot Studio',\n    'Azure OpenAI',\n    'Azure AI',\n    'Microsoft Security Copilot',\n    'Power Virtual Agents'\n]);\nlet KnownAIPatterns = dynamic(['openai', 'chatgpt', 'gpt', 'claude', 'anthropic', 'gemini', 'bard', 'copilot', 'ai', 'llm', 'bot', 'agent']);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (KnownAIPatterns)\n| where not(AppDisplayName has_any (ApprovedAIApps))\n| summarize \n    SignIns = count(),\n    SuccessCount = countif(ResultType == '0'),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 15),\n    UniqueIPs = dcount(IPAddress),\n    Resources = make_set(ResourceDisplayName, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by AppDisplayName, AppId\n| extend RiskLevel = case(\n    SuccessCount > 100, 'üî¥ Critical - High Usage Unapproved AI',\n    SuccessCount > 10, 'üü† High - Active Unapproved AI',\n    SuccessCount > 0, 'üü° Medium - Some Unapproved AI Access',\n    'üü¢ Low - Blocked'\n)\n| extend ShadowITStatus = 'üëª Potential Shadow AI'\n| order by SignIns desc",
              "size": 0,
              "title": "üëª AI Shadow IT - Unapproved AI Applications",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "AIShadowIT"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// New AI Applications (Not seen in baseline)\nlet KnownAIPatterns = dynamic(['openai', 'chatgpt', 'gpt', 'claude', 'anthropic', 'gemini', 'bard', 'copilot', 'ai', 'llm', 'bot', 'agent', 'cognitive']);\nlet BaselineApps = AADNonInteractiveUserSignInLogs\n| where TimeGenerated between (ago(60d) .. ago(7d))\n| where AppDisplayName has_any (KnownAIPatterns)\n| distinct AppDisplayName;\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (KnownAIPatterns)\n| join kind=leftanti (BaselineApps) on AppDisplayName\n| summarize \n    SignIns = count(),\n    SuccessCount = countif(ResultType == '0'),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 10),\n    FirstSeen = min(TimeGenerated)\n    by AppDisplayName, AppId\n| extend Status = 'üÜï New AI Application - Review Required'\n| order by SignIns desc",
              "size": 0,
              "title": "üÜï Newly Detected AI Applications",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "NewAIApps"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Shadow AI Usage by User\nlet ApprovedAIApps = dynamic(['Microsoft Copilot', 'Copilot Studio', 'Azure OpenAI', 'Azure AI', 'Microsoft Security Copilot']);\nlet KnownAIPatterns = dynamic(['openai', 'chatgpt', 'gpt', 'claude', 'anthropic', 'gemini', 'bard', 'copilot', 'ai', 'llm']);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (KnownAIPatterns)\n| where not(AppDisplayName has_any (ApprovedAIApps))\n| where ResultType == '0'\n| summarize \n    ShadowAISignIns = count(),\n    ShadowAIApps = make_set(AppDisplayName, 10),\n    UniqueApps = dcount(AppDisplayName),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by UserPrincipalName\n| extend RiskLevel = case(\n    UniqueApps > 3, 'üî¥ High - Multiple Shadow AI',\n    ShadowAISignIns > 50, 'üü† Medium - Heavy Usage',\n    'üü° Low - Limited Usage'\n)\n| order by ShadowAISignIns desc\n| take 30",
              "size": 0,
              "title": "üë§ Users Using Shadow AI",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ShadowAIUsers"
          },
          {
            "type": 1,
            "content": {
              "json": "### üåä Agent Sprawl Detection\n\nIdentify agent proliferation and sprawl within your organization. Agent sprawl occurs when too many AI agents are deployed without proper governance, leading to:\n\n**Risks of Agent Sprawl:**\n- üî¥ **Security Gaps** - Ungoverned agents with excessive permissions\n- üü† **Data Leakage** - Agents accessing sensitive resources\n- üü° **Compliance Issues** - Untracked AI usage for regulatory audits\n- ‚ö†Ô∏è **Cost Overruns** - Redundant or unused agent deployments\n\n**Sprawl Indicators:**\n- Many similar agents with overlapping functionality\n- Agents with no recent activity (abandoned)\n- Agents with high failure rates (misconfigured)\n- Agents accessing resources outside their scope"
            },
            "name": "AgentSprawlHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Agent Sprawl Overview - Total Agent Inventory\nlet AgentPatterns = dynamic(['agent', 'bot', 'automation', 'copilot', 'workflow', 'orchestrator', 'pipeline', 'scheduler']);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (AgentPatterns)\n| summarize \n    TotalSignIns = count(),\n    SuccessCount = countif(ResultType == '0'),\n    FailedCount = countif(ResultType != '0'),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueResources = dcount(ResourceDisplayName),\n    LastActivity = max(TimeGenerated),\n    FirstActivity = min(TimeGenerated)\n    by AppDisplayName, AppId\n| extend DaysSinceActivity = datetime_diff('day', now(), LastActivity)\n| extend FailureRate = round(todouble(FailedCount) / TotalSignIns * 100, 2)\n| extend AgentStatus = case(\n    DaysSinceActivity > 30, 'üíÄ Abandoned (No activity 30+ days)',\n    FailureRate > 80, 'üî¥ Broken (High failure rate)',\n    FailureRate > 50, 'üü† Degraded',\n    TotalSignIns < 10, 'üü° Low Usage',\n    'üü¢ Active'\n)\n| extend SprawlRisk = case(\n    DaysSinceActivity > 30, 'Review for removal',\n    UniqueResources > 10, 'Review permissions scope',\n    UniqueUsers > 20, 'Review delegation scope',\n    'Normal'\n)\n| order by TotalSignIns desc",
              "size": 0,
              "title": "üåä Agent Inventory & Sprawl Assessment",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "AgentSprawlInventory"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Abandoned/Inactive Agents\nlet AgentPatterns = dynamic(['agent', 'bot', 'automation', 'copilot', 'workflow', 'orchestrator']);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated >= ago(90d)\n| where AppDisplayName has_any (AgentPatterns)\n| summarize \n    LastActivity = max(TimeGenerated),\n    TotalSignIns = count(),\n    UniqueUsers = dcount(UserPrincipalName)\n    by AppDisplayName, AppId\n| extend DaysSinceActivity = datetime_diff('day', now(), LastActivity)\n| where DaysSinceActivity > 14\n| extend Status = case(\n    DaysSinceActivity > 60, 'üíÄ Abandoned - Remove',\n    DaysSinceActivity > 30, 'üî¥ Inactive - Review',\n    'üü° Stale - Monitor'\n)\n| order by DaysSinceActivity desc",
              "size": 0,
              "title": "üíÄ Abandoned/Inactive Agents (Sprawl Candidates)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "AbandonedAgents"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Agent Sprawl Metrics\nlet AgentPatterns = dynamic(['agent', 'bot', 'automation', 'copilot', 'workflow', 'orchestrator']);\nlet TotalAgents = toscalar(AADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (AgentPatterns)\n| summarize dcount(AppDisplayName));\nlet ActiveAgents = toscalar(AADNonInteractiveUserSignInLogs\n| where TimeGenerated >= ago(7d)\n| where AppDisplayName has_any (AgentPatterns)\n| summarize dcount(AppDisplayName));\nlet FailingAgents = toscalar(AADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (AgentPatterns)\n| summarize FailureRate = round(todouble(countif(ResultType != '0')) / count() * 100, 2) by AppDisplayName\n| where FailureRate > 50\n| summarize count());\nprint \n    TotalAgentApps = TotalAgents,\n    ActiveLast7Days = ActiveAgents,\n    HighFailureAgents = FailingAgents\n| extend ActivePct = round(todouble(ActiveLast7Days) / TotalAgentApps * 100, 2)\n| extend SprawlScore = case(\n    TotalAgentApps > 50 and ActivePct < 50, 'High Sprawl',\n    TotalAgentApps > 20 and ActivePct < 70, 'Medium Sprawl',\n    'Low Sprawl'\n)",
              "size": 4,
              "title": "üìä Agent Sprawl Metrics",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": { "columnMatch": "SprawlScore", "formatter": 1 },
                "leftContent": { "columnMatch": "TotalAgentApps", "formatter": 12, "formatOptions": { "palette": "auto" }, "numberFormat": { "unit": 17, "options": { "style": "decimal", "maximumFractionDigits": 0 } } },
                "secondaryContent": { "columnMatch": "ActivePct", "formatter": 1 },
                "showBorder": true
              }
            },
            "customWidth": "50",
            "name": "AgentSprawlMetrics"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Agents with Excessive Resource Access (Scope Creep)\nlet AgentPatterns = dynamic(['agent', 'bot', 'automation', 'copilot', 'workflow', 'orchestrator']);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (AgentPatterns)\n| where ResultType == '0'\n| summarize \n    UniqueResources = dcount(ResourceDisplayName),\n    Resources = make_set(ResourceDisplayName, 20),\n    SignIns = count(),\n    UniqueUsers = dcount(UserPrincipalName)\n    by AppDisplayName, AppId\n| where UniqueResources > 5\n| extend ScopeRisk = case(\n    UniqueResources > 15, 'üî¥ Critical - Excessive Access',\n    UniqueResources > 10, 'üü† High - Broad Access',\n    'üü° Medium - Review Scope'\n)\n| order by UniqueResources desc",
              "size": 0,
              "title": "‚ö†Ô∏è Agents with Excessive Resource Access (Scope Creep)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "AgentScopeCreep"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AI Agent Failures\nlet CopilotStudioApps = dynamic([\"Power Virtual Agents\", \"PVA\", \"Copilot Studio\", \"Microsoft Copilot\", \"Copilot\", \"Bot Framework\"]);\nlet FoundryApps = dynamic([\"Azure OpenAI\", \"Azure AI\", \"Cognitive Services\", \"Azure Machine Learning\", \"AI Foundry\"]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType != \"0\"\n| where AppDisplayName has_any (CopilotStudioApps) \n    or AppDisplayName has_any (FoundryApps)\n    or AppDisplayName contains \"copilot\" \n    or AppDisplayName contains \"bot\"\n    or AppDisplayName contains \"openai\"\n    or AppDisplayName contains \"agent\"\n| summarize \n    FailureCount = count(),\n    ErrorCodes = make_set(ResultType, 5),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 10),\n    LastFailure = max(TimeGenerated)\n    by AppDisplayName, AppId\n| order by FailureCount desc",
              "size": 0,
              "title": "‚ùå AI Agent Failures",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "AIAgentFailures"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// AI Agents Accessing from Unusual Locations\nlet CopilotStudioApps = dynamic([\"Power Virtual Agents\", \"PVA\", \"Copilot Studio\", \"Microsoft Copilot\", \"Copilot\"]);\nlet FoundryApps = dynamic([\"Azure OpenAI\", \"Azure AI\", \"Cognitive Services\", \"AI Foundry\"]);\nlet BaselineCountries = AADNonInteractiveUserSignInLogs\n| where TimeGenerated between (ago(60d) .. ago(7d))\n| where AppDisplayName has_any (CopilotStudioApps) or AppDisplayName has_any (FoundryApps) or AppDisplayName contains \"agent\"\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| where isnotempty(Country)\n| distinct AppDisplayName, Country;\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (CopilotStudioApps) or AppDisplayName has_any (FoundryApps) or AppDisplayName contains \"agent\"\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| where isnotempty(Country)\n| join kind=leftanti (BaselineCountries) on AppDisplayName, Country\n| summarize \n    SignIns = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 5),\n    Cities = make_set(City, 5)\n    by AppDisplayName, Country\n| extend RiskLevel = \"üî¥ New Location\"",
              "size": 0,
              "title": "‚ö†Ô∏è AI Agents from New Geographic Locations",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "AIAgentNewLocations"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// High Volume AI Agent Activity (Anomaly Detection)\nlet CopilotStudioApps = dynamic([\"Power Virtual Agents\", \"PVA\", \"Copilot Studio\", \"Microsoft Copilot\", \"Copilot\"]);\nlet FoundryApps = dynamic([\"Azure OpenAI\", \"Azure AI\", \"Cognitive Services\", \"AI Foundry\"]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (CopilotStudioApps) or AppDisplayName has_any (FoundryApps) or AppDisplayName contains \"agent\" or AppDisplayName contains \"copilot\"\n| summarize SignInCount = count() by AppDisplayName, bin(TimeGenerated, 1h)\n| summarize \n    TotalSignIns = sum(SignInCount),\n    MaxHourlySignIns = max(SignInCount),\n    AvgHourlySignIns = round(avg(SignInCount), 0),\n    ActiveHours = dcount(TimeGenerated)\n    by AppDisplayName\n| extend UsagePattern = case(\n    MaxHourlySignIns > 1000, \"üî¥ Very High Volume\",\n    MaxHourlySignIns > 100, \"üü† High Volume\",\n    AvgHourlySignIns > 10, \"üü° Moderate\",\n    \"üü¢ Normal\"\n)\n| order by TotalSignIns desc",
              "size": 0,
              "title": "üìä AI Agent Volume Analysis",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "AIAgentVolumeAnalysis"
          },
          {
            "type": 1,
            "content": {
              "json": "### üõ°Ô∏è Microsoft Security Copilot\n\nMonitor Microsoft Security Copilot and Security Copilot agents activity, including plugin usage and security operations."
            },
            "name": "SecurityCopilotHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Security Copilot Sign-In Activity\nlet SecurityCopilotApps = dynamic([\n    \"Security Copilot\",\n    \"Microsoft Security Copilot\",\n    \"Copilot for Security\",\n    \"Microsoft Copilot for Security\",\n    \"SecurityCopilot\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (SecurityCopilotApps) or AppDisplayName contains \"Security Copilot\"\n| summarize \n    TotalSignIns = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 15),\n    UniqueIPs = dcount(IPAddress),\n    Resources = make_set(ResourceDisplayName, 10),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by AppDisplayName, AppId\n| extend FailureRate = round(todouble(FailedCount) / TotalSignIns * 100, 2)\n| extend HealthStatus = case(\n    FailureRate > 50, \"üî¥ Unhealthy\",\n    FailureRate > 20, \"üü† Degraded\",\n    \"üü¢ Healthy\"\n)\n| order by TotalSignIns desc",
              "size": 0,
              "title": "üõ°Ô∏è Security Copilot Sign-In Activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SecurityCopilotActivity"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Security Copilot Users\nlet SecurityCopilotApps = dynamic([\n    \"Security Copilot\",\n    \"Microsoft Security Copilot\",\n    \"Copilot for Security\",\n    \"Microsoft Copilot for Security\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (SecurityCopilotApps) or AppDisplayName contains \"Security Copilot\"\n| summarize \n    SignIns = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    UniqueIPs = dcount(IPAddress),\n    Locations = make_set(Location, 5),\n    Resources = make_set(ResourceDisplayName, 5),\n    FirstUsage = min(TimeGenerated),\n    LastUsage = max(TimeGenerated)\n    by UserPrincipalName\n| extend FailureRate = round(todouble(FailedCount) / SignIns * 100, 2)\n| order by SignIns desc",
              "size": 0,
              "title": "üë§ Security Copilot Users",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "SecurityCopilotUsers"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Security Copilot Timeline\nlet SecurityCopilotApps = dynamic([\n    \"Security Copilot\",\n    \"Microsoft Security Copilot\",\n    \"Copilot for Security\",\n    \"Microsoft Copilot for Security\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (SecurityCopilotApps) or AppDisplayName contains \"Security Copilot\"\n| extend Status = case(ResultType == \"0\", \"Success\", \"Failed\")\n| summarize Count = count() by bin(TimeGenerated, 1h), Status\n| render timechart",
              "size": 0,
              "title": "üìà Security Copilot Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "SecurityCopilotTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Security Copilot Resources Accessed (Plugins/Integrations)\nlet SecurityCopilotApps = dynamic([\n    \"Security Copilot\",\n    \"Microsoft Security Copilot\",\n    \"Copilot for Security\",\n    \"Microsoft Copilot for Security\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (SecurityCopilotApps) or AppDisplayName contains \"Security Copilot\"\n| where ResultType == \"0\"\n| summarize \n    AccessCount = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 10)\n    by ResourceDisplayName\n| order by AccessCount desc\n| take 15",
              "size": 0,
              "title": "üîå Security Copilot Resources/Plugins Accessed",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "SecurityCopilotResources"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Security Copilot Geographic Distribution\nlet SecurityCopilotApps = dynamic([\n    \"Security Copilot\",\n    \"Microsoft Security Copilot\",\n    \"Copilot for Security\",\n    \"Microsoft Copilot for Security\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (SecurityCopilotApps) or AppDisplayName contains \"Security Copilot\"\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| where isnotempty(Country)\n| summarize SignIns = count(), UniqueUsers = dcount(UserPrincipalName) by Country\n| order by SignIns desc\n| take 10",
              "size": 2,
              "title": "üåç Security Copilot by Country",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "SecurityCopilotGeo"
          },
          {
            "type": 1,
            "content": {
              "json": "### ü§ñ Security Copilot Agents & Service Principals\n\nMonitor Security Copilot agent identities and automated security operations."
            },
            "name": "SecurityCopilotAgentsHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Security Copilot Service Principal Activity\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| where ServicePrincipalName has_any (\"Security Copilot\", \"Copilot for Security\", \"SecurityCopilot\")\n    or ServicePrincipalName contains \"security-copilot\"\n    or ServicePrincipalName contains \"securitycopilot\"\n| summarize \n    TotalSignIns = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    UniqueIPs = dcount(IPAddress),\n    Resources = make_set(ResourceDisplayName, 10),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by ServicePrincipalName, ServicePrincipalId\n| extend FailureRate = round(todouble(FailedCount) / TotalSignIns * 100, 2)\n| extend HealthStatus = case(\n    FailureRate > 50, \"üî¥ Unhealthy\",\n    FailureRate > 20, \"üü† Degraded\",\n    \"üü¢ Healthy\"\n)\n| order by TotalSignIns desc",
              "size": 0,
              "title": "üîß Security Copilot Service Principal Activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SecurityCopilotSPActivity"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Security Copilot Plugin/Integration Sign-Ins\nlet SecurityPlugins = dynamic([\n    \"Microsoft Defender\",\n    \"Microsoft Sentinel\",\n    \"Microsoft Intune\",\n    \"Microsoft Purview\",\n    \"Microsoft Entra\",\n    \"Defender for Endpoint\",\n    \"Defender for Cloud\",\n    \"Defender for Identity\",\n    \"Defender XDR\",\n    \"Threat Intelligence\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResourceDisplayName has_any (SecurityPlugins)\n| where AppDisplayName contains \"Copilot\" or AppDisplayName contains \"Security\"\n| summarize \n    SignIns = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    UniqueUsers = dcount(UserPrincipalName),\n    Apps = make_set(AppDisplayName, 5)\n    by ResourceDisplayName\n| extend PluginType = case(\n    ResourceDisplayName contains \"Sentinel\", \"üîµ SIEM\",\n    ResourceDisplayName contains \"Defender\", \"üõ°Ô∏è XDR\",\n    ResourceDisplayName contains \"Intune\", \"üì± Endpoint\",\n    ResourceDisplayName contains \"Purview\", \"üîí Compliance\",\n    ResourceDisplayName contains \"Entra\", \"üÜî Identity\",\n    \"üì¶ Other\"\n)\n| order by SignIns desc",
              "size": 0,
              "title": "üîå Security Plugin Integration Activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "SecurityCopilotPlugins"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Security Copilot Failures Analysis\nlet SecurityCopilotApps = dynamic([\n    \"Security Copilot\",\n    \"Microsoft Security Copilot\",\n    \"Copilot for Security\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType != \"0\"\n| where AppDisplayName has_any (SecurityCopilotApps) or AppDisplayName contains \"Security Copilot\"\n| extend ErrorDescription = case(\n    ResultType == \"50126\", \"Invalid credentials\",\n    ResultType == \"50053\", \"Account locked\",\n    ResultType == \"53003\", \"Blocked by CA\",\n    ResultType == \"65001\", \"Consent required\",\n    ResultType == \"70011\", \"Invalid scope\",\n    ResultType == \"500011\", \"Resource not found\",\n    strcat(\"Error \", ResultType)\n)\n| summarize \n    FailureCount = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 10),\n    LastFailure = max(TimeGenerated)\n    by ResultType, ErrorDescription\n| order by FailureCount desc",
              "size": 0,
              "title": "‚ùå Security Copilot Failures",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "SecurityCopilotFailures"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Security Copilot Geolocation Map\nlet SecurityCopilotApps = dynamic([\n    \"Security Copilot\",\n    \"Microsoft Security Copilot\",\n    \"Copilot for Security\",\n    \"Microsoft Copilot for Security\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (SecurityCopilotApps) or AppDisplayName contains \"Security Copilot\"\n| where isnotempty(IPAddress) and IPAddress != \"127.0.0.1\"\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Latitude = toreal(GeoInfo.latitude)\n| extend Longitude = toreal(GeoInfo.longitude)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| where isnotempty(Latitude) and isnotempty(Longitude)\n| summarize \n    SignIns = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 5)\n    by Longitude, Latitude, Country, City\n| extend LocationLabel = strcat(City, \", \", Country, \" - \", SignIns, \" sign-ins\")",
              "size": 0,
              "title": "üó∫Ô∏è Security Copilot Sign-In Locations",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "map",
              "mapSettings": {
                "locInfo": "LatLong",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "SignIns",
                "sizeAggregation": "Sum",
                "labelSettings": "LocationLabel",
                "legendMetric": "SignIns",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "SignIns",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "name": "SecurityCopilotGeoMap"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Security Copilot Usage by Hour (Operational Patterns)\nlet SecurityCopilotApps = dynamic([\n    \"Security Copilot\",\n    \"Microsoft Security Copilot\",\n    \"Copilot for Security\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (SecurityCopilotApps) or AppDisplayName contains \"Security Copilot\"\n| extend Hour = datetime_part(\"Hour\", TimeGenerated)\n| extend DayOfWeek = dayofweek(TimeGenerated) / 1d\n| extend DayName = case(\n    DayOfWeek == 0, \"Sunday\",\n    DayOfWeek == 1, \"Monday\",\n    DayOfWeek == 2, \"Tuesday\",\n    DayOfWeek == 3, \"Wednesday\",\n    DayOfWeek == 4, \"Thursday\",\n    DayOfWeek == 5, \"Friday\",\n    \"Saturday\"\n)\n| summarize UsageCount = count() by DayName, Hour\n| order by Hour asc",
              "size": 0,
              "title": "üìÖ Security Copilot Usage Patterns (Day/Hour)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SecurityCopilotUsagePatterns"
          },
          {
            "type": 1,
            "content": {
              "json": "### üåê External AI Services (ChatGPT, Gemini, Claude)\n\nMonitor usage of external AI services accessed through your organization's identity. This helps track Shadow AI usage and ensure compliance with data governance policies.\n\n‚ö†Ô∏è **Security Note:** External AI services may pose data leakage risks. Monitor for sensitive data being shared with third-party AI platforms."
            },
            "name": "ExternalAIHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// External AI Services Sign-In Activity\nlet ExternalAIApps = dynamic([\n    \"ChatGPT\",\n    \"OpenAI\",\n    \"chat.openai.com\",\n    \"Gemini\",\n    \"Google Gemini\",\n    \"Bard\",\n    \"Google Bard\",\n    \"Claude\",\n    \"Anthropic\",\n    \"Perplexity\",\n    \"Copilot\",\n    \"Bing Chat\",\n    \"Microsoft Copilot\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (ExternalAIApps) \n    or AppDisplayName contains \"chatgpt\"\n    or AppDisplayName contains \"openai\"\n    or AppDisplayName contains \"gemini\"\n    or AppDisplayName contains \"claude\"\n    or AppDisplayName contains \"anthropic\"\n    or ResourceDisplayName has_any (ExternalAIApps)\n| summarize \n    TotalSignIns = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 15),\n    UniqueIPs = dcount(IPAddress),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by AppDisplayName, AppId\n| extend AIService = case(\n    AppDisplayName contains \"ChatGPT\" or AppDisplayName contains \"OpenAI\", \"ü§ñ ChatGPT/OpenAI\",\n    AppDisplayName contains \"Gemini\" or AppDisplayName contains \"Bard\", \"üíé Google Gemini\",\n    AppDisplayName contains \"Claude\" or AppDisplayName contains \"Anthropic\", \"üß† Claude/Anthropic\",\n    AppDisplayName contains \"Perplexity\", \"üîç Perplexity\",\n    \"üì¶ Other AI\"\n)\n| extend FailureRate = round(todouble(FailedCount) / TotalSignIns * 100, 2)\n| order by TotalSignIns desc",
              "size": 0,
              "title": "üåê External AI Services Sign-In Activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "ExternalAIActivity"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Users Accessing External AI Services\nlet ExternalAIApps = dynamic([\n    \"ChatGPT\",\n    \"OpenAI\",\n    \"Gemini\",\n    \"Google Gemini\",\n    \"Bard\",\n    \"Claude\",\n    \"Anthropic\",\n    \"Perplexity\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (ExternalAIApps) \n    or AppDisplayName contains \"chatgpt\"\n    or AppDisplayName contains \"openai\"\n    or AppDisplayName contains \"gemini\"\n    or AppDisplayName contains \"claude\"\n| summarize \n    SignIns = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    AIServices = make_set(AppDisplayName, 10),\n    UniqueServices = dcount(AppDisplayName),\n    UniqueIPs = dcount(IPAddress),\n    Locations = make_set(Location, 5),\n    FirstUsage = min(TimeGenerated),\n    LastUsage = max(TimeGenerated)\n    by UserPrincipalName\n| extend UsageLevel = case(\n    SignIns > 100, \"üî¥ Heavy User\",\n    SignIns > 20, \"üü† Regular User\",\n    SignIns > 5, \"üü° Occasional User\",\n    \"üü¢ Light User\"\n)\n| order by SignIns desc",
              "size": 0,
              "title": "üë§ Users Accessing External AI Services",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ExternalAIUsers"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// External AI Service Distribution\nlet ExternalAIApps = dynamic([\n    \"ChatGPT\",\n    \"OpenAI\",\n    \"Gemini\",\n    \"Bard\",\n    \"Claude\",\n    \"Anthropic\",\n    \"Perplexity\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (ExternalAIApps) \n    or AppDisplayName contains \"chatgpt\"\n    or AppDisplayName contains \"openai\"\n    or AppDisplayName contains \"gemini\"\n    or AppDisplayName contains \"claude\"\n| extend AIService = case(\n    AppDisplayName contains \"ChatGPT\" or AppDisplayName contains \"OpenAI\", \"ChatGPT/OpenAI\",\n    AppDisplayName contains \"Gemini\" or AppDisplayName contains \"Bard\", \"Google Gemini\",\n    AppDisplayName contains \"Claude\" or AppDisplayName contains \"Anthropic\", \"Claude/Anthropic\",\n    AppDisplayName contains \"Perplexity\", \"Perplexity\",\n    AppDisplayName\n)\n| summarize Count = count() by AIService\n| order by Count desc",
              "size": 2,
              "title": "üìä External AI Service Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "ExternalAIDistribution"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// External AI Usage Timeline\nlet ExternalAIApps = dynamic([\n    \"ChatGPT\",\n    \"OpenAI\",\n    \"Gemini\",\n    \"Bard\",\n    \"Claude\",\n    \"Anthropic\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (ExternalAIApps) \n    or AppDisplayName contains \"chatgpt\"\n    or AppDisplayName contains \"openai\"\n    or AppDisplayName contains \"gemini\"\n    or AppDisplayName contains \"claude\"\n| extend AIService = case(\n    AppDisplayName contains \"ChatGPT\" or AppDisplayName contains \"OpenAI\", \"ChatGPT/OpenAI\",\n    AppDisplayName contains \"Gemini\" or AppDisplayName contains \"Bard\", \"Google Gemini\",\n    AppDisplayName contains \"Claude\" or AppDisplayName contains \"Anthropic\", \"Claude/Anthropic\",\n    \"Other\"\n)\n| summarize Count = count() by bin(TimeGenerated, 1h), AIService\n| render timechart",
              "size": 0,
              "title": "üìà External AI Usage Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "name": "ExternalAITimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// ChatGPT Specific Activity\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName contains \"ChatGPT\" \n    or AppDisplayName contains \"OpenAI\"\n    or AppDisplayName == \"chat.openai.com\"\n| summarize \n    SignIns = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 20),\n    UniqueIPs = dcount(IPAddress),\n    Locations = make_set(Location, 10),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by AppDisplayName\n| extend FailureRate = round(todouble(FailedCount) / SignIns * 100, 2)\n| order by SignIns desc",
              "size": 0,
              "title": "ü§ñ ChatGPT/OpenAI Activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ChatGPTActivity"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Google Gemini Specific Activity\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName contains \"Gemini\" \n    or AppDisplayName contains \"Bard\"\n    or AppDisplayName contains \"Google AI\"\n| summarize \n    SignIns = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 20),\n    UniqueIPs = dcount(IPAddress),\n    Locations = make_set(Location, 10),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by AppDisplayName\n| extend FailureRate = round(todouble(FailedCount) / SignIns * 100, 2)\n| order by SignIns desc",
              "size": 0,
              "title": "üíé Google Gemini/Bard Activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "GeminiActivity"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// External AI Geographic Distribution\nlet ExternalAIApps = dynamic([\n    \"ChatGPT\",\n    \"OpenAI\",\n    \"Gemini\",\n    \"Bard\",\n    \"Claude\",\n    \"Anthropic\"\n]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (ExternalAIApps) \n    or AppDisplayName contains \"chatgpt\"\n    or AppDisplayName contains \"openai\"\n    or AppDisplayName contains \"gemini\"\n    or AppDisplayName contains \"claude\"\n| where isnotempty(IPAddress) and IPAddress != \"127.0.0.1\"\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Latitude = toreal(GeoInfo.latitude)\n| extend Longitude = toreal(GeoInfo.longitude)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| where isnotempty(Latitude) and isnotempty(Longitude)\n| summarize \n    SignIns = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    Services = make_set(AppDisplayName, 5)\n    by Longitude, Latitude, Country, City\n| extend LocationLabel = strcat(City, \", \", Country, \" - \", SignIns, \" sign-ins\")",
              "size": 0,
              "title": "üó∫Ô∏è External AI Usage Locations",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "map",
              "mapSettings": {
                "locInfo": "LatLong",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "SignIns",
                "sizeAggregation": "Sum",
                "labelSettings": "LocationLabel",
                "legendMetric": "SignIns",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "SignIns",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "name": "ExternalAIGeoMap"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// New Users Accessing External AI (Shadow AI Detection)\nlet ExternalAIApps = dynamic([\"ChatGPT\", \"OpenAI\", \"Gemini\", \"Bard\", \"Claude\", \"Anthropic\"]);\nlet BaselineUsers = AADNonInteractiveUserSignInLogs\n| where TimeGenerated between (ago(60d) .. ago(7d))\n| where AppDisplayName has_any (ExternalAIApps) or AppDisplayName contains \"chatgpt\" or AppDisplayName contains \"openai\" or AppDisplayName contains \"gemini\"\n| distinct UserPrincipalName;\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (ExternalAIApps) or AppDisplayName contains \"chatgpt\" or AppDisplayName contains \"openai\" or AppDisplayName contains \"gemini\" or AppDisplayName contains \"claude\"\n| join kind=leftanti (BaselineUsers) on UserPrincipalName\n| summarize \n    SignIns = count(),\n    AIServices = make_set(AppDisplayName, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated),\n    Locations = make_set(Location, 3)\n    by UserPrincipalName\n| extend Status = \"üÜï New AI User\"\n| order by SignIns desc",
              "size": 0,
              "title": "üÜï New Users Accessing External AI (Shadow AI Detection)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "NewExternalAIUsers"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// External AI Usage by Department (if UPN contains dept info)\nlet ExternalAIApps = dynamic([\"ChatGPT\", \"OpenAI\", \"Gemini\", \"Bard\", \"Claude\", \"Anthropic\"]);\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName has_any (ExternalAIApps) or AppDisplayName contains \"chatgpt\" or AppDisplayName contains \"openai\" or AppDisplayName contains \"gemini\" or AppDisplayName contains \"claude\"\n| extend Domain = tostring(split(UserPrincipalName, \"@\")[1])\n| summarize \n    SignIns = count(),\n    UniqueUsers = dcount(UserPrincipalName),\n    Users = make_set(UserPrincipalName, 10),\n    AIServices = make_set(AppDisplayName, 5)\n    by Domain\n| order by SignIns desc",
              "size": 0,
              "title": "üè¢ External AI Usage by Domain",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "ExternalAIByDomain"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "aiagents"
      },
      "name": "AIAgentsGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üï∏Ô∏è Botnet & Token Theft Detection\n---\nIdentify patterns indicative of token theft, credential stuffing, and coordinated attacks targeting non-interactive authentication flows.\n\n**Key Indicators:**\n- üî¥ Same user token from multiple countries/IPs simultaneously\n- üî¥ High-volume token refresh from single IP targeting multiple users\n- üü† Unusual app-to-resource access patterns\n- üü† Time-clustered authentication bursts\n\n---"
            },
            "name": "BotnetHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Token Theft Detection - Same user from multiple countries/IPs\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| extend LocationData = parse_json(LocationDetails)\n| extend Country = tostring(LocationData.countryOrRegion)\n| where Country != ''\n| summarize \n    Countries = make_set(Country, 10),\n    CountryCount = dcount(Country),\n    IPs = make_set(IPAddress, 10),\n    IPCount = dcount(IPAddress),\n    Apps = make_set(AppDisplayName, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated),\n    TotalEvents = count()\n    by UserPrincipalName\n| extend TimeSpanMinutes = datetime_diff('minute', LastSeen, FirstSeen)\n| where CountryCount >= 2 and TimeSpanMinutes <= 120\n| extend RiskLevel = case(\n    CountryCount >= 5, 'üî¥ Critical - Token Compromised',\n    CountryCount >= 3 and TimeSpanMinutes <= 30, 'üî¥ High - Impossible Travel',\n    CountryCount >= 2, 'üü° Medium - Investigate',\n    'üü° Review'\n)\n| project UserPrincipalName, RiskLevel, CountryCount, Countries, IPCount, TimeSpanMinutes, Apps, TotalEvents\n| order by CountryCount desc, TimeSpanMinutes asc\n| take 20",
              "size": 0,
              "title": "üåç Token Theft Detection - Geographic Impossibility",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "TokenTheftGeo"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Credential Stuffing Detection - Single IP targeting multiple users\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where IPAddress != ''\n| summarize \n    UniqueUsers = dcount(UserPrincipalName),\n    UserList = make_set(UserPrincipalName, 10),\n    TotalAttempts = count(),\n    FailedAttempts = countif(ResultType != '0'),\n    UniqueApps = dcount(AppDisplayName),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by IPAddress\n| where UniqueUsers >= 5 or (FailedAttempts > 100 and UniqueUsers >= 2)\n| extend FailureRate = round(todouble(FailedAttempts) / todouble(TotalAttempts) * 100.0, 1)\n| extend AttackPattern = case(\n    UniqueUsers >= 20 and FailureRate > 50.0, 'üî¥ Critical - Mass Credential Stuffing',\n    UniqueUsers >= 10, 'üî¥ High - Multi-User Attack',\n    FailureRate > 80.0, 'üü† Medium - Brute Force',\n    'üü° Suspicious Activity'\n)\n| extend IsInternal = ipv4_is_private(IPAddress)\n| project IPAddress, IsInternal, AttackPattern, UniqueUsers, TotalAttempts, FailedAttempts, FailureRate, UniqueApps\n| order by UniqueUsers desc, FailedAttempts desc\n| take 20",
              "size": 0,
              "title": "üéØ Credential Stuffing Detection - IP Analysis",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "CredentialStuffing"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Time-Clustered Attack Detection\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| summarize EventCount = count() by bin(TimeGenerated, 1m), AppDisplayName\n| where EventCount > 100\n| summarize \n    Spikes = count(),\n    MaxEventsPerMinute = max(EventCount),\n    AvgEventsPerMinute = avg(EventCount),\n    FirstSpike = min(TimeGenerated),\n    LastSpike = max(TimeGenerated)\n    by AppDisplayName\n| where Spikes >= 3 or MaxEventsPerMinute > 500\n| extend AttackType = case(\n    MaxEventsPerMinute > 1000, 'üî¥ Critical - DDoS Pattern',\n    MaxEventsPerMinute > 500, 'üü† High - Burst Attack',\n    'üü° Unusual Volume'\n)\n| project AppDisplayName, AttackType, Spikes, MaxEventsPerMinute, AvgEventsPerMinute, FirstSpike, LastSpike\n| order by MaxEventsPerMinute desc",
              "size": 0,
              "title": "‚è±Ô∏è Time-Clustered Attack Detection",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "TimeClusterAttack"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Suspicious App Behavior - Apps with anomalous patterns\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| summarize \n    TotalEvents = count(),\n    FailedEvents = countif(ResultType != '0'),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueIPs = dcount(IPAddress),\n    Countries = dcount(tostring(parse_json(LocationDetails).countryOrRegion))\n    by AppDisplayName, AppId\n| where TotalEvents > 100\n| extend FailureRate = round(todouble(FailedEvents) / todouble(TotalEvents) * 100.0, 1)\n| extend UsersPerIP = round(todouble(UniqueUsers) / todouble(UniqueIPs), 1)\n| extend RiskScore = (iff(FailureRate > 50.0, 30.0, 0.0) + iff(Countries > 10, 20.0, 0.0) + iff(UsersPerIP > 10.0, 20.0, 0.0) + iff(UniqueIPs > 100, 15.0, 0.0))\n| where RiskScore > 0\n| extend RiskLevel = case(\n    RiskScore >= 50.0, 'üî¥ High Risk',\n    RiskScore >= 30.0, 'üü† Medium Risk',\n    'üü° Review'\n)\n| project AppDisplayName, RiskLevel, RiskScore, FailureRate, UniqueUsers, UniqueIPs, Countries, UsersPerIP\n| order by RiskScore desc\n| take 20",
              "size": 0,
              "title": "üì± Suspicious App Behavior Analysis",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SuspiciousApps"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Botnet Timeline - Hourly attack patterns\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType != '0'\n| summarize FailedEvents = count(), UniqueUsers = dcount(UserPrincipalName), UniqueIPs = dcount(IPAddress) by bin(TimeGenerated, 1h)\n| project TimeGenerated, FailedEvents, UniqueUsers, UniqueIPs\n| render timechart",
              "size": 0,
              "title": "üìä Attack Pattern Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "name": "BotnetTimeline"
          },
          {
            "type": 1,
            "content": {
              "json": "### üï∏Ô∏è Botnet Indicators Reference\n\n| Pattern | Indicator | Threshold | Response |\n|---------|-----------|-----------|----------|\n| **Token Theft** | User tokens from multiple countries | ‚â•2 countries in 2 hours | Revoke all sessions |\n| **Credential Stuffing** | Single IP targeting many users | ‚â•5 users from 1 IP | Block IP |\n| **Token Replay** | Same token used from different IPs | Multiple IPs, short time | Revoke tokens |\n| **Burst Attack** | High volume in short time | >500 events/minute | Rate limit |\n| **App Abuse** | Unusual app-to-user ratio | >10 users per IP | Review app permissions |"
            },
            "name": "BotnetReference"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "botnet"
      },
      "name": "BotnetGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üõ†Ô∏è Remediation Actions\n---\nIdentify and remediate compromised users and suspicious apps. Select entities from the tables below and **trigger playbooks directly** from this workbook.\n\n### ‚öôÔ∏è Playbook Configuration\nConfigure the parameters below to point to your deployed Logic App playbooks. See the [Sentinel-Remediation-Playbooks](https://github.com/Azure/Azure-Sentinel/tree/master/Playbooks) for ARM templates.\n\n---"
            },
            "name": "RemediationHeader"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "remediation-subscription",
                  "version": "KqlParameterItem/1.0",
                  "name": "RemediationSubscription",
                  "type": 1,
                  "isRequired": true,
                  "value": "your-subscription-id",
                  "label": "Subscription ID",
                  "description": "Azure Subscription ID where playbooks are deployed"
                },
                {
                  "id": "playbook-rg",
                  "version": "KqlParameterItem/1.0",
                  "name": "PlaybookResourceGroup",
                  "type": 1,
                  "isRequired": true,
                  "value": "rg-sentinel-playbooks",
                  "label": "Playbook Resource Group",
                  "description": "Resource group containing the Logic App playbooks"
                }
              ],
              "style": "pills",
              "queryType": 0
            },
            "name": "PlaybookConfigParams"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üë§ User Remediation"
            },
            "name": "UserRemediationHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// High-Risk Users - Click row to select\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| extend LocationData = parse_json(LocationDetails)\n| extend Country = tostring(LocationData.countryOrRegion)\n| summarize \n    TotalEvents = count(),\n    FailedEvents = countif(ResultType != '0'),\n    Countries = dcount(Country),\n    CountryList = make_set(Country, 5),\n    IPs = dcount(IPAddress),\n    IPList = make_set(IPAddress, 5),\n    Apps = dcount(AppDisplayName),\n    LastSeen = max(TimeGenerated)\n    by UserPrincipalName, UserId\n| where Countries >= 2 or IPs >= 5 or FailedEvents > 50\n| extend FailureRate = round(todouble(FailedEvents) / todouble(TotalEvents) * 100.0, 1)\n| extend RiskLevel = case(\n    Countries >= 3 or IPs >= 10, 'üî¥ Critical',\n    FailureRate > 50.0, 'üî¥ High',\n    Countries >= 2 or IPs >= 5, 'üü° Medium',\n    'üü° Low'\n)\n| project UserPrincipalName, UserId, RiskLevel, Countries, CountryList, IPs, FailedEvents, FailureRate, Apps, LastSeen\n| order by Countries desc, IPs desc\n| take 30",
              "size": 0,
              "title": "üë§ High-Risk Users - Click row to select for remediation",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 30,
                "filter": true
              },
              "exportFieldName": "UserId",
              "exportParameterName": "SelectedUserId",
              "exportDefaultValue": ""
            },
            "name": "HighRiskUsers"
          },
          {
            "type": 1,
            "content": {
              "json": "#### Selected User: **{SelectedUserDisplay}** (ID: `{SelectedUserId}`)\n\n> üéØ Click the action buttons below to trigger remediation playbooks directly."
            },
            "conditionalVisibility": {
              "parameterName": "SelectedUserId",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "SelectedUserHeader"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "revokeUserSessions",
                  "cellValue": "{SelectedUserId}",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üîê Revoke All Sessions",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "/subscriptions/{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Revoke-UserSessions/triggers/manual/run?api-version=2016-10-01",
                    "httpMethod": "POST",
                    "body": "{ \"userId\": \"{SelectedUserId}\", \"userPrincipalName\": \"{SelectedUserDisplay}\" }",
                    "title": "Revoke User Sessions",
                    "description": "This will revoke all refresh tokens for user {SelectedUserDisplay}. The user will need to re-authenticate on all devices.",
                    "actionName": "Revoke Sessions",
                    "runLabel": "Revoke Sessions"
                  }
                },
                {
                  "id": "resetUserPassword",
                  "cellValue": "{SelectedUserId}",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üîë Reset Password",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "/subscriptions/{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Reset-UserPassword/triggers/manual/run?api-version=2016-10-01",
                    "httpMethod": "POST",
                    "body": "{ \"userId\": \"{SelectedUserId}\", \"userPrincipalName\": \"{SelectedUserDisplay}\" }",
                    "title": "Reset User Password",
                    "description": "This will generate a new random password for user {SelectedUserDisplay} and require password change at next login.",
                    "actionName": "Reset Password",
                    "runLabel": "Reset Password"
                  }
                },
                {
                  "id": "disableUserAccount",
                  "cellValue": "{SelectedUserId}",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üö´ Disable Account",
                  "style": "secondary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "/subscriptions/{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Disable-UserAccount/triggers/manual/run?api-version=2016-10-01",
                    "httpMethod": "POST",
                    "body": "{ \"userId\": \"{SelectedUserId}\", \"userPrincipalName\": \"{SelectedUserDisplay}\" }",
                    "title": "Disable User Account",
                    "description": "This will disable the account for user {SelectedUserDisplay}, blocking all sign-ins.",
                    "actionName": "Disable Account",
                    "runLabel": "Disable Account"
                  }
                },
                {
                  "id": "resetUserMFA",
                  "cellValue": "{SelectedUserId}",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üì± Reset MFA",
                  "style": "secondary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "/subscriptions/{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Reset-UserMFA/triggers/manual/run?api-version=2016-10-01",
                    "httpMethod": "POST",
                    "body": "{ \"userId\": \"{SelectedUserId}\", \"userPrincipalName\": \"{SelectedUserDisplay}\" }",
                    "title": "Reset User MFA",
                    "description": "This will require user {SelectedUserDisplay} to re-register their MFA methods at next sign-in.",
                    "actionName": "Reset MFA",
                    "runLabel": "Reset MFA"
                  }
                },
                {
                  "id": "confirmCompromised",
                  "cellValue": "{SelectedUserId}",
                  "linkTarget": "ArmAction",
                  "linkLabel": "‚ö†Ô∏è Confirm Compromised",
                  "style": "secondary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "/subscriptions/{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Confirm-UserCompromised/triggers/manual/run?api-version=2016-10-01",
                    "httpMethod": "POST",
                    "body": "{ \"userId\": \"{SelectedUserId}\", \"userPrincipalName\": \"{SelectedUserDisplay}\" }",
                    "title": "Confirm User Compromised",
                    "description": "This will mark user {SelectedUserDisplay} as compromised in Identity Protection, triggering risk-based policies.",
                    "actionName": "Confirm Compromised",
                    "runLabel": "Confirm Compromised"
                  }
                },
                {
                  "id": "fullRemediation",
                  "cellValue": "{SelectedUserId}",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üõ°Ô∏è Full Remediation (Revoke + Reset + MFA)",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "/subscriptions/{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Full-UserRemediation/triggers/manual/run?api-version=2016-10-01",
                    "httpMethod": "POST",
                    "body": "{ \"userId\": \"{SelectedUserId}\", \"userPrincipalName\": \"{SelectedUserDisplay}\" }",
                    "title": "Full User Remediation",
                    "description": "This will perform complete remediation for user {SelectedUserDisplay}: revoke sessions, reset password, and require MFA re-registration.",
                    "actionName": "Full Remediation",
                    "runLabel": "Execute Full Remediation"
                  }
                },
                {
                  "id": "openUserInEntra",
                  "cellValue": "https://portal.azure.com/#view/Microsoft_AAD_UsersAndTenants/UserProfileMenuBlade/~/overview/userId/{SelectedUserId}",
                  "linkTarget": "Url",
                  "linkLabel": "üìã Open in Portal",
                  "style": "secondary"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "SelectedUserId",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "UserActionLinks"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Suspicious Apps - Click row to select\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| summarize \n    TotalEvents = count(),\n    FailedEvents = countif(ResultType != '0'),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueIPs = dcount(IPAddress),\n    Countries = dcount(tostring(parse_json(LocationDetails).countryOrRegion)),\n    LastSeen = max(TimeGenerated)\n    by AppDisplayName, AppId\n| where TotalEvents > 100\n| extend FailureRate = round(todouble(FailedEvents) / todouble(TotalEvents) * 100.0, 1)\n| where FailureRate > 20.0 or Countries > 10 or UniqueIPs > 50\n| extend RiskLevel = case(\n    FailureRate > 50.0, 'üî¥ Critical',\n    Countries > 20, 'üî¥ High',\n    FailureRate > 30.0, 'üü° Medium',\n    'üü° Review'\n)\n| project AppDisplayName, AppId, RiskLevel, FailureRate, FailedEvents, UniqueUsers, UniqueIPs, Countries, LastSeen\n| order by FailureRate desc\n| take 30",
              "size": 0,
              "title": "üì± Suspicious Apps - Click row to select for investigation",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 30,
                "filter": true
              },
              "exportFieldName": "AppId",
              "exportParameterName": "SelectedAppId",
              "exportDefaultValue": ""
            },
            "name": "SuspiciousApps"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "selectedAppDisplay",
                  "version": "KqlParameterItem/1.0",
                  "name": "SelectedAppDisplay",
                  "type": 1,
                  "query": "AADNonInteractiveUserSignInLogs\n| where AppId == '{SelectedAppId}'\n| take 1\n| project AppDisplayName",
                  "isHiddenWhenLocked": false,
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                }
              ],
              "style": "above",
              "queryType": 0
            },
            "conditionalVisibility": {
              "parameterName": "SelectedAppId",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "SelectedAppParams"
          },
          {
            "type": 1,
            "content": {
              "json": "#### Selected App: **{SelectedAppDisplay}** (ID: `{SelectedAppId}`)\n\n> üéØ Click the action buttons below to trigger app remediation playbooks."
            },
            "conditionalVisibility": {
              "parameterName": "SelectedAppId",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "SelectedAppHeader"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "disableServicePrincipal",
                  "cellValue": "{SelectedAppId}",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üö´ Disable Service Principal",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "/subscriptions/{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Disable-ServicePrincipal/triggers/manual/run?api-version=2016-10-01",
                    "httpMethod": "POST",
                    "body": "{ \"appId\": \"{SelectedAppId}\", \"appDisplayName\": \"{SelectedAppDisplay}\" }",
                    "title": "Disable Service Principal",
                    "description": "This will disable the service principal for {SelectedAppDisplay}, blocking all authentications.",
                    "actionName": "Disable App",
                    "runLabel": "Disable Service Principal"
                  }
                },
                {
                  "id": "rotateAppCredentials",
                  "cellValue": "{SelectedAppId}",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üîë Rotate Credentials",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "/subscriptions/{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Rotate-SPCredentials/triggers/manual/run?api-version=2016-10-01",
                    "httpMethod": "POST",
                    "body": "{ \"appId\": \"{SelectedAppId}\", \"appDisplayName\": \"{SelectedAppDisplay}\" }",
                    "title": "Rotate App Credentials",
                    "description": "This will generate new credentials for {SelectedAppDisplay} and invalidate old ones.",
                    "actionName": "Rotate Credentials",
                    "runLabel": "Rotate Credentials"
                  }
                },
                {
                  "id": "revokeAppPermissions",
                  "cellValue": "{SelectedAppId}",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üîê Revoke Permissions",
                  "style": "secondary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "/subscriptions/{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Revoke-SPPermissions/triggers/manual/run?api-version=2016-10-01",
                    "httpMethod": "POST",
                    "body": "{ \"appId\": \"{SelectedAppId}\", \"appDisplayName\": \"{SelectedAppDisplay}\" }",
                    "title": "Revoke App Permissions",
                    "description": "This will revoke all delegated and application permissions for {SelectedAppDisplay}.",
                    "actionName": "Revoke Permissions",
                    "runLabel": "Revoke Permissions"
                  }
                },
                {
                  "id": "openAppRegistration",
                  "cellValue": "https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/ApplicationMenuBlade/~/Overview/appId/{SelectedAppId}",
                  "linkTarget": "Url",
                  "linkLabel": "üìã Open in Portal",
                  "style": "secondary"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "SelectedAppId",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "AppActionLinks"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üåê IP Address Remediation"
            },
            "name": "IPRemediationHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// High-Risk IPs - Click row to select\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {TimeRange}\n| extend Country = tostring(parse_json(LocationDetails).countryOrRegion)\n| where IPAddress != ''\n| summarize \n    TotalAttempts = count(),\n    FailedAttempts = countif(ResultType != '0'),\n    SuccessfulAttempts = countif(ResultType == '0'),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueApps = dcount(AppDisplayName),\n    Countries = make_set_if(Country, Country != '', 3),\n    LastSeen = max(TimeGenerated)\n    by IPAddress\n| where FailedAttempts > 20 or (SuccessfulAttempts > 0 and FailedAttempts > 10)\n| extend ThreatScore = (FailedAttempts / 10) + (UniqueUsers * 5) + iif(SuccessfulAttempts > 0 and FailedAttempts > 10, 50, 0)\n| extend ThreatLevel = case(\n    SuccessfulAttempts > 0 and FailedAttempts > 10, 'üî¥ CRITICAL',\n    UniqueUsers > 10, 'üî¥ HIGH',\n    FailedAttempts > 100, 'üü† MEDIUM',\n    'üü° LOW'\n)\n| project ThreatLevel, IPAddress, ThreatScore, FailedAttempts, SuccessfulAttempts, UniqueUsers, UniqueApps, Countries, LastSeen\n| order by ThreatScore desc\n| take 20",
              "size": 0,
              "title": "üåê High-Risk IPs - Click row to select for remediation",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 20,
                "filter": true
              },
              "exportFieldName": "IPAddress",
              "exportParameterName": "SelectedRemediationIP",
              "exportDefaultValue": ""
            },
            "name": "HighRiskIPs"
          },
          {
            "type": 1,
            "content": {
              "json": "#### Selected IP: **{SelectedRemediationIP}**\n\n> üéØ Click the action buttons below to block this IP address."
            },
            "conditionalVisibility": {
              "parameterName": "SelectedRemediationIP",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "SelectedIPHeader"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "blockIP",
                  "cellValue": "{SelectedRemediationIP}",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üö´ Block IP Address",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "/subscriptions/{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Block-IPAddress/triggers/manual/run?api-version=2016-10-01",
                    "httpMethod": "POST",
                    "body": "{ \"ipAddress\": \"{SelectedRemediationIP}\" }",
                    "title": "Block IP Address",
                    "description": "This will add IP {SelectedRemediationIP} to the blocked Named Locations in Conditional Access.",
                    "actionName": "Block IP",
                    "runLabel": "Block IP Address"
                  }
                },
                {
                  "id": "enrichIP",
                  "cellValue": "{SelectedRemediationIP}",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üîç Enrich IP (Threat Intel)",
                  "style": "secondary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "/subscriptions/{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Enrich-IPAddress/triggers/manual/run?api-version=2016-10-01",
                    "httpMethod": "POST",
                    "body": "{ \"ipAddress\": \"{SelectedRemediationIP}\" }",
                    "title": "Enrich IP Address",
                    "description": "This will query threat intelligence sources for IP {SelectedRemediationIP} and return reputation data.",
                    "actionName": "Enrich IP",
                    "runLabel": "Enrich IP"
                  }
                },
                {
                  "id": "openNamedLocations",
                  "cellValue": "https://portal.azure.com/#view/Microsoft_AAD_ConditionalAccess/ConditionalAccessBlade/~/NamedLocations",
                  "linkTarget": "Url",
                  "linkLabel": "üìã Open Named Locations",
                  "style": "secondary"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "SelectedRemediationIP",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "IPActionLinks"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üöÄ Quick Access Links\n\n| Resource | Description | Link |\n|----------|-------------|------|\n| **Entra ID Users** | Manage user accounts | [Open Users](https://portal.azure.com/#view/Microsoft_AAD_IAM/UsersManagementMenuBlade/~/AllUsers) |\n| **App Registrations** | Manage applications | [Open Apps](https://portal.azure.com/#view/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/~/RegisteredApps) |\n| **Risky Users** | Identity Protection | [Open Risky Users](https://portal.azure.com/#view/Microsoft_AAD_IAM/IdentityProtectionMenuBlade/~/RiskyUsers) |\n| **Risky Sign-ins** | View risky sign-ins | [Open Risky Sign-ins](https://portal.azure.com/#view/Microsoft_AAD_IAM/IdentityProtectionMenuBlade/~/RiskySignIns) |\n| **Conditional Access** | Access policies | [Open CA](https://portal.azure.com/#view/Microsoft_AAD_ConditionalAccess/ConditionalAccessBlade/~/Overview) |\n| **Named Locations** | Trusted/blocked IPs | [Open Locations](https://portal.azure.com/#view/Microsoft_AAD_ConditionalAccess/ConditionalAccessBlade/~/NamedLocations) |\n| **Token Lifetime** | Configure token policies | [Open Policies](https://portal.azure.com/#view/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/~/AuthenticationMethodsPolicy) |"
            },
            "name": "QuickAccessLinks"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Recent User Remediation Actions\nAuditLogs\n| where TimeGenerated {TimeRange}\n| where OperationName in (\n    'Revoke all refresh tokens for a user',\n    'Reset password (by admin)',\n    'Disable account',\n    'Update user',\n    'Confirm compromised user'\n)\n| extend Actor = coalesce(tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName), 'System')\n| extend Target = coalesce(tostring(TargetResources[0].userPrincipalName), tostring(TargetResources[0].displayName))\n| project TimeGenerated, OperationName, Actor, Target, Result\n| order by TimeGenerated desc\n| take 30",
              "size": 0,
              "title": "üìã Recent Remediation Actions",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "RecentRemediations"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "remediation"
      },
      "name": "RemediationGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üîç Forensic Investigation Center\n---\n### Deep-Dive Analysis for Security Investigations\n\nThis tab provides comprehensive forensic capabilities for investigating non-interactive sign-in activity:\n- **üë§ Users** - Complete user token activity timeline and risk analysis\n- **üåê IP Addresses** - Source IP reputation and activity mapping\n- **üì± Applications** - App authentication deep investigation\n- **üíª Devices** - Device-based token usage analysis\n\n> üí° **Tip:** Each section below has its own search filter. Enter the entity identifier and click a row to investigate.\n\n---"
            },
            "name": "ForensicHeader"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "forensic-timerange",
                  "version": "KqlParameterItem/1.0",
                  "name": "ForensicTimeRange",
                  "type": 4,
                  "isRequired": true,
                  "value": {
                    "durationMs": 604800000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {"durationMs": 86400000, "displayName": "Last 24 hours"},
                      {"durationMs": 259200000, "displayName": "Last 3 days"},
                      {"durationMs": 604800000, "displayName": "Last 7 days"},
                      {"durationMs": 1209600000, "displayName": "Last 14 days"},
                      {"durationMs": 2592000000, "displayName": "Last 30 days"}
                    ]
                  },
                  "label": "Investigation Period"
                }
              ],
              "style": "pills",
              "queryType": 0
            },
            "name": "ForensicTimeParameters"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n## üë§ User Investigation\n\nComprehensive analysis of user token refresh behavior, risk indicators, and activity timeline."
            },
            "name": "UserForensicHeader"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "user-search-filter",
                  "version": "KqlParameterItem/1.0",
                  "name": "UserSearchFilter",
                  "type": 1,
                  "isRequired": false,
                  "value": "",
                  "label": "üîç Search User (UPN or ID)",
                  "description": "Enter user principal name or object ID to search"
                }
              ],
              "style": "pills",
              "queryType": 0
            },
            "name": "UserSearchParams"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// User Quick Search Results - Click to select\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where '{UserSearchFilter}' == '' or UserPrincipalName contains '{UserSearchFilter}' or UserId == '{UserSearchFilter}'\n| extend Country = tostring(parse_json(LocationDetails).countryOrRegion)\n| summarize \n    TotalEvents = count(),\n    FailedEvents = countif(ResultType != '0'),\n    UniqueIPs = dcount(IPAddress),\n    UniqueApps = dcount(AppDisplayName),\n    UniqueCountries = dcount(Country),\n    LastSeen = max(TimeGenerated)\n    by UserPrincipalName, UserId\n| extend FailureRate = round(todouble(FailedEvents) / TotalEvents * 100, 1)\n| extend RiskLevel = case(\n    UniqueCountries >= 3, 'üî¥ HIGH',\n    UniqueIPs >= 10, 'üü† MEDIUM',\n    FailureRate > 30, 'üü° ELEVATED',\n    'üü¢ NORMAL'\n)\n| project RiskLevel, UserPrincipalName, UserId, TotalEvents, FailedEvents, FailureRate, UniqueIPs, UniqueApps, UniqueCountries, LastSeen\n| order by TotalEvents desc\n| take 20",
              "size": 0,
              "title": "üë§ Users - Click row to investigate",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 20,
                "filter": true
              },
              "exportFieldName": "UserPrincipalName",
              "exportParameterName": "SelectedForensicUser",
              "exportDefaultValue": ""
            },
            "name": "UserSearchResults"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìä Investigating User: **{SelectedForensicUser}**"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicUser",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "SelectedUserHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// User Profile Summary\nlet targetUser = '{SelectedForensicUser}';\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where UserPrincipalName =~ targetUser or UserId == targetUser\n| extend Country = tostring(parse_json(LocationDetails).countryOrRegion)\n| summarize \n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated),\n    TotalEvents = count(),\n    SuccessfulEvents = countif(ResultType == '0'),\n    FailedEvents = countif(ResultType != '0'),\n    UniqueIPs = dcount(IPAddress),\n    UniqueApps = dcount(AppDisplayName),\n    UniqueCountries = dcount(Country),\n    Countries = make_set(Country, 10),\n    TopIPs = make_set(IPAddress, 5),\n    TopApps = make_set(AppDisplayName, 5)\n    by UserPrincipalName, UserId\n| extend FailureRate = round(todouble(FailedEvents) / TotalEvents * 100, 1)\n| extend RiskIndicator = case(\n    UniqueCountries >= 3, 'üî¥ TOKEN THEFT RISK',\n    UniqueIPs >= 10, 'üü† DISTRIBUTED ACCESS',\n    FailureRate > 50, 'üü° HIGH FAILURES',\n    'üü¢ NORMAL'\n)\n| project \n    UserPrincipalName, UserId, RiskIndicator,\n    FirstSeen, LastSeen,\n    TotalEvents, SuccessfulEvents, FailedEvents, FailureRate,\n    UniqueIPs, UniqueApps, UniqueCountries,\n    Countries, TopIPs, TopApps",
              "size": 0,
              "title": "üë§ User Profile Summary",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "RiskIndicator",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {"operator": "contains", "thresholdValue": "THEFT", "representation": "red", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "DISTRIBUTED", "representation": "orange", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "FAILURES", "representation": "yellow", "text": "{0}"},
                        {"operator": "Default", "representation": "green", "text": "{0}"}
                      ]
                    }
                  },
                  {
                    "columnMatch": "FailureRate",
                    "formatter": 4,
                    "formatOptions": {"palette": "redGreen", "min": 0, "max": 100}
                  }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicUser",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "UserProfileSummary"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// User Activity Timeline\nlet targetUser = '{SelectedForensicUser}';\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where UserPrincipalName =~ targetUser or UserId == targetUser\n| summarize \n    Success = countif(ResultType == '0'),\n    Failed = countif(ResultType != '0')\n    by bin(TimeGenerated, 1h)\n| render timechart",
              "size": 0,
              "title": "üìà User Token Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicUser",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "UserActivityTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// User App Usage Distribution\nlet targetUser = '{SelectedForensicUser}';\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where UserPrincipalName =~ targetUser or UserId == targetUser\n| summarize Count = count() by AppDisplayName\n| order by Count desc\n| take 10",
              "size": 2,
              "title": "üì± App Usage Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicUser",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "UserAppDistribution"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// User Event Details\nlet targetUser = '{SelectedForensicUser}';\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where UserPrincipalName =~ targetUser or UserId == targetUser\n| extend Country = tostring(parse_json(LocationDetails).countryOrRegion)\n| extend City = tostring(parse_json(LocationDetails).city)\n| extend Status = case(ResultType == '0', '‚úÖ Success', '‚ùå Failed')\n| project \n    TimeGenerated,\n    Status,\n    AppDisplayName,\n    IPAddress,\n    Country,\n    City,\n    ResultType,\n    ResultDescription\n| order by TimeGenerated desc\n| take 100",
              "size": 0,
              "title": "üìù User Token Event Details",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {"operator": "contains", "thresholdValue": "Success", "representation": "green", "text": "{0}"},
                        {"operator": "Default", "representation": "red", "text": "{0}"}
                      ]
                    }
                  }
                ],
                "filter": true
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicUser",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "UserEventDetails"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n## üåê IP Address Investigation\n\nAnalyze source IP reputation, associated users, and attack patterns."
            },
            "name": "IPForensicHeader"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "ip-search-filter",
                  "version": "KqlParameterItem/1.0",
                  "name": "IPSearchFilter",
                  "type": 1,
                  "isRequired": false,
                  "value": "",
                  "label": "üîç Search IP Address",
                  "description": "Enter IP address to investigate"
                }
              ],
              "style": "pills",
              "queryType": 0
            },
            "name": "IPSearchParams"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// IP Quick Search Results - Click to select\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where IPAddress != ''\n| where '{IPSearchFilter}' == '' or IPAddress contains '{IPSearchFilter}'\n| extend Country = tostring(parse_json(LocationDetails).countryOrRegion)\n| summarize \n    TotalAttempts = count(),\n    FailedAttempts = countif(ResultType != '0'),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueApps = dcount(AppDisplayName),\n    Countries = make_set_if(Country, Country != '', 3),\n    LastSeen = max(TimeGenerated)\n    by IPAddress\n| extend FailureRate = round(todouble(FailedAttempts) / TotalAttempts * 100, 1)\n| extend ThreatLevel = case(\n    FailureRate > 80 and FailedAttempts > 50, 'üî¥ ATTACK',\n    UniqueUsers > 20, 'üü† SPRAY',\n    FailedAttempts > 50, 'üü° ELEVATED',\n    'üü¢ NORMAL'\n)\n| project ThreatLevel, IPAddress, TotalAttempts, FailedAttempts, FailureRate, UniqueUsers, UniqueApps, Countries, LastSeen\n| order by TotalAttempts desc\n| take 20",
              "size": 0,
              "title": "üåê IP Addresses - Click row to investigate",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 20,
                "filter": true
              },
              "exportFieldName": "IPAddress",
              "exportParameterName": "SelectedForensicIP",
              "exportDefaultValue": ""
            },
            "name": "IPSearchResults"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìä Investigating IP: **{SelectedForensicIP}**"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicIP",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "SelectedIPHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// IP Address Profile\nlet targetIP = '{SelectedForensicIP}';\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where IPAddress == targetIP\n| extend Country = tostring(parse_json(LocationDetails).countryOrRegion)\n| summarize \n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated),\n    TotalEvents = count(),\n    SuccessfulEvents = countif(ResultType == '0'),\n    FailedEvents = countif(ResultType != '0'),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueApps = dcount(AppDisplayName),\n    Countries = make_set(Country, 5),\n    TopUsers = make_set(UserPrincipalName, 5),\n    TopApps = make_set(AppDisplayName, 5)\n    by IPAddress\n| extend FailureRate = round(todouble(FailedEvents) / TotalEvents * 100, 1)\n| extend ThreatLevel = case(\n    SuccessfulEvents > 0 and FailedEvents > 20, 'üî¥ COMPROMISED SOURCE',\n    UniqueUsers > 10, 'üî¥ TOKEN THEFT',\n    FailureRate > 80, 'üü† ATTACK SOURCE',\n    FailureRate > 50, 'üü° SUSPICIOUS',\n    'üü¢ NORMAL'\n)\n| project \n    IPAddress, ThreatLevel,\n    FirstSeen, LastSeen,\n    TotalEvents, SuccessfulEvents, FailedEvents, FailureRate,\n    UniqueUsers, UniqueApps,\n    Countries, TopUsers, TopApps",
              "size": 0,
              "title": "üåê IP Address Profile",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "ThreatLevel",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {"operator": "contains", "thresholdValue": "COMPROMISED", "representation": "red", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "THEFT", "representation": "red", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "ATTACK", "representation": "orange", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "SUSPICIOUS", "representation": "yellow", "text": "{0}"},
                        {"operator": "Default", "representation": "green", "text": "{0}"}
                      ]
                    }
                  },
                  {
                    "columnMatch": "FailureRate",
                    "formatter": 4,
                    "formatOptions": {"palette": "redGreen", "min": 0, "max": 100}
                  }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicIP",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "IPProfile"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Users accessing from this IP\nlet targetIP = '{SelectedForensicIP}';\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where IPAddress == targetIP\n| summarize \n    TokenEvents = count(),\n    Failed = countif(ResultType != '0'),\n    Successful = countif(ResultType == '0'),\n    LastSeen = max(TimeGenerated),\n    Apps = dcount(AppDisplayName)\n    by UserPrincipalName\n| extend Status = case(\n    Successful > 0 and Failed > 10, 'üî¥ COMPROMISED',\n    Failed > 20, 'üü† TARGETED',\n    'üü¢ NORMAL'\n)\n| order by TokenEvents desc\n| take 25",
              "size": 0,
              "title": "üë• Users Accessing from this IP",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {"filter": true}
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicIP",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "IPUsers"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// IP Activity Timeline\nlet targetIP = '{SelectedForensicIP}';\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where IPAddress == targetIP\n| summarize Success = countif(ResultType == '0'), Failed = countif(ResultType != '0') by bin(TimeGenerated, 1h)\n| render timechart",
              "size": 0,
              "title": "üìà IP Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicIP",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "IPTimeline"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n## üì± Application Investigation\n\nDeep analysis of application token refresh patterns, user access, and anomalies."
            },
            "name": "AppForensicHeader"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "app-search-filter",
                  "version": "KqlParameterItem/1.0",
                  "name": "AppSearchFilter",
                  "type": 1,
                  "isRequired": false,
                  "value": "",
                  "label": "üîç Search Application (Name or ID)",
                  "description": "Enter application name or ID to investigate"
                }
              ],
              "style": "pills",
              "queryType": 0
            },
            "name": "AppSearchParams"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// App Quick Search Results - Click to select\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where '{AppSearchFilter}' == '' or AppDisplayName contains '{AppSearchFilter}' or AppId == '{AppSearchFilter}'\n| extend Country = tostring(parse_json(LocationDetails).countryOrRegion)\n| summarize \n    TotalEvents = count(),\n    FailedEvents = countif(ResultType != '0'),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueIPs = dcount(IPAddress),\n    UniqueCountries = dcount(Country),\n    LastSeen = max(TimeGenerated)\n    by AppDisplayName, AppId\n| extend FailureRate = round(todouble(FailedEvents) / TotalEvents * 100, 1)\n| extend RiskLevel = case(\n    FailureRate > 50 and FailedEvents > 50, 'üî¥ CRITICAL',\n    UniqueCountries > 10, 'üü† DISTRIBUTED',\n    FailedEvents > 100, 'üü° ELEVATED',\n    'üü¢ NORMAL'\n)\n| project RiskLevel, AppDisplayName, AppId, TotalEvents, FailedEvents, FailureRate, UniqueUsers, UniqueIPs, UniqueCountries, LastSeen\n| order by TotalEvents desc\n| take 20",
              "size": 0,
              "title": "üì± Applications - Click row to investigate",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 20,
                "filter": true
              },
              "exportFieldName": "AppDisplayName",
              "exportParameterName": "SelectedForensicApp",
              "exportDefaultValue": ""
            },
            "name": "AppSearchResults"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìä Investigating Application: **{SelectedForensicApp}**"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicApp",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "SelectedAppHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Application Profile\nlet targetApp = '{SelectedForensicApp}';\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where AppDisplayName =~ targetApp or AppId == targetApp\n| extend Country = tostring(parse_json(LocationDetails).countryOrRegion)\n| summarize \n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated),\n    TotalEvents = count(),\n    SuccessfulEvents = countif(ResultType == '0'),\n    FailedEvents = countif(ResultType != '0'),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueIPs = dcount(IPAddress),\n    UniqueCountries = dcount(Country),\n    Countries = make_set(Country, 10),\n    TopUsers = make_set(UserPrincipalName, 5),\n    TopIPs = make_set(IPAddress, 5),\n    ErrorCodes = make_set(ResultType, 10)\n    by AppDisplayName, AppId\n| extend FailureRate = round(todouble(FailedEvents) / TotalEvents * 100, 1)\n| extend RiskIndicator = case(\n    FailureRate > 50 and FailedEvents > 50, 'üî¥ MISCONFIGURED',\n    UniqueCountries > 10, 'üî¥ GEO ANOMALY',\n    UniqueIPs > 50, 'üü† DISTRIBUTED',\n    FailedEvents > 100, 'üü† HIGH FAILURES',\n    'üü¢ NORMAL'\n)\n| project \n    AppDisplayName, AppId, RiskIndicator,\n    FirstSeen, LastSeen,\n    TotalEvents, SuccessfulEvents, FailedEvents, FailureRate,\n    UniqueUsers, UniqueIPs, UniqueCountries,\n    Countries, TopUsers, TopIPs, ErrorCodes",
              "size": 0,
              "title": "üì± Application Profile",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "RiskIndicator",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {"operator": "contains", "thresholdValue": "MISCONFIGURED", "representation": "red", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "ANOMALY", "representation": "red", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "DISTRIBUTED", "representation": "orange", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "FAILURES", "representation": "orange", "text": "{0}"},
                        {"operator": "Default", "representation": "green", "text": "{0}"}
                      ]
                    }
                  },
                  {
                    "columnMatch": "FailureRate",
                    "formatter": 4,
                    "formatOptions": {"palette": "redGreen", "min": 0, "max": 100}
                  }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicApp",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "AppProfile"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// App Activity Timeline\nlet targetApp = '{SelectedForensicApp}';\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where AppDisplayName =~ targetApp or AppId == targetApp\n| summarize Success = countif(ResultType == '0'), Failed = countif(ResultType != '0') by bin(TimeGenerated, 1h)\n| render timechart",
              "size": 0,
              "title": "üìà Application Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicApp",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "AppTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// App Error Distribution\nlet targetApp = '{SelectedForensicApp}';\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where AppDisplayName =~ targetApp or AppId == targetApp\n| where ResultType != '0'\n| summarize Count = count() by ResultType, ResultDescription\n| order by Count desc\n| take 10",
              "size": 0,
              "title": "‚ùå Error Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicApp",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "AppErrors"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n## üíª Device Investigation\n\nAnalyze device-based token activity patterns and associated users."
            },
            "name": "DeviceForensicHeader"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "device-search-filter",
                  "version": "KqlParameterItem/1.0",
                  "name": "DeviceSearchFilter",
                  "type": 1,
                  "isRequired": false,
                  "value": "",
                  "label": "üîç Search Device (Name or ID)",
                  "description": "Enter device name or ID to investigate"
                }
              ],
              "style": "pills",
              "queryType": 0
            },
            "name": "DeviceSearchParams"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Device Quick Search Results - Click to select\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| extend DeviceData = parse_json(DeviceDetail)\n| extend DeviceName = tostring(DeviceData.displayName)\n| extend DeviceId = tostring(DeviceData.deviceId)\n| extend DeviceOS = tostring(DeviceData.operatingSystem)\n| extend IsCompliant = tostring(DeviceData.isCompliant)\n| where DeviceName != '' or DeviceId != ''\n| where '{DeviceSearchFilter}' == '' or DeviceName contains '{DeviceSearchFilter}' or DeviceId contains '{DeviceSearchFilter}'\n| summarize \n    TotalEvents = count(),\n    FailedEvents = countif(ResultType != '0'),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueApps = dcount(AppDisplayName),\n    LastSeen = max(TimeGenerated)\n    by DeviceName, DeviceId, DeviceOS, IsCompliant\n| extend RiskLevel = case(\n    IsCompliant == 'false', 'üü† NON-COMPLIANT',\n    UniqueUsers > 5, 'üü° SHARED',\n    'üü¢ NORMAL'\n)\n| project RiskLevel, DeviceName, DeviceId, DeviceOS, IsCompliant, TotalEvents, FailedEvents, UniqueUsers, UniqueApps, LastSeen\n| order by TotalEvents desc\n| take 20",
              "size": 0,
              "title": "üíª Devices - Click row to investigate",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 20,
                "filter": true
              },
              "exportFieldName": "DeviceName",
              "exportParameterName": "SelectedForensicDevice",
              "exportDefaultValue": ""
            },
            "name": "DeviceSearchResults"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìä Investigating Device: **{SelectedForensicDevice}**"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicDevice",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "SelectedDeviceHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Device Profile\nlet targetDevice = '{SelectedForensicDevice}';\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| extend DeviceData = parse_json(DeviceDetail)\n| extend DeviceName = tostring(DeviceData.displayName)\n| extend DeviceId = tostring(DeviceData.deviceId)\n| extend DeviceOS = tostring(DeviceData.operatingSystem)\n| extend IsCompliant = tostring(DeviceData.isCompliant)\n| extend IsManaged = tostring(DeviceData.isManaged)\n| where DeviceId == targetDevice or DeviceName =~ targetDevice\n| summarize \n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated),\n    TotalEvents = count(),\n    SuccessfulEvents = countif(ResultType == '0'),\n    FailedEvents = countif(ResultType != '0'),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueApps = dcount(AppDisplayName),\n    UniqueIPs = dcount(IPAddress),\n    Users = make_set(UserPrincipalName, 10),\n    Apps = make_set(AppDisplayName, 5)\n    by DeviceName, DeviceId, DeviceOS, IsCompliant, IsManaged\n| extend FailureRate = round(todouble(FailedEvents) / TotalEvents * 100, 1)\n| extend RiskIndicator = case(\n    IsCompliant == 'false', 'üü† NON-COMPLIANT',\n    UniqueUsers > 5, 'üü° SHARED DEVICE',\n    FailureRate > 30, 'üü° HIGH FAILURES',\n    'üü¢ NORMAL'\n)\n| project \n    DeviceName, DeviceId, DeviceOS, RiskIndicator,\n    IsCompliant, IsManaged,\n    FirstSeen, LastSeen,\n    TotalEvents, SuccessfulEvents, FailedEvents, FailureRate,\n    UniqueUsers, UniqueApps, UniqueIPs,\n    Users, Apps",
              "size": 0,
              "title": "üíª Device Profile",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "RiskIndicator",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {"operator": "contains", "thresholdValue": "NON-COMPLIANT", "representation": "orange", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "SHARED", "representation": "yellow", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "FAILURES", "representation": "yellow", "text": "{0}"},
                        {"operator": "Default", "representation": "green", "text": "{0}"}
                      ]
                    }
                  },
                  {
                    "columnMatch": "IsCompliant",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {"operator": "==", "thresholdValue": "true", "representation": "green", "text": "‚úÖ Yes"},
                        {"operator": "Default", "representation": "red", "text": "‚ùå No"}
                      ]
                    }
                  }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicDevice",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "DeviceProfile"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Device Activity Timeline\nlet targetDevice = '{SelectedForensicDevice}';\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| extend DeviceData = parse_json(DeviceDetail)\n| extend DeviceName = tostring(DeviceData.displayName)\n| extend DeviceId = tostring(DeviceData.deviceId)\n| where DeviceId == targetDevice or DeviceName =~ targetDevice\n| summarize Success = countif(ResultType == '0'), Failed = countif(ResultType != '0') by bin(TimeGenerated, 1h)\n| render timechart",
              "size": 0,
              "title": "üìà Device Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicDevice",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "DeviceTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Users on this Device\nlet targetDevice = '{SelectedForensicDevice}';\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| extend DeviceData = parse_json(DeviceDetail)\n| extend DeviceName = tostring(DeviceData.displayName)\n| extend DeviceId = tostring(DeviceData.deviceId)\n| where DeviceId == targetDevice or DeviceName =~ targetDevice\n| summarize \n    TokenEvents = count(),\n    Failed = countif(ResultType != '0'),\n    Apps = dcount(AppDisplayName),\n    LastSeen = max(TimeGenerated)\n    by UserPrincipalName\n| order by TokenEvents desc",
              "size": 0,
              "title": "üë• Users on this Device",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {"filter": true}
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicDevice",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "DeviceUsers"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "forensics"
      },
      "name": "ForensicsGroup"
    },
    {
      "type": 1,
      "content": {
        "json": "---\n\n### üìã Non-Interactive Sign-In Security Best Practices\n\n**What are Non-Interactive Sign-Ins?**\n- Token refresh operations (users don't see a login prompt)\n- Background app authentication on behalf of users\n- Automated processes using delegated permissions\n- OAuth2 refresh token flows\n\n**üî¥ Critical Monitoring:**\n1. Watch for tokens being used from multiple IPs/countries simultaneously\n2. Monitor for unusual token refresh volumes (potential token theft)\n3. Alert on successful sign-ins from known malicious IPs\n4. Track apps with high failure rates (potential misconfiguration or attack)\n\n**üü° Investigation Triggers:**\n- User tokens refreshing from new geographic locations\n- Sudden spikes in non-interactive sign-ins for specific apps\n- Multiple users' tokens being used from same IP\n- Apps generating unusual error patterns\n\n**üìä Data Source:** AADNonInteractiveUserSignInLogs\n\n**References:**\n- [Azure AD Sign-in Logs](https://docs.microsoft.com/azure/active-directory/reports-monitoring/concept-sign-ins)\n- [Token Theft Detection](https://docs.microsoft.com/azure/active-directory/identity-protection/concept-identity-protection-risks)"
      },
      "name": "BestPractices"
    }
  ],
  "fallbackResourceIds": [
    "Azure Monitor"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
