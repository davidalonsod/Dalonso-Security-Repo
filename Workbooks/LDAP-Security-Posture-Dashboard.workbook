{
    "version": "Notebook/1.0",
    "items": [
        {
            "type": 1,
            "content": {
                "json": "## ðŸ›¡ï¸ LDAP Security Posture & DC Performance Dashboard\n---\n\nThis workbook provides comprehensive monitoring and analysis of LDAP security events, Domain Controller performance, reconnaissance detection, and privileged account protection.\n\n**Last Updated:** February 17, 2026  \n**Data Sources:** Uses `union isfuzzy=true` to support multiple data sources:\n- **Defender for Identity (MDI):** IdentityDirectoryEvents, IdentityQueryEvents\n- **DC Security Events:** SecurityEvent (EventID 2886-2889)\n- **MDE Network:** DeviceNetworkEvents (LDAP port traffic)\n- **Directory Services:** Event (EventID 1644 for expensive queries)\n\n> **Note:** If MDI is not deployed, queries automatically fall back to DC Security Events.\n\n---\n\n## ðŸ“‹ LDAP Ports & Event ID Reference\n\n| Port | Protocol | Description | Security Risk |\n|------|----------|-------------|---------------|\n| **TCP 389** | LDAP | Clear text (unencrypted) | ðŸ”´ High - Credentials exposed |\n| **TCP 636** | LDAPS | LDAP over SSL/TLS | ðŸŸ¢ Secure |\n| **TCP 3268** | GC-LDAP | Global Catalog (unencrypted) | ðŸ”´ High |\n| **TCP 3269** | GC-LDAPS | Global Catalog (encrypted) | ðŸŸ¢ Secure |\n\n---\n\n## ðŸ”§ Required Event Collection\n\n### Events to Collect from Domain Controllers\n\n| Event ID | Log | Description | Required For |\n|----------|-----|-------------|---------------|\n| **1644** | Directory Services | Expensive/inefficient LDAP query | DC Performance tab |\n| **2886** | Directory Services | LDAP signing not required warning | Security Config |\n| **2887** | Directory Services | Number of simple binds (24h summary) | Clear Text Detection |\n| **2888** | Directory Services | Rejected unsigned bind | Security Enforcement |\n| **2889** | Directory Services | Client performing unsigned simple bind | Unsigned Bind Detection |\n\n---\n\n## ðŸ“¥ Data Collection Rule (DCR) Setup\n\n### Option 1: Azure Portal DCR Configuration\n\nIn your DCR, add a **Windows Event Log** data source with:\n- **Log name:** `Directory Service`\n- **XPath Query (copy exactly):**\n\n```\nDirectory Service!*[System[(EventID=1644 or EventID=2886 or EventID=2887 or EventID=2888 or EventID=2889)]]\n```\n\n### Option 2: ARM Template / Bicep\n\n```json\n\"dataSources\": {\n  \"windowsEventLogs\": [\n    {\n      \"streams\": [\"Microsoft-Event\"],\n      \"xPathQueries\": [\n        \"Directory Service!*[System[(EventID=1644 or EventID=2886 or EventID=2887 or EventID=2888 or EventID=2889)]]\"\n      ],\n      \"name\": \"LDAP-Security-Events\"\n    }\n  ]\n}\n```\n\n### Option 3: PowerShell DCR Update\n\n```powershell\n$xpathQuery = 'Directory Service!*[System[(EventID=1644 or EventID=2886 or EventID=2887 or EventID=2888 or EventID=2889)]]'\n```\n\n---\n\n### Enable Event 1644 Logging (Expensive Query Detection)\n\nRun on each Domain Controller:\n```powershell\n# Enable Field Engineering diagnostic logging\nreg add \"HKLM\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Diagnostics\" /v \"15 Field Engineering\" /t REG_DWORD /d 5 /f\n\n# Set thresholds (optional - default is 10000)\nreg add \"HKLM\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Parameters\" /v \"Expensive Search Results Threshold\" /t REG_DWORD /d 1 /f\nreg add \"HKLM\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Parameters\" /v \"Inefficient Search Results Threshold\" /t REG_DWORD /d 1 /f\nreg add \"HKLM\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Parameters\" /v \"Search Time Threshold (msecs)\" /t REG_DWORD /d 100 /f\n```\n\n---\n\n### ðŸŽ¯ Threat Actor Coverage\n\n| Actor | Type | LDAP TTPs |\n|-------|------|------------|\n| APT29/Cozy Bear | Nation-State | Domain recon, DCSync |\n| APT28/Fancy Bear | Nation-State | Credential harvesting |\n| FIN7/Carbanak | Financially Motivated | AD enumeration |\n| Conti/LockBit/BlackCat | Ransomware | GPO abuse, privilege escalation |\n\n---"
            },
            "name": "text - header",
            "id": "cd9495ec-b897-48dc-a173-271a55ceb577"
        },
        {
            "type": 9,
            "content": {
                "version": "KqlParameterItem/1.0",
                "parameters": [
                    {
                        "id": "1f74ed9a-e3ed-498d-8b1e-e0a7e6c89f71",
                        "version": "KqlParameterItem/1.0",
                        "name": "TimeRange",
                        "label": "Time Range",
                        "type": 4,
                        "isRequired": true,
                        "value": {
                            "durationMs": 2592000000
                        },
                        "typeSettings": {
                            "selectableValues": [
                                {
                                    "durationMs": 3600000
                                },
                                {
                                    "durationMs": 14400000
                                },
                                {
                                    "durationMs": 43200000
                                },
                                {
                                    "durationMs": 86400000
                                },
                                {
                                    "durationMs": 172800000
                                },
                                {
                                    "durationMs": 604800000
                                },
                                {
                                    "durationMs": 2592000000
                                },
                                {
                                    "durationMs": 7776000000
                                }
                            ],
                            "allowCustom": true
                        },
                        "timeContext": {
                            "durationMs": 86400000
                        }
                    },
                    {
                        "id": "b3f7c4d9-2e1a-4f9c-8d7e-1a2b3c4d5e6f",
                        "version": "KqlParameterItem/1.0",
                        "name": "Workspace",
                        "type": 5,
                        "isRequired": true,
                        "query": "where type =~ 'microsoft.operationalinsights/workspaces'\n| project id",
                        "crossComponentResources": [
                            "value::selected"
                        ],
                        "typeSettings": {
                            "resourceTypeFilter": {
                                "microsoft.operationalinsights/workspaces": true
                            },
                            "additionalResourceOptions": [
                                "value::1"
                            ],
                            "showDefault": false
                        },
                        "timeContext": {
                            "durationMs": 86400000
                        },
                        "defaultValue": "value::1",
                        "queryType": 1,
                        "resourceType": "microsoft.resourcegraph/resources",
                        "value": "/subscriptions/e3b7b2a3-b776-46be-a556-1ea5fbc1a588/resourceGroups/RG_Sentinel/providers/Microsoft.OperationalInsights/workspaces/LAWSentinel"
                    }
                ],
                "style": "pills"
            },
            "name": "parameters - time range",
            "id": "e1971967-b719-4ea5-83f0-ad792284acad"
        },
        {
            "type": 11,
            "content": {
                "version": "LinkItem/1.0",
                "style": "tabs",
                "links": [
                    {
                        "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "ðŸ“Š Overview",
                        "subTarget": "Overview",
                        "style": "link"
                    },
                    {
                        "id": "perf-tab-001",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "âš¡ DC Performance",
                        "subTarget": "DCPerformance",
                        "style": "link"
                    },
                    {
                        "id": "b2c3d4e5-f678-90ab-cdef-123456789abc",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "ðŸ” Authentication",
                        "subTarget": "AuthAnalysis",
                        "style": "link"
                    },
                    {
                        "id": "c3d4e5f6-7890-abcd-ef12-3456789abcde",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "ðŸ” Reconnaissance",
                        "subTarget": "Reconnaissance",
                        "style": "link"
                    },
                    {
                        "id": "priv-tab-001",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "ðŸ‘‘ Privileged Accounts",
                        "subTarget": "PrivilegedAccounts",
                        "style": "link"
                    },
                    {
                        "id": "tools-tab-001",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "ðŸ› ï¸ Attack Tools",
                        "subTarget": "AttackTools",
                        "style": "link"
                    },
                    {
                        "id": "abnormal-tab-001",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "âš ï¸ Abnormal Clients",
                        "subTarget": "AbnormalClients",
                        "style": "link"
                    },
                    {
                        "id": "d4e5f678-90ab-cdef-1234-56789abcdef0",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "ðŸŽ¯ Threat Intel",
                        "subTarget": "ThreatIntel",
                        "style": "link"
                    },
                    {
                        "id": "bestpractice-tab-001",
                        "cellValue": "selectedTab",
                        "linkTarget": "parameter",
                        "linkLabel": "âœ… Best Practices",
                        "subTarget": "BestPractices",
                        "style": "link"
                    }
                ]
            },
            "name": "links - tabs",
            "id": "77b59cc0-1224-42b7-a98e-78c27f7f63fe"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "### ðŸ“Š LDAP Traffic Overview\n\nMonitor overall LDAP usage, protocol distribution, and security posture metrics."
                        },
                        "name": "text - overview header",
                        "id": "2ebab024-7dc6-4feb-9155-24b0dc396e9e"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// LDAP Query Volume Metrics - Combined Data Sources\n// Uses MDI if available, DC Directory Service Events, and MDE\nlet EmptyMDI = datatable(TimeGenerated:datetime, Protocol:string)[];\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, EventLog:string)[];\nlet EmptyMDE = datatable(TimeGenerated:datetime, RemotePort:int)[];\nlet AllLDAPEvents = union isfuzzy=true\n    (union isfuzzy=true EmptyMDI, IdentityDirectoryEvents | where Protocol == \"Ldap\" | project TimeGenerated, Source=\"MDI\"),\n    (union isfuzzy=true EmptyEvent, Event | where EventLog == \"Directory Service\" | where EventID in (1644, 2886, 2887, 2888, 2889) | project TimeGenerated, Source=\"DCEvent\"),\n    (union isfuzzy=true EmptyMDE, DeviceNetworkEvents | where RemotePort in (389, 636) | project TimeGenerated, Source=\"MDE\");\nlet Last24h = toscalar(AllLDAPEvents | where TimeGenerated > ago(24h) | count);\nlet Last7d = toscalar(AllLDAPEvents | where TimeGenerated > ago(7d) | count);\nlet Last30d = toscalar(AllLDAPEvents | where TimeGenerated > ago(30d) | count);\nprint Metric = \"LDAP Events\", Last24h = Last24h, Last7d = Last7d, Last30d = Last30d",
                            "size": 4,
                            "title": "LDAP Query Volume",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "tiles",
                            "tileSettings": {
                                "titleContent": {
                                    "columnMatch": "Metric",
                                    "formatter": 1
                                },
                                "leftContent": {
                                    "columnMatch": "Last24h",
                                    "formatter": 12,
                                    "formatOptions": {
                                        "palette": "auto"
                                    },
                                    "numberFormat": {
                                        "unit": 17,
                                        "options": {
                                            "style": "decimal",
                                            "maximumFractionDigits": 2,
                                            "maximumSignificantDigits": 3
                                        }
                                    }
                                },
                                "secondaryContent": {
                                    "columnMatch": "Last7d",
                                    "formatter": 1
                                },
                                "showBorder": false
                            }
                        },
                        "customWidth": "33",
                        "name": "query - ldap volume",
                        "id": "95cd4861-ef12-4495-b07c-e351377899b2"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Unsigned LDAP Binds Detection (Event 2889 from Directory Service log)\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, EventLog:string)[];\nunion isfuzzy=true EmptyEvent, Event\n| where TimeGenerated {TimeRange}\n| where EventLog == \"Directory Service\"\n| where EventID == 2889\n| summarize UnsignedBinds = count()\n| extend Status = case(\n    UnsignedBinds == 0, \"Secure\",\n    UnsignedBinds < 100, \"Warning\",\n    \"Critical\"\n)\n| project Metric = \"Unsigned LDAP Binds\", UnsignedBinds, Status",
                            "size": 4,
                            "title": "Unsigned LDAP Binds",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "tiles",
                            "tileSettings": {
                                "titleContent": {
                                    "columnMatch": "Metric",
                                    "formatter": 1
                                },
                                "leftContent": {
                                    "columnMatch": "UnsignedBinds",
                                    "formatter": 12,
                                    "formatOptions": {
                                        "palette": "redBright"
                                    },
                                    "numberFormat": {
                                        "unit": 17,
                                        "options": {
                                            "style": "decimal"
                                        }
                                    }
                                },
                                "secondaryContent": {
                                    "columnMatch": "Status",
                                    "formatter": 1
                                },
                                "showBorder": false
                            }
                        },
                        "customWidth": "33",
                        "name": "query - unsigned binds",
                        "id": "8fea94ad-df90-46f9-9373-750f3195f34a"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Clear Text LDAP Binds\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 2887  // Simple bind without SSL/TLS\n| summarize ClearTextBinds = count()\n| extend RiskLevel = case(\n    ClearTextBinds == 0, \"âœ… Secure\",\n    ClearTextBinds < 50, \"âš ï¸ Warning\",\n    \"ðŸ”´ Critical\"\n)\n| project Metric = \"Clear Text LDAP Binds\", ClearTextBinds, RiskLevel",
                            "size": 4,
                            "title": "Clear Text LDAP Binds",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "tiles",
                            "tileSettings": {
                                "titleContent": {
                                    "columnMatch": "Metric",
                                    "formatter": 1
                                },
                                "leftContent": {
                                    "columnMatch": "ClearTextBinds",
                                    "formatter": 12,
                                    "formatOptions": {
                                        "palette": "redBright"
                                    },
                                    "numberFormat": {
                                        "unit": 17,
                                        "options": {
                                            "style": "decimal"
                                        }
                                    }
                                },
                                "secondaryContent": {
                                    "columnMatch": "RiskLevel",
                                    "formatter": 1
                                },
                                "showBorder": false
                            }
                        },
                        "customWidth": "33",
                        "name": "query - clear text binds",
                        "id": "af4bf370-074d-466e-8490-3e2d8e7ff1dc"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// LDAP Traffic Trend Over Time - Combined Data Sources\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string, DestinationPort:int)[];\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, EventLog:string)[];\nunion isfuzzy=true EmptyIDEvents,\n    (IdentityDirectoryEvents \n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | extend EventType = ActionType, Source = \"MDI\"),\n    (Event \n        | where TimeGenerated {TimeRange}\n        | where EventLog == \"Directory Service\"\n        | where EventID in (2886, 2887, 2889)\n        | extend EventType = case(EventID == 2886, \"LDAP Signing Warning\", EventID == 2887, \"Clear Text Bind\", EventID == 2889, \"Unsigned Bind\", \"Other\"), Source = \"DC\"),\n    (SecurityEvent \n        | where TimeGenerated {TimeRange}\n        | where EventID == 4624 and LogonType == 3\n        | extend EventType = \"Network Logon\", Source = \"DC\"),\n    (SecurityEvent \n        | where TimeGenerated {TimeRange}\n        | where EventID == 4625 and LogonType == 3\n        | extend EventType = \"Failed Network Logon\", Source = \"DC\"),\n    (Event \n        | where TimeGenerated {TimeRange}\n        | where EventLog == \"Directory Service\"\n        | where EventID == 1644\n        | extend EventType = \"Expensive LDAP Query\", Source = \"Directory Services\"),\n    (DeviceNetworkEvents \n        | where TimeGenerated {TimeRange}\n        | where RemotePort in (389, 636, 3268, 3269)\n        | extend EventType = case(RemotePort == 389, \"LDAP Connection\", RemotePort == 636, \"LDAPS Connection\", \"Global Catalog\"), Source = \"MDE\")\n| summarize QueryCount = count() by bin(TimeGenerated, 1h), EventType\n| render timechart with (title=\"LDAP Activity Over Time\")",
                            "size": 0,
                            "title": "LDAP Activity Timeline",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "timechart"
                        },
                        "customWidth": "50",
                        "name": "query - ldap timeline",
                        "id": "5bcbe33c-0a72-48e1-9a5f-bf16d432f6b8"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// LDAP vs LDAPS Usage Ratio - Combined Data Sources\nlet EmptyMDI = datatable(TimeGenerated:datetime, Protocol:string, DestinationPort:int)[];\nlet EmptyMDE = datatable(TimeGenerated:datetime, RemotePort:int, LocalPort:int)[];\nunion isfuzzy=true\n    (union isfuzzy=true EmptyMDI, IdentityDirectoryEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | extend LDAPProtocol = case(\n            DestinationPort == 389, \"LDAP (Unencrypted)\",\n            DestinationPort == 636, \"LDAPS (Encrypted)\",\n            DestinationPort == 3268, \"Global Catalog (Unencrypted)\",\n            DestinationPort == 3269, \"Global Catalog (Encrypted)\",\n            \"Unknown\")\n        | project LDAPProtocol),\n    (union isfuzzy=true EmptyMDE, DeviceNetworkEvents\n        | where TimeGenerated {TimeRange}\n        | where RemotePort in (389, 636, 3268, 3269) or LocalPort in (389, 636, 3268, 3269)\n        | extend Port = coalesce(RemotePort, LocalPort)\n        | extend LDAPProtocol = case(\n            Port == 389, \"LDAP (Unencrypted)\",\n            Port == 636, \"LDAPS (Encrypted)\",\n            Port == 3268, \"Global Catalog (Unencrypted)\",\n            Port == 3269, \"Global Catalog (Encrypted)\",\n            \"Unknown\")\n        | project LDAPProtocol),\n    (SecurityEvent\n        | where TimeGenerated {TimeRange}\n        | where EventID in (2886, 2887, 2889)\n        | extend LDAPProtocol = \"LDAP (Unencrypted)\"\n        | project LDAPProtocol)\n| where isnotempty(LDAPProtocol)\n| summarize Count = count() by LDAPProtocol\n| render piechart",
                            "size": 0,
                            "title": "LDAP vs LDAPS Usage",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "piechart"
                        },
                        "customWidth": "50",
                        "name": "query - protocol distribution",
                        "id": "07f31a46-5957-4d41-8f2d-ac1423ae60ff"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Top Sources of LDAP Traffic (MDI + Event Table)\n// Uses MDI and Event table (1644, 2889) only\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string, DestinationPort:int)[];\nlet EmptyIQE = datatable(TimeGenerated:datetime, QueryType:string, AccountUpn:string, Query:string, DeviceName:string, IPAddress:string)[];\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, EventLog:string, RenderedDescription:string, Computer:string)[];\nunion isfuzzy=true\n    // MDI - IdentityDirectoryEvents\n    (union isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents \n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | extend LDAPQuery = coalesce(tostring(parse_json(AdditionalFields).Query), ActionType)\n        | extend Source = \"MDI\"\n        | project TimeGenerated, DeviceName, IPAddress, AccountName, LDAPQuery, Source),\n    // MDI - IdentityQueryEvents\n    (union isfuzzy=true EmptyIQE, IdentityQueryEvents\n        | where TimeGenerated {TimeRange}\n        | where QueryType == \"LDAP\"\n        | extend AccountName = AccountUpn, LDAPQuery = Query\n        | extend Source = \"MDI-Query\"\n        | project TimeGenerated, DeviceName, IPAddress, AccountName, LDAPQuery, Source),\n    // Event 1644 - Expensive LDAP Queries\n    (union isfuzzy=true EmptyEvent, Event\n        | where TimeGenerated {TimeRange}\n        | where EventLog == \"Directory Service\"\n        | where EventID == 1644\n        | extend IPAddress = extract(@\"Client IP:\\s*([\\d\\.]+)\", 1, RenderedDescription)\n        | extend LDAPQuery = extract(@\"Filter:\\s*(.{0,50})\", 1, RenderedDescription)\n        | extend AccountName = \"Event1644\", DeviceName = Computer\n        | extend Source = \"Event-1644\"\n        | project TimeGenerated, DeviceName, IPAddress, AccountName, LDAPQuery, Source),\n    // Event 2889 - Unsigned LDAP Binds\n    (union isfuzzy=true EmptyEvent, Event\n        | where TimeGenerated {TimeRange}\n        | where EventLog == \"Directory Service\"\n        | where EventID == 2889\n        | extend IPAddress = extract(@\"IP address:\\s*([\\d\\.]+)\", 1, RenderedDescription)\n        | extend LDAPQuery = \"Unsigned LDAP Bind\"\n        | extend AccountName = \"Event2889\", DeviceName = Computer\n        | extend Source = \"Event-2889\"\n        | project TimeGenerated, DeviceName, IPAddress, AccountName, LDAPQuery, Source)\n| where isnotempty(IPAddress) or isnotempty(DeviceName)\n| summarize \n    QueryCount = count(),\n    UniqueAccounts = dcount(AccountName),\n    Accounts = make_set(AccountName, 5),\n    SampleQueries = make_set(LDAPQuery, 3),\n    LastActivity = max(TimeGenerated),\n    DataSources = make_set(Source)\n    by DeviceName, IPAddress\n| top 20 by QueryCount desc\n| project DeviceName, IPAddress, QueryCount, UniqueAccounts, SampleQueries, DataSources, Accounts, LastActivity",
                            "size": 0,
                            "title": "Top LDAP Query Sources",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "QueryCount",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    },
                                    {
                                        "columnMatch": "LastActivity",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "name": "query - top sources",
                        "id": "c35ad610-3aeb-4a0d-9f5b-9e0932d5db1a"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "Overview"
            },
            "name": "group - overview",
            "id": "cd56cf19-edbf-4fcb-8ac0-285fc98b09c0"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "### âš¡ Domain Controller Performance - LDAP Query Analysis\n\nDetect expensive/inefficient LDAP queries that impact Domain Controller performance using **Event ID 1644** (Directory Services expensive query logging).\n\n**Prerequisites:**\n- Enable Event 1644 logging via registry: `HKLM\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Diagnostics\\15 Field Engineering = 5`\n- Set thresholds: `Expensive Search Results Threshold` (default: 10000), `Inefficient Search Results Threshold` (default: 1000)\n\n| Event | Description | Impact |\n|-------|-------------|--------|\n| 1644 | Expensive/Inefficient LDAP Search | High CPU, Memory pressure |\n| 3039 | Client session disconnected (timeout) | Query too slow |\n| 3040 | Query rejected (resource limit) | DC protection activated |"
                        },
                        "name": "text - dc perf header",
                        "id": "845dbf16-7dd4-44c6-9737-9bba628fcc54"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Event 1644 - Expensive LDAP Query Detection\n// Requires Field Engineering diagnostic logging enabled on DCs\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, EventLog:string, RenderedDescription:string, Computer:string)[];\nunion isfuzzy=true EmptyEvent, Event\n| where TimeGenerated {TimeRange}\n| where EventLog == \"Directory Service\"\n| where EventID == 1644\n| extend ClientIP = extract(@\"Client IP:\\s*([\\d\\.]+)\", 1, RenderedDescription)\n| extend StartingNode = extract(@\"Starting node:\\s*(.+?)\\s*(Filter|$)\", 1, RenderedDescription)\n| extend Filter = extract(@\"Filter:\\s*(.+?)\\s*(Visited entries|$)\", 1, RenderedDescription)\n| extend VisitedEntries = toint(extract(@\"Visited entries:\\s*(\\d+)\", 1, RenderedDescription))\n| extend ReturnedEntries = toint(extract(@\"Returned entries:\\s*(\\d+)\", 1, RenderedDescription))\n| extend TimeMs = toint(extract(@\"(\\d+)\\s*ms\", 1, RenderedDescription))\n| where VisitedEntries > 100 or ReturnedEntries > 100 or TimeMs > 500\n| extend Efficiency = iff(VisitedEntries > 0, round(todouble(ReturnedEntries) / todouble(VisitedEntries) * 100, 2), 0.0)\n| extend Severity = case(\n    VisitedEntries > 100000 or TimeMs > 30000, \"ðŸ”´ Critical\",\n    VisitedEntries > 10000 or TimeMs > 10000, \"ðŸŸ  High\",\n    VisitedEntries > 1000, \"ðŸŸ¡ Medium\",\n    \"ðŸŸ¢ Low\"\n)\n| project TimeGenerated, Computer, ClientIP, StartingNode, Filter, VisitedEntries, ReturnedEntries, Efficiency, TimeMs, Severity\n| order by VisitedEntries desc\n| take 50",
                            "size": 0,
                            "title": "ðŸ”´ Expensive LDAP Queries (Event 1644)",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "VisitedEntries",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "TimeMs",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    },
                                    {
                                        "columnMatch": "Efficiency",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "greenRed"
                                        }
                                    },
                                    {
                                        "columnMatch": "TimeGenerated",
                                        "formatter": 6
                                    }
                                ],
                                "rowLimit": 50
                            }
                        },
                        "name": "query - event 1644",
                        "id": "8c9bdd43-3f7d-46df-bf45-4ca4d05abcf3"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Expensive Query Trend Over Time\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, EventLog:string, Computer:string)[];\nunion isfuzzy=true EmptyEvent, Event\n| where TimeGenerated {TimeRange}\n| where EventLog == \"Directory Service\"\n| where EventID == 1644\n| summarize ExpensiveQueries = count() by bin(TimeGenerated, 1h), Computer\n| render timechart with (title=\"Expensive LDAP Queries Over Time (Event 1644)\")",
                            "size": 0,
                            "title": "Expensive Query Trend Timeline",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "timechart"
                        },
                        "customWidth": "50",
                        "name": "query - expensive trend",
                        "id": "38bbd01d-477d-463b-a546-01bf3337cfca"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Top Offending Clients\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, EventLog:string, RenderedDescription:string)[];\nunion isfuzzy=true EmptyEvent, Event\n| where TimeGenerated {TimeRange}\n| where EventLog == \"Directory Service\"\n| where EventID == 1644\n| extend ClientIP = extract(@\"Client IP:\\s*([\\d\\.]+)\", 1, RenderedDescription)\n| extend VisitedEntries = toint(extract(@\"Visited entries:\\s*(\\d+)\", 1, RenderedDescription))\n| where isnotempty(ClientIP)\n| summarize \n    QueryCount = count(),\n    TotalVisited = sum(VisitedEntries),\n    AvgVisited = avg(VisitedEntries),\n    MaxVisited = max(VisitedEntries)\n    by ClientIP\n| extend ImpactScore = QueryCount * toint(AvgVisited / 1000)\n| order by ImpactScore desc\n| take 20\n| extend RiskLevel = case(\n    ImpactScore > 10000, \"ðŸ”´ Critical\",\n    ImpactScore > 1000, \"ðŸŸ  High\",\n    ImpactScore > 100, \"ðŸŸ¡ Medium\",\n    \"ðŸŸ¢ Low\"\n)\n| project ClientIP, QueryCount, TotalVisited, AvgVisited, MaxVisited, ImpactScore, RiskLevel",
                            "size": 0,
                            "title": "Top Clients Causing DC Performance Issues",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "ImpactScore",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "TotalVisited",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - top offenders",
                        "id": "9e2d8fbd-a21a-495f-964d-bf1ff2d825c4"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Unindexed Attribute Detection (Performance Impact)\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, EventLog:string, RenderedDescription:string)[];\nunion isfuzzy=true EmptyEvent, Event\n| where TimeGenerated {TimeRange}\n| where EventLog == \"Directory Service\"\n| where EventID == 1644\n| extend Filter = extract(@\"Filter:\\s*(.+?)\\s*(Visited entries|$)\", 1, RenderedDescription)\n| extend VisitedEntries = toint(extract(@\"Visited entries:\\s*(\\d+)\", 1, RenderedDescription))\n| extend ReturnedEntries = toint(extract(@\"Returned entries:\\s*(\\d+)\", 1, RenderedDescription))\n| where VisitedEntries > 100 and ReturnedEntries < 50\n| extend ProbableAttribute = case(\n    Filter has \"description=\", \"description (NOT indexed by default)\",\n    Filter has \"info=\", \"info (NOT indexed)\",\n    Filter has \"comment=\", \"comment (NOT indexed)\",\n    Filter has \"extensionAttribute\", \"extensionAttribute (custom - check indexing)\",\n    Filter has \"employeeID=\", \"employeeID (may not be indexed)\",\n    Filter has \"employeeNumber=\", \"employeeNumber (may not be indexed)\",\n    Filter has \"title=\", \"title (NOT indexed by default)\",\n    Filter has \"physicalDeliveryOfficeName\", \"office (NOT indexed by default)\",\n    \"Unknown - Review filter\"\n)\n| summarize \n    QueryCount = count(),\n    TotalVisited = sum(VisitedEntries),\n    AvgVisited = avg(VisitedEntries)\n    by ProbableAttribute, Filter\n| order by TotalVisited desc\n| take 20",
                            "size": 0,
                            "title": "âš ï¸ Queries Using Likely Unindexed Attributes",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "TotalVisited",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - unindexed",
                        "id": "0ecf37a0-1fdf-4357-b0ac-547cdd3b693b"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Large Subtree Searches (Domain-wide queries)\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, EventLog:string, RenderedDescription:string)[];\nunion isfuzzy=true EmptyEvent, Event\n| where TimeGenerated {TimeRange}\n| where EventLog == \"Directory Service\"\n| where EventID == 1644\n| extend StartingNode = extract(@\"Starting node:\\s*(.+?)\\s*(Filter|$)\", 1, RenderedDescription)\n| extend ClientIP = extract(@\"Client IP:\\s*([\\d\\.]+)\", 1, RenderedDescription)\n| extend VisitedEntries = toint(extract(@\"Visited entries:\\s*(\\d+)\", 1, RenderedDescription))\n| where StartingNode has \"DC=\" and not(StartingNode has \"OU=\")\n| where VisitedEntries > 100\n| summarize \n    SubtreeSearches = count(),\n    TotalVisited = sum(VisitedEntries),\n    MaxVisited = max(VisitedEntries)\n    by ClientIP, StartingNode\n| extend RiskLevel = case(\n    TotalVisited > 1000000, \"ðŸ”´ Critical - Entire Domain Scan\",\n    TotalVisited > 100000, \"ðŸŸ  High - Large Subtree\",\n    \"ðŸŸ¡ Medium\"\n)\n| order by TotalVisited desc\n| take 20",
                            "size": 0,
                            "title": "ðŸ”´ Large Subtree Searches (Domain-Wide Scans)",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "TotalVisited",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - subtree",
                        "id": "e676941b-f152-4d73-8c34-e227b53d6413"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// DC Health - Query Rejection Events (Event 3040)\n// Queries rejected due to resource limits\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, EventLog:string, RenderedDescription:string, Computer:string)[];\nunion isfuzzy=true EmptyEvent, Event\n| where TimeGenerated {TimeRange}\n| where EventLog == \"Directory Service\"\n| where EventID in (3039, 3040)\n| extend EventType = case(\n    EventID == 3039, \"Client Disconnected (Timeout)\",\n    EventID == 3040, \"Query Rejected (Resource Limit)\",\n    \"Unknown\"\n)\n| extend ClientIP = extract(@\"client\\s*[:\\s]*([\\d\\.]+)\", 1, RenderedDescription)\n| summarize \n    EventCount = count(),\n    FirstOccurrence = min(TimeGenerated),\n    LastOccurrence = max(TimeGenerated)\n    by Computer, EventType, ClientIP\n| extend Severity = \"ðŸ”´ Critical - DC Under Stress\"\n| order by EventCount desc",
                            "size": 0,
                            "title": "ðŸ”´ DC Protection Events - Query Rejections",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "EventCount",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "FirstOccurrence",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "LastOccurrence",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "name": "query - dc protection",
                        "id": "126b2fda-c7b2-4c46-8d98-d371e56b501d"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// DC CPU Impact Analysis by Hour\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, EventLog:string, Computer:string)[];\nPerf\n| where TimeGenerated {TimeRange}\n| where ObjectName == \"Processor\" and CounterName == \"% Processor Time\" and InstanceName == \"_Total\"\n| where Computer has_any (\"DC\", \"AD\", \"Domain\")\n| summarize AvgCPU = avg(CounterValue), MaxCPU = max(CounterValue) by bin(TimeGenerated, 1h), Computer\n| join kind=leftouter (\n    union isfuzzy=true EmptyEvent, Event\n    | where TimeGenerated {TimeRange}\n    | where EventLog == \"Directory Service\"\n    | where EventID == 1644\n    | summarize ExpensiveQueries = count() by bin(TimeGenerated, 1h), Computer\n) on TimeGenerated, Computer\n| extend ExpensiveQueries = coalesce(ExpensiveQueries, 0)\n| project TimeGenerated, Computer, AvgCPU, MaxCPU, ExpensiveQueries\n| order by TimeGenerated desc",
                            "size": 0,
                            "title": "DC CPU vs Expensive Query Correlation",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "linechart"
                        },
                        "name": "query - cpu correlation",
                        "id": "45a6c28b-bf25-45b9-87fd-56e58aa43ec4"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "DCPerformance"
            },
            "name": "group - dc performance",
            "id": "efd71bfe-eeb7-4fce-9151-30b674dc0119"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "### ðŸ” LDAP Authentication Analysis\n\nAnalyze authentication methods, account usage patterns, and identify risky authentication behaviors."
                        },
                        "name": "text - auth header",
                        "id": "bc77de20-f06c-4c73-979f-c1f6691cd37b"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// LDAP Authentication Methods Breakdown - MDI Focus\n// Uses IdentityDirectoryEvents, IdentityLogonEvents, and Event table if available\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, DestinationPort:int, AdditionalFields:dynamic)[];\nlet EmptyLogon = datatable(TimeGenerated:datetime, Protocol:string, DestinationPort:int, LogonType:string, FailureReason:string)[];\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, EventLog:string)[];\nunion isfuzzy=true\n    // MDI - IdentityDirectoryEvents (LDAP operations)\n    (union isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | extend AuthMethod = case(\n            DestinationPort == 636 or DestinationPort == 3269, \"LDAPS (SSL/TLS)\",\n            DestinationPort == 3268, \"Global Catalog (Unencrypted)\",\n            DestinationPort == 389, \"LDAP (Port 389)\",\n            \"LDAP Operation\")\n        | project TimeGenerated, AuthMethod, Source=\"MDI\"),\n    // MDI - IdentityLogonEvents (authentication events)\n    (union isfuzzy=true EmptyLogon, IdentityLogonEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | extend AuthMethod = case(\n            DestinationPort == 636, \"LDAPS (SSL/TLS)\",\n            isnotempty(FailureReason), \"Failed LDAP Auth\",\n            LogonType has \"Ntlm\" or LogonType has \"NTLM\", \"NTLM Bind\",\n            LogonType has \"Kerberos\", \"Kerberos Bind\",\n            \"LDAP Logon\")\n        | project TimeGenerated, AuthMethod, Source=\"MDI-Logon\"),\n    // Event table - if available\n    (union isfuzzy=true EmptyEvent, Event\n        | where TimeGenerated {TimeRange}\n        | where EventLog == \"Directory Service\"\n        | where EventID in (2886, 2887, 2889)\n        | extend AuthMethod = case(\n            EventID == 2887, \"Simple Bind (Clear Text)\",\n            EventID == 2889, \"Unsigned LDAP Bind\",\n            EventID == 2886, \"LDAP Signing Warning\",\n            \"Other\")\n        | project TimeGenerated, AuthMethod, Source=\"Event\")\n| where isnotempty(AuthMethod)\n| summarize Count = count() by AuthMethod\n| extend RiskLevel = case(\n    AuthMethod == \"Simple Bind (Clear Text)\", \"ðŸ”´ High Risk\",\n    AuthMethod == \"Unsigned LDAP Bind\", \"ðŸ”´ High Risk\",\n    AuthMethod == \"Anonymous Bind\", \"ðŸ”´ High Risk\",\n    AuthMethod == \"Failed LDAP Auth\", \"ðŸŸ  Medium Risk\",\n    AuthMethod == \"NTLM Bind\", \"ðŸŸ¡ Consider Kerberos\",\n    AuthMethod == \"LDAP Signing Warning\", \"ðŸŸ  Medium Risk\",\n    AuthMethod has \"SSL\" or AuthMethod has \"LDAPS\", \"ðŸŸ¢ Secure\",\n    AuthMethod == \"Kerberos Bind\", \"ðŸŸ¢ Secure\",\n    \"ðŸŸ¡ Review\")\n| project AuthMethod, Count, RiskLevel\n| order by Count desc",
                            "size": 0,
                            "title": "Authentication Methods Distribution",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Count",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    },
                                    {
                                        "columnMatch": "RiskLevel",
                                        "formatter": 1
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - auth methods",
                        "id": "4b824357-3e56-4d53-909f-2403f04d7cee"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Top Accounts with LDAP Activity - All MDI LDAP Users\n// Shows all accounts performing LDAP operations\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, AccountName:string, IPAddress:string, DestinationDeviceName:string, DestinationPort:int, AdditionalFields:dynamic)[];\nlet EmptyLogon = datatable(TimeGenerated:datetime, Protocol:string, AccountName:string, IPAddress:string, DestinationDeviceName:string, DestinationPort:int, FailureReason:string)[];\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, EventLog:string, RenderedDescription:string, Computer:string)[];\nunion isfuzzy=true\n    // MDI - IdentityDirectoryEvents (LDAP operations)\n    (union isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | extend Account = AccountName\n        | extend ClientIP = IPAddress\n        | extend DC = DestinationDeviceName\n        | extend AuthType = case(\n            DestinationPort == 636, \"LDAPS\",\n            DestinationPort == 3269, \"GC-LDAPS\",\n            \"LDAP\")\n        | project TimeGenerated, Account, ClientIP, DC, AuthType, Source=\"MDI\"),\n    // MDI - IdentityLogonEvents (LDAP logons)\n    (union isfuzzy=true EmptyLogon, IdentityLogonEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | extend Account = AccountName\n        | extend ClientIP = IPAddress\n        | extend DC = DestinationDeviceName\n        | extend AuthType = case(\n            isnotempty(FailureReason), \"Failed\",\n            DestinationPort == 636, \"LDAPS\",\n            \"LDAP Logon\")\n        | project TimeGenerated, Account, ClientIP, DC, AuthType, Source=\"MDI-Logon\"),\n    // Event 2889 if available\n    (union isfuzzy=true EmptyEvent, Event\n        | where TimeGenerated {TimeRange}\n        | where EventLog == \"Directory Service\"\n        | where EventID == 2889\n        | extend ClientIP = extract(@\"IP address:\\s*([\\d\\.]+)\", 1, RenderedDescription)\n        | extend Account = \"From Event 2889\"\n        | extend DC = Computer\n        | extend AuthType = \"Unsigned Bind\"\n        | project TimeGenerated, Account, ClientIP, DC, AuthType, Source=\"Event\")\n| where isnotempty(Account)\n| summarize \n    LDAPOperations = count(),\n    SourceIPs = make_set(ClientIP, 5),\n    DCs = make_set(DC, 5),\n    AuthTypes = make_set(AuthType),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by Account\n| top 20 by LDAPOperations desc\n| extend RiskIndicator = case(\n    AuthTypes has \"Unsigned\", \"ðŸ”´ Insecure Auth\",\n    AuthTypes has \"Failed\", \"ðŸŸ  Auth Failures\",\n    LDAPOperations > 10000, \"ðŸŸ  High Volume\",\n    \"ðŸŸ¢ Normal\")\n| project Account, LDAPOperations, RiskIndicator, AuthTypes, SourceIPs, DCs, LastSeen",
                            "size": 0,
                            "title": "Accounts Using Clear Text LDAP",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "ClearTextBinds",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "RiskScore",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Critical",
                                                    "representation": "redBright",
                                                    "text": "{0}{1}"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "High",
                                                    "representation": "orange",
                                                    "text": "{0}{1}"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Medium",
                                                    "representation": "yellow",
                                                    "text": "{0}{1}"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "gray",
                                                    "text": "{0}{1}"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "FirstSeen",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "LastSeen",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - clear text accounts",
                        "id": "d4efa9a4-cdbb-42e5-a1fa-af96f82f56e7"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Failed LDAP Authentication Attempts - LDAP Only\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, AccountName:string, IPAddress:string, FailedReason:string, LDAPQuery:string, FailureStatus:string)[];\nunion isfuzzy=true EmptyIDEvents,\n    (IdentityDirectoryEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | where ActionType has_any (\"failure\", \"failed\", \"error\", \"unsuccessful\")\n            or AdditionalFields has_any (\"failed\", \"error\", \"Failure\", \"denied\", \"rejected\")\n        | extend FailedReason = \"MDI LDAP Failure\"\n        | extend LDAPQuery = coalesce(tostring(parse_json(AdditionalFields).Query), tostring(parse_json(AdditionalFields).SearchFilter), ActionType)\n        | extend FailureStatus = coalesce(tostring(parse_json(AdditionalFields).FailureReason), tostring(parse_json(AdditionalFields).ErrorCode), \"Unknown\")),\n    (IdentityQueryEvents\n        | where TimeGenerated {TimeRange}\n        | where QueryType == \"LDAP\"\n        | where ActionType has_any (\"failure\", \"failed\", \"error\")\n        | extend AccountName = AccountUpn, FailedReason = \"MDI LDAP Query Failure\"\n        | extend LDAPQuery = Query\n        | extend FailureStatus = \"Query Failed\"),\n    (SecurityEvent\n        | where TimeGenerated {TimeRange}\n        | where EventID == 2889\n        | extend AccountName = Account, IPAddress = IpAddress\n        | extend FailedReason = \"Unsigned LDAP Bind\"\n        | extend LDAPQuery = \"Simple Bind without signing\"\n        | extend FailureStatus = \"Security Warning\"),\n    (SecurityEvent\n        | where TimeGenerated {TimeRange}\n        | where EventID == 2887\n        | extend AccountName = Account, IPAddress = IpAddress\n        | extend FailedReason = \"Clear Text LDAP Bind\"\n        | extend LDAPQuery = \"Simple Bind without SSL/TLS\"\n        | extend FailureStatus = \"Security Warning\"),\n    (DeviceNetworkEvents\n        | where TimeGenerated {TimeRange}\n        | where RemotePort in (389, 636, 3268, 3269)\n        | where ActionType has_any (\"ConnectionFailed\", \"ConnectionBlocked\")\n        | extend AccountName = InitiatingProcessAccountName, IPAddress = RemoteIP\n        | extend FailedReason = \"MDE Connection Issue\"\n        | extend LDAPQuery = strcat(\"LDAP Port \", RemotePort)\n        | extend FailureStatus = ActionType)\n| where isnotempty(AccountName)\n| summarize \n    LDAPIssues = count(),\n    UniqueSourceIPs = dcount(IPAddress),\n    SourceIPs = make_set(IPAddress, 5),\n    IssueTypes = make_set(FailedReason),\n    LDAPQueries = make_set(LDAPQuery, 5),\n    Statuses = make_set(FailureStatus, 5)\n    by AccountName\n| where LDAPIssues > 0\n| top 20 by LDAPIssues desc\n| extend ThreatLevel = case(\n    LDAPIssues > 100, \"Critical\",\n    LDAPIssues > 50, \"High\",\n    LDAPIssues > 10, \"Medium\",\n    \"Low\"\n)\n| project AccountName, LDAPIssues, UniqueSourceIPs, ThreatLevel, IssueTypes, LDAPQueries, Statuses, SourceIPs",
                            "size": 0,
                            "title": "LDAP Authentication & Binding Issues",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "FailedAttempts",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "query - failed auth",
                        "id": "eeca431d-703f-43ac-9473-5c70834b46f3"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Geographic Distribution of LDAP Clients - LDAP Only\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string, DestinationPort:int)[];\nunion isfuzzy=true EmptyIDEvents,\n    (IdentityDirectoryEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | where isnotempty(IPAddress)),\n    (IdentityQueryEvents\n        | where TimeGenerated {TimeRange}\n        | where QueryType == \"LDAP\"\n        | where isnotempty(IPAddress)),\n    (SecurityEvent\n        | where TimeGenerated {TimeRange}\n        | where EventID in (2886, 2887, 2889)\n        | where isnotempty(IpAddress) and IpAddress != \"-\"\n        | extend IPAddress = IpAddress),\n    (DeviceNetworkEvents\n        | where TimeGenerated {TimeRange}\n        | where RemotePort in (389, 636, 3268, 3269)\n        | extend IPAddress = RemoteIP)\n| where isnotempty(IPAddress) and not(ipv4_is_private(IPAddress))\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| where isnotempty(Country)\n| summarize LDAPQueries = count() by Country\n| top 10 by LDAPQueries desc\n| render barchart with (title=\"LDAP Queries by Geographic Location\")",
                            "size": 0,
                            "title": "Geographic Distribution",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "barchart"
                        },
                        "customWidth": "50",
                        "name": "query - geo distribution",
                        "id": "ebf385f5-2e85-4dce-9624-444a810ac8d4"
                    },
                    {
                        "type": 1,
                        "content": {
                            "json": "### ðŸ—ºï¸ LDAP Geolocation Analysis"
                        },
                        "name": "text - geo header",
                        "id": "99e11125-0d4c-4ea9-b4f3-a278110b07de"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// LDAP Activity Summary - All Sources (Internal + External)\n// Shows LDAP activity by client with location for external IPs\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string, DestinationPort:int)[];\nlet EmptyQueryEvents = datatable(TimeGenerated:datetime, QueryType:string, IPAddress:string, AccountUpn:string)[];\nlet EmptySecEvent = datatable(TimeGenerated:datetime, EventID:int, IpAddress:string, Account:string)[];\nlet EmptyMDE = datatable(TimeGenerated:datetime, RemotePort:int, RemoteIP:string, InitiatingProcessAccountName:string)[];\nunion isfuzzy=true\n    (union isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | where isnotempty(IPAddress)\n        | project TimeGenerated, IPAddress, AccountName, Source=\"MDI\"),\n    (union isfuzzy=true EmptyQueryEvents, IdentityQueryEvents\n        | where TimeGenerated {TimeRange}\n        | where QueryType == \"LDAP\"\n        | where isnotempty(IPAddress)\n        | extend AccountName = AccountUpn\n        | project TimeGenerated, IPAddress, AccountName, Source=\"MDI-Query\"),\n    (union isfuzzy=true EmptySecEvent, SecurityEvent\n        | where TimeGenerated {TimeRange}\n        | where EventID in (2886, 2887, 2889)\n        | where isnotempty(IpAddress) and IpAddress != \"-\"\n        | extend IPAddress = IpAddress, AccountName = Account\n        | project TimeGenerated, IPAddress, AccountName, Source=\"DC\"),\n    (union isfuzzy=true EmptyMDE, DeviceNetworkEvents\n        | where TimeGenerated {TimeRange}\n        | where RemotePort in (389, 636, 3268, 3269)\n        | extend IPAddress = RemoteIP, AccountName = InitiatingProcessAccountName\n        | project TimeGenerated, IPAddress, AccountName, Source=\"MDE\")\n| where IPAddress != \"127.0.0.1\" and IPAddress != \"::1\"\n| extend IsInternal = ipv4_is_private(IPAddress)\n| extend GeoInfo = iff(not(IsInternal), geo_info_from_ip_address(IPAddress), pack(\"country\", \"Internal Network\", \"city\", \"Corporate\", \"latitude\", 39.8283, \"longitude\", -98.5795))\n| extend Latitude = toreal(GeoInfo.latitude)\n| extend Longitude = toreal(GeoInfo.longitude)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| where isnotempty(Latitude) and isnotempty(Longitude)\n| summarize \n    LDAPQueries = count(),\n    UniqueAccounts = dcount(AccountName),\n    SampleIPs = make_set(IPAddress, 5),\n    Sources = make_set(Source)\n    by Longitude, Latitude, Country, City\n| extend LocationLabel = strcat(City, \", \", Country, \" - \", LDAPQueries, \" LDAP queries\")",
                            "size": 0,
                            "title": "ðŸ—ºï¸ LDAP Activity by Geographic Location",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "map",
                            "mapSettings": {
                                "locInfo": "LatLong",
                                "latitude": "Latitude",
                                "longitude": "Longitude",
                                "sizeSettings": "LDAPQueries",
                                "sizeAggregation": "Sum",
                                "labelSettings": "LocationLabel",
                                "legendMetric": "LDAPQueries",
                                "legendAggregation": "Sum",
                                "itemColorSettings": {
                                    "nodeColorField": "LDAPQueries",
                                    "colorAggregation": "Sum",
                                    "type": "heatmap",
                                    "heatmapPalette": "greenRed"
                                }
                            }
                        },
                        "name": "query - ldap geo map",
                        "id": "1d93ef59-3665-49c2-b579-e579bb193177"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// LDAP Binding Issues by Location (Internal and External IPs)\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, RenderedDescription:string, Computer:string)[];\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, IPAddress:string, AccountName:string, AdditionalFields:dynamic)[];\nunion isfuzzy=true\n    (union isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | where ActionType has \"failure\" or tostring(AdditionalFields) has_any (\"failed\", \"error\", \"unsigned\")\n        | where isnotempty(IPAddress)\n        | extend IssueType = \"MDI LDAP Issue\"\n        | project TimeGenerated, IPAddress, AccountName, IssueType),\n    (union isfuzzy=true EmptyEvent, Event\n        | where TimeGenerated {TimeRange}\n        | where EventLog == \"Directory Service\"\n        | where EventID == 2889\n        | extend IPAddress = extract(@\"IP address:\\s*([\\d\\.]+)\", 1, RenderedDescription)\n        | extend AccountName = extract(@\"account:\\s*([^\\s]+)\", 1, RenderedDescription)\n        | where isnotempty(IPAddress)\n        | extend IssueType = \"Unsigned LDAP Bind\"\n        | project TimeGenerated, IPAddress, AccountName, IssueType)\n| where IPAddress != \"127.0.0.1\" and IPAddress != \"::1\"\n| extend IsExternal = not(ipv4_is_private(IPAddress))\n| extend GeoInfo = iff(IsExternal, geo_info_from_ip_address(IPAddress), pack(\"country\", \"Internal\", \"city\", \"Private Network\", \"latitude\", 0.0, \"longitude\", 0.0))\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| extend Latitude = iff(IsExternal, toreal(GeoInfo.latitude), 37.7749)\n| extend Longitude = iff(IsExternal, toreal(GeoInfo.longitude), -122.4194)\n| summarize \n    LDAPIssues = count(),\n    UniqueAccounts = dcount(AccountName),\n    IssueTypes = make_set(IssueType),\n    SampleIPs = make_set(IPAddress, 5)\n    by Country, City, Latitude, Longitude\n| extend LocationLabel = strcat(City, \", \", Country, \" - \", LDAPIssues, \" issues\")",
                            "size": 0,
                            "title": "LDAP Binding Issues by Location",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "map",
                            "mapSettings": {
                                "locInfo": "LatLong",
                                "latitude": "Latitude",
                                "longitude": "Longitude",
                                "sizeSettings": "FailedAttempts",
                                "sizeAggregation": "Sum",
                                "labelSettings": "LocationLabel",
                                "legendMetric": "FailedAttempts",
                                "legendAggregation": "Sum",
                                "itemColorSettings": {
                                    "nodeColorField": "FailedAttempts",
                                    "colorAggregation": "Sum",
                                    "type": "heatmap",
                                    "heatmapPalette": "yellowOrangeRed"
                                }
                            }
                        },
                        "name": "query - ldap failed geo map",
                        "id": "cd778bcf-d404-4981-aef5-9cba84678db6"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// LDAP Activity by Country - LDAP Only\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string, DestinationPort:int)[];\nunion isfuzzy=true EmptyIDEvents,\n    (IdentityDirectoryEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | where isnotempty(IPAddress)),\n    (IdentityQueryEvents\n        | where TimeGenerated {TimeRange}\n        | where QueryType == \"LDAP\"\n        | where isnotempty(IPAddress)),\n    (SecurityEvent\n        | where TimeGenerated {TimeRange}\n        | where EventID in (2886, 2887, 2889)\n        | where isnotempty(IpAddress) and IpAddress != \"-\"\n        | extend IPAddress = IpAddress, AccountName = Account),\n    (DeviceNetworkEvents\n        | where TimeGenerated {TimeRange}\n        | where RemotePort in (389, 636, 3268, 3269)\n        | extend IPAddress = RemoteIP, AccountName = InitiatingProcessAccountName)\n| where IPAddress != \"127.0.0.1\"\n| where not(ipv4_is_private(IPAddress))\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| where isnotempty(Country)\n| summarize \n    TotalLDAPQueries = count(),\n    UniqueAccounts = dcount(AccountName),\n    UniqueIPs = dcount(IPAddress),\n    IPList = make_set(IPAddress, 5)\n    by Country\n| extend ThreatLevel = case(\n    TotalLDAPQueries > 10000, \"ðŸ”´ Very High\",\n    TotalLDAPQueries > 1000, \"ðŸŸ  High\",\n    TotalLDAPQueries > 100, \"ðŸŸ¡ Medium\",\n    \"ðŸŸ¢ Low\"\n)\n| order by TotalLDAPQueries desc\n| take 15",
                            "size": 0,
                            "title": "LDAP Activity by Country",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table"
                        },
                        "customWidth": "50",
                        "name": "query - ldap by country",
                        "id": "3374c630-b7df-4f0f-8137-7e9bbf8cc0ee"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// LDAP Activity by City - LDAP Only\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string, DestinationPort:int)[];\nunion isfuzzy=true EmptyIDEvents,\n    (IdentityDirectoryEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | where isnotempty(IPAddress)),\n    (IdentityQueryEvents\n        | where TimeGenerated {TimeRange}\n        | where QueryType == \"LDAP\"\n        | where isnotempty(IPAddress)),\n    (SecurityEvent\n        | where TimeGenerated {TimeRange}\n        | where EventID in (2886, 2887, 2889)\n        | where isnotempty(IpAddress) and IpAddress != \"-\"\n        | extend IPAddress = IpAddress, AccountName = Account),\n    (DeviceNetworkEvents\n        | where TimeGenerated {TimeRange}\n        | where RemotePort in (389, 636, 3268, 3269)\n        | extend IPAddress = RemoteIP, AccountName = InitiatingProcessAccountName)\n| where IPAddress != \"127.0.0.1\"\n| where not(ipv4_is_private(IPAddress))\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| where isnotempty(City)\n| summarize \n    TotalLDAPQueries = count(),\n    UniqueAccounts = dcount(AccountName),\n    UniqueIPs = dcount(IPAddress)\n    by City, Country\n| extend Location = strcat(City, \", \", Country)\n| project Location, TotalLDAPQueries, UniqueAccounts, UniqueIPs\n| order by TotalLDAPQueries desc\n| take 15",
                            "size": 0,
                            "title": "LDAP Activity by City",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table"
                        },
                        "customWidth": "50",
                        "name": "query - ldap by city",
                        "id": "aded3d5a-2ef4-42eb-885a-6c478ddb466a"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// LDAP from New Geographic Locations - Combined Data Sources\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, IPAddress:string, AccountName:string)[];\nlet EmptySecEvent = datatable(TimeGenerated:datetime, EventID:int, IpAddress:string, TargetUserName:string)[];\nlet BaselineCountries = union isfuzzy=true\n    (union isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n        | where TimeGenerated between (ago(60d) .. ago(7d))\n        | where Protocol == \"Ldap\"\n        | where isnotempty(IPAddress)),\n    (union isfuzzy=true EmptySecEvent, SecurityEvent\n        | where TimeGenerated between (ago(60d) .. ago(7d))\n        | where EventID in (2886, 2887, 2889)\n        | where isnotempty(IpAddress)\n        | extend IPAddress = IpAddress, AccountName = TargetUserName)\n| where isnotempty(IPAddress) and not(ipv4_is_private(IPAddress))\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| where isnotempty(Country)\n| summarize by AccountName, Country;\nlet CurrentActivity = union isfuzzy=true\n    (union isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n        | where TimeGenerated > ago(7d)\n        | where Protocol == \"Ldap\"\n        | where isnotempty(IPAddress)),\n    (union isfuzzy=true EmptySecEvent, SecurityEvent\n        | where TimeGenerated > ago(7d)\n        | where EventID in (2886, 2887, 2889)\n        | where isnotempty(IpAddress)\n        | extend IPAddress = IpAddress, AccountName = TargetUserName)\n| where isnotempty(IPAddress) and not(ipv4_is_private(IPAddress))\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| where isnotempty(Country);\nCurrentActivity\n| join kind=leftanti (BaselineCountries) on AccountName, Country\n| summarize \n    NewGeoQueries = count(),\n    Cities = make_set(City, 5),\n    IPs = make_set(IPAddress, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by AccountName, Country\n| extend RiskLevel = \"New Geographic Location\"\n| order by NewGeoQueries desc",
                            "size": 0,
                            "title": "âš ï¸ LDAP Activity from New Geographic Locations",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table"
                        },
                        "name": "query - new geo locations",
                        "id": "bd29ad8a-88c8-4aa6-a195-4a115f91d256"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "AuthAnalysis"
            },
            "name": "group - auth analysis",
            "id": "bdc82e1d-9996-4a4b-acdf-4fdb40678aa0"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "### ðŸ” LDAP Reconnaissance Detection\n\nDetect suspicious LDAP enumeration, mass queries, and reconnaissance patterns indicative of attack preparation."
                        },
                        "name": "text - recon header",
                        "id": "398eb32f-0ab8-49ca-ba99-e90c160802e3"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// High-Volume LDAP Query Detection (MDI + Event 1644)\n// Shows all LDAP activity by source with volume indicators from both MDI and Event 1644\nlet EmptyMDI = datatable(TimeGenerated:datetime, AccountName:string, DeviceName:string, IPAddress:string, ActionType:string, TargetAccountDisplayName:string, Source:string)[];\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, EventLog:string, RenderedDescription:string, Computer:string)[];\nunion isfuzzy=true\n    // MDI source\n    (union isfuzzy=true EmptyMDI, IdentityDirectoryEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | extend Source = \"MDI\"\n        | project TimeGenerated, AccountName, DeviceName, IPAddress, ActionType, TargetAccountDisplayName, Source),\n    // Event 1644 source\n    (union isfuzzy=true EmptyEvent, Event\n        | where TimeGenerated {TimeRange}\n        | where EventLog == \"Directory Service\"\n        | where EventID == 1644\n        | extend AccountName = extract(@\"User:\\\\s*(.+?)\\\\s\", 1, RenderedDescription)\n        | extend IPAddress = extract(@\"Client IP:\\\\s*([\\\\d\\\\.]+)\", 1, RenderedDescription)\n        | extend Filter = extract(@\"Filter:\\\\s*(.+?)\\\\s*(Visited|$)\", 1, RenderedDescription)\n        | extend DeviceName = Computer, ActionType = \"Event1644\", TargetAccountDisplayName = Filter, Source = \"Event1644\"\n        | project TimeGenerated, AccountName, DeviceName, IPAddress, ActionType, TargetAccountDisplayName, Source)\n| summarize \n    QueryCount = count(),\n    UniqueTargets = dcount(TargetAccountDisplayName),\n    Actions = make_set(ActionType, 5),\n    Sources = make_set(Source),\n    FirstQuery = min(TimeGenerated),\n    LastQuery = max(TimeGenerated)\n    by AccountName, DeviceName, IPAddress\n| extend SuspicionLevel = case(\n    QueryCount > 1000, \"ðŸ”´ Critical - Likely Enumeration Tool\",\n    QueryCount > 500, \"ðŸŸ  High - Mass Enumeration\",\n    QueryCount > 100, \"ðŸŸ¡ Medium - High Volume\",\n    QueryCount > 20, \"Low - Normal\",\n    \"ðŸŸ¢ Low\")\n| project AccountName, DeviceName, IPAddress, QueryCount, UniqueTargets, SuspicionLevel, Actions, Sources, FirstQuery, LastQuery\n| order by QueryCount desc\n| take 50",
                            "size": 0,
                            "title": "High-Volume LDAP Reconnaissance Activity",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "QueryCount",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "TimeGenerated",
                                        "formatter": 6
                                    }
                                ],
                                "rowLimit": 50
                            }
                        },
                        "name": "query - recon activity",
                        "id": "5c8f872f-d749-4624-b87f-2cf67b38402a"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// After-Hours LDAP Activity - Combined Sources\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string, DestinationPort:int)[];\nunion isfuzzy=true EmptyIDEvents,\n    (IdentityDirectoryEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | extend Source = \"MDI\"),\n    (SecurityEvent\n        | where TimeGenerated {TimeRange}\n        | where EventID in (4624, 4625, 2886, 2887, 2889)\n        | extend AccountName = coalesce(TargetUserName, SubjectUserName), DeviceName = Computer, IPAddress = IpAddress\n        | extend Source = \"DC\")\n| extend Hour = datetime_part(\"Hour\", TimeGenerated)\n| extend DayOfWeek = dayofweek(TimeGenerated)\n| extend IsAfterHours = case(\n    DayOfWeek >= 5d, \"Weekend\",\n    Hour < 6 or Hour > 20, \"After Hours\",\n    \"Business Hours\"\n)\n| where IsAfterHours != \"Business Hours\"\n| summarize \n    QueryCount = count(),\n    Sources = make_set(Source),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by AccountName, DeviceName, IPAddress, IsAfterHours\n| where QueryCount > 50\n| extend RiskLevel = case(\n    QueryCount > 500, \"ðŸ”´ High\",\n    QueryCount > 100, \"ðŸŸ¡ Medium\",\n    \"ðŸŸ¢ Low\"\n)\n| project AccountName, DeviceName, IPAddress, QueryCount, IsAfterHours, RiskLevel, Sources, FirstSeen, LastSeen\n| order by QueryCount desc",
                            "size": 0,
                            "title": "After-Hours LDAP Activity",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "QueryCount",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "yellow"
                                        }
                                    },
                                    {
                                        "columnMatch": "FirstSeen",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "LastSeen",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - after hours",
                        "id": "e4bd8840-c0c7-4798-ad14-f93e97543437"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// LDAP Modification of Sensitive Objects - Combined Sources\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string, DestinationPort:int)[];\nunion isfuzzy=true EmptyIDEvents,\n    (IdentityDirectoryEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | where ActionType has_any (\"modified\", \"added\", \"deleted\")\n        | where TargetAccountDisplayName has_any (\"Administrator\", \"Domain Admin\", \"Enterprise Admin\", \"krbtgt\")\n            or AdditionalFields has_any (\"AdminSDHolder\", \"Domain Controllers\", \"Schema Admins\", \"Group Policy\")\n        | extend ModificationType = ActionType, Source = \"MDI\"),\n    (SecurityEvent\n        | where TimeGenerated {TimeRange}\n        | where EventID in (4738, 4728, 4729, 4732, 4733, 4756, 4757)  // Group/Account modifications\n        | where TargetUserName has_any (\"Administrator\", \"Domain Admin\", \"Enterprise Admin\", \"krbtgt\")\n            or TargetAccount has_any (\"Domain Admins\", \"Enterprise Admins\", \"Schema Admins\")\n        | extend AccountName = SubjectUserName, AccountDomain = SubjectDomainName, DeviceName = Computer, IPAddress = IpAddress\n        | extend TargetAccountDisplayName = TargetUserName, ModificationType = \"Security Event\", Source = \"DC\")\n| summarize \n    ModificationCount = count(),\n    Targets = make_set(TargetAccountDisplayName, 10),\n    ModificationTypes = make_set(ModificationType),\n    Sources = make_set(Source),\n    FirstModification = min(TimeGenerated),\n    LastModification = max(TimeGenerated)\n    by AccountName, AccountDomain, DeviceName, IPAddress\n| where ModificationCount > 0\n| extend ThreatLevel = \"ðŸ”´ Critical\"\n| project AccountName, DeviceName, IPAddress, ModificationCount, Targets, ModificationTypes, ThreatLevel, FirstModification, LastModification\n| order by ModificationCount desc",
                            "size": 0,
                            "title": "Modifications to Sensitive AD Objects",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "ModificationCount",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "FirstModification",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "LastModification",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "name": "query - modifications",
                        "id": "ac9261aa-4f04-4a83-8b49-702cb19201e3"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "Reconnaissance"
            },
            "name": "group - reconnaissance",
            "id": "60d1569e-cc29-47ec-a885-e01bc474fb93"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "### ðŸ‘‘ Privileged Account Monitoring\n\nMonitor LDAP activity targeting privileged accounts, high-value groups, and sensitive security principals.\n\n**âš ï¸ Data Requirements:**\n- **Event 1644** must be enabled on DCs to capture LDAP query patterns (filters like Domain Admins, adminCount)\n- OR **Microsoft Defender for Identity (MDI)** for IdentityDirectoryEvents\n\n| Target Group | Risk Level | Common Attack Pattern |\n|-------------|------------|----------------------|\n| Domain Admins | ðŸ”´ Critical | Primary target for domain dominance |\n| Enterprise Admins | ðŸ”´ Critical | Forest-wide compromise |\n| Schema Admins | ðŸ”´ Critical | Permanent backdoor creation |\n| Backup Operators | ðŸŸ  High | NTDS.dit extraction |\n| Account Operators | ðŸŸ  High | Account manipulation |\n| KRBTGT | ðŸ”´ Critical | Golden Ticket creation |"
                        },
                        "name": "text - priv header",
                        "id": "d5132876-8d3a-4e93-9a44-68ed0ae93cb8"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Data Source Availability Check - Handles Missing Tables\n// This query checks which LDAP-related tables have data in your workspace\nlet EmptyResult = datatable(Source:string, EventCount:long, TableExists:bool)[];\n// Check each table using union isfuzzy which handles missing tables\nlet Results = union isfuzzy=true\n    // MDI - IdentityDirectoryEvents\n    (IdentityDirectoryEvents\n        | where TimeGenerated > ago(7d)\n        | where Protocol == \"Ldap\"\n        | summarize EventCount = count()\n        | extend Source = \"MDI (IdentityDirectoryEvents)\", TableExists = true),\n    // MDI - IdentityQueryEvents  \n    (IdentityQueryEvents\n        | where TimeGenerated > ago(7d)\n        | summarize EventCount = count()\n        | extend Source = \"IdentityQueryEvents (MDI Queries)\", TableExists = true),\n    // MDI - IdentityLogonEvents\n    (IdentityLogonEvents\n        | where TimeGenerated > ago(7d)\n        | where Protocol == \"Ldap\"\n        | summarize EventCount = count()\n        | extend Source = \"IdentityLogonEvents (MDI Logons)\", TableExists = true),\n    // Event table - Directory Service\n    (Event\n        | where TimeGenerated > ago(7d)\n        | where EventLog == \"Directory Service\"\n        | summarize EventCount = count()\n        | extend Source = \"Event (Directory Service Log)\", TableExists = true),\n    // Event 1644 specifically\n    (Event\n        | where TimeGenerated > ago(7d)\n        | where EventLog == \"Directory Service\"\n        | where EventID == 1644\n        | summarize EventCount = count()\n        | extend Source = \"Event 1644 (Expensive Queries)\", TableExists = true),\n    // Event 2889 specifically\n    (Event\n        | where TimeGenerated > ago(7d)\n        | where EventLog == \"Directory Service\"\n        | where EventID == 2889\n        | summarize EventCount = count()\n        | extend Source = \"Event 2889 (Unsigned Binds)\", TableExists = true),\n    // WindowsEvent table (alternative to Event)\n    (WindowsEvent\n        | where TimeGenerated > ago(7d)\n        | where Channel == \"Directory Service\"\n        | summarize EventCount = count()\n        | extend Source = \"WindowsEvent (Directory Service)\", TableExists = true),\n    // DeviceNetworkEvents - LDAP traffic\n    (DeviceNetworkEvents\n        | where TimeGenerated > ago(7d)\n        | where RemotePort in (389, 636, 3268, 3269)\n        | summarize EventCount = count()\n        | extend Source = \"DeviceNetworkEvents (LDAP Traffic)\", TableExists = true),\n    // SecurityEvent - Kerberos (indicates DC connectivity)\n    (SecurityEvent\n        | where TimeGenerated > ago(7d)\n        | where EventID in (4768, 4769)\n        | summarize EventCount = count()\n        | extend Source = \"SecurityEvent (Kerberos TGT/TGS)\", TableExists = true)\n| where EventCount > 0;\nResults\n| extend Status = \"Available\"\n| extend Action = case(\n    Source has \"MDI\" or Source has \"Identity\", \"âœ… Ready - MDI active\",\n    Source has \"1644\", \"âœ… Ready - Field Engineering enabled\",\n    Source has \"2889\", \"âœ… Ready - Unsigned binds logged\",\n    Source has \"Event\" or Source has \"Windows\", \"âœ… Ready - Event collection active\",\n    Source has \"Network\", \"âœ… Ready - Network telemetry active\",\n    Source has \"Security\", \"âœ… Ready - DC Security events flowing\",\n    \"âœ… Data available\"\n)\n| project ['Data Source'] = Source, Status, ['Event Count (7d)'] = EventCount, ['Status Detail'] = Action\n| order by ['Event Count (7d)'] desc",
                            "size": 0,
                            "title": "ðŸ“Š Data Source Availability (Last 7 Days)",
                            "timeContext": {
                                "durationMs": 604800000
                            },
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Status",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Available",
                                                    "representation": "green",
                                                    "text": "âœ… {0}"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "redBright",
                                                    "text": "âŒ {0}"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "EventCount",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "query - data source check",
                        "id": "6010d584-dc04-4793-b712-7ba52d023304"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// All Event 1644 Data (Raw View) - Check if any data exists\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, EventLog:string, RenderedDescription:string, Computer:string)[];\nunion isfuzzy=true EmptyEvent, Event\n| where TimeGenerated {TimeRange}\n| where EventLog == \"Directory Service\"\n| where EventID == 1644\n| extend ClientIP = extract(@\"Client IP:\\s*([\\d\\.]+)\", 1, RenderedDescription)\n| extend Filter = extract(@\"Filter:\\s*(.+?)\\s*(Visited|$)\", 1, RenderedDescription)\n| extend VisitedEntries = extract(@\"Visited entries:\\s*(\\d+)\", 1, RenderedDescription)\n| project TimeGenerated, Computer, ClientIP, Filter, VisitedEntries\n| order by TimeGenerated desc\n| take 20",
                            "size": 0,
                            "title": "ðŸ“‹ Recent Event 1644 Data (Raw)",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "TimeGenerated",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "name": "query - raw event 1644",
                        "id": "6b427cf2-c709-47d1-8f39-da11193e4a4c"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// All LDAP Activity with Privileged Target Indicators (MDI + Event 1644)\n// Shows all MDI and Event 1644 LDAP events, highlighting those targeting privileged accounts\nlet PrivGroups = dynamic([\"Domain Admins\", \"Enterprise Admins\", \"Schema Admins\", \"Administrators\", \"Account Operators\", \"Backup Operators\", \"Server Operators\", \"DnsAdmins\", \"krbtgt\", \"adminCount\", \"Admin\"]);\nlet EmptyMDI = datatable(TimeGenerated:datetime, TargetedGroup:string, AccountName:string, IPAddress:string, DeviceName:string, ActionType:string, IsPrivilegedQuery:bool, TargetAccountDisplayName:string, Source:string)[];\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, EventLog:string, RenderedDescription:string, Computer:string)[];\nunion isfuzzy=true EmptyMDI,\n    // MDI source\n    (IdentityDirectoryEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | extend AdditionalFieldsStr = tostring(AdditionalFields)\n        | extend IsPrivilegedQuery = TargetAccountDisplayName has_any (PrivGroups) or AdditionalFieldsStr has_any (PrivGroups)\n        | extend TargetedGroup = case(\n            TargetAccountDisplayName has \"Domain Admins\" or AdditionalFieldsStr has \"Domain Admins\", \"Domain Admins\",\n            TargetAccountDisplayName has \"Enterprise Admins\" or AdditionalFieldsStr has \"Enterprise Admins\", \"Enterprise Admins\",\n            TargetAccountDisplayName has \"Admin\" or AdditionalFieldsStr has \"Admin\", \"Other Admin\",\n            TargetAccountDisplayName has \"krbtgt\" or AdditionalFieldsStr has \"krbtgt\", \"KRBTGT Account\",\n            AdditionalFieldsStr has \"adminCount\", \"AdminCount Query\",\n            isnotempty(TargetAccountDisplayName), \"Named Object\",\n            \"General LDAP\")\n        | extend Source = \"MDI\"\n        | project TimeGenerated, TargetedGroup, AccountName, IPAddress, DeviceName, ActionType, IsPrivilegedQuery, TargetAccountDisplayName, Source),\n    // Event 1644 source\n    (union isfuzzy=true EmptyEvent, Event\n        | where TimeGenerated {TimeRange}\n        | where EventLog == \"Directory Service\"\n        | where EventID == 1644\n        | extend Filter = extract(@\"Filter:\\\\s*(.+?)\\\\s*(Visited|$)\", 1, RenderedDescription)\n        | extend IsPrivilegedQuery = Filter has_any (PrivGroups)\n        | extend TargetedGroup = case(\n            Filter has \"Domain Admins\", \"Domain Admins\",\n            Filter has \"Enterprise Admins\", \"Enterprise Admins\",\n            Filter has \"Admin\", \"Other Admin\",\n            Filter has \"krbtgt\", \"KRBTGT Account\",\n            Filter has \"adminCount\", \"AdminCount Query\",\n            \"General LDAP\")\n        | extend AccountName = extract(@\"User:\\\\s*(.+?)\\\\s\", 1, RenderedDescription)\n        | extend IPAddress = extract(@\"Client IP:\\\\s*([\\\\d\\\\.]+)\", 1, RenderedDescription)\n        | extend DeviceName = Computer, ActionType = \"Event1644\", TargetAccountDisplayName = Filter, Source = \"Event1644\"\n        | project TimeGenerated, TargetedGroup, AccountName, IPAddress, DeviceName, ActionType, IsPrivilegedQuery, TargetAccountDisplayName, Source)\n| summarize \n    QueryCount = count(),\n    UniqueTargets = dcount(TargetAccountDisplayName),\n    PrivQueries = countif(IsPrivilegedQuery),\n    Actions = make_set(ActionType, 5),\n    Sources = make_set(Source),\n    SampleTargets = make_set(TargetAccountDisplayName, 5)\n    by TargetedGroup, AccountName, IPAddress, DeviceName\n| extend Risk = case(\n    TargetedGroup in (\"Domain Admins\", \"Enterprise Admins\", \"KRBTGT Account\") and QueryCount > 5, \"ðŸ”´ Critical\",\n    TargetedGroup in (\"Domain Admins\", \"Enterprise Admins\", \"KRBTGT Account\"), \"ðŸŸ  High\",\n    TargetedGroup == \"AdminCount Query\" or TargetedGroup == \"Other Admin\", \"ðŸŸ¡ Medium\",\n    QueryCount > 100, \"High Volume\",\n    \"Low\")\n| project TargetedGroup, QueryCount, PrivQueries, Risk, AccountName, IPAddress, DeviceName, Sources, SampleTargets\n| order by case(Risk == \"ðŸ”´ Critical\", 1, Risk == \"ðŸŸ  High\", 2, Risk == \"ðŸŸ¡ Medium\", 3, Risk == \"High Volume\", 4, 5), QueryCount desc",
                            "size": 0,
                            "title": "Privileged Group Enumeration",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "QueryCount",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - priv groups",
                        "id": "3a6c9af2-1eb1-4dab-b3ec-fec272b164dd"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// LDAP Activity Trend by Target Type\n// Shows all LDAP activity over time, categorized by target sensitivity\nlet PrivilegedKeywords = dynamic([\"Admin\", \"Domain Admins\", \"Enterprise Admins\", \"krbtgt\", \"adminCount\"]);\nlet EmptyMDI = datatable(TimeGenerated:datetime, Protocol:string, AdditionalFields:dynamic, TargetAccountDisplayName:string)[];\nunion isfuzzy=true EmptyMDI, IdentityDirectoryEvents\n| where TimeGenerated {TimeRange}\n| where Protocol == \"Ldap\"\n| extend AdditionalFieldsStr = tostring(AdditionalFields)\n| extend QueryCategory = case(\n    TargetAccountDisplayName has_any (PrivilegedKeywords) or AdditionalFieldsStr has_any (PrivilegedKeywords), \"Privileged Target\",\n    isnotempty(TargetAccountDisplayName), \"Named Target\",\n    \"General LDAP\")\n| summarize QueryCount = count() by bin(TimeGenerated, 1h), QueryCategory\n| render timechart with (title=\"LDAP Activity by Target Type\")",
                            "size": 0,
                            "title": "Privileged Group Query Trend",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "timechart"
                        },
                        "customWidth": "50",
                        "name": "query - priv trend",
                        "id": "c85372f2-d1f9-4973-b9c5-401e0ee0ae2e"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Top LDAP Queries to Privileged Accounts - Combined Data Sources\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string, DestinationPort:int)[];\nunion isfuzzy=true EmptyIDEvents,\n    (IdentityDirectoryEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | where TargetAccountDisplayName has_any (\"Administrator\", \"Domain Admins\", \"Enterprise Admins\", \"Schema Admins\", \"Backup Operators\", \"Account Operators\", \"krbtgt\")\n            or AdditionalFields has_any (\"Domain Admins\", \"Enterprise Admins\", \"Schema Admins\", \"adminCount=1\", \"primaryGroupID=512\", \"memberOf\")\n        | extend LDAPQuery = coalesce(tostring(parse_json(AdditionalFields).Query), tostring(parse_json(AdditionalFields).SearchFilter), ActionType)\n        | extend TargetObject = coalesce(TargetAccountDisplayName, tostring(parse_json(AdditionalFields).TargetObject))\n        | extend Source = \"MDI\"),\n    (SecurityEvent\n        | where TimeGenerated {TimeRange}\n        | where EventID == 4662  // AD object access\n        | where ObjectName has_any (\"Domain Admins\", \"Enterprise Admins\", \"Schema Admins\", \"Administrators\", \"krbtgt\")\n        | extend AccountName = SubjectUserName, AccountDomain = SubjectDomainName, DeviceName = Computer, IPAddress = IpAddress\n        | extend LDAPQuery = strcat(\"Object Access: \", ObjectName)\n        | extend TargetObject = ObjectName\n        | extend Source = \"DC\")\n| where isnotempty(LDAPQuery)\n| summarize \n    QueryCount = count(),\n    UniqueAccounts = dcount(AccountName),\n    Accounts = make_set(AccountName, 5),\n    Devices = make_set(DeviceName, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by LDAPQuery, TargetObject\n| top 25 by QueryCount desc\n| extend Risk = case(\n    TargetObject has_any (\"Domain Admins\", \"Enterprise Admins\", \"krbtgt\"), \"ðŸ”´ Critical\",\n    TargetObject has_any (\"Schema Admins\", \"Backup Operators\"), \"ðŸŸ  High\",\n    \"ðŸŸ¡ Medium\"\n)\n| project LDAPQuery, TargetObject, QueryCount, UniqueAccounts, Risk, Accounts, Devices, FirstSeen, LastSeen",
                            "size": 0,
                            "title": "ðŸ” Top LDAP Queries to Privileged Accounts",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "QueryCount",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "FirstSeen",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "LastSeen",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "name": "query - top priv queries",
                        "id": "8b7d75d9-1c41-424b-a85d-846bd32ff16d"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// KRBTGT Account Access Monitoring (Golden Ticket Risk)\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string)[];\nunion isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n| where TimeGenerated {TimeRange}\n| where Protocol == \"Ldap\"\n| where TargetAccountDisplayName has \"krbtgt\" or AdditionalFields has \"krbtgt\" or AdditionalFields has \"502\"\n| project TimeGenerated, AccountName, DeviceName, IPAddress, ActionType, AdditionalFields\n| extend ThreatLevel = \"CRITICAL - Potential Golden Ticket Preparation\"\n| order by TimeGenerated desc",
                            "size": 0,
                            "title": "ðŸ”´ KRBTGT Account Access (Golden Ticket Risk)",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "TimeGenerated",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "name": "query - krbtgt",
                        "id": "d603d778-12e2-42ad-94fa-a8cc55ad3517"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// AdminSDHolder Modification Detection\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string, DestinationPort:int)[];\nunion isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n| where TimeGenerated {TimeRange}\n| where Protocol == \"Ldap\"\n| where AdditionalFields has \"AdminSDHolder\" or TargetAccountDisplayName has \"AdminSDHolder\"\n| where ActionType has_any (\"modified\", \"added\", \"deleted\")\n| project TimeGenerated, AccountName, DeviceName, IPAddress, ActionType, AdditionalFields\n| extend ThreatLevel = \"ðŸ”´ CRITICAL - Persistence Mechanism\"\n| order by TimeGenerated desc",
                            "size": 0,
                            "title": "ðŸ”´ AdminSDHolder Modifications (Persistence)",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "TimeGenerated",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - adminsdholder",
                        "id": "43446c28-6fde-434b-a833-adf07d090f21"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Service Principal Name (SPN) Queries - Kerberoasting Preparation\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string, DestinationPort:int)[];\nunion isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n| where TimeGenerated {TimeRange}\n| where Protocol == \"Ldap\"\n| where AdditionalFields has \"servicePrincipalName\"\n| summarize \n    SPNQueries = count(),\n    Actions = make_set(ActionType, 5),\n    FirstQuery = min(TimeGenerated),\n    LastQuery = max(TimeGenerated)\n    by AccountName, DeviceName, IPAddress\n| where SPNQueries > 3\n| extend ThreatLevel = case(\n    SPNQueries > 20, \"ðŸ”´ Critical - Mass SPN Enumeration\",\n    SPNQueries > 10, \"ðŸŸ  High - SPN Discovery\",\n    \"ðŸŸ¡ Medium - Investigate\"\n)\n| order by SPNQueries desc",
                            "size": 0,
                            "title": "ðŸŸ  SPN Enumeration (Kerberoasting Preparation)",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "SPNQueries",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    },
                                    {
                                        "columnMatch": "FirstQuery",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "LastQuery",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - spn",
                        "id": "9a87b55e-6f48-427a-a527-0e4d7285664c"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Delegation Settings Enumeration (Unconstrained/Constrained)\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string, DestinationPort:int)[];\nunion isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n| where TimeGenerated {TimeRange}\n| where Protocol == \"Ldap\"\n| where AdditionalFields has_any (\"msDS-AllowedToDelegateTo\", \"TRUSTED_FOR_DELEGATION\", \"TRUSTED_TO_AUTH_FOR_DELEGATION\", \"userAccountControl\")\n    and AdditionalFields has_any (\"524288\", \"16777216\")  // UAC flags for delegation\n| summarize \n    DelegationQueries = count(),\n    FirstQuery = min(TimeGenerated),\n    LastQuery = max(TimeGenerated)\n    by AccountName, DeviceName, IPAddress\n| extend ThreatLevel = case(\n    DelegationQueries > 10, \"ðŸ”´ Critical - Delegation Abuse Preparation\",\n    DelegationQueries > 5, \"ðŸŸ  High\",\n    \"ðŸŸ¡ Medium\"\n)\n| order by DelegationQueries desc",
                            "size": 0,
                            "title": "ðŸŸ  Delegation Settings Discovery (Lateral Movement Prep)",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "DelegationQueries",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    },
                                    {
                                        "columnMatch": "FirstQuery",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "LastQuery",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "name": "query - delegation",
                        "id": "37548b86-aa69-46fd-a167-3273263fe438"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// GPO Enumeration (Pre-Attack Reconnaissance)\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string, DestinationPort:int)[];\nunion isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n| where TimeGenerated {TimeRange}\n| where Protocol == \"Ldap\"\n| where AdditionalFields has_any (\"groupPolicyContainer\", \"gPLink\", \"gPCFileSysPath\", \"Group Policy\")\n| summarize \n    GPOQueries = count(),\n    FirstQuery = min(TimeGenerated),\n    LastQuery = max(TimeGenerated)\n    by AccountName, DeviceName, IPAddress\n| where GPOQueries > 5\n| extend ThreatLevel = case(\n    GPOQueries > 50, \"ðŸ”´ Critical - Mass GPO Enumeration\",\n    GPOQueries > 20, \"ðŸŸ  High\",\n    \"ðŸŸ¡ Medium\"\n)\n| order by GPOQueries desc",
                            "size": 0,
                            "title": "ðŸŸ  GPO Enumeration (Ransomware Preparation)",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "GPOQueries",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    },
                                    {
                                        "columnMatch": "FirstQuery",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "LastQuery",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "name": "query - gpo",
                        "id": "e4c61de7-e254-45cf-9123-e693ed263937"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Certificate Template Enumeration (AD CS Attacks - ESC1-ESC8)\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string, DestinationPort:int)[];\nunion isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n| where TimeGenerated {TimeRange}\n| where Protocol == \"Ldap\"\n| where AdditionalFields has_any (\"pKICertificateTemplate\", \"msPKI-Certificate-Name-Flag\", \"msPKI-Enrollment-Flag\", \"Cert Publishers\", \"CA-\", \"Certificate\")\n    or TargetAccountDisplayName has \"Certificate\"\n| summarize \n    CertQueries = count(),\n    Templates = make_set(TargetAccountDisplayName, 10),\n    FirstQuery = min(TimeGenerated),\n    LastQuery = max(TimeGenerated)\n    by AccountName, DeviceName, IPAddress\n| where CertQueries > 2\n| extend ThreatLevel = case(\n    CertQueries > 20, \"ðŸ”´ Critical - AD CS Reconnaissance\",\n    CertQueries > 10, \"ðŸŸ  High - Certificate Template Discovery\",\n    \"ðŸŸ¡ Medium - Investigate\"\n)\n| extend ESCRisk = \"Potential ESC1/ESC2/ESC4 Attack Preparation\"\n| order by CertQueries desc",
                            "size": 0,
                            "title": "ðŸ”´ Certificate Template Enumeration (AD CS Attacks)",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "CertQueries",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "FirstQuery",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "LastQuery",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - cert templates",
                        "id": "82161f7d-4084-47a2-b2e3-eee9ec47a8cd"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Domain Trust Enumeration (Cross-Forest Attacks)\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string, DestinationPort:int)[];\nunion isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n| where TimeGenerated {TimeRange}\n| where Protocol == \"Ldap\"\n| where AdditionalFields has_any (\"trustedDomain\", \"trustDirection\", \"trustType\", \"trustAttributes\", \"domainDNS\", \"crossRef\")\n| summarize \n    TrustQueries = count(),\n    TrustedDomains = make_set(TargetAccountDisplayName, 10),\n    FirstQuery = min(TimeGenerated),\n    LastQuery = max(TimeGenerated)\n    by AccountName, DeviceName, IPAddress\n| where TrustQueries > 1\n| extend ThreatLevel = case(\n    TrustQueries > 10, \"ðŸ”´ Critical - Trust Enumeration\",\n    TrustQueries > 5, \"ðŸŸ  High - Forest Reconnaissance\",\n    \"ðŸŸ¡ Medium - Investigate\"\n)\n| extend AttackPath = \"Potential SID History / Golden Ticket Cross-Forest Attack\"\n| order by TrustQueries desc",
                            "size": 0,
                            "title": "ðŸ”´ Domain Trust Enumeration (Cross-Forest Attacks)",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "TrustQueries",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "FirstQuery",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "LastQuery",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - trust enum",
                        "id": "63043fea-ecf4-4fff-8e61-9a719457c03a"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// RBCD (Resource-Based Constrained Delegation) Attack Preparation\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string, DestinationPort:int)[];\nunion isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n| where TimeGenerated {TimeRange}\n| where Protocol == \"Ldap\"\n| where AdditionalFields has \"msDS-AllowedToActOnBehalfOfOtherIdentity\"\n| project TimeGenerated, AccountName, DeviceName, IPAddress, ActionType, AdditionalFields, TargetAccountDisplayName\n| extend ThreatLevel = \"ðŸ”´ CRITICAL - RBCD Configuration Query\"\n| extend AttackVector = \"May indicate Kerberos RBCD attack preparation\"\n| order by TimeGenerated desc",
                            "size": 0,
                            "title": "ðŸ”´ RBCD Configuration Queries (Kerberos Abuse)",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "TimeGenerated",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "name": "query - rbcd",
                        "id": "9f31e9ca-a4c6-4ba6-b7cc-03cef74084f1"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "PrivilegedAccounts"
            },
            "name": "group - privileged accounts",
            "id": "922d0199-bbe0-4087-80ad-a98dbe9c2af9"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "### ðŸ› ï¸ Attack Tool Detection - BloodHound, SharpHound, PowerView\n\nDetect known red team and attacker tools performing LDAP reconnaissance.\n\n**âš ï¸ Data Requirements:** Event 1644 must be enabled on DCs OR Microsoft Defender for Identity (MDI)\n\n| Tool | Detection Pattern | Threat Level |\n|------|-------------------|-------------|\n| **BloodHound/SharpHound** | Mass objectClass queries, memberOf enumeration, adminCount=1 | ðŸ”´ Critical |\n| **PowerView** | Get-DomainUser, Get-DomainGroup patterns | ðŸ”´ Critical |"
                        },
                        "name": "text - tools header",
                        "id": "f28d4988-c3f7-4509-a35e-2886781a0bc8"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// BloodHound/SharpHound Detection - Combined MDI + Event 1644\nlet BloodHoundPatterns = dynamic([\"objectClass=user\", \"objectClass=group\", \"objectClass=computer\", \"memberOf\", \"adminCount\", \"primaryGroupID\", \"servicePrincipalName\", \"msDS-AllowedToDelegateTo\"]);\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic)[];\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, RenderedDescription:string, Computer:string)[];\nunion isfuzzy=true\n    (union isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | where tostring(AdditionalFields) has_any (BloodHoundPatterns)\n        | extend Filter = tostring(AdditionalFields)\n        | extend ClientIP = IPAddress\n        | extend Source = \"MDI\"\n        | project TimeGenerated, AccountName, DeviceName, ClientIP, Filter, Source),\n    (union isfuzzy=true EmptyEvent, Event\n        | where TimeGenerated {TimeRange}\n        | where EventLog == \"Directory Service\"\n        | where EventID == 1644\n        | where RenderedDescription has_any (BloodHoundPatterns)\n        | extend ClientIP = extract(@\"Client IP:\\s*([\\d\\.]+)\", 1, RenderedDescription)\n        | extend Filter = extract(@\"Filter:\\s*(.+?)\\s*(Visited|$)\", 1, RenderedDescription)\n        | extend VisitedEntries = toint(extract(@\"Visited entries:\\s*(\\d+)\", 1, RenderedDescription))\n        | extend Source = \"Event1644\"\n        | extend AccountName = \"N/A\", DeviceName = Computer\n        | project TimeGenerated, AccountName, DeviceName, ClientIP, Filter, Source, VisitedEntries)\n| summarize \n    QueryCount = count(),\n    Patterns = make_set(extract(@\"(objectClass=[a-zA-Z]+|memberOf|adminCount|servicePrincipalName)\", 0, Filter), 10),\n    Sources = make_set(Source),\n    FirstQuery = min(TimeGenerated),\n    LastQuery = max(TimeGenerated)\n    by ClientIP, bin(TimeGenerated, 1h)\n| where QueryCount > 10\n| extend BloodHoundIndicator = case(\n    QueryCount > 500, \"CRITICAL - High Confidence SharpHound\",\n    QueryCount > 100, \"HIGH - Likely SharpHound\",\n    QueryCount > 20, \"MEDIUM - Possible BloodHound\",\n    \"LOW - Investigate\"\n)\n| project TimeGenerated, ClientIP, QueryCount, Patterns, Sources, BloodHoundIndicator, FirstQuery, LastQuery\n| order by QueryCount desc",
                            "size": 0,
                            "title": "BloodHound/SharpHound Collection Detection",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "QueryCount",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "FirstQuery",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "LastQuery",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "name": "query - bloodhound",
                        "id": "914b599e-58cf-4058-8d49-08220caf2838"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// SharpHound Specific Signature - Combined MDI + Event 1644\nlet MembershipPatterns = dynamic([\"memberOf\", \"primaryGroupID\", \"member\", \"objectClass=user\", \"objectClass=group\"]);\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic)[];\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, RenderedDescription:string, Computer:string)[];\nunion isfuzzy=true\n    (union isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | where tostring(AdditionalFields) has_any (MembershipPatterns)\n        | extend Filter = tostring(AdditionalFields)\n        | extend ClientIP = IPAddress\n        | extend Source = \"MDI\"\n        | project TimeGenerated, AccountName, DeviceName, ClientIP, Filter, Source),\n    (union isfuzzy=true EmptyEvent, Event\n        | where TimeGenerated {TimeRange}\n        | where EventLog == \"Directory Service\"\n        | where EventID == 1644\n        | where RenderedDescription has_any (MembershipPatterns)\n        | extend ClientIP = extract(@\"Client IP:\\s*([\\d\\.]+)\", 1, RenderedDescription)\n        | extend Filter = extract(@\"Filter:\\s*(.+?)\\s*(Visited|$)\", 1, RenderedDescription)\n        | extend Source = \"Event1644\"\n        | extend AccountName = \"N/A\", DeviceName = Computer\n        | project TimeGenerated, AccountName, DeviceName, ClientIP, Filter, Source)\n| summarize \n    MemberOfQueries = countif(Filter has \"memberOf\"),\n    UserQueries = countif(Filter has \"user\"),\n    GroupQueries = countif(Filter has \"group\"),\n    TotalQueries = count(),\n    FirstQuery = min(TimeGenerated),\n    LastQuery = max(TimeGenerated)\n    by ClientIP, bin(TimeGenerated, 10m)\n| where TotalQueries > 10\n| extend SharpHoundLikelihood = case(\n    MemberOfQueries > 100 and UserQueries > 50, \"CRITICAL - Definite SharpHound\",\n    MemberOfQueries > 20, \"HIGH - Likely SharpHound\",\n    \"MEDIUM - Possible\"\n)\n| order by MemberOfQueries desc",
                            "size": 0,
                            "title": "SharpHound Membership Collection Pattern",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "MemberOfQueries",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "UserQueries",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    },
                                    {
                                        "columnMatch": "FirstQuery",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "LastQuery",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - sharphound",
                        "id": "fe37753a-fe12-44fb-af48-fd2d0bf724d0"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// PowerView Detection - Combined MDI + Event 1644\nlet PowerViewPatterns = dynamic([\"samAccountType\", \"userAccountControl\", \"objectCategory\", \"lastLogon\", \"pwdLastSet\", \"servicePrincipalName\", \"805306368\", \"805306369\"]);\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic)[];\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, RenderedDescription:string, Computer:string)[];\nunion isfuzzy=true\n    (union isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | where tostring(AdditionalFields) has_any (PowerViewPatterns)\n        | extend Filter = tostring(AdditionalFields)\n        | extend ClientIP = IPAddress\n        | extend Source = \"MDI\"\n        | project TimeGenerated, AccountName, DeviceName, ClientIP, Filter, Source),\n    (union isfuzzy=true EmptyEvent, Event\n        | where TimeGenerated {TimeRange}\n        | where EventLog == \"Directory Service\"\n        | where EventID == 1644\n        | where RenderedDescription has_any (PowerViewPatterns)\n        | extend ClientIP = extract(@\"Client IP:\\s*([\\d\\.]+)\", 1, RenderedDescription)\n        | extend Filter = extract(@\"Filter:\\s*(.+?)\\s*(Visited|$)\", 1, RenderedDescription)\n        | extend Source = \"Event1644\"\n        | extend AccountName = \"N/A\", DeviceName = Computer\n        | project TimeGenerated, AccountName, DeviceName, ClientIP, Filter, Source)\n| summarize \n    QueryCount = count(),\n    PatternMatches = make_set(extract(@\"(samAccountType|userAccountControl|objectCategory|lastLogon|pwdLastSet|servicePrincipalName)\", 1, Filter), 10),\n    FirstQuery = min(TimeGenerated),\n    LastQuery = max(TimeGenerated)\n    by ClientIP, bin(TimeGenerated, 10m)\n| where QueryCount > 5\n| extend PowerViewIndicator = case(\n    QueryCount > 100, \"CRITICAL - PowerView Enumeration\",\n    QueryCount > 30, \"HIGH - Likely PowerView\",\n    \"MEDIUM - Possible PowerView\"\n)\n| order by QueryCount desc",
                            "size": 0,
                            "title": "PowerView Enumeration Detection",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "QueryCount",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "FirstQuery",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "LastQuery",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - powerview",
                        "id": "c7912a51-fe11-4902-bb11-d3bba2978f73"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "AttackTools"
            },
            "name": "group - attack tools",
            "id": "9ebef23e-05f5-4c14-826e-3fd855b4c6b8"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "### âš ï¸ Abnormal Client Detection\n\nIdentify LDAP clients exhibiting suspicious behavior patterns.\n\n**âš ï¸ Data Requirements:** Event 1644 must be enabled on DCs OR Microsoft Defender for Identity (MDI)\n\n- Non-domain-joined machines querying AD\n- Workstations querying entire domain\n- Unusual client IP ranges\n- First-time LDAP clients"
                        },
                        "name": "text - abnormal header",
                        "id": "d596880a-3a72-4c77-91ed-d7e84c90ef30"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// All LDAP Client Activity - Combined MDI + Event 1644 + SecurityEvent\nlet EmptyMDI = datatable(TimeGenerated:datetime, ClientIP:string, AccountName:string, DeviceName:string, Source:string)[];\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, EventLog:string, RenderedDescription:string, Computer:string)[];\nlet EmptySecEvent = datatable(TimeGenerated:datetime, EventID:int, IpAddress:string, TargetUserName:string, Computer:string)[];\nunion isfuzzy=true EmptyMDI,\n    // MDI source\n    (IdentityDirectoryEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | extend ClientIP = IPAddress\n        | extend Source = \"MDI\"\n        | project TimeGenerated, ClientIP, AccountName, DeviceName, Source),\n    // Event 1644 source\n    (union isfuzzy=true EmptyEvent, Event\n        | where TimeGenerated {TimeRange}\n        | where EventLog == \"Directory Service\"\n        | where EventID == 1644\n        | extend ClientIP = extract(@\"Client IP:\\\\s*([\\\\d\\\\.]+)\", 1, RenderedDescription)\n        | where isnotempty(ClientIP)\n        | extend Source = \"Event1644\", AccountName = \"N/A\", DeviceName = Computer\n        | project TimeGenerated, ClientIP, AccountName, DeviceName, Source),\n    // Event 2889 source\n    (union isfuzzy=true EmptyEvent, Event\n        | where TimeGenerated {TimeRange}\n        | where EventLog == \"Directory Service\"\n        | where EventID == 2889\n        | extend ClientIP = extract(@\"IP address:\\\\s*([\\\\d\\\\.]+)\", 1, RenderedDescription)\n        | where isnotempty(ClientIP)\n        | extend Source = \"Event2889\", AccountName = \"N/A\", DeviceName = Computer\n        | project TimeGenerated, ClientIP, AccountName, DeviceName, Source),\n    // SecurityEvent LDAP-related events\n    (union isfuzzy=true EmptySecEvent, SecurityEvent\n        | where TimeGenerated {TimeRange}\n        | where EventID in (4624, 4625)  // Logon events\n        | where isnotempty(IpAddress) and IpAddress != \"-\" and IpAddress != \"::1\" and IpAddress != \"127.0.0.1\"\n        | extend ClientIP = IpAddress, AccountName = TargetUserName, DeviceName = Computer, Source = \"SecurityEvent\"\n        | project TimeGenerated, ClientIP, AccountName, DeviceName, Source)\n| where isnotempty(ClientIP)\n| summarize \n    QueryCount = count(),\n    Sources = make_set(Source),\n    Accounts = make_set(AccountName, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by ClientIP\n| extend IsInternal = ipv4_is_private(ClientIP)\n| extend ClientType = iff(IsInternal, \"Internal\", \"External\")\n| order by QueryCount desc\n| take 30",
                            "size": 0,
                            "title": "All LDAP Clients (Top 30)",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "QueryCount",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "FirstSeen",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "LastSeen",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "name": "query - nondomain",
                        "id": "4e49d340-61a7-4622-a073-844dcea73864"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Workstations Performing Domain-Wide Queries - Event 1644\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, RenderedDescription:string, Computer:string, EventLog:string)[];\nunion isfuzzy=true EmptyEvent, Event\n| where TimeGenerated {TimeRange}\n| where EventLog == \"Directory Service\"\n| where EventID == 1644\n| extend ClientIP = extract(@\"Client IP:\\s*([\\d\\.]+)\", 1, RenderedDescription)\n| extend StartingNode = extract(@\"Starting node:\\s*(.+?)\\s*(Filter|$)\", 1, RenderedDescription)\n| extend VisitedEntries = toint(extract(@\"Visited entries:\\s*(\\d+)\", 1, RenderedDescription))\n| extend Filter = extract(@\"Filter:\\s*(.+?)\\s*(Visited|$)\", 1, RenderedDescription)\n| where isnotempty(ClientIP)\n| summarize \n    QueryCount = count(),\n    TotalVisited = sum(VisitedEntries),\n    MaxVisited = max(VisitedEntries),\n    Filters = make_set(Filter, 5)\n    by ClientIP, Computer\n| extend ClientType = iff(ipv4_is_private(ClientIP), \"Internal\", \"External\")\n| extend RiskLevel = case(\n    TotalVisited > 100000, \"CRITICAL - Domain Enumeration\",\n    TotalVisited > 10000, \"HIGH\",\n    TotalVisited > 1000, \"MEDIUM\",\n    \"LOW\"\n)\n| order by TotalVisited desc\n| take 20",
                            "size": 0,
                            "title": "High-Volume LDAP Clients (Event 1644)",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "TotalVisited",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - domainwide",
                        "id": "56ea60e5-5423-4816-8a17-6fc2ce4a5e7c"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// First-Time LDAP Clients - Combined MDI + Event 1644 + Event 2889\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, RenderedDescription:string, Computer:string, EventLog:string)[];\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, IPAddress:string)[];\n// Build baseline of known clients from past 60 days\nlet BaselineClients = union isfuzzy=true\n    (union isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n        | where TimeGenerated between (ago(60d) .. ago(7d))\n        | where Protocol == \"Ldap\"\n        | distinct IPAddress),\n    (union isfuzzy=true EmptyEvent, Event\n        | where TimeGenerated between (ago(60d) .. ago(7d))\n        | where EventLog == \"Directory Service\"\n        | where EventID in (1644, 2889)\n        | extend IPAddress = extract(@\"(Client )?IP( address)?:\\s*([\\d\\.]+)\", 3, RenderedDescription)\n        | where isnotempty(IPAddress)\n        | distinct IPAddress)\n| distinct IPAddress;\n// Find new clients in last 7 days\nunion isfuzzy=true\n    (union isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n        | where TimeGenerated > ago(7d)\n        | where Protocol == \"Ldap\"\n        | extend ClientIP = IPAddress\n        | extend Source = \"MDI\"\n        | project TimeGenerated, ClientIP, Source),\n    (union isfuzzy=true EmptyEvent, Event\n        | where TimeGenerated > ago(7d)\n        | where EventLog == \"Directory Service\"\n        | where EventID in (1644, 2889)\n        | extend ClientIP = extract(@\"(Client )?IP( address)?:\\s*([\\d\\.]+)\", 3, RenderedDescription)\n        | where isnotempty(ClientIP)\n        | extend Source = strcat(\"Event\", EventID)\n        | project TimeGenerated, ClientIP, Source)\n| where ClientIP !in (BaselineClients)\n| summarize \n    QueryCount = count(),\n    Sources = make_set(Source),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by ClientIP\n| extend RiskLevel = case(\n    QueryCount > 100, \"HIGH - New High-Volume Client\",\n    QueryCount > 20, \"MEDIUM\",\n    \"LOW - New Client\"\n)\n| order by QueryCount desc",
                            "size": 0,
                            "title": "First-Time LDAP Clients (Last 7 Days)",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "QueryCount",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    },
                                    {
                                        "columnMatch": "FirstSeen",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "LastSeen",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - firsttime",
                        "id": "2e761002-6203-4cbc-8632-150c8e89a1f4"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// External/Unusual IP LDAP Connections - Combined Sources\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, RenderedDescription:string, Computer:string, EventLog:string)[];\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, IPAddress:string, AccountName:string)[];\nunion isfuzzy=true\n    (union isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n        | where TimeGenerated {TimeRange}\n        | where Protocol == \"Ldap\"\n        | where isnotempty(IPAddress)\n        | extend ClientIP = IPAddress\n        | extend Source = \"MDI\"\n        | project TimeGenerated, ClientIP, AccountName, Source),\n    (union isfuzzy=true EmptyEvent, Event\n        | where TimeGenerated {TimeRange}\n        | where EventLog == \"Directory Service\"\n        | where EventID in (1644, 2889)\n        | extend ClientIP = extract(@\"(Client )?IP( address)?:\\s*([\\d\\.]+)\", 3, RenderedDescription)\n        | where isnotempty(ClientIP)\n        | extend Source = strcat(\"Event\", EventID)\n        | extend AccountName = \"N/A\"\n        | project TimeGenerated, ClientIP, AccountName, Source)\n| where ClientIP != \"127.0.0.1\" and ClientIP != \"::1\"\n| extend IsInternal = ipv4_is_private(ClientIP)\n| summarize \n    QueryCount = count(),\n    Sources = make_set(Source),\n    Accounts = make_set(AccountName, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by ClientIP, IsInternal\n| extend ClientType = iff(IsInternal, \"Internal\", \"EXTERNAL\")\n| extend RiskLevel = case(\n    not(IsInternal), \"CRITICAL - External LDAP\",\n    QueryCount > 1000, \"HIGH - High Volume\",\n    \"NORMAL\"\n)\n| order by IsInternal asc, QueryCount desc\n| take 30",
                            "size": 0,
                            "title": "LDAP Connections by IP Type",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "QueryCount",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "FirstSeen",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "LastSeen",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "name": "query - external",
                        "id": "0c63db10-c6f5-4277-972f-6394ead321cf"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Unusual Hours LDAP Activity by Client\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string, DestinationPort:int)[];\nunion isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n| where TimeGenerated {TimeRange}\n| where Protocol == \"Ldap\"\n| extend Hour = datetime_part(\"Hour\", TimeGenerated)\n| extend DayOfWeek = dayofweek(TimeGenerated)\n| extend IsUnusualTime = case(\n    DayOfWeek >= 5d, \"Weekend\",\n    Hour < 6 or Hour > 22, \"Night\",\n    \"Normal\"\n)\n| where IsUnusualTime != \"Normal\"\n| summarize \n    UnusualQueries = count(),\n    NightQueries = countif(IsUnusualTime == \"Night\"),\n    WeekendQueries = countif(IsUnusualTime == \"Weekend\"),\n    Actions = make_set(ActionType, 5),\n    FirstQuery = min(TimeGenerated),\n    LastQuery = max(TimeGenerated)\n    by IPAddress, DeviceName, AccountName\n| where UnusualQueries > 20\n| extend RiskLevel = case(\n    UnusualQueries > 500, \"ðŸ”´ High - Automated Tool Likely\",\n    UnusualQueries > 100, \"ðŸŸ  Medium\",\n    \"ðŸŸ¡ Low\"\n)\n| order by UnusualQueries desc",
                            "size": 0,
                            "title": "âš ï¸ Unusual Hours LDAP Activity",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "UnusualQueries",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    },
                                    {
                                        "columnMatch": "FirstQuery",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "LastQuery",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "name": "query - unusual hours",
                        "id": "1658e757-fb5a-45fe-aaf9-214548ba9596"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "AbnormalClients"
            },
            "name": "group - abnormal clients",
            "id": "14aff631-0cb8-4672-a744-17b2dabcbbfd"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "### ðŸŽ¯ Threat Intelligence Correlation\n\nCorrelate LDAP activity with known attack patterns, IOCs, and threat intelligence feeds."
                        },
                        "name": "text - threat intel header",
                        "id": "504b2552-7322-4c5a-b1aa-3fad711012d1"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// LDAP Relay Attack Indicators\nSecurityEvent\n| where TimeGenerated {TimeRange}\n| where EventID == 4624  // Successful logon\n| where LogonType == 3   // Network logon\n| where AuthenticationPackageName == \"NTLM\"\n| where Computer has \"DC\" or Computer has \"Domain\"\n| join kind=inner (\n    SecurityEvent\n    | where TimeGenerated {TimeRange}\n    | where EventID == 4625  // Failed logon\n    | project FailedTime = TimeGenerated, FailedAccount = Account, FailedIP = IpAddress\n) on $left.Account == $right.FailedAccount\n| where (TimeGenerated - FailedTime) between (-5m .. 5m)\n| summarize \n    RelayIndicators = count(),\n    SuccessAfterFailure = countif(TimeGenerated > FailedTime),\n    TargetedComputers = make_set(Computer),\n    FirstEvent = min(TimeGenerated),\n    LastEvent = max(TimeGenerated)\n    by Account, IpAddress\n| where RelayIndicators > 2\n| extend ThreatLevel = \"ðŸ”´ Critical - Potential LDAP Relay\"\n| project Account, IpAddress, RelayIndicators, SuccessAfterFailure, TargetedComputers, ThreatLevel, FirstEvent, LastEvent\n| order by RelayIndicators desc",
                            "size": 0,
                            "title": "LDAP Relay Attack Indicators",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "RelayIndicators",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "redBright"
                                        }
                                    },
                                    {
                                        "columnMatch": "FirstEvent",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "LastEvent",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "name": "query - relay attacks",
                        "id": "44b107c7-fb9b-4e0a-b4b3-a9f3366ed016"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// LDAP Attack Timeline\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string)[];\nlet LDAPEvents = union isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n    | where TimeGenerated {TimeRange}\n    | where Protocol == \"Ldap\"\n    | summarize EventCount = count() by bin(TimeGenerated, 1h), ActionType;\nlet FailedAuth = SecurityEvent\n    | where TimeGenerated {TimeRange}\n    | where EventID == 4625\n    | where AuthenticationPackageName has \"LDAP\"\n    | summarize FailedCount = count() by bin(TimeGenerated, 1h)\n    | extend ActionType = \"Failed LDAP Auth\";\nlet UnsignedBinds = SecurityEvent\n    | where TimeGenerated {TimeRange}\n    | where EventID == 2889\n    | summarize UnsignedCount = count() by bin(TimeGenerated, 1h)\n    | extend ActionType = \"Unsigned LDAP\";\nunion \n    (LDAPEvents | project TimeGenerated, EventCount, ActionType),\n    (FailedAuth | project TimeGenerated, EventCount = FailedCount, ActionType),\n    (UnsignedBinds | project TimeGenerated, EventCount = UnsignedCount, ActionType)\n| render timechart with (title=\"LDAP Security Events Timeline\")",
                            "size": 0,
                            "title": "LDAP Attack Pattern Timeline",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "timechart"
                        },
                        "name": "query - attack timeline",
                        "id": "7e0f1405-2b4c-491e-b074-68bcdeee982c"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Correlation with Failed Authentication Attempts\nlet FailedAuth = SecurityEvent\n    | where TimeGenerated {TimeRange}\n    | where EventID == 4625\n    | summarize FailedAttempts = count() by IpAddress;\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string, DestinationPort:int)[];\nunion isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n| where TimeGenerated {TimeRange}\n| where Protocol == \"Ldap\"\n| summarize LDAPQueries = count() by IPAddress\n| join kind=inner FailedAuth on $left.IPAddress == $right.IpAddress\n| where FailedAttempts > 10\n| extend ThreatScore = LDAPQueries + (FailedAttempts * 2)\n| extend RiskLevel = case(\n    ThreatScore > 500, \"ðŸ”´ Critical\",\n    ThreatScore > 200, \"ðŸŸ  High\",\n    ThreatScore > 50, \"ðŸŸ¡ Medium\",\n    \"ðŸŸ¢ Low\"\n)\n| project IPAddress, LDAPQueries, FailedAttempts, ThreatScore, RiskLevel\n| order by ThreatScore desc\n| take 20",
                            "size": 0,
                            "title": "IPs with Both LDAP Queries and Failed Authentication",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "ThreatScore",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "RiskLevel",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Critical",
                                                    "representation": "redBright",
                                                    "text": "{0}{1}"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "High",
                                                    "representation": "orange",
                                                    "text": "{0}{1}"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Medium",
                                                    "representation": "yellow",
                                                    "text": "{0}{1}"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "gray",
                                                    "text": "{0}{1}"
                                                }
                                            ]
                                        }
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - correlation",
                        "id": "211fc88a-367a-492f-90b3-fa2df13289ee"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Attack Pattern Matching\nlet EmptyIDEvents = datatable(TimeGenerated:datetime, Protocol:string, ActionType:string, AccountName:string, DeviceName:string, IPAddress:string, AdditionalFields:dynamic, TargetAccountDisplayName:string, DestinationPort:int)[];\nunion isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n| where TimeGenerated {TimeRange}\n| where Protocol == \"Ldap\"\n| extend AttackPattern = case(\n    AdditionalFields has_all (\"objectClass=user\", \"memberOf\"), \"BloodHound Enumeration\",\n    AdditionalFields has \"adminCount=1\", \"Privileged Account Discovery\",\n    AdditionalFields has \"primaryGroupID=512\", \"Domain Admin Enumeration\",\n    AdditionalFields has \"userAccountControl\" and AdditionalFields has \"ACCOUNTDISABLE\", \"Disabled Account Discovery\",\n    AdditionalFields has \"servicePrincipalName\", \"Kerberoasting Preparation\",\n    AdditionalFields has \"msDS-AllowedToDelegateTo\", \"Delegation Abuse Preparation\",\n    \"Normal Activity\"\n)\n| where AttackPattern != \"Normal Activity\"\n| summarize \n    PatternCount = count(),\n    UniqueAccounts = dcount(AccountName),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by AttackPattern\n| extend Severity = case(\n    AttackPattern contains \"BloodHound\", \"ðŸ”´ Critical\",\n    AttackPattern contains \"Admin\", \"ðŸŸ  High\",\n    \"ðŸŸ¡ Medium\"\n)\n| project AttackPattern, PatternCount, UniqueAccounts, Severity, FirstSeen, LastSeen\n| order by PatternCount desc",
                            "size": 0,
                            "title": "Detected Attack Patterns",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "PatternCount",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    },
                                    {
                                        "columnMatch": "FirstSeen",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "LastSeen",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - attack patterns",
                        "id": "f4e3be09-e12a-488e-946b-cc97da898e5e"
                    },
                    {
                        "type": 1,
                        "content": {
                            "json": "---\n### ðŸš¨ Security Alerts & Incidents\n\nIdentity and LDAP-related alerts from Microsoft Sentinel and Defender XDR."
                        },
                        "name": "text - alerts header",
                        "id": "ac0cf19d-f40e-4b5e-93db-b49f404ff835"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// All Recent Security Alerts (Unfiltered) - For Diagnostics\nlet EmptyAlerts = datatable(TimeGenerated:datetime, AlertName:string, AlertSeverity:string, Description:string, Tactics:string, Techniques:string, Status:string, ProviderName:string, CompromisedEntity:string, ProductName:string)[];\nunion isfuzzy=true EmptyAlerts, SecurityAlert\n| where TimeGenerated {TimeRange}\n| summarize \n    AlertCount = count(),\n    arg_max(TimeGenerated, *)\n    by AlertName, ProviderName\n| project \n    AlertName,\n    Severity = AlertSeverity,\n    Provider = ProviderName,\n    Product = ProductName,\n    Tactics,\n    Status,\n    Entity = CompromisedEntity,\n    AlertCount,\n    LastTriggered = TimeGenerated\n| order by LastTriggered desc\n| take 30",
                            "size": 0,
                            "title": "All Recent Alerts (All Sources)",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Severity",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "High",
                                                    "representation": "redBright",
                                                    "text": "ðŸ”´ {0}"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Medium",
                                                    "representation": "orange",
                                                    "text": "ðŸŸ  {0}"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Low",
                                                    "representation": "yellow",
                                                    "text": "ðŸŸ¡ {0}"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "gray",
                                                    "text": "{0}"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "AlertCount",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    },
                                    {
                                        "columnMatch": "LastTriggered",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "name": "query - all alerts",
                        "id": "fd4d8119-8087-495c-9ba4-e5506ddcd3fb"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// All Recent Incidents (Unfiltered) - Shows all incidents from Sentinel & Defender XDR\nlet EmptyIncidents = datatable(TimeGenerated:datetime, Title:string, Severity:string, Status:string, IncidentNumber:int, Owner:dynamic, Classification:string, ProviderName:string, AdditionalData:dynamic)[];\nunion isfuzzy=true EmptyIncidents, SecurityIncident\n| where TimeGenerated {TimeRange}\n| extend OwnerName = tostring(Owner.assignedTo)\n| extend Provider = coalesce(ProviderName, tostring(AdditionalData.providerName), \"Unknown\")\n| project \n    IncidentNumber,\n    Title,\n    Severity,\n    Status,\n    Classification,\n    Provider,\n    Owner = iff(isempty(OwnerName), \"Unassigned\", OwnerName),\n    Created = TimeGenerated\n| order by Created desc\n| take 30",
                            "size": 0,
                            "title": "All Recent Incidents (All Sources)",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Severity",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "High",
                                                    "representation": "redBright",
                                                    "text": "ðŸ”´ {0}"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Medium",
                                                    "representation": "orange",
                                                    "text": "ðŸŸ  {0}"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Low",
                                                    "representation": "yellow",
                                                    "text": "ðŸŸ¡ {0}"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "gray",
                                                    "text": "{0}"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Status",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "New",
                                                    "representation": "redBright",
                                                    "text": "{0}"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Active",
                                                    "representation": "orange",
                                                    "text": "{0}"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Closed",
                                                    "representation": "green",
                                                    "text": "{0}"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "gray",
                                                    "text": "{0}"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Created",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "name": "query - all incidents",
                        "id": "e98b7247-f633-46af-9ef4-ea328885b3f1"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Microsoft Sentinel Incidents - Identity & LDAP Related\nlet IdentityKeywords = dynamic([\"LDAP\", \"Directory\", \"Active Directory\", \"Kerberos\", \"BloodHound\", \"SharpHound\", \"DCSync\", \"DCShadow\", \"NTLM\", \"Pass-the-Hash\", \"Golden Ticket\", \"Silver Ticket\", \"Enumeration\", \"Reconnaissance\", \"Credential\", \"Domain Controller\", \"Identity\", \"Account\", \"Logon\", \"Authentication\", \"Domain\", \"Admin\", \"Privilege\", \"Lateral\", \"Suspicious\", \"Anomal\", \"Malicious\", \"User\", \"Service\"]);\nlet EmptyIncidents = datatable(TimeGenerated:datetime, Title:string, Severity:string, Status:string, IncidentNumber:int, Owner:dynamic, Classification:string, ClassificationReason:string, AlertIds:dynamic)[];\nunion isfuzzy=true EmptyIncidents, SecurityIncident\n| where TimeGenerated {TimeRange}\n| where Title has_any (IdentityKeywords)\n    or Classification has_any (\"TruePositive\", \"BenignPositive\")\n| extend OwnerName = tostring(Owner.assignedTo)\n| project \n    IncidentNumber,\n    Title,\n    Severity,\n    Status,\n    Classification,\n    ClassificationReason,\n    Owner = iff(isempty(OwnerName), \"Unassigned\", OwnerName),\n    AlertCount = array_length(AlertIds),\n    Created = TimeGenerated\n| order by \n    case(Severity == \"High\", 1, Severity == \"Medium\", 2, Severity == \"Low\", 3, 4),\n    Created desc\n| take 25",
                            "size": 0,
                            "title": "Sentinel Incidents - Identity & LDAP Related",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Severity",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "High",
                                                    "representation": "redBright",
                                                    "text": "ðŸ”´ {0}"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Medium",
                                                    "representation": "orange",
                                                    "text": "ðŸŸ  {0}"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Low",
                                                    "representation": "yellow",
                                                    "text": "ðŸŸ¡ {0}"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "gray",
                                                    "text": "{0}"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Status",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "New",
                                                    "representation": "redBright",
                                                    "text": "{0}"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Active",
                                                    "representation": "orange",
                                                    "text": "{0}"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Closed",
                                                    "representation": "green",
                                                    "text": "{0}"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "gray",
                                                    "text": "{0}"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "AlertCount",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "orange"
                                        }
                                    },
                                    {
                                        "columnMatch": "Created",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - sentinel incidents",
                        "id": "d4680fcd-6b92-457b-b034-95d430c3a20a"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Microsoft Defender XDR Alerts - LDAP Related\nlet LDAPKeywords = dynamic([\"LDAP\", \"Directory\", \"Active Directory\", \"Kerberos\", \"BloodHound\", \"SharpHound\", \"DCSync\", \"DCShadow\", \"NTLM\", \"Pass-the-Hash\", \"Golden Ticket\", \"Silver Ticket\", \"Enumeration\", \"Reconnaissance\", \"Credential\", \"Domain Controller\", \"Domain Admin\"]);\nlet EmptyAlertInfo = datatable(Timestamp:datetime, AlertId:string, Title:string, Severity:string, Category:string, ServiceSource:string, DetectionSource:string, AttackTechniques:string)[];\nlet EmptyAlertEvidence = datatable(Timestamp:datetime, AlertId:string, EntityType:string, AccountName:string, DeviceName:string, RemoteIP:string, FileName:string)[];\nlet AlertData = union isfuzzy=true EmptyAlertInfo, AlertInfo\n    | where Timestamp {TimeRange}\n    | where Title has_any (LDAPKeywords)\n        or Category has_any (\"Reconnaissance\", \"CredentialAccess\", \"LateralMovement\", \"Discovery\", \"InitialAccess\")\n        or ServiceSource == \"Microsoft Defender for Identity\";\nlet EvidenceData = union isfuzzy=true EmptyAlertEvidence, AlertEvidence\n    | where Timestamp {TimeRange}\n    | summarize \n        Entities = make_set(strcat(EntityType, \": \", coalesce(AccountName, DeviceName, RemoteIP, FileName)))\n        by AlertId;\nAlertData\n| join kind=leftouter EvidenceData on AlertId\n| summarize \n    AlertCount = count(),\n    arg_max(Timestamp, *)\n    by Title\n| project \n    Title,\n    Severity,\n    Category,\n    Source = ServiceSource,\n    Detection = DetectionSource,\n    Techniques = AttackTechniques,\n    Entities = iff(isnull(Entities), dynamic([]), Entities),\n    AlertCount,\n    LastSeen = Timestamp\n| order by \n    case(Severity == \"High\", 1, Severity == \"Medium\", 2, Severity == \"Low\", 3, 4),\n    AlertCount desc\n| take 25",
                            "size": 0,
                            "title": "Defender XDR Alerts - LDAP & Identity Related",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Severity",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "High",
                                                    "representation": "redBright",
                                                    "text": "ðŸ”´ {0}"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Medium",
                                                    "representation": "orange",
                                                    "text": "ðŸŸ  {0}"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Low",
                                                    "representation": "yellow",
                                                    "text": "ðŸŸ¡ {0}"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "gray",
                                                    "text": "{0}"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "AlertCount",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "red"
                                        }
                                    },
                                    {
                                        "columnMatch": "LastSeen",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - defender xdr alerts",
                        "id": "cc899a56-2456-4f6b-bee9-493d84a571d2"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Alert Severity Distribution Over Time\nlet LDAPKeywords = dynamic([\"LDAP\", \"Directory\", \"Active Directory\", \"Kerberos\", \"BloodHound\", \"DCSync\", \"NTLM\", \"Enumeration\", \"Reconnaissance\", \"Credential\"]);\nlet EmptyAlerts = datatable(TimeGenerated:datetime, AlertName:string, AlertSeverity:string, Description:string, Tactics:string)[];\nlet SentinelAlerts = union isfuzzy=true EmptyAlerts, SecurityAlert\n    | where TimeGenerated {TimeRange}\n    | where AlertName has_any (LDAPKeywords)\n        or Description has_any (LDAPKeywords)\n        or Tactics has_any (\"Reconnaissance\", \"CredentialAccess\", \"LateralMovement\", \"Discovery\")\n    | project TimeGenerated, Severity = AlertSeverity, Source = \"Sentinel\";\nlet EmptyAlertInfo = datatable(Timestamp:datetime, Title:string, Severity:string, Category:string, ServiceSource:string)[];\nlet XDRAlerts = union isfuzzy=true EmptyAlertInfo, AlertInfo\n    | where Timestamp {TimeRange}\n    | where Title has_any (LDAPKeywords)\n        or Category has_any (\"Reconnaissance\", \"CredentialAccess\", \"LateralMovement\", \"Discovery\")\n        or ServiceSource == \"Microsoft Defender for Identity\"\n    | project TimeGenerated = Timestamp, Severity, Source = \"Defender XDR\";\nunion SentinelAlerts, XDRAlerts\n| summarize \n    High = countif(Severity == \"High\"),\n    Medium = countif(Severity == \"Medium\"),\n    Low = countif(Severity == \"Low\"),\n    Informational = countif(Severity == \"Informational\" or Severity == \"Info\")\n    by bin(TimeGenerated, 1d), Source\n| project TimeGenerated, Source, High, Medium, Low, Informational\n| order by TimeGenerated asc",
                            "size": 0,
                            "title": "LDAP Security Alert Trend",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "barchart",
                            "chartSettings": {
                                "seriesLabelSettings": [
                                    {
                                        "seriesName": "High",
                                        "color": "redBright"
                                    },
                                    {
                                        "seriesName": "Medium",
                                        "color": "orange"
                                    },
                                    {
                                        "seriesName": "Low",
                                        "color": "yellow"
                                    },
                                    {
                                        "seriesName": "Informational",
                                        "color": "blue"
                                    }
                                ]
                            }
                        },
                        "name": "query - alert trend",
                        "id": "ef4d20a1-3a4f-4a8a-b62d-45e6dadea09e"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Microsoft Defender for Identity Alerts (via SecurityAlert)\nlet MDIAlertNames = dynamic([\"Suspected DCSync attack\", \"Suspected Golden Ticket usage\", \"Suspected skeleton key attack\", \"Suspected Brute Force attack\", \"Suspected LDAP reconnaissance\", \"User and IP address reconnaissance\", \"User and Group membership reconnaissance\", \"Active Directory attributes reconnaissance\", \"Account enumeration reconnaissance\", \"Network mapping reconnaissance\", \"Suspicious service creation\", \"Suspected DCShadow attack\", \"Suspicious additions to sensitive groups\", \"Data exfiltration over SMB\", \"Malicious request of Data Protection API\", \"Suspected Pass-the-Hash attack\", \"Suspected Pass-the-Ticket attack\", \"Suspected overpass-the-hash attack\", \"Suspected Kerberoasting\", \"Abnormal Active Directory Federation Services authentication\"]);\nlet EmptyAlerts = datatable(TimeGenerated:datetime, AlertName:string, AlertSeverity:string, Description:string, Tactics:string, Techniques:string, Status:string, ProviderName:string, CompromisedEntity:string, ExtendedProperties:string)[];\nunion isfuzzy=true EmptyAlerts, SecurityAlert\n| where TimeGenerated {TimeRange}\n| where ProviderName == \"Azure Advanced Threat Protection\"\n| extend Details = parse_json(ExtendedProperties)\n| project \n    TimeGenerated,\n    AlertName,\n    Severity = AlertSeverity,\n    Description = substring(Description, 0, 150),\n    Tactics,\n    Entity = CompromisedEntity,\n    Status,\n    Source = ProviderName\n| order by TimeGenerated desc\n| take 50",
                            "size": 0,
                            "title": "Microsoft Defender for Identity Alerts (MDI/Azure ATP)",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "timeContextFromParameter": "TimeRange",
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Severity",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "High",
                                                    "representation": "redBright",
                                                    "text": "ðŸ”´ {0}"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Medium",
                                                    "representation": "orange",
                                                    "text": "ðŸŸ  {0}"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "Low",
                                                    "representation": "yellow",
                                                    "text": "ðŸŸ¡ {0}"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "gray",
                                                    "text": "{0}"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "TimeGenerated",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "name": "query - mdi alerts",
                        "id": "8a7cadd5-24f0-47e5-99fc-b4ad90ce0088"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "ThreatIntel"
            },
            "name": "group - threat intel",
            "id": "43c5d469-fb33-44be-b17d-ea4ae56e46c0"
        },
        {
            "type": 12,
            "content": {
                "version": "NotebookGroup/1.0",
                "groupType": "editable",
                "items": [
                    {
                        "type": 1,
                        "content": {
                            "json": "### âœ… LDAP Security Best Practices & Compliance\n\nComprehensive guidance for securing LDAP infrastructure against nation-state actors and ransomware groups.\n\n---\n\n#### ðŸ” **LDAP Protocol Hardening**\n\n| Setting | Registry Path | Recommended Value | Impact |\n|---------|--------------|-------------------|--------|\n| **LDAP Signing** | `HKLM\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Parameters\\LDAPServerIntegrity` | 2 (Required) | Prevents relay attacks |\n| **LDAP Channel Binding** | `HKLM\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Parameters\\LdapEnforceChannelBinding` | 2 (Always) | Blocks MitM attacks |\n| **Disable LDAP over port 389** | Firewall rules | Block 389 externally | Force LDAPS |\n\n---\n\n#### ðŸ“Š **Event ID Configuration for Detection**\n\n| Event ID | Log Source | Description | Enable Via |\n|----------|-----------|-------------|------------|\n| **1644** | Directory Services | Expensive LDAP queries | Registry: Field Engineering = 5 |\n| **2886** | Directory Services | LDAP signing not required warning | Default enabled |\n| **2887** | Directory Services | LDAP simple bind (clear text) | Default enabled |\n| **2889** | Directory Services | Unsigned LDAP bind | Default enabled |\n| **3039** | Directory Services | Client disconnected (timeout) | Default enabled |\n| **3040** | Directory Services | Query rejected (resource limit) | Default enabled |\n| **4662** | Security | Object access (for SACL) | Advanced Audit Policy |\n| **4771** | Security | Kerberos pre-auth failure | Advanced Audit Policy |\n| **4776** | Security | NTLM authentication | Advanced Audit Policy |\n\n---\n\n#### ðŸ›¡ï¸ **Threat Actor Mitigation Matrix**\n\n| Threat Actor | Primary Technique | Detection Method | Mitigation |\n|-------------|------------------|------------------|------------|\n| **APT29** | BloodHound, Kerberoasting | High-volume LDAP, SPN queries | Tiered admin, LAPS, gMSA |\n| **APT28** | PowerView enumeration | samAccountType patterns | Block PowerShell in sensitive OUs |\n| **FIN7** | Privileged account discovery | adminCount=1 queries | Reduce DA count, Just-In-Time access |\n| **Conti/LockBit** | GPO enumeration for deployment | gPLink, gPCFileSysPath queries | GPO hardening, LAPS |\n| **BlackCat** | Delegation abuse | msDS-AllowedToDelegateTo queries | Constrained delegation only |\n\n---\n\n#### ðŸ”§ **Registry Settings for Event 1644 Logging**\n\n```plaintext\n; Enable Field Engineering diagnostic logging\nWindows Registry Editor Version 5.00\n\n[HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Diagnostics]\n\"15 Field Engineering\"=dword:00000005\n\n[HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Parameters]\n\"Expensive Search Results Threshold\"=dword:00000001\n\"Inefficient Search Results Threshold\"=dword:00000001\n\"Search Time Threshold (msecs)\"=dword:00000064\n```"
                        },
                        "name": "text - best practices intro",
                        "id": "1825dc5a-aa25-4283-96cf-933c3c367a33"
                    },
                    {
                        "type": 1,
                        "content": {
                            "json": "---\n\n### ðŸ” Data Collection Status - LDAP Events Diagnostic\n\nUse the queries below to verify if LDAP-related events are being collected in Sentinel."
                        },
                        "name": "text - data collection header",
                        "id": "d37c7424-a31e-4dce-9489-74299384e20d"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Per Event ID Collection Check - Detailed\nlet LDAPEvents = datatable(EventID:int, EventName:string, LogSource:string, EnabledBy:string)\n[\n    1644, \"Expensive/Inefficient LDAP Query\", \"Directory Service\", \"Registry: Field Engineering = 5\",\n    2886, \"LDAP Signing Not Required Warning\", \"Directory Service\", \"Default (24h summary)\",\n    2887, \"LDAP Simple Bind (Clear Text) Count\", \"Directory Service\", \"Default (24h summary)\",\n    2888, \"LDAP Channel Binding Not Supported\", \"Directory Service\", \"Default (24h summary)\",\n    2889, \"Unsigned LDAP Bind Attempted\", \"Directory Service\", \"Default (per bind)\"\n];\n// Check each event ID individually\nlet EventCheck = union \n    (SecurityEvent | where TimeGenerated > ago(30d) | where EventID in (1644, 2886, 2887, 2888, 2889) | extend Source = \"SecurityEvent\"),\n    (Event | where TimeGenerated > ago(30d) | where EventID in (1644, 2886, 2887, 2888, 2889) | extend Source = \"Event\")\n| summarize \n    EventCount = count(),\n    LastSeen = max(TimeGenerated),\n    Sources = make_set(Source),\n    DCs = make_set(Computer, 5)\n    by EventID;\nLDAPEvents\n| join kind=leftouter EventCheck on EventID\n| extend Status = case(\n    EventCount > 0 and LastSeen > ago(1d), \"âœ… Collecting\",\n    EventCount > 0 and LastSeen > ago(7d), \"âš ï¸ Stale\",\n    EventCount > 0, \"âš ï¸ Old\",\n    \"âŒ Not Collecting\"\n)\n| project \n    ['Event ID'] = EventID,\n    ['Event Name'] = EventName,\n    ['Status'] = Status,\n    ['Event Count'] = coalesce(EventCount, 0),\n    ['Last Seen'] = LastSeen,\n    ['Table Source'] = strcat_array(Sources, \", \"),\n    ['How to Enable'] = EnabledBy,\n    ['DCs with Events'] = strcat_array(DCs, \", \")\n| order by ['Event ID'] asc",
                            "size": 0,
                            "title": "ðŸ“‹ Per-Event ID Collection Status",
                            "timeContext": {
                                "durationMs": 2592000000
                            },
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Status",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "icons",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Collecting",
                                                    "representation": "success",
                                                    "text": "{0}"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Stale",
                                                    "representation": "2",
                                                    "text": "{0}"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "error",
                                                    "text": "{0}"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Event Count",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    },
                                    {
                                        "columnMatch": "Last Seen",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - per event status",
                        "id": "bf9b29d9-ebed-43bf-a375-0421c4376ed1"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Connector & Agent Health Check - Multiple DC Discovery Methods\nlet EmptyHeartbeat = datatable(TimeGenerated:datetime, Computer:string, Category:string, OSType:string, Version:string)[];\nlet AgentHealth = union isfuzzy=true EmptyHeartbeat, Heartbeat\n    | where TimeGenerated > ago(1d)\n    | where OSType == \"Windows\"\n    | summarize \n        LastHeartbeat = max(TimeGenerated),\n        AgentVersion = any(Version),\n        Category = any(Category)\n    by Computer;\n// Method 1: DCs from Kerberos events\nlet DCsFromKerberos = SecurityEvent\n    | where TimeGenerated > ago(7d)\n    | where EventID in (4768, 4769, 4770, 4771)\n    | distinct Computer\n    | extend Source = \"Kerberos\";\n// Method 2: DCs from Heartbeat (machines with DC in name)\nlet DCsFromHeartbeat = union isfuzzy=true EmptyHeartbeat, Heartbeat\n    | where TimeGenerated > ago(7d)\n    | where Computer has_any (\"DC\", \"PDC\", \"BDC\", \"AD\")\n    | distinct Computer\n    | extend Source = \"Heartbeat\";\n// Method 3: DCs from Directory Service events\nlet DCsFromDirService = Event\n    | where TimeGenerated > ago(7d)\n    | where EventLog == \"Directory Service\"\n    | distinct Computer\n    | extend Source = \"DirService\";\n// Method 4: DCs from any SecurityEvent source with DC naming\nlet DCsFromSecurityEvent = SecurityEvent\n    | where TimeGenerated > ago(7d)\n    | where Computer has_any (\"DC\", \"PDC\", \"BDC\")\n    | distinct Computer\n    | extend Source = \"SecurityEvent\";\n// Method 5: All Windows machines from Heartbeat (as fallback)\nlet AllWindowsMachines = union isfuzzy=true EmptyHeartbeat, Heartbeat\n    | where TimeGenerated > ago(1d)\n    | where OSType == \"Windows\"\n    | distinct Computer\n    | extend Source = \"AllMachines\";\n// Combine all sources - union will include all machines found\nunion DCsFromKerberos, DCsFromHeartbeat, DCsFromDirService, DCsFromSecurityEvent, AllWindowsMachines\n| summarize Sources = make_set(Source) by Computer\n| join kind=leftouter AgentHealth on Computer\n| extend \n    AgentStatus = case(\n        isnotempty(LastHeartbeat) and LastHeartbeat > ago(15m), \"âœ… Online\",\n        isnotempty(LastHeartbeat), \"âš ï¸ Offline\",\n        \"âŒ No Heartbeat\"\n    ),\n    AgentVersion = coalesce(AgentVersion, \"N/A\"),\n    Category = coalesce(Category, \"Unknown\"),\n    IsDC = iff(Sources has_any (\"Kerberos\", \"DirService\") or (Sources !has \"AllMachines\"), \"Yes\", \"Maybe\")\n| project \n    Computer,\n    ['Is DC'] = IsDC,\n    ['Agent Status'] = AgentStatus,\n    ['Agent Version'] = AgentVersion,\n    ['Agent Type'] = Category,\n    ['Last Heartbeat'] = LastHeartbeat,\n    ['Discovery Sources'] = strcat_array(Sources, \", \")\n| order by ['Is DC'] desc, ['Agent Status'] asc, Computer asc",
                            "size": 0,
                            "title": "ðŸ–¥ï¸ DC Agent Health Status",
                            "timeContext": {
                                "durationMs": 86400000
                            },
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Agent Status",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "icons",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Online",
                                                    "representation": "success",
                                                    "text": "{0}"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Offline",
                                                    "representation": "2",
                                                    "text": "{0}"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "error",
                                                    "text": "{0}"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Last Heartbeat",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "customWidth": "50",
                        "name": "query - agent health",
                        "id": "b61c3a3c-4b29-42bd-8e18-914b10b82560"
                    },
                    {
                        "type": 1,
                        "content": {
                            "json": "---\n\n#### ðŸ–¥ï¸ **Azure Monitor Agent (AMA) Verification**\n\nThe queries below verify AMA installation, agent status, and events received per server."
                        },
                        "name": "text - ama verification header",
                        "id": "de8909a8-79ac-407f-9d97-64619c846863"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Azure Monitor Agent Installation & Health Status\n// Shows all servers with AMA agent, their status, version, and data collection info\nlet EmptyHeartbeat = datatable(TimeGenerated:datetime, Computer:string, Category:string, OSType:string, Version:string, ComputerEnvironment:string, ResourceId:string, Solutions:string)[];\nlet AgentInfo = union isfuzzy=true EmptyHeartbeat, Heartbeat\n    | where TimeGenerated > ago(1d)\n    | where OSType == \"Windows\"\n    | summarize \n        LastHeartbeat = max(TimeGenerated),\n        AgentVersion = arg_max(TimeGenerated, Version).Version,\n        Category = arg_max(TimeGenerated, Category).Category,\n        Environment = arg_max(TimeGenerated, ComputerEnvironment).ComputerEnvironment,\n        ResourceId = arg_max(TimeGenerated, ResourceId).ResourceId,\n        Solutions = arg_max(TimeGenerated, Solutions).Solutions,\n        HeartbeatCount = count()\n    by Computer;\n// Identify which are DCs (from Directory Service events or Kerberos)\nlet EmptyEvent = datatable(Computer:string, EventLog:string, TimeGenerated:datetime)[];\nlet DCsFromEvents = union isfuzzy=true EmptyEvent, Event\n    | where TimeGenerated > ago(7d)\n    | where EventLog == \"Directory Service\"\n    | distinct Computer;\nlet EmptySec = datatable(Computer:string, EventID:int, TimeGenerated:datetime)[];\nlet DCsFromKerberos = union isfuzzy=true EmptySec, SecurityEvent\n    | where TimeGenerated > ago(7d)\n    | where EventID in (4768, 4769)\n    | distinct Computer;\nlet AllDCs = union DCsFromEvents, DCsFromKerberos | distinct Computer;\n// Join to get final view\nAgentInfo\n| extend IsDC = iff(Computer in (AllDCs), \"âœ… Yes\", \"âž– No\")\n| extend AgentStatus = case(\n    LastHeartbeat > ago(5m), \"ðŸŸ¢ Online (Active)\",\n    LastHeartbeat > ago(15m), \"ðŸŸ¡ Online\",\n    LastHeartbeat > ago(1h), \"ðŸŸ  Delayed\",\n    LastHeartbeat > ago(1d), \"ðŸ”´ Offline\",\n    \"âŒ No Recent Heartbeat\"\n)\n| extend AgentType = case(\n    Category == \"Direct Agent\", \"AMA Direct\",\n    Category == \"Azure\", \"AMA (Azure VM)\",\n    Category == \"SCOM\", \"SCOM Managed\",\n    Category has \"OMS\", \"Legacy MMA\",\n    \"Unknown\"\n)\n| extend TimeSinceHeartbeat = datetime_diff('minute', now(), LastHeartbeat)\n| project \n    ['Server'] = Computer,\n    ['Is DC'] = IsDC,\n    ['Agent Status'] = AgentStatus,\n    ['Agent Type'] = AgentType,\n    ['Agent Version'] = AgentVersion,\n    ['Last Heartbeat'] = LastHeartbeat,\n    ['Minutes Ago'] = TimeSinceHeartbeat,\n    ['Environment'] = Environment,\n    ['Heartbeats (24h)'] = HeartbeatCount\n| order by ['Is DC'] desc, ['Agent Status'] asc, Server asc",
                            "size": 0,
                            "title": "ðŸ–¥ï¸ Azure Monitor Agent Installation & Status",
                            "timeContext": {
                                "durationMs": 86400000
                            },
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Agent Status",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "icons",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Active",
                                                    "representation": "success",
                                                    "text": "{0}"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Online",
                                                    "representation": "success",
                                                    "text": "{0}"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Delayed",
                                                    "representation": "warning",
                                                    "text": "{0}"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "error",
                                                    "text": "{0}"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Is DC",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "icons",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Yes",
                                                    "representation": "success",
                                                    "text": "{0}"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "Blank",
                                                    "text": "{0}"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Last Heartbeat",
                                        "formatter": 6
                                    },
                                    {
                                        "columnMatch": "Heartbeats",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    }
                                ]
                            }
                        },
                        "customWidth": "60",
                        "name": "query - ama installation status",
                        "id": "e1186cb5-5279-4994-af84-be0627c90159"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Events Received per Server via AMA (Last 24 Hours)\n// Shows event collection breakdown by server and event type\nlet EmptyEvent = datatable(Computer:string, EventLog:string, EventID:int, TimeGenerated:datetime)[];\nlet EventStats = union isfuzzy=true EmptyEvent, Event\n    | where TimeGenerated > ago(24h)\n    | summarize \n        TotalEvents = count(),\n        DirServiceEvents = countif(EventLog == \"Directory Service\"),\n        Event1644 = countif(EventID == 1644),\n        Event2886 = countif(EventID == 2886),\n        Event2887 = countif(EventID == 2887),\n        Event2888 = countif(EventID == 2888),\n        Event2889 = countif(EventID == 2889),\n        LastEvent = max(TimeGenerated),\n        EventLogs = make_set(EventLog, 10)\n    by Computer;\nlet EmptyHeartbeat = datatable(Computer:string, TimeGenerated:datetime, Category:string)[];\nlet AgentInfo = union isfuzzy=true EmptyHeartbeat, Heartbeat\n    | where TimeGenerated > ago(1d)\n    | summarize LastHeartbeat = max(TimeGenerated), AgentType = arg_max(TimeGenerated, Category).Category by Computer;\n// Get DCs list\nlet EmptySec = datatable(Computer:string, EventID:int, TimeGenerated:datetime)[];\nlet DCsFromKerberos = union isfuzzy=true EmptySec, SecurityEvent\n    | where TimeGenerated > ago(7d)\n    | where EventID in (4768, 4769)\n    | distinct Computer;\nlet DCsFromDirService = union isfuzzy=true EmptyEvent, Event\n    | where TimeGenerated > ago(7d)\n    | where EventLog == \"Directory Service\"\n    | distinct Computer;\nlet AllDCs = union DCsFromKerberos, DCsFromDirService | distinct Computer;\n// Join stats with agent info, focusing on DCs\nAgentInfo\n| where Computer in (AllDCs)\n| join kind=leftouter EventStats on Computer\n| extend \n    LDAPEventsTotal = Event1644 + Event2886 + Event2887 + Event2888 + Event2889,\n    CollectionStatus = case(\n        Event1644 > 0 and Event2889 > 0, \"âœ… Full Collection\",\n        Event1644 > 0 or Event2889 > 0, \"âš ï¸ Partial Collection\",\n        DirServiceEvents > 0, \"âš ï¸ Other DirSvc Events\",\n        TotalEvents > 0, \"âš ï¸ Other Events Only\",\n        \"âŒ No Events\"\n    )\n| project \n    ['Domain Controller'] = Computer,\n    ['Collection Status'] = CollectionStatus,\n    ['Total Events (24h)'] = coalesce(TotalEvents, 0),\n    ['Dir Service Events'] = coalesce(DirServiceEvents, 0),\n    ['1644 (Expensive)'] = coalesce(Event1644, 0),\n    ['2886 (Signing)'] = coalesce(Event2886, 0),\n    ['2887 (ClearText)'] = coalesce(Event2887, 0),\n    ['2888 (Channel)'] = coalesce(Event2888, 0),\n    ['2889 (Unsigned)'] = coalesce(Event2889, 0),\n    ['Last Event'] = LastEvent\n| order by ['Collection Status'] desc, ['Domain Controller'] asc",
                            "size": 0,
                            "title": "ðŸ“Š Events Received per Server (Last 24 Hours)",
                            "timeContext": {
                                "durationMs": 86400000
                            },
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Collection Status",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "icons",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Full",
                                                    "representation": "success",
                                                    "text": "{0}"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Partial",
                                                    "representation": "warning",
                                                    "text": "{0}"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "error",
                                                    "text": "{0}"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "1644|2886|2887|2888|2889",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    },
                                    {
                                        "columnMatch": "Total Events|Dir Service",
                                        "formatter": 8,
                                        "formatOptions": {
                                            "palette": "turquoise"
                                        }
                                    },
                                    {
                                        "columnMatch": "Last Event",
                                        "formatter": 6
                                    }
                                ]
                            }
                        },
                        "customWidth": "40",
                        "name": "query - events per server",
                        "id": "cf2f73f8-8e3c-4061-8689-1b892f086a09"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Event Collection Timeline per DC (Last 7 Days)\n// Shows when LDAP events were collected from each DC\nlet EmptyEvent = datatable(Computer:string, EventLog:string, EventID:int, TimeGenerated:datetime)[];\nunion isfuzzy=true EmptyEvent, Event\n| where TimeGenerated > ago(7d)\n| where EventLog == \"Directory Service\"\n| where EventID in (1644, 2886, 2887, 2888, 2889)\n| summarize EventCount = count() by bin(TimeGenerated, 1h), Computer\n| render timechart with (title=\"LDAP Event Collection per DC Over Time\")",
                            "size": 0,
                            "title": "ðŸ“ˆ Event Collection Timeline per DC (7 Days)",
                            "timeContext": {
                                "durationMs": 604800000
                            },
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "timechart"
                        },
                        "name": "query - event timeline per dc",
                        "id": "7f283544-db9e-4914-beed-3af373781f97"
                    },
                    {
                        "type": 1,
                        "content": {
                            "json": "---\n\n#### âš™ï¸ **DCR Configuration for LDAP Events**\n\nTo collect LDAP events (1644, 2886-2889) via Azure Monitor Agent, create a Data Collection Rule with the following XPath:\n\n```\nDirectory Service!*[System[(EventID=1644 or EventID=2886 or EventID=2887 or EventID=2888 or EventID=2889)]]\n```\n\n**Steps to configure:**\n1. Go to **Azure Portal > Monitor > Data Collection Rules**\n2. Create or edit a DCR associated with your DCs\n3. Add a **Windows Event Log** data source\n4. Select **Custom** and paste the XPath above\n5. Set destination to your Log Analytics workspace\n6. Associate the DCR with your DC VMs\n\n**To enable Event 1644:**\n```powershell\n# Run on each Domain Controller\nNew-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Diagnostics' -Name '15 Field Engineering' -Value 5 -PropertyType DWORD -Force\nNew-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Parameters' -Name 'Expensive Search Results Threshold' -Value 1 -PropertyType DWORD -Force\nNew-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Parameters' -Name 'Inefficient Search Results Threshold' -Value 1 -PropertyType DWORD -Force\n```"
                        },
                        "name": "text - dcr config",
                        "id": "bc4e3ef7-ebbd-4063-8a6d-a7a7b3252b7b"
                    },
                    {
                        "type": 1,
                        "content": {
                            "json": "---\n\n### ðŸ”§ Troubleshooting Failed Collection (Events 1644, 2886-2889)\n\n#### âŒ **Common Causes & Solutions**\n\n| Issue | Symptom | Solution |\n|-------|---------|----------|\n| **Event 1644 not generated** | No expensive query events | Enable Field Engineering registry key (see above) |\n| **Events 2886-2889 not collected** | No bind events | Check DCR XPath configuration |\n| **Wrong table** | Events in `Event` not `SecurityEvent` | Use `Event` table with `EventLog == \\\"Directory Service\\\"` |\n| **AMA not installed** | No heartbeat from DC | Install Azure Monitor Agent on all DCs |\n| **DCR not associated** | Agent installed but no events | Associate DCR with DC VMs |\n| **Firewall blocking** | Agent online but no events flowing | Allow outbound 443 to *.ods.opinsights.azure.com |\n\n---\n\n#### ðŸ” **Step-by-Step Troubleshooting**\n\n**Step 1: Verify events exist locally on DC**\n```powershell\n# Run on Domain Controller\nGet-WinEvent -LogName 'Directory Service' -MaxEvents 10 | Where-Object { $_.Id -in @(1644, 2886, 2887, 2888, 2889) } | Format-Table TimeCreated, Id, Message -Wrap\n```\nIf no events â†’ Registry settings not configured or no LDAP activity occurred.\n\n**Step 2: Verify Event 1644 registry settings**\n```powershell\n# Check if Field Engineering is enabled\nGet-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Diagnostics' | Select-Object '15 Field Engineering'\nGet-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Services\\NTDS\\Parameters' | Select-Object 'Expensive Search Results Threshold', 'Inefficient Search Results Threshold'\n```\nExpected: `15 Field Engineering = 5`, Thresholds = `1`\n\n**Step 3: Verify Azure Monitor Agent installation**\n```powershell\n# Check AMA service status\nGet-Service AzureMonitorAgent, AzureMonitorAgentDependency | Select-Object Name, Status\n# Check agent version\n(Get-ItemProperty 'HKLM:\\SOFTWARE\\Microsoft\\Azure Monitor Agent').Version\n```\n\n**Step 4: Verify DCR configuration in Azure Portal**\n1. Go to **Monitor > Data Collection Rules**\n2. Find your DCR and check **Data Sources**\n3. Verify XPath includes: `Directory Service!*[System[(EventID=1644 or EventID=2886 or EventID=2887 or EventID=2888 or EventID=2889)]]`\n4. Check **Resources** tab - your DCs must be listed\n\n**Step 5: Check agent connectivity**\n```powershell\n# Test connectivity to Log Analytics\nTest-NetConnection -ComputerName '<workspace-id>.ods.opinsights.azure.com' -Port 443\n# Check recent agent logs\nGet-WinEvent -LogName 'Microsoft-AzureMonitorAgent/Operational' -MaxEvents 50 | Where-Object { $_.LevelDisplayName -ne 'Information' }\n```\n\n**Step 6: Force DCR refresh on agent**\n```powershell\n# Restart AMA to pull latest DCR\nRestart-Service AzureMonitorAgent\n```\n\n---\n\n#### âš ï¸ **Event-Specific Notes**\n\n| Event | Frequency | Note |\n|-------|-----------|------|\n| **1644** | Per expensive query | Requires registry config. High volume if thresholds set to 1. |\n| **2886** | Once per 24 hours | Summary event - only appears if LDAP signing NOT enforced |\n| **2887** | Once per 24 hours | Summary of clear-text bind COUNT (not per-bind) |\n| **2888** | Once per 24 hours | Summary of channel binding issues |\n| **2889** | Per unsigned bind | Only event with per-occurrence client IP detail |\n\n---\n\n#### âœ… **Validation Query** (run in Sentinel)\n\n```kusto\n// Check if Directory Service events are being collected\nEvent\n| where TimeGenerated > ago(24h)\n| where EventLog == \"Directory Service\"\n| summarize count() by EventID, Computer\n| order by EventID asc\n```\n\nIf this returns no results, your DCR or agent is not configured correctly."
                        },
                        "name": "text - troubleshooting guide",
                        "id": "70cac27f-286c-4879-b244-f2b425bc1868"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// LDAP Security Posture Score\nlet EmptyEvent = datatable(TimeGenerated:datetime, EventID:int, EventLog:string)[];\nlet UnsignedBinds = toscalar(\n    union isfuzzy=true EmptyEvent, Event\n    | where TimeGenerated > ago(7d)\n    | where EventLog == \"Directory Service\"\n    | where EventID == 2889\n    | count\n);\nlet ClearTextBinds = toscalar(\n    union isfuzzy=true EmptyEvent, Event\n    | where TimeGenerated > ago(7d)\n    | where EventLog == \"Directory Service\"\n    | where EventID == 2887\n    | count\n);\nlet ExpensiveQueries = toscalar(\n    union isfuzzy=true EmptyEvent, Event\n    | where TimeGenerated > ago(7d)\n    | where EventLog == \"Directory Service\"\n    | where EventID == 1644\n    | count\n);\nlet EmptyMDI = datatable(TimeGenerated:datetime, Protocol:string, AdditionalFields:dynamic)[];\nlet PrivGroupQueries = toscalar(\n    union isfuzzy=true EmptyMDI, IdentityDirectoryEvents\n    | where TimeGenerated > ago(7d)\n    | where Protocol == \"Ldap\"\n    | where tostring(AdditionalFields) has_any (\"Domain Admins\", \"Enterprise Admins\", \"adminCount=1\")\n    | count\n);\nlet Score = 100 - \n    (case(UnsignedBinds > 1000, 30, UnsignedBinds > 100, 20, UnsignedBinds > 10, 10, 0) +\n    case(ClearTextBinds > 100, 30, ClearTextBinds > 10, 20, ClearTextBinds > 0, 10, 0) +\n    case(ExpensiveQueries > 100, 20, ExpensiveQueries > 10, 10, 0) +\n    case(PrivGroupQueries > 500, 20, PrivGroupQueries > 100, 10, 0));\nprint \n    SecurityScore = Score,\n    UnsignedLDAPBinds = UnsignedBinds,\n    ClearTextBinds = ClearTextBinds,\n    ExpensiveQueries = ExpensiveQueries,\n    PrivGroupRecon = PrivGroupQueries,\n    Grade = case(\n        Score >= 90, \"A - Excellent\",\n        Score >= 80, \"B - Good\",\n        Score >= 70, \"C - Needs Improvement\",\n        Score >= 60, \"D - Poor\",\n        \"F - Critical\"\n    )",
                            "size": 4,
                            "title": "ðŸŽ¯ LDAP Security Posture Score (Last 7 Days)",
                            "timeContext": {
                                "durationMs": 604800000
                            },
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "tiles",
                            "tileSettings": {
                                "titleContent": {
                                    "columnMatch": "Grade",
                                    "formatter": 1
                                },
                                "leftContent": {
                                    "columnMatch": "SecurityScore",
                                    "formatter": 12,
                                    "formatOptions": {
                                        "palette": "greenRed"
                                    }
                                },
                                "showBorder": false
                            }
                        },
                        "name": "query - security score",
                        "id": "1917ae2c-f078-4465-90dd-c415173fad3c"
                    },
                    {
                        "type": 3,
                        "content": {
                            "version": "KqlItem/1.0",
                            "query": "// Per-DC LDAP Event Collection Compliance with Enhanced DC Discovery\nlet TimeRange = 7d;\nlet RequiredEvents = dynamic([1644, 2886, 2887, 2888, 2889]);\n// Method 1: Discover DCs from Kerberos TGT/TGS events (only DCs generate these)\nlet EmptySecEvent = datatable(Computer:string, TimeGenerated:datetime, EventID:int)[];\nlet DCsFromKerberos = union isfuzzy=true EmptySecEvent, SecurityEvent\n    | where TimeGenerated > ago(TimeRange)\n    | where EventID in (4768, 4769, 4770, 4771)\n    | distinct Computer;\n// Method 2: Discover DCs from Heartbeat (Azure Monitor Agent)\nlet EmptyHeartbeat = datatable(Computer:string, OSType:string, Category:string, TimeGenerated:datetime)[];\nlet DCsFromHeartbeat = union isfuzzy=true EmptyHeartbeat, Heartbeat\n    | where TimeGenerated > ago(TimeRange)\n    | where OSType == \"Windows\"\n    | distinct Computer;\n// Method 3: Discover DCs from MDI (IdentityDirectoryEvents - DestinationDeviceName is DC)\nlet EmptyIDEvents = datatable(DestinationDeviceName:string, TimeGenerated:datetime)[];\nlet DCsFromMDI = union isfuzzy=true EmptyIDEvents, IdentityDirectoryEvents\n    | where TimeGenerated > ago(TimeRange)\n    | where isnotempty(DestinationDeviceName)\n    | distinct Computer = DestinationDeviceName;\n// Method 4: Discover DCs from IdentityLogonEvents\nlet EmptyLogonEvents = datatable(DestinationDeviceName:string, TimeGenerated:datetime)[];\nlet DCsFromLogon = union isfuzzy=true EmptyLogonEvents, IdentityLogonEvents\n    | where TimeGenerated > ago(TimeRange)\n    | where isnotempty(DestinationDeviceName)\n    | distinct Computer = DestinationDeviceName;\n// Method 5: Discover DCs from Event table (Directory Services log)\nlet EmptyEvent = datatable(Computer:string, TimeGenerated:datetime, EventLog:string)[];\nlet DCsFromDirServices = union isfuzzy=true EmptyEvent, Event\n    | where TimeGenerated > ago(TimeRange)\n    | where EventLog == \"Directory Service\"\n    | distinct Computer;\n// Method 6: Discover DCs from SecurityEvent AD replication events\nlet DCsFromReplication = union isfuzzy=true EmptySecEvent, SecurityEvent\n    | where TimeGenerated > ago(TimeRange)\n    | where EventID in (4932, 4933, 4928, 4929)  // AD Replication events\n    | distinct Computer;\n// Method 7: Discover DCs from LDAP port activity in network logs\nlet EmptyNetwork = datatable(DestinationDeviceName:string, RemotePort:int, TimeGenerated:datetime)[];\nlet DCsFromNetwork = union isfuzzy=true EmptyNetwork, DeviceNetworkEvents\n    | where TimeGenerated > ago(TimeRange)\n    | where RemotePort in (389, 636, 3268, 3269)\n    | where isnotempty(DestinationDeviceName)\n    | distinct Computer = DestinationDeviceName;\n// Combine all DC discovery sources\nlet AllDCs = union DCsFromKerberos, DCsFromHeartbeat, DCsFromMDI, DCsFromLogon, DCsFromDirServices, DCsFromReplication, DCsFromNetwork\n    | where isnotempty(Computer)\n    | distinct Computer;\n// Get LDAP events per DC from SecurityEvent\nlet LDAPFromSecurityEvent = union isfuzzy=true EmptySecEvent, SecurityEvent\n    | where TimeGenerated > ago(TimeRange)\n    | where EventID in (RequiredEvents)\n    | summarize Events = make_set(EventID), LastEvent = max(TimeGenerated), EventCount = count() by Computer;\n// Get LDAP events from Event table (Directory Services)\nlet LDAPFromEvent = union isfuzzy=true EmptyEvent, Event\n    | where TimeGenerated > ago(TimeRange)\n    | where EventLog == \"Directory Service\"\n    | where EventID in (RequiredEvents)\n    | summarize Events = make_set(EventID), LastEvent = max(TimeGenerated), EventCount = count() by Computer;\n// Combine LDAP event sources\nlet AllLDAPEvents = union isfuzzy=true LDAPFromSecurityEvent, LDAPFromEvent\n    | summarize Events = make_set(Events), LastEvent = max(LastEvent), TotalEvents = sum(EventCount) by Computer\n    | extend EventsFlat = set_union(Events, dynamic([]));\n// Join discovered DCs with LDAP events\nAllDCs\n| join kind=leftouter AllLDAPEvents on Computer\n| extend EventsFlat = coalesce(EventsFlat, dynamic([]))\n| extend \n    Event1644 = iff(array_index_of(EventsFlat, 1644) >= 0, \"âœ…\", \"âŒ\"),\n    Event2886 = iff(array_index_of(EventsFlat, 2886) >= 0, \"âœ…\", \"âŒ\"),\n    Event2887 = iff(array_index_of(EventsFlat, 2887) >= 0, \"âœ…\", \"âŒ\"),\n    Event2888 = iff(array_index_of(EventsFlat, 2888) >= 0, \"âœ…\", \"âŒ\"),\n    Event2889 = iff(array_index_of(EventsFlat, 2889) >= 0, \"âœ…\", \"âŒ\")\n| extend EventsCollected = array_length(EventsFlat)\n| extend ComplianceStatus = case(\n    EventsCollected == 5, \"âœ… Full Compliance\",\n    EventsCollected >= 3, \"âš ï¸ Partial\",\n    EventsCollected >= 1, \"âš ï¸ Minimal\",\n    \"âŒ No LDAP Events\"\n)\n| extend MissingEvents = iff(EventsCollected == 0, \"All (1644, 2886, 2887, 2888, 2889)\", strcat_array(set_difference(RequiredEvents, EventsFlat), \", \"))\n| project \n    ['Domain Controller'] = Computer,\n    ['1644 (Expensive)'] = Event1644,\n    ['2886 (Signing)'] = Event2886,\n    ['2887 (ClearText)'] = Event2887,\n    ['2888 (Channel)'] = Event2888,\n    ['2889 (Unsigned)'] = Event2889,\n    ['Status'] = ComplianceStatus,\n    ['Missing Events'] = iff(isempty(MissingEvents), \"None\", MissingEvents),\n    ['Last LDAP Event'] = LastEvent,\n    ['Total Events'] = coalesce(TotalEvents, 0)\n| order by ['Status'] desc, ['Domain Controller'] asc",
                            "size": 0,
                            "title": "ðŸ“‹ Per-DC LDAP Event Collection Compliance",
                            "timeContext": {
                                "durationMs": 604800000
                            },
                            "queryType": 0,
                            "resourceType": "microsoft.operationalinsights/workspaces",
                            "crossComponentResources": [
                                "{Workspace}"
                            ],
                            "visualization": "table",
                            "gridSettings": {
                                "formatters": [
                                    {
                                        "columnMatch": "Status",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "colors",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Full Compliance",
                                                    "representation": "green",
                                                    "text": "{0}{1}"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Partial",
                                                    "representation": "yellow",
                                                    "text": "{0}{1}"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "Non-Compliant",
                                                    "representation": "redBright",
                                                    "text": "{0}{1}"
                                                },
                                                {
                                                    "operator": "contains",
                                                    "thresholdValue": "No Events",
                                                    "representation": "redBright",
                                                    "text": "{0}{1}"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "gray",
                                                    "text": "{0}{1}"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "1644|2886|2887|2888|2889",
                                        "formatter": 18,
                                        "formatOptions": {
                                            "thresholdsOptions": "icons",
                                            "thresholdsGrid": [
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "âœ…",
                                                    "representation": "success",
                                                    "text": "âœ…"
                                                },
                                                {
                                                    "operator": "==",
                                                    "thresholdValue": "âŒ",
                                                    "representation": "failed",
                                                    "text": "âŒ"
                                                },
                                                {
                                                    "operator": "Default",
                                                    "thresholdValue": null,
                                                    "representation": "unknown",
                                                    "text": "{0}{1}"
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        "columnMatch": "Last Event",
                                        "formatter": 6,
                                        "formatOptions": {
                                            "customColumnWidthSetting": "150px"
                                        }
                                    },
                                    {
                                        "columnMatch": "Total Events",
                                        "formatter": 4,
                                        "formatOptions": {
                                            "palette": "blue"
                                        }
                                    }
                                ]
                            }
                        },
                        "name": "query - compliance",
                        "id": "582f3bed-7510-4a1e-93a3-c67ac17432e4"
                    },
                    {
                        "type": 1,
                        "content": {
                            "json": "---\n\n#### ðŸ“š **References & Resources**\n\n| Resource | Description | Link |\n|----------|-------------|------|\n| **ADV190023** | Microsoft LDAP Channel Binding Advisory | [Microsoft Security Advisory](https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/ADV190023) |\n| **KB4520412** | LDAP Channel Binding and Signing | [Microsoft KB](https://support.microsoft.com/en-us/topic/2020-ldap-channel-binding-and-ldap-signing-requirements-for-windows-ef185fb8-00f7-167d-744c-f299a66fc00a) |\n| **Event 1644** | Expensive LDAP Query Logging | [Microsoft Docs](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc773540(v=ws.10)) |\n| **BloodHound** | Attack Path Detection | [BloodHound GitHub](https://github.com/BloodHoundAD/BloodHound) |\n\n---\n\n#### ðŸš¨ **Immediate Action Items**\n\n1. **Critical:** Review all accounts with clear text LDAP binds and enforce LDAPS\n2. **High:** Enable Event 1644 logging on all Domain Controllers\n3. **High:** Configure LDAP signing (`LDAPServerIntegrity = 2`)\n4. **High:** Configure LDAP channel binding (`LdapEnforceChannelBinding = 2`)\n5. **Medium:** Review and minimize privileged group membership\n6. **Medium:** Implement Just-In-Time (JIT) privileged access\n7. **Low:** Create alerts for BloodHound/SharpHound patterns\n\n---\n\n#### ðŸ” **Detection Rule Templates**\n\nCreate the following Sentinel Analytics Rules based on this workbook:\n\n| Rule Name | Severity | Query Pattern |\n|-----------|----------|---------------|\n| BloodHound Collection Detected | High | >1000 LDAP queries in 1 hour with multiple objectClass types |\n| Clear Text LDAP Bind | Medium | Event 2887 from non-service accounts |\n| KRBTGT Access Attempt | Critical | Any LDAP query targeting KRBTGT |\n| Domain-Wide Enumeration | High | Event 1644 with >100,000 visited entries |\n| New LDAP Client | Medium | First-time LDAP source IP with >100 queries |"
                        },
                        "name": "text - references",
                        "id": "d6442312-9429-4e61-9888-a0ca4634a0b7"
                    }
                ]
            },
            "conditionalVisibility": {
                "parameterName": "selectedTab",
                "comparison": "isEqualTo",
                "value": "BestPractices"
            },
            "name": "group - best practices",
            "id": "38e7c5bf-d2b7-4264-96a5-0c36af04e015"
        }
    ],
    "fallbackResourceIds": [
        "/subscriptions/e3b7b2a3-b776-46be-a556-1ea5fbc1a588/resourcegroups/rg_sentinel/providers/microsoft.operationalinsights/workspaces/lawsentinel"
    ],
    "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json",
    "context": {
        "ownerId": "/subscriptions/e3b7b2a3-b776-46be-a556-1ea5fbc1a588/resourcegroups/rg_sentinel/providers/microsoft.operationalinsights/workspaces/lawsentinel"
    }
}
