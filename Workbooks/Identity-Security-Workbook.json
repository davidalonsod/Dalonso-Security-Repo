{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# üîê App Identity Security & Threat Investigation Workbook\n---\n**Purpose:** Comprehensive app identity security monitoring for OAuth Apps, Service Principals, Managed Identities, and AI Agents. No user-focused data - purely application identity threat detection.\n\n**Data Sources:** AADServicePrincipalSignInLogs, AADManagedIdentitySignInLogs, AuditLogs, CloudAppEvents\n\n**Last Updated:** January 2026\n\n---\n\n## üìã Requirements & Prerequisites\n\n### **Required Data Sources**\n\n| Data Source | Purpose | Collection Method |\n|-------------|---------|-------------------|\n| **AADServicePrincipalSignInLogs** | Service Principal authentication events | Azure AD Diagnostic Settings ‚Üí Log Analytics |\n| **AADManagedIdentitySignInLogs** | Managed Identity authentication events | Azure AD Diagnostic Settings ‚Üí Log Analytics |\n| **AuditLogs** | Azure AD audit events (app registrations, consents, role assignments) | Azure AD Diagnostic Settings ‚Üí Log Analytics |\n| **CloudAppEvents** | Microsoft 365 cloud app activity (mail, files access) | Microsoft Defender for Cloud Apps ‚Üí Sentinel Connector |\n| **SigninLogs** | User sign-in data for cross-reference | Azure AD Diagnostic Settings ‚Üí Log Analytics |\n\n### **Prerequisites**\n\n**1. Azure AD Diagnostic Settings:**\n- ‚úÖ Enable ServicePrincipalSignInLogs, ManagedIdentitySignInLogs, AuditLogs\n- ‚úÖ Route to Log Analytics workspace connected to Sentinel\n- ‚úÖ Allow 15-30 minutes for initial data ingestion\n\n**2. Microsoft Defender for Cloud Apps (for CloudAppEvents):**\n- ‚úÖ Enable Microsoft 365 Defender connector in Sentinel\n- ‚úÖ CloudAppEvents table populated\n\n**3. Azure Resource Permissions:**\n- ‚úÖ Reader access to Azure AD for diagnostic settings\n- ‚úÖ Log Analytics Contributor for workspace configuration\n\n### **Verification Steps**\n\n```kql\n// Test AADServicePrincipalSignInLogs\nAADServicePrincipalSignInLogs | take 10\n\n// Test AADManagedIdentitySignInLogs\nAADManagedIdentitySignInLogs | take 10\n\n// Test AuditLogs\nAuditLogs | where OperationName has \"application\" | take 10\n\n// Test CloudAppEvents\nCloudAppEvents | take 10\n```\n\n‚ö†Ô∏è **Note:** If queries return 0 results, verify diagnostic settings are enabled and data is flowing. Allow 24-48 hours for full data population.\n\n---"
      },
      "name": "Header"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "timeRange",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 604800000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 3600000,
                  "displayName": "Last 1 hour"
                },
                {
                  "durationMs": 14400000,
                  "displayName": "Last 4 hours"
                },
                {
                  "durationMs": 86400000,
                  "displayName": "Last 24 hours"
                },
                {
                  "durationMs": 604800000,
                  "displayName": "Last 7 days"
                },
                {
                  "durationMs": 2592000000,
                  "displayName": "Last 30 days"
                }
              ]
            },
            "label": "Time Range"
          },
          {
            "id": "userFilter",
            "version": "KqlParameterItem/1.0",
            "name": "UserFilter",
            "type": 1,
            "value": "*",
            "label": "User Filter (UPN)"
          }
        ],
        "style": "pills",
        "queryType": 0
      },
      "name": "Parameters"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "executive",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üìà Executive Summary",
            "subTarget": "executive"
          },
          {
            "id": "overview",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üìä Overview",
            "subTarget": "overview"
          },
          {
            "id": "oauth",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üîë OAuth & App Governance",
            "subTarget": "oauth"
          },
          {
            "id": "serviceprincipal",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "‚öôÔ∏è Service Principals",
            "subTarget": "serviceprincipal"
          },
          {
            "id": "managedidentity",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "ü§ñ Managed Identities",
            "subTarget": "managedidentity"
          },
          {
            "id": "botnet",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üï∏Ô∏è Botnet Detection",
            "subTarget": "botnet"
          },
          {
            "id": "threats",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üö® Threat Investigation",
            "subTarget": "threats"
          },
          {
            "id": "remediation",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üõ†Ô∏è Remediation Actions",
            "subTarget": "remediation"
          },
          {
            "id": "geolocation",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üó∫Ô∏è Geolocation",
            "subTarget": "geolocation"
          },
          {
            "id": "forensics",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "üîç Forensic Investigation",
            "subTarget": "forensics"
          }
        ]
      },
      "name": "TabNavigation"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üìà Executive Summary - Non-Human Identity Security Posture\n---\n### For CISOs, CIOs, and Security Leadership\n\nReal-time visibility into your organization's **non-human identity security posture**. This dashboard surfaces critical risks across Service Principals, Managed Identities, and OAuth Applications requiring executive attention.\n\n| üî¥ Critical | üü† High | üü° Medium | üü¢ Low |\n|---|---|---|---|\n| Immediate action required | Action within 24h | Review within 7d | Monitor |\n\n---"
            },
            "name": "ExecutiveHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Overall Security Score (0-100)\nlet SPHealth = AADServicePrincipalSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | summarize Total = count(), Failed = countif(ResultType != '0'), UniqueSPs = dcount(ServicePrincipalId)\n    | extend SPFailRate = iff(Total == 0, 0.0, round(todouble(Failed) / todouble(Total) * 100.0, 1))\n    | extend SPScore = max_of(0.0, 100.0 - SPFailRate - iff(Failed > 100, 20.0, 0.0));\nlet MIHealth = AADManagedIdentitySignInLogs\n    | where TimeGenerated >= ago(7d)\n    | summarize Total = count(), Failed = countif(ResultType != '0')\n    | extend MIFailRate = iff(Total == 0, 0.0, round(todouble(Failed) / todouble(Total) * 100.0, 1))\n    | extend MIScore = max_of(0.0, 100.0 - MIFailRate - iff(Failed > 50, 15.0, 0.0));\nlet ConsentRisk = AuditLogs\n    | where TimeGenerated >= ago(7d)\n    | where OperationName has 'Consent'\n    | summarize ConsentCount = count()\n    | extend ConsentScore = max_of(0.0, 100.0 - iff(ConsentCount > 20, 30.0, iff(ConsentCount > 5, 15.0, 0.0)));\nSPHealth | extend placeholder = 1\n| join kind=leftouter (MIHealth | extend placeholder = 1) on placeholder\n| join kind=leftouter (ConsentRisk | extend placeholder = 1) on placeholder\n| extend OverallScore = round((coalesce(SPScore, 100.0) + coalesce(MIScore, 100.0) + coalesce(ConsentScore, 100.0)) / 3.0, 0)\n| extend ScoreStatus = case(\n    OverallScore >= 90.0, 'üü¢ Excellent',\n    OverallScore >= 75.0, 'üü° Good',\n    OverallScore >= 60.0, 'üü† Needs Attention',\n    'üî¥ Critical'\n)\n| project Metric = 'Security Score', Value = OverallScore, Status = ScoreStatus",
              "size": 4,
              "title": "üèÜ Identity Security Score",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": {
                  "columnMatch": "Metric",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Value",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "greenRed",
                    "min": 0,
                    "max": 100
                  },
                  "numberFormat": {
                    "unit": 0,
                    "options": {
                      "style": "decimal"
                    }
                  }
                },
                "secondaryContent": {
                  "columnMatch": "Status",
                  "formatter": 1
                }
              }
            },
            "customWidth": "25",
            "name": "SecurityScore"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Active Threats (24h)\nlet CompromisedSPs = AADServicePrincipalSignInLogs\n    | where TimeGenerated >= ago(24h)\n    | summarize Total = count(), Failed = countif(ResultType != '0'), IPs = dcount(IPAddress) by ServicePrincipalId\n    | where (Total > 0 and todouble(Failed) / Total > 0.8 and Failed > 20) or IPs > 10\n    | summarize Count = count();\nlet SuspiciousGeo = AADServicePrincipalSignInLogs\n    | where TimeGenerated >= ago(24h)\n    | extend LocationData = parse_json(LocationDetails)\n    | extend Country = tostring(LocationData.countryOrRegion)\n    | where Country != ''\n    | summarize Countries = dcount(Country) by ServicePrincipalId\n    | where Countries >= 3\n    | summarize Count = count();\nlet MaliciousConsents = AuditLogs\n    | where TimeGenerated >= ago(24h)\n    | where OperationName has 'Consent'\n    | extend Initiator = tostring(InitiatedBy.user.userPrincipalName)\n    | where Result != 'success' or Initiator == ''\n    | summarize Count = count();\nunion\n    (CompromisedSPs | extend ThreatType = 'Compromised'),\n    (SuspiciousGeo | extend ThreatType = 'GeoAnomaly'),\n    (MaliciousConsents | extend ThreatType = 'Consent')\n| summarize TotalThreats = sum(Count)\n| extend Severity = case(TotalThreats >= 10, 'üî¥ Critical', TotalThreats >= 3, 'üü† High', TotalThreats > 0, 'üü° Medium', 'üü¢ None')\n| project Metric = 'Active Threats', Value = TotalThreats, Status = Severity",
              "size": 4,
              "title": "üö® Active Threats (24h)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": {
                  "columnMatch": "Metric",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Value",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "redGreen",
                    "min": 0
                  },
                  "numberFormat": {
                    "unit": 0,
                    "options": {
                      "style": "decimal"
                    }
                  }
                },
                "secondaryContent": {
                  "columnMatch": "Status",
                  "formatter": 1
                }
              }
            },
            "customWidth": "25",
            "name": "ActiveThreats"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Total Non-Human Identities\nlet SPs = AADServicePrincipalSignInLogs | where TimeGenerated >= ago(30d) | summarize by ServicePrincipalId | count | project Count;\nlet MIs = AADManagedIdentitySignInLogs | where TimeGenerated >= ago(30d) | summarize by ServicePrincipalId | count | project Count;\nunion SPs, MIs\n| summarize TotalIdentities = sum(Count)\n| project Metric = 'Monitored Identities', Value = TotalIdentities, Status = 'üìä'",
              "size": 4,
              "title": "ü§ñ Identity Inventory",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": {
                  "columnMatch": "Metric",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Value",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "blue"
                  },
                  "numberFormat": {
                    "unit": 0,
                    "options": {
                      "style": "decimal"
                    }
                  }
                },
                "secondaryContent": {
                  "columnMatch": "Status",
                  "formatter": 1
                }
              }
            },
            "customWidth": "25",
            "name": "IdentityInventory"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Week-over-Week Failure Change\nlet ThisWeek = AADServicePrincipalSignInLogs | where TimeGenerated >= ago(7d) | summarize TW = countif(ResultType != '0');\nlet LastWeek = AADServicePrincipalSignInLogs | where TimeGenerated between (ago(14d) .. ago(7d)) | summarize LW = countif(ResultType != '0');\nThisWeek | extend p = 1 | join kind=leftouter (LastWeek | extend p = 1) on p\n| extend LW = coalesce(LW, 1)\n| extend Change = round((todouble(TW) - LW) / LW * 100, 0)\n| extend Status = case(Change > 50, strcat('üî¥ +', tostring(toint(Change)), '%'), Change > 10, strcat('üü† +', tostring(toint(Change)), '%'), Change < -10, strcat('üü¢ ', tostring(toint(Change)), '%'), '‚û°Ô∏è Stable')\n| project Metric = 'WoW Failures', Value = TW, Status",
              "size": 4,
              "title": "üìÖ Week Trend",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": {
                  "columnMatch": "Metric",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Value",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "blue"
                  },
                  "numberFormat": {
                    "unit": 0,
                    "options": {
                      "style": "decimal"
                    }
                  }
                },
                "secondaryContent": {
                  "columnMatch": "Status",
                  "formatter": 1
                }
              }
            },
            "customWidth": "25",
            "name": "WeekTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Detailed KPIs\nlet SPMetrics = AADServicePrincipalSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | summarize SPTotal = count(), SPFailed = countif(ResultType != '0'), SPActive = dcount(ServicePrincipalId), SPExternal = dcountif(IPAddress, not(ipv4_is_private(IPAddress)) and IPAddress != '');\nlet MIMetrics = AADManagedIdentitySignInLogs\n    | where TimeGenerated >= ago(7d)\n    | summarize MITotal = count(), MIFailed = countif(ResultType != '0'), MIActive = dcount(ServicePrincipalId);\nlet ConsentMetrics = AuditLogs\n    | where TimeGenerated >= ago(7d)\n    | where OperationName has 'Consent'\n    | summarize Consents = count(), AdminConsents = countif(OperationName has 'admin');\nlet NewApps = AuditLogs\n    | where TimeGenerated >= ago(7d)\n    | where OperationName in ('Add application', 'Add service principal')\n    | summarize NewAppCount = count();\nSPMetrics | extend p = 1 | join kind=leftouter (MIMetrics | extend p = 1) on p | join kind=leftouter (ConsentMetrics | extend p = 1) on p | join kind=leftouter (NewApps | extend p = 1) on p\n| extend SPFailRate = iff(SPTotal == 0, 0.0, round(todouble(SPFailed) / SPTotal * 100, 1))\n| extend MIFailRate = iff(coalesce(MITotal, 0) == 0, 0.0, round(todouble(coalesce(MIFailed, 0)) / coalesce(MITotal, 1) * 100, 1))\n| project \n    SPAuthVolume = SPTotal,\n    SPFailureRate = SPFailRate,\n    SPStatus = case(SPFailRate > 10, 'üî¥', SPFailRate > 5, 'üü°', 'üü¢'),\n    MIAuthVolume = coalesce(MITotal, 0),\n    MIFailureRate = MIFailRate,\n    MIStatus = case(MIFailRate > 10, 'üî¥', MIFailRate > 5, 'üü°', 'üü¢'),\n    ActiveSPs = SPActive,\n    ActiveMIs = coalesce(MIActive, 0),\n    ExternalIPs = SPExternal,\n    OAuthConsents = coalesce(Consents, 0),\n    NewApps = coalesce(NewAppCount, 0)",
              "size": 0,
              "title": "üìä Key Performance Indicators (7-Day Summary)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "SPFailureRate",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "redGreen",
                      "min": 0,
                      "max": 20
                    }
                  },
                  {
                    "columnMatch": "MIFailureRate",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "redGreen",
                      "min": 0,
                      "max": 20
                    }
                  }
                ]
              }
            },
            "name": "DetailedKPIs"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top Critical Findings\nlet Finding1 = AADServicePrincipalSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | summarize Total = count(), Failed = countif(ResultType != '0') by ServicePrincipalName, ServicePrincipalId\n    | where Total > 0 and (Failed > 50 or (todouble(Failed) / Total > 0.5 and Failed > 10))\n    | top 3 by Failed\n    | extend Priority = 1, Category = 'üî¥ Compromised App', Finding = strcat(ServicePrincipalName, ' - ', Failed, ' failures (', round(todouble(Failed)/Total*100,0), '% rate)'), Impact = 'Credential compromise risk', Action = 'Disable & rotate';\nlet Finding2 = AADServicePrincipalSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | extend LocationData = parse_json(LocationDetails)\n    | extend Country = tostring(LocationData.countryOrRegion)\n    | where Country != ''\n    | summarize Countries = make_set(Country, 5), CountryCount = dcount(Country) by ServicePrincipalName\n    | where CountryCount >= 3\n    | top 2 by CountryCount\n    | extend Priority = 2, Category = 'üü† Impossible Travel', Finding = strcat(ServicePrincipalName, ' - ', CountryCount, ' countries: ', tostring(Countries)), Impact = 'Distributed attack', Action = 'Enable geo-fencing';\nlet Finding3 = AuditLogs\n    | where TimeGenerated >= ago(7d)\n    | where OperationName has 'Consent'\n    | extend AppName = tostring(TargetResources[0].displayName)\n    | extend Initiator = coalesce(tostring(InitiatedBy.user.userPrincipalName), 'Unknown')\n    | where Initiator == 'Unknown' or OperationName has 'admin'\n    | summarize Count = count() by AppName\n    | where Count > 0\n    | top 2 by Count\n    | extend Priority = 3, Category = 'üü† Suspicious Consent', ServicePrincipalName = AppName, Finding = strcat(AppName, ' - ', Count, ' suspicious consents'), Impact = 'OAuth phishing risk', Action = 'Revoke consents';\nlet Finding4 = AADServicePrincipalSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | where not(ipv4_is_private(IPAddress)) and IPAddress != ''\n    | summarize IPs = dcount(IPAddress), Events = count() by ServicePrincipalName\n    | where IPs > 20\n    | top 2 by IPs\n    | extend Priority = 4, Category = 'üü° External Exposure', Finding = strcat(ServicePrincipalName, ' - ', IPs, ' external IPs'), Impact = 'Wide credential distribution', Action = 'IP restrictions';\nunion Finding1, Finding2, Finding3, Finding4\n| project Priority, Category, Finding, Impact, Action\n| order by Priority asc\n| take 10",
              "size": 0,
              "title": "üö® Top Critical Findings Requiring Executive Attention",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Priority",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "1",
                          "representation": "Sev0",
                          "text": ""
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "2",
                          "representation": "Sev1",
                          "text": ""
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "3",
                          "representation": "Sev2",
                          "text": ""
                        },
                        {
                          "operator": "Default",
                          "representation": "Sev3",
                          "text": ""
                        }
                      ]
                    }
                  }
                ]
              }
            },
            "name": "CriticalFindings"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// 30-Day Failure Rate Trend\nlet SPTrend = AADServicePrincipalSignInLogs\n    | where TimeGenerated >= ago(30d)\n    | summarize SPTotal = count(), SPFailed = countif(ResultType != '0') by bin(TimeGenerated, 1d)\n    | extend FailureRate = iff(SPTotal == 0, 0.0, round(todouble(SPFailed) / SPTotal * 100, 1))\n    | project TimeGenerated, FailureRate, Category = 'Service Principals';\nlet MITrend = AADManagedIdentitySignInLogs\n    | where TimeGenerated >= ago(30d)\n    | summarize MITotal = count(), MIFailed = countif(ResultType != '0') by bin(TimeGenerated, 1d)\n    | extend FailureRate = iff(MITotal == 0, 0.0, round(todouble(MIFailed) / MITotal * 100, 1))\n    | project TimeGenerated, FailureRate, Category = 'Managed Identities';\nunion SPTrend, MITrend\n| render timechart",
              "size": 0,
              "title": "üìà Auth Failure Rate Trend (30 Days) - Lower is Better",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart",
              "chartSettings": {
                "ySettings": {
                  "min": 0,
                  "max": 20
                }
              }
            },
            "customWidth": "60",
            "name": "FailureTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Risk Distribution\nlet HighRisk = AADServicePrincipalSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | summarize Total = count(), Failed = countif(ResultType != '0') by ServicePrincipalId\n    | where Total > 0 and todouble(Failed) / Total > 0.5 and Failed > 20\n    | count | project Category = 'üî¥ High Risk', Count;\nlet MediumRisk = AADServicePrincipalSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | summarize Total = count(), Failed = countif(ResultType != '0') by ServicePrincipalId\n    | where Total > 0 and todouble(Failed) / Total between (0.1 .. 0.5) and Failed > 5\n    | count | project Category = 'üü† Medium Risk', Count;\nlet LowRisk = AADServicePrincipalSignInLogs\n    | where TimeGenerated >= ago(7d)\n    | summarize Total = count(), Failed = countif(ResultType != '0') by ServicePrincipalId\n    | where Total > 0 and (todouble(Failed) / Total < 0.1 or Failed <= 5)\n    | count | project Category = 'üü¢ Low Risk', Count;\nunion HighRisk, MediumRisk, LowRisk",
              "size": 2,
              "title": "‚ö†Ô∏è SP Risk Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "üî¥ High Risk",
                    "color": "redBright"
                  },
                  {
                    "seriesName": "üü† Medium Risk",
                    "color": "orange"
                  },
                  {
                    "seriesName": "üü¢ Low Risk",
                    "color": "green"
                  }
                ]
              }
            },
            "customWidth": "40",
            "name": "RiskDistribution"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Week-over-Week Comparison Table\nlet ThisWeek = AADServicePrincipalSignInLogs | where TimeGenerated >= ago(7d) | summarize TW_Total = count(), TW_Failed = countif(ResultType != '0'), TW_SPs = dcount(ServicePrincipalId);\nlet LastWeek = AADServicePrincipalSignInLogs | where TimeGenerated between (ago(14d) .. ago(7d)) | summarize LW_Total = count(), LW_Failed = countif(ResultType != '0'), LW_SPs = dcount(ServicePrincipalId);\nlet TWConsents = AuditLogs | where TimeGenerated >= ago(7d) | where OperationName has 'Consent' | count | project TW_Consents = Count;\nlet LWConsents = AuditLogs | where TimeGenerated between (ago(14d) .. ago(7d)) | where OperationName has 'Consent' | count | project LW_Consents = Count;\nThisWeek | extend p = 1 \n| join kind=leftouter (LastWeek | extend p = 1) on p \n| join kind=leftouter (TWConsents | extend p = 1) on p \n| join kind=leftouter (LWConsents | extend p = 1) on p\n| extend LW_Total = coalesce(LW_Total, 1), LW_Failed = coalesce(LW_Failed, 1), LW_Consents = coalesce(LW_Consents, 0)\n| extend VolumeChg = round((todouble(TW_Total) - LW_Total) / LW_Total * 100, 0)\n| extend FailureChg = round((todouble(TW_Failed) - LW_Failed) / LW_Failed * 100, 0)\n| extend ConsentChg = coalesce(TW_Consents, 0) - LW_Consents\n| project \n    Metric = pack_array('Auth Volume', 'Failures', 'OAuth Consents'),\n    ThisWeek = pack_array(TW_Total, TW_Failed, coalesce(TW_Consents, 0)),\n    LastWeek = pack_array(LW_Total, LW_Failed, LW_Consents),\n    Change = pack_array(\n        case(VolumeChg > 50, strcat('üìà +', tostring(toint(VolumeChg)), '%'), VolumeChg < -20, strcat('üìâ ', tostring(toint(VolumeChg)), '%'), '‚û°Ô∏è Stable'),\n        case(FailureChg > 25, strcat('üî¥ +', tostring(toint(FailureChg)), '%'), FailureChg < -10, strcat('üü¢ ', tostring(toint(FailureChg)), '%'), 'üü° Stable'),\n        case(ConsentChg > 10, strcat('üü† +', tostring(ConsentChg)), ConsentChg < 0, strcat('üü¢ ', tostring(ConsentChg)), '‚û°Ô∏è Stable')\n    )\n| mv-expand Metric to typeof(string), ThisWeek to typeof(long), LastWeek to typeof(long), Change to typeof(string)",
              "size": 0,
              "title": "üìÖ Week-over-Week Performance",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "WeekComparison"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top 5 Most Active SPs\nAADServicePrincipalSignInLogs\n| where TimeGenerated >= ago(7d)\n| summarize TotalEvents = count(), FailedEvents = countif(ResultType != '0'), Resources = dcount(ResourceDisplayName) by ServicePrincipalName\n| extend FailRate = iff(TotalEvents == 0, 0.0, round(todouble(FailedEvents) / TotalEvents * 100, 1))\n| extend Status = case(FailRate > 20, 'üî¥', FailRate > 5, 'üü°', 'üü¢')\n| top 5 by TotalEvents desc\n| project ServicePrincipalName, TotalEvents, FailedEvents, FailRate, Resources, Status",
              "size": 0,
              "title": "üèÖ Top 5 Active Service Principals",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TotalEvents",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "blue",
                      "min": 0
                    }
                  },
                  {
                    "columnMatch": "FailRate",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "redGreen",
                      "min": 0,
                      "max": 50
                    }
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "TopSPs"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top 10 High Risk IPs - Sources targeting your apps\nAADServicePrincipalSignInLogs\n| where TimeGenerated >= ago(7d)\n| where IPAddress != ''\n| summarize \n    TotalAttempts = count(),\n    FailedAttempts = countif(ResultType != '0'),\n    SuccessfulAttempts = countif(ResultType == '0'),\n    TargetedApps = dcount(ServicePrincipalId),\n    Countries = make_set(tostring(parse_json(LocationDetails).countryOrRegion), 3)\n    by IPAddress\n| extend FailureRate = round(todouble(FailedAttempts) / TotalAttempts * 100, 1)\n| extend ThreatScore = (FailedAttempts / 10) + (TargetedApps * 5) + iif(SuccessfulAttempts > 0 and FailedAttempts > 10, 50, 0)\n| where ThreatScore > 20 or FailedAttempts > 50\n| extend ThreatLevel = case(\n    SuccessfulAttempts > 0 and FailedAttempts > 10, 'üî¥ CRITICAL - Compromise Likely',\n    TargetedApps > 10, 'üî¥ CRITICAL - Wide Spray',\n    FailedAttempts > 100, 'üü† HIGH - Brute Force',\n    FailureRate > 80, 'üü† HIGH - Attack Source',\n    'üü° MEDIUM'\n)\n| project ThreatLevel, IPAddress, ThreatScore, FailedAttempts, SuccessfulAttempts, TargetedApps, Countries\n| order by ThreatScore desc\n| take 10",
              "size": 0,
              "title": "üåê Top 10 High Risk IPs",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "ThreatScore",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "redGreen",
                      "min": 0
                    }
                  },
                  {
                    "columnMatch": "ThreatLevel",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "contains",
                          "thresholdValue": "CRITICAL",
                          "representation": "red",
                          "text": "{0}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "HIGH",
                          "representation": "orange",
                          "text": "{0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "yellow",
                          "text": "{0}"
                        }
                      ]
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "TopHighRiskIPs"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Top 10 Apps at Risk - Service Principals under attack or compromised\nAADServicePrincipalSignInLogs\n| where TimeGenerated >= ago(7d)\n| summarize \n    TotalAttempts = count(),\n    FailedAttempts = countif(ResultType != '0'),\n    SuccessfulAttempts = countif(ResultType == '0'),\n    UniqueIPs = dcount(IPAddress),\n    UniqueCountries = dcount(tostring(parse_json(LocationDetails).countryOrRegion)),\n    LastActivity = max(TimeGenerated)\n    by ServicePrincipalName, ServicePrincipalId\n| extend FailureRate = round(todouble(FailedAttempts) / TotalAttempts * 100, 1)\n| extend RiskScore = (FailedAttempts / 10) + (UniqueCountries * 10) + iif(FailureRate > 50 and FailedAttempts > 20, 50, 0) + iif(UniqueIPs > 20, 20, 0)\n| where RiskScore > 15 or FailedAttempts > 50\n| extend RiskLevel = case(\n    FailureRate > 50 and FailedAttempts > 50, 'üî¥ CRITICAL - Under Attack',\n    UniqueCountries > 5, 'üî¥ CRITICAL - Geo Anomaly',\n    SuccessfulAttempts > 0 and UniqueCountries > 3, 'üü† HIGH - Suspicious Activity',\n    FailedAttempts > 100, 'üü† HIGH - Targeted',\n    'üü° MEDIUM'\n)\n| project RiskLevel, ServicePrincipalName, RiskScore, FailedAttempts, SuccessfulAttempts, UniqueIPs, UniqueCountries, LastActivity\n| order by RiskScore desc\n| take 10",
              "size": 0,
              "title": "‚ö†Ô∏è Top 10 Apps at Risk",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "RiskScore",
                    "formatter": 4,
                    "formatOptions": {
                      "palette": "redGreen",
                      "min": 0
                    }
                  },
                  {
                    "columnMatch": "RiskLevel",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "contains",
                          "thresholdValue": "CRITICAL",
                          "representation": "red",
                          "text": "{0}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "HIGH",
                          "representation": "orange",
                          "text": "{0}"
                        },
                        {
                          "operator": "Default",
                          "representation": "yellow",
                          "text": "{0}"
                        }
                      ]
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "50",
            "name": "TopAppsAtRisk"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üìã Executive Action Items\n\n| Priority | Area | Issue | Recommended Action | Owner | SLA |\n|:--------:|------|-------|-------------------|-------|-----|\n| üî¥ **P1** | **Compromised Apps** | SPs with >50% failure rate | Disable, rotate credentials, forensic review | Security Ops | **4 hours** |\n| üî¥ **P1** | **Suspicious OAuth** | Unknown initiator consents | Revoke consents, audit permissions | IAM Team | **4 hours** |\n| üü† **P2** | **Geo Anomalies** | Apps from multiple countries | Enable conditional access geo-blocking | Identity Team | **24 hours** |\n| üü† **P2** | **Elevated Failures** | Failures above baseline | Investigate for attack patterns | SOC | **24 hours** |\n| üü° **P3** | **App Governance** | New registrations without review | Implement approval workflow | App Governance | **7 days** |\n| üü° **P3** | **Credential Hygiene** | Secrets nearing expiration | Automate 90-day rotation | Platform Team | **7 days** |\n\n---\n\n### üéØ Strategic Recommendations\n\n| Initiative | Business Impact | Effort | Timeline |\n|------------|----------------|--------|----------|\n| **Migrate to Managed Identities** | Eliminate secret management, reduce attack surface | Medium | 3-6 months |\n| **Implement App Governance** | Control shadow IT, enforce compliance | Low | 1-2 months |\n| **Workload Identity Federation** | Zero-trust for CI/CD, no stored secrets | Medium | 2-4 months |\n| **Conditional Access for Workloads** | Geo-fencing, IP restrictions | Low | 1 month |\n| **Automate Secret Rotation** | Reduce credential theft window | Medium | 2-3 months |\n\n---\n\n### üìä Compliance Scorecard\n\n| Control | Status | Target | Gap |\n|---------|--------|--------|-----|\n| Managed Identity Coverage | üìä See Inventory | 80%+ | Review MI adoption |\n| Secret Rotation | ‚è≥ Manual | Auto 90-day | Implement automation |\n| OAuth Consent Review | üîÑ Quarterly | Monthly | Increase frequency |\n| Privileged App Monitoring | ‚úÖ Enabled | Real-time | Configure playbooks |\n| Geo-restriction | üü° Partial | All critical apps | Expand coverage |"
            },
            "name": "ExecutiveRecommendations"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "executive"
      },
      "name": "ExecutiveGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## ÔøΩüìä App Identity Security Overview\n\nMonitoring Service Principals, Managed Identities, and OAuth Applications"
            },
            "name": "OverviewHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "datatable(Metric:string, Value:long, Category:string) []\n| union (\n    AADServicePrincipalSignInLogs\n    | where TimeGenerated {TimeRange}\n    | summarize Value = count()\n    | extend Metric = \"SP Sign-Ins\", Category = \"Service Principal\"\n)\n| union (\n    AADServicePrincipalSignInLogs\n    | where TimeGenerated {TimeRange}\n    | where ResultType != \"0\"\n    | summarize Value = count()\n    | extend Metric = \"SP Failed Sign-Ins\", Category = \"Service Principal\"\n)\n| union (\n    AADServicePrincipalSignInLogs\n    | where TimeGenerated {TimeRange}\n    | summarize Value = dcount(ServicePrincipalId)\n    | extend Metric = \"Active SPs\", Category = \"Service Principal\"\n)\n| union (\n    AADManagedIdentitySignInLogs\n    | where TimeGenerated {TimeRange}\n    | summarize Value = count()\n    | extend Metric = \"MI Sign-Ins\", Category = \"Managed Identity\"\n)\n| union (\n    AADManagedIdentitySignInLogs\n    | where TimeGenerated {TimeRange}\n    | where ResultType != \"0\"\n    | summarize Value = count()\n    | extend Metric = \"MI Failed Sign-Ins\", Category = \"Managed Identity\"\n)\n| union (\n    AADManagedIdentitySignInLogs\n    | where TimeGenerated {TimeRange}\n    | summarize Value = dcount(ServicePrincipalId)\n    | extend Metric = \"Active MIs\", Category = \"Managed Identity\"\n)\n| union (\n    AuditLogs\n    | where TimeGenerated {TimeRange}\n    | where OperationName has_any (\"Consent to application\", \"Add OAuth2PermissionGrant\")\n    | summarize Value = count()\n    | extend Metric = \"OAuth Consents\", Category = \"OAuth Apps\"\n)\n| union (\n    AuditLogs\n    | where TimeGenerated {TimeRange}\n    | where OperationName in (\"Add application\", \"Add service principal\")\n    | summarize Value = count()\n    | extend Metric = \"New App Registrations\", Category = \"OAuth Apps\"\n)\n| project Metric, Value, Category",
              "size": 4,
              "title": "App Identity Metrics Summary",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": {
                  "columnMatch": "Metric",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Value",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 0
                    }
                  }
                },
                "secondaryContent": {
                  "columnMatch": "Category",
                  "formatter": 1
                }
              }
            },
            "name": "OverviewMetrics"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union \n    (AADServicePrincipalSignInLogs | where TimeGenerated {TimeRange} | extend EventType = \"Service Principal\"),\n    (AADManagedIdentitySignInLogs | where TimeGenerated {TimeRange} | extend EventType = \"Managed Identity\")\n| summarize Count = count() by bin(TimeGenerated, 1h), EventType\n| render timechart",
              "size": 0,
              "title": "Service Principal & Managed Identity Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "name": "AppAuthTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| extend Status = case(ResultType == \"0\", \"Success\", \"Failed\")\n| summarize Count = count() by Status\n| order by Count desc",
              "size": 2,
              "title": "Service Principal Sign-In Status",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "SPSignInStatus"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AADManagedIdentitySignInLogs\n| where TimeGenerated {TimeRange}\n| extend Status = case(ResultType == \"0\", \"Success\", \"Failed\")\n| summarize Count = count() by Status\n| order by Count desc",
              "size": 2,
              "title": "Managed Identity Sign-In Status",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "MISignInStatus"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AuditLogs\n| where TimeGenerated {TimeRange}\n| where OperationName has_any (\"application\", \"service principal\", \"OAuth\", \"Consent\")\n| summarize Count = count() by OperationName\n| order by Count desc\n| take 10",
              "size": 2,
              "title": "Top App Operations",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "34",
            "name": "TopAppOperations"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| summarize \n    SignInCount = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    UniqueResources = dcount(ResourceDisplayName)\n    by ServicePrincipalName\n| extend FailureRate = round(todouble(FailedCount) / SignInCount * 100, 2)\n| order by SignInCount desc\n| take 10",
              "size": 0,
              "title": "Top 10 Active Service Principals",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "TopActiveSPs"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AADManagedIdentitySignInLogs\n| where TimeGenerated {TimeRange}\n| summarize \n    SignInCount = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    UniqueResources = dcount(ResourceDisplayName)\n    by ServicePrincipalName\n| extend FailureRate = round(todouble(FailedCount) / SignInCount * 100, 2)\n| order by SignInCount desc\n| take 10",
              "size": 0,
              "title": "Top 10 Active Managed Identities",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "TopActiveMIs"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType != \"0\"\n| summarize \n    FailedCount = count(),\n    ErrorCodes = make_set(ResultType, 5),\n    LastFailure = max(TimeGenerated)\n    by ServicePrincipalName, ServicePrincipalId\n| order by FailedCount desc\n| take 10",
              "size": 0,
              "title": "‚ö†Ô∏è Service Principals with Most Failures",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "SPFailures"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AuditLogs\n| where TimeGenerated {TimeRange}\n| where OperationName has_any (\"Consent to application\", \"Add OAuth2PermissionGrant\", \"Add app role assignment\")\n| extend AppName = tostring(TargetResources[0].displayName)\n| extend ConsentedBy = coalesce(tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\n| project TimeGenerated, OperationName, AppName, ConsentedBy\n| order by TimeGenerated desc\n| take 10",
              "size": 0,
              "title": "Recent OAuth Consent Activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "RecentOAuthConsents"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìà 7-Day Baseline Comparison\n---\nCompare current sign-in activity against the baseline from the last 7 days to detect anomalies and deviations."
            },
            "name": "BaselineHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Managed Identity - 7 Day Baseline Comparison\nlet CurrentWeek = AADManagedIdentitySignInLogs\n| where TimeGenerated >= ago(7d)\n| summarize \n    CurrentTotal = count(),\n    CurrentSuccess = countif(ResultType == \"0\"),\n    CurrentFailed = countif(ResultType != \"0\"),\n    CurrentUniqueMIs = dcount(ServicePrincipalId)\n    by bin(TimeGenerated, 1d);\nlet PreviousWeek = AADManagedIdentitySignInLogs\n| where TimeGenerated between (ago(14d) .. ago(7d))\n| summarize \n    BaselineTotal = count(),\n    BaselineSuccess = countif(ResultType == \"0\"),\n    BaselineFailed = countif(ResultType != \"0\"),\n    BaselineUniqueMIs = dcount(ServicePrincipalId);\nlet BaselineAvg = toscalar(PreviousWeek | project BaselineTotal) / 7;\nlet BaselineSuccessAvg = toscalar(PreviousWeek | project BaselineSuccess) / 7;\nlet BaselineFailedAvg = toscalar(PreviousWeek | project BaselineFailed) / 7;\nCurrentWeek\n| extend BaselineAvgDaily = BaselineAvg\n| extend BaselineSuccessDaily = BaselineSuccessAvg\n| extend BaselineFailedDaily = BaselineFailedAvg\n| extend TotalDeviation = round((todouble(CurrentTotal) - BaselineAvgDaily) / BaselineAvgDaily * 100, 2)\n| extend DeviationIndicator = case(\n    TotalDeviation > 50, \"üî¥ High Increase\",\n    TotalDeviation > 20, \"üü† Moderate Increase\",\n    TotalDeviation < -50, \"üîµ Significant Decrease\",\n    TotalDeviation < -20, \"üü° Moderate Decrease\",\n    \"üü¢ Normal\"\n)\n| project Day = format_datetime(TimeGenerated, 'yyyy-MM-dd'), CurrentTotal, BaselineAvgDaily = round(BaselineAvgDaily, 0), TotalDeviation, DeviationIndicator, CurrentSuccess, CurrentFailed, CurrentUniqueMIs\n| order by Day desc",
              "size": 0,
              "title": "ü§ñ Managed Identity - 7 Day Baseline Deviation",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "MIBaselineComparison"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principal - 7 Day Baseline Comparison\nlet CurrentWeek = AADServicePrincipalSignInLogs\n| where TimeGenerated >= ago(7d)\n| summarize \n    CurrentTotal = count(),\n    CurrentSuccess = countif(ResultType == \"0\"),\n    CurrentFailed = countif(ResultType != \"0\"),\n    CurrentUniqueSPs = dcount(ServicePrincipalId)\n    by bin(TimeGenerated, 1d);\nlet PreviousWeek = AADServicePrincipalSignInLogs\n| where TimeGenerated between (ago(14d) .. ago(7d))\n| summarize \n    BaselineTotal = count(),\n    BaselineSuccess = countif(ResultType == \"0\"),\n    BaselineFailed = countif(ResultType != \"0\"),\n    BaselineUniqueSPs = dcount(ServicePrincipalId);\nlet BaselineAvg = toscalar(PreviousWeek | project BaselineTotal) / 7;\nlet BaselineSuccessAvg = toscalar(PreviousWeek | project BaselineSuccess) / 7;\nlet BaselineFailedAvg = toscalar(PreviousWeek | project BaselineFailed) / 7;\nCurrentWeek\n| extend BaselineAvgDaily = BaselineAvg\n| extend BaselineSuccessDaily = BaselineSuccessAvg\n| extend BaselineFailedDaily = BaselineFailedAvg\n| extend TotalDeviation = round((todouble(CurrentTotal) - BaselineAvgDaily) / BaselineAvgDaily * 100, 2)\n| extend DeviationIndicator = case(\n    TotalDeviation > 50, \"üî¥ High Increase\",\n    TotalDeviation > 20, \"üü† Moderate Increase\",\n    TotalDeviation < -50, \"üîµ Significant Decrease\",\n    TotalDeviation < -20, \"üü° Moderate Decrease\",\n    \"üü¢ Normal\"\n)\n| project Day = format_datetime(TimeGenerated, 'yyyy-MM-dd'), CurrentTotal, BaselineAvgDaily = round(BaselineAvgDaily, 0), TotalDeviation, DeviationIndicator, CurrentSuccess, CurrentFailed, CurrentUniqueSPs\n| order by Day desc",
              "size": 0,
              "title": "‚öôÔ∏è Service Principal - 7 Day Baseline Deviation",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "SPBaselineComparison"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Managed Identity Baseline Trend Chart\nlet CurrentWeek = AADManagedIdentitySignInLogs\n| where TimeGenerated >= ago(7d)\n| summarize CurrentSignIns = count() by bin(TimeGenerated, 1d)\n| extend Period = \"Current Week\";\nlet PreviousWeek = AADManagedIdentitySignInLogs\n| where TimeGenerated between (ago(14d) .. ago(7d))\n| summarize BaselineSignIns = count() by bin(TimeGenerated, 1d)\n| extend AdjustedTime = datetime_add('day', 7, TimeGenerated)\n| project TimeGenerated = AdjustedTime, BaselineSignIns, Period = \"Baseline (Previous Week)\";\nCurrentWeek\n| project TimeGenerated, SignIns = CurrentSignIns, Period\n| union (PreviousWeek | project TimeGenerated, SignIns = BaselineSignIns, Period)\n| render timechart",
              "size": 0,
              "title": "ü§ñ Managed Identity - Current vs Baseline Trend",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "MIBaselineTrend"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principal Baseline Trend Chart\nlet CurrentWeek = AADServicePrincipalSignInLogs\n| where TimeGenerated >= ago(7d)\n| summarize CurrentSignIns = count() by bin(TimeGenerated, 1d)\n| extend Period = \"Current Week\";\nlet PreviousWeek = AADServicePrincipalSignInLogs\n| where TimeGenerated between (ago(14d) .. ago(7d))\n| summarize BaselineSignIns = count() by bin(TimeGenerated, 1d)\n| extend AdjustedTime = datetime_add('day', 7, TimeGenerated)\n| project TimeGenerated = AdjustedTime, BaselineSignIns, Period = \"Baseline (Previous Week)\";\nCurrentWeek\n| project TimeGenerated, SignIns = CurrentSignIns, Period\n| union (PreviousWeek | project TimeGenerated, SignIns = BaselineSignIns, Period)\n| render timechart",
              "size": 0,
              "title": "‚öôÔ∏è Service Principal - Current vs Baseline Trend",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "SPBaselineTrend"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "overview"
      },
      "name": "OverviewGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üîë OAuth Applications & App Governance\n---\nMonitor OAuth application consent, permissions, and potential malicious app activity."
            },
            "name": "OAuthHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// OAuth App Consent Activity\nAuditLogs\n| where TimeGenerated {TimeRange}\n| where OperationName has_any (\"Consent to application\", \"Add app role assignment\", \"Add OAuth2PermissionGrant\", \"Add application\", \"Add service principal\")\n| extend InitiatedBy = tostring(InitiatedBy.user.userPrincipalName)\n| extend TargetApp = tostring(TargetResources[0].displayName)\n| extend TargetAppId = tostring(TargetResources[0].id)\n| extend Permissions = tostring(TargetResources[0].modifiedProperties)\n| summarize \n    ConsentCount = count(),\n    LastConsent = max(TimeGenerated),\n    Users = make_set(InitiatedBy, 10)\n    by OperationName, TargetApp, TargetAppId\n| order by ConsentCount desc",
              "size": 0,
              "title": "OAuth App Consent Activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "OAuthConsentActivity"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// High-Risk OAuth Permissions Granted\nAuditLogs\n| where TimeGenerated {TimeRange}\n| where OperationName == \"Consent to application\"\n| extend ConsentType = tostring(TargetResources[0].modifiedProperties[0].newValue)\n| extend AppName = tostring(TargetResources[0].displayName)\n| extend AppId = tostring(TargetResources[0].id)\n| extend GrantedBy = tostring(InitiatedBy.user.userPrincipalName)\n| extend GrantedByIP = tostring(InitiatedBy.user.ipAddress)\n// High-risk permission patterns\n| where ConsentType has_any (\n    \"Mail.Read\", \"Mail.ReadWrite\", \"Mail.Send\",\n    \"Files.ReadWrite.All\", \"Directory.ReadWrite.All\",\n    \"User.ReadWrite.All\", \"Application.ReadWrite.All\",\n    \"full_access_as_app\", \"Exchange.ManageAsApp\"\n)\n| project TimeGenerated, AppName, AppId, GrantedBy, GrantedByIP, ConsentType, OperationName\n| order by TimeGenerated desc",
              "size": 0,
              "title": "‚ö†Ô∏è High-Risk OAuth Permissions Granted",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "HighRiskOAuthPermissions"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// OAuth Apps Accessing Data - CloudAppEvents\nCloudAppEvents\n| where TimeGenerated {TimeRange}\n| where ActionType has_any (\"MailItemsAccessed\", \"FileAccessed\", \"FileDownloaded\", \"FileSyncDownloadedFull\")\n| extend AppName = tostring(Application)\n| extend UserAgent = tostring(UserAgent)\n| extend IsOAuthApp = UserAgent !has \"Mozilla\" and UserAgent !has \"Edge\" and UserAgent !has \"Chrome\"\n| where IsOAuthApp == true or AppName !in (\"Microsoft Office\", \"SharePoint\", \"OneDrive\")\n| summarize \n    AccessCount = count(),\n    UniqueFiles = dcount(ObjectName),\n    Actions = make_set(ActionType, 5),\n    FirstAccess = min(TimeGenerated),\n    LastAccess = max(TimeGenerated)\n    by AppName, AccountDisplayName, AccountObjectId\n| where AccessCount > 10\n| order by AccessCount desc",
              "size": 0,
              "title": "OAuth App Data Access Patterns",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "OAuthDataAccess"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// App Governance - Overprivileged Apps Detection\nAuditLogs\n| where TimeGenerated {TimeRange}\n| where OperationName has_any (\"Add app role assignment\", \"Add OAuth2PermissionGrant\")\n| extend AppName = tostring(TargetResources[0].displayName)\n| extend AppId = tostring(TargetResources[0].id)\n| extend PermissionType = case(\n    OperationName == \"Add app role assignment\", \"Application Permission\",\n    OperationName == \"Add OAuth2PermissionGrant\", \"Delegated Permission\",\n    \"Other\"\n)\n| extend GrantedPermission = tostring(TargetResources[0].modifiedProperties[1].newValue)\n| summarize \n    PermissionCount = count(),\n    Permissions = make_set(GrantedPermission, 20),\n    PermissionTypes = make_set(PermissionType)\n    by AppName, AppId\n| extend RiskLevel = case(\n    PermissionCount > 20, \"Critical\",\n    PermissionCount > 10, \"High\",\n    PermissionCount > 5, \"Medium\",\n    \"Low\"\n)\n| order by PermissionCount desc",
              "size": 0,
              "title": "App Governance - Permission Analysis",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "AppGovernancePermissions"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Suspicious OAuth App Behavior Indicators\nlet SuspiciousApps = CloudAppEvents\n| where TimeGenerated {TimeRange}\n| where ActionType has_any (\"MailItemsAccessed\", \"Send\", \"SendAs\", \"SendOnBehalf\")\n| extend AppName = Application\n| summarize \n    MailActions = count(),\n    UniqueTargets = dcount(AccountObjectId),\n    MailboxesAccessed = make_set(AccountDisplayName, 10)\n    by AppName\n| where MailActions > 100 or UniqueTargets > 5;\nAuditLogs\n| where TimeGenerated {TimeRange}\n| where OperationName has \"application\"\n| extend AppName = tostring(TargetResources[0].displayName)\n| join kind=inner (SuspiciousApps) on AppName\n| project TimeGenerated, AppName, OperationName, MailActions, UniqueTargets, MailboxesAccessed\n| order by MailActions desc",
              "size": 0,
              "title": "üö® Suspicious OAuth App Behavior",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SuspiciousOAuthBehavior"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// New OAuth App Registrations\nAuditLogs\n| where TimeGenerated {TimeRange}\n| where OperationName in (\"Add application\", \"Add service principal\")\n| extend AppName = tostring(TargetResources[0].displayName)\n| extend AppId = tostring(TargetResources[0].id)\n| extend CreatedBy = tostring(InitiatedBy.user.userPrincipalName)\n| extend CreatedByIP = tostring(InitiatedBy.user.ipAddress)\n| extend AppType = tostring(TargetResources[0].type)\n| project TimeGenerated, OperationName, AppName, AppId, AppType, CreatedBy, CreatedByIP\n| order by TimeGenerated desc",
              "size": 0,
              "title": "New Application Registrations",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "NewAppRegistrations"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìã App Governance - Unused & Multi-Tenant Apps"
            },
            "name": "AppGovernanceHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Unused Service Principals - No Sign-Ins in Last 90 Days\nlet ActiveSPs = AADServicePrincipalSignInLogs\n| where TimeGenerated > ago(90d)\n| distinct ServicePrincipalId;\nlet AllSPs = AuditLogs\n| where TimeGenerated > ago(365d)\n| where OperationName in (\"Add service principal\", \"Update service principal\")\n| extend SPName = tostring(TargetResources[0].displayName)\n| extend SPId = tostring(TargetResources[0].id)\n| extend SPType = tostring(TargetResources[0].type)\n| extend CreatedBy = coalesce(tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\n| summarize \n    FirstSeen = min(TimeGenerated),\n    LastAuditEvent = max(TimeGenerated),\n    CreatedBy = take_any(CreatedBy)\n    by SPName, SPId, SPType\n| where isnotempty(SPName);\nAllSPs\n| join kind=leftanti (ActiveSPs) on $left.SPId == $right.ServicePrincipalId\n| extend DaysInactive = datetime_diff('day', now(), LastAuditEvent)\n| extend RiskLevel = case(\n    DaysInactive > 180, \"üî¥ High - Consider Removal\",\n    DaysInactive > 90, \"üü† Medium - Review Required\",\n    \"üü° Low - Monitor\"\n)\n| project SPName, SPId, SPType, CreatedBy, FirstSeen, LastAuditEvent, DaysInactive, RiskLevel\n| order by DaysInactive desc",
              "size": 0,
              "title": "‚ö†Ô∏è Unused Service Principals (No Activity in 90+ Days)",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "UnusedServicePrincipals"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principals with Zero Usage\nlet UsedSPs = AADServicePrincipalSignInLogs\n| where TimeGenerated > ago(365d)\n| summarize LastUsed = max(TimeGenerated), UsageCount = count() by ServicePrincipalId, ServicePrincipalName;\nlet RegisteredSPs = AuditLogs\n| where TimeGenerated > ago(365d)\n| where OperationName == \"Add service principal\"\n| extend SPName = tostring(TargetResources[0].displayName)\n| extend SPId = tostring(TargetResources[0].id)\n| extend CreatedBy = coalesce(tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\n| extend CreatedTime = TimeGenerated\n| summarize CreatedTime = min(CreatedTime), CreatedBy = take_any(CreatedBy) by SPName, SPId;\nRegisteredSPs\n| join kind=leftouter (UsedSPs) on $left.SPId == $right.ServicePrincipalId\n| extend UsageStatus = case(\n    isnull(UsageCount), \"üî¥ Never Used\",\n    UsageCount == 0, \"üî¥ Never Used\",\n    UsageCount < 10, \"üü† Rarely Used\",\n    \"üü¢ Active\"\n)\n| where UsageStatus in (\"üî¥ Never Used\", \"üü† Rarely Used\")\n| project SPName, SPId, CreatedBy, CreatedTime, UsageStatus, UsageCount = coalesce(UsageCount, 0), LastUsed\n| order by UsageCount asc, CreatedTime desc",
              "size": 0,
              "title": "üìä Service Principal Usage Status",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SPUsageStatus"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Multi-Tenant OAuth Applications\nAuditLogs\n| where TimeGenerated {TimeRange}\n| where OperationName has_any (\"Add application\", \"Update application\", \"Add service principal\")\n| extend AppName = tostring(TargetResources[0].displayName)\n| extend AppId = tostring(TargetResources[0].id)\n| extend ModifiedProps = parse_json(tostring(TargetResources[0].modifiedProperties))\n| mv-expand ModifiedProps\n| extend PropName = tostring(ModifiedProps.displayName)\n| extend PropNewValue = tostring(ModifiedProps.newValue)\n| extend PropOldValue = tostring(ModifiedProps.oldValue)\n| where PropName has_any (\"AvailableToOtherTenants\", \"SignInAudience\", \"AppAddress\")\n| extend IsMultiTenant = case(\n    PropNewValue has \"AzureADMultipleOrgs\", true,\n    PropNewValue has \"AzureADandPersonalMicrosoftAccount\", true,\n    PropNewValue =~ \"true\", true,\n    false\n)\n| where IsMultiTenant == true\n| extend AudienceType = case(\n    PropNewValue has \"AzureADMultipleOrgs\", \"üåê Multi-Tenant (Any Azure AD)\",\n    PropNewValue has \"AzureADandPersonalMicrosoftAccount\", \"üåç Multi-Tenant + Personal Accounts\",\n    \"üîì Multi-Tenant\"\n)\n| extend ModifiedBy = coalesce(tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\n| summarize \n    LastModified = max(TimeGenerated),\n    ModifiedBy = take_any(ModifiedBy),\n    AudienceType = take_any(AudienceType)\n    by AppName, AppId\n| project AppName, AppId, AudienceType, ModifiedBy, LastModified\n| order by LastModified desc",
              "size": 0,
              "title": "üåê Multi-Tenant OAuth Applications",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "MultiTenantApps"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Multi-Tenant Apps with External Sign-Ins\nlet MultiTenantApps = AuditLogs\n| where TimeGenerated > ago(90d)\n| where OperationName has_any (\"Add application\", \"Update application\")\n| extend ModifiedProps = parse_json(tostring(TargetResources[0].modifiedProperties))\n| mv-expand ModifiedProps\n| where tostring(ModifiedProps.displayName) has_any (\"AvailableToOtherTenants\", \"SignInAudience\")\n| where tostring(ModifiedProps.newValue) has_any (\"AzureADMultipleOrgs\", \"AzureADandPersonalMicrosoftAccount\", \"true\")\n| extend AppName = tostring(TargetResources[0].displayName)\n| distinct AppName;\nSigninLogs\n| where TimeGenerated {TimeRange}\n| where AppDisplayName in (MultiTenantApps)\n| where HomeTenantId != ResourceTenantId\n| summarize \n    ExternalSignIns = count(),\n    ExternalTenants = dcount(HomeTenantId),\n    TenantList = make_set(HomeTenantId, 10),\n    UniqueUsers = dcount(UserPrincipalName),\n    Countries = make_set(tostring(LocationDetails.countryOrRegion), 10),\n    SuccessRate = round(countif(ResultType == \"0\") * 100.0 / count(), 2)\n    by AppDisplayName\n| extend RiskIndicator = case(\n    ExternalTenants > 10, \"üî¥ High External Exposure\",\n    ExternalTenants > 5, \"üü† Moderate External Use\",\n    \"üü¢ Limited External Use\"\n)\n| order by ExternalSignIns desc",
              "size": 0,
              "title": "üö® Multi-Tenant Apps with External Tenant Sign-Ins",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "MultiTenantExternalSignIns"
          },
          {
            "type": 1,
            "content": {
              "json": "### üîê Graph API Permissions & Credential Management"
            },
            "name": "GraphAPIHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Apps with Microsoft Graph API Permissions\nAuditLogs\n| where TimeGenerated {TimeRange}\n| where OperationName has_any (\"Add app role assignment to service principal\", \"Add OAuth2PermissionGrant\", \"Consent to application\")\n| extend AppName = tostring(TargetResources[0].displayName)\n| extend AppId = tostring(TargetResources[0].id)\n| extend ModifiedProps = parse_json(tostring(TargetResources[0].modifiedProperties))\n| mv-expand ModifiedProps\n| extend PropName = tostring(ModifiedProps.displayName)\n| extend PropValue = tostring(ModifiedProps.newValue)\n| where PropValue has \"Microsoft Graph\" or PropValue has \"graph.microsoft.com\" or PropName has \"Permission\"\n| extend PermissionType = case(\n    OperationName has \"app role\", \"Application Permission\",\n    OperationName has \"OAuth2\", \"Delegated Permission\",\n    \"Consent\"\n)\n| extend GrantedBy = coalesce(tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\n| summarize \n    PermissionGrants = count(),\n    PermissionTypes = make_set(PermissionType),\n    Permissions = make_set(PropValue, 20),\n    GrantedBy = make_set(GrantedBy, 5),\n    LastGranted = max(TimeGenerated)\n    by AppName, AppId\n| extend RiskLevel = case(\n    Permissions has_any (\"Mail.ReadWrite\", \"Mail.Send\", \"Files.ReadWrite.All\", \"Directory.ReadWrite.All\", \"RoleManagement\"), \"üî¥ High-Risk Permissions\",\n    Permissions has_any (\"Mail.Read\", \"Files.Read.All\", \"User.Read.All\", \"Group.Read.All\"), \"üü† Sensitive Permissions\",\n    \"üü¢ Standard Permissions\"\n)\n| order by PermissionGrants desc",
              "size": 0,
              "title": "üìä Apps with Microsoft Graph API Permissions",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "GraphAPIPermissions"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Detailed Graph API Permissions by App\nAuditLogs\n| where TimeGenerated > ago(90d)\n| where OperationName has_any (\"Add app role assignment\", \"Add OAuth2PermissionGrant\", \"Consent to application\")\n| extend AppName = tostring(TargetResources[0].displayName)\n| extend ModifiedProps = parse_json(tostring(TargetResources[0].modifiedProperties))\n| mv-expand ModifiedProps\n| extend PropName = tostring(ModifiedProps.displayName)\n| extend PropValue = tostring(ModifiedProps.newValue)\n| where PropValue has_any (\"Graph\", \"graph.microsoft\", \"00000003-0000-0000\") or PropName has \"Scope\" or PropName has \"Permission\"\n| extend Permission = extract(@\"([A-Za-z]+\\.[A-Za-z\\.]+)\", 1, PropValue)\n| where isnotempty(Permission)\n| extend PermissionCategory = case(\n    Permission has \"Mail\", \"üìß Mail\",\n    Permission has \"Files\", \"üìÅ Files\",\n    Permission has \"User\", \"üë§ User\",\n    Permission has \"Group\", \"üë• Group\",\n    Permission has \"Directory\", \"üìÇ Directory\",\n    Permission has \"Calendar\", \"üìÖ Calendar\",\n    Permission has \"Sites\", \"üåê SharePoint\",\n    Permission has \"Team\", \"üí¨ Teams\",\n    Permission has \"Application\", \"‚öôÔ∏è Application\",\n    Permission has \"Role\", \"üîë Roles\",\n    \"üìã Other\"\n)\n| summarize Permissions = make_set(Permission, 50), Count = count() by AppName, PermissionCategory\n| order by AppName, Count desc",
              "size": 0,
              "title": "üîç Detailed Graph API Permissions by Category",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "GraphAPIPermissionsDetail"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Apps with Expiring or Recently Expired Credentials\nAuditLogs\n| where TimeGenerated > ago(365d)\n| where OperationName has_any (\"Add service principal credentials\", \"Update application ‚Äì Certificates and secrets management\", \"Update service principal\")\n| extend AppName = tostring(TargetResources[0].displayName)\n| extend AppId = tostring(TargetResources[0].id)\n| extend ModifiedProps = parse_json(tostring(TargetResources[0].modifiedProperties))\n| mv-expand ModifiedProps\n| extend PropName = tostring(ModifiedProps.displayName)\n| extend PropValue = tostring(ModifiedProps.newValue)\n| where PropName has_any (\"KeyCredentials\", \"PasswordCredentials\", \"Credential\")\n| extend CredentialAdded = TimeGenerated\n| extend ModifiedBy = coalesce(tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\n// Estimate expiration (typically 1-2 years from creation)\n| extend EstimatedExpiry1Year = datetime_add('year', 1, CredentialAdded)\n| extend EstimatedExpiry2Year = datetime_add('year', 2, CredentialAdded)\n| extend DaysUntilExpiry1Year = datetime_diff('day', EstimatedExpiry1Year, now())\n| extend ExpiryStatus = case(\n    DaysUntilExpiry1Year < 0, \"üî¥ Likely Expired (1yr creds)\",\n    DaysUntilExpiry1Year < 30, \"üü† Expiring Soon (<30 days)\",\n    DaysUntilExpiry1Year < 90, \"üü° Expiring (<90 days)\",\n    \"üü¢ Valid\"\n)\n| summarize \n    LastCredentialUpdate = max(CredentialAdded),\n    CredentialUpdates = count(),\n    ModifiedBy = make_set(ModifiedBy, 5),\n    ExpiryStatus = take_any(ExpiryStatus),\n    DaysUntilExpiry = min(DaysUntilExpiry1Year)\n    by AppName, AppId\n| where ExpiryStatus != \"üü¢ Valid\"\n| order by DaysUntilExpiry asc",
              "size": 0,
              "title": "‚ö†Ô∏è Apps with Expiring Application Credentials",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "ExpiringCredentials"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Recent Credential Changes - Security Audit\nAuditLogs\n| where TimeGenerated {TimeRange}\n| where OperationName has_any (\n    \"Add service principal credentials\",\n    \"Remove service principal credentials\", \n    \"Update application ‚Äì Certificates and secrets management\",\n    \"Update service principal\"\n)\n| extend AppName = tostring(TargetResources[0].displayName)\n| extend AppId = tostring(TargetResources[0].id)\n| extend ModifiedBy = coalesce(tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\n| extend ModifiedByIP = tostring(InitiatedBy.user.ipAddress)\n| extend CredentialAction = case(\n    OperationName has \"Add\", \"‚ûï Added\",\n    OperationName has \"Remove\", \"‚ûñ Removed\",\n    \"üîÑ Updated\"\n)\n| project TimeGenerated, AppName, AppId, OperationName, CredentialAction, ModifiedBy, ModifiedByIP, Result\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üîê Recent Credential Changes",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "RecentCredentialChanges"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "oauth"
      },
      "name": "OAuthGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## ‚öôÔ∏è Service Principal Monitoring\n---\nTrack Service Principal authentication, permission changes, and suspicious activity."
            },
            "name": "SPHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principal Sign-Ins\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| extend SPName = ServicePrincipalName\n| extend SPId = ServicePrincipalId\n| extend ResourceAccessed = ResourceDisplayName\n| extend SignInStatus = case(\n    ResultType == \"0\", \"Success\",\n    \"Failed\"\n)\n| summarize \n    SignInCount = count(),\n    SuccessCount = countif(SignInStatus == \"Success\"),\n    FailedCount = countif(SignInStatus == \"Failed\"),\n    UniqueResources = dcount(ResourceAccessed),\n    Resources = make_set(ResourceAccessed, 10),\n    UniqueIPs = dcount(IPAddress),\n    IPs = make_set(IPAddress, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by SPName, SPId\n| extend FailureRate = round(todouble(FailedCount) / SignInCount * 100, 2)\n| order by SignInCount desc",
              "size": 0,
              "title": "Service Principal Sign-In Activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SPSignIns"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principal Credential Changes\nAuditLogs\n| where TimeGenerated {TimeRange}\n| where OperationName has_any (\n    \"Add service principal credentials\",\n    \"Update service principal\",\n    \"Remove service principal credentials\",\n    \"Add service principal\",\n    \"Update application ‚Äì Certificates and secrets management\"\n)\n| extend SPName = tostring(TargetResources[0].displayName)\n| extend SPId = tostring(TargetResources[0].id)\n| extend ModifiedBy = tostring(InitiatedBy.user.userPrincipalName)\n| extend ModifiedByApp = tostring(InitiatedBy.app.displayName)\n| extend ModifiedByIP = tostring(InitiatedBy.user.ipAddress)\n| project TimeGenerated, OperationName, SPName, SPId, ModifiedBy, ModifiedByApp, ModifiedByIP, Result\n| order by TimeGenerated desc",
              "size": 0,
              "title": "‚ö†Ô∏è Service Principal Credential Changes",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SPCredentialChanges"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principal Accessing Sensitive Resources\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\" // Successful only\n| where ResourceDisplayName has_any (\n    \"Microsoft Graph\", \"Azure Key Vault\", \"Azure Storage\",\n    \"Office 365 Exchange Online\", \"Office 365 SharePoint Online\",\n    \"Windows Azure Active Directory\", \"Azure SQL Database\"\n)\n| summarize \n    AccessCount = count(),\n    UniqueIPs = dcount(IPAddress),\n    IPList = make_set(IPAddress, 5),\n    FirstAccess = min(TimeGenerated),\n    LastAccess = max(TimeGenerated)\n    by ServicePrincipalName, ServicePrincipalId, ResourceDisplayName\n| extend RiskIndicator = case(\n    UniqueIPs > 5, \"Multiple Source IPs\",\n    AccessCount > 1000, \"High Volume\",\n    \"Normal\"\n)\n| order by AccessCount desc",
              "size": 0,
              "title": "Service Principal Sensitive Resource Access",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SPSensitiveAccess"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principal Sign-In from New/Unusual IPs\nlet SPBaseline = AADServicePrincipalSignInLogs\n| where TimeGenerated between (ago(30d) .. ago(7d))\n| where ResultType == \"0\"\n| distinct ServicePrincipalId, IPAddress;\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\"\n| join kind=leftanti (SPBaseline) on ServicePrincipalId, IPAddress\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| project TimeGenerated, ServicePrincipalName, ServicePrincipalId, IPAddress, Country, City, ResourceDisplayName\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üö® Service Principal Sign-In from New IPs",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SPNewIPSignIn"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principal Activity Timeline\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| extend Status = case(ResultType == \"0\", \"Success\", \"Failed\")\n| summarize Count = count() by bin(TimeGenerated, 1h), Status\n| render timechart",
              "size": 0,
              "title": "Service Principal Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "name": "SPTimeline"
          },
          {
            "type": 1,
            "content": {
              "json": "### üë• Service Principals & User Relationships"
            },
            "name": "SPUserHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principals and the Users who use them\n// Correlate SP sign-ins with AuditLogs to find who manages/uses them\nlet SPActivity = AADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\"\n| summarize \n    SignInCount = count(),\n    UniqueResources = dcount(ResourceDisplayName),\n    Resources = make_set(ResourceDisplayName, 10),\n    UniqueIPs = dcount(IPAddress),\n    IPList = make_set(IPAddress, 5),\n    FirstUsed = min(TimeGenerated),\n    LastUsed = max(TimeGenerated)\n    by ServicePrincipalName, ServicePrincipalId;\nlet SPOwners = AuditLogs\n| where TimeGenerated > ago(90d)\n| where OperationName has_any (\"Add service principal\", \"Update service principal\", \"Add owner\")\n| extend SPName = tostring(TargetResources[0].displayName)\n| extend SPId = tostring(TargetResources[0].id)\n| extend UserIdentity = coalesce(tostring(InitiatedBy.user.userPrincipalName), \"System/App\")\n| where isnotempty(SPId)\n| summarize Users = make_set(UserIdentity, 20), UniqueUsers = dcount(UserIdentity) by SPId;\nSPActivity\n| join kind=leftouter (SPOwners) on $left.ServicePrincipalId == $right.SPId\n| project ServicePrincipalName, ServicePrincipalId, SignInCount, Users = coalesce(Users, dynamic([])), UniqueUsers = coalesce(UniqueUsers, 0), UniqueResources, Resources, UniqueIPs, FirstUsed, LastUsed\n| order by SignInCount desc",
              "size": 0,
              "title": "üë• Service Principals and Associated Users",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SPUserMapping"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Users who manage/interact with Service Principals\nAuditLogs\n| where TimeGenerated {TimeRange}\n| where OperationName has_any (\n    \"Add service principal\", \"Update service principal\", \n    \"Add owner to service principal\", \"Add service principal credentials\",\n    \"Remove service principal credentials\", \"Add app role assignment to service principal\"\n)\n| extend UserIdentity = coalesce(tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName))\n| extend SPName = tostring(TargetResources[0].displayName)\n| extend SPId = tostring(TargetResources[0].id)\n| where isnotempty(UserIdentity) and UserIdentity != \"\"\n| summarize \n    SPOperations = count(),\n    UniqueSPs = dcount(SPName),\n    ServicePrincipals = make_set(SPName, 20),\n    Operations = make_set(OperationName, 10),\n    UniqueIPs = dcount(tostring(InitiatedBy.user.ipAddress)),\n    LastActivity = max(TimeGenerated)\n    by UserIdentity\n| order by SPOperations desc\n| take 50",
              "size": 0,
              "title": "üë§ Users with Most Service Principal Usage",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "UserSPUsage"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principal Usage by App Owner\nAuditLogs\n| where TimeGenerated {TimeRange}\n| where OperationName in (\"Add service principal\", \"Update service principal\")\n| extend SPName = tostring(TargetResources[0].displayName)\n| extend SPId = tostring(TargetResources[0].id)\n| extend Owner = tostring(InitiatedBy.user.userPrincipalName)\n| where isnotempty(Owner)\n| summarize \n    Operations = count(),\n    LastModified = max(TimeGenerated)\n    by SPName, SPId, Owner\n| join kind=leftouter (\n    AADServicePrincipalSignInLogs\n    | where TimeGenerated {TimeRange}\n    | summarize UsageCount = count(), LastUsed = max(TimeGenerated) by ServicePrincipalId\n) on $left.SPId == $right.ServicePrincipalId\n| project SPName, Owner, Operations, UsageCount = coalesce(UsageCount, 0), LastModified, LastUsed\n| order by UsageCount desc",
              "size": 0,
              "title": "üìã Service Principal Owners and Usage",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SPOwners"
          },
          {
            "type": 1,
            "content": {
              "json": "### üîÑ Non-Interactive Sign-Ins Analysis"
            },
            "name": "SPNonInteractiveHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Non-Interactive Sign-Ins by Service Principal\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| extend SignInType = case(\n    isnotempty(ServicePrincipalCredentialKeyId), \"Certificate/Secret\",\n    isnotempty(FederatedCredentialId), \"Federated Identity\",\n    \"Other\"\n)\n| summarize \n    TotalSignIns = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    UniqueResources = dcount(ResourceDisplayName),\n    Resources = make_set(ResourceDisplayName, 10),\n    UniqueIPs = dcount(IPAddress),\n    SignInTypes = make_set(SignInType),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by ServicePrincipalName, ServicePrincipalId\n| extend FailureRate = round(todouble(FailedCount) / TotalSignIns * 100, 2)\n| extend HealthStatus = case(\n    FailureRate > 50, \"üî¥ Unhealthy\",\n    FailureRate > 20, \"üü† Degraded\",\n    \"üü¢ Healthy\"\n)\n| order by TotalSignIns desc",
              "size": 0,
              "title": "üîÑ Non-Interactive Sign-In Summary by Service Principal",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SPNonInteractiveSignIns"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Non-Interactive Sign-Ins by Authentication Method\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| extend AuthMethod = case(\n    isnotempty(ServicePrincipalCredentialKeyId) and isnotempty(ServicePrincipalCredentialThumbprint), \"Certificate\",\n    isnotempty(ServicePrincipalCredentialKeyId), \"Client Secret\",\n    isnotempty(FederatedCredentialId), \"Federated Identity (Workload Identity)\",\n    \"Other/Unknown\"\n)\n| summarize \n    Count = count(),\n    SuccessRate = round(countif(ResultType == \"0\") * 100.0 / count(), 2),\n    UniqueSPs = dcount(ServicePrincipalName)\n    by AuthMethod\n| order by Count desc",
              "size": 2,
              "title": "üîë Sign-Ins by Authentication Method",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "SPAuthMethodDist"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Non-Interactive Sign-Ins by Resource Accessed\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\"\n| summarize \n    AccessCount = count(),\n    UniqueSPs = dcount(ServicePrincipalName),\n    SPList = make_set(ServicePrincipalName, 10)\n    by ResourceDisplayName\n| order by AccessCount desc\n| take 15",
              "size": 2,
              "title": "üéØ Top Resources Accessed",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "SPResourceAccess"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// High Volume Non-Interactive Sign-Ins (Potential Automation)\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| summarize SignInCount = count() by ServicePrincipalName, ServicePrincipalId, bin(TimeGenerated, 1h)\n| summarize \n    TotalSignIns = sum(SignInCount),\n    MaxHourlySignIns = max(SignInCount),\n    AvgHourlySignIns = round(avg(SignInCount), 0),\n    ActiveHours = dcount(TimeGenerated)\n    by ServicePrincipalName, ServicePrincipalId\n| extend UsagePattern = case(\n    MaxHourlySignIns > 1000, \"üî¥ Very High Volume\",\n    MaxHourlySignIns > 100, \"üü† High Volume\",\n    AvgHourlySignIns > 10, \"üü° Moderate\",\n    \"üü¢ Low Volume\"\n)\n| order by TotalSignIns desc\n| take 20",
              "size": 0,
              "title": "üìä High Volume Non-Interactive Sign-Ins",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SPHighVolumeSignIns"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "serviceprincipal"
      },
      "name": "ServicePrincipalGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## ü§ñ Managed Identity Monitoring\n---\nMonitor Azure Managed Identity usage patterns and detect anomalous behavior."
            },
            "name": "MIHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Managed Identity Sign-Ins\nAADManagedIdentitySignInLogs\n| where TimeGenerated {TimeRange}\n| extend MIName = ServicePrincipalName\n| extend MIId = ServicePrincipalId\n| extend ResourceAccessed = ResourceDisplayName\n| extend SignInStatus = case(\n    ResultType == \"0\", \"Success\",\n    \"Failed\"\n)\n| summarize \n    SignInCount = count(),\n    SuccessCount = countif(SignInStatus == \"Success\"),\n    FailedCount = countif(SignInStatus == \"Failed\"),\n    UniqueResources = dcount(ResourceAccessed),\n    Resources = make_set(ResourceAccessed, 10),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by MIName, MIId\n| order by SignInCount desc",
              "size": 0,
              "title": "Managed Identity Sign-In Activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "MISignIns"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Managed Identity Resource Access Patterns\nAADManagedIdentitySignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\"\n| summarize \n    AccessCount = count(),\n    UniqueMIs = dcount(ServicePrincipalId),\n    ManagedIdentities = make_set(ServicePrincipalName, 10)\n    by ResourceDisplayName\n| order by AccessCount desc",
              "size": 2,
              "title": "Resources Accessed by Managed Identities",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "MIResourceAccess"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Managed Identity Resource Distribution\nAADManagedIdentitySignInLogs\n| where TimeGenerated {TimeRange}\n| summarize Count = count() by Category\n| order by Count desc",
              "size": 2,
              "title": "Managed Identity by Category",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "MITypeDistribution"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Managed Identity Failed Sign-Ins (Potential Misconfiguration/Attack)\nAADManagedIdentitySignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType != \"0\"\n| extend ErrorCode = ResultType\n| extend ErrorDescription = ResultDescription\n| summarize \n    FailureCount = count(),\n    ErrorCodes = make_set(ErrorCode, 5),\n    LastFailure = max(TimeGenerated)\n    by ServicePrincipalName, ServicePrincipalId, ResourceDisplayName\n| where FailureCount > 5\n| order by FailureCount desc",
              "size": 0,
              "title": "‚ö†Ô∏è Managed Identity Sign-In Failures",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "MIFailures"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Managed Identity Accessing Unusual Resources\nlet ResourceBaseline = AADManagedIdentitySignInLogs\n| where TimeGenerated between (ago(30d) .. ago(7d))\n| where ResultType == \"0\"\n| distinct ServicePrincipalId, ResourceDisplayName;\nAADManagedIdentitySignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\"\n| join kind=leftanti (ResourceBaseline) on ServicePrincipalId, ResourceDisplayName\n| project TimeGenerated, ServicePrincipalName, ServicePrincipalId, ResourceDisplayName, Category\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üö® Managed Identity Accessing New Resources",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "MINewResourceAccess"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Managed Identity Activity Timeline\nAADManagedIdentitySignInLogs\n| where TimeGenerated {TimeRange}\n| extend Status = case(ResultType == \"0\", \"Success\", \"Failed\")\n| summarize Count = count() by bin(TimeGenerated, 1h), Status\n| render timechart",
              "size": 0,
              "title": "Managed Identity Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "name": "MITimeline"
          },
          {
            "type": 1,
            "content": {
              "json": "### üîÑ Managed Identity Non-Interactive Sign-Ins"
            },
            "name": "MINonInteractiveHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Non-Interactive Sign-Ins by Managed Identity\nAADManagedIdentitySignInLogs\n| where TimeGenerated {TimeRange}\n| summarize \n    TotalSignIns = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    UniqueResources = dcount(ResourceDisplayName),\n    Resources = make_set(ResourceDisplayName, 10),\n    UniqueIPs = dcount(IPAddress),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by ServicePrincipalName, ServicePrincipalId\n| extend FailureRate = round(todouble(FailedCount) / TotalSignIns * 100, 2)\n| extend HealthStatus = case(\n    FailureRate > 50, \"üî¥ Unhealthy\",\n    FailureRate > 20, \"üü† Degraded\",\n    \"üü¢ Healthy\"\n)\n| order by TotalSignIns desc",
              "size": 0,
              "title": "üîÑ Non-Interactive Sign-In Summary by Managed Identity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "MINonInteractiveSignIns"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Managed Identity Sign-In Status Distribution\nAADManagedIdentitySignInLogs\n| where TimeGenerated {TimeRange}\n| extend SignInStatus = case(\n    ResultType == \"0\", \"Success\",\n    ResultType == \"50126\", \"Invalid Credentials\",\n    ResultType == \"50076\", \"MFA Required\",\n    \"Other Failure\"\n)\n| summarize Count = count() by SignInStatus\n| order by Count desc",
              "size": 2,
              "title": "ü§ñ Managed Identity Sign-In Status",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "MITypeDist"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Resources Accessed by Managed Identities\nAADManagedIdentitySignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\"\n| summarize \n    AccessCount = count(),\n    UniqueMIs = dcount(ServicePrincipalName),\n    MIList = make_set(ServicePrincipalName, 10)\n    by ResourceDisplayName\n| order by AccessCount desc\n| take 15",
              "size": 2,
              "title": "üéØ Top Resources Accessed by Managed Identities",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "MIResourceAccess"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// High Volume Managed Identity Activity\nAADManagedIdentitySignInLogs\n| where TimeGenerated {TimeRange}\n| summarize SignInCount = count() by ServicePrincipalName, bin(TimeGenerated, 1h)\n| summarize \n    TotalSignIns = sum(SignInCount),\n    MaxHourlySignIns = max(SignInCount),\n    AvgHourlySignIns = round(avg(SignInCount), 0),\n    ActiveHours = dcount(TimeGenerated)\n    by ServicePrincipalName\n| extend UsagePattern = case(\n    MaxHourlySignIns > 1000, \"üî¥ Very High Volume\",\n    MaxHourlySignIns > 100, \"üü† High Volume\",\n    AvgHourlySignIns > 10, \"üü° Moderate\",\n    \"üü¢ Low Volume\"\n)\n| order by TotalSignIns desc\n| take 20",
              "size": 0,
              "title": "üìä High Volume Managed Identity Activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "MIHighVolumeSignIns"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Managed Identity Cross-Resource Access Patterns\nAADManagedIdentitySignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\"\n| summarize \n    Resources = make_set(ResourceDisplayName, 20),\n    ResourceCount = dcount(ResourceDisplayName),\n    SignInCount = count(),\n    UniqueIPs = dcount(IPAddress)\n    by ServicePrincipalName, ServicePrincipalId\n| where ResourceCount > 1\n| extend AccessScope = case(\n    ResourceCount > 10, \"üî¥ Very Broad Access\",\n    ResourceCount > 5, \"üü† Broad Access\",\n    ResourceCount > 2, \"üü° Multiple Resources\",\n    \"üü¢ Single Resource\"\n)\n| order by ResourceCount desc",
              "size": 0,
              "title": "üîó Managed Identity Cross-Resource Access",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "MICrossResourceAccess"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "managedidentity"
      },
      "name": "ManagedIdentityGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üö® Threat Investigation - Service Principals & OAuth Apps\n---\nInvestigate suspicious Service Principal activity, malicious OAuth apps, geographic anomalies, and Conditional Access enforcement."
            },
            "name": "ThreatHeader"
          },
          {
            "type": 1,
            "content": {
              "json": "### üõ°Ô∏è Protecting Non-Human Identities from Threat Actors\n---\n**Common Attack Vectors Against Non-Human Identities:**\n\n| Attack Type | Target | Threat Actor Techniques | Detection Methods |\n|-------------|--------|------------------------|-------------------|\n| **Illicit Consent Grant** | OAuth Apps | Phishing users to consent to malicious apps with Mail.Read, Files.ReadWrite permissions | Monitor consent grants, high-risk permissions |\n| **Credential Theft** | Service Principals | Stealing client secrets/certificates from code repos, config files, or memory | Track credential rotation, new credential additions |\n| **Token Replay** | Managed Identities | Extracting tokens from compromised VMs/containers | Detect impossible travel, unusual resource access |\n| **Privilege Escalation** | All NHIs | Adding high-privilege roles (Global Admin, Exchange Admin) | Monitor role assignments, Graph API permissions |\n| **Persistence Mechanisms** | OAuth Apps/SPs | Creating backdoor apps or adding federation credentials | Track new app registrations, federation changes |\n\n**Hardening Recommendations:**\n\n‚úÖ **Service Principals:**\n- Use Workload Identity Federation instead of secrets where possible\n- Implement credential rotation (90-day maximum)\n- Apply Conditional Access policies for workload identities\n- Restrict to specific IP ranges/locations\n- Use managed identities over service principals when feasible\n\n‚úÖ **Managed Identities:**\n- Prefer User-Assigned over System-Assigned for cross-resource scenarios\n- Apply least-privilege RBAC roles\n- Monitor for unusual resource access patterns\n- Enable Defender for Cloud workload protection\n\n‚úÖ **OAuth Applications:**\n- Implement app consent policies (admin consent required for high-risk permissions)\n- Enable Microsoft Defender for Cloud Apps governance\n- Block unverified publisher apps\n- Regular app permission audits and unused app removal\n- Restrict multi-tenant app registrations\n\n‚úÖ **All Non-Human Identities:**\n- Enable Conditional Access for workload identities\n- Implement continuous access evaluation (CAE)\n- Monitor with Microsoft Entra ID Protection\n- Create alerting rules for credential changes, new permissions, and anomalous behavior"
            },
            "name": "NHIHardeningGuide"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Non-Human Identity Security Posture Summary\nunion\n(\n    AADServicePrincipalSignInLogs\n    | where TimeGenerated {TimeRange}\n    | summarize Value = count()\n    | extend Category = \"Service Principals\", Metric = \"Total Sign-Ins\", RiskLevel = \"Info\"\n),\n(\n    AADServicePrincipalSignInLogs\n    | where TimeGenerated {TimeRange}\n    | where ResultType != \"0\"\n    | summarize Value = count()\n    | extend Category = \"Service Principals\", Metric = \"Failed Sign-Ins\"\n    | extend RiskLevel = case(Value > 100, \"High\", Value > 10, \"Medium\", \"Low\")\n),\n(\n    AADManagedIdentitySignInLogs\n    | where TimeGenerated {TimeRange}\n    | summarize Value = count()\n    | extend Category = \"Managed Identities\", Metric = \"Total Sign-Ins\", RiskLevel = \"Info\"\n),\n(\n    AADManagedIdentitySignInLogs\n    | where TimeGenerated {TimeRange}\n    | where ResultType != \"0\"\n    | summarize Value = count()\n    | extend Category = \"Managed Identities\", Metric = \"Failed Sign-Ins\"\n    | extend RiskLevel = case(Value > 50, \"High\", Value > 10, \"Medium\", \"Low\")\n),\n(\n    AuditLogs\n    | where TimeGenerated {TimeRange}\n    | where OperationName has \"Consent\"\n    | where tostring(TargetResources[0].modifiedProperties) has_any (\"Mail.Read\", \"Mail.Send\", \"Files.ReadWrite.All\", \"full_access\")\n    | summarize Value = count()\n    | extend Category = \"OAuth Apps\", Metric = \"High-Risk Consent Grants\"\n    | extend RiskLevel = case(Value > 5, \"Critical\", Value > 0, \"High\", \"Low\")\n),\n(\n    AuditLogs\n    | where TimeGenerated {TimeRange}\n    | where OperationName has_any (\"Add service principal credentials\", \"Update application ‚Äì Certificates\")\n    | summarize Value = count()\n    | extend Category = \"Credentials\", Metric = \"Credential Changes\"\n    | extend RiskLevel = case(Value > 20, \"High\", Value > 5, \"Medium\", \"Low\")\n)\n| extend RiskIndicator = case(\n    RiskLevel == \"Critical\", \"üî¥\",\n    RiskLevel == \"High\", \"üü†\",\n    RiskLevel == \"Medium\", \"üü°\",\n    \"üü¢\"\n)\n| project Category, Metric, Value, RiskIndicator, RiskLevel\n| order by Category, Metric",
              "size": 0,
              "title": "üõ°Ô∏è Non-Human Identity Security Posture",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "NHISecurityPosture"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Threat Actor TTPs Detection - MITRE ATT&CK Mapping\nunion\n    // T1098.001 - Additional Cloud Credentials\n    (AuditLogs\n    | where TimeGenerated {TimeRange}\n    | where OperationName has_any (\"Add service principal credentials\", \"Update application ‚Äì Certificates\")\n    | extend TTP = \"T1098.001\", Technique = \"Additional Cloud Credentials\", Severity = \"High\"\n    | extend Details = tostring(TargetResources[0].displayName)),\n    // T1550.001 - Application Access Token\n    (AADServicePrincipalSignInLogs\n    | where TimeGenerated {TimeRange}\n    | where ResultType == \"0\"\n    | extend GeoInfo = geo_info_from_ip_address(IPAddress)\n    | extend Country = tostring(GeoInfo.country)\n    | where Country in (\"Russia\", \"China\", \"North Korea\", \"Iran\")\n    | extend TTP = \"T1550.001\", Technique = \"Token Abuse from Suspicious Location\", Severity = \"Critical\"\n    | extend OperationName = \"Service Principal Sign-In\", Details = ServicePrincipalName),\n    // T1098.003 - Additional Cloud Roles\n    (AuditLogs\n    | where TimeGenerated {TimeRange}\n    | where OperationName has_any (\"Add member to role\", \"Add app role assignment\")\n    | where tostring(TargetResources[0].modifiedProperties) has_any (\"Global Administrator\", \"Exchange Administrator\", \"Application Administrator\")\n    | extend TTP = \"T1098.003\", Technique = \"Additional Cloud Roles\", Severity = \"Critical\"\n    | extend Details = tostring(TargetResources[0].displayName)),\n    // T1136.003 - Cloud Account Creation\n    (AuditLogs\n    | where TimeGenerated {TimeRange}\n    | where OperationName in (\"Add application\", \"Add service principal\")\n    | extend TTP = \"T1136.003\", Technique = \"Cloud Account Creation\", Severity = \"Medium\"\n    | extend Details = tostring(TargetResources[0].displayName))\n| project TimeGenerated, TTP, Technique, Severity, OperationName, Details\n| order by TimeGenerated desc\n| take 50",
              "size": 0,
              "title": "üéØ MITRE ATT&CK TTPs - Non-Human Identity Threats",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "MITRETTPs"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principal Sign-Ins from Suspicious IPs\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n// Detect suspicious IP patterns - multiple countries, unusual locations\n| summarize \n    SignInCount = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    Countries = make_set(Country, 10),\n    Cities = make_set(City, 10),\n    UniqueIPs = dcount(IPAddress),\n    IPList = make_set(IPAddress, 10),\n    Resources = make_set(ResourceDisplayName, 5)\n    by ServicePrincipalName, ServicePrincipalId\n| extend CountryCount = array_length(Countries)\n| extend RiskIndicator = case(\n    CountryCount > 5, \"üî¥ High - Multiple Countries\",\n    UniqueIPs > 20, \"üü† Medium - Many IPs\",\n    FailedCount > SuccessCount, \"üü° Elevated Failures\",\n    \"üü¢ Normal\"\n)\n| where CountryCount > 1 or UniqueIPs > 5 or FailedCount > 10\n| order by CountryCount desc, UniqueIPs desc",
              "size": 0,
              "title": "‚ö†Ô∏è Service Principal Suspicious IP Activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "AnonymousSignIns"
          },
          {
            "type": 1,
            "content": {
              "json": "### üî¥ Malicious OAuth Application Detection"
            },
            "name": "MaliciousOAuthHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Detect Illicit Consent Grant Attack Patterns\nAuditLogs\n| where TimeGenerated {TimeRange}\n| where OperationName == \"Consent to application\"\n| extend ConsentUser = tostring(InitiatedBy.user.userPrincipalName)\n| extend ConsentIP = tostring(InitiatedBy.user.ipAddress)\n| extend AppName = tostring(TargetResources[0].displayName)\n| extend AppId = tostring(TargetResources[0].id)\n| extend Permissions = tostring(TargetResources[0].modifiedProperties)\n// Detect suspicious patterns\n| extend IsSuspicious = case(\n    // Consent from risky IP\n    ConsentIP has_any (\"tor\", \"vpn\"), true,\n    // High-risk permissions\n    Permissions has_any (\"Mail.Read\", \"Mail.Send\", \"Files.ReadWrite.All\", \"full_access\"), true,\n    // Unknown publisher apps\n    AppName has_any (\"test\", \"demo\", \"oauth\", \"token\"), true,\n    false\n)\n| where IsSuspicious == true\n| project TimeGenerated, ConsentUser, ConsentIP, AppName, AppId, Permissions, IsSuspicious\n| order by TimeGenerated desc",
              "size": 0,
              "title": "üö® Potential Illicit Consent Grant Attacks",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "IllicitConsentGrant"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// OAuth App with Suspicious Behavior Patterns\nlet SuspiciousMailAccess = CloudAppEvents\n| where TimeGenerated {TimeRange}\n| where ActionType has_any (\"MailItemsAccessed\", \"Send\", \"SendAs\")\n| where Application !in (\"Microsoft Outlook\", \"Microsoft Teams\")\n| summarize \n    MailAccessCount = count(),\n    UniqueMailboxes = dcount(AccountObjectId)\n    by Application\n| where MailAccessCount > 50 or UniqueMailboxes > 3;\nlet AppPermissions = AuditLogs\n| where TimeGenerated {TimeRange}\n| where OperationName has \"Consent\"\n| extend AppName = tostring(TargetResources[0].displayName)\n| extend HighRiskPerm = tostring(TargetResources[0].modifiedProperties) has_any (\"Mail.Read\", \"Mail.Send\", \"full_access\")\n| where HighRiskPerm == true\n| summarize HasHighRiskPerm = count() by AppName;\nSuspiciousMailAccess\n| join kind=leftouter (AppPermissions) on $left.Application == $right.AppName\n| extend ThreatLevel = case(\n    MailAccessCount > 100 and UniqueMailboxes > 5, \"Critical\",\n    MailAccessCount > 50, \"High\",\n    \"Medium\"\n)\n| project Application, MailAccessCount, UniqueMailboxes, HasHighRiskPerm, ThreatLevel\n| order by MailAccessCount desc",
              "size": 0,
              "title": "üö® OAuth Apps with Suspicious Mail Activity",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SuspiciousOAuthMail"
          },
          {
            "type": 1,
            "content": {
              "json": "### üî¥ Service Principal Impossible Travel Detection"
            },
            "name": "ImpossibleTravelHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principal Impossible Travel Detection\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\"\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| extend Latitude = todouble(GeoInfo.latitude)\n| extend Longitude = todouble(GeoInfo.longitude)\n| where isnotempty(Latitude) and isnotempty(Longitude)\n| order by ServicePrincipalId, TimeGenerated\n| serialize\n| extend PrevTime = prev(TimeGenerated, 1)\n| extend PrevLat = prev(Latitude, 1)\n| extend PrevLon = prev(Longitude, 1)\n| extend PrevCity = prev(City, 1)\n| extend PrevCountry = prev(Country, 1)\n| extend PrevSP = prev(ServicePrincipalId, 1)\n| where ServicePrincipalId == PrevSP\n| where isnotempty(PrevLat)\n| extend TimeDiffMinutes = datetime_diff('minute', TimeGenerated, PrevTime)\n| where TimeDiffMinutes > 0\n// Calculate distance using Haversine formula\n| extend Distance_km = 6371 * acos(cos(radians(Latitude)) * cos(radians(PrevLat)) * cos(radians(PrevLon) - radians(Longitude)) + sin(radians(Latitude)) * sin(radians(PrevLat)))\n| where isnan(Distance_km) == false\n// Speed > 800 km/h is suspicious\n| extend Speed_kmh = (Distance_km / TimeDiffMinutes) * 60\n| where Speed_kmh > 800 and Distance_km > 500\n| project TimeGenerated, ServicePrincipalName, ServicePrincipalId,\n          FromLocation = strcat(PrevCity, \", \", PrevCountry), \n          ToLocation = strcat(City, \", \", Country),\n          Distance_km = round(Distance_km, 0),\n          TimeDiffMinutes,\n          Speed_kmh = round(Speed_kmh, 0),\n          IPAddress, ResourceDisplayName\n| order by Speed_kmh desc",
              "size": 0,
              "title": "üö® Service Principal Impossible Travel",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "ImpossibleTravel"
          },
          {
            "type": 1,
            "content": {
              "json": "### üó∫Ô∏è Service Principal Geolocation Analysis"
            },
            "name": "SPGeoHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principal Usage Geolocation Map\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\"\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Latitude = todouble(GeoInfo.latitude)\n| extend Longitude = todouble(GeoInfo.longitude)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| where isnotempty(Latitude) and isnotempty(Longitude)\n| summarize \n    UsageCount = count(),\n    UniqueSPs = dcount(ServicePrincipalName),\n    ServicePrincipals = make_set(ServicePrincipalName, 10),\n    UniqueResources = dcount(ResourceDisplayName)\n    by Country, City, Latitude, Longitude\n| order by UsageCount desc",
              "size": 0,
              "title": "üó∫Ô∏è Service Principal Usage - Global Map",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "map",
              "mapSettings": {
                "locInfo": "LatLong",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "UsageCount",
                "sizeAggregation": "Sum",
                "labelSettings": "Country",
                "legendMetric": "UsageCount",
                "numberOfMetrics": 1,
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "UsageCount",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "name": "SPGeoMap"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principal Attacks - Failed Sign-Ins Map\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType != \"0\"\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Latitude = todouble(GeoInfo.latitude)\n| extend Longitude = todouble(GeoInfo.longitude)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| where isnotempty(Latitude) and isnotempty(Longitude)\n| summarize \n    AttackCount = count(),\n    TargetedSPs = dcount(ServicePrincipalName),\n    SPList = make_set(ServicePrincipalName, 10),\n    ErrorCodes = make_set(ResultType, 5)\n    by Country, City, Latitude, Longitude\n| extend ThreatLevel = case(\n    AttackCount > 1000, \"üî¥ Critical\",\n    AttackCount > 100, \"üü† High\",\n    AttackCount > 10, \"üü° Medium\",\n    \"üü¢ Low\"\n)\n| order by AttackCount desc",
              "size": 0,
              "title": "üö® Service Principal Attack Origins Map",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "map",
              "mapSettings": {
                "locInfo": "LatLong",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "AttackCount",
                "sizeAggregation": "Sum",
                "labelSettings": "Country",
                "legendMetric": "AttackCount",
                "numberOfMetrics": 1,
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "AttackCount",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "redDark"
                }
              }
            },
            "name": "SPAttackMap"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principal Activity by Country\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend Status = case(ResultType == \"0\", \"Success\", \"Failed\")\n| summarize \n    TotalEvents = count(),\n    SuccessCount = countif(Status == \"Success\"),\n    FailedCount = countif(Status == \"Failed\"),\n    UniqueSPs = dcount(ServicePrincipalName),\n    UniqueIPs = dcount(IPAddress)\n    by Country\n| extend FailureRate = round(todouble(FailedCount) / TotalEvents * 100, 2)\n| extend RiskIndicator = case(\n    FailureRate > 80, \"üî¥ High Attack Rate\",\n    FailedCount > 100, \"üü† Elevated Failures\",\n    \"üü¢ Normal\"\n)\n| order by TotalEvents desc",
              "size": 0,
              "title": "üåç Service Principal Activity by Country",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SPByCountry"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Suspicious Service Principal Activity from Unusual Countries\nlet BaselineCountries = AADServicePrincipalSignInLogs\n| where TimeGenerated between (ago(30d) .. ago(7d))\n| where ResultType == \"0\"\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| distinct ServicePrincipalId, Country;\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| join kind=leftanti (BaselineCountries) on ServicePrincipalId, Country\n| summarize \n    Events = count(),\n    SuccessCount = countif(ResultType == \"0\"),\n    FailedCount = countif(ResultType != \"0\"),\n    UniqueIPs = dcount(IPAddress),\n    Cities = make_set(City, 5),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by ServicePrincipalName, Country\n| extend Severity = case(\n    SuccessCount > 0, \"üî¥ Critical - Successful from New Country\",\n    FailedCount > 50, \"üü† High - Heavy Attack\",\n    \"üü° Medium - New Country Activity\"\n)\n| order by SuccessCount desc, Events desc",
              "size": 0,
              "title": "üö® Service Principal Activity from New Countries",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SPNewCountries"
          },
          {
            "type": 1,
            "content": {
              "json": "### üõ°Ô∏è Conditional Access Insights for Service Principals"
            },
            "name": "SPCAHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principal Sign-Ins Blocked by Conditional Access\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType != \"0\"\n| where ConditionalAccessStatus == \"failure\" or ResultType in (\"53000\", \"53001\", \"53002\", \"53003\")\n| extend CABlockReason = case(\n    ResultType == \"53000\", \"Device not compliant\",\n    ResultType == \"53001\", \"Device not registered\",\n    ResultType == \"53002\", \"Application used not approved\",\n    ResultType == \"53003\", \"Blocked by Conditional Access\",\n    \"CA Policy Block\"\n)\n| summarize \n    BlockedCount = count(),\n    BlockReasons = make_set(CABlockReason, 5),\n    UniqueIPs = dcount(IPAddress),\n    Resources = make_set(ResourceDisplayName, 10),\n    FirstBlocked = min(TimeGenerated),\n    LastBlocked = max(TimeGenerated)\n    by ServicePrincipalName, ServicePrincipalId\n| order by BlockedCount desc",
              "size": 0,
              "title": "üö´ Service Principals Blocked by Conditional Access",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SPCABlocked"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Conditional Access Policy Evaluation for Service Principals\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| extend CAPolicies = parse_json(ConditionalAccessPolicies)\n| mv-expand CAPolicy = CAPolicies\n| extend PolicyName = tostring(CAPolicy.displayName)\n| extend PolicyResult = tostring(CAPolicy.result)\n| where isnotempty(PolicyName)\n| summarize \n    Evaluations = count(),\n    Success = countif(PolicyResult == \"success\"),\n    Failure = countif(PolicyResult == \"failure\"),\n    NotApplied = countif(PolicyResult == \"notApplied\"),\n    UniqueSPs = dcount(ServicePrincipalName)\n    by PolicyName, PolicyResult\n| extend EffectivenessRate = round(todouble(Success + Failure) / Evaluations * 100, 2)\n| order by Evaluations desc",
              "size": 0,
              "title": "üìä CA Policy Evaluation Results for Service Principals",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SPCAPolicyEval"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principals with No CA Policies Applied\nlet SPWithCA = AADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| where ConditionalAccessStatus in (\"success\", \"failure\")\n| distinct ServicePrincipalId;\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| where ResultType == \"0\"\n| join kind=leftanti (SPWithCA) on ServicePrincipalId\n| summarize \n    SignInCount = count(),\n    UniqueResources = dcount(ResourceDisplayName),\n    Resources = make_set(ResourceDisplayName, 10),\n    UniqueIPs = dcount(IPAddress),\n    Countries = make_set(tostring(geo_info_from_ip_address(IPAddress).country), 5)\n    by ServicePrincipalName, ServicePrincipalId\n| extend RiskIndicator = case(\n    UniqueIPs > 10, \"üî¥ High - No CA + Multiple IPs\",\n    UniqueResources > 5, \"üü† Medium - No CA + Multiple Resources\",\n    \"üü° Review - No CA Applied\"\n)\n| order by SignInCount desc",
              "size": 0,
              "title": "‚ö†Ô∏è Service Principals with No Conditional Access Policies",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "SPNoCA"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// CA Blocks Timeline for Service Principals\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| where ConditionalAccessStatus == \"failure\" or ResultType in (\"53000\", \"53001\", \"53002\", \"53003\")\n| summarize BlockedCount = count() by bin(TimeGenerated, 1h)\n| render timechart",
              "size": 0,
              "title": "üìà CA Blocks Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "SPCABlocksTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// CA Status Distribution for Service Principals\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| extend CAStatus = case(\n    ConditionalAccessStatus == \"success\", \"‚úÖ CA Passed\",\n    ConditionalAccessStatus == \"failure\", \"‚ùå CA Blocked\",\n    ConditionalAccessStatus == \"notApplied\", \"‚ö™ Not Applied\",\n    \"‚ùì Unknown\"\n)\n| summarize Count = count() by CAStatus\n| order by Count desc",
              "size": 2,
              "title": "üìä CA Status Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "SPCAStatusDist"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "threats"
      },
      "name": "ThreatGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## ÔøΩÔ∏è Botnet Pattern Detection\n---\nDetect coordinated attack patterns across Service Principals and Managed Identities that may indicate botnet activity, credential stuffing, or orchestrated attacks.\n\n**Detection Patterns:**\n- üî¥ Multiple identities authenticating from same IP\n- üî¥ Synchronized authentication attempts (time clustering)\n- üî¥ Geographic impossibility (same identity, multiple locations)\n- üî¥ High-velocity authentication patterns\n- üü° Unusual resource access patterns"
            },
            "name": "BotnetHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// IP-based Botnet Detection - Multiple SPs from Same IP\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| where IPAddress != ''\n| summarize \n    UniqueSPs = dcount(ServicePrincipalId),\n    SPNames = make_set(ServicePrincipalName, 10),\n    TotalAttempts = count(),\n    FailedAttempts = countif(ResultType != '0'),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated),\n    TimeSpanMinutes = datetime_diff('minute', max(TimeGenerated), min(TimeGenerated))\n    by IPAddress\n| where UniqueSPs >= 3\n| extend AttackPattern = case(\n    UniqueSPs >= 10 and TotalAttempts > 100, 'üî¥ Critical - Botnet Command & Control',\n    UniqueSPs >= 5 and FailedAttempts > 20, 'üî¥ High - Credential Stuffing',\n    UniqueSPs >= 3 and TimeSpanMinutes < 60, 'üü° Medium - Coordinated Attack',\n    'üü° Suspicious - Multiple Apps Same IP'\n)\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| extend IsInternal = ipv4_is_private(IPAddress)\n| project IPAddress, Country, City, IsInternal, AttackPattern, UniqueSPs, TotalAttempts, FailedAttempts, TimeSpanMinutes, SPNames, FirstSeen, LastSeen\n| order by UniqueSPs desc, TotalAttempts desc\n| take 30",
              "size": 0,
              "title": "üî¥ Botnet Pattern: Multiple Service Principals from Same IP",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "BotnetIPDetection"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Time-Clustered Authentication (Synchronized Attacks)\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| summarize \n    EventsPerMinute = count(),\n    UniqueSPs = dcount(ServicePrincipalId),\n    UniqueIPs = dcount(IPAddress),\n    FailedCount = countif(ResultType != '0')\n    by TimeWindow = bin(TimeGenerated, 1m)\n| where EventsPerMinute > 50 or (UniqueSPs > 5 and UniqueIPs > 3)\n| extend BotnetIndicator = case(\n    EventsPerMinute > 200 and UniqueIPs > 10, 'üî¥ Critical - Distributed Attack',\n    EventsPerMinute > 100 and UniqueSPs > 10, 'üî¥ High - Synchronized Botnet',\n    EventsPerMinute > 50, 'üü° Medium - Burst Activity',\n    'üü° Elevated Activity'\n)\n| project TimeWindow, BotnetIndicator, EventsPerMinute, UniqueSPs, UniqueIPs, FailedCount\n| order by EventsPerMinute desc\n| take 50",
              "size": 0,
              "title": "‚è±Ô∏è Time-Clustered Authentication Spikes",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "TimeClustering"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Botnet Activity Timeline\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| summarize \n    TotalEvents = count(),\n    UniqueIPs = dcount(IPAddress),\n    UniqueSPs = dcount(ServicePrincipalId),\n    FailedEvents = countif(ResultType != '0')\n    by bin(TimeGenerated, 5m)\n| extend SuspicionScore = UniqueIPs * UniqueSPs / 10\n| where SuspicionScore > 5 or FailedEvents > 20\n| project TimeGenerated, TotalEvents, UniqueIPs, UniqueSPs, FailedEvents, SuspicionScore\n| render timechart",
              "size": 0,
              "title": "üìà Botnet Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "BotnetTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Geographic Impossibility - Same SP, Multiple Countries in Short Time\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| extend LocationData = parse_json(LocationDetails)\n| extend Country = tostring(LocationData.countryOrRegion)\n| where Country != ''\n| summarize \n    Countries = make_set(Country, 10),\n    CountryCount = dcount(Country),\n    IPs = make_set(IPAddress, 10),\n    IPCount = dcount(IPAddress),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated),\n    TotalEvents = count()\n    by ServicePrincipalName, ServicePrincipalId\n| extend TimeSpanMinutes = datetime_diff('minute', LastSeen, FirstSeen)\n| where CountryCount >= 2 and TimeSpanMinutes <= 60\n| extend ImpossibilityScore = CountryCount * 10 + IPCount\n| extend RiskLevel = case(\n    CountryCount >= 5, 'üî¥ Critical - Impossible Travel',\n    CountryCount >= 3 and TimeSpanMinutes <= 30, 'üî¥ High - Compromised Credentials',\n    CountryCount >= 2, 'üü° Medium - Multi-Region Activity',\n    'üü° Review'\n)\n| project ServicePrincipalName, RiskLevel, CountryCount, Countries, IPCount, TimeSpanMinutes, TotalEvents, FirstSeen, LastSeen\n| order by CountryCount desc, TimeSpanMinutes asc\n| take 20",
              "size": 0,
              "title": "üåç Geographic Impossibility Detection",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "GeoImpossibility"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Managed Identity Botnet Detection\nAADManagedIdentitySignInLogs\n| where TimeGenerated {TimeRange}\n| where IPAddress != ''\n| summarize \n    UniqueMIs = dcount(ServicePrincipalId),\n    MINames = make_set(ServicePrincipalName, 10),\n    TotalAttempts = count(),\n    FailedAttempts = countif(ResultType != '0'),\n    UniqueResources = dcount(ResourceDisplayName)\n    by IPAddress\n| where UniqueMIs >= 2 or FailedAttempts > 10\n| extend AttackPattern = case(\n    UniqueMIs >= 5, 'üî¥ Critical - Multiple MIs Compromised',\n    FailedAttempts > 50, 'üî¥ High - Brute Force on MIs',\n    UniqueMIs >= 2, 'üü° Medium - Unusual MI Activity',\n    'üü° Elevated Failures'\n)\n| extend IsInternal = ipv4_is_private(IPAddress)\n| project IPAddress, IsInternal, AttackPattern, UniqueMIs, TotalAttempts, FailedAttempts, UniqueResources, MINames\n| order by UniqueMIs desc, FailedAttempts desc\n| take 20",
              "size": 0,
              "title": "ü§ñ Managed Identity Botnet Detection",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "MIBotnetDetection"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// IP Reputation - Top Suspicious IPs\nlet SPActivity = AADServicePrincipalSignInLogs\n    | where TimeGenerated {TimeRange}\n    | summarize SPEvents = count(), SPFailed = countif(ResultType != '0'), UniqueSPs = dcount(ServicePrincipalId) by IPAddress;\nlet MIActivity = AADManagedIdentitySignInLogs\n    | where TimeGenerated {TimeRange}\n    | summarize MIEvents = count(), MIFailed = countif(ResultType != '0'), UniqueMIs = dcount(ServicePrincipalId) by IPAddress;\nSPActivity\n| join kind=fullouter (MIActivity) on IPAddress\n| extend IPAddress = coalesce(IPAddress, IPAddress1)\n| extend TotalEvents = coalesce(SPEvents, 0) + coalesce(MIEvents, 0)\n| extend TotalFailed = coalesce(SPFailed, 0) + coalesce(MIFailed, 0)\n| extend TotalIdentities = coalesce(UniqueSPs, 0) + coalesce(UniqueMIs, 0)\n| where TotalEvents > 10 or TotalFailed > 5 or TotalIdentities > 2\n| extend FailureRate = round(todouble(TotalFailed) / TotalEvents * 100, 1)\n| extend ThreatScore = (TotalFailed * 2) + (TotalIdentities * 5)\n| extend ThreatLevel = case(\n    ThreatScore > 50, 'üî¥ Critical',\n    ThreatScore > 20, 'üü° High',\n    ThreatScore > 10, 'üü¢ Medium',\n    'üü¢ Low'\n)\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend IsInternal = ipv4_is_private(IPAddress)\n| project IPAddress, IsInternal, Country, ThreatLevel, ThreatScore, TotalEvents, TotalFailed, FailureRate, TotalIdentities\n| order by ThreatScore desc\n| take 30",
              "size": 0,
              "title": "üìä IP Threat Scoring",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "customWidth": "50",
            "name": "IPThreatScore"
          },
          {
            "type": 1,
            "content": {
              "json": "### üï∏Ô∏è Botnet Indicators Reference\n\n| Pattern | Indicator | Threshold | Response |\n|---------|-----------|-----------|----------|\n| **C2 Communication** | Multiple SPs from single IP | ‚â•5 unique SPs | Block IP, investigate SPs |\n| **Credential Stuffing** | High failure rate + multiple IPs | >50% failure, >10 IPs | Enable smart lockout |\n| **Synchronized Attack** | Time-clustered events | >100 events/minute | Rate limiting |\n| **Impossible Travel** | Multi-geo in short time | >2 countries in 1 hour | Revoke tokens |\n| **Lateral Movement** | Sequential resource access | Unusual access pattern | Audit permissions |\n\n**üîó Threat Intelligence Sources:**\n- Microsoft Threat Intelligence\n- Azure AD Identity Protection\n- IP reputation databases"
            },
            "name": "BotnetReference"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "botnet"
      },
      "name": "BotnetGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üõ†Ô∏è Remediation Actions\n---\nExecute remediation playbooks directly from this workbook. Select an entity from the tables below and trigger the appropriate response action.\n\n---\n\n### üì¶ Deployment Instructions\n\n**Playbook ARM Templates Location:**\n```\nc:\\Users\\dalonso\\Downloads\\Sentinel-Remediation-Playbooks\\\n```\n\n**Files Available:**\n| File | Purpose |\n|------|----------|\n| `README.md` | Full deployment guide and permissions |\n| `Deploy-All-Playbooks.json` | API connections template |\n| `Disable-AADUser.json` | Disable user account |\n| `Reset-AADUserPassword.json` | Force password reset |\n| `Revoke-AADUserSessions.json` | Revoke all sessions |\n| `Block-AADSignIn.json` | Block user sign-in |\n| `Confirm-AADUserCompromised.json` | Mark user compromised |\n| `Full-UserRemediation.json` | All user actions combined |\n| `Isolate-MDEDevice.json` | Network isolate device |\n| `Run-MDE-AVScan.json` | Trigger AV scan |\n| `Collect-MDE-Investigation.json` | Collect forensic package |\n| `Restrict-MDEAppExecution.json` | Restrict app execution |\n| `Add-ThreatIndicator.json` | Add IP to threat intel |\n| `Add-BlockedLocation.json` | Block IP in Conditional Access |\n\n**Quick Deploy (PowerShell):**\n```powershell\n$RG = 'rg-sentinel-playbooks'\nNew-AzResourceGroup -Name $RG -Location 'eastus'\nGet-ChildItem '.\\*.json' | ForEach-Object {\n  New-AzResourceGroupDeployment -ResourceGroupName $RG -TemplateFile $_.FullName\n}\n```\n\n**Post-Deployment:**\n1. Authorize API connections in Azure Portal\n2. Assign Managed Identity permissions (see README.md)\n3. Update the Logic App Base URL parameter below\n\n---\n\n‚ö†Ô∏è **Prerequisites:**\n- Logic Apps with HTTP triggers deployed\n- Appropriate RBAC permissions (Security Operator, User Administrator)\n- Logic App Managed Identity with Graph API permissions\n\n---"
            },
            "name": "RemediationHeader"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "remediation-subscription",
                  "version": "KqlParameterItem/1.0",
                  "name": "RemediationSubscription",
                  "type": 6,
                  "isRequired": true,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "includeAll": false,
                    "showDefault": false
                  },
                  "label": "Subscription"
                },
                {
                  "id": "remediation-resourcegroup",
                  "version": "KqlParameterItem/1.0",
                  "name": "PlaybookResourceGroup",
                  "type": 1,
                  "isRequired": true,
                  "value": "rg-sentinel-playbooks",
                  "label": "Playbook Resource Group"
                }
              ],
              "style": "pills",
              "queryType": 0
            },
            "name": "PlaybookParams"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// High-Risk Users for Remediation - Click row to select\nSigninLogs\n| where TimeGenerated {TimeRange}\n| summarize \n    TotalAttempts = count(),\n    FailedSignIns = countif(ResultType != '0'),\n    LastEvent = max(TimeGenerated),\n    Locations = make_set(tostring(parse_json(LocationDetails).countryOrRegion), 5),\n    IPs = make_set(IPAddress, 5)\n    by UserPrincipalName, UserId\n| where FailedSignIns > 10\n| extend FailureRate = round(todouble(FailedSignIns) / TotalAttempts * 100, 1)\n| extend RiskLevel = case(\n    FailureRate > 80.0 and FailedSignIns > 50, 'üî¥ Critical',\n    FailedSignIns > 100, 'üî¥ High',\n    FailedSignIns > 50, 'üü° Medium',\n    'üü° Low'\n)\n| project UserPrincipalName, UserId, RiskLevel, FailedSignIns, FailureRate, TotalAttempts, LastEvent, Locations, IPs\n| order by FailedSignIns desc\n| take 30",
              "size": 0,
              "title": "üë§ High-Risk Users - Click row to select for remediation",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 30,
                "filter": true
              },
              "exportFieldName": "UserId",
              "exportParameterName": "SelectedUserId",
              "exportDefaultValue": ""
            },
            "name": "HighRiskUsers"
          },
          {
            "type": 1,
            "content": {
              "json": "#### Selected User: **{SelectedUserDisplay}**\n\n> Click the action buttons below to execute remediation playbooks directly."
            },
            "conditionalVisibility": {
              "parameterName": "SelectedUserId",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "SelectedUserText"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "action-disable-user",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üö´ Disable User Account",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Disable-AADUser/triggers/manual/run",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2016-10-01"
                      }
                    ],
                    "body": "{\"userId\": \"{SelectedUserId}\", \"userPrincipalName\": \"{SelectedUserDisplay}\", \"action\": \"disable\", \"reason\": \"Disabled via Identity Security Workbook - Compromised Account\"}",
                    "httpMethod": "POST",
                    "title": "Disable User Account",
                    "description": "## ‚ö†Ô∏è Confirm User Disable\n\nYou are about to **disable** the following user account:\n\n**User:** {SelectedUserDisplay}\n\nThis will:\n- Prevent the user from signing in\n- Block all active sessions\n- Require admin intervention to re-enable\n\nAre you sure you want to proceed?",
                    "actionName": "Disable-AADUser",
                    "runLabel": "Disable User"
                  }
                },
                {
                  "id": "action-reset-password",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üîë Force Password Reset",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Reset-AADUserPassword/triggers/manual/run",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2016-10-01"
                      }
                    ],
                    "body": "{\"userId\": \"{SelectedUserId}\", \"userPrincipalName\": \"{SelectedUserDisplay}\", \"forceChangeOnNextLogin\": true, \"reason\": \"Password reset via Identity Security Workbook\"}",
                    "httpMethod": "POST",
                    "title": "Force Password Reset",
                    "description": "## üîë Confirm Password Reset\n\nYou are about to **force a password reset** for:\n\n**User:** {SelectedUserDisplay}\n\nThis will:\n- Generate a temporary password\n- Force the user to change password on next login\n- Invalidate current password\n\nAre you sure you want to proceed?",
                    "actionName": "Reset-AADUserPassword",
                    "runLabel": "Reset Password"
                  }
                },
                {
                  "id": "action-revoke-sessions",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üîì Revoke All Sessions",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Revoke-AADUserSessions/triggers/manual/run",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2016-10-01"
                      }
                    ],
                    "body": "{\"userId\": \"{SelectedUserId}\", \"userPrincipalName\": \"{SelectedUserDisplay}\", \"revokeRefreshTokens\": true, \"reason\": \"Sessions revoked via Identity Security Workbook\"}",
                    "httpMethod": "POST",
                    "title": "Revoke User Sessions",
                    "description": "## üîì Confirm Session Revocation\n\nYou are about to **revoke all sessions and tokens** for:\n\n**User:** {SelectedUserDisplay}\n\nThis will:\n- Invalidate all refresh tokens\n- Force re-authentication on all devices\n- Log out user from all active sessions\n\nAre you sure you want to proceed?",
                    "actionName": "Revoke-AADUserSessions",
                    "runLabel": "Revoke Sessions"
                  }
                },
                {
                  "id": "action-block-signin",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üìß Block Sign-In",
                  "style": "secondary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Block-AADSignIn/triggers/manual/run",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2016-10-01"
                      }
                    ],
                    "body": "{\"userId\": \"{SelectedUserId}\", \"userPrincipalName\": \"{SelectedUserDisplay}\", \"blockSignIn\": true, \"reason\": \"Sign-in blocked via Identity Security Workbook\"}",
                    "httpMethod": "POST",
                    "title": "Block User Sign-In",
                    "description": "## üìß Confirm Sign-In Block\n\nYou are about to **block sign-in** for:\n\n**User:** {SelectedUserDisplay}\n\nThis will:\n- Prevent any new sign-in attempts\n- Existing sessions may remain active until token expiry\n\nAre you sure you want to proceed?",
                    "actionName": "Block-AADSignIn",
                    "runLabel": "Block Sign-In"
                  }
                },
                {
                  "id": "action-confirm-compromise",
                  "linkTarget": "ArmAction",
                  "linkLabel": "‚ö†Ô∏è Confirm User Compromised",
                  "style": "secondary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Confirm-AADUserCompromised/triggers/manual/run",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2016-10-01"
                      }
                    ],
                    "body": "{\"userId\": \"{SelectedUserId}\", \"userPrincipalName\": \"{SelectedUserDisplay}\", \"riskState\": \"confirmedCompromised\", \"reason\": \"Confirmed compromised via Identity Security Workbook investigation\"}",
                    "httpMethod": "POST",
                    "title": "Confirm User Compromised",
                    "description": "## ‚ö†Ô∏è Confirm User Compromised\n\nYou are about to **confirm the user as compromised** in Identity Protection:\n\n**User:** {SelectedUserDisplay}\n\nThis will:\n- Mark user risk as 'Confirmed Compromised'\n- Trigger any configured risk-based policies\n- Add to risky users list\n\nAre you sure you want to proceed?",
                    "actionName": "Confirm-AADUserCompromised",
                    "runLabel": "Confirm Compromised"
                  }
                },
                {
                  "id": "action-full-remediation",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üõ°Ô∏è FULL REMEDIATION (All Actions)",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Full-UserRemediation/triggers/manual/run",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2016-10-01"
                      }
                    ],
                    "body": "{\"userId\": \"{SelectedUserId}\", \"userPrincipalName\": \"{SelectedUserDisplay}\", \"actions\": [\"disable\", \"resetPassword\", \"revokeSessions\", \"confirmCompromised\"], \"reason\": \"Full remediation via Identity Security Workbook\"}",
                    "httpMethod": "POST",
                    "title": "Full User Remediation",
                    "description": "## üõ°Ô∏è FULL REMEDIATION\n\nYou are about to perform **FULL REMEDIATION** on:\n\n**User:** {SelectedUserDisplay}\n\nThis will execute ALL of the following:\n- ‚úÖ Disable user account\n- ‚úÖ Force password reset\n- ‚úÖ Revoke all sessions and tokens\n- ‚úÖ Confirm user as compromised\n\n‚ö†Ô∏è **This is a critical action.** Are you sure you want to proceed?",
                    "actionName": "Full-UserRemediation",
                    "runLabel": "Execute Full Remediation"
                  }
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "SelectedUserId",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "UserActionLinks"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// High-Risk Service Principals - Click row to select\nAADServicePrincipalSignInLogs\n| where TimeGenerated {TimeRange}\n| summarize \n    TotalAttempts = count(),\n    FailedAttempts = countif(ResultType != '0'),\n    UniqueIPs = dcount(IPAddress),\n    IPs = make_set(IPAddress, 5),\n    LastEvent = max(TimeGenerated),\n    Resources = make_set(ResourceDisplayName, 5)\n    by ServicePrincipalName, ServicePrincipalId, AppId\n| where FailedAttempts > 10\n| extend FailureRate = round(todouble(FailedAttempts) / TotalAttempts * 100, 1)\n| extend RiskLevel = case(\n    FailureRate > 80.0 and FailedAttempts > 50, 'üî¥ Critical',\n    FailedAttempts > 100, 'üî¥ High',\n    FailedAttempts > 50, 'üü° Medium',\n    'üü° Low'\n)\n| project ServicePrincipalName, ServicePrincipalId, AppId, RiskLevel, FailedAttempts, FailureRate, UniqueIPs, IPs, LastEvent, Resources\n| order by FailedAttempts desc\n| take 30",
              "size": 0,
              "title": "‚öôÔ∏è High-Risk Service Principals - Click row to select for remediation",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 30,
                "filter": true
              },
              "exportFieldName": "AppId",
              "exportParameterName": "SelectedAppId",
              "exportDefaultValue": ""
            },
            "name": "HighRiskSPs"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "selectedSPDisplay",
                  "version": "KqlParameterItem/1.0",
                  "name": "SelectedSPDisplay",
                  "type": 1,
                  "query": "AADServicePrincipalSignInLogs\n| where AppId == '{SelectedAppId}'\n| take 1\n| project ServicePrincipalName",
                  "isHiddenWhenLocked": false,
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                },
                {
                  "id": "selectedSPId",
                  "version": "KqlParameterItem/1.0",
                  "name": "SelectedSPId",
                  "type": 1,
                  "query": "AADServicePrincipalSignInLogs\n| where AppId == '{SelectedAppId}'\n| take 1\n| project ServicePrincipalId",
                  "isHiddenWhenLocked": false,
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces"
                }
              ],
              "style": "above",
              "queryType": 0
            },
            "conditionalVisibility": {
              "parameterName": "SelectedAppId",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "SelectedSPParams"
          },
          {
            "type": 1,
            "content": {
              "json": "#### Selected Service Principal: **{SelectedSPDisplay}**\n\n> Click the action buttons below to execute remediation playbooks directly."
            },
            "conditionalVisibility": {
              "parameterName": "SelectedAppId",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "SelectedSPText"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "action-disable-sp",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üö´ Disable Service Principal",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Disable-ServicePrincipal/triggers/manual/run",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2016-10-01"
                      }
                    ],
                    "body": "{\"servicePrincipalId\": \"{SelectedSPId}\", \"appId\": \"{SelectedAppId}\", \"displayName\": \"{SelectedSPDisplay}\", \"action\": \"disable\", \"reason\": \"Disabled via Identity Security Workbook - Compromised App\"}",
                    "httpMethod": "POST",
                    "title": "Disable Service Principal",
                    "description": "## ‚ö†Ô∏è Confirm Service Principal Disable\n\nYou are about to **disable** the following Service Principal:\n\n**App:** {SelectedSPDisplay}\n**App ID:** {SelectedAppId}\n\nThis will:\n- Prevent the app from authenticating\n- Block all API access\n- Require admin intervention to re-enable\n\nAre you sure you want to proceed?",
                    "actionName": "Disable-ServicePrincipal",
                    "runLabel": "Disable App"
                  }
                },
                {
                  "id": "action-rotate-sp-creds",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üîë Rotate Credentials",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Rotate-SPCredentials/triggers/manual/run",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2016-10-01"
                      }
                    ],
                    "body": "{\"servicePrincipalId\": \"{SelectedSPId}\", \"appId\": \"{SelectedAppId}\", \"displayName\": \"{SelectedSPDisplay}\", \"removeOldCredentials\": true, \"reason\": \"Credential rotation via Identity Security Workbook\"}",
                    "httpMethod": "POST",
                    "title": "Rotate Service Principal Credentials",
                    "description": "## üîë Confirm Credential Rotation\n\nYou are about to **rotate credentials** for:\n\n**App:** {SelectedSPDisplay}\n**App ID:** {SelectedAppId}\n\nThis will:\n- Generate new client secret\n- Remove old credentials\n- Require updating all clients using this app\n\nAre you sure you want to proceed?",
                    "actionName": "Rotate-SPCredentials",
                    "runLabel": "Rotate Credentials"
                  }
                },
                {
                  "id": "action-revoke-sp-permissions",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üîê Revoke All Permissions",
                  "style": "secondary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Revoke-SPPermissions/triggers/manual/run",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2016-10-01"
                      }
                    ],
                    "body": "{\"servicePrincipalId\": \"{SelectedSPId}\", \"appId\": \"{SelectedAppId}\", \"displayName\": \"{SelectedSPDisplay}\", \"revokeAllConsents\": true, \"reason\": \"Permissions revoked via Identity Security Workbook\"}",
                    "httpMethod": "POST",
                    "title": "Revoke Service Principal Permissions",
                    "description": "## üîê Confirm Permission Revocation\n\nYou are about to **revoke all permissions** for:\n\n**App:** {SelectedSPDisplay}\n**App ID:** {SelectedAppId}\n\nThis will:\n- Remove all delegated permissions\n- Remove all application permissions\n- Require re-consent for any API access\n\nAre you sure you want to proceed?",
                    "actionName": "Revoke-SPPermissions",
                    "runLabel": "Revoke Permissions"
                  }
                },
                {
                  "id": "openAppRegistration",
                  "cellValue": "https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/ApplicationMenuBlade/~/Overview/appId/{SelectedAppId}",
                  "linkTarget": "Url",
                  "linkLabel": "üìã Open in Portal",
                  "style": "secondary"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "SelectedAppId",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "SPActionLinks"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üåê IP Address Remediation"
            },
            "name": "text - ip remediation header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// High-Risk IPs - Click row to select\nunion\n    (AADServicePrincipalSignInLogs | where TimeGenerated {TimeRange} | extend Country = tostring(parse_json(LocationDetails).countryOrRegion)),\n    (AADManagedIdentitySignInLogs | where TimeGenerated {TimeRange} | extend Country = ''),\n    (SigninLogs | where TimeGenerated {TimeRange} | extend Country = tostring(LocationDetails.countryOrRegion))\n| where IPAddress != ''\n| summarize \n    TotalAttempts = count(),\n    FailedAttempts = countif(ResultType != '0'),\n    SuccessfulAttempts = countif(ResultType == '0'),\n    UniqueTargets = dcount(coalesce(ServicePrincipalId, UserId)),\n    Countries = make_set_if(Country, Country != '', 3),\n    LastSeen = max(TimeGenerated)\n    by IPAddress\n| where FailedAttempts > 20 or (SuccessfulAttempts > 0 and FailedAttempts > 10)\n| extend ThreatScore = (FailedAttempts / 10) + (UniqueTargets * 5) + iif(SuccessfulAttempts > 0 and FailedAttempts > 10, 50, 0)\n| extend ThreatLevel = case(\n    SuccessfulAttempts > 0 and FailedAttempts > 10, 'üî¥ CRITICAL',\n    UniqueTargets > 10, 'üî¥ HIGH - Spray',\n    FailedAttempts > 100, 'üü† HIGH - Brute Force',\n    'üü° MEDIUM'\n)\n| project ThreatLevel, IPAddress, ThreatScore, FailedAttempts, SuccessfulAttempts, UniqueTargets, Countries, LastSeen\n| order by ThreatScore desc\n| take 20",
              "size": 0,
              "title": "üåê High-Risk IPs - Click row to select for remediation",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 20,
                "filter": true
              },
              "exportFieldName": "IPAddress",
              "exportParameterName": "SelectedRemediationIP",
              "exportDefaultValue": ""
            },
            "name": "HighRiskIPs"
          },
          {
            "type": 1,
            "content": {
              "json": "#### Selected IP: **{SelectedRemediationIP}**\n\n> Click the action buttons below to block this IP address."
            },
            "conditionalVisibility": {
              "parameterName": "SelectedRemediationIP",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "SelectedIPText"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "action-add-threat-indicator",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üõ°Ô∏è Add to Threat Intelligence",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Add-ThreatIndicator/triggers/manual/run",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2016-10-01"
                      }
                    ],
                    "body": "{\"ipAddress\": \"{SelectedRemediationIP}\", \"threatType\": \"malicious-activity\", \"confidence\": 85, \"description\": \"Malicious IP identified via Identity Security Workbook - Attack source\", \"action\": \"alert\"}",
                    "httpMethod": "POST",
                    "title": "Add IP to Threat Intelligence",
                    "description": "## üõ°Ô∏è Add Threat Indicator\n\nYou are about to **add a threat indicator** for:\n\n**IP Address:** {SelectedRemediationIP}\n\nThis will:\n- Create threat indicator in Microsoft Sentinel\n- Enable correlation with future events\n- Alert on matching activity\n\nAre you sure you want to proceed?",
                    "actionName": "Add-ThreatIndicator",
                    "runLabel": "Add Indicator"
                  }
                },
                {
                  "id": "action-block-ip-location",
                  "linkTarget": "ArmAction",
                  "linkLabel": "üö´ Block in Conditional Access",
                  "style": "primary",
                  "linkIsContextBlade": true,
                  "armActionContext": {
                    "path": "{RemediationSubscription}/resourceGroups/{PlaybookResourceGroup}/providers/Microsoft.Logic/workflows/Add-BlockedLocation/triggers/manual/run",
                    "headers": [],
                    "params": [
                      {
                        "key": "api-version",
                        "value": "2016-10-01"
                      }
                    ],
                    "body": "{\"ipAddress\": \"{SelectedRemediationIP}\", \"namedLocation\": \"Blocked-Attack-Sources\", \"reason\": \"IP blocked via Identity Security Workbook - Malicious activity detected\"}",
                    "httpMethod": "POST",
                    "title": "Block IP in Conditional Access",
                    "description": "## üö´ Block IP Address\n\nYou are about to **add this IP to blocked locations** in Conditional Access:\n\n**IP Address:** {SelectedRemediationIP}\n\nThis will:\n- Add IP to 'Blocked-Attack-Sources' named location\n- Block sign-ins from this IP (if CA policy configured)\n- Apply immediately\n\nAre you sure you want to proceed?",
                    "actionName": "Add-BlockedLocation",
                    "runLabel": "Block IP"
                  }
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "SelectedRemediationIP",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "IPActionLinks"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Recent Remediation Actions (from AuditLogs)\nAuditLogs\n| where TimeGenerated {TimeRange}\n| where OperationName in (\n    'Revoke all refresh tokens for a user',\n    'Reset password (by admin)',\n    'Disable account',\n    'Update user',\n    'Delete OAuth2PermissionGrant',\n    'Remove app role assignment from service principal',\n    'Update service principal',\n    'Hard delete service principal',\n    'Add service principal credentials',\n    'Remove service principal credentials'\n)\n| extend Actor = coalesce(tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName), 'System')\n| extend Target = coalesce(tostring(TargetResources[0].userPrincipalName), tostring(TargetResources[0].displayName))\n| project TimeGenerated, OperationName, Actor, Target, Result\n| order by TimeGenerated desc\n| take 50",
              "size": 0,
              "title": "üìã Recent Remediation Actions",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "RecentRemediations"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n### üìö Quick Reference - Azure Portal Remediation\n\n#### üë§ User Actions\n| Action | Navigation Path |\n|--------|----------------|\n| Revoke Sessions | Entra ID ‚Üí Users ‚Üí [User] ‚Üí Revoke sessions |\n| Reset Password | Entra ID ‚Üí Users ‚Üí [User] ‚Üí Reset password |\n| Block Sign-in | Entra ID ‚Üí Users ‚Üí [User] ‚Üí Edit properties ‚Üí Block sign in = Yes |\n| Reset MFA | Entra ID ‚Üí Users ‚Üí [User] ‚Üí Authentication methods ‚Üí Require re-register MFA |\n| Confirm Compromised | Identity Protection ‚Üí Risky users ‚Üí [User] ‚Üí Confirm user compromised |\n\n#### ‚öôÔ∏è Service Principal Actions\n| Action | Navigation Path |\n|--------|----------------|\n| Rotate Secret | App registrations ‚Üí [App] ‚Üí Certificates & secrets ‚Üí New client secret |\n| Delete Old Secret | App registrations ‚Üí [App] ‚Üí Certificates & secrets ‚Üí Delete |\n| Disable App | Enterprise applications ‚Üí [App] ‚Üí Properties ‚Üí Enabled = No |\n| Revoke Permissions | Enterprise applications ‚Üí [App] ‚Üí Permissions ‚Üí [Permission] ‚Üí Revoke |\n\n#### üåê Network Actions\n| Action | Navigation Path |\n|--------|----------------|\n| Block IP | Conditional Access ‚Üí Named locations ‚Üí New location ‚Üí IP ranges |\n| Create Block Policy | Conditional Access ‚Üí Policies ‚Üí New policy ‚Üí Block + Select location |\n\n---\n**üîó Resources:**\n- [Sentinel Automation](https://learn.microsoft.com/azure/sentinel/automation)\n- [Graph API User Actions](https://learn.microsoft.com/graph/api/resources/user)\n- [Graph API Application Actions](https://learn.microsoft.com/graph/api/resources/application)"
            },
            "name": "QuickReference"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "remediation"
      },
      "name": "RemediationGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## ÔøΩüó∫Ô∏è Geolocation Analysis & Trusted Location Validation\n---\nVisualize non-human identity activity on a global map and validate IP addresses against Conditional Access trusted locations."
            },
            "name": "GeoHeader"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "trustedIPs",
                  "version": "KqlParameterItem/1.0",
                  "name": "TrustedIPRanges",
                  "type": 1,
                  "value": "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,20.0.0.0/8,40.0.0.0/8,52.0.0.0/8,104.0.0.0/8",
                  "label": "Trusted IP Ranges (comma-separated CIDR)",
                  "description": "Enter your organization's trusted IP ranges from Conditional Access Named Locations"
                },
                {
                  "id": "trustedCountries",
                  "version": "KqlParameterItem/1.0",
                  "name": "TrustedCountries",
                  "type": 1,
                  "value": "United States,Canada,United Kingdom,Germany,France,Netherlands,Australia",
                  "label": "Trusted Countries (comma-separated)",
                  "description": "Enter trusted countries from Conditional Access Named Locations"
                }
              ],
              "style": "formHorizontal",
              "queryType": 0
            },
            "name": "GeoParameters"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Global Non-Human Identity Activity Map\nunion\n    (AADServicePrincipalSignInLogs | where TimeGenerated {TimeRange} | extend IdentityType = \"Service Principal\", IdentityName = ServicePrincipalName),\n    (AADManagedIdentitySignInLogs | where TimeGenerated {TimeRange} | extend IdentityType = \"Managed Identity\", IdentityName = ServicePrincipalName)\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Latitude = todouble(GeoInfo.latitude)\n| extend Longitude = todouble(GeoInfo.longitude)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| where isnotempty(Latitude) and isnotempty(Longitude)\n| summarize \n    TotalEvents = count(),\n    SuccessEvents = countif(ResultType == \"0\"),\n    FailedEvents = countif(ResultType != \"0\"),\n    UniqueIdentities = dcount(IdentityName),\n    IdentityTypes = make_set(IdentityType),\n    TopIdentities = make_set(IdentityName, 5)\n    by Country, City, Latitude, Longitude\n| extend FailureRate = round(todouble(FailedEvents) / TotalEvents * 100, 2)\n| order by TotalEvents desc",
              "size": 0,
              "title": "üó∫Ô∏è Global Non-Human Identity Activity Map",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "map",
              "mapSettings": {
                "locInfo": "LatLong",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "TotalEvents",
                "sizeAggregation": "Sum",
                "labelSettings": "City",
                "legendMetric": "TotalEvents",
                "numberOfMetrics": 1,
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "FailureRate",
                  "colorAggregation": "Average",
                  "type": "heatmap",
                  "heatmapPalette": "greenRed"
                }
              }
            },
            "name": "GlobalActivityMap"
          },
          {
            "type": 1,
            "content": {
              "json": "### üîç IP Address Trusted Location Validation\n---\nCompare sign-in IPs against your Conditional Access trusted locations to identify access from untrusted sources."
            },
            "name": "TrustedIPHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// IP Addresses with Trusted Location Check\nlet TrustedCountryList = dynamic([\"United States\", \"Canada\", \"United Kingdom\", \"Germany\", \"France\", \"Netherlands\", \"Australia\"]);\nunion\n    (AADServicePrincipalSignInLogs | where TimeGenerated {TimeRange} | extend IdentityType = \"Service Principal\", IdentityName = ServicePrincipalName),\n    (AADManagedIdentitySignInLogs | where TimeGenerated {TimeRange} | extend IdentityType = \"Managed Identity\", IdentityName = ServicePrincipalName)\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| extend State = tostring(GeoInfo.state)\n// Check if country is in trusted list\n| extend IsTrustedCountry = Country in (TrustedCountryList)\n// Check for common private/Azure IP ranges\n| extend IsPrivateIP = ipv4_is_private(IPAddress)\n| extend IsAzureIP = ipv4_is_in_range(IPAddress, \"20.0.0.0/8\") or ipv4_is_in_range(IPAddress, \"40.0.0.0/8\") or ipv4_is_in_range(IPAddress, \"52.0.0.0/8\") or ipv4_is_in_range(IPAddress, \"104.0.0.0/8\") or ipv4_is_in_range(IPAddress, \"13.0.0.0/8\") or ipv4_is_in_range(IPAddress, \"23.0.0.0/8\")\n| extend IsTrustedLocation = case(\n    IsPrivateIP == true, true,\n    IsAzureIP == true, true,\n    IsTrustedCountry == true, true,\n    false\n)\n| extend TrustStatus = case(\n    IsPrivateIP == true, \"‚úÖ Private IP\",\n    IsAzureIP == true, \"‚úÖ Azure IP\",\n    IsTrustedCountry == true, \"‚úÖ Trusted Country\",\n    \"‚ùå Untrusted Location\"\n)\n| summarize \n    TotalEvents = count(),\n    SuccessEvents = countif(ResultType == \"0\"),\n    FailedEvents = countif(ResultType != \"0\"),\n    UniqueIdentities = dcount(IdentityName),\n    Identities = make_set(IdentityName, 5),\n    IdentityTypes = make_set(IdentityType),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by IPAddress, Country, City, TrustStatus, IsTrustedLocation\n| extend RiskLevel = case(\n    IsTrustedLocation == false and SuccessEvents > 0, \"üî¥ Critical - Untrusted Success\",\n    IsTrustedLocation == false and FailedEvents > 10, \"üü† High - Untrusted Attacks\",\n    IsTrustedLocation == false, \"üü° Medium - Untrusted Activity\",\n    \"üü¢ Low - Trusted\"\n)\n| order by IsTrustedLocation asc, TotalEvents desc",
              "size": 0,
              "title": "üîç IP Address Trusted Location Analysis",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "TrustedIPAnalysis"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Untrusted Location Activity Summary\nlet TrustedCountryList = dynamic([\"United States\", \"Canada\", \"United Kingdom\", \"Germany\", \"France\", \"Netherlands\", \"Australia\"]);\nunion\n    (AADServicePrincipalSignInLogs | where TimeGenerated {TimeRange} | extend IdentityType = \"Service Principal\"),\n    (AADManagedIdentitySignInLogs | where TimeGenerated {TimeRange} | extend IdentityType = \"Managed Identity\")\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend IsPrivateIP = ipv4_is_private(IPAddress)\n| extend IsAzureIP = ipv4_is_in_range(IPAddress, \"20.0.0.0/8\") or ipv4_is_in_range(IPAddress, \"40.0.0.0/8\") or ipv4_is_in_range(IPAddress, \"52.0.0.0/8\")\n| extend IsTrustedCountry = Country in (TrustedCountryList)\n| extend IsTrustedLocation = IsPrivateIP or IsAzureIP or IsTrustedCountry\n| summarize \n    Total = count(),\n    Trusted = countif(IsTrustedLocation == true),\n    Untrusted = countif(IsTrustedLocation == false)\n    by IdentityType\n| extend UntrustedPercent = round(todouble(Untrusted) / Total * 100, 2)\n| extend RiskIndicator = case(\n    UntrustedPercent > 30, \"üî¥ High Risk\",\n    UntrustedPercent > 10, \"üü† Elevated\",\n    UntrustedPercent > 5, \"üü° Monitor\",\n    \"üü¢ Good\"\n)",
              "size": 4,
              "title": "üìä Trusted vs Untrusted Location Summary",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "showBorder": true,
                "titleContent": {
                  "columnMatch": "IdentityType",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Untrusted",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "redGreen"
                  }
                },
                "secondaryContent": {
                  "columnMatch": "RiskIndicator",
                  "formatter": 1
                }
              }
            },
            "customWidth": "50",
            "name": "TrustedSummary"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Trust Status Distribution\nlet TrustedCountryList = dynamic([\"United States\", \"Canada\", \"United Kingdom\", \"Germany\", \"France\", \"Netherlands\", \"Australia\"]);\nunion\n    (AADServicePrincipalSignInLogs | where TimeGenerated {TimeRange}),\n    (AADManagedIdentitySignInLogs | where TimeGenerated {TimeRange})\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend IsPrivateIP = ipv4_is_private(IPAddress)\n| extend IsAzureIP = ipv4_is_in_range(IPAddress, \"20.0.0.0/8\") or ipv4_is_in_range(IPAddress, \"40.0.0.0/8\") or ipv4_is_in_range(IPAddress, \"52.0.0.0/8\")\n| extend IsTrustedCountry = Country in (TrustedCountryList)\n| extend TrustCategory = case(\n    IsPrivateIP == true, \"Private IP\",\n    IsAzureIP == true, \"Azure IP\",\n    IsTrustedCountry == true, \"Trusted Country\",\n    \"Untrusted\"\n)\n| summarize Count = count() by TrustCategory\n| order by Count desc",
              "size": 2,
              "title": "ü•ß Trust Status Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "TrustDistribution"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Untrusted Location Sign-Ins Map (Attack Origins)\nlet TrustedCountryList = dynamic([\"United States\", \"Canada\", \"United Kingdom\", \"Germany\", \"France\", \"Netherlands\", \"Australia\"]);\nunion\n    (AADServicePrincipalSignInLogs | where TimeGenerated {TimeRange} | extend IdentityType = \"Service Principal\", IdentityName = ServicePrincipalName),\n    (AADManagedIdentitySignInLogs | where TimeGenerated {TimeRange} | extend IdentityType = \"Managed Identity\", IdentityName = ServicePrincipalName)\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Latitude = todouble(GeoInfo.latitude)\n| extend Longitude = todouble(GeoInfo.longitude)\n| extend Country = tostring(GeoInfo.country)\n| extend City = tostring(GeoInfo.city)\n| where isnotempty(Latitude) and isnotempty(Longitude)\n| extend IsPrivateIP = ipv4_is_private(IPAddress)\n| extend IsAzureIP = ipv4_is_in_range(IPAddress, \"20.0.0.0/8\") or ipv4_is_in_range(IPAddress, \"40.0.0.0/8\") or ipv4_is_in_range(IPAddress, \"52.0.0.0/8\")\n| extend IsTrustedCountry = Country in (TrustedCountryList)\n| extend IsTrustedLocation = IsPrivateIP or IsAzureIP or IsTrustedCountry\n| where IsTrustedLocation == false\n| summarize \n    UntrustedEvents = count(),\n    SuccessfulBreaches = countif(ResultType == \"0\"),\n    FailedAttempts = countif(ResultType != \"0\"),\n    TargetedIdentities = dcount(IdentityName),\n    Identities = make_set(IdentityName, 5)\n    by Country, City, Latitude, Longitude\n| extend ThreatLevel = case(\n    SuccessfulBreaches > 0, \"Critical\",\n    UntrustedEvents > 100, \"High\",\n    UntrustedEvents > 10, \"Medium\",\n    \"Low\"\n)\n| order by SuccessfulBreaches desc, UntrustedEvents desc",
              "size": 0,
              "title": "üö® Untrusted Location Activity Map",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "map",
              "mapSettings": {
                "locInfo": "LatLong",
                "latitude": "Latitude",
                "longitude": "Longitude",
                "sizeSettings": "UntrustedEvents",
                "sizeAggregation": "Sum",
                "labelSettings": "Country",
                "legendMetric": "SuccessfulBreaches",
                "numberOfMetrics": 1,
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "SuccessfulBreaches",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "redDark"
                }
              }
            },
            "name": "UntrustedLocationMap"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Activity by Country with Trust Status\nlet TrustedCountryList = dynamic([\"United States\", \"Canada\", \"United Kingdom\", \"Germany\", \"France\", \"Netherlands\", \"Australia\"]);\nunion\n    (AADServicePrincipalSignInLogs | where TimeGenerated {TimeRange} | extend IdentityType = \"Service Principal\"),\n    (AADManagedIdentitySignInLogs | where TimeGenerated {TimeRange} | extend IdentityType = \"Managed Identity\")\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| where isnotempty(Country)\n| extend IsTrustedCountry = Country in (TrustedCountryList)\n| extend TrustStatus = iff(IsTrustedCountry, \"‚úÖ Trusted\", \"‚ùå Untrusted\")\n| summarize \n    TotalEvents = count(),\n    SuccessEvents = countif(ResultType == \"0\"),\n    FailedEvents = countif(ResultType != \"0\"),\n    UniqueIPs = dcount(IPAddress),\n    UniqueIdentities = dcount(ServicePrincipalId),\n    IdentityTypes = make_set(IdentityType)\n    by Country, TrustStatus\n| extend SuccessRate = round(todouble(SuccessEvents) / TotalEvents * 100, 2)\n| extend RiskScore = case(\n    TrustStatus == \"‚ùå Untrusted\" and SuccessEvents > 0, \"üî¥ Critical\",\n    TrustStatus == \"‚ùå Untrusted\" and FailedEvents > 50, \"üü† High\",\n    TrustStatus == \"‚ùå Untrusted\", \"üü° Medium\",\n    \"üü¢ Low\"\n)\n| order by TrustStatus asc, TotalEvents desc",
              "size": 0,
              "title": "üåç Country Activity with Trust Status",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table"
            },
            "name": "CountryTrustAnalysis"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Untrusted Location Activity Timeline\nlet TrustedCountryList = dynamic([\"United States\", \"Canada\", \"United Kingdom\", \"Germany\", \"France\", \"Netherlands\", \"Australia\"]);\nunion\n    (AADServicePrincipalSignInLogs | where TimeGenerated {TimeRange}),\n    (AADManagedIdentitySignInLogs | where TimeGenerated {TimeRange})\n| extend GeoInfo = geo_info_from_ip_address(IPAddress)\n| extend Country = tostring(GeoInfo.country)\n| extend IsPrivateIP = ipv4_is_private(IPAddress)\n| extend IsAzureIP = ipv4_is_in_range(IPAddress, \"20.0.0.0/8\") or ipv4_is_in_range(IPAddress, \"40.0.0.0/8\") or ipv4_is_in_range(IPAddress, \"52.0.0.0/8\")\n| extend IsTrustedCountry = Country in (TrustedCountryList)\n| extend IsTrustedLocation = IsPrivateIP or IsAzureIP or IsTrustedCountry\n| extend LocationType = iff(IsTrustedLocation, \"Trusted\", \"Untrusted\")\n| summarize Count = count() by bin(TimeGenerated, 1h), LocationType\n| render timechart",
              "size": 0,
              "title": "üìà Trusted vs Untrusted Location Activity Over Time",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "name": "TrustTimeline"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "geolocation"
      },
      "name": "GeolocationGroup"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## üîç Forensic Investigation Center\n---\n### Deep-Dive Analysis for Security Investigations\n\nThis tab provides comprehensive forensic capabilities for investigating:\n- **üë§ Users** - Complete user activity timeline and risk analysis\n- **üåê IP Addresses** - Source IP reputation and activity mapping\n- **‚öôÔ∏è Service Principals** - App identity deep investigation\n- **ü§ñ Managed Identities** - Azure resource identity forensics\n\n> üí° **Tip:** Each section below has its own search filter. Enter the entity identifier and click a row or press Enter to investigate.\n\n---"
            },
            "name": "ForensicHeader"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "forensic-timerange",
                  "version": "KqlParameterItem/1.0",
                  "name": "ForensicTimeRange",
                  "type": 4,
                  "isRequired": true,
                  "value": {
                    "durationMs": 604800000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {"durationMs": 86400000, "displayName": "Last 24 hours"},
                      {"durationMs": 259200000, "displayName": "Last 3 days"},
                      {"durationMs": 604800000, "displayName": "Last 7 days"},
                      {"durationMs": 1209600000, "displayName": "Last 14 days"},
                      {"durationMs": 2592000000, "displayName": "Last 30 days"}
                    ]
                  },
                  "label": "Investigation Period"
                }
              ],
              "style": "pills",
              "queryType": 0
            },
            "name": "ForensicTimeParameters"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n## üë§ User Investigation\n\nComprehensive analysis of user authentication behavior, risk indicators, and activity timeline."
            },
            "name": "UserForensicHeader"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "user-search-filter",
                  "version": "KqlParameterItem/1.0",
                  "name": "UserSearchFilter",
                  "type": 1,
                  "isRequired": false,
                  "value": "",
                  "label": "üîç Search User (UPN or User ID)",
                  "description": "Enter user principal name or user ID to investigate"
                }
              ],
              "style": "pills",
              "queryType": 0
            },
            "name": "UserSearchParams"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// User Quick Search Results - Click to select\nSigninLogs\n| where TimeGenerated {ForensicTimeRange}\n| where '{UserSearchFilter}' == '' or UserPrincipalName contains '{UserSearchFilter}' or UserId == '{UserSearchFilter}'\n| summarize \n    TotalSignIns = count(),\n    FailedSignIns = countif(ResultType != '0'),\n    HighRisk = countif(RiskLevelDuringSignIn == 'high'),\n    UniqueIPs = dcount(IPAddress),\n    LastSeen = max(TimeGenerated)\n    by UserPrincipalName, UserId\n| extend FailureRate = round(todouble(FailedSignIns) / TotalSignIns * 100, 1)\n| extend RiskLevel = case(\n    HighRisk > 0, 'üî¥ HIGH',\n    FailureRate > 50, 'üü† ELEVATED',\n    'üü¢ NORMAL'\n)\n| project RiskLevel, UserPrincipalName, UserId, TotalSignIns, FailedSignIns, FailureRate, UniqueIPs, LastSeen\n| order by TotalSignIns desc\n| take 20",
              "size": 0,
              "title": "üë§ Users - Click row to investigate",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 20,
                "filter": true
              },
              "exportFieldName": "UserPrincipalName",
              "exportParameterName": "SelectedForensicUser",
              "exportDefaultValue": ""
            },
            "name": "UserSearchResults"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìä Investigating User: **{SelectedForensicUser}**"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicUser",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "SelectedUserHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// User Profile Summary\nlet targetUser = '{SelectedForensicUser}';\nSigninLogs\n| where TimeGenerated {ForensicTimeRange}\n| where UserPrincipalName =~ targetUser or UserId == targetUser\n| summarize \n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated),\n    TotalSignIns = count(),\n    SuccessfulSignIns = countif(ResultType == '0'),\n    FailedSignIns = countif(ResultType != '0'),\n    UniqueIPs = dcount(IPAddress),\n    UniqueDevices = dcount(tostring(DeviceDetail.deviceId)),\n    UniqueCountries = dcount(tostring(LocationDetails.countryOrRegion)),\n    UniqueApps = dcount(AppDisplayName),\n    HighRiskEvents = countif(RiskLevelDuringSignIn == 'high'),\n    MediumRiskEvents = countif(RiskLevelDuringSignIn == 'medium'),\n    MFARequired = countif(AuthenticationRequirement == 'multiFactorAuthentication'),\n    Countries = make_set(tostring(LocationDetails.countryOrRegion), 10),\n    TopIPs = make_set(IPAddress, 5),\n    RiskEvents = make_set(RiskEventTypes_V2, 10)\n    by UserPrincipalName, UserId\n| extend FailureRate = round(todouble(FailedSignIns) / TotalSignIns * 100, 1)\n| extend MFARate = round(todouble(MFARequired) / TotalSignIns * 100, 1)\n| extend RiskIndicator = case(\n    HighRiskEvents > 0, 'üî¥ HIGH RISK',\n    MediumRiskEvents > 0, 'üü† MEDIUM RISK',\n    FailureRate > 50, 'üü° ELEVATED',\n    'üü¢ NORMAL'\n)\n| project \n    UserPrincipalName, UserId, RiskIndicator,\n    FirstSeen, LastSeen,\n    TotalSignIns, SuccessfulSignIns, FailedSignIns, FailureRate,\n    MFARate, UniqueIPs, UniqueDevices, UniqueCountries, UniqueApps,\n    HighRiskEvents, MediumRiskEvents,\n    Countries, TopIPs, RiskEvents",
              "size": 0,
              "title": "üë§ User Profile Summary",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "RiskIndicator",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {"operator": "contains", "thresholdValue": "HIGH", "representation": "red", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "MEDIUM", "representation": "orange", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "ELEVATED", "representation": "yellow", "text": "{0}"},
                        {"operator": "Default", "representation": "green", "text": "{0}"}
                      ]
                    }
                  },
                  {
                    "columnMatch": "FailureRate",
                    "formatter": 4,
                    "formatOptions": {"palette": "redGreen", "min": 0, "max": 100}
                  }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicUser",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "UserProfileSummary"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// User Activity Timeline\nlet targetUser = '{SelectedForensicUser}';\nSigninLogs\n| where TimeGenerated {ForensicTimeRange}\n| where UserPrincipalName =~ targetUser or UserId == targetUser\n| summarize \n    Success = countif(ResultType == '0'),\n    Failed = countif(ResultType != '0'),\n    HighRisk = countif(RiskLevelDuringSignIn == 'high')\n    by bin(TimeGenerated, 1h)\n| render timechart",
              "size": 0,
              "title": "üìà User Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicUser",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "UserActivityTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// User Geographic Distribution\nlet targetUser = '{SelectedForensicUser}';\nSigninLogs\n| where TimeGenerated {ForensicTimeRange}\n| where UserPrincipalName =~ targetUser or UserId == targetUser\n| extend Country = tostring(LocationDetails.countryOrRegion)\n| extend City = tostring(LocationDetails.city)\n| summarize Count = count() by Country, City\n| order by Count desc",
              "size": 0,
              "title": "üåç Geographic Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicUser",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "UserGeoDistribution"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// User Sign-In Details\nlet targetUser = '{SelectedForensicUser}';\nSigninLogs\n| where TimeGenerated {ForensicTimeRange}\n| where UserPrincipalName =~ targetUser or UserId == targetUser\n| extend Country = tostring(LocationDetails.countryOrRegion)\n| extend City = tostring(LocationDetails.city)\n| extend DeviceName = tostring(DeviceDetail.displayName)\n| extend DeviceOS = tostring(DeviceDetail.operatingSystem)\n| extend Browser = tostring(DeviceDetail.browser)\n| extend Status = case(ResultType == '0', '‚úÖ Success', '‚ùå Failed')\n| extend RiskLevel = coalesce(RiskLevelDuringSignIn, 'none')\n| project \n    TimeGenerated,\n    Status,\n    RiskLevel,\n    IPAddress,\n    Country,\n    City,\n    AppDisplayName,\n    ClientAppUsed,\n    DeviceName,\n    DeviceOS,\n    Browser,\n    AuthenticationRequirement,\n    ConditionalAccessStatus,\n    ResultType,\n    ResultDescription,\n    RiskEventTypes_V2\n| order by TimeGenerated desc\n| take 100",
              "size": 0,
              "title": "üìù User Sign-In Event Details",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {"operator": "contains", "thresholdValue": "Success", "representation": "green", "text": "{0}"},
                        {"operator": "Default", "representation": "red", "text": "{0}"}
                      ]
                    }
                  },
                  {
                    "columnMatch": "RiskLevel",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {"operator": "==", "thresholdValue": "high", "representation": "red", "text": "üî¥ HIGH"},
                        {"operator": "==", "thresholdValue": "medium", "representation": "orange", "text": "üü† MEDIUM"},
                        {"operator": "==", "thresholdValue": "low", "representation": "yellow", "text": "üü° LOW"},
                        {"operator": "Default", "representation": "green", "text": "üü¢ NONE"}
                      ]
                    }
                  }
                ],
                "filter": true
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicUser",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "UserSignInDetails"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n## üåê IP Address Investigation\n\nAnalyze source IP reputation, associated identities, and attack patterns."
            },
            "name": "IPForensicHeader"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "ip-search-filter",
                  "version": "KqlParameterItem/1.0",
                  "name": "IPSearchFilter",
                  "type": 1,
                  "isRequired": false,
                  "value": "",
                  "label": "üîç Search IP Address",
                  "description": "Enter IP address to investigate"
                }
              ],
              "style": "pills",
              "queryType": 0
            },
            "name": "IPSearchParams"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// IP Quick Search Results - Click to select\nunion\n    (AADServicePrincipalSignInLogs | where TimeGenerated {ForensicTimeRange}),\n    (AADManagedIdentitySignInLogs | where TimeGenerated {ForensicTimeRange}),\n    (SigninLogs | where TimeGenerated {ForensicTimeRange})\n| where IPAddress != ''\n| where '{IPSearchFilter}' == '' or IPAddress contains '{IPSearchFilter}'\n| summarize \n    TotalAttempts = count(),\n    FailedAttempts = countif(ResultType != '0'),\n    UniqueTargets = dcount(coalesce(ServicePrincipalId, UserId)),\n    LastSeen = max(TimeGenerated)\n    by IPAddress\n| extend FailureRate = round(todouble(FailedAttempts) / TotalAttempts * 100, 1)\n| extend ThreatLevel = case(\n    FailureRate > 80 and FailedAttempts > 50, 'üî¥ ATTACK',\n    UniqueTargets > 20, 'üü† SPRAY',\n    FailedAttempts > 50, 'üü° ELEVATED',\n    'üü¢ NORMAL'\n)\n| project ThreatLevel, IPAddress, TotalAttempts, FailedAttempts, FailureRate, UniqueTargets, LastSeen\n| order by TotalAttempts desc\n| take 20",
              "size": 0,
              "title": "üåê IP Addresses - Click row to investigate",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 20,
                "filter": true
              },
              "exportFieldName": "IPAddress",
              "exportParameterName": "SelectedForensicIP",
              "exportDefaultValue": ""
            },
            "name": "IPSearchResults"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìä Investigating IP: **{SelectedForensicIP}**"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicIP",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "SelectedIPHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// IP Address Profile\nlet targetIP = '{SelectedForensicIP}';\nlet userActivity = SigninLogs\n| where TimeGenerated {ForensicTimeRange}\n| where IPAddress == targetIP\n| summarize \n    UserSignIns = count(),\n    UserFailed = countif(ResultType != '0'),\n    UniqueUsers = dcount(UserPrincipalName),\n    HighRiskUser = countif(RiskLevelDuringSignIn == 'high')\n    by IPAddress;\nlet spActivity = AADServicePrincipalSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where IPAddress == targetIP\n| summarize \n    SPSignIns = count(),\n    SPFailed = countif(ResultType != '0'),\n    UniqueSPs = dcount(ServicePrincipalId)\n    by IPAddress;\nlet miActivity = AADManagedIdentitySignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where IPAddress == targetIP\n| summarize \n    MISignIns = count(),\n    MIFailed = countif(ResultType != '0'),\n    UniqueMIs = dcount(ServicePrincipalId)\n    by IPAddress;\nuserActivity\n| join kind=leftouter spActivity on IPAddress\n| join kind=leftouter miActivity on IPAddress\n| extend TotalEvents = coalesce(UserSignIns, 0) + coalesce(SPSignIns, 0) + coalesce(MISignIns, 0)\n| extend TotalFailed = coalesce(UserFailed, 0) + coalesce(SPFailed, 0) + coalesce(MIFailed, 0)\n| extend FailureRate = round(todouble(TotalFailed) / TotalEvents * 100, 1)\n| extend ThreatLevel = case(\n    coalesce(HighRiskUser, 0) > 0, 'üî¥ MALICIOUS',\n    FailureRate > 80 and TotalFailed > 50, 'üî¥ ATTACK SOURCE',\n    coalesce(UniqueUsers, 0) > 20, 'üü† PASSWORD SPRAY',\n    coalesce(UniqueSPs, 0) > 5, 'üü† APP TARGETING',\n    FailureRate > 50, 'üü° SUSPICIOUS',\n    'üü¢ NORMAL'\n)\n| project \n    IPAddress, ThreatLevel,\n    TotalEvents, TotalFailed, FailureRate,\n    UserSignIns = coalesce(UserSignIns, 0), UniqueUsers = coalesce(UniqueUsers, 0),\n    SPSignIns = coalesce(SPSignIns, 0), UniqueSPs = coalesce(UniqueSPs, 0),\n    MISignIns = coalesce(MISignIns, 0), UniqueMIs = coalesce(UniqueMIs, 0)",
              "size": 0,
              "title": "üåê IP Address Profile",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "ThreatLevel",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {"operator": "contains", "thresholdValue": "MALICIOUS", "representation": "red", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "ATTACK", "representation": "red", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "SPRAY", "representation": "orange", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "TARGETING", "representation": "orange", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "SUSPICIOUS", "representation": "yellow", "text": "{0}"},
                        {"operator": "Default", "representation": "green", "text": "{0}"}
                      ]
                    }
                  },
                  {
                    "columnMatch": "FailureRate",
                    "formatter": 4,
                    "formatOptions": {"palette": "redGreen", "min": 0, "max": 100}
                  }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicIP",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "IPProfile"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Users targeted from this IP\nlet targetIP = '{SelectedForensicIP}';\nSigninLogs\n| where TimeGenerated {ForensicTimeRange}\n| where IPAddress == targetIP\n| summarize \n    Attempts = count(),\n    Failed = countif(ResultType != '0'),\n    Successful = countif(ResultType == '0'),\n    LastAttempt = max(TimeGenerated),\n    HighRisk = countif(RiskLevelDuringSignIn == 'high')\n    by UserPrincipalName\n| extend Status = case(\n    Successful > 0 and Failed > 10, 'üî¥ COMPROMISED',\n    HighRisk > 0, 'üî¥ HIGH RISK',\n    Failed > 20, 'üü† TARGETED',\n    'üü¢ NORMAL'\n)\n| order by Attempts desc\n| take 25",
              "size": 0,
              "title": "üë• Users Targeted from this IP",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {"filter": true}
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicIP",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "IPTargetedUsers"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Apps targeted from this IP\nlet targetIP = '{SelectedForensicIP}';\nAADServicePrincipalSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where IPAddress == targetIP\n| summarize \n    Attempts = count(),\n    Failed = countif(ResultType != '0'),\n    Successful = countif(ResultType == '0'),\n    LastAttempt = max(TimeGenerated)\n    by ServicePrincipalName, ServicePrincipalId\n| extend Status = case(\n    Successful > 0 and Failed > 10, 'üî¥ COMPROMISED',\n    Failed > 20, 'üü† TARGETED',\n    'üü¢ NORMAL'\n)\n| order by Attempts desc\n| take 25",
              "size": 0,
              "title": "‚öôÔ∏è Service Principals Targeted from this IP",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {"filter": true}
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicIP",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "IPTargetedSPs"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// IP Activity Timeline\nlet targetIP = '{SelectedForensicIP}';\nunion\n    (SigninLogs | where TimeGenerated {ForensicTimeRange} | where IPAddress == targetIP | extend Source = 'User'),\n    (AADServicePrincipalSignInLogs | where TimeGenerated {ForensicTimeRange} | where IPAddress == targetIP | extend Source = 'ServicePrincipal'),\n    (AADManagedIdentitySignInLogs | where TimeGenerated {ForensicTimeRange} | where IPAddress == targetIP | extend Source = 'ManagedIdentity')\n| summarize Count = count() by bin(TimeGenerated, 1h), Source\n| render timechart",
              "size": 0,
              "title": "üìà IP Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicIP",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "IPTimeline"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n## ‚öôÔ∏è Service Principal Investigation\n\nDeep analysis of service principal authentication patterns, resource access, and anomalies."
            },
            "name": "SPForensicHeader"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "sp-search-filter",
                  "version": "KqlParameterItem/1.0",
                  "name": "SPSearchFilter",
                  "type": 1,
                  "isRequired": false,
                  "value": "",
                  "label": "üîç Search Service Principal (Name or ID)",
                  "description": "Enter service principal name or ID to investigate"
                }
              ],
              "style": "pills",
              "queryType": 0
            },
            "name": "SPSearchParams"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// SP Quick Search Results - Click to select\nAADServicePrincipalSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where '{SPSearchFilter}' == '' or ServicePrincipalName contains '{SPSearchFilter}' or ServicePrincipalId == '{SPSearchFilter}'\n| summarize \n    TotalEvents = count(),\n    FailedEvents = countif(ResultType != '0'),\n    UniqueIPs = dcount(IPAddress),\n    LastSeen = max(TimeGenerated)\n    by ServicePrincipalName, ServicePrincipalId\n| extend FailureRate = round(todouble(FailedEvents) / TotalEvents * 100, 1)\n| extend RiskLevel = case(\n    FailureRate > 50 and FailedEvents > 50, 'üî¥ ATTACK',\n    UniqueIPs > 20, 'üü† DISTRIBUTED',\n    FailedEvents > 100, 'üü° ELEVATED',\n    'üü¢ NORMAL'\n)\n| project RiskLevel, ServicePrincipalName, ServicePrincipalId, TotalEvents, FailedEvents, FailureRate, UniqueIPs, LastSeen\n| order by TotalEvents desc\n| take 20",
              "size": 0,
              "title": "‚öôÔ∏è Service Principals - Click row to investigate",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 20,
                "filter": true
              },
              "exportFieldName": "ServicePrincipalName",
              "exportParameterName": "SelectedForensicSP",
              "exportDefaultValue": ""
            },
            "name": "SPSearchResults"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìä Investigating Service Principal: **{SelectedForensicSP}**"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicSP",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "SelectedSPHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Service Principal Profile\nlet targetSP = '{SelectedForensicSP}';\nAADServicePrincipalSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where ServicePrincipalName =~ targetSP or ServicePrincipalId == targetSP\n| summarize \n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated),\n    TotalEvents = count(),\n    SuccessfulEvents = countif(ResultType == '0'),\n    FailedEvents = countif(ResultType != '0'),\n    UniqueIPs = dcount(IPAddress),\n    UniqueResources = dcount(ResourceDisplayName),\n    UniqueCountries = dcount(tostring(parse_json(LocationDetails).countryOrRegion)),\n    Countries = make_set(tostring(parse_json(LocationDetails).countryOrRegion), 10),\n    TopIPs = make_set(IPAddress, 10),\n    Resources = make_set(ResourceDisplayName, 10)\n    by ServicePrincipalName, ServicePrincipalId\n| extend FailureRate = round(todouble(FailedEvents) / TotalEvents * 100, 1)\n| extend RiskIndicator = case(\n    FailureRate > 50 and FailedEvents > 50, 'üî¥ UNDER ATTACK',\n    UniqueCountries > 5, 'üî¥ GEO ANOMALY',\n    UniqueIPs > 50, 'üü† DISTRIBUTED',\n    FailedEvents > 100, 'üü† HIGH FAILURES',\n    'üü¢ NORMAL'\n)\n| project \n    ServicePrincipalName, ServicePrincipalId, RiskIndicator,\n    FirstSeen, LastSeen,\n    TotalEvents, SuccessfulEvents, FailedEvents, FailureRate,\n    UniqueIPs, UniqueResources, UniqueCountries,\n    Countries, TopIPs, Resources",
              "size": 0,
              "title": "‚öôÔ∏è Service Principal Profile",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "RiskIndicator",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {"operator": "contains", "thresholdValue": "ATTACK", "representation": "red", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "ANOMALY", "representation": "red", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "DISTRIBUTED", "representation": "orange", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "FAILURES", "representation": "orange", "text": "{0}"},
                        {"operator": "Default", "representation": "green", "text": "{0}"}
                      ]
                    }
                  },
                  {
                    "columnMatch": "FailureRate",
                    "formatter": 4,
                    "formatOptions": {"palette": "redGreen", "min": 0, "max": 100}
                  }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicSP",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "SPProfile"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// SP Activity Timeline\nlet targetSP = '{SelectedForensicSP}';\nAADServicePrincipalSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where ServicePrincipalName =~ targetSP or ServicePrincipalId == targetSP\n| summarize Success = countif(ResultType == '0'), Failed = countif(ResultType != '0') by bin(TimeGenerated, 1h)\n| render timechart",
              "size": 0,
              "title": "üìà Service Principal Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicSP",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "SPTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// SP Resource Access\nlet targetSP = '{SelectedForensicSP}';\nAADServicePrincipalSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where ServicePrincipalName =~ targetSP or ServicePrincipalId == targetSP\n| summarize AccessCount = count() by ResourceDisplayName\n| order by AccessCount desc",
              "size": 2,
              "title": "üìÇ Resource Access Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicSP",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "SPResourceAccess"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// SP Event Details\nlet targetSP = '{SelectedForensicSP}';\nAADServicePrincipalSignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where ServicePrincipalName =~ targetSP or ServicePrincipalId == targetSP\n| extend Country = tostring(parse_json(LocationDetails).countryOrRegion)\n| extend City = tostring(parse_json(LocationDetails).city)\n| extend Status = case(ResultType == '0', '‚úÖ Success', '‚ùå Failed')\n| project \n    TimeGenerated,\n    Status,\n    IPAddress,\n    Country,\n    City,\n    ResourceDisplayName,\n    ResultType,\n    ResultDescription\n| order by TimeGenerated desc\n| take 100",
              "size": 0,
              "title": "üìù Service Principal Event Details",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {"operator": "contains", "thresholdValue": "Success", "representation": "green", "text": "{0}"},
                        {"operator": "Default", "representation": "red", "text": "{0}"}
                      ]
                    }
                  }
                ],
                "filter": true
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicSP",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "SPEventDetails"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n## ü§ñ Managed Identity Investigation\n\nAnalyze managed identity authentication patterns, resource access, and potential compromise indicators."
            },
            "name": "MIForensicHeader"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "mi-search-filter",
                  "version": "KqlParameterItem/1.0",
                  "name": "MISearchFilter",
                  "type": 1,
                  "isRequired": false,
                  "value": "",
                  "label": "üîç Search Managed Identity (Name or ID)",
                  "description": "Enter managed identity name or ID to investigate"
                }
              ],
              "style": "pills",
              "queryType": 0
            },
            "name": "MISearchParams"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// MI Quick Search Results - Click to select\nAADManagedIdentitySignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where '{MISearchFilter}' == '' or ServicePrincipalName contains '{MISearchFilter}' or ServicePrincipalId == '{MISearchFilter}'\n| summarize \n    TotalEvents = count(),\n    FailedEvents = countif(ResultType != '0'),\n    UniqueIPs = dcount(IPAddress),\n    LastSeen = max(TimeGenerated)\n    by ServicePrincipalName, ServicePrincipalId\n| extend FailureRate = round(todouble(FailedEvents) / TotalEvents * 100, 1)\n| extend RiskLevel = case(\n    FailedEvents > 50, 'üü† HIGH FAILURES',\n    UniqueIPs > 10, 'üü† MULTI-SOURCE',\n    FailureRate > 20, 'üü° ELEVATED',\n    'üü¢ NORMAL'\n)\n| project RiskLevel, ServicePrincipalName, ServicePrincipalId, TotalEvents, FailedEvents, FailureRate, UniqueIPs, LastSeen\n| order by TotalEvents desc\n| take 20",
              "size": 0,
              "title": "ü§ñ Managed Identities - Click row to investigate",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 20,
                "filter": true
              },
              "exportFieldName": "ServicePrincipalName",
              "exportParameterName": "SelectedForensicMI",
              "exportDefaultValue": ""
            },
            "name": "MISearchResults"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìä Investigating Managed Identity: **{SelectedForensicMI}**"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicMI",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "SelectedMIHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Managed Identity Profile\nlet targetMI = '{SelectedForensicMI}';\nAADManagedIdentitySignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where ServicePrincipalName =~ targetMI or ServicePrincipalId == targetMI\n| summarize \n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated),\n    TotalEvents = count(),\n    SuccessfulEvents = countif(ResultType == '0'),\n    FailedEvents = countif(ResultType != '0'),\n    UniqueIPs = dcount(IPAddress),\n    UniqueResources = dcount(ResourceDisplayName),\n    Resources = make_set(ResourceDisplayName, 10),\n    TopIPs = make_set(IPAddress, 10)\n    by ServicePrincipalName, ServicePrincipalId\n| extend FailureRate = round(todouble(FailedEvents) / TotalEvents * 100, 1)\n| extend RiskIndicator = case(\n    FailedEvents > 50, 'üü† HIGH FAILURES',\n    UniqueIPs > 10, 'üü† MULTI-SOURCE',\n    FailureRate > 20, 'üü° ELEVATED',\n    'üü¢ NORMAL'\n)\n| project \n    ServicePrincipalName, ServicePrincipalId, RiskIndicator,\n    FirstSeen, LastSeen,\n    TotalEvents, SuccessfulEvents, FailedEvents, FailureRate,\n    UniqueIPs, UniqueResources,\n    Resources, TopIPs",
              "size": 0,
              "title": "ü§ñ Managed Identity Profile",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "RiskIndicator",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {"operator": "contains", "thresholdValue": "HIGH", "representation": "orange", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "MULTI", "representation": "orange", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "ELEVATED", "representation": "yellow", "text": "{0}"},
                        {"operator": "Default", "representation": "green", "text": "{0}"}
                      ]
                    }
                  },
                  {
                    "columnMatch": "FailureRate",
                    "formatter": 4,
                    "formatOptions": {"palette": "redGreen", "min": 0, "max": 100}
                  }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicMI",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "MIProfile"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// MI Activity Timeline\nlet targetMI = '{SelectedForensicMI}';\nAADManagedIdentitySignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where ServicePrincipalName =~ targetMI or ServicePrincipalId == targetMI\n| summarize Success = countif(ResultType == '0'), Failed = countif(ResultType != '0') by bin(TimeGenerated, 1h)\n| render timechart",
              "size": 0,
              "title": "üìà Managed Identity Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicMI",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "MITimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// MI Resource Access\nlet targetMI = '{SelectedForensicMI}';\nAADManagedIdentitySignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where ServicePrincipalName =~ targetMI or ServicePrincipalId == targetMI\n| summarize AccessCount = count() by ResourceDisplayName\n| order by AccessCount desc",
              "size": 2,
              "title": "üìÇ Resource Access Distribution",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicMI",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "MIResourceAccess"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// MI Event Details\nlet targetMI = '{SelectedForensicMI}';\nAADManagedIdentitySignInLogs\n| where TimeGenerated {ForensicTimeRange}\n| where ServicePrincipalName =~ targetMI or ServicePrincipalId == targetMI\n| extend Status = case(ResultType == '0', '‚úÖ Success', '‚ùå Failed')\n| project \n    TimeGenerated,\n    Status,\n    IPAddress,\n    ResourceDisplayName,\n    ResultType,\n    ResultDescription\n| order by TimeGenerated desc\n| take 100",
              "size": 0,
              "title": "üìù Managed Identity Event Details",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {"operator": "contains", "thresholdValue": "Success", "representation": "green", "text": "{0}"},
                        {"operator": "Default", "representation": "red", "text": "{0}"}
                      ]
                    }
                  }
                ],
                "filter": true
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicMI",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "MIEventDetails"
          },
          {
            "type": 1,
            "content": {
              "json": "---\n## üíª Device Investigation\n\nAnalyze device authentication patterns, associated users, and compliance status."
            },
            "name": "DeviceForensicHeader"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "device-search-filter",
                  "version": "KqlParameterItem/1.0",
                  "name": "DeviceSearchFilter",
                  "type": 1,
                  "isRequired": false,
                  "value": "",
                  "label": "üîç Search Device (Name or ID)",
                  "description": "Enter device name or ID to investigate"
                }
              ],
              "style": "pills",
              "queryType": 0
            },
            "name": "DeviceSearchParams"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Device Quick Search Results - Click to select\nSigninLogs\n| where TimeGenerated {ForensicTimeRange}\n| extend DeviceName = tostring(DeviceDetail.displayName)\n| extend DeviceId = tostring(DeviceDetail.deviceId)\n| extend DeviceOS = tostring(DeviceDetail.operatingSystem)\n| extend IsCompliant = tostring(DeviceDetail.isCompliant)\n| where DeviceName != '' or DeviceId != ''\n| where '{DeviceSearchFilter}' == '' or DeviceName contains '{DeviceSearchFilter}' or DeviceId contains '{DeviceSearchFilter}'\n| summarize \n    TotalEvents = count(),\n    FailedEvents = countif(ResultType != '0'),\n    UniqueUsers = dcount(UserPrincipalName),\n    HighRiskEvents = countif(RiskLevelDuringSignIn == 'high'),\n    LastSeen = max(TimeGenerated)\n    by DeviceName, DeviceId, DeviceOS, IsCompliant\n| extend RiskLevel = case(\n    HighRiskEvents > 0, 'üî¥ HIGH RISK',\n    IsCompliant == 'false', 'üü† NON-COMPLIANT',\n    UniqueUsers > 5, 'üü° SHARED',\n    'üü¢ NORMAL'\n)\n| project RiskLevel, DeviceName, DeviceId, DeviceOS, IsCompliant, TotalEvents, FailedEvents, UniqueUsers, LastSeen\n| order by TotalEvents desc\n| take 20",
              "size": 0,
              "title": "üíª Devices - Click row to investigate",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 20,
                "filter": true
              },
              "exportFieldName": "DeviceName",
              "exportParameterName": "SelectedForensicDevice",
              "exportDefaultValue": ""
            },
            "name": "DeviceSearchResults"
          },
          {
            "type": 1,
            "content": {
              "json": "### üìä Investigating Device: **{SelectedForensicDevice}**"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicDevice",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "SelectedDeviceHeader"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Device Profile\nlet targetDevice = '{SelectedForensicDevice}';\nSigninLogs\n| where TimeGenerated {ForensicTimeRange}\n| where DeviceDetail.deviceId == targetDevice or DeviceDetail.displayName =~ targetDevice\n| extend DeviceName = tostring(DeviceDetail.displayName)\n| extend DeviceId = tostring(DeviceDetail.deviceId)\n| extend DeviceOS = tostring(DeviceDetail.operatingSystem)\n| extend IsCompliant = tostring(DeviceDetail.isCompliant)\n| extend IsManaged = tostring(DeviceDetail.isManaged)\n| extend TrustType = tostring(DeviceDetail.trustType)\n| summarize \n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated),\n    TotalSignIns = count(),\n    SuccessfulSignIns = countif(ResultType == '0'),\n    FailedSignIns = countif(ResultType != '0'),\n    UniqueUsers = dcount(UserPrincipalName),\n    UniqueIPs = dcount(IPAddress),\n    UniqueCountries = dcount(tostring(LocationDetails.countryOrRegion)),\n    HighRiskEvents = countif(RiskLevelDuringSignIn == 'high'),\n    Users = make_set(UserPrincipalName, 10),\n    Countries = make_set(tostring(LocationDetails.countryOrRegion), 10)\n    by DeviceName, DeviceId, DeviceOS, IsCompliant, IsManaged, TrustType\n| extend FailureRate = round(todouble(FailedSignIns) / TotalSignIns * 100, 1)\n| extend RiskIndicator = case(\n    HighRiskEvents > 0, 'üî¥ HIGH RISK',\n    IsCompliant == 'false', 'üü† NON-COMPLIANT',\n    UniqueCountries > 3, 'üü† GEO ANOMALY',\n    UniqueUsers > 5, 'üü° SHARED DEVICE',\n    'üü¢ NORMAL'\n)\n| project \n    DeviceName, DeviceId, DeviceOS, RiskIndicator,\n    IsCompliant, IsManaged, TrustType,\n    FirstSeen, LastSeen,\n    TotalSignIns, SuccessfulSignIns, FailedSignIns, FailureRate,\n    UniqueUsers, UniqueIPs, UniqueCountries, HighRiskEvents,\n    Users, Countries",
              "size": 0,
              "title": "üíª Device Profile",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "RiskIndicator",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {"operator": "contains", "thresholdValue": "HIGH RISK", "representation": "red", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "NON-COMPLIANT", "representation": "orange", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "ANOMALY", "representation": "orange", "text": "{0}"},
                        {"operator": "contains", "thresholdValue": "SHARED", "representation": "yellow", "text": "{0}"},
                        {"operator": "Default", "representation": "green", "text": "{0}"}
                      ]
                    }
                  },
                  {
                    "columnMatch": "IsCompliant",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {"operator": "==", "thresholdValue": "true", "representation": "green", "text": "‚úÖ Yes"},
                        {"operator": "Default", "representation": "red", "text": "‚ùå No"}
                      ]
                    }
                  }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicDevice",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "DeviceProfile"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Device Activity Timeline\nlet targetDevice = '{SelectedForensicDevice}';\nSigninLogs\n| where TimeGenerated {ForensicTimeRange}\n| where DeviceDetail.deviceId == targetDevice or DeviceDetail.displayName =~ targetDevice\n| summarize Success = countif(ResultType == '0'), Failed = countif(ResultType != '0'), HighRisk = countif(RiskLevelDuringSignIn == 'high') by bin(TimeGenerated, 1h)\n| render timechart",
              "size": 0,
              "title": "üìà Device Activity Timeline",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicDevice",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "DeviceTimeline"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Users on this Device\nlet targetDevice = '{SelectedForensicDevice}';\nSigninLogs\n| where TimeGenerated {ForensicTimeRange}\n| where DeviceDetail.deviceId == targetDevice or DeviceDetail.displayName =~ targetDevice\n| summarize \n    SignIns = count(),\n    Failed = countif(ResultType != '0'),\n    HighRisk = countif(RiskLevelDuringSignIn == 'high'),\n    LastSeen = max(TimeGenerated)\n    by UserPrincipalName\n| extend Status = case(\n    HighRisk > 0, 'üî¥ HIGH RISK',\n    Failed > 10, 'üü† FAILURES',\n    'üü¢ NORMAL'\n)\n| order by SignIns desc",
              "size": 0,
              "title": "üë• Users on this Device",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {"filter": true}
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicDevice",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "customWidth": "50",
            "name": "DeviceUsers"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Device Event Details\nlet targetDevice = '{SelectedForensicDevice}';\nSigninLogs\n| where TimeGenerated {ForensicTimeRange}\n| where DeviceDetail.deviceId == targetDevice or DeviceDetail.displayName =~ targetDevice\n| extend Country = tostring(LocationDetails.countryOrRegion)\n| extend City = tostring(LocationDetails.city)\n| extend Status = case(ResultType == '0', '‚úÖ Success', '‚ùå Failed')\n| extend RiskLevel = coalesce(RiskLevelDuringSignIn, 'none')\n| project \n    TimeGenerated,\n    Status,\n    RiskLevel,\n    UserPrincipalName,\n    IPAddress,\n    Country,\n    City,\n    AppDisplayName,\n    AuthenticationRequirement,\n    ConditionalAccessStatus,\n    ResultDescription\n| order by TimeGenerated desc\n| take 100",
              "size": 0,
              "title": "üìù Device Sign-In Event Details",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {"operator": "contains", "thresholdValue": "Success", "representation": "green", "text": "{0}"},
                        {"operator": "Default", "representation": "red", "text": "{0}"}
                      ]
                    }
                  },
                  {
                    "columnMatch": "RiskLevel",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {"operator": "==", "thresholdValue": "high", "representation": "red", "text": "üî¥ HIGH"},
                        {"operator": "==", "thresholdValue": "medium", "representation": "orange", "text": "üü† MEDIUM"},
                        {"operator": "==", "thresholdValue": "low", "representation": "yellow", "text": "üü° LOW"},
                        {"operator": "Default", "representation": "green", "text": "üü¢ NONE"}
                      ]
                    }
                  }
                ],
                "filter": true
              }
            },
            "conditionalVisibility": {
              "parameterName": "SelectedForensicDevice",
              "comparison": "isNotEqualTo",
              "value": ""
            },
            "name": "DeviceEventDetails"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "forensics"
      },
      "name": "ForensicsGroup"
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/{subscription-id}/resourceGroups/{resource-group}/providers/Microsoft.OperationalInsights/workspaces/{workspace-name}"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}